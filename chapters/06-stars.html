<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>6&nbsp; Spatiotemporal Raster Data Handling with stars – R as GIS for Economists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/07-CreateMaps-ggplot.html" rel="next">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Google tag (gtag.js) --><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../style.css">
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/06-stars.html">Extensions</a></li><li class="breadcrumb-item"><a href="../chapters/06-stars.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">R as GIS for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/R-as-GIS-for-Economists" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Demonstrations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-Demonstration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-VectorDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-SpatialInteractionVectorVector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-RasterDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-SpatialInteractionVectorRaster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Extensions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-stars.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-CreateMaps-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-DownloadSpatialData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">(slightly) Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-SpeedThingsUp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-ParallelComputing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Loop and Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-ggplot2-appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">ggplot2 minimals</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#before-you-start" id="toc-before-you-start" class="nav-link active" data-scroll-target="#before-you-start">Before you start</a>
  <ul class="collapse">
<li><a href="#direction-for-replication" id="toc-direction-for-replication" class="nav-link" data-scroll-target="#direction-for-replication">Direction for replication</a></li>
  </ul>
</li>
  <li><a href="#sec-stars-structure" id="toc-sec-stars-structure" class="nav-link" data-scroll-target="#sec-stars-structure"><span class="header-section-number">6.1</span> Understanding the structure of a <code>stars</code> object</a></li>
  <li>
<a href="#some-basic-operations-on-stars-objects" id="toc-some-basic-operations-on-stars-objects" class="nav-link" data-scroll-target="#some-basic-operations-on-stars-objects"><span class="header-section-number">6.2</span> Some basic operations on <code>stars</code> objects</a>
  <ul class="collapse">
<li><a href="#create-a-new-attribute-and-drop-a-attribute" id="toc-create-a-new-attribute-and-drop-a-attribute" class="nav-link" data-scroll-target="#create-a-new-attribute-and-drop-a-attribute"><span class="header-section-number">6.2.1</span> Create a new attribute and drop a attribute</a></li>
  <li><a href="#subset-a-stars-object-by-index" id="toc-subset-a-stars-object-by-index" class="nav-link" data-scroll-target="#subset-a-stars-object-by-index"><span class="header-section-number">6.2.2</span> Subset a <code>stars</code> object by index</a></li>
  <li><a href="#set-attribute-names" id="toc-set-attribute-names" class="nav-link" data-scroll-target="#set-attribute-names"><span class="header-section-number">6.2.3</span> Set attribute names</a></li>
  <li><a href="#get-the-coordinate-reference-system" id="toc-get-the-coordinate-reference-system" class="nav-link" data-scroll-target="#get-the-coordinate-reference-system"><span class="header-section-number">6.2.4</span> Get the coordinate reference system</a></li>
  <li><a href="#get-the-dimension-characteristics-and-values" id="toc-get-the-dimension-characteristics-and-values" class="nav-link" data-scroll-target="#get-the-dimension-characteristics-and-values"><span class="header-section-number">6.2.5</span> Get the dimension characteristics and values</a></li>
  <li><a href="#attributes-to-dimensions-and-vice-versa" id="toc-attributes-to-dimensions-and-vice-versa" class="nav-link" data-scroll-target="#attributes-to-dimensions-and-vice-versa"><span class="header-section-number">6.2.6</span> Attributes to dimensions, and vice versa</a></li>
  </ul>
</li>
  <li><a href="#quick-visualization-for-exploration" id="toc-quick-visualization-for-exploration" class="nav-link" data-scroll-target="#quick-visualization-for-exploration"><span class="header-section-number">6.3</span> Quick visualization for exploration</a></li>
  <li>
<a href="#sec-read-write-stars" id="toc-sec-read-write-stars" class="nav-link" data-scroll-target="#sec-read-write-stars"><span class="header-section-number">6.4</span> Reading and writing raster data</a>
  <ul class="collapse">
<li><a href="#reading-raster-data" id="toc-reading-raster-data" class="nav-link" data-scroll-target="#reading-raster-data"><span class="header-section-number">6.4.1</span> Reading raster data</a></li>
  <li><a href="#writing-a-stars-object-to-a-file" id="toc-writing-a-stars-object-to-a-file" class="nav-link" data-scroll-target="#writing-a-stars-object-to-a-file"><span class="header-section-number">6.4.2</span> Writing a <code>stars</code> object to a file</a></li>
  </ul>
</li>
  <li><a href="#sec-stars-set-time" id="toc-sec-stars-set-time" class="nav-link" data-scroll-target="#sec-stars-set-time"><span class="header-section-number">6.5</span> Setting the time dimension manually</a></li>
  <li>
<a href="#sec-dplyr-op" id="toc-sec-dplyr-op" class="nav-link" data-scroll-target="#sec-dplyr-op"><span class="header-section-number">6.6</span> <code>dplyr</code>-like operations</a>
  <ul class="collapse">
<li><a href="#dplyrfilter" id="toc-dplyrfilter" class="nav-link" data-scroll-target="#dplyrfilter"><span class="header-section-number">6.6.1</span> <code>dplyr::filter()</code></a></li>
  <li><a href="#dplyrselect" id="toc-dplyrselect" class="nav-link" data-scroll-target="#dplyrselect"><span class="header-section-number">6.6.2</span> <code>dplyr::select()</code></a></li>
  <li><a href="#dplyrmutate" id="toc-dplyrmutate" class="nav-link" data-scroll-target="#dplyrmutate"><span class="header-section-number">6.6.3</span> <code>dplyr::mutate()</code></a></li>
  <li><a href="#dplyrpull" id="toc-dplyrpull" class="nav-link" data-scroll-target="#dplyrpull"><span class="header-section-number">6.6.4</span> <code>dplyr::pull()</code></a></li>
  </ul>
</li>
  <li>
<a href="#merging-stars-objects-using-c-and-starsst_mosaic" id="toc-merging-stars-objects-using-c-and-starsst_mosaic" class="nav-link" data-scroll-target="#merging-stars-objects-using-c-and-starsst_mosaic"><span class="header-section-number">6.7</span> Merging <code>stars</code> objects using <code>c()</code> and <code>stars::st_mosaic()</code></a>
  <ul class="collapse">
<li><a href="#merging-stars-objects-along-the-third-dimension-band" id="toc-merging-stars-objects-along-the-third-dimension-band" class="nav-link" data-scroll-target="#merging-stars-objects-along-the-third-dimension-band"><span class="header-section-number">6.7.1</span> Merging <code>stars</code> objects along the third dimension (band)</a></li>
  <li><a href="#sec-merge-two" id="toc-sec-merge-two" class="nav-link" data-scroll-target="#sec-merge-two"><span class="header-section-number">6.7.2</span> Merging <code>stars</code> objects of different attributes</a></li>
  <li><a href="#merging-stars-objects-of-different-spatial-extents" id="toc-merging-stars-objects-of-different-spatial-extents" class="nav-link" data-scroll-target="#merging-stars-objects-of-different-spatial-extents"><span class="header-section-number">6.7.3</span> Merging <code>stars</code> objects of different spatial extents</a></li>
  </ul>
</li>
  <li><a href="#apply-a-function-to-one-or-more-dimensions" id="toc-apply-a-function-to-one-or-more-dimensions" class="nav-link" data-scroll-target="#apply-a-function-to-one-or-more-dimensions"><span class="header-section-number">6.8</span> Apply a function to one or more dimensions</a></li>
  <li><a href="#sec-convert-to-rb" id="toc-sec-convert-to-rb" class="nav-link" data-scroll-target="#sec-convert-to-rb"><span class="header-section-number">6.9</span> Convert from and to <code>Raster</code><span class="math inline">\(^*\)</span> or <code>SpatRaster</code> objects</a></li>
  <li>
<a href="#spatial-interactions-of-stars-and-sf-objects" id="toc-spatial-interactions-of-stars-and-sf-objects" class="nav-link" data-scroll-target="#spatial-interactions-of-stars-and-sf-objects"><span class="header-section-number">6.10</span> Spatial interactions of <code>stars</code> and <code>sf</code> objects</a>
  <ul class="collapse">
<li><a href="#sec-stars-crop" id="toc-sec-stars-crop" class="nav-link" data-scroll-target="#sec-stars-crop"><span class="header-section-number">6.10.1</span> Spatial cropping (subsetting) to the area of interest</a></li>
  <li><a href="#sec-extraction-stars-points" id="toc-sec-extraction-stars-points" class="nav-link" data-scroll-target="#sec-extraction-stars-points"><span class="header-section-number">6.10.2</span> Extracting values for points</a></li>
  <li><a href="#sec-extraction-stars-polygons" id="toc-sec-extraction-stars-polygons" class="nav-link" data-scroll-target="#sec-extraction-stars-polygons"><span class="header-section-number">6.10.3</span> Extract and summarize values for polygons</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/06-stars.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/06-stars.html">Extensions</a></li><li class="breadcrumb-item"><a href="../chapters/06-stars.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-stars-basics" class="quarto-section-identifier"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="before-you-start" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="before-you-start">Before you start</h2>
<p>In this chapter, we introduce the <code>stars</code> package <span class="citation" data-cites="stars">(<a href="#ref-stars" role="doc-biblioref">Pebesma 2020</a>)</span> for handling raster data. It is especially useful for those working with spatiotemporal raster datasets, such as daily PRISM and Daymet data, as it offers a consistent framework for managing raster data with temporal dimensions. Specifically, stars objects can include a time dimension in addition to the usual spatial 2D dimensions (longitude and latitude), with the time dimension accepting Date values. This feature proves to be particularly handy for tasks like filtering data by date, as you will see below.</p>
<p>Another advantage of the <code>stars</code> package is its compatibility with <code>sf</code> objects as the lead developer of the two packages is the same person. Therefore, unlike the <code>terra</code> package approach, we do not need any tedious conversions between <code>sf</code> and <code>SpatVector</code>. The <code>stars</code> package also allows <code>dplyr</code>-like data operations using functions like <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> (see <a href="#sec-dplyr-op" class="quarto-xref"><span class="quarto-unresolved-ref">sec-dplyr-op</span></a>).</p>
<p>In Chapters <a href="#sec-raster-basics" class="quarto-xref"><span class="quarto-unresolved-ref">sec-raster-basics</span></a> and <a href="#sec-int-RV" class="quarto-xref"><span class="quarto-unresolved-ref">sec-int-RV</span></a>, we used the <code>raster</code> and <code>terra</code> packages to handle raster data and interact raster data with vector data. If you do not feel any inconvenience with the approach, you do not need to read on. Also, note that the <code>stars</code> package was not written to replace either <code>raster</code> or <code>terra</code> packages. <a href="https://github.com/r-spatial/stars/wiki/How-%60raster%60-functions-map-to-%60stars%60-functions">Here</a> is a good summary of how <code>raster</code> functions map to <code>stars</code> functions. As you can see, there are many functions that are available in the <code>terra</code> packages that cannot be implemented by the <code>stars</code> package. However, I must say the functionality of the <code>stars</code> package is rather complete at least for most users, and it is definitely possible to use just the <code>stars</code> package for all the raster data work in most cases.</p>
<p>Finally, this book does not cover the use of <code>stars_proxy</code> for big data that does not fit in your memory, which may be useful for some of you. <a href="https://r-spatial.github.io/stars/articles/stars2.html">This</a> provides an introduction to <code>stars_proxy</code> for those interested. This book also does not cover <strong>irregular</strong> raster cells (e.g., curvelinear grids). Interested readers are referred to <a href="https://r-spatial.github.io/stars/articles/stars4.html">here</a>.</p>
<section id="direction-for-replication" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="direction-for-replication">Direction for replication</h3>
<p><strong>Datasets</strong></p>
<p>All the datasets that you need to import are available <a href="https://www.dropbox.com/sh/l8fmabfjjcuzu5u/aad75x8b_f3yvaq6ca5ap5oza?dl=0">here</a>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</p>
<ul>
<li>set a folder (any folder) as the working directory using <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code>
</li>
<li>create a folder called “Data” inside the folder designated as the working directory (if you have created a “Data” folder previously, skip this step)</li>
<li>download the pertinent datasets from <a href="https://www.dropbox.com/sh/l8fmabfjjcuzu5u/aad75x8b_f3yvaq6ca5ap5oza?dl=0">here</a> and put them in the “Data” folder</li>
</ul>
<p><strong>Packages</strong></p>
<ul>
<li>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">stars</span>, <span class="co"># spatiotemporal data handling</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data handling</span></span>
<span>  <span class="va">tidyverse</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">cubelyr</span>, <span class="co"># handle raster data</span></span>
<span>  <span class="va">tmap</span>, <span class="co"># make maps</span></span>
<span>  <span class="va">mapview</span>, <span class="co"># make maps</span></span>
<span>  <span class="va">exactextractr</span>, <span class="co"># fast raster data extraction</span></span>
<span>  <span class="va">lubridate</span>, <span class="co"># handle dates</span></span>
<span>  <span class="va">prism</span> <span class="co"># download PRISM data</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Run the following code to define the theme for map:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">theme_set</span><span class="op">(</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">theme_for_map</span> <span class="op">&lt;-</span> <span class="fu">theme</span><span class="op">(</span></span>
<span>  axis.ticks <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  axis.text <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.border <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,</span>
<span>  panel.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span>, color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-stars-structure" class="level2 page-columns page-full" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="sec-stars-structure">
<span class="header-section-number">6.1</span> Understanding the structure of a <code>stars</code> object</h2>
<p>Let’s import a <code>stars</code> object of daily PRISM precipitation and tmax saved as an R dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read PRISM prcp and tmax data  ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">prcp_tmax_PRISM_m8_y09</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/prcp_tmax_PRISM_m8_y09_small.rds"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 2 attributes
attribute(s):
       Min.  1st Qu. Median      Mean  3rd Qu.   Max.
ppt   0.000  0.00000  0.000  1.292334  0.01100 30.851
tmax  1.833 17.55575 21.483 22.035435 26.54275 39.707
dimension(s):
     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
<p>This <code>stars</code> object has two attributes: <code>ppt</code> (precipitation) and <code>tmax</code> (maximum temperature). They are like variables in a regular <code>data.frame</code>. They hold information we are interested in using for our analysis.</p>
<p>This <code>stars</code> object has three dimensions: <code>x</code> (longitude), <code>y</code> (latitude), and <code>date</code>. Each dimension has <code>from</code>, <code>to</code>, <code>offset</code>, <code>delta</code>, <code>refsys</code>, <code>point</code>, and <code>values</code>. Here are their definitions (except <code>point</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>):</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;It is not clear what it really means. I have never had to pay attention to this parameter. So, its definition is not explained here. If you would like to investigate what it is, the best resource is probably <a href="https://r-spatial.github.io/stars/articles/stars4.html">this</a></p></div></div><ul>
<li>
<code>from</code>: beginning index</li>
<li>
<code>to</code>: ending index</li>
<li>
<code>offset</code>: starting value</li>
<li>
<code>delta</code>: step value</li>
<li>
<code>refsys</code>: GCS or CRS for <code>x</code> and <code>y</code> (and can be <code>Date</code> for a date dimension)</li>
<li>
<code>values</code>: values of the dimension when objects are not regular</li>
</ul>
<p>In order to understand the dimensions of <code>stars</code> objects, let’s first take a look at the figure below (<a href="#fig-two-d-map" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-two-d-map</span></a>), which visualizes the tmax values on the 2D <code>x</code>-<code>y</code> surfaces of the <code>stars</code> objects at 10th <code>date</code> value (the spatial distribution of tmax at a particular date).</p>
<p><br></p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-two-d-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-two-d-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-two-d-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-two-d-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.1: Map of tmax values on August 10, 2009: 20 by 20 matrix of cells
</figcaption></figure>
</div>
</div>
</div>
<p><br></p>
<p>You can consider the 2D x-y surface as a matrix, where the location of a cell is defined by the row number and column number. Since the <code>from</code> for <code>x</code> is 1 and <code>to</code> for <code>x</code> is 20, we have 20 columns. Similarly, since the <code>from</code> for <code>y</code> is 1 and <code>to</code> for <code>y</code> is 20, we have 20 rows. The <code>offset</code> value of the <code>x</code> and <code>y</code> dimensions is the longitude and latitude of the upper-left corner point of the upper left cell of the 2D x-y surface, respectively (the red circle i@fig-two-d-map).<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> As <code>refsys</code> indicates, they are in NAD83 GCS. The longitude of the upper-left corner point of all the cells in the <span class="math inline">\(j\)</span>th column (from the left) of the 2D x-y surface is -121.7291667 + <span class="math inline">\((j-1)\times\)</span> 0.0416667, where -121.7291667 is <code>offset</code> for <code>x</code> and 0.0416667 is <code>delta</code> for <code>x</code>. Similarly, the latitude of the upper-left corner point of all the cells in the <span class="math inline">\(i\)</span>th row (from the top) of the 2D x-y surface is 46.6458333 +<span class="math inline">\((i-1)\times\)</span> -0.0416667, where 46.6458333 is <code>offset</code> for <code>y</code> and -0.0416667 is <code>delta</code> for <code>y</code>.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;This changes depending on the <code>delta</code> of <code>x</code> and <code>y</code>. If both of the <code>delta</code> for <code>x</code> and <code>y</code> are positive, then the <code>offset</code> value of the <code>x</code> and <code>y</code> dimensions are the longitude and latitude of the upper-left corner point of the lower-left cell of the 2D x-y surface.</p></div></div><p>The dimension characteristics of <code>x</code> and <code>y</code> are shared by all the layers across the date dimension, and a particular combination of <code>x</code> and <code>y</code> indexes refers to exactly the same location on the earth in all the layers across dates (of course). In the <code>date</code> dimension, we have 10 date values since the <code>from</code> for <code>date</code> is 1 and <code>to</code> for <code>date</code> is 10. The <code>refsys</code> of the <code>date</code> dimension is <code>Date</code>. Since the <code>offset</code> is 2009-08-11 and <code>delta</code> is 1, <span class="math inline">\(k\)</span>th layer represents tmax values for August <span class="math inline">\(11+k-1\)</span>, 2009.</p>
<p>Putting all this information together, we have 20 by 20 x-y surfaces stacked over the <code>date</code> dimension (10 layers), thus making up a 20 by 20 by 10 three-dimensional array (or cube) as shown in the figure below (<a href="#fig-map-layer-stars-structure" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-map-layer-stars-structure</span></a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-map-layer-stars-structure" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-layer-stars-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-map-layer-stars-structure-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-layer-stars-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.2: Visual illustration of stars data structure
</figcaption></figure>
</div>
</div>
</div>
<p>Remember that <code>prcp_tmax_PRISM_m8_y09</code> also has another attribute (<code>ppt</code>) which is structured exactly the same way as <code>tmax</code>. So, <code>prcp_tmax_PRISM_m8_y09</code> basically has four dimensions: attribute, <code>x</code>, <code>y</code>, and <code>date</code>.</p>
<p>It is not guaranteed that all the dimensions are regularly spaced or timed. For an irregular dimension, dimension values themselves are stored in <code>values</code> instead of using indexes, <code>offset</code>, and <code>delta</code> to find dimension values. For example, if you observe satellite data with 6-day gaps sometimes and 7-day gaps other times, then the date dimension would be irregular. We will see a made-up example of irregular time dimension in <a href="#sec-stars-set-time" class="quarto-xref"><span class="quarto-unresolved-ref">sec-stars-set-time</span></a>.</p>
</section><section id="some-basic-operations-on-stars-objects" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="some-basic-operations-on-stars-objects">
<span class="header-section-number">6.2</span> Some basic operations on <code>stars</code> objects</h2>
<section id="create-a-new-attribute-and-drop-a-attribute" class="level3" data-number="6.2.1"><h3 data-number="6.2.1" class="anchored" data-anchor-id="create-a-new-attribute-and-drop-a-attribute">
<span class="header-section-number">6.2.1</span> Create a new attribute and drop a attribute</h3>
<p>You can add a new attribute to a <code>stars</code> object just like you add a variable to a <code>data.frame</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- define a new variable which is tmax - 20 ---#</span></span>
<span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">$</span><span class="va">tmax_less_20</span> <span class="op">&lt;-</span> <span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">$</span><span class="va">tmax</span> <span class="op">-</span> <span class="fl">20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see below, <code>prcp_tmax_PRISM_m8_y09</code> now has <code>tmax_less_20</code> as an attribute.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prcp_tmax_PRISM_m8_y09</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 3 attributes
attribute(s):
                 Min.  1st Qu. Median      Mean  3rd Qu.   Max.
ppt             0.000  0.00000  0.000  1.292334  0.01100 30.851
tmax            1.833 17.55575 21.483 22.035435 26.54275 39.707
tmax_less_20  -18.167 -2.44425  1.483  2.035435  6.54275 19.707
dimension(s):
     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
<p>You can drop an attribute by assining <code>NULL</code> to the attribute you want to drop.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">$</span><span class="va">tmax_less_20</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="va">prcp_tmax_PRISM_m8_y09</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 2 attributes
attribute(s):
       Min.  1st Qu. Median      Mean  3rd Qu.   Max.
ppt   0.000  0.00000  0.000  1.292334  0.01100 30.851
tmax  1.833 17.55575 21.483 22.035435 26.54275 39.707
dimension(s):
     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
</section><section id="subset-a-stars-object-by-index" class="level3" data-number="6.2.2"><h3 data-number="6.2.2" class="anchored" data-anchor-id="subset-a-stars-object-by-index">
<span class="header-section-number">6.2.2</span> Subset a <code>stars</code> object by index</h3>
<p>In order to access the value of an attribute (say <code>ppt</code>) at a particular location at a particular time from the <code>stars</code> object (<code>prcp_tmax_PRISM_m8_y09</code>), you need to tell R that you are interested in the <code>ppt</code> attribute and specify the corresponding index of <code>x</code>, <code>y</code>, and <code>date</code>. Here, is how you get the <code>ppt</code> value of (3, 4) cell at date = 10.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"ppt"</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">10</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
     Min. 1st Qu. Median Mean 3rd Qu. Max.
ppt     0       0      0    0       0    0
dimension(s):
     from to     offset    delta refsys point x/y
x       3  3     -121.7  0.04167  NAD83 FALSE [x]
y       4  4      46.65 -0.04167  NAD83 FALSE [y]
date   10 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
<p>This is very much similar to accessing a value from a matrix except that we have more dimensions. The first argument selects the attribute of interest, 2nd <code>x</code>, 3rd <code>y</code>, and 4th <code>date</code>.</p>
<p>Of course, you can subset a <code>stars</code> object to access the value of multiple cells like this:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"ppt"</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">6</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
     Min. 1st Qu. Median     Mean 3rd Qu.  Max.
ppt     0       0      0 0.043125       0 0.546
dimension(s):
     from to     offset    delta refsys point x/y
x       3  6     -121.7  0.04167  NAD83 FALSE [x]
y       3  4      46.65 -0.04167  NAD83 FALSE [y]
date    5 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
</section><section id="set-attribute-names" class="level3" data-number="6.2.3"><h3 data-number="6.2.3" class="anchored" data-anchor-id="set-attribute-names">
<span class="header-section-number">6.2.3</span> Set attribute names</h3>
<p>When you read a raster dataset from a GeoTIFF file, the attribute name is the file name by default. So, you will often encounter cases where you want to change the attribute name. You can set the name of attributes using <code><a href="https://rdrr.io/r/stats/setNames.html">setNames()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prcp_tmax_PRISM_m8_y09_dif_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"precipitation"</span>, <span class="st">"maximum_temp"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the attribute names of <code>prcp_tmax_PRISM_m8_y09</code> (original datar) have not changed after this operation (just like <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> or other <code>dplyr</code> functions do):</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prcp_tmax_PRISM_m8_y09</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 2 attributes
attribute(s):
       Min.  1st Qu. Median      Mean  3rd Qu.   Max.
ppt   0.000  0.00000  0.000  1.292334  0.01100 30.851
tmax  1.833 17.55575 21.483 22.035435 26.54275 39.707
dimension(s):
     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
<p>If you want to reflect changes in the variable names while keeping the same object name, you need to assign the output of <code><a href="https://rdrr.io/r/stats/setNames.html">setNames()</a></code> to the object as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># the codes in the rest of this chapter use "precipitation" and "tmax" as the variables names, not these ones</span></span>
<span><span class="va">prcp_tmax_PRISM_m8_y09</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"precipitation"</span>, <span class="st">"maximum_temp"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will be using this function in <a href="#sec-merge-two" class="quarto-xref"><span class="quarto-unresolved-ref">sec-merge-two</span></a>.</p>
</section><section id="get-the-coordinate-reference-system" class="level3" data-number="6.2.4"><h3 data-number="6.2.4" class="anchored" data-anchor-id="get-the-coordinate-reference-system">
<span class="header-section-number">6.2.4</span> Get the coordinate reference system</h3>
<p>You can get the CRS of a <code>stars</code> object using <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">sf::st_crs()</a></code>, which is actually the same function name that we used to extract the CRS of an <code>sf</code> object.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: NAD83 
  wkt:
GEOGCRS["NAD83",
    DATUM["North American Datum 1983",
        ELLIPSOID["GRS 1980",6378137,298.257222101004,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["geodetic latitude (Lat)",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["geodetic longitude (Lon)",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4269]]</code></pre>
</div>
</div>
<p>You will use this to change the projection of vector datasets when you interact them:</p>
<ul>
<li>crop the <code>stars</code> raster dataset to the spatial extent of <code>sf</code> objects</li>
<li>extract values from the <code>stars</code> raster dataset for <code>sf</code> objects</li>
</ul>
<p>as we will see in <a href="#sec-int-RV" class="quarto-xref"><span class="quarto-unresolved-ref">sec-int-RV</span></a>. Notice also that we used exactly the same function name (<code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">sf::st_crs()</a></code>) to get the CRS of <code>sf</code> objects (see <a href="#sec-vector-basics" class="quarto-xref"><span class="quarto-unresolved-ref">sec-vector-basics</span></a>).</p>
</section><section id="get-the-dimension-characteristics-and-values" class="level3" data-number="6.2.5"><h3 data-number="6.2.5" class="anchored" data-anchor-id="get-the-dimension-characteristics-and-values">
<span class="header-section-number">6.2.5</span> Get the dimension characteristics and values</h3>
<p>You can access these dimension values using <code>st_dimensions()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get dimension characteristics ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">dim_prcp_tmin</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
<p>The following shows what we can get from this object.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">dim_prcp_tmin</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ x   :List of 7
  ..$ from  : num 1
  ..$ to    : num 20
  ..$ offset: num -122
  ..$ delta : num 0.0417
  ..$ refsys:List of 2
  .. ..$ input: chr "NAD83"
  .. ..$ wkt  : chr "GEOGCRS[\"NAD83\",\n    DATUM[\"North American Datum 1983\",\n        ELLIPSOID[\"GRS 1980\",6378137,298.257222"| __truncated__
  .. ..- attr(*, "class")= chr "crs"
  ..$ point : logi FALSE
  ..$ values: NULL
  ..- attr(*, "class")= chr "dimension"
 $ y   :List of 7
  ..$ from  : num 1
  ..$ to    : num 20
  ..$ offset: num 46.6
  ..$ delta : num -0.0417
  ..$ refsys:List of 2
  .. ..$ input: chr "NAD83"
  .. ..$ wkt  : chr "GEOGCRS[\"NAD83\",\n    DATUM[\"North American Datum 1983\",\n        ELLIPSOID[\"GRS 1980\",6378137,298.257222"| __truncated__
  .. ..- attr(*, "class")= chr "crs"
  ..$ point : logi FALSE
  ..$ values: NULL
  ..- attr(*, "class")= chr "dimension"
 $ date:List of 7
  ..$ from  : num 1
  ..$ to    : int 10
  ..$ offset: Date[1:1], format: "2009-08-11"
  ..$ delta : 'difftime' num 1
  .. ..- attr(*, "units")= chr "days"
  ..$ refsys: chr "Date"
  ..$ point : logi NA
  ..$ values: NULL
  ..- attr(*, "class")= chr "dimension"
 - attr(*, "raster")=List of 4
  ..$ affine     : num [1:2] 0 0
  ..$ dimensions : chr [1:2] "x" "y"
  ..$ curvilinear: logi FALSE
  ..$ blocksizes : int [1:10, 1:2] 20 20 20 20 20 20 20 20 20 20 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : NULL
  .. .. ..$ : chr [1:2] "x" "y"
  ..- attr(*, "class")= chr "stars_raster"
 - attr(*, "class")= chr "dimensions"</code></pre>
</div>
</div>
<p>For example, you can get <code>offset</code> of <code>x</code> as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dim_prcp_tmin</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="va">offset</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -121.7292</code></pre>
</div>
</div>
<p>You can extract dimension values using <code><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">stars::st_get_dimension_values()</a></code>. For example, to get values of <code>date</code>,</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get date values ---#</span></span>
<span><span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_get_dimension_values</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span>, <span class="st">"date"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "2009-08-11" "2009-08-12" "2009-08-13" "2009-08-14" "2009-08-15"
 [6] "2009-08-16" "2009-08-17" "2009-08-18" "2009-08-19" "2009-08-20"</code></pre>
</div>
</div>
<p>This can be handy as you will see in <a href="#sec-daymet-poly" class="quarto-xref"><span class="quarto-unresolved-ref">sec-daymet-poly</span></a>. Later in <a href="#sec-stars-set-time" class="quarto-xref"><span class="quarto-unresolved-ref">sec-stars-set-time</span></a>, we will learn how to set dimensions using <code><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">stars::st_set_dimensions()</a></code>.</p>
</section><section id="attributes-to-dimensions-and-vice-versa" class="level3" data-number="6.2.6"><h3 data-number="6.2.6" class="anchored" data-anchor-id="attributes-to-dimensions-and-vice-versa">
<span class="header-section-number">6.2.6</span> Attributes to dimensions, and vice versa</h3>
<p>You can make attributes to dimensions using <code><a href="https://rdrr.io/r/base/merge.html">base::merge()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">prcp_tmax_four</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 4 dimensions and 1 attribute
attribute(s):
          Min. 1st Qu. Median     Mean 3rd Qu.   Max.
ppt.tmax     0       0 11.799 11.66388  21.535 39.707
dimension(s):
           from to     offset    delta refsys point     values x/y
x             1 20     -121.7  0.04167  NAD83 FALSE       NULL [x]
y             1 20      46.65 -0.04167  NAD83 FALSE       NULL [y]
date          1 10 2009-08-11   1 days   Date    NA       NULL    
attributes    1  2         NA       NA     NA    NA ppt , tmax    </code></pre>
</div>
</div>
<p>As you can see, the new <code>stars</code> object has an additional dimension called <code>attributes</code>, which represents attributes and has two dimension values: the first for <code>ppt</code> and second for <code>tmax</code>. Now, if you want to access <code>ppt</code>, you can do the following:</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prcp_tmax_four</span><span class="op">[</span>, , , , <span class="st">"ppt"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 4 dimensions and 1 attribute
attribute(s):
          Min. 1st Qu. Median     Mean 3rd Qu.   Max.
ppt.tmax     0       0      0 1.292334   0.011 30.851
dimension(s):
           from to     offset    delta refsys point values x/y
x             1 20     -121.7  0.04167  NAD83 FALSE   NULL [x]
y             1 20      46.65 -0.04167  NAD83 FALSE   NULL [y]
date          1 10 2009-08-11   1 days   Date    NA   NULL    
attributes    1  1         NA       NA     NA    NA    ppt    </code></pre>
</div>
</div>
<p>We can do this because the merge kept the attribute names as dimension values as you can see in <code>values</code>.</p>
<p>You can revert it back to the original state using <code><a href="https://rdrr.io/r/base/split.html">base::split()</a></code>. Since we want the fourth dimension to dissolve,</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">prcp_tmax_four</span>, <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 2 attributes
attribute(s):
       Min.  1st Qu. Median      Mean  3rd Qu.   Max.
ppt   0.000  0.00000  0.000  1.292334  0.01100 30.851
tmax  1.833 17.55575 21.483 22.035435 26.54275 39.707
dimension(s):
     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
</section></section><section id="quick-visualization-for-exploration" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="quick-visualization-for-exploration">
<span class="header-section-number">6.3</span> Quick visualization for exploration</h2>
<p>You can use <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> to have a quick static map and <code>tmap::mapview()</code> or the <code>tmap</code> package for interactive views.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"tmax"</span>, , , <span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-stars_files/figure-html/static-map-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It only plots the first attribute if the <code>stars</code> object has multiple attributes:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-stars_files/figure-html/static-map-one-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>, which is identical with this:</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"ppt"</span>, , , <span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-stars_files/figure-html/static-map-identical-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="sec-read-write-stars" class="level2" data-number="6.4"><h2 data-number="6.4" class="anchored" data-anchor-id="sec-read-write-stars">
<span class="header-section-number">6.4</span> Reading and writing raster data</h2>
<p>There are so many formats in which raster data is stored. Some of the common ones include GeoTIFF, netCDF, GRIB. All the available GDAL drivers for reading and writing raster data can be found by the following code:</p>
<div class="cell" data-output-location="column">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_drivers.html">st_drivers</a></span><span class="op">(</span>what <span class="op">=</span> <span class="st">"raster"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="reading-raster-data" class="level3" data-number="6.4.1"><h3 data-number="6.4.1" class="anchored" data-anchor-id="reading-raster-data">
<span class="header-section-number">6.4.1</span> Reading raster data</h3>
<p>You can use <code><a href="https://r-spatial.github.io/stars/reference/read_stars.html">stars::read_stars()</a></code> to read a raster data file. It is very unlikely that the raster file you are trying to read is not in one of the supported formats.</p>
<p>For example, you can read a GeoTIFF file as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">ppt_m1_y09_stars</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"Data/PRISM_ppt_y2009_m1.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                        Min. 1st Qu. Median     Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m1.tif     0       0  0.436 3.543222  3.4925 56.208 60401
dimension(s):
     from   to offset    delta refsys point
x       1 1405   -125  0.04167  NAD83 FALSE
y       1  621  49.94 -0.04167  NAD83 FALSE
band    1   31     NA       NA     NA    NA
                                                                          values
x                                                                           NULL
y                                                                           NULL
band PRISM_ppt_stable_4kmD2_20090101_bil,...,PRISM_ppt_stable_4kmD2_20090131_bil
     x/y
x    [x]
y    [y]
band    </code></pre>
</div>
</div>
<p>This one imports a raw PRISM data stored as a BIL file.</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">prism_tmax_20180701</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"Data/PRISM_tmax_stable_4kmD2_20180701_bil/PRISM_tmax_stable_4kmD2_20180701_bil.bil"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
                                 Min. 1st Qu. Median     Mean 3rd Qu.   Max.
PRISM_tmax_stable_4kmD2_201...  3.623  25.318 31.596 29.50749  33.735 48.008
                                  NA's
PRISM_tmax_stable_4kmD2_201...  390874
dimension(s):
  from   to offset    delta refsys x/y
x    1 1405   -125  0.04167  NAD83 [x]
y    1  621  49.94 -0.04167  NAD83 [y]</code></pre>
</div>
</div>
<p>You can import multiple raster data files into one <code>stars</code> object by simply supplying a vector of file names:</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">files</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Data/PRISM_tmax_stable_4kmD2_20180701_bil/PRISM_tmax_stable_4kmD2_20180701_bil.bil"</span>,</span>
<span>    <span class="st">"Data/PRISM_tmax_stable_4kmD2_20180702_bil/PRISM_tmax_stable_4kmD2_20180702_bil.bil"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">prism_tmax_201807_two</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 2 attributes
attribute(s):
                                 Min. 1st Qu. Median     Mean 3rd Qu.   Max.
1_bil/PRISM_tmax_stable_4km...  3.623  25.318 31.596 29.50749  33.735 48.008
2_bil/PRISM_tmax_stable_4km...  0.808  26.505 30.632 29.93235  33.632 47.999
                                  NA's
1_bil/PRISM_tmax_stable_4km...  390874
2_bil/PRISM_tmax_stable_4km...  390874
dimension(s):
  from   to offset    delta refsys x/y
x    1 1405   -125  0.04167  NAD83 [x]
y    1  621  49.94 -0.04167  NAD83 [y]</code></pre>
</div>
</div>
<p>As you can see, each file becomes an attribute. It is more convenient to have them as layers stacked along the third dimension. To do that you can add <code>along = 3</code> option as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">prism_tmax_201807_two</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">files</span>, along <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                                 Min. 1st Qu. Median     Mean 3rd Qu.   Max.
PRISM_tmax_stable_4kmD2_201...  4.693 19.5925 23.653 22.05224 24.5945 33.396
                                 NA's
PRISM_tmax_stable_4kmD2_201...  60401
dimension(s):
        from   to offset    delta refsys
x          1 1405   -125  0.04167  NAD83
y          1  621  49.94 -0.04167  NAD83
new_dim    1    2     NA       NA     NA
                                                                                values
x                                                                                 NULL
y                                                                                 NULL
new_dim 1_bil/PRISM_tmax_stable_4kmD2_20180701, 2_bil/PRISM_tmax_stable_4kmD2_20180702
        x/y
x       [x]
y       [y]
new_dim    </code></pre>
</div>
</div>
<hr>
<p>Note that while the GeoTIFF format (and many other formats) can store multi-band (multi-layer) raster data allowing for an additional dimension beyond <code>x</code> and <code>y</code>, it does not store the values of the dimension like the <code>date</code> dimension we saw in <code>prcp_tmax_PRISM_m8_y09</code>. So, when you read a multi-layer raster data saved as a GeoTIFF, the third dimension of the resulting <code>stars</code> object will always be called <code>band</code> without any explicit time information. On the other hand, netCDF files are capable of storing the time dimension values. So, when you read a netCDF file with valid time dimension, you will have time dimension when it is read.</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"nc/bcsd_obs_1999.nc"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 2 attributes
attribute(s):
                Min.   1st Qu.   Median      Mean   3rd Qu.      Max. NA's
pr [mm/m]  0.5900000 56.139999 81.88000 101.26433 121.07250 848.54999 7116
tas [C]   -0.4209678  8.898887 15.65763  15.48932  21.77979  29.38581 7116
dimension(s):
          from to offset delta  refsys                    values x/y
longitude    1 81    -85 0.125  WGS 84                      NULL [x]
latitude     1 33     33 0.125  WGS 84                      NULL [y]
time         1 12     NA    NA POSIXct 1999-01-31,...,1999-12-31    </code></pre>
</div>
</div>
<p>The <code>refsys</code> of the time dimension is <code>POSIXct</code>, which is one of the date classes.</p>
</section><section id="writing-a-stars-object-to-a-file" class="level3" data-number="6.4.2"><h3 data-number="6.4.2" class="anchored" data-anchor-id="writing-a-stars-object-to-a-file">
<span class="header-section-number">6.4.2</span> Writing a <code>stars</code> object to a file</h3>
<p>You can write a <code>stars</code> object to a file using <code><a href="https://r-spatial.github.io/stars/reference/write_stars.html">stars::write_stars()</a></code> using one of the GDAL drivers.</p>
<p>Let’s save <code>prcp_tmax_PRISM_m8_y09["tmax",,,]</code>, which has <code>date</code> dimension whose <code>refsys</code> is <code>Date</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/write_stars.html">write_stars</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"tmax"</span>, , , <span class="op">]</span>, <span class="st">"Data/tmax_m8_y09_from_stars.tif"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s read the file we just saved.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"Data/tmax_m8_y09_from_stars.tif"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
                             Min.  1st Qu. Median     Mean  3rd Qu.   Max.
tmax_m8_y09_from_stars.tif  1.833 17.55575 21.483 22.03543 26.54275 39.707
dimension(s):
     from to offset    delta refsys point x/y
x       1 20 -121.7  0.04167  NAD83 FALSE [x]
y       1 20  46.65 -0.04167  NAD83 FALSE [y]
band    1 10     NA       NA     NA    NA    </code></pre>
</div>
</div>
<p>Notice that the third dimension is now called band and all the date information is lost. The loss of information happened when we saved <code>prcp_tmax_PRISM_m8_y09["tmax",,,]</code> as a GeoTIFF file. One easy way to avoid this problem is to just save a <code>stars</code> object as an R dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- save it as an rds file ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"tmax"</span>, , , <span class="op">]</span>, <span class="st">"Data/tmax_m8_y09_from_stars.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read it back ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/tmax_m8_y09_from_stars.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
       Min.  1st Qu. Median     Mean  3rd Qu.   Max.
tmax  1.833 17.55575 21.483 22.03543 26.54275 39.707
dimension(s):
     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
<p>As you can see, date information is retained. So, if you are the only one who uses this data or all of your team members use R, then this is a nice solution to the problem. At the moment, it is not possible to use <code><a href="https://r-spatial.github.io/stars/reference/write_stars.html">stars::write_stars()</a></code> to write to a netCDF file that supports the third dimension as time. However, this may not be the case for a long time (See the discussion <a href="https://github.com/r-spatial/stars/issues/8">here</a>).</p>
</section></section><section id="sec-stars-set-time" class="level2 page-columns page-full" data-number="6.5"><h2 data-number="6.5" class="anchored" data-anchor-id="sec-stars-set-time">
<span class="header-section-number">6.5</span> Setting the time dimension manually</h2>
<p>For this section, we will use PRISM precipitation data for U.S. for January, 2009.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">ppt_m1_y09_stars</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"Data/PRISM_ppt_y2009_m1.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                        Min. 1st Qu. Median     Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m1.tif     0       0  0.436 3.543222  3.4925 56.208 60401
dimension(s):
     from   to offset    delta refsys point
x       1 1405   -125  0.04167  NAD83 FALSE
y       1  621  49.94 -0.04167  NAD83 FALSE
band    1   31     NA       NA     NA    NA
                                                                          values
x                                                                           NULL
y                                                                           NULL
band PRISM_ppt_stable_4kmD2_20090101_bil,...,PRISM_ppt_stable_4kmD2_20090131_bil
     x/y
x    [x]
y    [y]
band    </code></pre>
</div>
</div>
<p>As you can see, when you read a GeoTIFF file, the third dimension will always be called <code>band</code> because GeoTIFF format does not support dimension values for the third dimension.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;In <a href="#sec-stars-structure" class="quarto-xref"><span class="quarto-unresolved-ref">sec-stars-structure</span></a>, we read an <code>rds</code>, which is a <code>stars</code> object with dimension name set manually.</p></div></div><p>You can use <code>st_set_dimension()</code> to set the third dimension (called <code>band</code>) as the time dimension using <code>Date</code> object. This can be convenient when you would like to filter the data by date using <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> as we will see later.</p>
<p>For <code>ppt_m1_y09_stars</code>, precipitation is observed on a daily basis from January 1, 2009 to January 31, 2009, where the band value of <strong>x</strong> corresponds to January <strong>x</strong>, 2009. So, we can first create a vector of dates as follows (If you are not familiar with <code>Dates</code> and the <code>lubridate</code> pacakge, <a href="http://uc-r.github.io/dates/">this</a> is a good resource to learn them.):</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- starting date ---#</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-01-01"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- ending date ---#</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-01-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- sequence of dates  ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">dates_ls_m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, <span class="st">"days"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "2009-01-01" "2009-01-02" "2009-01-03" "2009-01-04" "2009-01-05"
 [6] "2009-01-06" "2009-01-07" "2009-01-08" "2009-01-09" "2009-01-10"
[11] "2009-01-11" "2009-01-12" "2009-01-13" "2009-01-14" "2009-01-15"
[16] "2009-01-16" "2009-01-17" "2009-01-18" "2009-01-19" "2009-01-20"
[21] "2009-01-21" "2009-01-22" "2009-01-23" "2009-01-24" "2009-01-25"
[26] "2009-01-26" "2009-01-27" "2009-01-28" "2009-01-29" "2009-01-30"
[31] "2009-01-31"</code></pre>
</div>
</div>
<p>We can then use <code><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">stars::st_set_dimensions()</a></code> to change the third dimension to the dimension of date.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>stars<span class="sc">::</span><span class="fu">st_set_dimensions</span>(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  stars object,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  dimension,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">values =</span> dimension values,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">names =</span> name of the dimension</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">ppt_m1_y09_stars</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span></span>
<span>      <span class="va">ppt_m1_y09_stars</span>,</span>
<span>      <span class="fl">3</span>,</span>
<span>      values <span class="op">=</span> <span class="va">dates_ls_m1</span>,</span>
<span>      names <span class="op">=</span> <span class="st">"date"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                        Min. 1st Qu. Median     Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m1.tif     0       0  0.436 3.543222  3.4925 56.208 60401
dimension(s):
     from   to     offset    delta refsys point x/y
x       1 1405       -125  0.04167  NAD83 FALSE [x]
y       1  621      49.94 -0.04167  NAD83 FALSE [y]
date    1   31 2009-01-01   1 days   Date    NA    </code></pre>
</div>
</div>
<p>As you can see, the third dimension has become date. The value of offset for the date dimension has become <code>2009-01-01</code> meaning the starting date value is now <code>2009-01-01</code>. Further, the value of delta is now 1 days, so date dimension of <strong>x</strong> corresponds to <code>2009-01-01</code> + <strong>x</strong> - 1 = <code>2009-01-x</code>.</p>
<p>Note that the date dimension does not have to be regularly spaced. For example, you may have satellite images available for your area with a 5-day interval sometimes and a 6-day interval other times. This is perfectly fine. As an illustration, I will create a wrong sequence of dates for this data with a 2-day gap in the middle and assign them to the date dimension to see what happens.</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- 2009-01-23 removed and 2009-02-01 added ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">dates_ls_wrong</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, <span class="st">"days"</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">23</span><span class="op">]</span>, <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-02-01"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "2009-01-01" "2009-01-02" "2009-01-03" "2009-01-04" "2009-01-05"
 [6] "2009-01-06" "2009-01-07" "2009-01-08" "2009-01-09" "2009-01-10"
[11] "2009-01-11" "2009-01-12" "2009-01-13" "2009-01-14" "2009-01-15"
[16] "2009-01-16" "2009-01-17" "2009-01-18" "2009-01-19" "2009-01-20"
[21] "2009-01-21" "2009-01-22" "2009-01-24" "2009-01-25" "2009-01-26"
[26] "2009-01-27" "2009-01-28" "2009-01-29" "2009-01-30" "2009-01-31"
[31] "2009-02-01"</code></pre>
</div>
</div>
<p>Now assign these date values to <code>ppt_m1_y09_stars</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- set date values ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">ppt_m1_y09_stars_wrong</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span></span>
<span>      <span class="va">ppt_m1_y09_stars</span>,</span>
<span>      <span class="fl">3</span>,</span>
<span>      values <span class="op">=</span> <span class="va">dates_ls_wrong</span>,</span>
<span>      names <span class="op">=</span> <span class="st">"date"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                        Min. 1st Qu. Median     Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m1.tif     0       0  0.436 3.543222  3.4925 56.208 60401
dimension(s):
     from   to offset    delta refsys point                    values x/y
x       1 1405   -125  0.04167  NAD83 FALSE                      NULL [x]
y       1  621  49.94 -0.04167  NAD83 FALSE                      NULL [y]
date    1   31     NA       NA   Date    NA 2009-01-01,...,2009-02-01    </code></pre>
</div>
</div>
<p>Since the step between the date values is no longer <span class="math inline">\(1\)</span> day for the entire sequence, the value of <code>delta</code> is now <code>NA</code>. However, notice that the value of date is no longer NULL. Since the date is not regular, you cannot represent date using three values (<code>from</code>, <code>to</code>, and <code>delta</code>) any more, and date values for each observation have to be stored now.</p>
<p>Finally, note that just applying <code><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">stars::st_set_dimensions()</a></code> to a <code>stars</code> object does not change the dimension of the <code>stars</code> object (just like <code><a href="https://rdrr.io/r/stats/setNames.html">setNames()</a></code> as we discussed above).</p>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ppt_m1_y09_stars</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                        Min. 1st Qu. Median     Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m1.tif     0       0  0.436 3.543222  3.4925 56.208 60401
dimension(s):
     from   to     offset    delta refsys point x/y
x       1 1405       -125  0.04167  NAD83 FALSE [x]
y       1  621      49.94 -0.04167  NAD83 FALSE [y]
date    1   31 2009-01-01   1 days   Date    NA    </code></pre>
</div>
</div>
<p>As you can see, the date dimension has not been altered. You need to assign the results of <code><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">stars::st_set_dimensions()</a></code> to a <code>stars</code> object to see the changes in the dimension reflected just like we did above with the right date values.</p>
</section><section id="sec-dplyr-op" class="level2 page-columns page-full" data-number="6.6"><h2 data-number="6.6" class="anchored" data-anchor-id="sec-dplyr-op">
<span class="header-section-number">6.6</span> <code>dplyr</code>-like operations</h2>
<p>You can use the <code>dplyr</code> language to do basic data operations on <code>stars</code> objects.</p>
<section id="dplyrfilter" class="level3 page-columns page-full" data-number="6.6.1"><h3 data-number="6.6.1" class="anchored" data-anchor-id="dplyrfilter">
<span class="header-section-number">6.6.1</span> <code>dplyr::filter()</code>
</h3>
<p>The <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> function allows you to subset data by dimension values: x, y, and band (here date).</p>
<hr>
<p><strong>spatial filtering</strong></p>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- longitude greater than -100 ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ppt_m1_y09_stars</span>, <span class="va">x</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-stars_files/figure-html/filter_ex-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- latitude less than 40 ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ppt_m1_y09_stars</span>, <span class="va">y</span> <span class="op">&lt;</span> <span class="fl">40</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-stars_files/figure-html/filter_ex-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p><strong>temporal filtering</strong></p>
<p>Finally, since the date dimension is in <code>Date</code>, you can use <code>Date</code> math to filter the data.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;This is possible only because we have assigned date values to the band dimension above.</p></div></div><div class="cell">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- dates after 2009-01-15  ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ppt_m1_y09_stars</span>, <span class="va">date</span> <span class="op">&gt;</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-01-21"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-stars_files/figure-html/filter_ex_date-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p><strong>filter by attribute?</strong></p>
<p>In case you are wondering, filtering by attribute is not possible. This makes sense, as doing so would disrupt the regular grid structure of raster data.</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ppt_m1_y09_stars</span>, <span class="va">ppt</span> <span class="op">&gt;</span> <span class="fl">20</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `map2_int()`:
ℹ In index: 1.
Caused by error in `glubort()`:
! ``~``, `ppt &gt; 20` must refer to exactly one dimension, not ``</code></pre>
</div>
</div>
</section><section id="dplyrselect" class="level3" data-number="6.6.2"><h3 data-number="6.6.2" class="anchored" data-anchor-id="dplyrselect">
<span class="header-section-number">6.6.2</span> <code>dplyr::select()</code>
</h3>
<p>The <code>dply::select()</code> function lets you pick certain attributes.</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span>, <span class="va">ppt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
     Min. 1st Qu. Median     Mean 3rd Qu.   Max.
ppt     0       0      0 1.292334   0.011 30.851
dimension(s):
     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
</section><section id="dplyrmutate" class="level3" data-number="6.6.3"><h3 data-number="6.6.3" class="anchored" data-anchor-id="dplyrmutate">
<span class="header-section-number">6.6.3</span> <code>dplyr::mutate()</code>
</h3>
<p>You can mutate attributes using the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> function. For example, this can be useful to calculate NDVI in a <code>stars</code> object that has Red and NIR (spectral reflectance measurements in the red and near-infrared regions) as attributes. Here, we just simply convert the unit of precipitation from mm to inches.</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- mm to inches ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span>, ppt <span class="op">=</span> <span class="va">ppt</span> <span class="op">*</span> <span class="fl">0.0393701</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 2 attributes
attribute(s):
       Min.  1st Qu. Median       Mean      3rd Qu.      Max.
ppt   0.000  0.00000  0.000  0.0508793 4.330711e-04  1.214607
tmax  1.833 17.55575 21.483 22.0354348 2.654275e+01 39.707001
dimension(s):
     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
</section><section id="dplyrpull" class="level3" data-number="6.6.4"><h3 data-number="6.6.4" class="anchored" data-anchor-id="dplyrpull">
<span class="header-section-number">6.6.4</span> <code>dplyr::pull()</code>
</h3>
<p>You can extract attribute values using <code><a href="https://dplyr.tidyverse.org/reference/pull.html">dplyr::pull()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- tmax values of the 1st date layer ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"tmax"</span>, , , <span class="fl">1</span><span class="op">]</span>, <span class="st">"tmax"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>, , 1

        [,1]   [,2]   [,3]   [,4]   [,5]   [,6]   [,7]   [,8]   [,9]  [,10]
 [1,] 25.495 27.150 22.281 19.553 21.502 19.616 21.664 24.458 21.712 19.326
 [2,] 27.261 27.042 21.876 19.558 19.141 19.992 18.694 24.310 21.094 20.032
 [3,] 27.568 21.452 23.220 19.428 18.974 19.366 20.293 24.418 20.190 21.127
 [4,] 23.310 20.357 20.111 21.380 19.824 19.638 22.135 20.885 20.121 18.396
 [5,] 19.571 20.025 18.407 19.142 19.314 22.759 22.652 19.566 18.817 16.065
 [6,] 17.963 16.581 17.121 16.716 19.680 20.521 17.991 18.007 17.430 14.586
 [7,] 20.911 19.202 16.309 14.496 17.429 19.083 18.509 18.723 17.645 16.415
 [8,] 17.665 16.730 17.691 14.370 16.849 18.413 17.787 20.000 19.319 18.401
 [9,] 16.795 18.091 20.460 16.405 18.331 19.005 19.142 21.226 21.184 19.520
[10,] 19.208 19.624 17.210 19.499 18.492 20.854 18.684 19.811 22.058 19.923
[11,] 23.148 18.339 19.676 20.674 18.545 21.126 19.013 19.722 21.843 21.271
[12,] 23.254 21.279 21.921 19.894 19.445 21.499 19.765 20.742 21.560 22.989
[13,] 23.450 21.956 19.813 18.970 20.173 20.567 21.152 20.932 19.836 20.347
[14,] 24.075 21.120 20.166 19.177 20.428 20.908 21.060 19.832 19.764 19.981
[15,] 24.318 20.943 20.024 20.022 19.040 19.773 20.452 20.152 20.321 20.304
[16,] 22.538 19.461 20.100 21.149 19.958 20.486 20.535 20.445 21.564 21.493
[17,] 20.827 20.192 21.165 22.369 21.488 22.031 21.552 21.089 21.687 23.375
[18,] 21.089 21.451 22.692 21.793 22.160 23.049 22.562 22.738 23.634 24.697
[19,] 22.285 22.992 23.738 23.497 24.255 25.177 25.411 24.324 24.588 26.032
[20,] 23.478 23.584 24.589 24.719 26.114 26.777 27.310 26.643 26.516 26.615
       [,11]  [,12]  [,13]  [,14]  [,15]  [,16]  [,17]  [,18]  [,19]  [,20]
 [1,] 24.845 23.211 21.621 23.180 21.618 21.322 22.956 23.749 23.162 25.746
 [2,] 24.212 21.820 21.305 22.960 22.806 22.235 23.604 23.689 25.597 25.933
 [3,] 20.879 20.951 22.280 23.536 23.455 22.537 24.760 23.587 26.170 24.764
 [4,] 17.435 18.681 22.224 24.122 25.828 25.604 25.298 22.817 24.438 24.835
 [5,] 14.186 17.789 20.624 23.416 26.059 27.571 25.158 24.201 26.001 26.235
 [6,] 10.188 15.632 19.907 22.660 25.268 27.469 27.376 27.488 27.278 27.558
 [7,] 14.797 15.933 19.204 21.641 23.107 25.626 26.990 25.838 26.906 27.247
 [8,] 17.325 18.299 19.691 21.553 21.840 23.754 26.099 25.270 26.282 26.981
 [9,] 19.322 19.855 20.489 22.597 23.614 25.873 26.906 26.368 26.332 25.844
[10,] 20.241 21.800 22.111 24.128 25.765 27.105 27.200 25.491 26.306 25.663
[11,] 23.398 24.090 24.884 25.596 26.545 27.014 26.464 25.708 25.742 25.336
[12,] 22.576 21.996 23.874 26.447 26.955 26.871 25.533 25.576 25.610 25.902
[13,] 22.023 22.358 24.996 26.185 27.249 25.617 25.623 25.600 25.433 26.681
[14,] 20.974 23.533 25.388 25.975 27.316 26.199 26.090 25.920 25.767 27.956
[15,] 20.982 23.632 24.703 25.539 26.515 27.133 27.407 27.518 27.149 28.506
[16,] 22.500 24.012 25.282 25.751 25.212 25.290 26.058 28.258 28.290 29.842
[17,] 23.024 24.381 25.157 25.259 24.829 24.183 25.632 26.947 28.601 29.589
[18,] 24.016 24.425 24.965 24.930 24.482 23.274 25.412 26.733 28.494 29.656
[19,] 24.065 24.105 24.145 24.318 23.912 22.782 25.039 26.554 28.184 29.012
[20,] 23.979 24.321 23.477 22.135 22.395 22.189 24.944 26.542 27.923 28.849</code></pre>
</div>
</div>
</section></section><section id="merging-stars-objects-using-c-and-starsst_mosaic" class="level2 page-columns page-full" data-number="6.7"><h2 data-number="6.7" class="anchored" data-anchor-id="merging-stars-objects-using-c-and-starsst_mosaic">
<span class="header-section-number">6.7</span> Merging <code>stars</code> objects using <code>c()</code> and <code>stars::st_mosaic()</code>
</h2>
<section id="merging-stars-objects-along-the-third-dimension-band" class="level3" data-number="6.7.1"><h3 data-number="6.7.1" class="anchored" data-anchor-id="merging-stars-objects-along-the-third-dimension-band">
<span class="header-section-number">6.7.1</span> Merging <code>stars</code> objects along the third dimension (band)</h3>
<p>Here we learn how to merge multiple <code>stars</code> objects that have</p>
<ul>
<li>the <strong>same</strong> attributes</li>
<li>the <strong>same</strong> spatial extent and resolution</li>
<li>
<strong>different</strong> bands (dates here)</li>
</ul>
<p>For example, consider merging PRISM precipitation data in January and February. Both of them have exactly the same spatial extent and resolutions and represent the same attribute (precipitation). However, they differ in the third dimension (date). So, you are trying to stack data of the same attributes along the third dimension (date) while making sure that spatial correspondence is maintained. This merge is kind of like <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code> that stacks multiple <code>data.frame</code>s vertically while making sure the variables are aligned correctly.</p>
<p>Let’s import the PRISM precipitation data for February, 2009.</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read the February ppt data ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">ppt_m2_y09_stars</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"Data/PRISM_ppt_y2009_m2.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                        Min. 1st Qu. Median      Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m2.tif     0       0      0 0.1855858       0 11.634 60401
dimension(s):
     from   to offset    delta refsys point
x       1 1405   -125  0.04167  NAD83 FALSE
y       1  621  49.94 -0.04167  NAD83 FALSE
band    1   28     NA       NA     NA    NA
                                                                          values
x                                                                           NULL
y                                                                           NULL
band PRISM_ppt_stable_4kmD2_20090201_bil,...,PRISM_ppt_stable_4kmD2_20090228_bil
     x/y
x    [x]
y    [y]
band    </code></pre>
</div>
</div>
<p>Note here that the third dimension of <code>ppt_m2_y09_stars</code> has not been changed to date.</p>
<p>Now, let’s try to merge the two:</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- combine the two ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">ppt_m1_to_m2_y09_stars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ppt_m1_y09_stars</span>, <span class="va">ppt_m2_y09_stars</span>, along <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                        Min. 1st Qu. Median     Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m1.tif     0       0  0.436 3.543222  3.4925 56.208 60401
dimension(s):
     from   to     offset    delta refsys point x/y
x       1 1405       -125  0.04167  NAD83 FALSE [x]
y       1  621      49.94 -0.04167  NAD83 FALSE [y]
date    1   59 2009-01-01   1 days   Date    NA    </code></pre>
</div>
</div>
<p>As you noticed, the second object (<code>ppt_m2_y09_stars</code>) was assumed to have the same date characteristics as the first one: the data in February is observed daily (<code>delta</code> is 1 day). This causes no problem in this instance as the February data is indeed observed daily starting from <code>2009-02-01</code>. However, be careful if you are appending the data that does not start from 1 day after (or more generally <code>delta</code> for the time dimension) the first data or the data that does not follow the same observation interval.</p>
<p>For this reason, it is advisable to first set the date values if it has not been set. Pretend that the February data actually starts from <code>2009-02-02</code> to <code>2009-03-01</code> to see what happens when the regular interval (<code>delta</code>) is not kept after merging.</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- starting date ---#</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-02-01"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- ending date ---#</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-02-28"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- sequence of dates  ---#</span></span>
<span><span class="va">dates_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, <span class="st">"days"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- pretend the data actually starts from `2009-02-02` to `2009-03-01` ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">ppt_m2_y09_stars</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span></span>
<span>      <span class="va">ppt_m2_y09_stars</span>,</span>
<span>      <span class="fl">3</span>,</span>
<span>      values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dates_ls</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-03-01"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      name <span class="op">=</span> <span class="st">"date"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                        Min. 1st Qu. Median      Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m2.tif     0       0      0 0.1855858       0 11.634 60401
dimension(s):
     from   to     offset    delta refsys point x/y
x       1 1405       -125  0.04167  NAD83 FALSE [x]
y       1  621      49.94 -0.04167  NAD83 FALSE [y]
date    1   28 2009-02-02   1 days   Date    NA    </code></pre>
</div>
</div>
<p>If you merge the two,</p>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ppt_m1_y09_stars</span>, <span class="va">ppt_m2_y09_stars</span>, along <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
                        Min. 1st Qu. Median     Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m1.tif     0       0  0.436 3.543222  3.4925 56.208 60401
dimension(s):
     from   to offset    delta refsys point                    values x/y
x       1 1405   -125  0.04167  NAD83 FALSE                      NULL [x]
y       1  621  49.94 -0.04167  NAD83 FALSE                      NULL [y]
date    1   59     NA       NA   Date    NA 2009-01-01,...,2009-03-01    </code></pre>
</div>
</div>
<p>The date dimension does not have <code>delta</code> any more, and correctly so because there is a one-day gap between the end date of the first <code>stars</code> object (<code>"2009-01-31"</code>) and the start date of the second <code>stars</code> object (<code>"2009-02-02"</code>). So, all the date values are now stored in <code>values</code>.</p>
</section><section id="sec-merge-two" class="level3" data-number="6.7.2"><h3 data-number="6.7.2" class="anchored" data-anchor-id="sec-merge-two">
<span class="header-section-number">6.7.2</span> Merging <code>stars</code> objects of different attributes</h3>
<p>Here we learn how to merge multiple <code>stars</code> objects that have</p>
<ul>
<li>
<strong>different</strong> attributes</li>
<li>the <strong>same</strong> spatial extent and resolution</li>
<li>the <strong>same</strong> bands (dates here)</li>
</ul>
<p>For example, consider merging PRISM precipitation and tmax data in January. Both of them have exactly the same spatial extent and resolutions and the date characteristics (starting and ending on the same dates with the same time interval). However, they differ in what they represent: precipitation and tmax. This merge is kind of like <code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code> that combines multiple <code>data.frame</code>s of different variables while making sure the observation correspondence is correct.</p>
<p>Let’s read the daily tmax data for January, 2009:</p>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_m8_y09_stars</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"Data/PRISM_tmax_y2009_m1.tif"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- change the attribute name ---#</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"tmax"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
         Min. 1st Qu. Median      Mean 3rd Qu.  Max.  NA's
tmax  -17.898  -7.761 -2.248 -3.062721   1.718 7.994 60401
dimension(s):
     from   to offset    delta refsys point
x       1 1405   -125  0.04167  NAD83 FALSE
y       1  621  49.94 -0.04167  NAD83 FALSE
band    1   31     NA       NA     NA    NA
                                                                            values
x                                                                             NULL
y                                                                             NULL
band PRISM_tmax_stable_4kmD2_20090101_bil,...,PRISM_tmax_stable_4kmD2_20090131_bil
     x/y
x    [x]
y    [y]
band    </code></pre>
</div>
</div>
<p>Now, let’s merge the PRISM ppt and tmax data in January, 2009.</p>
<div class="cell">
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ppt_m1_y09_stars</span>, <span class="va">tmax_m8_y09_stars</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in c.stars(ppt_m1_y09_stars, tmax_m8_y09_stars): don't know how to merge arrays: please specify parameter along</code></pre>
</div>
</div>
<p>Oops. Well, the problem is that the third dimension of the two objects is not the same. Even though we know that the <strong>x</strong>th element of their third dimension represent the same thing, they look different to R’s eyes. So, we first need to change the third dimension of <code>tmax_m8_y09_stars</code> to be consistent with the third dimension of <code>ppt_m1_y09_stars</code> (<code>dates_ls_m1</code> was defined in <a href="#sec-stars-set-time" class="quarto-xref"><span class="quarto-unresolved-ref">sec-stars-set-time</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_m8_y09_stars</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="fl">3</span>, values <span class="op">=</span> <span class="va">dates_ls_m1</span>, names <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
         Min. 1st Qu. Median      Mean 3rd Qu.  Max.  NA's
tmax  -17.898  -7.761 -2.248 -3.062721   1.718 7.994 60401
dimension(s):
     from   to     offset    delta refsys point x/y
x       1 1405       -125  0.04167  NAD83 FALSE [x]
y       1  621      49.94 -0.04167  NAD83 FALSE [y]
date    1   31 2009-01-01   1 days   Date    NA    </code></pre>
</div>
</div>
<p>Now, we can merge the two.</p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">ppt_tmax_m8_y09_stars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ppt_m1_y09_stars</span>, <span class="va">tmax_m8_y09_stars</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 2 attributes
attribute(s), summary of first 1e+05 cells:
                           Min. 1st Qu. Median      Mean 3rd Qu.   Max.  NA's
PRISM_ppt_y2009_m1.tif    0.000   0.000  0.436  3.543222  3.4925 56.208 60401
tmax                    -17.898  -7.761 -2.248 -3.062721  1.7180  7.994 60401
dimension(s):
     from   to     offset    delta refsys point x/y
x       1 1405       -125  0.04167  NAD83 FALSE [x]
y       1  621      49.94 -0.04167  NAD83 FALSE [y]
date    1   31 2009-01-01   1 days   Date    NA    </code></pre>
</div>
</div>
<p>As you can see, now we have another attribute called <code>tmax</code>.</p>
</section><section id="merging-stars-objects-of-different-spatial-extents" class="level3 page-columns page-full" data-number="6.7.3"><h3 data-number="6.7.3" class="anchored" data-anchor-id="merging-stars-objects-of-different-spatial-extents">
<span class="header-section-number">6.7.3</span> Merging <code>stars</code> objects of different spatial extents</h3>
<p>Here we learn how to merge multiple <code>stars</code> objects that have</p>
<ul>
<li>the <strong>same</strong> attributes</li>
<li>
<strong>different</strong> spatial extent but <strong>same</strong> resolution<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>
</li>
<li>the <strong>same</strong> bands (dates here)</li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;Technically, you can actually merge <code>stars</code> objects of different spatial resolutions. But, you probably should not.</p></div></div><p>Some times you have multiple separate raster datasets that have different spatial coverages and would like to combine them into one. You can do that using <code><a href="https://r-spatial.github.io/stars/reference/st_mosaic.html">stars::st_mosaic()</a></code>.</p>
<p>Let’s split <code>tmax_m8_y09_stars</code> into two parts (<a href="#fig-map-indiv" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-map-indiv</span></a> shows what they look like (only Jan 1, 1980)):</p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_1</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">x</span> <span class="op">&lt;=</span> <span class="op">-</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">tmax_2</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">x</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g_1</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tmax_1</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"tmax_1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g_2</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tmax_2</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"tmax_2"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">g_1</span> <span class="op">+</span> <span class="va">g_2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-indiv" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-indiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-map-indiv-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-indiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.3: Two spatially non-overlapping stars objects
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Let’s combine the two using <code><a href="https://r-spatial.github.io/stars/reference/st_mosaic.html">stars::st_mosaic()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_combined</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_mosaic.html">st_mosaic</a></span><span class="op">(</span><span class="va">tmax_1</span>, <span class="va">tmax_2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-plot-combine" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-plot-combine</span></a> shows what the combined object looks like.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tmax_combined</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-plot-combine" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plot-combine-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-plot-combine-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-combine-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.4: Map of the stars objects combined into one
</figcaption></figure>
</div>
</div>
</div>
<hr>
<p>It is okay to have the two <code>stars</code> objects to be combined have a spatial overlap. The following split creates two <code>stars</code> objects with a spatial overlap (<a href="#fig-map-indiv-2" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-map-indiv-2</span></a> shows what they look like).</p>
<div class="cell">
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_1</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">x</span> <span class="op">&lt;=</span> <span class="op">-</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">tmax_2</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">x</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">110</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g_1</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tmax_m8_y09_stars</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tmax_1</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"tmax_1"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">g_2</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tmax_m8_y09_stars</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tmax_2</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"tmax_2"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">g_1</span> <span class="op">/</span> <span class="va">g_2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-indiv-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-indiv-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-map-indiv-2-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-indiv-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.5: Two spatially overlapping stars objects
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>As you can see below, <code><a href="https://r-spatial.github.io/stars/reference/st_mosaic.html">stars::st_mosaic()</a></code> reconciles the spatial overlap between the two <code>stars</code> objects (<a href="#fig-plot-combine-overlapped" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-plot-combine-overlapped</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_combined</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_mosaic.html">st_mosaic</a></span><span class="op">(</span><span class="va">tmax_1</span>, <span class="va">tmax_2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
         Min. 1st Qu. Median      Mean 3rd Qu.  Max.  NA's
tmax  -17.898  -7.761 -2.248 -3.062721   1.718 7.994 60401
dimension(s):
     from   to offset    delta refsys x/y
x       1 1405   -125  0.04167  NAD83 [x]
y       1  621  49.94 -0.04167  NAD83 [y]
band    1   31     NA       NA     NA    </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tmax_combined</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-plot-combine-overlapped" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plot-combine-overlapped-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-plot-combine-overlapped-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-combine-overlapped-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.6: Map of the spatially-overlapping stars objects combined into one
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="apply-a-function-to-one-or-more-dimensions" class="level2 page-columns page-full" data-number="6.8"><h2 data-number="6.8" class="anchored" data-anchor-id="apply-a-function-to-one-or-more-dimensions">
<span class="header-section-number">6.8</span> Apply a function to one or more dimensions</h2>
<p>At times, you may want to apply a function to one or more dimensions of a stars object. For instance, you might want to calculate the total annual precipitation for each cell using daily precipitation data. To illustrate this, let’s create a single-attribute stars object that contains daily precipitation data for August 2009.</p>
<div class="cell">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">ppt_m8_y09</span> <span class="op">&lt;-</span> <span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"ppt"</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
     Min. 1st Qu. Median     Mean 3rd Qu.   Max.
ppt     0       0      0 1.292334   0.011 30.851
dimension(s):
     from to     offset    delta refsys point x/y
x       1 20     -121.7  0.04167  NAD83 FALSE [x]
y       1 20      46.65 -0.04167  NAD83 FALSE [y]
date    1 10 2009-08-11   1 days   Date    NA    </code></pre>
</div>
</div>
<p>Let’s find total precipitation for each cell in August in 2009 using <code><a href="https://r-spatial.github.io/stars/reference/st_apply.html">stars::st_apply()</a></code>, which works like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>stars<span class="sc">::</span><span class="fu">st_apply</span>(</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> stars object,</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">MARGIN =</span> margin,</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">FUN =</span> <span class="cf">function</span> to apply</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we want to sum the value of attribute (<code>ppt</code>) for each of the cells (each cell is represented by <code>x-y</code>), we specify <code>MARGIN = c("x", "y")</code> and use <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> as the function (<a href="#fig-summed-precip" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-summed-precip</span></a> shows the results).</p>
<div class="cell">
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">monthly_ppt</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span></span>
<span>    <span class="va">ppt_m8_y09</span>,</span>
<span>    MARGIN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    FUN <span class="op">=</span> <span class="va">sum</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb107"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">monthly_ppt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-summed-precip" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-summed-precip-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-summed-precip-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-summed-precip-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.7: Summed value of precipitation
</figcaption></figure>
</div>
</div>
</div>
</div></div></section><section id="sec-convert-to-rb" class="level2" data-number="6.9"><h2 data-number="6.9" class="anchored" data-anchor-id="sec-convert-to-rb">
<span class="header-section-number">6.9</span> Convert from and to <code>Raster</code><span class="math inline">\(^*\)</span> or <code>SpatRaster</code> objects</h2>
<p>When you need to convert a <code>stars</code> object to a <code>Raster</code><span class="math inline">\(^*\)</span> or <code>SpatRaster</code> object, you can use the <code>as()</code> function as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co"># to Raster* object</span></span>
<span>  <span class="va">prcp_tmax_PRISM_m8_y09_rb</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span>, <span class="st">"Raster"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class      : RasterBrick 
dimensions : 20, 20, 400, 10  (nrow, ncol, ncell, nlayers)
resolution : 0.04166667, 0.04166667  (x, y)
extent     : -121.7292, -120.8958, 45.8125, 46.64583  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=NAD83 +no_defs 
source     : memory
names      : layer.1, layer.2, layer.3, layer.4, layer.5, layer.6, layer.7, layer.8, layer.9, layer.10 
min values :       0,       0,       0,       0,       0,       0,       0,       0,       0,        0 
max values :   0.019,  18.888,  30.851,   4.287,   0.797,   0.003,   3.698,   1.801,   0.000,    0.000 
time       : 2009-08-11, 2009-08-12, 2009-08-13, 2009-08-14, 2009-08-15, 2009-08-16, 2009-08-17, 2009-08-18, 2009-08-19, 2009-08-20 </code></pre>
</div>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co"># to SpatRaster</span></span>
<span>  <span class="va">prcp_tmax_PRISM_m8_y09_sr</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span>, <span class="st">"SpatRaster"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 20, 20, 10  (nrow, ncol, nlyr)
resolution  : 0.04166667, 0.04166667  (x, y)
extent      : -121.7292, -120.8958, 45.8125, 46.64583  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 (EPSG:4269) 
source(s)   : memory
names       : date2~08-11, date2~08-12, date2~08-13, date2~08-14, date2~08-15, date2~08-16, ... 
min values  :       0.000,       0.000,       0.000,       0.000,       0.000,       0.000, ... 
max values  :       0.019,      18.888,      30.851,       4.287,       0.797,       0.003, ... </code></pre>
</div>
</div>
<p>As you can see, date values in <code>prcp_tmax_PRISM_m8_y09</code> appear in the time dimension of <code>prcp_tmax_PRISM_m8_y09_rb</code> (<code>RasterBrick</code>). However, in <code>prcp_tmax_PRISM_m8_y09_sr</code> (<code>SpatRaster</code>), date values appear in the <code>names</code> dimension with <code>date</code> added as prefix to the original date values.</p>
<p>Note also that the conversion was done for only the <code>ppt</code> attribute. This is simply because the <code>raster</code> and <code>terra</code> package does not accommodate multiple attributes of 3-dimensional array. So, if you want a <code>RasterBrick</code> or <code>SpatRaster</code> of the precipitation data, then you need to do the following:</p>
<div class="cell">
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co"># to RasterBrick</span></span>
<span>  <span class="va">tmax_PRISM_m8_y09_rb</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"ppt"</span>, , , <span class="op">]</span>, <span class="st">"Raster"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class      : RasterBrick 
dimensions : 20, 20, 400, 10  (nrow, ncol, ncell, nlayers)
resolution : 0.04166667, 0.04166667  (x, y)
extent     : -121.7292, -120.8958, 45.8125, 46.64583  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=NAD83 +no_defs 
source     : memory
names      : layer.1, layer.2, layer.3, layer.4, layer.5, layer.6, layer.7, layer.8, layer.9, layer.10 
min values :       0,       0,       0,       0,       0,       0,       0,       0,       0,        0 
max values :   0.019,  18.888,  30.851,   4.287,   0.797,   0.003,   3.698,   1.801,   0.000,    0.000 
time       : 2009-08-11, 2009-08-12, 2009-08-13, 2009-08-14, 2009-08-15, 2009-08-16, 2009-08-17, 2009-08-18, 2009-08-19, 2009-08-20 </code></pre>
</div>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co"># to SpatRaster</span></span>
<span>  <span class="va">tmax_PRISM_m8_y09_sr</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">prcp_tmax_PRISM_m8_y09</span><span class="op">[</span><span class="st">"ppt"</span>, , , <span class="op">]</span>, <span class="st">"SpatRaster"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 20, 20, 10  (nrow, ncol, nlyr)
resolution  : 0.04166667, 0.04166667  (x, y)
extent      : -121.7292, -120.8958, 45.8125, 46.64583  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 (EPSG:4269) 
source(s)   : memory
names       : date2~08-11, date2~08-12, date2~08-13, date2~08-14, date2~08-15, date2~08-16, ... 
min values  :       0.000,       0.000,       0.000,       0.000,       0.000,       0.000, ... 
max values  :       0.019,      18.888,      30.851,       4.287,       0.797,       0.003, ... </code></pre>
</div>
</div>
<p>You can convert a <code>Raster</code><span class="math inline">\(^*\)</span> object to a <code>stars</code> object using <code><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">stars::st_as_stars()</a></code> (you will see a use case in <a href="#sec-daymet-poly" class="quarto-xref"><span class="quarto-unresolved-ref">sec-daymet-poly</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_PRISM_m8_y09_back_to_stars</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="va">tmax_PRISM_m8_y09_rb</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
         Min. 1st Qu. Median     Mean 3rd Qu.   Max.
layer.1     0       0      0 1.292334   0.011 30.851
dimension(s):
     from to     offset    delta refsys x/y
x       1 20     -121.7  0.04167  NAD83 [x]
y       1 20      46.65 -0.04167  NAD83 [y]
band    1 10 2009-08-11   1 days   Date    </code></pre>
</div>
</div>
<p>Notice that the original date values (stored in the <code>date</code> dimension) are recovered, but its dimension is now called just <code>band</code>.</p>
<p>You can do the same with a <code>SpatRaster</code> object.</p>
<div class="cell">
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_PRISM_m8_y09_back_to_stars</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="va">tmax_PRISM_m8_y09_sr</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
                Min. 1st Qu. Median     Mean 3rd Qu.   Max.
date2009-08-11     0       0      0 1.292334   0.011 30.851
dimension(s):
     from to offset    delta refsys                            values x/y
x       1 20 -121.7  0.04167  NAD83                              NULL [x]
y       1 20  46.65 -0.04167  NAD83                              NULL [y]
band    1 10     NA       NA     NA date2009-08-11,...,date2009-08-20    </code></pre>
</div>
</div>
<p>Note that unlike the conversion from the <code>RasterBrick</code> object, the <code>band</code> dimension inherited values of the <code>name</code> dimension in <code>tmax_PRISM_m8_y09_sr</code>.</p>
</section><section id="spatial-interactions-of-stars-and-sf-objects" class="level2 page-columns page-full" data-number="6.10"><h2 data-number="6.10" class="anchored" data-anchor-id="spatial-interactions-of-stars-and-sf-objects">
<span class="header-section-number">6.10</span> Spatial interactions of <code>stars</code> and <code>sf</code> objects</h2>
<section id="sec-stars-crop" class="level3" data-number="6.10.1"><h3 data-number="6.10.1" class="anchored" data-anchor-id="sec-stars-crop">
<span class="header-section-number">6.10.1</span> Spatial cropping (subsetting) to the area of interest</h3>
<p>If the region of interest is smaller than the spatial extent of the <code>stars</code> raster data, there is no need to retain the irrelevant portions of the <code>stars</code> object. In such cases, you can crop the <code>stars</code> data to focus on the region of interest using <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">sf::st_crop()</a></code>. The general syntax of <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">sf::st_crop()</a></code> is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- NOT RUN ---#</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">st_crop</span>(stars object, sf<span class="sc">/</span>bbox object)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For demonstration, we use PRISM tmax data for the U.S. for January 2019 as a <code>stars</code> object.</p>
<div class="cell">
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">tmax_m8_y09_stars</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"Data/PRISM_tmax_y2009_m8.tif"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"tmax"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="va">.</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span></span>
<span>    <span class="st">"band"</span>,</span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span></span>
<span>      <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-08-01"</span><span class="op">)</span>,</span>
<span>      <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-08-10"</span><span class="op">)</span>,</span>
<span>      by <span class="op">=</span> <span class="st">"days"</span></span>
<span>    <span class="op">)</span>, </span>
<span>    name <span class="op">=</span> <span class="st">"date"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
        Min. 1st Qu. Median     Mean 3rd Qu.   Max.  NA's
tmax  15.084 20.1775 22.584 23.86903 26.3285 41.247 60401
dimension(s):
     from   to     offset    delta refsys point x/y
x       1 1405       -125  0.04167  NAD83 FALSE [x]
y       1  621      49.94 -0.04167  NAD83 FALSE [y]
date    1   10 2009-08-01   1 days   Date    NA    </code></pre>
</div>
</div>
<p>The region of interest is Michigan.</p>
<div class="cell">
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">MI_county_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Michigan"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- transform using the CRS of the PRISM stars data  ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can crop the tmax data to the Michigan state border using <code>st_crop()</code> as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">tmax_MI</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">MI_county_sf</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
        Min. 1st Qu. Median     Mean 3rd Qu.   Max.   NA's
tmax  14.108  22.471 24.343 24.61851  26.208 35.373 206900
dimension(s):
     from   to     offset    delta refsys point x/y
x     831 1023       -125  0.04167  NAD83 FALSE [x]
y      41  198      49.94 -0.04167  NAD83 FALSE [y]
date    1   10 2009-08-01   1 days   Date    NA    </code></pre>
</div>
</div>
<p>Notice that <code>from</code> and <code>to</code> for <code>x</code> and <code>y</code> have changed to cover only the boundary box of the Michigan state border. Note that the values for the cells outside of the Michigan state border were set to NA. <a href="#fig-mi-tmax" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-mi-tmax</span></a> shows the cropping was successful.</p>
<div class="cell">
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">tmax_MI</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mi-tmax" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-mi-tmax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-mi-tmax-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mi-tmax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.8: PRISM tmax data cropped to the Michigan state border
</figcaption></figure>
</div>
</div>
</div>
<p>Alternatively, you could use <code>[]</code> like as follows to crop a <code>stars</code> object.</p>
<div class="cell">
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span><span class="op">[</span><span class="va">MI_county_sf</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-stars_files/figure-html/alt-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>:::{.callout-note title = “Use bounding box”} When using <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">sf::st_crop()</a></code>, it is much faster to crop to a bounding box instead of <code>sf</code> if that is satisfactory. For example, you may be cropping a <code>stars</code> object to speed up subsequent raster value extraction (see <a href="#sec-crop-first" class="quarto-xref"><span class="quarto-unresolved-ref">sec-crop-first</span></a>). In this case, it is far better to crop to the bounding box of the <code>sf</code> instead of <code>sf</code>. Confirm the speed difference between the two below:</p>
<div class="cell">
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">crop_to_sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">MI_county_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="va">crop_to_bbox</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">MI_county_sf</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The difference can be substantial especially when the number of observations are large in <code>sf</code>. :::</p>
</section><section id="sec-extraction-stars-points" class="level3 page-columns page-full" data-number="6.10.2"><h3 data-number="6.10.2" class="anchored" data-anchor-id="sec-extraction-stars-points">
<span class="header-section-number">6.10.2</span> Extracting values for points</h3>
<p>In this section, we will learn how to extract cell values from raster layers as <code>starts</code> for spatial units represented as point <code>sf</code> data<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;see <a href="#sec-extract-raster-to-vector" class="quarto-xref"><span class="quarto-unresolved-ref">sec-extract-raster-to-vector</span></a> for a detailed explanation of what it means to <strong>extract</strong> raster values.</p></div></div><section id="extraction-using-starsst_extract" class="level4" data-number="6.10.2.1"><h4 data-number="6.10.2.1" class="anchored" data-anchor-id="extraction-using-starsst_extract">
<span class="header-section-number">6.10.2.1</span> Extraction using <code>stars::st_extract()</code>
</h4>
<p>For the illustrations in this section, we use the following datasets:</p>
<ul>
<li>Points: Irrigation wells in Kansas</li>
<li>Raster: daily PRISM tmax data for August, 2009</li>
</ul>
<p><strong>PRISM tmax data</strong></p>
<div class="cell">
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_m8_y09_stars</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"Data/PRISM_tmax_y2009_m8.tif"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"tmax"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span></span>
<span>      <span class="st">"band"</span>,</span>
<span>      values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span></span>
<span>        <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-08-01"</span><span class="op">)</span>,</span>
<span>        <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2009-08-10"</span><span class="op">)</span>,</span>
<span>        by <span class="op">=</span> <span class="st">"days"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      name <span class="op">=</span> <span class="st">"date"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Irrigation wells in Kansas:</strong></p>
<div class="cell">
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read in the KS points data ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">KS_wells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/Chap_5_wells_KS.rds"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37647 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -102.0495 ymin: 36.99552 xmax: -94.62089 ymax: 40.00199
Geodetic CRS:  NAD83
First 10 features:
   well_id                   geometry
1        1 POINT (-100.4423 37.52046)
2        3 POINT (-100.7118 39.91526)
3        5 POINT (-99.15168 38.48849)
4        7 POINT (-101.8995 38.78077)
5        8  POINT (-100.7122 38.0731)
6        9 POINT (-97.70265 39.04055)
7       11 POINT (-101.7114 39.55035)
8       12 POINT (-95.97031 39.16121)
9       15 POINT (-98.30759 38.26787)
10      17 POINT (-100.2785 37.71539)</code></pre>
</div>
</div>
<p><a href="#fig-tmax-prism-wells" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-tmax-prism-wells</span></a> show the spatial distribution of the irrigation wells over the PRISM grids:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb132"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_crop</span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span>, <span class="fu">st_bbox</span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"tmax"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">KS_wells</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-tmax-prism-wells" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-tmax-prism-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-tmax-prism-wells-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tmax-prism-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.9: Map of Kansas county borders, irrigation wells, and PRISM tmax
</figcaption></figure>
</div>
</div>
</div>
<hr>
<p>We can extract the value of raster cells in which points are located using <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">stars::st_extract()</a></code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- NOT RUN ---#</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>stars<span class="sc">::</span><span class="fu">st_extract</span>(stars object, sf of points)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before we extract values from the <code>stars</code> raster data, let’s crop it to the spatial extent of the <code>KS_wells</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_m8_y09_KS_stars</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">KS_wells</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also should change the CRS of <code>KS_wells</code> to that of <code>tmax_m8_y09_KS_stars</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">KS_wells</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now extract the value of rasters in which points are located:</p>
<div class="cell">
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">extracted_tmax</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_stars</span>, <span class="va">KS_wells</span><span class="op">)</span> </span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
        Min. 1st Qu. Median     Mean  3rd Qu.   Max.
tmax  24.605  30.681  33.08 33.22354 36.38175 40.759
dimension(s):
         from    to     offset  delta refsys point
geometry    1 37647         NA     NA  NAD83  TRUE
date        1    10 2009-08-01 1 days   Date    NA
                                                            values
geometry POINT (-100.4423 37.52046),...,POINT (-99.96733 39.88535)
date                                                          NULL</code></pre>
</div>
</div>
<p>The returned object is a <code>stars</code> object of simple features. You can convert this to a more familiar-looking <code>sf</code> object using <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">sf::st_as_sf()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">extracted_tmax_sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">extracted_tmax</span><span class="op">)</span> </span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37647 features and 10 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -102.0495 ymin: 36.99552 xmax: -94.62089 ymax: 40.00199
Geodetic CRS:  NAD83
First 10 features:
   2009-08-01 2009-08-02 2009-08-03 2009-08-04 2009-08-05 2009-08-06 2009-08-07
1      30.131     27.070     32.288     37.496     33.977     32.563     33.733
2      31.533     28.373     35.927     36.942     30.557     31.235     31.121
3      30.591     27.968     33.279     38.182     33.783     32.790     29.852
4      31.307     27.565     34.945     38.056     32.832     30.040     31.744
5      30.715     27.836     33.458     38.083     33.912     31.895     32.497
6      29.661     27.592     32.192     36.787     33.856     31.655     29.434
7      31.308     27.876     35.709     36.806     32.254     29.634     31.048
8      28.776     25.930     30.293     34.316     30.861     29.100     29.051
9      30.583     26.527     32.315     37.495     32.576     31.702     28.578
10     29.715     27.051     32.638     37.328     33.863     32.001     33.281
   2009-08-08 2009-08-09 2009-08-10                   geometry
1      36.471     37.635     31.506 POINT (-100.4423 37.52046)
2      37.016     31.317     29.902 POINT (-100.7118 39.91526)
3      36.954     38.100     33.257 POINT (-99.15168 38.48849)
4      36.498     32.738     29.350 POINT (-101.8995 38.78077)
5      36.021     37.251     30.389  POINT (-100.7122 38.0731)
6      36.524     39.329     36.532 POINT (-97.70265 39.04055)
7      36.319     30.805     30.004 POINT (-101.7114 39.55035)
8      34.211     35.462     35.193 POINT (-95.97031 39.16121)
9      37.337     38.112     36.962 POINT (-98.30759 38.26787)
10     36.322     37.686     31.488 POINT (-100.2785 37.71539)</code></pre>
</div>
</div>
<p>As you can see each date forms a column of extracted values for the points because the third dimension of <code>tmax_MI</code> is <code>date</code>. So, you can easily turn the outcome to an <code>sf</code> object with date as <code>Date</code> object as follows.</p>
<div class="cell">
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">extracted_tmax_long</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">extracted_tmax_sf</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span> <span class="va">geometry</span>, names_to <span class="op">=</span> <span class="st">"date"</span>, values_to <span class="op">=</span> <span class="st">"tmax"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>date <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 376470 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -102.0495 ymin: 36.99552 xmax: -94.62089 ymax: 40.00199
Geodetic CRS:  NAD83
# A tibble: 376,470 × 3
               geometry date        tmax
 *          &lt;POINT [°]&gt; &lt;date&gt;     &lt;dbl&gt;
 1 (-100.4423 37.52046) 2009-08-01  30.1
 2 (-100.4423 37.52046) 2009-08-02  27.1
 3 (-100.4423 37.52046) 2009-08-03  32.3
 4 (-100.4423 37.52046) 2009-08-04  37.5
 5 (-100.4423 37.52046) 2009-08-05  34.0
 6 (-100.4423 37.52046) 2009-08-06  32.6
 7 (-100.4423 37.52046) 2009-08-07  33.7
 8 (-100.4423 37.52046) 2009-08-08  36.5
 9 (-100.4423 37.52046) 2009-08-09  37.6
10 (-100.4423 37.52046) 2009-08-10  31.5
# ℹ 376,460 more rows</code></pre>
</div>
</div>
<p>Note that all the variables other than <code>geometry</code> in the points data (<code>KS_wells</code>) are lost at the time of applying <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">stars::st_extract()</a></code>. You take advantage the fact that the the order of the observations in the object returned by <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">stars::st_extract()</a></code> is the order of the points (<code>KS_wells</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">extracted_tmax_long</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">extracted_tmax_sf</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>well_id <span class="op">=</span> <span class="va">KS_wells</span><span class="op">$</span><span class="va">well_id</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span> <span class="va">geometry</span>, <span class="op">-</span> <span class="va">well_id</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"date"</span>, values_to <span class="op">=</span> <span class="st">"tmax"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>date <span class="op">=</span> <span class="fu">ymd</span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 376470 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -102.0495 ymin: 36.99552 xmax: -94.62089 ymax: 40.00199
Geodetic CRS:  NAD83
# A tibble: 376,470 × 4
               geometry well_id date        tmax
 *          &lt;POINT [°]&gt;   &lt;dbl&gt; &lt;date&gt;     &lt;dbl&gt;
 1 (-100.4423 37.52046)       1 2009-08-01  30.1
 2 (-100.4423 37.52046)       1 2009-08-02  27.1
 3 (-100.4423 37.52046)       1 2009-08-03  32.3
 4 (-100.4423 37.52046)       1 2009-08-04  37.5
 5 (-100.4423 37.52046)       1 2009-08-05  34.0
 6 (-100.4423 37.52046)       1 2009-08-06  32.6
 7 (-100.4423 37.52046)       1 2009-08-07  33.7
 8 (-100.4423 37.52046)       1 2009-08-08  36.5
 9 (-100.4423 37.52046)       1 2009-08-09  37.6
10 (-100.4423 37.52046)       1 2009-08-10  31.5
# ℹ 376,460 more rows</code></pre>
</div>
</div>
<p>We can now summarize the data by <code>well_id</code> and then merge it back to <code>KS_wells</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">extracted_tmax_long</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- geometry no longer needed ---#</span></span>
<span>  <span class="co"># if you do not do this, summarize() takes a long time</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">well_id</span>, <span class="fu">month</span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tmax</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">KS_wells</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"well_id"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-extraction-stars-polygons" class="level3 page-columns page-full" data-number="6.10.3"><h3 data-number="6.10.3" class="anchored" data-anchor-id="sec-extraction-stars-polygons">
<span class="header-section-number">6.10.3</span> Extract and summarize values for polygons</h3>
<p>In this section, we will learn how to extract cell values from raster layers as <code>starts</code> for spatial units represented as polygons <code>sf</code> data (see <a href="#sec-extract-raster-to-vector" class="quarto-xref"><span class="quarto-unresolved-ref">sec-extract-raster-to-vector</span></a> for a more detailed explanation of this operation).</p>
<p>In order to extract cell values from <code>stars</code> objects (just like <a href="#sec-int-RV" class="quarto-xref"><span class="quarto-unresolved-ref">sec-int-RV</span></a>) and summarize them for polygons, you can use <code>aggregate.stars()</code>. Although introduced here because it natively accepts stars objects, <code>aggregate.stars()</code> is <span style="color: red;">not recommended</span> unless the raster data is small (with a small number of cells). It is almost always slower than the two other alternatives: <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> and <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> even though they involve conversion of <code>stars</code> objects to <code>SpatRaster</code> objects. For a comparison of its performance relative to these alternatives, see <a href="#sec-num-cells-geometries" class="quarto-xref"><span class="quarto-unresolved-ref">sec-num-cells-geometries</span></a>. If you just want to see the better alternatives, you can just skip to <a href="#sec-ee-extract-stars" class="quarto-xref"><span class="quarto-unresolved-ref">sec-ee-extract-stars</span></a>.</p>
<section id="sec-extract-polygon-aggregate" class="level4 page-columns page-full" data-number="6.10.3.1"><h4 data-number="6.10.3.1" class="anchored" data-anchor-id="sec-extract-polygon-aggregate">
<span class="header-section-number">6.10.3.1</span> <code>aggregate.stars()</code>
</h4>
<p>The syntax of <code>aggregate.stars()</code> is as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- NOT RUN ---#</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(stars object, sf object, <span class="at">FUN =</span> <span class="cf">function</span> to apply)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each polygon, <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> identifies the cells whose centroids lie within the polygon, extracts their values, and applies the specified function to those values. Let’s now see a demonstration of how to use <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code>. For this example, we will use Kansas counties as the polygon data.</p>
<div class="cell">
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_county_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Kansas"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- transform using the CRS of the PRISM stars data  ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- generate unique id ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-polygons-location" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-polygons-location</span></a> shows polygons (counties) superimposed on top of the tmax raster data:</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb147"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_county_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-polygons-location" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-polygons-location-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-polygons-location-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-polygons-location-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.10: Map of Kansas counties over tmax raster data
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>For example, the following code will find the mean of the tmax values for each county:</p>
<div class="cell">
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">mean_tmax_stars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">KS_county_sf</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span> </span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
          Min.  1st Qu.   Median    Mean  3rd Qu.     Max.
tmax  24.91317 29.65889 32.56404 32.5487 35.34826 39.70888
dimension(s):
         from  to     offset  delta refsys point
geometry    1 105         NA     NA  NAD83 FALSE
date        1  10 2009-08-01 1 days   Date    NA
                                                                values
geometry MULTIPOLYGON (((-101.0681...,...,MULTIPOLYGON (((-96.50168...
date                                                              NULL</code></pre>
</div>
</div>
<p>As you can see, the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> operation also returns a <code>stars</code> object for polygons just like <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">stars::st_extract()</a></code> did. You can convert the <code>stars</code> object into an <code>sf</code> object using <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">sf::st_as_sf()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mean_tmax_sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">mean_tmax_stars</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see, <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> function extracted values for the polygons from all the layers across the date dimension, and the values from individual dates become variables where the variables names are the corresponding date values.</p>
<p>Just like the case of raster data extraction for points data we saw in <a href="#sec-extraction-stars-points" class="quarto-xref"><span class="quarto-unresolved-ref">sec-extraction-stars-points</span></a>, no information from the polygons (<code>KS_county_sf</code>) except the geometry column remains. For further processing of the extracted data and easy merging with the polygons data (<code>KS_county_sf</code>), we can assign the unique county id just like we did for the case of points data.</p>
<div class="cell">
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">mean_tmax_long</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">mean_tmax_sf</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- drop geometry ---#</span></span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- assign id before transformation ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">KS_county_sf</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- then transform ---#</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span>, names_to <span class="op">=</span> <span class="st">"date"</span>, values_to <span class="op">=</span> <span class="st">"tmax"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<p><code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> will return NA for polygons that intersect with raster cells that have NA values. To ignore the NA values when applying a function, we can add <code>na.rm=TRUE</code> option like this:</p>
<div class="cell">
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">mean_tmax_stars</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span></span>
<span>      <span class="va">tmax_m8_y09_stars</span>,</span>
<span>      <span class="va">KS_county_sf</span>,</span>
<span>      FUN <span class="op">=</span> <span class="va">mean</span>,</span>
<span>      na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div></section><section id="sec-ee-extract-stars" class="level4" data-number="6.10.3.2"><h4 data-number="6.10.3.2" class="anchored" data-anchor-id="sec-ee-extract-stars">
<span class="header-section-number">6.10.3.2</span> <code>exactextractr::exact_extract()</code>
</h4>
<p>A great alternative to <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> is to extract raster cell values using <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> or <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> and then summarize the results yourself. Both are considerably faster than <code>aggregate.stars()</code>. Although they do not natively accept <code>stars</code> objects, you can easily convert a <code>stars</code> object to a <code>SpatRaster</code> using <code>as(stars, "SpatRaster")</code> and then use these methods.</p>
<p>Let’s first convert <code>tmax_m8_y09_KS_stars</code> (a <code>stars</code> object) into a <code>SpatRaster</code> object.</p>
<div class="cell">
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">tmax_m8_y09_KS_sr</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">tmax_m8_y09_KS_stars</span>, <span class="st">"SpatRaster"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 73, 179, 10  (nrow, ncol, nlyr)
resolution  : 0.04166667, 0.04166667  (x, y)
extent      : -102.0625, -94.60417, 36.97917, 40.02083  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 (EPSG:4269) 
source(s)   : memory
names       : date2~08-01, date2~08-02, date2~08-03, date2~08-04, date2~08-05, date2~08-06, ... 
min values  :      27.639,      24.605,      28.094,      32.711,      28.972,      26.871, ... 
max values  :      32.844,      32.341,      37.560,      40.759,      39.466,      36.303, ... </code></pre>
</div>
</div>
<p>Now, we can use <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr</span>, <span class="va">KS_county_sf</span>, include_cols <span class="op">=</span> <span class="st">"COUNTYFP"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The returned outcome is a list of <code>data.frame</code>. Let’s take a look at the first 6 rows of the first 3 elements of the list.</p>
<div class="cell">
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extracted_values</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">head</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
  COUNTYFP date2009-08-01 date2009-08-02 date2009-08-03 date2009-08-04
1      175         30.954         27.629         34.411         37.547
2      175             NA             NA             NA             NA
3      175         30.866         27.506         34.229         37.464
4      175         30.837         27.398         34.126         37.364
5      175         30.759         27.369         33.969         37.323
6      175         30.584         27.399         33.734         37.284
  date2009-08-05 date2009-08-06 date2009-08-07 date2009-08-08 date2009-08-09
1         34.264         33.468         35.103         36.674         37.961
2             NA             NA             NA             NA             NA
3         34.217         33.348         34.925         36.552         37.861
4         34.198         33.314         34.860         36.442         37.762
5         34.159         33.186         34.728         36.463         37.778
6         34.098         33.092         34.512         36.487         37.723
  date2009-08-10 coverage_fraction
1         31.715         0.1074141
2             NA         0.8066747
3         31.564         0.8066615
4         31.432         0.8066448
5         31.463         0.8061629
6         31.592         0.8054324

[[2]]
  COUNTYFP date2009-08-01 date2009-08-02 date2009-08-03 date2009-08-04
1      027         29.623         26.370         32.274         35.627
2      027         29.657         26.306         32.209         35.527
3      027         29.665         26.254         32.213         35.421
4      027             NA             NA             NA             NA
5      027             NA             NA             NA             NA
6      027             NA             NA             NA             NA
  date2009-08-05 date2009-08-06 date2009-08-07 date2009-08-08 date2009-08-09
1         31.836         30.141         29.131         35.980         38.073
2         31.787         30.081         29.089         35.968         37.983
3         31.719         30.010         29.049         35.951         37.949
4             NA             NA             NA             NA             NA
5             NA             NA             NA             NA             NA
6             NA             NA             NA             NA             NA
  date2009-08-10 coverage_fraction
1         34.794        0.03732148
2         34.905        0.10592906
3         34.810        0.10249268
4             NA        0.10018899
5             NA        0.10074520
6             NA        0.09701102

[[3]]
  COUNTYFP date2009-08-01 date2009-08-02 date2009-08-03 date2009-08-04
1      171             NA             NA             NA             NA
2      171             NA             NA             NA             NA
3      171             NA             NA             NA             NA
4      171             NA             NA             NA             NA
5      171             NA             NA             NA             NA
6      171             NA             NA             NA             NA
  date2009-08-05 date2009-08-06 date2009-08-07 date2009-08-08 date2009-08-09
1             NA             NA             NA             NA             NA
2             NA             NA             NA             NA             NA
3             NA             NA             NA             NA             NA
4             NA             NA             NA             NA             NA
5             NA             NA             NA             NA             NA
6             NA             NA             NA             NA             NA
  date2009-08-10 coverage_fraction
1             NA         0.1813289
2             NA         0.3062004
3             NA         0.2972469
4             NA         0.2887933
5             NA         0.2825042
6             NA         0.2799884</code></pre>
</div>
</div>
<p>As you can see, each <code>data.frame</code> has variables called <code>COUNTYFP</code>, <code>date2009-08-01</code>, <span class="math inline">\(\dots\)</span>, <code>date2009-08-10</code> (they are from the layer names in <code>tmax_m8_y09_KS_sr</code>) and <code>coverage_fraction</code>. <code>COUNTYFP</code> was inherited from <code>KS_county_sf</code> thanks to <code>include_cols = "COUNTYFP"</code> and let us merge the extracted values with <code>KS_county_sf</code>.</p>
<p>In order to make the results easier to work with, you can process them to get a single <code>data.frame</code>, taking advantage of <code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">dplyr::bind_rows()</a></code> to combine the list of the datasets into one dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extracted_values_df</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">extracted_values</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- combine the list of data.frames ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">extracted_values_df</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  COUNTYFP date2009-08-01 date2009-08-02 date2009-08-03 date2009-08-04
1      175         30.954         27.629         34.411         37.547
2      175             NA             NA             NA             NA
3      175         30.866         27.506         34.229         37.464
4      175         30.837         27.398         34.126         37.364
5      175         30.759         27.369         33.969         37.323
6      175         30.584         27.399         33.734         37.284
  date2009-08-05 date2009-08-06 date2009-08-07 date2009-08-08 date2009-08-09
1         34.264         33.468         35.103         36.674         37.961
2             NA             NA             NA             NA             NA
3         34.217         33.348         34.925         36.552         37.861
4         34.198         33.314         34.860         36.442         37.762
5         34.159         33.186         34.728         36.463         37.778
6         34.098         33.092         34.512         36.487         37.723
  date2009-08-10 coverage_fraction
1         31.715         0.1074141
2             NA         0.8066747
3         31.564         0.8066615
4         31.432         0.8066448
5         31.463         0.8061629
6         31.592         0.8054324</code></pre>
</div>
</div>
<p>Now, let’s find area-weighted mean of tmax for each of the county-date combinations. The following code</p>
<ul>
<li>reshapes <code>extracted_values_df</code> to a long format</li>
<li>recovers date as <code>Date</code> object</li>
<li>calculates area-weighted mean of tmax by county-date</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extracted_values_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- long to wide ---#</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">COUNTYFP</span>, <span class="op">-</span><span class="va">coverage_fraction</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"tmax"</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- remove date  ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">#--- remove "date" from date and then convert it to Date ---#</span></span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">""</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- mean area-weighted tmax by county-date ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tmax</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 960 × 3
# Groups:   COUNTYFP [96]
   COUNTYFP date       `sum(tmax * coverage_fraction)/sum(coverage_fraction)`
   &lt;chr&gt;    &lt;date&gt;                                                      &lt;dbl&gt;
 1 005      2009-08-01                                                   28.2
 2 005      2009-08-02                                                   26.0
 3 005      2009-08-03                                                   29.3
 4 005      2009-08-04                                                   33.6
 5 005      2009-08-05                                                   30.4
 6 005      2009-08-06                                                   28.1
 7 005      2009-08-07                                                   28.9
 8 005      2009-08-08                                                   33.3
 9 005      2009-08-09                                                   34.8
10 005      2009-08-10                                                   34.4
# ℹ 950 more rows</code></pre>
</div>
</div>
<p>This can now be readily merged with <code>KS_county_sf</code> using <code>COUNTYFP</code> as the key.</p>
<hr></section><section id="summarizing-the-extracted-values-inside-exactextractrexact_extract" class="level4" data-number="6.10.3.3"><h4 data-number="6.10.3.3" class="anchored" data-anchor-id="summarizing-the-extracted-values-inside-exactextractrexact_extract">
<span class="header-section-number">6.10.3.3</span> Summarizing the extracted values inside <code>exactextractr::exact_extract()</code>
</h4>
<p>Instead of returning the value from all the intersecting cells, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> can summarize the extracted values by polygon and then return the summarized numbers. This is much like how <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> works, which we saw above. There are multiple default options you can choose from. All you need to do is to add the desired summary function name as the third argument of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. For example, the following will get us the mean of the extracted values weighted by <code>coverage_fraction</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extacted_mean</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr</span>, <span class="va">KS_county_sf</span>, <span class="st">"mean"</span>, append_cols <span class="op">=</span> <span class="st">"COUNTYFP"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">extacted_mean</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that you use <code>append_cols</code> instead of <code>include_cols</code> when you summarize within <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">mean_tmax_long</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">extacted_mean</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- wide to long ---#</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">-</span><span class="va">COUNTYFP</span>, names_to <span class="op">=</span> <span class="st">"date"</span>, values_to <span class="op">=</span> <span class="st">"tmax"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- recover date ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"mean.date"</span>, <span class="st">""</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,050 × 3
   COUNTYFP date        tmax
   &lt;chr&gt;    &lt;date&gt;     &lt;dbl&gt;
 1 175      2009-08-01  30.8
 2 175      2009-08-02  27.7
 3 175      2009-08-03  34.0
 4 175      2009-08-04  37.2
 5 175      2009-08-05  34.8
 6 175      2009-08-06  33.9
 7 175      2009-08-07  35.2
 8 175      2009-08-08  36.8
 9 175      2009-08-09  38.0
10 175      2009-08-10  32.3
# ℹ 1,040 more rows</code></pre>
</div>
</div>
<p>There are other summary function options that may be of interest, such as “max”, “min.” You can see all the default options at <a href="https://isciences.gitlab.io/exactextractr/index.html#summary-operations">the package website</a>.</p>
</section><section id="area-weighted-v.s.-coverage-fraction-weighted-summary-optional" class="level4 page-columns page-full" data-number="6.10.3.4"><h4 data-number="6.10.3.4" class="anchored" data-anchor-id="area-weighted-v.s.-coverage-fraction-weighted-summary-optional">
<span class="header-section-number">6.10.3.4</span> area-weighted v.s. coverage-fraction-weighted summary (Optional)</h4>
<p>When we found the mean of tmax weighted by coverage fraction, each raster cell was assumed to cover the same area. This is not exactly correct when a raster layer in geographic coordinates (latitude/longitude) is used. To see this, let’s find the area of each cell using <code><a href="https://rspatial.github.io/terra/reference/cellSize.html">terra::cellSize()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">raster_area_data</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/cellSize.html">cellSize</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 73, 179, 1  (nrow, ncol, nlyr)
resolution  : 0.04166667, 0.04166667  (x, y)
extent      : -102.0625, -94.60417, 36.97917, 40.02083  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 (EPSG:4269) 
source(s)   : memory
name        :     area 
min value   : 16461242 
max value   : 17149835 </code></pre>
</div>
</div>
<p>The output is a <code>SpatRaster</code>, where the area of the cells are stored as <code>values</code>. <a href="#fig-prism-raster-area" class="quarto-xref">Figure&nbsp;<span class="quarto-unresolved-ref">fig-prism-raster-area</span></a> shows the map of the PRISM raster cells in Kansas, color-differentiated by area.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb167"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">raster_area_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-prism-raster-area" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-prism-raster-area-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-stars_files/figure-html/fig-prism-raster-area-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prism-raster-area-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.11: Area of PRISM raster cells
</figcaption></figure>
</div>
</div>
</div>
<p>The area of a raster cell becomes slightly larger as the latitude increases. This is mainly due to the fact that 1 degree in longitude is longer in actual length on the earth surface at a higher latitude than at a lower latitude in the northern hemisphere.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> The mean of extracted values weighted by coverage fraction ignores this fact and implicitly assumes the all the cells have the same area.</p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;The opposite happens in the southern hemisphere.</p></div></div><p>In order to get an area-weighted mean instead of a coverage-weighted mean, you can use the “weighted_mean” option as the third argument and also supply the <code>SpatRaster</code> of area (<code>raster_area_data</code> here) like this:</p>
<div class="cell">
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extracted_weighted_mean</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">tmax_m8_y09_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    <span class="st">"weighted_mean"</span>,</span>
<span>    weights <span class="op">=</span> <span class="va">raster_area_data</span>,</span>
<span>    append_cols <span class="op">=</span> <span class="st">"COUNTYFP"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span>   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s compare the difference in the calculated means from the two methods for the first polygon.</p>
<div class="cell">
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extracted_weighted_mean</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">extacted_mean</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1]  1.316071e-04 -8.201599e-05 -1.201630e-04 -1.029968e-04  3.585815e-04
  [6]  8.010864e-05 -2.212524e-04 -1.335144e-05 -8.392334e-05 -1.640320e-04
 [11] -7.057190e-05 -4.386902e-05 -1.850128e-04 -1.506805e-04  6.504059e-04
 [16]  1.983643e-04  0.000000e+00  3.623962e-04  8.201599e-05  3.509521e-04
 [21]  3.814697e-06  1.258850e-04 -1.602173e-04 -9.155273e-05 -7.247925e-05
 [26] -4.768372e-05  0.000000e+00 -2.861023e-05 -4.005432e-05  4.577637e-05
 [31]  1.716614e-05  1.869202e-04  5.340576e-05 -4.386902e-05  1.621246e-04
 [36] -2.365112e-04  3.814697e-05  2.803802e-04 -4.005432e-05           NaN
 [41]  6.103516e-05  4.005432e-05  7.629395e-05 -1.392365e-04  2.593994e-04
 [46]  3.623962e-05 -3.814697e-05 -3.814697e-05  4.386902e-05 -1.907349e-06
 [51]  2.670288e-04  6.675720e-05  3.623962e-04  4.005432e-04 -1.029968e-04
 [56] -1.010895e-04 -7.247925e-05  0.000000e+00 -6.294250e-05 -7.629395e-06
 [61]           NaN -3.147125e-04 -5.149841e-05 -4.768372e-05 -1.487732e-04
 [66] -9.155273e-05           NaN  8.773804e-05 -1.525879e-05 -3.204346e-04
 [71]           NaN -5.531311e-04  5.722046e-06  1.201630e-03  6.866455e-05
 [76] -6.294250e-05 -7.629395e-06 -1.907349e-05  1.964569e-04 -1.869202e-04
 [81] -1.125336e-04  2.803802e-04  2.861023e-05 -1.964569e-04           NaN
 [86] -9.536743e-06  7.057190e-05 -2.536774e-04 -4.005432e-05 -3.623962e-05
 [91] -1.945496e-04 -2.593994e-04 -1.029968e-04           NaN           NaN
 [96]  4.959106e-05 -5.531311e-05           NaN -6.866455e-05  7.762909e-04
[101]  1.010895e-04 -7.629395e-06  5.531311e-05           NaN -8.392334e-05</code></pre>
</div>
</div>
<p>As you can see the error is minimal. So, the consequence of using coverage-weighted means should be negligible in most cases. Indeed, unless polygons span a wide range of latitude and longitude, the error introduce by using the coverage-weighted mean instead of area-weighted mean should be negligible.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-stars" class="csl-entry" role="listitem">
Pebesma, Edzer. 2020. <em>Stars: Spatiotemporal Arrays, Raster and Vector Data Cubes</em>. <a href="https://CRAN.R-project.org/package=stars">https://CRAN.R-project.org/package=stars</a>.
</div>
</div>
</section></section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tmieno2\.github\.io\/R-as-GIS-for-Economists\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/07-CreateMaps-ggplot.html" class="pagination-link" aria-label="Creating Maps using `ggplot2`">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb171" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatiotemporal Raster Data Handling with `stars` {#sec-stars-basics}</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="in">```{r chap_7_setup, include = FALSE}</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="in">library(knitr)</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a><span class="in">  echo = TRUE,</span></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a><span class="in">  cache = FALSE,</span></span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a><span class="in">  comment = NA,</span></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a><span class="in">  message = FALSE,</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a><span class="in">  warning = FALSE,</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy = FALSE,</span></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a><span class="in">  cache.lazy = FALSE</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a><span class="in">library(here)</span></span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a><span class="in">opts_knit$set(root.dir = here())</span></span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a><span class="in">```{r , eval = FALSE, echo = FALSE}</span></span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a><span class="in">setwd(here::here())</span></span>
<span id="cb171-21"><a href="#cb171-21" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-22"><a href="#cb171-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-23"><a href="#cb171-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include = FALSE, warning=FALSE, cache = FALSE}</span></span>
<span id="cb171-24"><a href="#cb171-24" aria-hidden="true" tabindex="-1"></a><span class="in">#--- load packages ---#</span></span>
<span id="cb171-25"><a href="#cb171-25" aria-hidden="true" tabindex="-1"></a><span class="in">library(data.table)</span></span>
<span id="cb171-26"><a href="#cb171-26" aria-hidden="true" tabindex="-1"></a><span class="in">library(stringr)</span></span>
<span id="cb171-27"><a href="#cb171-27" aria-hidden="true" tabindex="-1"></a><span class="in">library(raster)</span></span>
<span id="cb171-28"><a href="#cb171-28" aria-hidden="true" tabindex="-1"></a><span class="in">library(terra)</span></span>
<span id="cb171-29"><a href="#cb171-29" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb171-30"><a href="#cb171-30" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb171-31"><a href="#cb171-31" aria-hidden="true" tabindex="-1"></a><span class="in">library(gdalcubes)</span></span>
<span id="cb171-32"><a href="#cb171-32" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb171-33"><a href="#cb171-33" aria-hidden="true" tabindex="-1"></a><span class="in">library(lubridate)</span></span>
<span id="cb171-34"><a href="#cb171-34" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyr)</span></span>
<span id="cb171-35"><a href="#cb171-35" aria-hidden="true" tabindex="-1"></a><span class="in">library(viridis)</span></span>
<span id="cb171-36"><a href="#cb171-36" aria-hidden="true" tabindex="-1"></a><span class="in">library(tictoc)</span></span>
<span id="cb171-37"><a href="#cb171-37" aria-hidden="true" tabindex="-1"></a><span class="in">library(stars)</span></span>
<span id="cb171-38"><a href="#cb171-38" aria-hidden="true" tabindex="-1"></a><span class="in">library(tmap)</span></span>
<span id="cb171-39"><a href="#cb171-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-40"><a href="#cb171-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-41"><a href="#cb171-41" aria-hidden="true" tabindex="-1"></a><span class="fu">## Before you start {.unnumbered}</span></span>
<span id="cb171-42"><a href="#cb171-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-43"><a href="#cb171-43" aria-hidden="true" tabindex="-1"></a>In this chapter, we introduce the <span class="in">`stars`</span> package <span class="co">[</span><span class="ot">@stars</span><span class="co">]</span> for handling raster data. It is especially useful for those working with spatiotemporal raster datasets, such as daily PRISM and Daymet data, as it offers a consistent framework for managing raster data with temporal dimensions. Specifically, stars objects can include a time dimension in addition to the usual spatial 2D dimensions (longitude and latitude), with the time dimension accepting Date values. This feature proves to be particularly handy for tasks like filtering data by date, as you will see below.</span>
<span id="cb171-44"><a href="#cb171-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-45"><a href="#cb171-45" aria-hidden="true" tabindex="-1"></a>Another advantage of the <span class="in">`stars`</span> package is its compatibility with <span class="in">`sf`</span> objects as the lead developer of the two packages is the same person. Therefore, unlike the <span class="in">`terra`</span> package approach, we do not need any tedious conversions between <span class="in">`sf`</span> and <span class="in">`SpatVector`</span>. The <span class="in">`stars`</span> package also allows <span class="in">`dplyr`</span>-like data operations using functions like <span class="in">`dplyr::filter()`</span>, <span class="in">`dplyr::mutate()`</span> (see @sec-dplyr-op).</span>
<span id="cb171-46"><a href="#cb171-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-47"><a href="#cb171-47" aria-hidden="true" tabindex="-1"></a>In Chapters @sec-raster-basics and @sec-int-RV, we used the <span class="in">`raster`</span> and <span class="in">`terra`</span> packages to handle raster data and interact raster data with vector data. If you do not feel any inconvenience with the approach, you do not need to read on. Also, note that the <span class="in">`stars`</span> package was not written to replace either <span class="in">`raster`</span> or <span class="in">`terra`</span> packages. <span class="co">[</span><span class="ot">Here</span><span class="co">](https://github.com/r-spatial/stars/wiki/How-%60raster%60-functions-map-to-%60stars%60-functions)</span> is a good summary of how <span class="in">`raster`</span> functions map to <span class="in">`stars`</span> functions. As you can see, there are many functions that are available in the <span class="in">`terra`</span> packages that cannot be implemented by the <span class="in">`stars`</span> package. However, I must say the functionality of the <span class="in">`stars`</span> package is rather complete at least for most users, and it is definitely possible to use just the <span class="in">`stars`</span> package for all the raster data work in most cases.</span>
<span id="cb171-48"><a href="#cb171-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-49"><a href="#cb171-49" aria-hidden="true" tabindex="-1"></a>Finally, this book does not cover the use of <span class="in">`stars_proxy`</span> for big data that does not fit in your memory, which may be useful for some of you. <span class="co">[</span><span class="ot">This</span><span class="co">](https://r-spatial.github.io/stars/articles/stars2.html)</span> provides an introduction to <span class="in">`stars_proxy`</span> for those interested. This book also does not cover **irregular** raster cells (e.g., curvelinear grids). Interested readers are referred to <span class="co">[</span><span class="ot">here</span><span class="co">](https://r-spatial.github.io/stars/articles/stars4.html)</span>.</span>
<span id="cb171-50"><a href="#cb171-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-51"><a href="#cb171-51" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direction for replication {.unnumbered}</span></span>
<span id="cb171-52"><a href="#cb171-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-53"><a href="#cb171-53" aria-hidden="true" tabindex="-1"></a>**Datasets**</span>
<span id="cb171-54"><a href="#cb171-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-55"><a href="#cb171-55" aria-hidden="true" tabindex="-1"></a>All the datasets that you need to import are available <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/l8fmabfjjcuzu5u/aad75x8b_f3yvaq6ca5ap5oza?dl=0)</span>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</span>
<span id="cb171-56"><a href="#cb171-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-57"><a href="#cb171-57" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>set a folder (any folder) as the working directory using <span class="in">`setwd()`</span></span>
<span id="cb171-58"><a href="#cb171-58" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>create a folder called "Data" inside the folder designated as the working directory (if you have created a "Data" folder previously, skip this step)</span>
<span id="cb171-59"><a href="#cb171-59" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>download the pertinent datasets from <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/l8fmabfjjcuzu5u/aad75x8b_f3yvaq6ca5ap5oza?dl=0)</span> and put them in the "Data" folder</span>
<span id="cb171-60"><a href="#cb171-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-61"><a href="#cb171-61" aria-hidden="true" tabindex="-1"></a>**Packages**</span>
<span id="cb171-62"><a href="#cb171-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-63"><a href="#cb171-63" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Run the following code to install or load (if already installed) the <span class="in">`pacman`</span> package, and then install or load (if already installed) the listed package inside the <span class="in">`pacman::p_load()`</span> function.</span>
<span id="cb171-64"><a href="#cb171-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-65"><a href="#cb171-65" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Chap7_packages}</span></span>
<span id="cb171-66"><a href="#cb171-66" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require("pacman")) install.packages("pacman")</span></span>
<span id="cb171-67"><a href="#cb171-67" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(</span></span>
<span id="cb171-68"><a href="#cb171-68" aria-hidden="true" tabindex="-1"></a><span class="in">  stars, # spatiotemporal data handling</span></span>
<span id="cb171-69"><a href="#cb171-69" aria-hidden="true" tabindex="-1"></a><span class="in">  sf, # vector data handling</span></span>
<span id="cb171-70"><a href="#cb171-70" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyverse, # data wrangling</span></span>
<span id="cb171-71"><a href="#cb171-71" aria-hidden="true" tabindex="-1"></a><span class="in">  cubelyr, # handle raster data</span></span>
<span id="cb171-72"><a href="#cb171-72" aria-hidden="true" tabindex="-1"></a><span class="in">  tmap, # make maps</span></span>
<span id="cb171-73"><a href="#cb171-73" aria-hidden="true" tabindex="-1"></a><span class="in">  mapview, # make maps</span></span>
<span id="cb171-74"><a href="#cb171-74" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr, # fast raster data extraction</span></span>
<span id="cb171-75"><a href="#cb171-75" aria-hidden="true" tabindex="-1"></a><span class="in">  lubridate, # handle dates</span></span>
<span id="cb171-76"><a href="#cb171-76" aria-hidden="true" tabindex="-1"></a><span class="in">  prism # download PRISM data</span></span>
<span id="cb171-77"><a href="#cb171-77" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-78"><a href="#cb171-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-79"><a href="#cb171-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-80"><a href="#cb171-80" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Run the following code to define the theme for map:</span>
<span id="cb171-81"><a href="#cb171-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-82"><a href="#cb171-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{r define_theme_Chap7, cache = F}</span></span>
<span id="cb171-83"><a href="#cb171-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-84"><a href="#cb171-84" aria-hidden="true" tabindex="-1"></a><span class="in">theme_set(theme_bw())</span></span>
<span id="cb171-85"><a href="#cb171-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-86"><a href="#cb171-86" aria-hidden="true" tabindex="-1"></a><span class="in">theme_for_map &lt;- theme(</span></span>
<span id="cb171-87"><a href="#cb171-87" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks = element_blank(),</span></span>
<span id="cb171-88"><a href="#cb171-88" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text = element_blank(),</span></span>
<span id="cb171-89"><a href="#cb171-89" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.line = element_blank(),</span></span>
<span id="cb171-90"><a href="#cb171-90" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.border = element_blank(),</span></span>
<span id="cb171-91"><a href="#cb171-91" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.major = element_line(color = "transparent"),</span></span>
<span id="cb171-92"><a href="#cb171-92" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.minor = element_line(color = "transparent"),</span></span>
<span id="cb171-93"><a href="#cb171-93" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.background = element_blank(),</span></span>
<span id="cb171-94"><a href="#cb171-94" aria-hidden="true" tabindex="-1"></a><span class="in">  plot.background = element_rect(fill = "transparent", color = "transparent")</span></span>
<span id="cb171-95"><a href="#cb171-95" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-96"><a href="#cb171-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-97"><a href="#cb171-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-98"><a href="#cb171-98" aria-hidden="true" tabindex="-1"></a><span class="fu">## Understanding the structure of a `stars` object {#sec-stars-structure}</span></span>
<span id="cb171-99"><a href="#cb171-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-100"><a href="#cb171-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r layers-map-gen, echo = F, results = "hide", cache = F}</span></span>
<span id="cb171-101"><a href="#cb171-101" aria-hidden="true" tabindex="-1"></a><span class="in">library(viridis)</span></span>
<span id="cb171-102"><a href="#cb171-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-103"><a href="#cb171-103" aria-hidden="true" tabindex="-1"></a><span class="in">theme_for_map &lt;- theme(</span></span>
<span id="cb171-104"><a href="#cb171-104" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks = element_blank(),</span></span>
<span id="cb171-105"><a href="#cb171-105" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text = element_blank(),</span></span>
<span id="cb171-106"><a href="#cb171-106" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.title = element_blank(),</span></span>
<span id="cb171-107"><a href="#cb171-107" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.line = element_blank(),</span></span>
<span id="cb171-108"><a href="#cb171-108" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.border = element_blank(),</span></span>
<span id="cb171-109"><a href="#cb171-109" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.position = "bottom",</span></span>
<span id="cb171-110"><a href="#cb171-110" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.major = element_line(color = "transparent"),</span></span>
<span id="cb171-111"><a href="#cb171-111" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.minor = element_line(color = "transparent"),</span></span>
<span id="cb171-112"><a href="#cb171-112" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.background = element_blank(),</span></span>
<span id="cb171-113"><a href="#cb171-113" aria-hidden="true" tabindex="-1"></a><span class="in">  plot.background = element_rect(fill = "transparent", color = "transparent")</span></span>
<span id="cb171-114"><a href="#cb171-114" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-115"><a href="#cb171-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-116"><a href="#cb171-116" aria-hidden="true" tabindex="-1"></a><span class="in">vec_lr &lt;- c(1, 0)</span></span>
<span id="cb171-117"><a href="#cb171-117" aria-hidden="true" tabindex="-1"></a><span class="in">vec_sn &lt;- c(0.6, 0.3)</span></span>
<span id="cb171-118"><a href="#cb171-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-119"><a href="#cb171-119" aria-hidden="true" tabindex="-1"></a><span class="in">nrow &lt;- 20</span></span>
<span id="cb171-120"><a href="#cb171-120" aria-hidden="true" tabindex="-1"></a><span class="in">ncol &lt;- 20</span></span>
<span id="cb171-121"><a href="#cb171-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-122"><a href="#cb171-122" aria-hidden="true" tabindex="-1"></a><span class="in">row_col_data &lt;- expand.grid(row = 1:nrow, col = 1:ncol) %&gt;%</span></span>
<span id="cb171-123"><a href="#cb171-123" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table()</span></span>
<span id="cb171-124"><a href="#cb171-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-125"><a href="#cb171-125" aria-hidden="true" tabindex="-1"></a><span class="in">make_sf_grid &lt;- function(i) {</span></span>
<span id="cb171-126"><a href="#cb171-126" aria-hidden="true" tabindex="-1"></a><span class="in">  row_temp &lt;- row_col_data[i, row]</span></span>
<span id="cb171-127"><a href="#cb171-127" aria-hidden="true" tabindex="-1"></a><span class="in">  col_temp &lt;- row_col_data[i, col]</span></span>
<span id="cb171-128"><a href="#cb171-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-129"><a href="#cb171-129" aria-hidden="true" tabindex="-1"></a><span class="in">  origin &lt;- c(0, 0) + (col_temp - 1) * vec_lr + (row_temp - 1) * vec_sn</span></span>
<span id="cb171-130"><a href="#cb171-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-131"><a href="#cb171-131" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_mat &lt;- rbind(</span></span>
<span id="cb171-132"><a href="#cb171-132" aria-hidden="true" tabindex="-1"></a><span class="in">    origin,</span></span>
<span id="cb171-133"><a href="#cb171-133" aria-hidden="true" tabindex="-1"></a><span class="in">    origin + vec_lr,</span></span>
<span id="cb171-134"><a href="#cb171-134" aria-hidden="true" tabindex="-1"></a><span class="in">    origin + vec_lr + vec_sn,</span></span>
<span id="cb171-135"><a href="#cb171-135" aria-hidden="true" tabindex="-1"></a><span class="in">    origin + vec_sn,</span></span>
<span id="cb171-136"><a href="#cb171-136" aria-hidden="true" tabindex="-1"></a><span class="in">    origin</span></span>
<span id="cb171-137"><a href="#cb171-137" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb171-138"><a href="#cb171-138" aria-hidden="true" tabindex="-1"></a><span class="in">    list() %&gt;%</span></span>
<span id="cb171-139"><a href="#cb171-139" aria-hidden="true" tabindex="-1"></a><span class="in">    st_polygon() %&gt;%</span></span>
<span id="cb171-140"><a href="#cb171-140" aria-hidden="true" tabindex="-1"></a><span class="in">    st_sfc() %&gt;%</span></span>
<span id="cb171-141"><a href="#cb171-141" aria-hidden="true" tabindex="-1"></a><span class="in">    st_sf()</span></span>
<span id="cb171-142"><a href="#cb171-142" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb171-143"><a href="#cb171-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-144"><a href="#cb171-144" aria-hidden="true" tabindex="-1"></a><span class="in">all_polygons &lt;- lapply(1:nrow(row_col_data), make_sf_grid) %&gt;%</span></span>
<span id="cb171-145"><a href="#cb171-145" aria-hidden="true" tabindex="-1"></a><span class="in">  do.call("rbind", .)</span></span>
<span id="cb171-146"><a href="#cb171-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-147"><a href="#cb171-147" aria-hidden="true" tabindex="-1"></a><span class="in">g_layers &lt;- ggplot() +</span></span>
<span id="cb171-148"><a href="#cb171-148" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c(name = "tmax") +</span></span>
<span id="cb171-149"><a href="#cb171-149" aria-hidden="true" tabindex="-1"></a><span class="in">  xlim(-6, NA) +</span></span>
<span id="cb171-150"><a href="#cb171-150" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_for_map</span></span>
<span id="cb171-151"><a href="#cb171-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-152"><a href="#cb171-152" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_m8_y09_stars &lt;- stars::read_stars("Data/PRISM_tmax_y2009_m8.tif")</span></span>
<span id="cb171-153"><a href="#cb171-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-154"><a href="#cb171-154" aria-hidden="true" tabindex="-1"></a><span class="in">y_shift &lt;- 3</span></span>
<span id="cb171-155"><a href="#cb171-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-156"><a href="#cb171-156" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:10) {</span></span>
<span id="cb171-157"><a href="#cb171-157" aria-hidden="true" tabindex="-1"></a><span class="in">  tmep_prism_sf &lt;- tmax_m8_y09_stars["PRISM_tmax_y2009_m8.tif", 80:(80 + ncol - 1), 80:(80 + nrow - 1), i]</span></span>
<span id="cb171-158"><a href="#cb171-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-159"><a href="#cb171-159" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_values &lt;- pull(tmep_prism_sf, PRISM_tmax_y2009_m8.tif) %&gt;% as.vector()</span></span>
<span id="cb171-160"><a href="#cb171-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-161"><a href="#cb171-161" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_sf_to_add &lt;- mutate(all_polygons, value = temp_values)</span></span>
<span id="cb171-162"><a href="#cb171-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-163"><a href="#cb171-163" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_sf_to_add &lt;- st_set_geometry(</span></span>
<span id="cb171-164"><a href="#cb171-164" aria-hidden="true" tabindex="-1"></a><span class="in">    temp_sf_to_add,</span></span>
<span id="cb171-165"><a href="#cb171-165" aria-hidden="true" tabindex="-1"></a><span class="in">    st_geometry(temp_sf_to_add) + c(0, y_shift) * (i - 1)</span></span>
<span id="cb171-166"><a href="#cb171-166" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb171-167"><a href="#cb171-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-168"><a href="#cb171-168" aria-hidden="true" tabindex="-1"></a><span class="in">  g_layers &lt;- g_layers +</span></span>
<span id="cb171-169"><a href="#cb171-169" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_sf(data = temp_sf_to_add, aes(fill = value))</span></span>
<span id="cb171-170"><a href="#cb171-170" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb171-171"><a href="#cb171-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-172"><a href="#cb171-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-173"><a href="#cb171-173" aria-hidden="true" tabindex="-1"></a><span class="in">for (i in 1:10) {</span></span>
<span id="cb171-174"><a href="#cb171-174" aria-hidden="true" tabindex="-1"></a><span class="in">  g_layers &lt;- g_layers +</span></span>
<span id="cb171-175"><a href="#cb171-175" aria-hidden="true" tabindex="-1"></a><span class="in">    annotate("text", x = -4, y = (i - 1) * y_shift, label = paste0("8/", 10 + i, "/2009"), size = 4)</span></span>
<span id="cb171-176"><a href="#cb171-176" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb171-177"><a href="#cb171-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-178"><a href="#cb171-178" aria-hidden="true" tabindex="-1"></a><span class="in">g_layers &lt;- g_layers +</span></span>
<span id="cb171-179"><a href="#cb171-179" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate("text", x = nrow / 2, y = -1, label = "x", size = 6) +</span></span>
<span id="cb171-180"><a href="#cb171-180" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate("text", x = ncol + 8, y = 3, label = "y", size = 6)</span></span>
<span id="cb171-181"><a href="#cb171-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-182"><a href="#cb171-182" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(g_layers, "Data/stars_layers.rds")</span></span>
<span id="cb171-183"><a href="#cb171-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-184"><a href="#cb171-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-185"><a href="#cb171-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prepare_data_and_viz, eval = F, echo = F}</span></span>
<span id="cb171-186"><a href="#cb171-186" aria-hidden="true" tabindex="-1"></a><span class="in">#--- tmax ---#</span></span>
<span id="cb171-187"><a href="#cb171-187" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_m8_y09_small &lt;-</span></span>
<span id="cb171-188"><a href="#cb171-188" aria-hidden="true" tabindex="-1"></a><span class="in">  stars::read_stars("Data/PRISM_tmax_y2009_m8.tif") %&gt;%</span></span>
<span id="cb171-189"><a href="#cb171-189" aria-hidden="true" tabindex="-1"></a><span class="in">  .[, 80:(80 + ncol - 1), 80:(80 + nrow - 1), 11:20] %&gt;%</span></span>
<span id="cb171-190"><a href="#cb171-190" aria-hidden="true" tabindex="-1"></a><span class="in">  st_set_dimensions(3, values = 1:10, names = "band")</span></span>
<span id="cb171-191"><a href="#cb171-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-192"><a href="#cb171-192" aria-hidden="true" tabindex="-1"></a><span class="in">#* Note that offset does not get updated when selecting a portion of a stars obejct. Here, we write it to tif and then read it to get the offset right</span></span>
<span id="cb171-193"><a href="#cb171-193" aria-hidden="true" tabindex="-1"></a><span class="in">stars::write_stars(tmax_m8_y09_small, "Data/PRISM_tmax_y2009_m8_small.tif")</span></span>
<span id="cb171-194"><a href="#cb171-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-195"><a href="#cb171-195" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_m8_y09_small &lt;-</span></span>
<span id="cb171-196"><a href="#cb171-196" aria-hidden="true" tabindex="-1"></a><span class="in">  stars::read_stars("Data/PRISM_tmax_y2009_m8_small.tif") %&gt;%</span></span>
<span id="cb171-197"><a href="#cb171-197" aria-hidden="true" tabindex="-1"></a><span class="in">  setNames("tmax")</span></span>
<span id="cb171-198"><a href="#cb171-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-199"><a href="#cb171-199" aria-hidden="true" tabindex="-1"></a><span class="in">#--- ppt ---#</span></span>
<span id="cb171-200"><a href="#cb171-200" aria-hidden="true" tabindex="-1"></a><span class="in">ppt_m8_y09_small &lt;-</span></span>
<span id="cb171-201"><a href="#cb171-201" aria-hidden="true" tabindex="-1"></a><span class="in">  stars::read_stars("Data/PRISM_ppt_y2009_m8.tif") %&gt;%</span></span>
<span id="cb171-202"><a href="#cb171-202" aria-hidden="true" tabindex="-1"></a><span class="in">  .[, 80:(80 + ncol - 1), 80:(80 + nrow - 1), 11:20] %&gt;%</span></span>
<span id="cb171-203"><a href="#cb171-203" aria-hidden="true" tabindex="-1"></a><span class="in">  st_set_dimensions(3, values = 1:10, names = "band")</span></span>
<span id="cb171-204"><a href="#cb171-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-205"><a href="#cb171-205" aria-hidden="true" tabindex="-1"></a><span class="in">stars::write_stars(ppt_m8_y09_small, "Data/PRISM_ppt_y2009_m8_small.tif")</span></span>
<span id="cb171-206"><a href="#cb171-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-207"><a href="#cb171-207" aria-hidden="true" tabindex="-1"></a><span class="in">ppt_m8_y09_small &lt;-</span></span>
<span id="cb171-208"><a href="#cb171-208" aria-hidden="true" tabindex="-1"></a><span class="in">  stars::read_stars("Data/PRISM_ppt_y2009_m8_small.tif") %&gt;%</span></span>
<span id="cb171-209"><a href="#cb171-209" aria-hidden="true" tabindex="-1"></a><span class="in">  setNames("ppt")</span></span>
<span id="cb171-210"><a href="#cb171-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-211"><a href="#cb171-211" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine ---#</span></span>
<span id="cb171-212"><a href="#cb171-212" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_tmax_PRISM_m8_y09_small &lt;-</span></span>
<span id="cb171-213"><a href="#cb171-213" aria-hidden="true" tabindex="-1"></a><span class="in">  c(ppt_m8_y09_small, tmax_m8_y09_small) %&gt;%</span></span>
<span id="cb171-214"><a href="#cb171-214" aria-hidden="true" tabindex="-1"></a><span class="in">  st_set_dimensions(</span></span>
<span id="cb171-215"><a href="#cb171-215" aria-hidden="true" tabindex="-1"></a><span class="in">    3,</span></span>
<span id="cb171-216"><a href="#cb171-216" aria-hidden="true" tabindex="-1"></a><span class="in">    values = seq(ymd("2009/08/11"), ymd("2009/08/20"), by = "days"),</span></span>
<span id="cb171-217"><a href="#cb171-217" aria-hidden="true" tabindex="-1"></a><span class="in">    names = "date"</span></span>
<span id="cb171-218"><a href="#cb171-218" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb171-219"><a href="#cb171-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-220"><a href="#cb171-220" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(prcp_tmax_PRISM_m8_y09_small, "Data/prcp_tmax_PRISM_m8_y09_small.rds")</span></span>
<span id="cb171-221"><a href="#cb171-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-222"><a href="#cb171-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-223"><a href="#cb171-223" aria-hidden="true" tabindex="-1"></a>Let's import a <span class="in">`stars`</span> object of daily PRISM precipitation and tmax saved as an R dataset.</span>
<span id="cb171-224"><a href="#cb171-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-225"><a href="#cb171-225" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read_prism_stars, cache = F}</span></span>
<span id="cb171-226"><a href="#cb171-226" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read PRISM prcp and tmax data  ---#</span></span>
<span id="cb171-227"><a href="#cb171-227" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-228"><a href="#cb171-228" aria-hidden="true" tabindex="-1"></a><span class="in">  prcp_tmax_PRISM_m8_y09 &lt;- readRDS("Data/prcp_tmax_PRISM_m8_y09_small.rds")</span></span>
<span id="cb171-229"><a href="#cb171-229" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-230"><a href="#cb171-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-231"><a href="#cb171-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-232"><a href="#cb171-232" aria-hidden="true" tabindex="-1"></a>This <span class="in">`stars`</span> object has two attributes: <span class="in">`ppt`</span> (precipitation) and <span class="in">`tmax`</span> (maximum temperature). They are like variables in a regular <span class="in">`data.frame`</span>. They hold information we are interested in using for our analysis.</span>
<span id="cb171-233"><a href="#cb171-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-234"><a href="#cb171-234" aria-hidden="true" tabindex="-1"></a>This <span class="in">`stars`</span> object has three dimensions: <span class="in">`x`</span> (longitude), <span class="in">`y`</span> (latitude), and <span class="in">`date`</span>. Each dimension has <span class="in">`from`</span>, <span class="in">`to`</span>, <span class="in">`offset`</span>, <span class="in">`delta`</span>, <span class="in">`refsys`</span>, <span class="in">`point`</span>, and <span class="in">`values`</span>. Here are their definitions (except <span class="in">`point`</span><span class="ot">[^stars-3]</span>):</span>
<span id="cb171-235"><a href="#cb171-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-236"><a href="#cb171-236" aria-hidden="true" tabindex="-1"></a><span class="ot">[^stars-3]: </span>It is not clear what it really means. I have never had to pay attention to this parameter. So, its definition is not explained here. If you would like to investigate what it is, the best resource is probably <span class="co">[</span><span class="ot">this</span><span class="co">](https://r-spatial.github.io/stars/articles/stars4.html)</span></span>
<span id="cb171-237"><a href="#cb171-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-238"><a href="#cb171-238" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`from`</span>: beginning index</span>
<span id="cb171-239"><a href="#cb171-239" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`to`</span>: ending index</span>
<span id="cb171-240"><a href="#cb171-240" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`offset`</span>: starting value</span>
<span id="cb171-241"><a href="#cb171-241" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`delta`</span>: step value</span>
<span id="cb171-242"><a href="#cb171-242" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`refsys`</span>: GCS or CRS for <span class="in">`x`</span> and <span class="in">`y`</span> (and can be <span class="in">`Date`</span> for a date dimension)</span>
<span id="cb171-243"><a href="#cb171-243" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`values`</span>: values of the dimension when objects are not regular</span>
<span id="cb171-244"><a href="#cb171-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-245"><a href="#cb171-245" aria-hidden="true" tabindex="-1"></a>In order to understand the dimensions of <span class="in">`stars`</span> objects, let's first take a look at the figure below (@fig-two-d-map), which visualizes the tmax values on the 2D <span class="in">`x`</span>-<span class="in">`y`</span> surfaces of the <span class="in">`stars`</span> objects at 10th <span class="in">`date`</span> value (the spatial distribution of tmax at a particular date).</span>
<span id="cb171-246"><a href="#cb171-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-247"><a href="#cb171-247" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb171-248"><a href="#cb171-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-249"><a href="#cb171-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_dim_1, echo = F, cache = F}</span></span>
<span id="cb171-250"><a href="#cb171-250" aria-hidden="true" tabindex="-1"></a><span class="in">dim_prcp_tmin &lt;- stars::st_dimensions(prcp_tmax_PRISM_m8_y09)</span></span>
<span id="cb171-251"><a href="#cb171-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-252"><a href="#cb171-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-255"><a href="#cb171-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-256"><a href="#cb171-256" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-two-d-map</span></span>
<span id="cb171-257"><a href="#cb171-257" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb171-258"><a href="#cb171-258" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of tmax values on August 10, 2009: 20 by 20 matrix of cells"</span></span>
<span id="cb171-259"><a href="#cb171-259" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb171-260"><a href="#cb171-260" aria-hidden="true" tabindex="-1"></a><span class="co"># library(mapview)</span></span>
<span id="cb171-261"><a href="#cb171-261" aria-hidden="true" tabindex="-1"></a><span class="co"># library(leaflet)</span></span>
<span id="cb171-262"><a href="#cb171-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-263"><a href="#cb171-263" aria-hidden="true" tabindex="-1"></a>temp_data <span class="ot">&lt;-</span> prcp_tmax_PRISM_m8_y09[<span class="st">"tmax"</span>, , , <span class="dv">10</span>]</span>
<span id="cb171-264"><a href="#cb171-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-265"><a href="#cb171-265" aria-hidden="true" tabindex="-1"></a><span class="co"># x_mean &lt;- stars::st_get_dimension_values(temp_data, which = "x") %&gt;%  mean</span></span>
<span id="cb171-266"><a href="#cb171-266" aria-hidden="true" tabindex="-1"></a><span class="co"># y_mean &lt;- stars::st_get_dimension_values(temp_data, which = "y") %&gt;%  mean</span></span>
<span id="cb171-267"><a href="#cb171-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-268"><a href="#cb171-268" aria-hidden="true" tabindex="-1"></a><span class="co"># map_view &lt;- mapview(temp_data)</span></span>
<span id="cb171-269"><a href="#cb171-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-270"><a href="#cb171-270" aria-hidden="true" tabindex="-1"></a><span class="co"># map_view@map %&gt;% setView(x_mean, y_mean, zoom = 7.5)</span></span>
<span id="cb171-271"><a href="#cb171-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-272"><a href="#cb171-272" aria-hidden="true" tabindex="-1"></a>sf_point <span class="ot">&lt;-</span></span>
<span id="cb171-273"><a href="#cb171-273" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(dim_prcp_tmin<span class="sc">$</span>x<span class="sc">$</span>offset, dim_prcp_tmin<span class="sc">$</span>y<span class="sc">$</span>offset)) <span class="sc">%&gt;%</span></span>
<span id="cb171-274"><a href="#cb171-274" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_sfc</span>() <span class="sc">%&gt;%</span></span>
<span id="cb171-275"><a href="#cb171-275" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_crs</span>(<span class="fu">st_crs</span>(temp_data))</span>
<span id="cb171-276"><a href="#cb171-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-277"><a href="#cb171-277" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb171-278"><a href="#cb171-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> temp_data) <span class="sc">+</span></span>
<span id="cb171-279"><a href="#cb171-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> sf_point, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb171-280"><a href="#cb171-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"tmax"</span>) <span class="sc">+</span></span>
<span id="cb171-281"><a href="#cb171-281" aria-hidden="true" tabindex="-1"></a>  theme_for_map</span>
<span id="cb171-282"><a href="#cb171-282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-283"><a href="#cb171-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-284"><a href="#cb171-284" aria-hidden="true" tabindex="-1"></a>&lt;br&gt;</span>
<span id="cb171-285"><a href="#cb171-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-286"><a href="#cb171-286" aria-hidden="true" tabindex="-1"></a>You can consider the 2D x-y surface as a matrix, where the location of a cell is defined by the row number and column number. Since the <span class="in">`from`</span> for <span class="in">`x`</span> is <span class="in">`r dim_prcp_tmin$x$from`</span> and <span class="in">`to`</span> for <span class="in">`x`</span> is <span class="in">`r dim_prcp_tmin$x$to`</span>, we have <span class="in">`r dim_prcp_tmin$x$to - dim_prcp_tmin$x$from + 1`</span> columns. Similarly, since the <span class="in">`from`</span> for <span class="in">`y`</span> is <span class="in">`r dim_prcp_tmin$y$from`</span> and <span class="in">`to`</span> for <span class="in">`y`</span> is <span class="in">`r dim_prcp_tmin$y$to`</span>, we have <span class="in">`r dim_prcp_tmin$y$to - dim_prcp_tmin$y$from + 1`</span> rows. The <span class="in">`offset`</span> value of the <span class="in">`x`</span> and <span class="in">`y`</span> dimensions is the longitude and latitude of the upper-left corner point of the upper left cell of the 2D x-y surface, respectively (the red circle i@fig-two-d-map).<span class="ot">[^stars-4]</span> As <span class="in">`refsys`</span> indicates, they are in NAD83 GCS. The longitude of the upper-left corner point of all the cells in the $j$th column (from the left) of the 2D x-y surface is <span class="in">`r dim_prcp_tmin$x$offset`</span> + $(j-1)\times$ <span class="in">`r dim_prcp_tmin$x$delta`</span>, where <span class="in">`r dim_prcp_tmin$x$offset`</span> is <span class="in">`offset`</span> for <span class="in">`x`</span> and <span class="in">`r dim_prcp_tmin$x$delta`</span> is <span class="in">`delta`</span> for <span class="in">`x`</span>. Similarly, the latitude of the upper-left corner point of all the cells in the $i$th row (from the top) of the 2D x-y surface is <span class="in">`r dim_prcp_tmin$y$offset`</span> +$(i-1)\times$ <span class="in">`r dim_prcp_tmin$y$delta`</span>, where <span class="in">`r dim_prcp_tmin$y$offset`</span> is <span class="in">`offset`</span> for <span class="in">`y`</span> and <span class="in">`r dim_prcp_tmin$y$delta`</span> is <span class="in">`delta`</span> for <span class="in">`y`</span>.</span>
<span id="cb171-287"><a href="#cb171-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-288"><a href="#cb171-288" aria-hidden="true" tabindex="-1"></a><span class="ot">[^stars-4]: </span>This changes depending on the <span class="in">`delta`</span> of <span class="in">`x`</span> and <span class="in">`y`</span>. If both of the <span class="in">`delta`</span> for <span class="in">`x`</span> and <span class="in">`y`</span> are positive, then the <span class="in">`offset`</span> value of the <span class="in">`x`</span> and <span class="in">`y`</span> dimensions are the longitude and latitude of the upper-left corner point of the lower-left cell of the 2D x-y surface.</span>
<span id="cb171-289"><a href="#cb171-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-290"><a href="#cb171-290" aria-hidden="true" tabindex="-1"></a>The dimension characteristics of <span class="in">`x`</span> and <span class="in">`y`</span> are shared by all the layers across the date dimension, and a particular combination of <span class="in">`x`</span> and <span class="in">`y`</span> indexes refers to exactly the same location on the earth in all the layers across dates (of course). In the <span class="in">`date`</span> dimension, we have <span class="in">`r dim_prcp_tmin$date$to - dim_prcp_tmin$date$from + 1`</span> date values since the <span class="in">`from`</span> for <span class="in">`date`</span> is <span class="in">`r dim_prcp_tmin$date$from`</span> and <span class="in">`to`</span> for <span class="in">`date`</span> is <span class="in">`r dim_prcp_tmin$date$to`</span>. The <span class="in">`refsys`</span> of the <span class="in">`date`</span> dimension is <span class="in">`Date`</span>. Since the <span class="in">`offset`</span> is <span class="in">`r dim_prcp_tmin$date$offset`</span> and <span class="in">`delta`</span> is <span class="in">`r dim_prcp_tmin$date$delta`</span>, $k$th layer represents tmax values for August $11+k-1$, 2009.</span>
<span id="cb171-291"><a href="#cb171-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-292"><a href="#cb171-292" aria-hidden="true" tabindex="-1"></a>Putting all this information together, we have 20 by 20 x-y surfaces stacked over the <span class="in">`date`</span> dimension (10 layers), thus making up a 20 by 20 by 10 three-dimensional array (or cube) as shown in the figure below (@fig-map-layer-stars-structure).</span>
<span id="cb171-293"><a href="#cb171-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-296"><a href="#cb171-296" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-297"><a href="#cb171-297" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-layer-stars-structure</span></span>
<span id="cb171-298"><a href="#cb171-298" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visual illustration of stars data structure"</span></span>
<span id="cb171-299"><a href="#cb171-299" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb171-300"><a href="#cb171-300" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb171-301"><a href="#cb171-301" aria-hidden="true" tabindex="-1"></a>g_layers</span>
<span id="cb171-302"><a href="#cb171-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-303"><a href="#cb171-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-304"><a href="#cb171-304" aria-hidden="true" tabindex="-1"></a>Remember that <span class="in">`prcp_tmax_PRISM_m8_y09`</span> also has another attribute (<span class="in">`ppt`</span>) which is structured exactly the same way as <span class="in">`tmax`</span>. So, <span class="in">`prcp_tmax_PRISM_m8_y09`</span> basically has four dimensions: attribute, <span class="in">`x`</span>, <span class="in">`y`</span>, and <span class="in">`date`</span>.</span>
<span id="cb171-305"><a href="#cb171-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-306"><a href="#cb171-306" aria-hidden="true" tabindex="-1"></a>It is not guaranteed that all the dimensions are regularly spaced or timed. For an irregular dimension, dimension values themselves are stored in <span class="in">`values`</span> instead of using indexes, <span class="in">`offset`</span>, and <span class="in">`delta`</span> to find dimension values. For example, if you observe satellite data with 6-day gaps sometimes and 7-day gaps other times, then the date dimension would be irregular. We will see a made-up example of irregular time dimension in @sec-stars-set-time.</span>
<span id="cb171-307"><a href="#cb171-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-308"><a href="#cb171-308" aria-hidden="true" tabindex="-1"></a><span class="fu">## Some basic operations on `stars` objects</span></span>
<span id="cb171-309"><a href="#cb171-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-310"><a href="#cb171-310" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create a new attribute and drop a attribute</span></span>
<span id="cb171-311"><a href="#cb171-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-312"><a href="#cb171-312" aria-hidden="true" tabindex="-1"></a>You can add a new attribute to a <span class="in">`stars`</span> object just like you add a variable to a <span class="in">`data.frame`</span>.</span>
<span id="cb171-313"><a href="#cb171-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-316"><a href="#cb171-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-317"><a href="#cb171-317" aria-hidden="true" tabindex="-1"></a><span class="co">#--- define a new variable which is tmax - 20 ---#</span></span>
<span id="cb171-318"><a href="#cb171-318" aria-hidden="true" tabindex="-1"></a>prcp_tmax_PRISM_m8_y09<span class="sc">$</span>tmax_less_20 <span class="ot">&lt;-</span> prcp_tmax_PRISM_m8_y09<span class="sc">$</span>tmax <span class="sc">-</span> <span class="dv">20</span></span>
<span id="cb171-319"><a href="#cb171-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-320"><a href="#cb171-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-321"><a href="#cb171-321" aria-hidden="true" tabindex="-1"></a>As you can see below, <span class="in">`prcp_tmax_PRISM_m8_y09`</span> now has <span class="in">`tmax_less_20`</span> as an attribute.</span>
<span id="cb171-324"><a href="#cb171-324" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-325"><a href="#cb171-325" aria-hidden="true" tabindex="-1"></a>prcp_tmax_PRISM_m8_y09</span>
<span id="cb171-326"><a href="#cb171-326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-327"><a href="#cb171-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-328"><a href="#cb171-328" aria-hidden="true" tabindex="-1"></a>You can drop an attribute by assining <span class="in">`NULL`</span> to the attribute you want to drop.</span>
<span id="cb171-329"><a href="#cb171-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-332"><a href="#cb171-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-333"><a href="#cb171-333" aria-hidden="true" tabindex="-1"></a>prcp_tmax_PRISM_m8_y09<span class="sc">$</span>tmax_less_20 <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb171-334"><a href="#cb171-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-335"><a href="#cb171-335" aria-hidden="true" tabindex="-1"></a>prcp_tmax_PRISM_m8_y09</span>
<span id="cb171-336"><a href="#cb171-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-337"><a href="#cb171-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-338"><a href="#cb171-338" aria-hidden="true" tabindex="-1"></a><span class="fu">### Subset a `stars` object by index</span></span>
<span id="cb171-339"><a href="#cb171-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-340"><a href="#cb171-340" aria-hidden="true" tabindex="-1"></a>In order to access the value of an attribute (say <span class="in">`ppt`</span>) at a particular location at a particular time from the <span class="in">`stars`</span> object (<span class="in">`prcp_tmax_PRISM_m8_y09`</span>), you need to tell R that you are interested in the <span class="in">`ppt`</span> attribute and specify the corresponding index of <span class="in">`x`</span>, <span class="in">`y`</span>, and <span class="in">`date`</span>. Here, is how you get the <span class="in">`ppt`</span> value of (3, 4) cell at date = 10.</span>
<span id="cb171-341"><a href="#cb171-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-342"><a href="#cb171-342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract_tmax_subset}</span></span>
<span id="cb171-343"><a href="#cb171-343" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_tmax_PRISM_m8_y09["ppt", 3, 4, 10]</span></span>
<span id="cb171-344"><a href="#cb171-344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-345"><a href="#cb171-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-346"><a href="#cb171-346" aria-hidden="true" tabindex="-1"></a>This is very much similar to accessing a value from a matrix except that we have more dimensions. The first argument selects the attribute of interest, 2nd <span class="in">`x`</span>, 3rd <span class="in">`y`</span>, and 4th <span class="in">`date`</span>.</span>
<span id="cb171-347"><a href="#cb171-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-348"><a href="#cb171-348" aria-hidden="true" tabindex="-1"></a>Of course, you can subset a <span class="in">`stars`</span> object to access the value of multiple cells like this:</span>
<span id="cb171-349"><a href="#cb171-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-350"><a href="#cb171-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract_tmax_more}</span></span>
<span id="cb171-351"><a href="#cb171-351" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_tmax_PRISM_m8_y09["ppt", 3:6, 3:4, 5:10]</span></span>
<span id="cb171-352"><a href="#cb171-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-353"><a href="#cb171-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-354"><a href="#cb171-354" aria-hidden="true" tabindex="-1"></a><span class="fu">### Set attribute names</span></span>
<span id="cb171-355"><a href="#cb171-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-356"><a href="#cb171-356" aria-hidden="true" tabindex="-1"></a>When you read a raster dataset from a GeoTIFF file, the attribute name is the file name by default. So, you will often encounter cases where you want to change the attribute name. You can set the name of attributes using <span class="in">`setNames()`</span>.</span>
<span id="cb171-357"><a href="#cb171-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-358"><a href="#cb171-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r set_names}</span></span>
<span id="cb171-359"><a href="#cb171-359" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_tmax_PRISM_m8_y09_dif_names &lt;- setNames(prcp_tmax_PRISM_m8_y09, c("precipitation", "maximum_temp"))</span></span>
<span id="cb171-360"><a href="#cb171-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-361"><a href="#cb171-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-362"><a href="#cb171-362" aria-hidden="true" tabindex="-1"></a>Note that the attribute names of <span class="in">`prcp_tmax_PRISM_m8_y09`</span> (original datar) have not changed after this operation (just like <span class="in">`dplyr::mutate()`</span> or other <span class="in">`dplyr`</span> functions do):</span>
<span id="cb171-363"><a href="#cb171-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-364"><a href="#cb171-364" aria-hidden="true" tabindex="-1"></a><span class="in">```{r names_same}</span></span>
<span id="cb171-365"><a href="#cb171-365" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_tmax_PRISM_m8_y09</span></span>
<span id="cb171-366"><a href="#cb171-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-367"><a href="#cb171-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-368"><a href="#cb171-368" aria-hidden="true" tabindex="-1"></a>If you want to reflect changes in the variable names while keeping the same object name, you need to assign the output of <span class="in">`setNames()`</span> to the object as follows:</span>
<span id="cb171-369"><a href="#cb171-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-370"><a href="#cb171-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{r name_keep, eval = F}</span></span>
<span id="cb171-371"><a href="#cb171-371" aria-hidden="true" tabindex="-1"></a><span class="in"># the codes in the rest of this chapter use "precipitation" and "tmax" as the variables names, not these ones</span></span>
<span id="cb171-372"><a href="#cb171-372" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_tmax_PRISM_m8_y09 &lt;- setNames(prcp_tmax_PRISM_m8_y09, c("precipitation", "maximum_temp"))</span></span>
<span id="cb171-373"><a href="#cb171-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-374"><a href="#cb171-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-375"><a href="#cb171-375" aria-hidden="true" tabindex="-1"></a>We will be using this function in @sec-merge-two.</span>
<span id="cb171-376"><a href="#cb171-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-377"><a href="#cb171-377" aria-hidden="true" tabindex="-1"></a><span class="fu">### Get the coordinate reference system</span></span>
<span id="cb171-378"><a href="#cb171-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-379"><a href="#cb171-379" aria-hidden="true" tabindex="-1"></a>You can get the CRS of a <span class="in">`stars`</span> object using <span class="in">`sf::st_crs()`</span>, which is actually the same function name that we used to extract the CRS of an <span class="in">`sf`</span> object.</span>
<span id="cb171-380"><a href="#cb171-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-381"><a href="#cb171-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_crs}</span></span>
<span id="cb171-382"><a href="#cb171-382" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_crs(prcp_tmax_PRISM_m8_y09)</span></span>
<span id="cb171-383"><a href="#cb171-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-384"><a href="#cb171-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-385"><a href="#cb171-385" aria-hidden="true" tabindex="-1"></a>You will use this to change the projection of vector datasets when you interact them:</span>
<span id="cb171-386"><a href="#cb171-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-387"><a href="#cb171-387" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>crop the <span class="in">`stars`</span> raster dataset to the spatial extent of <span class="in">`sf`</span> objects</span>
<span id="cb171-388"><a href="#cb171-388" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>extract values from the <span class="in">`stars`</span> raster dataset for <span class="in">`sf`</span> objects</span>
<span id="cb171-389"><a href="#cb171-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-390"><a href="#cb171-390" aria-hidden="true" tabindex="-1"></a>as we will see in @sec-int-RV. Notice also that we used exactly the same function name (<span class="in">`sf::st_crs()`</span>) to get the CRS of <span class="in">`sf`</span> objects (see @sec-vector-basics).</span>
<span id="cb171-391"><a href="#cb171-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-392"><a href="#cb171-392" aria-hidden="true" tabindex="-1"></a><span class="fu">### Get the dimension characteristics and values</span></span>
<span id="cb171-393"><a href="#cb171-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-394"><a href="#cb171-394" aria-hidden="true" tabindex="-1"></a>You can access these dimension values using <span class="in">`st_dimensions()`</span>.</span>
<span id="cb171-395"><a href="#cb171-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-396"><a href="#cb171-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_dim}</span></span>
<span id="cb171-397"><a href="#cb171-397" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get dimension characteristics ---#</span></span>
<span id="cb171-398"><a href="#cb171-398" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-399"><a href="#cb171-399" aria-hidden="true" tabindex="-1"></a><span class="in">  dim_prcp_tmin &lt;- stars::st_dimensions(prcp_tmax_PRISM_m8_y09)</span></span>
<span id="cb171-400"><a href="#cb171-400" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-401"><a href="#cb171-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-402"><a href="#cb171-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-403"><a href="#cb171-403" aria-hidden="true" tabindex="-1"></a>The following shows what we can get from this object.</span>
<span id="cb171-404"><a href="#cb171-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-405"><a href="#cb171-405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb171-406"><a href="#cb171-406" aria-hidden="true" tabindex="-1"></a><span class="in">str(dim_prcp_tmin)</span></span>
<span id="cb171-407"><a href="#cb171-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-408"><a href="#cb171-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-409"><a href="#cb171-409" aria-hidden="true" tabindex="-1"></a>For example, you can get <span class="in">`offset`</span> of <span class="in">`x`</span> as follows:</span>
<span id="cb171-410"><a href="#cb171-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-411"><a href="#cb171-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb171-412"><a href="#cb171-412" aria-hidden="true" tabindex="-1"></a><span class="in">dim_prcp_tmin$x$offset</span></span>
<span id="cb171-413"><a href="#cb171-413" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-414"><a href="#cb171-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-415"><a href="#cb171-415" aria-hidden="true" tabindex="-1"></a>You can extract dimension values using <span class="in">`stars::st_get_dimension_values()`</span>. For example, to get values of <span class="in">`date`</span>,</span>
<span id="cb171-416"><a href="#cb171-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-417"><a href="#cb171-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-values-date}</span></span>
<span id="cb171-418"><a href="#cb171-418" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get date values ---#</span></span>
<span id="cb171-419"><a href="#cb171-419" aria-hidden="true" tabindex="-1"></a><span class="in">stars::st_get_dimension_values(prcp_tmax_PRISM_m8_y09, "date")</span></span>
<span id="cb171-420"><a href="#cb171-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-421"><a href="#cb171-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-422"><a href="#cb171-422" aria-hidden="true" tabindex="-1"></a>This can be handy as you will see in @sec-daymet-poly. Later in @sec-stars-set-time, we will learn how to set dimensions using <span class="in">`stars::st_set_dimensions()`</span>.</span>
<span id="cb171-423"><a href="#cb171-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-424"><a href="#cb171-424" aria-hidden="true" tabindex="-1"></a><span class="fu">### Attributes to dimensions, and vice versa</span></span>
<span id="cb171-425"><a href="#cb171-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-426"><a href="#cb171-426" aria-hidden="true" tabindex="-1"></a>You can make attributes to dimensions using <span class="in">`base::merge()`</span>.</span>
<span id="cb171-427"><a href="#cb171-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-428"><a href="#cb171-428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r merge-att-dim}</span></span>
<span id="cb171-429"><a href="#cb171-429" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-430"><a href="#cb171-430" aria-hidden="true" tabindex="-1"></a><span class="in">  prcp_tmax_four &lt;- base::merge(prcp_tmax_PRISM_m8_y09)</span></span>
<span id="cb171-431"><a href="#cb171-431" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-432"><a href="#cb171-432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-433"><a href="#cb171-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-434"><a href="#cb171-434" aria-hidden="true" tabindex="-1"></a>As you can see, the new <span class="in">`stars`</span> object has an additional dimension called <span class="in">`attributes`</span>, which represents attributes and has two dimension values: the first for <span class="in">`ppt`</span> and second for <span class="in">`tmax`</span>. Now, if you want to access <span class="in">`ppt`</span>, you can do the following:</span>
<span id="cb171-435"><a href="#cb171-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-436"><a href="#cb171-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r access-ppt}</span></span>
<span id="cb171-437"><a href="#cb171-437" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_tmax_four[, , , , "ppt"]</span></span>
<span id="cb171-438"><a href="#cb171-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-439"><a href="#cb171-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-440"><a href="#cb171-440" aria-hidden="true" tabindex="-1"></a>We can do this because the merge kept the attribute names as dimension values as you can see in <span class="in">`values`</span>.</span>
<span id="cb171-441"><a href="#cb171-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-442"><a href="#cb171-442" aria-hidden="true" tabindex="-1"></a>You can revert it back to the original state using <span class="in">`base::split()`</span>. Since we want the fourth dimension to dissolve,</span>
<span id="cb171-443"><a href="#cb171-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-444"><a href="#cb171-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r split}</span></span>
<span id="cb171-445"><a href="#cb171-445" aria-hidden="true" tabindex="-1"></a><span class="in">base::split(prcp_tmax_four, 4)</span></span>
<span id="cb171-446"><a href="#cb171-446" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-447"><a href="#cb171-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-448"><a href="#cb171-448" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quick visualization for exploration</span></span>
<span id="cb171-449"><a href="#cb171-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-450"><a href="#cb171-450" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`plot()`</span> to have a quick static map and <span class="in">`tmap::mapview()`</span> or the <span class="in">`tmap`</span> package for interactive views.</span>
<span id="cb171-451"><a href="#cb171-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-452"><a href="#cb171-452" aria-hidden="true" tabindex="-1"></a><span class="in">```{r static-map}</span></span>
<span id="cb171-453"><a href="#cb171-453" aria-hidden="true" tabindex="-1"></a><span class="in">plot(prcp_tmax_PRISM_m8_y09["tmax", , , ])</span></span>
<span id="cb171-454"><a href="#cb171-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-455"><a href="#cb171-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-456"><a href="#cb171-456" aria-hidden="true" tabindex="-1"></a>It only plots the first attribute if the <span class="in">`stars`</span> object has multiple attributes:</span>
<span id="cb171-457"><a href="#cb171-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-458"><a href="#cb171-458" aria-hidden="true" tabindex="-1"></a><span class="in">```{r static-map-one}</span></span>
<span id="cb171-459"><a href="#cb171-459" aria-hidden="true" tabindex="-1"></a><span class="in">plot(prcp_tmax_PRISM_m8_y09)</span></span>
<span id="cb171-460"><a href="#cb171-460" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-461"><a href="#cb171-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-462"><a href="#cb171-462" aria-hidden="true" tabindex="-1"></a>, which is identical with this:</span>
<span id="cb171-463"><a href="#cb171-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-464"><a href="#cb171-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r static-map-identical}</span></span>
<span id="cb171-465"><a href="#cb171-465" aria-hidden="true" tabindex="-1"></a><span class="in">plot(prcp_tmax_PRISM_m8_y09["ppt", , , ])</span></span>
<span id="cb171-466"><a href="#cb171-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-467"><a href="#cb171-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-468"><a href="#cb171-468" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reading and writing raster data {#sec-read-write-stars}</span></span>
<span id="cb171-469"><a href="#cb171-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-470"><a href="#cb171-470" aria-hidden="true" tabindex="-1"></a>There are so many formats in which raster data is stored. Some of the common ones include GeoTIFF, netCDF, GRIB. All the available GDAL drivers for reading and writing raster data can be found by the following code:</span>
<span id="cb171-471"><a href="#cb171-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-472"><a href="#cb171-472" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_drivers, eval = F}</span></span>
<span id="cb171-473"><a href="#cb171-473" aria-hidden="true" tabindex="-1"></a><span class="in">#| output-location: column</span></span>
<span id="cb171-474"><a href="#cb171-474" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_drivers(what = "raster") %&gt;% DT::datatable()</span></span>
<span id="cb171-475"><a href="#cb171-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-476"><a href="#cb171-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-477"><a href="#cb171-477" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reading raster data</span></span>
<span id="cb171-478"><a href="#cb171-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-479"><a href="#cb171-479" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`stars::read_stars()`</span> to read a raster data file. It is very unlikely that the raster file you are trying to read is not in one of the supported formats.</span>
<span id="cb171-480"><a href="#cb171-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-481"><a href="#cb171-481" aria-hidden="true" tabindex="-1"></a>For example, you can read a GeoTIFF file as follows:</span>
<span id="cb171-482"><a href="#cb171-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-483"><a href="#cb171-483" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read_stars_tif}</span></span>
<span id="cb171-484"><a href="#cb171-484" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-485"><a href="#cb171-485" aria-hidden="true" tabindex="-1"></a><span class="in">  ppt_m1_y09_stars &lt;- stars::read_stars("Data/PRISM_ppt_y2009_m1.tif")</span></span>
<span id="cb171-486"><a href="#cb171-486" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-487"><a href="#cb171-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-488"><a href="#cb171-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-489"><a href="#cb171-489" aria-hidden="true" tabindex="-1"></a>This one imports a raw PRISM data stored as a BIL file.</span>
<span id="cb171-490"><a href="#cb171-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-491"><a href="#cb171-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read-prism}</span></span>
<span id="cb171-492"><a href="#cb171-492" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-493"><a href="#cb171-493" aria-hidden="true" tabindex="-1"></a><span class="in">  prism_tmax_20180701 &lt;- stars::read_stars("Data/PRISM_tmax_stable_4kmD2_20180701_bil/PRISM_tmax_stable_4kmD2_20180701_bil.bil")</span></span>
<span id="cb171-494"><a href="#cb171-494" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-495"><a href="#cb171-495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-496"><a href="#cb171-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-497"><a href="#cb171-497" aria-hidden="true" tabindex="-1"></a>You can import multiple raster data files into one <span class="in">`stars`</span> object by simply supplying a vector of file names:</span>
<span id="cb171-498"><a href="#cb171-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-499"><a href="#cb171-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read-prism-files}</span></span>
<span id="cb171-500"><a href="#cb171-500" aria-hidden="true" tabindex="-1"></a><span class="in">files &lt;-</span></span>
<span id="cb171-501"><a href="#cb171-501" aria-hidden="true" tabindex="-1"></a><span class="in">  c(</span></span>
<span id="cb171-502"><a href="#cb171-502" aria-hidden="true" tabindex="-1"></a><span class="in">    "Data/PRISM_tmax_stable_4kmD2_20180701_bil/PRISM_tmax_stable_4kmD2_20180701_bil.bil",</span></span>
<span id="cb171-503"><a href="#cb171-503" aria-hidden="true" tabindex="-1"></a><span class="in">    "Data/PRISM_tmax_stable_4kmD2_20180702_bil/PRISM_tmax_stable_4kmD2_20180702_bil.bil"</span></span>
<span id="cb171-504"><a href="#cb171-504" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb171-505"><a href="#cb171-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-506"><a href="#cb171-506" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-507"><a href="#cb171-507" aria-hidden="true" tabindex="-1"></a><span class="in">  prism_tmax_201807_two &lt;- stars::read_stars(files)</span></span>
<span id="cb171-508"><a href="#cb171-508" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-509"><a href="#cb171-509" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-510"><a href="#cb171-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-511"><a href="#cb171-511" aria-hidden="true" tabindex="-1"></a>As you can see, each file becomes an attribute. It is more convenient to have them as layers stacked along the third dimension. To do that you can add <span class="in">`along = 3`</span> option as follows:</span>
<span id="cb171-512"><a href="#cb171-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-513"><a href="#cb171-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read-stars-along}</span></span>
<span id="cb171-514"><a href="#cb171-514" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-515"><a href="#cb171-515" aria-hidden="true" tabindex="-1"></a><span class="in">  prism_tmax_201807_two &lt;- stars::read_stars(files, along = 3)</span></span>
<span id="cb171-516"><a href="#cb171-516" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-517"><a href="#cb171-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-518"><a href="#cb171-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-519"><a href="#cb171-519" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb171-520"><a href="#cb171-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-521"><a href="#cb171-521" aria-hidden="true" tabindex="-1"></a>Note that while the GeoTIFF format (and many other formats) can store multi-band (multi-layer) raster data allowing for an additional dimension beyond <span class="in">`x`</span> and <span class="in">`y`</span>, it does not store the values of the dimension like the <span class="in">`date`</span> dimension we saw in <span class="in">`prcp_tmax_PRISM_m8_y09`</span>. So, when you read a multi-layer raster data saved as a GeoTIFF, the third dimension of the resulting <span class="in">`stars`</span> object will always be called <span class="in">`band`</span> without any explicit time information. On the other hand, netCDF files are capable of storing the time dimension values. So, when you read a netCDF file with valid time dimension, you will have time dimension when it is read.</span>
<span id="cb171-522"><a href="#cb171-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-523"><a href="#cb171-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read_ncdf}</span></span>
<span id="cb171-524"><a href="#cb171-524" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-525"><a href="#cb171-525" aria-hidden="true" tabindex="-1"></a><span class="in">  stars::read_ncdf(system.file("nc/bcsd_obs_1999.nc", package = "stars"))</span></span>
<span id="cb171-526"><a href="#cb171-526" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-527"><a href="#cb171-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-528"><a href="#cb171-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-529"><a href="#cb171-529" aria-hidden="true" tabindex="-1"></a>The <span class="in">`refsys`</span> of the time dimension is <span class="in">`POSIXct`</span>, which is one of the date classes.</span>
<span id="cb171-530"><a href="#cb171-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-531"><a href="#cb171-531" aria-hidden="true" tabindex="-1"></a><span class="fu">### Writing a `stars` object to a file</span></span>
<span id="cb171-532"><a href="#cb171-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-533"><a href="#cb171-533" aria-hidden="true" tabindex="-1"></a>You can write a <span class="in">`stars`</span> object to a file using <span class="in">`stars::write_stars()`</span> using one of the GDAL drivers.</span>
<span id="cb171-534"><a href="#cb171-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-535"><a href="#cb171-535" aria-hidden="true" tabindex="-1"></a>Let's save <span class="in">`prcp_tmax_PRISM_m8_y09["tmax",,,]`</span>, which has <span class="in">`date`</span> dimension whose <span class="in">`refsys`</span> is <span class="in">`Date`</span>.</span>
<span id="cb171-536"><a href="#cb171-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-537"><a href="#cb171-537" aria-hidden="true" tabindex="-1"></a><span class="in">```{r write_stars, eval = F}</span></span>
<span id="cb171-538"><a href="#cb171-538" aria-hidden="true" tabindex="-1"></a><span class="in">stars::write_stars(prcp_tmax_PRISM_m8_y09["tmax", , , ], "Data/tmax_m8_y09_from_stars.tif")</span></span>
<span id="cb171-539"><a href="#cb171-539" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-540"><a href="#cb171-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-541"><a href="#cb171-541" aria-hidden="true" tabindex="-1"></a>Let's read the file we just saved.</span>
<span id="cb171-542"><a href="#cb171-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-543"><a href="#cb171-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read_stars_saved}</span></span>
<span id="cb171-544"><a href="#cb171-544" aria-hidden="true" tabindex="-1"></a><span class="in">stars::read_stars("Data/tmax_m8_y09_from_stars.tif")</span></span>
<span id="cb171-545"><a href="#cb171-545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-546"><a href="#cb171-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-547"><a href="#cb171-547" aria-hidden="true" tabindex="-1"></a>Notice that the third dimension is now called band and all the date information is lost. The loss of information happened when we saved <span class="in">`prcp_tmax_PRISM_m8_y09["tmax",,,]`</span> as a GeoTIFF file. One easy way to avoid this problem is to just save a <span class="in">`stars`</span> object as an R dataset.</span>
<span id="cb171-548"><a href="#cb171-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-549"><a href="#cb171-549" aria-hidden="true" tabindex="-1"></a><span class="in">```{r save_as_rds, eval = F}</span></span>
<span id="cb171-550"><a href="#cb171-550" aria-hidden="true" tabindex="-1"></a><span class="in">#--- save it as an rds file ---#</span></span>
<span id="cb171-551"><a href="#cb171-551" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(prcp_tmax_PRISM_m8_y09["tmax", , , ], "Data/tmax_m8_y09_from_stars.rds")</span></span>
<span id="cb171-552"><a href="#cb171-552" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-553"><a href="#cb171-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-554"><a href="#cb171-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read_rds}</span></span>
<span id="cb171-555"><a href="#cb171-555" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read it back ---#</span></span>
<span id="cb171-556"><a href="#cb171-556" aria-hidden="true" tabindex="-1"></a><span class="in">readRDS("Data/tmax_m8_y09_from_stars.rds")</span></span>
<span id="cb171-557"><a href="#cb171-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-558"><a href="#cb171-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-559"><a href="#cb171-559" aria-hidden="true" tabindex="-1"></a>As you can see, date information is retained. So, if you are the only one who uses this data or all of your team members use R, then this is a nice solution to the problem. At the moment, it is not possible to use <span class="in">`stars::write_stars()`</span> to write to a netCDF file that supports the third dimension as time. However, this may not be the case for a long time (See the discussion <span class="co">[</span><span class="ot">here</span><span class="co">](https://github.com/r-spatial/stars/issues/8)</span>).</span>
<span id="cb171-560"><a href="#cb171-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-561"><a href="#cb171-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-562"><a href="#cb171-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-563"><a href="#cb171-563" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting the time dimension manually {#sec-stars-set-time}</span></span>
<span id="cb171-564"><a href="#cb171-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-565"><a href="#cb171-565" aria-hidden="true" tabindex="-1"></a>For this section, we will use PRISM precipitation data for U.S. for January, 2009.</span>
<span id="cb171-566"><a href="#cb171-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-567"><a href="#cb171-567" aria-hidden="true" tabindex="-1"></a><span class="in">```{r starting_object}</span></span>
<span id="cb171-568"><a href="#cb171-568" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-569"><a href="#cb171-569" aria-hidden="true" tabindex="-1"></a><span class="in">  ppt_m1_y09_stars &lt;- stars::read_stars("Data/PRISM_ppt_y2009_m1.tif")</span></span>
<span id="cb171-570"><a href="#cb171-570" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-571"><a href="#cb171-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-572"><a href="#cb171-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-573"><a href="#cb171-573" aria-hidden="true" tabindex="-1"></a>As you can see, when you read a GeoTIFF file, the third dimension will always be called <span class="in">`band`</span> because GeoTIFF format does not support dimension values for the third dimension.<span class="ot">[^stars-8]</span></span>
<span id="cb171-574"><a href="#cb171-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-575"><a href="#cb171-575" aria-hidden="true" tabindex="-1"></a><span class="ot">[^stars-8]: </span>In @sec-stars-structure, we read an <span class="in">`rds`</span>, which is a <span class="in">`stars`</span> object with dimension name set manually.</span>
<span id="cb171-576"><a href="#cb171-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-577"><a href="#cb171-577" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`st_set_dimension()`</span> to set the third dimension (called <span class="in">`band`</span>) as the time dimension using <span class="in">`Date`</span> object. This can be convenient when you would like to filter the data by date using <span class="in">`filter()`</span> as we will see later.</span>
<span id="cb171-578"><a href="#cb171-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-579"><a href="#cb171-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-580"><a href="#cb171-580" aria-hidden="true" tabindex="-1"></a>For <span class="in">`ppt_m1_y09_stars`</span>, precipitation is observed on a daily basis from January 1, 2009 to January 31, 2009, where the band value of **x** corresponds to January **x**, 2009. So, we can first create a vector of dates as follows (If you are not familiar with <span class="in">`Dates`</span> and the <span class="in">`lubridate`</span> pacakge, <span class="co">[</span><span class="ot">this</span><span class="co">](http://uc-r.github.io/dates/)</span> is a good resource to learn them.):</span>
<span id="cb171-581"><a href="#cb171-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-582"><a href="#cb171-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_dates}</span></span>
<span id="cb171-583"><a href="#cb171-583" aria-hidden="true" tabindex="-1"></a><span class="in">#--- starting date ---#</span></span>
<span id="cb171-584"><a href="#cb171-584" aria-hidden="true" tabindex="-1"></a><span class="in">start_date &lt;- lubridate::ymd("2009-01-01")</span></span>
<span id="cb171-585"><a href="#cb171-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-586"><a href="#cb171-586" aria-hidden="true" tabindex="-1"></a><span class="in">#--- ending date ---#</span></span>
<span id="cb171-587"><a href="#cb171-587" aria-hidden="true" tabindex="-1"></a><span class="in">end_date &lt;- lubridate::ymd("2009-01-31")</span></span>
<span id="cb171-588"><a href="#cb171-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-589"><a href="#cb171-589" aria-hidden="true" tabindex="-1"></a><span class="in">#--- sequence of dates  ---#</span></span>
<span id="cb171-590"><a href="#cb171-590" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-591"><a href="#cb171-591" aria-hidden="true" tabindex="-1"></a><span class="in">dates_ls_m1 &lt;- seq(start_date, end_date, "days")</span></span>
<span id="cb171-592"><a href="#cb171-592" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-593"><a href="#cb171-593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-594"><a href="#cb171-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-595"><a href="#cb171-595" aria-hidden="true" tabindex="-1"></a>We can then use <span class="in">`stars::st_set_dimensions()`</span> to change the third dimension to the dimension of date.</span>
<span id="cb171-596"><a href="#cb171-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-597"><a href="#cb171-597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb171-598"><a href="#cb171-598" aria-hidden="true" tabindex="-1"></a><span class="in">stars::st_set_dimensions(</span></span>
<span id="cb171-599"><a href="#cb171-599" aria-hidden="true" tabindex="-1"></a><span class="in">  stars object,</span></span>
<span id="cb171-600"><a href="#cb171-600" aria-hidden="true" tabindex="-1"></a><span class="in">  dimension,</span></span>
<span id="cb171-601"><a href="#cb171-601" aria-hidden="true" tabindex="-1"></a><span class="in">  values = dimension values,</span></span>
<span id="cb171-602"><a href="#cb171-602" aria-hidden="true" tabindex="-1"></a><span class="in">  names = name of the dimension</span></span>
<span id="cb171-603"><a href="#cb171-603" aria-hidden="true" tabindex="-1"></a><span class="in"> )</span></span>
<span id="cb171-604"><a href="#cb171-604" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-605"><a href="#cb171-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-606"><a href="#cb171-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dimension_set}</span></span>
<span id="cb171-607"><a href="#cb171-607" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-608"><a href="#cb171-608" aria-hidden="true" tabindex="-1"></a><span class="in">  ppt_m1_y09_stars &lt;-</span></span>
<span id="cb171-609"><a href="#cb171-609" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::st_set_dimensions(</span></span>
<span id="cb171-610"><a href="#cb171-610" aria-hidden="true" tabindex="-1"></a><span class="in">      ppt_m1_y09_stars,</span></span>
<span id="cb171-611"><a href="#cb171-611" aria-hidden="true" tabindex="-1"></a><span class="in">      3,</span></span>
<span id="cb171-612"><a href="#cb171-612" aria-hidden="true" tabindex="-1"></a><span class="in">      values = dates_ls_m1,</span></span>
<span id="cb171-613"><a href="#cb171-613" aria-hidden="true" tabindex="-1"></a><span class="in">      names = "date"</span></span>
<span id="cb171-614"><a href="#cb171-614" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb171-615"><a href="#cb171-615" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-616"><a href="#cb171-616" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-617"><a href="#cb171-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-618"><a href="#cb171-618" aria-hidden="true" tabindex="-1"></a>As you can see, the third dimension has become date. The value of offset for the date dimension has become <span class="in">`2009-01-01`</span> meaning the starting date value is now <span class="in">`2009-01-01`</span>. Further, the value of delta is now 1 days, so date dimension of **x** corresponds to `2009-01-01` + **x** - 1 = <span class="in">`2009-01-x`</span>.</span>
<span id="cb171-619"><a href="#cb171-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-620"><a href="#cb171-620" aria-hidden="true" tabindex="-1"></a>Note that the date dimension does not have to be regularly spaced. For example, you may have satellite images available for your area with a 5-day interval sometimes and a 6-day interval other times. This is perfectly fine. As an illustration, I will create a wrong sequence of dates for this data with a 2-day gap in the middle and assign them to the date dimension to see what happens.</span>
<span id="cb171-621"><a href="#cb171-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-622"><a href="#cb171-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wrong_date_seq}</span></span>
<span id="cb171-623"><a href="#cb171-623" aria-hidden="true" tabindex="-1"></a><span class="in">#--- 2009-01-23 removed and 2009-02-01 added ---#</span></span>
<span id="cb171-624"><a href="#cb171-624" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-625"><a href="#cb171-625" aria-hidden="true" tabindex="-1"></a><span class="in">  dates_ls_wrong &lt;- c(seq(start_date, end_date, "days")[-23], lubridate::ymd("2009-02-01"))</span></span>
<span id="cb171-626"><a href="#cb171-626" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-627"><a href="#cb171-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-628"><a href="#cb171-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-629"><a href="#cb171-629" aria-hidden="true" tabindex="-1"></a>Now assign these date values to <span class="in">`ppt_m1_y09_stars`</span>:</span>
<span id="cb171-630"><a href="#cb171-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-631"><a href="#cb171-631" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dimension_set_wrong}</span></span>
<span id="cb171-632"><a href="#cb171-632" aria-hidden="true" tabindex="-1"></a><span class="in">#--- set date values ---#</span></span>
<span id="cb171-633"><a href="#cb171-633" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-634"><a href="#cb171-634" aria-hidden="true" tabindex="-1"></a><span class="in">  ppt_m1_y09_stars_wrong &lt;-</span></span>
<span id="cb171-635"><a href="#cb171-635" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::st_set_dimensions(</span></span>
<span id="cb171-636"><a href="#cb171-636" aria-hidden="true" tabindex="-1"></a><span class="in">      ppt_m1_y09_stars,</span></span>
<span id="cb171-637"><a href="#cb171-637" aria-hidden="true" tabindex="-1"></a><span class="in">      3,</span></span>
<span id="cb171-638"><a href="#cb171-638" aria-hidden="true" tabindex="-1"></a><span class="in">      values = dates_ls_wrong,</span></span>
<span id="cb171-639"><a href="#cb171-639" aria-hidden="true" tabindex="-1"></a><span class="in">      names = "date"</span></span>
<span id="cb171-640"><a href="#cb171-640" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb171-641"><a href="#cb171-641" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-642"><a href="#cb171-642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-643"><a href="#cb171-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-644"><a href="#cb171-644" aria-hidden="true" tabindex="-1"></a>Since the step between the date values is no longer $1$ day for the entire sequence, the value of <span class="in">`delta`</span> is now <span class="in">`NA`</span>. However, notice that the value of date is no longer NULL. Since the date is not regular, you cannot represent date using three values (<span class="in">`from`</span>, <span class="in">`to`</span>, and <span class="in">`delta`</span>) any more, and date values for each observation have to be stored now.</span>
<span id="cb171-645"><a href="#cb171-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-646"><a href="#cb171-646" aria-hidden="true" tabindex="-1"></a>Finally, note that just applying <span class="in">`stars::st_set_dimensions()`</span> to a <span class="in">`stars`</span> object does not change the dimension of the <span class="in">`stars`</span> object (just like <span class="in">`setNames()`</span> as we discussed above).</span>
<span id="cb171-647"><a href="#cb171-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-648"><a href="#cb171-648" aria-hidden="true" tabindex="-1"></a><span class="in">```{r check_stars}</span></span>
<span id="cb171-649"><a href="#cb171-649" aria-hidden="true" tabindex="-1"></a><span class="in">ppt_m1_y09_stars</span></span>
<span id="cb171-650"><a href="#cb171-650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-651"><a href="#cb171-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-652"><a href="#cb171-652" aria-hidden="true" tabindex="-1"></a>As you can see, the date dimension has not been altered. You need to assign the results of <span class="in">`stars::st_set_dimensions()`</span> to a <span class="in">`stars`</span> object to see the changes in the dimension reflected just like we did above with the right date values.</span>
<span id="cb171-653"><a href="#cb171-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-654"><a href="#cb171-654" aria-hidden="true" tabindex="-1"></a><span class="fu">## `dplyr`-like operations {#sec-dplyr-op}</span></span>
<span id="cb171-655"><a href="#cb171-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-656"><a href="#cb171-656" aria-hidden="true" tabindex="-1"></a>You can use the <span class="in">`dplyr`</span> language to do basic data operations on <span class="in">`stars`</span> objects.</span>
<span id="cb171-657"><a href="#cb171-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-658"><a href="#cb171-658" aria-hidden="true" tabindex="-1"></a><span class="fu">### `dplyr::filter()`</span></span>
<span id="cb171-659"><a href="#cb171-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-660"><a href="#cb171-660" aria-hidden="true" tabindex="-1"></a>The <span class="in">`dplyr::filter()`</span> function allows you to subset data by dimension values: x, y, and band (here date).</span>
<span id="cb171-661"><a href="#cb171-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-662"><a href="#cb171-662" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb171-663"><a href="#cb171-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-664"><a href="#cb171-664" aria-hidden="true" tabindex="-1"></a>**spatial filtering**</span>
<span id="cb171-665"><a href="#cb171-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-666"><a href="#cb171-666" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filter_ex}</span></span>
<span id="cb171-667"><a href="#cb171-667" aria-hidden="true" tabindex="-1"></a><span class="in">#--- longitude greater than -100 ---#</span></span>
<span id="cb171-668"><a href="#cb171-668" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::filter(ppt_m1_y09_stars, x &gt; -100) %&gt;% plot()</span></span>
<span id="cb171-669"><a href="#cb171-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-670"><a href="#cb171-670" aria-hidden="true" tabindex="-1"></a><span class="in">#--- latitude less than 40 ---#</span></span>
<span id="cb171-671"><a href="#cb171-671" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::filter(ppt_m1_y09_stars, y &lt; 40) %&gt;% plot()</span></span>
<span id="cb171-672"><a href="#cb171-672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-673"><a href="#cb171-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-674"><a href="#cb171-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-675"><a href="#cb171-675" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb171-676"><a href="#cb171-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-677"><a href="#cb171-677" aria-hidden="true" tabindex="-1"></a>**temporal filtering**</span>
<span id="cb171-678"><a href="#cb171-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-679"><a href="#cb171-679" aria-hidden="true" tabindex="-1"></a>Finally, since the date dimension is in <span class="in">`Date`</span>, you can use <span class="in">`Date`</span> math to filter the data.<span class="ot">[^stars-9]</span></span>
<span id="cb171-680"><a href="#cb171-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-681"><a href="#cb171-681" aria-hidden="true" tabindex="-1"></a><span class="ot">[^stars-9]: </span>This is possible only because we have assigned date values to the band dimension above.</span>
<span id="cb171-682"><a href="#cb171-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-683"><a href="#cb171-683" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filter_ex_date}</span></span>
<span id="cb171-684"><a href="#cb171-684" aria-hidden="true" tabindex="-1"></a><span class="in">#--- dates after 2009-01-15  ---#</span></span>
<span id="cb171-685"><a href="#cb171-685" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::filter(ppt_m1_y09_stars, date &gt; lubridate::ymd("2009-01-21")) %&gt;% plot()</span></span>
<span id="cb171-686"><a href="#cb171-686" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-687"><a href="#cb171-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-688"><a href="#cb171-688" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb171-689"><a href="#cb171-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-690"><a href="#cb171-690" aria-hidden="true" tabindex="-1"></a>**filter by attribute?**</span>
<span id="cb171-691"><a href="#cb171-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-692"><a href="#cb171-692" aria-hidden="true" tabindex="-1"></a>In case you are wondering, filtering by attribute is not possible. This makes sense, as doing so would disrupt the regular grid structure of raster data.</span>
<span id="cb171-693"><a href="#cb171-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-694"><a href="#cb171-694" aria-hidden="true" tabindex="-1"></a><span class="in">```{r error = TRUE}</span></span>
<span id="cb171-695"><a href="#cb171-695" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::filter(ppt_m1_y09_stars, ppt &gt; 20)</span></span>
<span id="cb171-696"><a href="#cb171-696" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-697"><a href="#cb171-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-698"><a href="#cb171-698" aria-hidden="true" tabindex="-1"></a><span class="fu">### `dplyr::select()`</span></span>
<span id="cb171-699"><a href="#cb171-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-700"><a href="#cb171-700" aria-hidden="true" tabindex="-1"></a>The <span class="in">`dply::select()`</span> function lets you pick certain attributes.</span>
<span id="cb171-701"><a href="#cb171-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-702"><a href="#cb171-702" aria-hidden="true" tabindex="-1"></a><span class="in">```{r select_vars}</span></span>
<span id="cb171-703"><a href="#cb171-703" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::select(prcp_tmax_PRISM_m8_y09, ppt)</span></span>
<span id="cb171-704"><a href="#cb171-704" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-705"><a href="#cb171-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-706"><a href="#cb171-706" aria-hidden="true" tabindex="-1"></a><span class="fu">### `dplyr::mutate()`</span></span>
<span id="cb171-707"><a href="#cb171-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-708"><a href="#cb171-708" aria-hidden="true" tabindex="-1"></a>You can mutate attributes using the <span class="in">`dplyr::mutate()`</span> function. For example, this can be useful to calculate NDVI in a <span class="in">`stars`</span> object that has Red and NIR (spectral reflectance measurements in the red and near-infrared regions) as attributes. Here, we just simply convert the unit of precipitation from mm to inches.</span>
<span id="cb171-709"><a href="#cb171-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-710"><a href="#cb171-710" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mm_inches}</span></span>
<span id="cb171-711"><a href="#cb171-711" aria-hidden="true" tabindex="-1"></a><span class="in">#--- mm to inches ---#</span></span>
<span id="cb171-712"><a href="#cb171-712" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::mutate(prcp_tmax_PRISM_m8_y09, ppt = ppt * 0.0393701)</span></span>
<span id="cb171-713"><a href="#cb171-713" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-714"><a href="#cb171-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-715"><a href="#cb171-715" aria-hidden="true" tabindex="-1"></a><span class="fu">### `dplyr::pull()`</span></span>
<span id="cb171-716"><a href="#cb171-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-717"><a href="#cb171-717" aria-hidden="true" tabindex="-1"></a>You can extract attribute values using <span class="in">`dplyr::pull()`</span>.</span>
<span id="cb171-718"><a href="#cb171-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-719"><a href="#cb171-719" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pull}</span></span>
<span id="cb171-720"><a href="#cb171-720" aria-hidden="true" tabindex="-1"></a><span class="in">#--- tmax values of the 1st date layer ---#</span></span>
<span id="cb171-721"><a href="#cb171-721" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::pull(prcp_tmax_PRISM_m8_y09["tmax", , , 1], "tmax")</span></span>
<span id="cb171-722"><a href="#cb171-722" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-723"><a href="#cb171-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-724"><a href="#cb171-724" aria-hidden="true" tabindex="-1"></a><span class="fu">## Merging `stars` objects using `c()` and `stars::st_mosaic()`</span></span>
<span id="cb171-725"><a href="#cb171-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-726"><a href="#cb171-726" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merging `stars` objects along the third dimension (band)</span></span>
<span id="cb171-727"><a href="#cb171-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-728"><a href="#cb171-728" aria-hidden="true" tabindex="-1"></a>Here we learn how to merge multiple <span class="in">`stars`</span> objects that have</span>
<span id="cb171-729"><a href="#cb171-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-730"><a href="#cb171-730" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the **same** attributes</span>
<span id="cb171-731"><a href="#cb171-731" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the **same** spatial extent and resolution</span>
<span id="cb171-732"><a href="#cb171-732" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**different** bands (dates here)</span>
<span id="cb171-733"><a href="#cb171-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-734"><a href="#cb171-734" aria-hidden="true" tabindex="-1"></a>For example, consider merging PRISM precipitation data in January and February. Both of them have exactly the same spatial extent and resolutions and represent the same attribute (precipitation). However, they differ in the third dimension (date). So, you are trying to stack data of the same attributes along the third dimension (date) while making sure that spatial correspondence is maintained. This merge is kind of like <span class="in">`rbind()`</span> that stacks multiple <span class="in">`data.frame`</span>s vertically while making sure the variables are aligned correctly.</span>
<span id="cb171-735"><a href="#cb171-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-736"><a href="#cb171-736" aria-hidden="true" tabindex="-1"></a>Let's import the PRISM precipitation data for February, 2009.</span>
<span id="cb171-737"><a href="#cb171-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-738"><a href="#cb171-738" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ppt_feb}</span></span>
<span id="cb171-739"><a href="#cb171-739" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read the February ppt data ---#</span></span>
<span id="cb171-740"><a href="#cb171-740" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-741"><a href="#cb171-741" aria-hidden="true" tabindex="-1"></a><span class="in">  ppt_m2_y09_stars &lt;- stars::read_stars("Data/PRISM_ppt_y2009_m2.tif")</span></span>
<span id="cb171-742"><a href="#cb171-742" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-743"><a href="#cb171-743" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-744"><a href="#cb171-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-745"><a href="#cb171-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-746"><a href="#cb171-746" aria-hidden="true" tabindex="-1"></a>Note here that the third dimension of <span class="in">`ppt_m2_y09_stars`</span> has not been changed to date.</span>
<span id="cb171-747"><a href="#cb171-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-748"><a href="#cb171-748" aria-hidden="true" tabindex="-1"></a>Now, let's try to merge the two:</span>
<span id="cb171-749"><a href="#cb171-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-750"><a href="#cb171-750" aria-hidden="true" tabindex="-1"></a><span class="in">```{r combine_r}</span></span>
<span id="cb171-751"><a href="#cb171-751" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine the two ---#</span></span>
<span id="cb171-752"><a href="#cb171-752" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-753"><a href="#cb171-753" aria-hidden="true" tabindex="-1"></a><span class="in">  ppt_m1_to_m2_y09_stars &lt;- c(ppt_m1_y09_stars, ppt_m2_y09_stars, along = 3)</span></span>
<span id="cb171-754"><a href="#cb171-754" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-755"><a href="#cb171-755" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-756"><a href="#cb171-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-757"><a href="#cb171-757" aria-hidden="true" tabindex="-1"></a>As you noticed, the second object (<span class="in">`ppt_m2_y09_stars`</span>) was assumed to have the same date characteristics as the first one: the data in February is observed daily (<span class="in">`delta`</span> is 1 day). This causes no problem in this instance as the February data is indeed observed daily starting from <span class="in">`2009-02-01`</span>. However, be careful if you are appending the data that does not start from 1 day after (or more generally <span class="in">`delta`</span> for the time dimension) the first data or the data that does not follow the same observation interval.</span>
<span id="cb171-758"><a href="#cb171-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-759"><a href="#cb171-759" aria-hidden="true" tabindex="-1"></a>For this reason, it is advisable to first set the date values if it has not been set. Pretend that the February data actually starts from <span class="in">`2009-02-02`</span> to <span class="in">`2009-03-01`</span> to see what happens when the regular interval (<span class="in">`delta`</span>) is not kept after merging.</span>
<span id="cb171-760"><a href="#cb171-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-761"><a href="#cb171-761" aria-hidden="true" tabindex="-1"></a><span class="in">```{r combine_caveates}</span></span>
<span id="cb171-762"><a href="#cb171-762" aria-hidden="true" tabindex="-1"></a><span class="in">#--- starting date ---#</span></span>
<span id="cb171-763"><a href="#cb171-763" aria-hidden="true" tabindex="-1"></a><span class="in">start_date &lt;- lubridate::ymd("2009-02-01")</span></span>
<span id="cb171-764"><a href="#cb171-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-765"><a href="#cb171-765" aria-hidden="true" tabindex="-1"></a><span class="in">#--- ending date ---#</span></span>
<span id="cb171-766"><a href="#cb171-766" aria-hidden="true" tabindex="-1"></a><span class="in">end_date &lt;- lubridate::ymd("2009-02-28")</span></span>
<span id="cb171-767"><a href="#cb171-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-768"><a href="#cb171-768" aria-hidden="true" tabindex="-1"></a><span class="in">#--- sequence of dates  ---#</span></span>
<span id="cb171-769"><a href="#cb171-769" aria-hidden="true" tabindex="-1"></a><span class="in">dates_ls &lt;- seq(start_date, end_date, "days")</span></span>
<span id="cb171-770"><a href="#cb171-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-771"><a href="#cb171-771" aria-hidden="true" tabindex="-1"></a><span class="in">#--- pretend the data actually starts from `2009-02-02` to `2009-03-01` ---#</span></span>
<span id="cb171-772"><a href="#cb171-772" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-773"><a href="#cb171-773" aria-hidden="true" tabindex="-1"></a><span class="in">  ppt_m2_y09_stars &lt;- </span></span>
<span id="cb171-774"><a href="#cb171-774" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::st_set_dimensions(</span></span>
<span id="cb171-775"><a href="#cb171-775" aria-hidden="true" tabindex="-1"></a><span class="in">      ppt_m2_y09_stars,</span></span>
<span id="cb171-776"><a href="#cb171-776" aria-hidden="true" tabindex="-1"></a><span class="in">      3,</span></span>
<span id="cb171-777"><a href="#cb171-777" aria-hidden="true" tabindex="-1"></a><span class="in">      values = c(dates_ls[-1], lubridate::ymd("2009-03-01")),</span></span>
<span id="cb171-778"><a href="#cb171-778" aria-hidden="true" tabindex="-1"></a><span class="in">      name = "date"</span></span>
<span id="cb171-779"><a href="#cb171-779" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb171-780"><a href="#cb171-780" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-781"><a href="#cb171-781" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-782"><a href="#cb171-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-783"><a href="#cb171-783" aria-hidden="true" tabindex="-1"></a>If you merge the two,</span>
<span id="cb171-784"><a href="#cb171-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-785"><a href="#cb171-785" aria-hidden="true" tabindex="-1"></a><span class="in">```{r combine_caveates_2}</span></span>
<span id="cb171-786"><a href="#cb171-786" aria-hidden="true" tabindex="-1"></a><span class="in">c(ppt_m1_y09_stars, ppt_m2_y09_stars, along = 3)</span></span>
<span id="cb171-787"><a href="#cb171-787" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-788"><a href="#cb171-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-789"><a href="#cb171-789" aria-hidden="true" tabindex="-1"></a>The date dimension does not have <span class="in">`delta`</span> any more, and correctly so because there is a one-day gap between the end date of the first <span class="in">`stars`</span> object (<span class="in">`"2009-01-31"`</span>) and the start date of the second <span class="in">`stars`</span> object (<span class="in">`"2009-02-02"`</span>). So, all the date values are now stored in <span class="in">`values`</span>.</span>
<span id="cb171-790"><a href="#cb171-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-791"><a href="#cb171-791" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merging `stars` objects of different attributes {#sec-merge-two}</span></span>
<span id="cb171-792"><a href="#cb171-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-793"><a href="#cb171-793" aria-hidden="true" tabindex="-1"></a>Here we learn how to merge multiple <span class="in">`stars`</span> objects that have</span>
<span id="cb171-794"><a href="#cb171-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-795"><a href="#cb171-795" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**different** attributes</span>
<span id="cb171-796"><a href="#cb171-796" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the **same** spatial extent and resolution</span>
<span id="cb171-797"><a href="#cb171-797" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the **same** bands (dates here)</span>
<span id="cb171-798"><a href="#cb171-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-799"><a href="#cb171-799" aria-hidden="true" tabindex="-1"></a>For example, consider merging PRISM precipitation and tmax data in January. Both of them have exactly the same spatial extent and resolutions and the date characteristics (starting and ending on the same dates with the same time interval). However, they differ in what they represent: precipitation and tmax. This merge is kind of like <span class="in">`cbind()`</span> that combines multiple <span class="in">`data.frame`</span>s of different variables while making sure the observation correspondence is correct.</span>
<span id="cb171-800"><a href="#cb171-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-801"><a href="#cb171-801" aria-hidden="true" tabindex="-1"></a>Let's read the daily tmax data for January, 2009:</span>
<span id="cb171-802"><a href="#cb171-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-803"><a href="#cb171-803" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tmax_read}</span></span>
<span id="cb171-804"><a href="#cb171-804" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-805"><a href="#cb171-805" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_m8_y09_stars &lt;- </span></span>
<span id="cb171-806"><a href="#cb171-806" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::read_stars("Data/PRISM_tmax_y2009_m1.tif") %&gt;%</span></span>
<span id="cb171-807"><a href="#cb171-807" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- change the attribute name ---#</span></span>
<span id="cb171-808"><a href="#cb171-808" aria-hidden="true" tabindex="-1"></a><span class="in">    setNames("tmax")</span></span>
<span id="cb171-809"><a href="#cb171-809" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-810"><a href="#cb171-810" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-811"><a href="#cb171-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-812"><a href="#cb171-812" aria-hidden="true" tabindex="-1"></a>Now, let's merge the PRISM ppt and tmax data in January, 2009.</span>
<span id="cb171-813"><a href="#cb171-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-814"><a href="#cb171-814" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ppt_tmax_combine, error = TRUE}</span></span>
<span id="cb171-815"><a href="#cb171-815" aria-hidden="true" tabindex="-1"></a><span class="in">c(ppt_m1_y09_stars, tmax_m8_y09_stars)</span></span>
<span id="cb171-816"><a href="#cb171-816" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-817"><a href="#cb171-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-818"><a href="#cb171-818" aria-hidden="true" tabindex="-1"></a>Oops. Well, the problem is that the third dimension of the two objects is not the same. Even though we know that the **x**th element of their third dimension represent the same thing, they look different to R's eyes. So, we first need to change the third dimension of <span class="in">`tmax_m8_y09_stars`</span> to be consistent with the third dimension of <span class="in">`ppt_m1_y09_stars`</span> (<span class="in">`dates_ls_m1`</span> was defined in @sec-stars-set-time).</span>
<span id="cb171-819"><a href="#cb171-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-820"><a href="#cb171-820" aria-hidden="true" tabindex="-1"></a><span class="in">```{r set_dim_first_combine}</span></span>
<span id="cb171-821"><a href="#cb171-821" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-822"><a href="#cb171-822" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_m8_y09_stars &lt;- stars::st_set_dimensions(tmax_m8_y09_stars, 3, values = dates_ls_m1, names = "date")</span></span>
<span id="cb171-823"><a href="#cb171-823" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-824"><a href="#cb171-824" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-825"><a href="#cb171-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-826"><a href="#cb171-826" aria-hidden="true" tabindex="-1"></a>Now, we can merge the two.</span>
<span id="cb171-827"><a href="#cb171-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-828"><a href="#cb171-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ppt_tmax_combine_2}</span></span>
<span id="cb171-829"><a href="#cb171-829" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-830"><a href="#cb171-830" aria-hidden="true" tabindex="-1"></a><span class="in">  ppt_tmax_m8_y09_stars &lt;- c(ppt_m1_y09_stars, tmax_m8_y09_stars)</span></span>
<span id="cb171-831"><a href="#cb171-831" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-832"><a href="#cb171-832" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-833"><a href="#cb171-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-834"><a href="#cb171-834" aria-hidden="true" tabindex="-1"></a>As you can see, now we have another attribute called <span class="in">`tmax`</span>.</span>
<span id="cb171-835"><a href="#cb171-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-836"><a href="#cb171-836" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merging `stars` objects of different spatial extents</span></span>
<span id="cb171-837"><a href="#cb171-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-838"><a href="#cb171-838" aria-hidden="true" tabindex="-1"></a>Here we learn how to merge multiple <span class="in">`stars`</span> objects that have</span>
<span id="cb171-839"><a href="#cb171-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-840"><a href="#cb171-840" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the **same** attributes</span>
<span id="cb171-841"><a href="#cb171-841" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**different** spatial extent but **same** resolution<span class="ot">[^stars-10]</span></span>
<span id="cb171-842"><a href="#cb171-842" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the **same** bands (dates here)</span>
<span id="cb171-843"><a href="#cb171-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-844"><a href="#cb171-844" aria-hidden="true" tabindex="-1"></a><span class="ot">[^stars-10]: </span>Technically, you can actually merge <span class="in">`stars`</span> objects of different spatial resolutions. But, you probably should not.</span>
<span id="cb171-845"><a href="#cb171-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-846"><a href="#cb171-846" aria-hidden="true" tabindex="-1"></a>Some times you have multiple separate raster datasets that have different spatial coverages and would like to combine them into one. You can do that using <span class="in">`stars::st_mosaic()`</span>.</span>
<span id="cb171-847"><a href="#cb171-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-848"><a href="#cb171-848" aria-hidden="true" tabindex="-1"></a>Let's split <span class="in">`tmax_m8_y09_stars`</span> into two parts (@fig-map-indiv shows what they look like (only Jan 1, 1980)):</span>
<span id="cb171-849"><a href="#cb171-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-850"><a href="#cb171-850" aria-hidden="true" tabindex="-1"></a><span class="in">```{r split-to-two}</span></span>
<span id="cb171-851"><a href="#cb171-851" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_1 &lt;- dplyr::filter(tmax_m8_y09_stars, x &lt;= -100)</span></span>
<span id="cb171-852"><a href="#cb171-852" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_2 &lt;- dplyr::filter(tmax_m8_y09_stars, x &gt; -100)</span></span>
<span id="cb171-853"><a href="#cb171-853" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-854"><a href="#cb171-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-855"><a href="#cb171-855" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb171-858"><a href="#cb171-858" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-859"><a href="#cb171-859" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-indiv</span></span>
<span id="cb171-860"><a href="#cb171-860" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Two spatially non-overlapping stars objects"</span></span>
<span id="cb171-861"><a href="#cb171-861" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb171-862"><a href="#cb171-862" aria-hidden="true" tabindex="-1"></a>g_1 <span class="ot">&lt;-</span> </span>
<span id="cb171-863"><a href="#cb171-863" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb171-864"><a href="#cb171-864" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> tmax_1[, , , <span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb171-865"><a href="#cb171-865" aria-hidden="true" tabindex="-1"></a>  theme_for_map <span class="sc">+</span></span>
<span id="cb171-866"><a href="#cb171-866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb171-867"><a href="#cb171-867" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb171-868"><a href="#cb171-868" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb171-869"><a href="#cb171-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"tmax_1"</span>)</span>
<span id="cb171-870"><a href="#cb171-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-871"><a href="#cb171-871" aria-hidden="true" tabindex="-1"></a>g_2 <span class="ot">&lt;-</span> </span>
<span id="cb171-872"><a href="#cb171-872" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb171-873"><a href="#cb171-873" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> tmax_2[, , , <span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb171-874"><a href="#cb171-874" aria-hidden="true" tabindex="-1"></a>  theme_for_map <span class="sc">+</span></span>
<span id="cb171-875"><a href="#cb171-875" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb171-876"><a href="#cb171-876" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb171-877"><a href="#cb171-877" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb171-878"><a href="#cb171-878" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"tmax_2"</span>)</span>
<span id="cb171-879"><a href="#cb171-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-880"><a href="#cb171-880" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb171-881"><a href="#cb171-881" aria-hidden="true" tabindex="-1"></a>g_1 <span class="sc">+</span> g_2</span>
<span id="cb171-882"><a href="#cb171-882" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-883"><a href="#cb171-883" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb171-884"><a href="#cb171-884" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb171-885"><a href="#cb171-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-886"><a href="#cb171-886" aria-hidden="true" tabindex="-1"></a>Let's combine the two using <span class="in">`stars::st_mosaic()`</span>:</span>
<span id="cb171-887"><a href="#cb171-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-888"><a href="#cb171-888" aria-hidden="true" tabindex="-1"></a><span class="in">```{r combine_mosaic}</span></span>
<span id="cb171-889"><a href="#cb171-889" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_combined &lt;- stars::st_mosaic(tmax_1, tmax_2)</span></span>
<span id="cb171-890"><a href="#cb171-890" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-891"><a href="#cb171-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-892"><a href="#cb171-892" aria-hidden="true" tabindex="-1"></a>@fig-plot-combine shows what the combined object looks like.</span>
<span id="cb171-893"><a href="#cb171-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-896"><a href="#cb171-896" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-897"><a href="#cb171-897" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-plot-combine</span></span>
<span id="cb171-898"><a href="#cb171-898" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of the stars objects combined into one"</span></span>
<span id="cb171-899"><a href="#cb171-899" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb171-900"><a href="#cb171-900" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb171-901"><a href="#cb171-901" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> tmax_combined[, , , <span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb171-902"><a href="#cb171-902" aria-hidden="true" tabindex="-1"></a>  theme_for_map</span>
<span id="cb171-903"><a href="#cb171-903" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-904"><a href="#cb171-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-905"><a href="#cb171-905" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb171-906"><a href="#cb171-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-907"><a href="#cb171-907" aria-hidden="true" tabindex="-1"></a>It is okay to have the two <span class="in">`stars`</span> objects to be combined have a spatial overlap. The following split creates two <span class="in">`stars`</span> objects with a spatial overlap (@fig-map-indiv-2 shows what they look like).</span>
<span id="cb171-908"><a href="#cb171-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-909"><a href="#cb171-909" aria-hidden="true" tabindex="-1"></a><span class="in">```{r split_overlap}</span></span>
<span id="cb171-910"><a href="#cb171-910" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_1 &lt;- dplyr::filter(tmax_m8_y09_stars, x &lt;= -100)</span></span>
<span id="cb171-911"><a href="#cb171-911" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_2 &lt;- dplyr::filter(tmax_m8_y09_stars, x &gt; -110)</span></span>
<span id="cb171-912"><a href="#cb171-912" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-913"><a href="#cb171-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-914"><a href="#cb171-914" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb171-915"><a href="#cb171-915" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height = 8}</span></span>
<span id="cb171-916"><a href="#cb171-916" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-map-indiv-2</span></span>
<span id="cb171-917"><a href="#cb171-917" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Two spatially overlapping stars objects"</span></span>
<span id="cb171-918"><a href="#cb171-918" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true </span></span>
<span id="cb171-919"><a href="#cb171-919" aria-hidden="true" tabindex="-1"></a><span class="in">g_1 &lt;- </span></span>
<span id="cb171-920"><a href="#cb171-920" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot() +</span></span>
<span id="cb171-921"><a href="#cb171-921" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_stars(data = tmax_m8_y09_stars[, , , 1], fill = NA) +</span></span>
<span id="cb171-922"><a href="#cb171-922" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_stars(data = tmax_1[, , , 1]) +</span></span>
<span id="cb171-923"><a href="#cb171-923" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_for_map +</span></span>
<span id="cb171-924"><a href="#cb171-924" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("tmax_1") </span></span>
<span id="cb171-925"><a href="#cb171-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-926"><a href="#cb171-926" aria-hidden="true" tabindex="-1"></a><span class="in">g_2 &lt;- </span></span>
<span id="cb171-927"><a href="#cb171-927" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot() +</span></span>
<span id="cb171-928"><a href="#cb171-928" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_stars(data = tmax_m8_y09_stars[, , , 1], fill = NA) +</span></span>
<span id="cb171-929"><a href="#cb171-929" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_stars(data = tmax_2[, , , 1]) +</span></span>
<span id="cb171-930"><a href="#cb171-930" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_for_map +</span></span>
<span id="cb171-931"><a href="#cb171-931" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("tmax_2")</span></span>
<span id="cb171-932"><a href="#cb171-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-933"><a href="#cb171-933" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)</span></span>
<span id="cb171-934"><a href="#cb171-934" aria-hidden="true" tabindex="-1"></a><span class="in">g_1 / g_2</span></span>
<span id="cb171-935"><a href="#cb171-935" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-936"><a href="#cb171-936" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb171-937"><a href="#cb171-937" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb171-938"><a href="#cb171-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-939"><a href="#cb171-939" aria-hidden="true" tabindex="-1"></a>As you can see below, <span class="in">`stars::st_mosaic()`</span> reconciles the spatial overlap between the two <span class="in">`stars`</span> objects (@fig-plot-combine-overlapped).</span>
<span id="cb171-940"><a href="#cb171-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-941"><a href="#cb171-941" aria-hidden="true" tabindex="-1"></a><span class="in">```{r combine_ovelapped}</span></span>
<span id="cb171-942"><a href="#cb171-942" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-943"><a href="#cb171-943" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_combined &lt;- stars::st_mosaic(tmax_1, tmax_2)</span></span>
<span id="cb171-944"><a href="#cb171-944" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-945"><a href="#cb171-945" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-946"><a href="#cb171-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-949"><a href="#cb171-949" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-950"><a href="#cb171-950" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-plot-combine-overlapped</span></span>
<span id="cb171-951"><a href="#cb171-951" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of the spatially-overlapping stars objects combined into one"</span></span>
<span id="cb171-952"><a href="#cb171-952" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb171-953"><a href="#cb171-953" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb171-954"><a href="#cb171-954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> tmax_combined[, , , <span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb171-955"><a href="#cb171-955" aria-hidden="true" tabindex="-1"></a>  theme_for_map</span>
<span id="cb171-956"><a href="#cb171-956" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-957"><a href="#cb171-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-958"><a href="#cb171-958" aria-hidden="true" tabindex="-1"></a><span class="fu">## Apply a function to one or more dimensions</span></span>
<span id="cb171-959"><a href="#cb171-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-960"><a href="#cb171-960" aria-hidden="true" tabindex="-1"></a>At times, you may want to apply a function to one or more dimensions of a stars object. For instance, you might want to calculate the total annual precipitation for each cell using daily precipitation data. To illustrate this, let's create a single-attribute stars object that contains daily precipitation data for August 2009.</span>
<span id="cb171-961"><a href="#cb171-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-964"><a href="#cb171-964" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-965"><a href="#cb171-965" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb171-966"><a href="#cb171-966" aria-hidden="true" tabindex="-1"></a>  ppt_m8_y09 <span class="ot">&lt;-</span> prcp_tmax_PRISM_m8_y09[<span class="st">"ppt"</span>]</span>
<span id="cb171-967"><a href="#cb171-967" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb171-968"><a href="#cb171-968" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-969"><a href="#cb171-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-970"><a href="#cb171-970" aria-hidden="true" tabindex="-1"></a>Let's find total precipitation for each cell in August in 2009 using <span class="in">`stars::st_apply()`</span>, which works like this. </span>
<span id="cb171-971"><a href="#cb171-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-974"><a href="#cb171-974" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-975"><a href="#cb171-975" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb171-976"><a href="#cb171-976" aria-hidden="true" tabindex="-1"></a>stars<span class="sc">::</span><span class="fu">st_apply</span>(</span>
<span id="cb171-977"><a href="#cb171-977" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> stars object,</span>
<span id="cb171-978"><a href="#cb171-978" aria-hidden="true" tabindex="-1"></a>  <span class="at">MARGIN =</span> margin,</span>
<span id="cb171-979"><a href="#cb171-979" aria-hidden="true" tabindex="-1"></a>  <span class="at">FUN =</span> <span class="cf">function</span> to apply</span>
<span id="cb171-980"><a href="#cb171-980" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb171-981"><a href="#cb171-981" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-982"><a href="#cb171-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-983"><a href="#cb171-983" aria-hidden="true" tabindex="-1"></a>Since we want to sum the value of attribute (<span class="in">`ppt`</span>) for each of the cells (each cell is represented by <span class="in">`x-y`</span>), we specify <span class="in">`MARGIN = c("x", "y")`</span> and use <span class="in">`sum()`</span> as the function (@fig-summed-precip shows the results).</span>
<span id="cb171-984"><a href="#cb171-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-987"><a href="#cb171-987" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-988"><a href="#cb171-988" aria-hidden="true" tabindex="-1"></a>monthly_ppt <span class="ot">&lt;-</span></span>
<span id="cb171-989"><a href="#cb171-989" aria-hidden="true" tabindex="-1"></a>  stars<span class="sc">::</span><span class="fu">st_apply</span>(</span>
<span id="cb171-990"><a href="#cb171-990" aria-hidden="true" tabindex="-1"></a>    ppt_m8_y09,</span>
<span id="cb171-991"><a href="#cb171-991" aria-hidden="true" tabindex="-1"></a>    <span class="at">MARGIN =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>),</span>
<span id="cb171-992"><a href="#cb171-992" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> sum</span>
<span id="cb171-993"><a href="#cb171-993" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb171-994"><a href="#cb171-994" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-995"><a href="#cb171-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-996"><a href="#cb171-996" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb171-999"><a href="#cb171-999" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-1000"><a href="#cb171-1000" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-summed-precip</span></span>
<span id="cb171-1001"><a href="#cb171-1001" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb171-1002"><a href="#cb171-1002" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Summed value of precipitation"</span></span>
<span id="cb171-1003"><a href="#cb171-1003" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(monthly_ppt)</span>
<span id="cb171-1004"><a href="#cb171-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1005"><a href="#cb171-1005" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb171-1006"><a href="#cb171-1006" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb171-1007"><a href="#cb171-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1008"><a href="#cb171-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1009"><a href="#cb171-1009" aria-hidden="true" tabindex="-1"></a><span class="fu">## Convert from and to `Raster`$^*$ or `SpatRaster` objects {#sec-convert-to-rb}</span></span>
<span id="cb171-1010"><a href="#cb171-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1011"><a href="#cb171-1011" aria-hidden="true" tabindex="-1"></a>When you need to convert a <span class="in">`stars`</span> object to a <span class="in">`Raster`</span>$^*$ or <span class="in">`SpatRaster`</span> object, you can use the <span class="in">`as()`</span> function as follows:</span>
<span id="cb171-1012"><a href="#cb171-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1013"><a href="#cb171-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```{r convert_to_raster}</span></span>
<span id="cb171-1014"><a href="#cb171-1014" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1015"><a href="#cb171-1015" aria-hidden="true" tabindex="-1"></a><span class="in">  # to Raster* object</span></span>
<span id="cb171-1016"><a href="#cb171-1016" aria-hidden="true" tabindex="-1"></a><span class="in">  prcp_tmax_PRISM_m8_y09_rb &lt;- as(prcp_tmax_PRISM_m8_y09, "Raster")</span></span>
<span id="cb171-1017"><a href="#cb171-1017" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1018"><a href="#cb171-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1019"><a href="#cb171-1019" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1020"><a href="#cb171-1020" aria-hidden="true" tabindex="-1"></a><span class="in">  # to SpatRaster</span></span>
<span id="cb171-1021"><a href="#cb171-1021" aria-hidden="true" tabindex="-1"></a><span class="in">  prcp_tmax_PRISM_m8_y09_sr &lt;- as(prcp_tmax_PRISM_m8_y09, "SpatRaster")</span></span>
<span id="cb171-1022"><a href="#cb171-1022" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1023"><a href="#cb171-1023" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1024"><a href="#cb171-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1025"><a href="#cb171-1025" aria-hidden="true" tabindex="-1"></a>As you can see, date values in <span class="in">`prcp_tmax_PRISM_m8_y09`</span> appear in the time dimension of <span class="in">`prcp_tmax_PRISM_m8_y09_rb`</span> (<span class="in">`RasterBrick`</span>). However, in <span class="in">`prcp_tmax_PRISM_m8_y09_sr`</span> (<span class="in">`SpatRaster`</span>), date values appear in the <span class="in">`names`</span> dimension with <span class="in">`date`</span> added as prefix to the original date values.</span>
<span id="cb171-1026"><a href="#cb171-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1027"><a href="#cb171-1027" aria-hidden="true" tabindex="-1"></a>Note also that the conversion was done for only the <span class="in">`ppt`</span> attribute. This is simply because the <span class="in">`raster`</span> and <span class="in">`terra`</span> package does not accommodate multiple attributes of 3-dimensional array. So, if you want a <span class="in">`RasterBrick`</span> or <span class="in">`SpatRaster`</span> of the precipitation data, then you need to do the following:</span>
<span id="cb171-1028"><a href="#cb171-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1029"><a href="#cb171-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tmax_conv}</span></span>
<span id="cb171-1030"><a href="#cb171-1030" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1031"><a href="#cb171-1031" aria-hidden="true" tabindex="-1"></a><span class="in">  # to RasterBrick</span></span>
<span id="cb171-1032"><a href="#cb171-1032" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_PRISM_m8_y09_rb &lt;- as(prcp_tmax_PRISM_m8_y09["ppt", , , ], "Raster")</span></span>
<span id="cb171-1033"><a href="#cb171-1033" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1034"><a href="#cb171-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1035"><a href="#cb171-1035" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1036"><a href="#cb171-1036" aria-hidden="true" tabindex="-1"></a><span class="in">  # to SpatRaster</span></span>
<span id="cb171-1037"><a href="#cb171-1037" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_PRISM_m8_y09_sr &lt;- as(prcp_tmax_PRISM_m8_y09["ppt", , , ], "SpatRaster")</span></span>
<span id="cb171-1038"><a href="#cb171-1038" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1039"><a href="#cb171-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1040"><a href="#cb171-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1041"><a href="#cb171-1041" aria-hidden="true" tabindex="-1"></a>You can convert a <span class="in">`Raster`</span>$^*$ object to a <span class="in">`stars`</span> object using <span class="in">`stars::st_as_stars()`</span> (you will see a use case in @sec-daymet-poly).</span>
<span id="cb171-1042"><a href="#cb171-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1043"><a href="#cb171-1043" aria-hidden="true" tabindex="-1"></a><span class="in">```{r from_stars}</span></span>
<span id="cb171-1044"><a href="#cb171-1044" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1045"><a href="#cb171-1045" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_PRISM_m8_y09_back_to_stars &lt;- stars::st_as_stars(tmax_PRISM_m8_y09_rb)</span></span>
<span id="cb171-1046"><a href="#cb171-1046" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1047"><a href="#cb171-1047" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1048"><a href="#cb171-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1049"><a href="#cb171-1049" aria-hidden="true" tabindex="-1"></a>Notice that the original date values (stored in the <span class="in">`date`</span> dimension) are recovered, but its dimension is now called just <span class="in">`band`</span>. </span>
<span id="cb171-1050"><a href="#cb171-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1051"><a href="#cb171-1051" aria-hidden="true" tabindex="-1"></a>You can do the same with a <span class="in">`SpatRaster`</span> object.</span>
<span id="cb171-1052"><a href="#cb171-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1053"><a href="#cb171-1053" aria-hidden="true" tabindex="-1"></a><span class="in">```{r from_spatraster}</span></span>
<span id="cb171-1054"><a href="#cb171-1054" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1055"><a href="#cb171-1055" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_PRISM_m8_y09_back_to_stars &lt;- stars::st_as_stars(tmax_PRISM_m8_y09_sr)</span></span>
<span id="cb171-1056"><a href="#cb171-1056" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1057"><a href="#cb171-1057" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1058"><a href="#cb171-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1059"><a href="#cb171-1059" aria-hidden="true" tabindex="-1"></a>Note that unlike the conversion from the <span class="in">`RasterBrick`</span> object, the <span class="in">`band`</span> dimension inherited values of the <span class="in">`name`</span> dimension in <span class="in">`tmax_PRISM_m8_y09_sr`</span>.</span>
<span id="cb171-1060"><a href="#cb171-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1061"><a href="#cb171-1061" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial interactions of `stars` and `sf` objects</span></span>
<span id="cb171-1062"><a href="#cb171-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1063"><a href="#cb171-1063" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatial cropping (subsetting) to the area of interest {#sec-stars-crop}</span></span>
<span id="cb171-1064"><a href="#cb171-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1065"><a href="#cb171-1065" aria-hidden="true" tabindex="-1"></a>If the region of interest is smaller than the spatial extent of the <span class="in">`stars`</span> raster data, there is no need to retain the irrelevant portions of the <span class="in">`stars`</span> object. In such cases, you can crop the <span class="in">`stars`</span> data to focus on the region of interest using <span class="in">`sf::st_crop()`</span>. The general syntax of <span class="in">`sf::st_crop()`</span> is:</span>
<span id="cb171-1066"><a href="#cb171-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1069"><a href="#cb171-1069" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-1070"><a href="#cb171-1070" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb171-1071"><a href="#cb171-1071" aria-hidden="true" tabindex="-1"></a><span class="co">#--- NOT RUN ---#</span></span>
<span id="cb171-1072"><a href="#cb171-1072" aria-hidden="true" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">st_crop</span>(stars object, sf<span class="sc">/</span>bbox object)</span>
<span id="cb171-1073"><a href="#cb171-1073" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1074"><a href="#cb171-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1075"><a href="#cb171-1075" aria-hidden="true" tabindex="-1"></a>For demonstration, we use PRISM tmax data for the U.S. for January 2019 as a <span class="in">`stars`</span> object.</span>
<span id="cb171-1076"><a href="#cb171-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1077"><a href="#cb171-1077" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tmax-m1}</span></span>
<span id="cb171-1078"><a href="#cb171-1078" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1079"><a href="#cb171-1079" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_m8_y09_stars &lt;- </span></span>
<span id="cb171-1080"><a href="#cb171-1080" aria-hidden="true" tabindex="-1"></a><span class="in">  stars::read_stars("Data/PRISM_tmax_y2009_m8.tif") %&gt;% </span></span>
<span id="cb171-1081"><a href="#cb171-1081" aria-hidden="true" tabindex="-1"></a><span class="in">  setNames("tmax") %&gt;% </span></span>
<span id="cb171-1082"><a href="#cb171-1082" aria-hidden="true" tabindex="-1"></a><span class="in">  .[, , , 1:10] %&gt;%</span></span>
<span id="cb171-1083"><a href="#cb171-1083" aria-hidden="true" tabindex="-1"></a><span class="in">  stars::st_set_dimensions(</span></span>
<span id="cb171-1084"><a href="#cb171-1084" aria-hidden="true" tabindex="-1"></a><span class="in">    "band",</span></span>
<span id="cb171-1085"><a href="#cb171-1085" aria-hidden="true" tabindex="-1"></a><span class="in">    values = seq(</span></span>
<span id="cb171-1086"><a href="#cb171-1086" aria-hidden="true" tabindex="-1"></a><span class="in">      lubridate::ymd("2009-08-01"),</span></span>
<span id="cb171-1087"><a href="#cb171-1087" aria-hidden="true" tabindex="-1"></a><span class="in">      lubridate::ymd("2009-08-10"),</span></span>
<span id="cb171-1088"><a href="#cb171-1088" aria-hidden="true" tabindex="-1"></a><span class="in">      by = "days"</span></span>
<span id="cb171-1089"><a href="#cb171-1089" aria-hidden="true" tabindex="-1"></a><span class="in">    ), </span></span>
<span id="cb171-1090"><a href="#cb171-1090" aria-hidden="true" tabindex="-1"></a><span class="in">    name = "date"</span></span>
<span id="cb171-1091"><a href="#cb171-1091" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb171-1092"><a href="#cb171-1092" aria-hidden="true" tabindex="-1"></a><span class="in">) </span></span>
<span id="cb171-1093"><a href="#cb171-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1094"><a href="#cb171-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1095"><a href="#cb171-1095" aria-hidden="true" tabindex="-1"></a>The region of interest is Michigan.</span>
<span id="cb171-1096"><a href="#cb171-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1097"><a href="#cb171-1097" aria-hidden="true" tabindex="-1"></a><span class="in">```{r MI_county}</span></span>
<span id="cb171-1098"><a href="#cb171-1098" aria-hidden="true" tabindex="-1"></a><span class="in">MI_county_sf &lt;-</span></span>
<span id="cb171-1099"><a href="#cb171-1099" aria-hidden="true" tabindex="-1"></a><span class="in">  tigris::counties(state = "Michigan", cb = TRUE, progress_bar = FALSE) %&gt;% </span></span>
<span id="cb171-1100"><a href="#cb171-1100" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- transform using the CRS of the PRISM stars data  ---#</span></span>
<span id="cb171-1101"><a href="#cb171-1101" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(sf::st_crs(tmax_m8_y09_stars))</span></span>
<span id="cb171-1102"><a href="#cb171-1102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1103"><a href="#cb171-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1104"><a href="#cb171-1104" aria-hidden="true" tabindex="-1"></a>We can crop the tmax data to the Michigan state border using <span class="in">`st_crop()`</span> as follows:</span>
<span id="cb171-1105"><a href="#cb171-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1106"><a href="#cb171-1106" aria-hidden="true" tabindex="-1"></a><span class="in">```{r crop_to_MI}</span></span>
<span id="cb171-1107"><a href="#cb171-1107" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1108"><a href="#cb171-1108" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_MI &lt;- sf::st_crop(tmax_m8_y09_stars, MI_county_sf)</span></span>
<span id="cb171-1109"><a href="#cb171-1109" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1110"><a href="#cb171-1110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1111"><a href="#cb171-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1112"><a href="#cb171-1112" aria-hidden="true" tabindex="-1"></a>Notice that <span class="in">`from`</span> and <span class="in">`to`</span> for <span class="in">`x`</span> and <span class="in">`y`</span> have changed to cover only the boundary box of the Michigan state border. Note that the values for the cells outside of the Michigan state border were set to NA. @fig-mi-tmax shows the cropping was successful.</span>
<span id="cb171-1113"><a href="#cb171-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1116"><a href="#cb171-1116" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-1117"><a href="#cb171-1117" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-mi-tmax</span></span>
<span id="cb171-1118"><a href="#cb171-1118" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "PRISM tmax data cropped to the Michigan state border"</span></span>
<span id="cb171-1119"><a href="#cb171-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1120"><a href="#cb171-1120" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tmax_MI[,,,<span class="dv">1</span>])</span>
<span id="cb171-1121"><a href="#cb171-1121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1122"><a href="#cb171-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1123"><a href="#cb171-1123" aria-hidden="true" tabindex="-1"></a>Alternatively, you could use <span class="in">`[]`</span> like as follows to crop a <span class="in">`stars`</span> object.</span>
<span id="cb171-1124"><a href="#cb171-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1125"><a href="#cb171-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r alt}</span></span>
<span id="cb171-1126"><a href="#cb171-1126" aria-hidden="true" tabindex="-1"></a><span class="in">plot(tmax_m8_y09_stars[MI_county_sf])</span></span>
<span id="cb171-1127"><a href="#cb171-1127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1128"><a href="#cb171-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1129"><a href="#cb171-1129" aria-hidden="true" tabindex="-1"></a>:::{.callout-note title = "Use bounding box"}</span>
<span id="cb171-1130"><a href="#cb171-1130" aria-hidden="true" tabindex="-1"></a>When using <span class="in">`sf::st_crop()`</span>, it is much faster to crop to a bounding box instead of <span class="in">`sf`</span> if that is satisfactory. For example, you may be cropping a <span class="in">`stars`</span> object to speed up subsequent raster value extraction (see @sec-crop-first). In this case, it is far better to crop to the bounding box of the <span class="in">`sf`</span> instead of <span class="in">`sf`</span>. Confirm the speed difference between the two below:</span>
<span id="cb171-1131"><a href="#cb171-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1134"><a href="#cb171-1134" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-1135"><a href="#cb171-1135" aria-hidden="true" tabindex="-1"></a>crop_to_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_crop</span>(tmax_m8_y09_stars, MI_county_sf)</span>
<span id="cb171-1136"><a href="#cb171-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1137"><a href="#cb171-1137" aria-hidden="true" tabindex="-1"></a>crop_to_bbox <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_crop</span>(tmax_m8_y09_stars, sf<span class="sc">::</span><span class="fu">st_bbox</span>(MI_county_sf))</span>
<span id="cb171-1138"><a href="#cb171-1138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1139"><a href="#cb171-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1140"><a href="#cb171-1140" aria-hidden="true" tabindex="-1"></a>The difference can be substantial especially when the number of observations are large in <span class="in">`sf`</span>.</span>
<span id="cb171-1141"><a href="#cb171-1141" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb171-1142"><a href="#cb171-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1143"><a href="#cb171-1143" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting values for points {#sec-extraction-stars-points}</span></span>
<span id="cb171-1144"><a href="#cb171-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1145"><a href="#cb171-1145" aria-hidden="true" tabindex="-1"></a>In this section, we will learn how to extract cell values from raster layers as <span class="in">`starts`</span> for spatial units represented as point <span class="in">`sf`</span> data^<span class="co">[</span><span class="ot">see [@sec-extract-raster-to-vector] for a detailed explanation of what it means to **extract** raster values.</span><span class="co">]</span>.</span>
<span id="cb171-1146"><a href="#cb171-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1147"><a href="#cb171-1147" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Extraction using `stars::st_extract()`</span></span>
<span id="cb171-1148"><a href="#cb171-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1149"><a href="#cb171-1149" aria-hidden="true" tabindex="-1"></a>For the illustrations in this section, we use the following datasets: </span>
<span id="cb171-1150"><a href="#cb171-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1151"><a href="#cb171-1151" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Points: Irrigation wells in Kansas </span>
<span id="cb171-1152"><a href="#cb171-1152" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Raster: daily PRISM tmax data for August, 2009 </span>
<span id="cb171-1153"><a href="#cb171-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1154"><a href="#cb171-1154" aria-hidden="true" tabindex="-1"></a>**PRISM tmax data**</span>
<span id="cb171-1155"><a href="#cb171-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1156"><a href="#cb171-1156" aria-hidden="true" tabindex="-1"></a><span class="in">```{r download_07022018, cache = F, results = "hide"}</span></span>
<span id="cb171-1157"><a href="#cb171-1157" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1158"><a href="#cb171-1158" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_m8_y09_stars &lt;-</span></span>
<span id="cb171-1159"><a href="#cb171-1159" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::read_stars("Data/PRISM_tmax_y2009_m8.tif") %&gt;%</span></span>
<span id="cb171-1160"><a href="#cb171-1160" aria-hidden="true" tabindex="-1"></a><span class="in">    setNames("tmax") %&gt;%</span></span>
<span id="cb171-1161"><a href="#cb171-1161" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, , , 1:10] %&gt;%</span></span>
<span id="cb171-1162"><a href="#cb171-1162" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::st_set_dimensions(</span></span>
<span id="cb171-1163"><a href="#cb171-1163" aria-hidden="true" tabindex="-1"></a><span class="in">      "band",</span></span>
<span id="cb171-1164"><a href="#cb171-1164" aria-hidden="true" tabindex="-1"></a><span class="in">      values = seq(</span></span>
<span id="cb171-1165"><a href="#cb171-1165" aria-hidden="true" tabindex="-1"></a><span class="in">        lubridate::ymd("2009-08-01"),</span></span>
<span id="cb171-1166"><a href="#cb171-1166" aria-hidden="true" tabindex="-1"></a><span class="in">        lubridate::ymd("2009-08-10"),</span></span>
<span id="cb171-1167"><a href="#cb171-1167" aria-hidden="true" tabindex="-1"></a><span class="in">        by = "days"</span></span>
<span id="cb171-1168"><a href="#cb171-1168" aria-hidden="true" tabindex="-1"></a><span class="in">      ),</span></span>
<span id="cb171-1169"><a href="#cb171-1169" aria-hidden="true" tabindex="-1"></a><span class="in">      name = "date"</span></span>
<span id="cb171-1170"><a href="#cb171-1170" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb171-1171"><a href="#cb171-1171" aria-hidden="true" tabindex="-1"></a><span class="in">) </span></span>
<span id="cb171-1172"><a href="#cb171-1172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1173"><a href="#cb171-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1174"><a href="#cb171-1174" aria-hidden="true" tabindex="-1"></a>**Irrigation wells in Kansas:**</span>
<span id="cb171-1175"><a href="#cb171-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1176"><a href="#cb171-1176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r import_KS_wells}</span></span>
<span id="cb171-1177"><a href="#cb171-1177" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read in the KS points data ---#</span></span>
<span id="cb171-1178"><a href="#cb171-1178" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1179"><a href="#cb171-1179" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells &lt;- readRDS("Data/Chap_5_wells_KS.rds")</span></span>
<span id="cb171-1180"><a href="#cb171-1180" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1181"><a href="#cb171-1181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1182"><a href="#cb171-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1183"><a href="#cb171-1183" aria-hidden="true" tabindex="-1"></a>@fig-tmax-prism-wells show the spatial distribution of the irrigation wells over the PRISM grids:</span>
<span id="cb171-1184"><a href="#cb171-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1187"><a href="#cb171-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-1188"><a href="#cb171-1188" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tmax-prism-wells</span></span>
<span id="cb171-1189"><a href="#cb171-1189" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of Kansas county borders, irrigation wells, and PRISM tmax"</span></span>
<span id="cb171-1190"><a href="#cb171-1190" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb171-1191"><a href="#cb171-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1192"><a href="#cb171-1192" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb171-1193"><a href="#cb171-1193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> <span class="fu">st_crop</span>(tmax_m8_y09_stars[,,,<span class="dv">1</span>], <span class="fu">st_bbox</span>(KS_wells))) <span class="sc">+</span></span>
<span id="cb171-1194"><a href="#cb171-1194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">name =</span> <span class="st">"tmax"</span>) <span class="sc">+</span></span>
<span id="cb171-1195"><a href="#cb171-1195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_transform</span>(KS_wells, <span class="fu">st_crs</span>(tmax_m8_y09_stars)), <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb171-1196"><a href="#cb171-1196" aria-hidden="true" tabindex="-1"></a>  theme_for_map <span class="sc">+</span></span>
<span id="cb171-1197"><a href="#cb171-1197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb171-1198"><a href="#cb171-1198" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb171-1199"><a href="#cb171-1199" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb171-1200"><a href="#cb171-1200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1201"><a href="#cb171-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1202"><a href="#cb171-1202" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb171-1203"><a href="#cb171-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1204"><a href="#cb171-1204" aria-hidden="true" tabindex="-1"></a>We can extract the value of raster cells in which points are located using <span class="in">`stars::st_extract()`</span>.</span>
<span id="cb171-1205"><a href="#cb171-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1206"><a href="#cb171-1206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r syntax-st_extract, eval = F}</span></span>
<span id="cb171-1207"><a href="#cb171-1207" aria-hidden="true" tabindex="-1"></a><span class="in">#--- NOT RUN ---#</span></span>
<span id="cb171-1208"><a href="#cb171-1208" aria-hidden="true" tabindex="-1"></a><span class="in">stars::st_extract(stars object, sf of points)</span></span>
<span id="cb171-1209"><a href="#cb171-1209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1210"><a href="#cb171-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1211"><a href="#cb171-1211" aria-hidden="true" tabindex="-1"></a>Before we extract values from the <span class="in">`stars`</span> raster data, let's crop it to the spatial extent of the <span class="in">`KS_wells`</span>.</span>
<span id="cb171-1212"><a href="#cb171-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1213"><a href="#cb171-1213" aria-hidden="true" tabindex="-1"></a><span class="in">```{r crop-to-KS}</span></span>
<span id="cb171-1214"><a href="#cb171-1214" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_m8_y09_KS_stars &lt;- sf::st_crop(tmax_m8_y09_stars, KS_wells)</span></span>
<span id="cb171-1215"><a href="#cb171-1215" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1216"><a href="#cb171-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1217"><a href="#cb171-1217" aria-hidden="true" tabindex="-1"></a>We also should change the CRS of <span class="in">`KS_wells`</span> to that of <span class="in">`tmax_m8_y09_KS_stars`</span>.</span>
<span id="cb171-1218"><a href="#cb171-1218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1219"><a href="#cb171-1219" aria-hidden="true" tabindex="-1"></a><span class="in">```{r st-transform-ks}</span></span>
<span id="cb171-1220"><a href="#cb171-1220" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells &lt;- sf::st_transform(KS_wells, sf::st_crs(tmax_m8_y09_stars))</span></span>
<span id="cb171-1221"><a href="#cb171-1221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1222"><a href="#cb171-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1223"><a href="#cb171-1223" aria-hidden="true" tabindex="-1"></a>We now extract the value of rasters in which points are located:</span>
<span id="cb171-1224"><a href="#cb171-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1225"><a href="#cb171-1225" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extracted-points-disp}</span></span>
<span id="cb171-1226"><a href="#cb171-1226" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1227"><a href="#cb171-1227" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_tmax &lt;- stars::st_extract(tmax_m8_y09_KS_stars, KS_wells) </span></span>
<span id="cb171-1228"><a href="#cb171-1228" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1229"><a href="#cb171-1229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1230"><a href="#cb171-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1231"><a href="#cb171-1231" aria-hidden="true" tabindex="-1"></a>The returned object is a <span class="in">`stars`</span> object of simple features. You can convert this to a more familiar-looking <span class="in">`sf`</span> object using <span class="in">`sf::st_as_sf()`</span>:</span>
<span id="cb171-1232"><a href="#cb171-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1233"><a href="#cb171-1233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r to-sf-1}</span></span>
<span id="cb171-1234"><a href="#cb171-1234" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1235"><a href="#cb171-1235" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_tmax_sf &lt;- sf::st_as_sf(extracted_tmax) </span></span>
<span id="cb171-1236"><a href="#cb171-1236" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1237"><a href="#cb171-1237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1238"><a href="#cb171-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1239"><a href="#cb171-1239" aria-hidden="true" tabindex="-1"></a>As you can see each date forms a column of extracted values for the points because the third dimension of <span class="in">`tmax_MI`</span> is <span class="in">`date`</span>. So, you can easily turn the outcome to an <span class="in">`sf`</span> object with date as <span class="in">`Date`</span> object as follows.</span>
<span id="cb171-1240"><a href="#cb171-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1241"><a href="#cb171-1241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r convert-to-sf-with-dates}</span></span>
<span id="cb171-1242"><a href="#cb171-1242" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1243"><a href="#cb171-1243" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_tmax_long &lt;- </span></span>
<span id="cb171-1244"><a href="#cb171-1244" aria-hidden="true" tabindex="-1"></a><span class="in">  extracted_tmax_sf %&gt;%</span></span>
<span id="cb171-1245"><a href="#cb171-1245" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyr::pivot_longer(- geometry, names_to = "date", values_to = "tmax") %&gt;% </span></span>
<span id="cb171-1246"><a href="#cb171-1246" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf() %&gt;% </span></span>
<span id="cb171-1247"><a href="#cb171-1247" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(date = lubridate::ymd(date))</span></span>
<span id="cb171-1248"><a href="#cb171-1248" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1249"><a href="#cb171-1249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1250"><a href="#cb171-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1251"><a href="#cb171-1251" aria-hidden="true" tabindex="-1"></a>Note that all the variables other than <span class="in">`geometry`</span> in the points data (<span class="in">`KS_wells`</span>) are lost at the time of applying <span class="in">`stars::st_extract()`</span>. You take advantage the fact that the the order of the observations in the object returned by <span class="in">`stars::st_extract()`</span> is the order of the points (<span class="in">`KS_wells`</span>).</span>
<span id="cb171-1252"><a href="#cb171-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1253"><a href="#cb171-1253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r long-with-id}</span></span>
<span id="cb171-1254"><a href="#cb171-1254" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1255"><a href="#cb171-1255" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_tmax_long &lt;- </span></span>
<span id="cb171-1256"><a href="#cb171-1256" aria-hidden="true" tabindex="-1"></a><span class="in">  extracted_tmax_sf %&gt;% </span></span>
<span id="cb171-1257"><a href="#cb171-1257" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(well_id = KS_wells$well_id) %&gt;% </span></span>
<span id="cb171-1258"><a href="#cb171-1258" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(c(- geometry, - well_id), names_to = "date", values_to = "tmax") %&gt;% </span></span>
<span id="cb171-1259"><a href="#cb171-1259" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sf() %&gt;% </span></span>
<span id="cb171-1260"><a href="#cb171-1260" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(date = ymd(date))</span></span>
<span id="cb171-1261"><a href="#cb171-1261" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1262"><a href="#cb171-1262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1263"><a href="#cb171-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1264"><a href="#cb171-1264" aria-hidden="true" tabindex="-1"></a>We can now summarize the data by <span class="in">`well_id`</span> and then merge it back to <span class="in">`KS_wells`</span>.</span>
<span id="cb171-1265"><a href="#cb171-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1266"><a href="#cb171-1266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r monthly-mean-tmax, eval = F}</span></span>
<span id="cb171-1267"><a href="#cb171-1267" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells &lt;-</span></span>
<span id="cb171-1268"><a href="#cb171-1268" aria-hidden="true" tabindex="-1"></a><span class="in">  extracted_tmax_long %&gt;%</span></span>
<span id="cb171-1269"><a href="#cb171-1269" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- geometry no longer needed ---#</span></span>
<span id="cb171-1270"><a href="#cb171-1270" aria-hidden="true" tabindex="-1"></a><span class="in">  # if you do not do this, summarize() takes a long time</span></span>
<span id="cb171-1271"><a href="#cb171-1271" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_drop_geometry() %&gt;%</span></span>
<span id="cb171-1272"><a href="#cb171-1272" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::group_by(well_id, month(date)) %&gt;%</span></span>
<span id="cb171-1273"><a href="#cb171-1273" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::summarize(mean(tmax)) %&gt;%</span></span>
<span id="cb171-1274"><a href="#cb171-1274" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::left_join(KS_wells, ., by = "well_id")</span></span>
<span id="cb171-1275"><a href="#cb171-1275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1276"><a href="#cb171-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1277"><a href="#cb171-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1278"><a href="#cb171-1278" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extract and summarize values for polygons {#sec-extraction-stars-polygons}</span></span>
<span id="cb171-1279"><a href="#cb171-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1280"><a href="#cb171-1280" aria-hidden="true" tabindex="-1"></a>In this section, we will learn how to extract cell values from raster layers as <span class="in">`starts`</span> for spatial units represented as polygons <span class="in">`sf`</span> data (see <span class="co">[</span><span class="ot">@sec-extract-raster-to-vector</span><span class="co">]</span> for a more detailed explanation of this operation).</span>
<span id="cb171-1281"><a href="#cb171-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1282"><a href="#cb171-1282" aria-hidden="true" tabindex="-1"></a>In order to extract cell values from <span class="in">`stars`</span> objects (just like @sec-int-RV) and summarize them for polygons, you can use <span class="in">`aggregate.stars()`</span>. Although introduced here because it natively accepts stars objects, <span class="in">`aggregate.stars()`</span> is &lt;span style = "color: red;"&gt;not recommended&lt;/span&gt; unless the raster data is small (with a small number of cells). It is almost always slower than the two other alternatives: <span class="in">`terra::extract()`</span> and <span class="in">`exactextractr::exact_extract()`</span> even though they involve conversion of <span class="in">`stars`</span> objects to <span class="in">`SpatRaster`</span> objects. For a comparison of its performance relative to these alternatives, see @sec-num-cells-geometries. If you just want to see the better alternatives, you can just skip to @sec-ee-extract-stars.</span>
<span id="cb171-1283"><a href="#cb171-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1284"><a href="#cb171-1284" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `aggregate.stars()` {#sec-extract-polygon-aggregate}</span></span>
<span id="cb171-1285"><a href="#cb171-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1286"><a href="#cb171-1286" aria-hidden="true" tabindex="-1"></a>The syntax of <span class="in">`aggregate.stars()`</span> is as follows:</span>
<span id="cb171-1287"><a href="#cb171-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1288"><a href="#cb171-1288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r syntax-aggregate, eval = F}</span></span>
<span id="cb171-1289"><a href="#cb171-1289" aria-hidden="true" tabindex="-1"></a><span class="in">#--- NOT RUN ---#</span></span>
<span id="cb171-1290"><a href="#cb171-1290" aria-hidden="true" tabindex="-1"></a><span class="in">aggregate(stars object, sf object, FUN = function to apply)</span></span>
<span id="cb171-1291"><a href="#cb171-1291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1292"><a href="#cb171-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1293"><a href="#cb171-1293" aria-hidden="true" tabindex="-1"></a>For each polygon, <span class="in">`aggregate()`</span> identifies the cells whose centroids lie within the polygon, extracts their values, and applies the specified function to those values. Let’s now see a demonstration of how to use <span class="in">`aggregate()`</span>. For this example, we will use Kansas counties as the polygon data.</span>
<span id="cb171-1294"><a href="#cb171-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1295"><a href="#cb171-1295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r county-KS}</span></span>
<span id="cb171-1296"><a href="#cb171-1296" aria-hidden="true" tabindex="-1"></a><span class="in">KS_county_sf &lt;-</span></span>
<span id="cb171-1297"><a href="#cb171-1297" aria-hidden="true" tabindex="-1"></a><span class="in">  tigris::counties(state = "Kansas", cb = TRUE, progress_bar = FALSE)%&gt;%</span></span>
<span id="cb171-1298"><a href="#cb171-1298" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- transform using the CRS of the PRISM stars data  ---#</span></span>
<span id="cb171-1299"><a href="#cb171-1299" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(sf::st_crs(tmax_m8_y09_stars)) %&gt;%</span></span>
<span id="cb171-1300"><a href="#cb171-1300" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- generate unique id ---#</span></span>
<span id="cb171-1301"><a href="#cb171-1301" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(id = 1:nrow(.))</span></span>
<span id="cb171-1302"><a href="#cb171-1302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1303"><a href="#cb171-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1304"><a href="#cb171-1304" aria-hidden="true" tabindex="-1"></a>@fig-polygons-location shows polygons (counties) superimposed on top of the tmax raster data:</span>
<span id="cb171-1305"><a href="#cb171-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1306"><a href="#cb171-1306" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb171-1309"><a href="#cb171-1309" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-1310"><a href="#cb171-1310" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-polygons-location</span></span>
<span id="cb171-1311"><a href="#cb171-1311" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of Kansas counties over tmax raster data"</span></span>
<span id="cb171-1312"><a href="#cb171-1312" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb171-1313"><a href="#cb171-1313" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb171-1314"><a href="#cb171-1314" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb171-1315"><a href="#cb171-1315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> sf<span class="sc">::</span><span class="fu">st_crop</span>(tmax_m8_y09_stars, sf<span class="sc">::</span><span class="fu">st_bbox</span>(KS_county_sf))[,,,<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb171-1316"><a href="#cb171-1316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>() <span class="sc">+</span></span>
<span id="cb171-1317"><a href="#cb171-1317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_county_sf, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb171-1318"><a href="#cb171-1318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb171-1319"><a href="#cb171-1319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1320"><a href="#cb171-1320" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb171-1321"><a href="#cb171-1321" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb171-1322"><a href="#cb171-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1323"><a href="#cb171-1323" aria-hidden="true" tabindex="-1"></a>For example, the following code will find the mean of the tmax values for each county:</span>
<span id="cb171-1324"><a href="#cb171-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1325"><a href="#cb171-1325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mean-aggregate}</span></span>
<span id="cb171-1326"><a href="#cb171-1326" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1327"><a href="#cb171-1327" aria-hidden="true" tabindex="-1"></a><span class="in">mean_tmax_stars &lt;- aggregate(tmax_m8_y09_stars, KS_county_sf, FUN = mean) </span></span>
<span id="cb171-1328"><a href="#cb171-1328" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1329"><a href="#cb171-1329" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1330"><a href="#cb171-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1331"><a href="#cb171-1331" aria-hidden="true" tabindex="-1"></a>As you can see, the <span class="in">`aggregate()`</span> operation also returns a <span class="in">`stars`</span> object for polygons just like <span class="in">`stars::st_extract()`</span> did. You can convert the <span class="in">`stars`</span> object into an <span class="in">`sf`</span> object using <span class="in">`sf::st_as_sf()`</span>:</span>
<span id="cb171-1332"><a href="#cb171-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1333"><a href="#cb171-1333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r to-sf}</span></span>
<span id="cb171-1334"><a href="#cb171-1334" aria-hidden="true" tabindex="-1"></a><span class="in">mean_tmax_sf &lt;- sf::st_as_sf(mean_tmax_stars)</span></span>
<span id="cb171-1335"><a href="#cb171-1335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1336"><a href="#cb171-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1337"><a href="#cb171-1337" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`aggregate()`</span> function extracted values for the polygons from all the layers across the date dimension, and the values from individual dates become variables where the variables names are the corresponding date values.</span>
<span id="cb171-1338"><a href="#cb171-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1339"><a href="#cb171-1339" aria-hidden="true" tabindex="-1"></a>Just like the case of raster data extraction for points data we saw in @sec-extraction-stars-points, no information from the polygons (<span class="in">`KS_county_sf`</span>) except the geometry column remains. For further processing of the extracted data and easy merging with the polygons data (<span class="in">`KS_county_sf`</span>), we can assign the unique county id just like we did for the case of points data.</span>
<span id="cb171-1340"><a href="#cb171-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1341"><a href="#cb171-1341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mean-aggregate-na-remove-id, eval = F}</span></span>
<span id="cb171-1342"><a href="#cb171-1342" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1343"><a href="#cb171-1343" aria-hidden="true" tabindex="-1"></a><span class="in">  mean_tmax_long &lt;-</span></span>
<span id="cb171-1344"><a href="#cb171-1344" aria-hidden="true" tabindex="-1"></a><span class="in">    mean_tmax_sf %&gt;%</span></span>
<span id="cb171-1345"><a href="#cb171-1345" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- drop geometry ---#</span></span>
<span id="cb171-1346"><a href="#cb171-1346" aria-hidden="true" tabindex="-1"></a><span class="in">    sf::st_drop_geometry() %&gt;%</span></span>
<span id="cb171-1347"><a href="#cb171-1347" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- assign id before transformation ---#</span></span>
<span id="cb171-1348"><a href="#cb171-1348" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::mutate(id = KS_county_sf$id) %&gt;%</span></span>
<span id="cb171-1349"><a href="#cb171-1349" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- then transform ---#</span></span>
<span id="cb171-1350"><a href="#cb171-1350" aria-hidden="true" tabindex="-1"></a><span class="in">    tidyr::pivot_longer(-id, names_to = "date", values_to = "tmax")</span></span>
<span id="cb171-1351"><a href="#cb171-1351" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1352"><a href="#cb171-1352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1353"><a href="#cb171-1353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1354"><a href="#cb171-1354" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb171-1355"><a href="#cb171-1355" aria-hidden="true" tabindex="-1"></a><span class="in">`aggregate()`</span> will return NA for polygons that intersect with raster cells that have NA values. To ignore the NA values when applying a function, we can add <span class="in">`na.rm=TRUE`</span> option like this:</span>
<span id="cb171-1356"><a href="#cb171-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1357"><a href="#cb171-1357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mean-aggregate-na-remove, eval = F}</span></span>
<span id="cb171-1358"><a href="#cb171-1358" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1359"><a href="#cb171-1359" aria-hidden="true" tabindex="-1"></a><span class="in">  mean_tmax_stars &lt;-</span></span>
<span id="cb171-1360"><a href="#cb171-1360" aria-hidden="true" tabindex="-1"></a><span class="in">    aggregate(</span></span>
<span id="cb171-1361"><a href="#cb171-1361" aria-hidden="true" tabindex="-1"></a><span class="in">      tmax_m8_y09_stars,</span></span>
<span id="cb171-1362"><a href="#cb171-1362" aria-hidden="true" tabindex="-1"></a><span class="in">      KS_county_sf,</span></span>
<span id="cb171-1363"><a href="#cb171-1363" aria-hidden="true" tabindex="-1"></a><span class="in">      FUN = mean,</span></span>
<span id="cb171-1364"><a href="#cb171-1364" aria-hidden="true" tabindex="-1"></a><span class="in">      na.rm = TRUE</span></span>
<span id="cb171-1365"><a href="#cb171-1365" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;%</span></span>
<span id="cb171-1366"><a href="#cb171-1366" aria-hidden="true" tabindex="-1"></a><span class="in">    sf::st_as_sf()</span></span>
<span id="cb171-1367"><a href="#cb171-1367" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1368"><a href="#cb171-1368" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1369"><a href="#cb171-1369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1370"><a href="#cb171-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1371"><a href="#cb171-1371" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb171-1372"><a href="#cb171-1372" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb171-1373"><a href="#cb171-1373" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `exactextractr::exact_extract()` {#sec-ee-extract-stars}</span></span>
<span id="cb171-1374"><a href="#cb171-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1375"><a href="#cb171-1375" aria-hidden="true" tabindex="-1"></a>A great alternative to <span class="in">`aggregate()`</span> is to extract raster cell values using <span class="in">`exactextractr::exact_extract()`</span> or <span class="in">`terra::extract()`</span> and then summarize the results yourself. Both are considerably faster than <span class="in">`aggregate.stars()`</span>. Although they do not natively accept <span class="in">`stars`</span> objects, you can easily convert a <span class="in">`stars`</span> object to a <span class="in">`SpatRaster`</span> using <span class="in">`as(stars, "SpatRaster")`</span> and then use these methods.</span>
<span id="cb171-1376"><a href="#cb171-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1377"><a href="#cb171-1377" aria-hidden="true" tabindex="-1"></a>Let's first convert <span class="in">`tmax_m8_y09_KS_stars`</span> (a <span class="in">`stars`</span> object) into a <span class="in">`SpatRaster`</span> object.</span>
<span id="cb171-1378"><a href="#cb171-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1379"><a href="#cb171-1379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stars-to-rb}</span></span>
<span id="cb171-1380"><a href="#cb171-1380" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1381"><a href="#cb171-1381" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_m8_y09_KS_sr &lt;- as(tmax_m8_y09_KS_stars, "SpatRaster")</span></span>
<span id="cb171-1382"><a href="#cb171-1382" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1383"><a href="#cb171-1383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1384"><a href="#cb171-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1385"><a href="#cb171-1385" aria-hidden="true" tabindex="-1"></a>Now, we can use <span class="in">`exactextractr::exact_extract()`</span> as follows:</span>
<span id="cb171-1386"><a href="#cb171-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1387"><a href="#cb171-1387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extracted-values-ee, results = "hide"}</span></span>
<span id="cb171-1388"><a href="#cb171-1388" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- exactextractr::exact_extract(tmax_m8_y09_KS_sr, KS_county_sf, include_cols = "COUNTYFP")</span></span>
<span id="cb171-1389"><a href="#cb171-1389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1390"><a href="#cb171-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1391"><a href="#cb171-1391" aria-hidden="true" tabindex="-1"></a>The returned outcome is a list of <span class="in">`data.frame`</span>. Let's take a look at the first 6 rows of the first 3 elements of the list.</span>
<span id="cb171-1392"><a href="#cb171-1392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1393"><a href="#cb171-1393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r take-a-look-ee}</span></span>
<span id="cb171-1394"><a href="#cb171-1394" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values[1:3] %&gt;% lapply(., head)</span></span>
<span id="cb171-1395"><a href="#cb171-1395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1396"><a href="#cb171-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1397"><a href="#cb171-1397" aria-hidden="true" tabindex="-1"></a>As you can see, each <span class="in">`data.frame`</span> has variables called <span class="in">`COUNTYFP`</span>, <span class="in">`date2009-08-01`</span>, $\dots$, <span class="in">`date2009-08-10`</span> (they are from the layer names in <span class="in">`tmax_m8_y09_KS_sr`</span>) and <span class="in">`coverage_fraction`</span>. <span class="in">`COUNTYFP`</span> was inherited from <span class="in">`KS_county_sf`</span> thanks to <span class="in">`include_cols = "COUNTYFP"`</span> and let us merge the extracted values with <span class="in">`KS_county_sf`</span>.</span>
<span id="cb171-1398"><a href="#cb171-1398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1399"><a href="#cb171-1399" aria-hidden="true" tabindex="-1"></a>In order to make the results easier to work with, you can process them to get a single <span class="in">`data.frame`</span>, taking advantage of <span class="in">`dplyr::bind_rows()`</span> to combine the list of the datasets into one dataset. </span>
<span id="cb171-1400"><a href="#cb171-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1401"><a href="#cb171-1401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r single-sf-ee}</span></span>
<span id="cb171-1402"><a href="#cb171-1402" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values_df &lt;-</span></span>
<span id="cb171-1403"><a href="#cb171-1403" aria-hidden="true" tabindex="-1"></a><span class="in">  extracted_values %&gt;%</span></span>
<span id="cb171-1404"><a href="#cb171-1404" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- combine the list of data.frames ---#</span></span>
<span id="cb171-1405"><a href="#cb171-1405" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::bind_rows()</span></span>
<span id="cb171-1406"><a href="#cb171-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1407"><a href="#cb171-1407" aria-hidden="true" tabindex="-1"></a><span class="in">head(extracted_values_df)</span></span>
<span id="cb171-1408"><a href="#cb171-1408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1409"><a href="#cb171-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1410"><a href="#cb171-1410" aria-hidden="true" tabindex="-1"></a>Now, let's find area-weighted mean of tmax for each of the county-date combinations. The following code </span>
<span id="cb171-1411"><a href="#cb171-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1412"><a href="#cb171-1412" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>reshapes <span class="in">`extracted_values_df`</span> to a long format</span>
<span id="cb171-1413"><a href="#cb171-1413" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>recovers date as <span class="in">`Date`</span> object</span>
<span id="cb171-1414"><a href="#cb171-1414" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>calculates area-weighted mean of tmax by county-date</span>
<span id="cb171-1415"><a href="#cb171-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1418"><a href="#cb171-1418" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-1419"><a href="#cb171-1419" aria-hidden="true" tabindex="-1"></a>extracted_values_df <span class="sc">%&gt;%</span></span>
<span id="cb171-1420"><a href="#cb171-1420" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- long to wide ---#</span></span>
<span id="cb171-1421"><a href="#cb171-1421" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb171-1422"><a href="#cb171-1422" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span>COUNTYFP, <span class="sc">-</span>coverage_fraction),</span>
<span id="cb171-1423"><a href="#cb171-1423" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"date"</span>,</span>
<span id="cb171-1424"><a href="#cb171-1424" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"tmax"</span></span>
<span id="cb171-1425"><a href="#cb171-1425" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb171-1426"><a href="#cb171-1426" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- remove date  ---#</span></span>
<span id="cb171-1427"><a href="#cb171-1427" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb171-1428"><a href="#cb171-1428" aria-hidden="true" tabindex="-1"></a>    <span class="co">#--- remove "date" from date and then convert it to Date ---#</span></span>
<span id="cb171-1429"><a href="#cb171-1429" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">gsub</span>(<span class="st">"date"</span>, <span class="st">""</span>, date) <span class="sc">%&gt;%</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>()</span>
<span id="cb171-1430"><a href="#cb171-1430" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb171-1431"><a href="#cb171-1431" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- mean area-weighted tmax by county-date ---#</span></span>
<span id="cb171-1432"><a href="#cb171-1432" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(COUNTYFP, date) <span class="sc">%&gt;%</span></span>
<span id="cb171-1433"><a href="#cb171-1433" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span></span>
<span id="cb171-1434"><a href="#cb171-1434" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="fu">sum</span>(tmax <span class="sc">*</span> coverage_fraction)<span class="sc">/</span><span class="fu">sum</span>(coverage_fraction))</span>
<span id="cb171-1435"><a href="#cb171-1435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1436"><a href="#cb171-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1437"><a href="#cb171-1437" aria-hidden="true" tabindex="-1"></a>This can now be readily merged with <span class="in">`KS_county_sf`</span> using <span class="in">`COUNTYFP`</span> as the key.</span>
<span id="cb171-1438"><a href="#cb171-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1439"><a href="#cb171-1439" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb171-1440"><a href="#cb171-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1441"><a href="#cb171-1441" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Summarizing the extracted values inside `exactextractr::exact_extract()`</span></span>
<span id="cb171-1442"><a href="#cb171-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1443"><a href="#cb171-1443" aria-hidden="true" tabindex="-1"></a>Instead of returning the value from all the intersecting cells, <span class="in">`exactextractr::exact_extract()`</span> can summarize the extracted values by polygon and then return the summarized numbers. This is much like how <span class="in">`aggregate()`</span> works, which we saw above. There are multiple default options you can choose from. All you need to do is to add the desired summary function name as the third argument of <span class="in">`exactextractr::exact_extract()`</span>. For example, the following will get us the mean of the extracted values weighted by <span class="in">`coverage_fraction`</span>.</span>
<span id="cb171-1444"><a href="#cb171-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1445"><a href="#cb171-1445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mean-cov, results = "hide"}</span></span>
<span id="cb171-1446"><a href="#cb171-1446" aria-hidden="true" tabindex="-1"></a><span class="in">extacted_mean &lt;- exactextractr::exact_extract(tmax_m8_y09_KS_sr, KS_county_sf, "mean", append_cols = "COUNTYFP", progress = FALSE)</span></span>
<span id="cb171-1447"><a href="#cb171-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1448"><a href="#cb171-1448" aria-hidden="true" tabindex="-1"></a><span class="in">head(extacted_mean)</span></span>
<span id="cb171-1449"><a href="#cb171-1449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1450"><a href="#cb171-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1451"><a href="#cb171-1451" aria-hidden="true" tabindex="-1"></a>Notice that you use <span class="in">`append_cols`</span> instead of <span class="in">`include_cols`</span> when you summarize within <span class="in">`exactextractr::exact_extract()`</span>.</span>
<span id="cb171-1452"><a href="#cb171-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1453"><a href="#cb171-1453" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb171-1454"><a href="#cb171-1454" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1455"><a href="#cb171-1455" aria-hidden="true" tabindex="-1"></a><span class="in">mean_tmax_long &lt;- </span></span>
<span id="cb171-1456"><a href="#cb171-1456" aria-hidden="true" tabindex="-1"></a><span class="in">  extacted_mean %&gt;% </span></span>
<span id="cb171-1457"><a href="#cb171-1457" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- wide to long ---#</span></span>
<span id="cb171-1458"><a href="#cb171-1458" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(-COUNTYFP, names_to = "date", values_to = "tmax") %&gt;%</span></span>
<span id="cb171-1459"><a href="#cb171-1459" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- recover date ---#</span></span>
<span id="cb171-1460"><a href="#cb171-1460" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(date = gsub("mean.date", "", date) %&gt;% lubridate::ymd())</span></span>
<span id="cb171-1461"><a href="#cb171-1461" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1462"><a href="#cb171-1462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1463"><a href="#cb171-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1464"><a href="#cb171-1464" aria-hidden="true" tabindex="-1"></a>There are other summary function options that may be of interest, such as "max", "min." You can see all the default options at <span class="co">[</span><span class="ot">the package website</span><span class="co">](https://isciences.gitlab.io/exactextractr/index.html#summary-operations)</span>. </span>
<span id="cb171-1465"><a href="#cb171-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1466"><a href="#cb171-1466" aria-hidden="true" tabindex="-1"></a><span class="fu">#### area-weighted v.s. coverage-fraction-weighted summary (Optional)</span></span>
<span id="cb171-1467"><a href="#cb171-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1468"><a href="#cb171-1468" aria-hidden="true" tabindex="-1"></a>When we found the mean of tmax weighted by coverage fraction, each raster cell was assumed to cover the same area. This is not exactly correct when a raster layer in geographic coordinates (latitude/longitude) is used. To see this, let's find the area of each cell using <span class="in">`terra::cellSize()`</span>.</span>
<span id="cb171-1469"><a href="#cb171-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1470"><a href="#cb171-1470" aria-hidden="true" tabindex="-1"></a><span class="in">```{r find-raster-area}</span></span>
<span id="cb171-1471"><a href="#cb171-1471" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb171-1472"><a href="#cb171-1472" aria-hidden="true" tabindex="-1"></a><span class="in">raster_area_data &lt;- terra::cellSize(tmax_m8_y09_KS_sr)</span></span>
<span id="cb171-1473"><a href="#cb171-1473" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb171-1474"><a href="#cb171-1474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1475"><a href="#cb171-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1476"><a href="#cb171-1476" aria-hidden="true" tabindex="-1"></a>The output is a <span class="in">`SpatRaster`</span>, where the area of the cells are stored as <span class="in">`values`</span>. @fig-prism-raster-area shows the map of the PRISM raster cells in Kansas, color-differentiated by area.</span>
<span id="cb171-1477"><a href="#cb171-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1480"><a href="#cb171-1480" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb171-1481"><a href="#cb171-1481" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-prism-raster-area</span></span>
<span id="cb171-1482"><a href="#cb171-1482" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Area of PRISM raster cells" </span></span>
<span id="cb171-1483"><a href="#cb171-1483" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb171-1484"><a href="#cb171-1484" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(raster_area_data)</span>
<span id="cb171-1485"><a href="#cb171-1485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1486"><a href="#cb171-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1487"><a href="#cb171-1487" aria-hidden="true" tabindex="-1"></a>The area of a raster cell becomes slightly larger as the latitude increases. This is mainly due to the fact that 1 degree in longitude is longer in actual length on the earth surface at a higher latitude than at a lower latitude in the northern hemisphere.^<span class="co">[</span><span class="ot">The opposite happens in the southern hemisphere.</span><span class="co">]</span> The mean of extracted values weighted by coverage fraction ignores this fact and implicitly assumes the all the cells have the same area.</span>
<span id="cb171-1488"><a href="#cb171-1488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1489"><a href="#cb171-1489" aria-hidden="true" tabindex="-1"></a>In order to get an area-weighted mean instead of a coverage-weighted mean, you can use the "weighted_mean" option as the third argument and also supply the <span class="in">`SpatRaster`</span> of area (<span class="in">`raster_area_data`</span> here) like this:</span>
<span id="cb171-1490"><a href="#cb171-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1491"><a href="#cb171-1491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r area-weighted-mean}</span></span>
<span id="cb171-1492"><a href="#cb171-1492" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_weighted_mean &lt;-</span></span>
<span id="cb171-1493"><a href="#cb171-1493" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb171-1494"><a href="#cb171-1494" aria-hidden="true" tabindex="-1"></a><span class="in">    tmax_m8_y09_KS_sr,</span></span>
<span id="cb171-1495"><a href="#cb171-1495" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb171-1496"><a href="#cb171-1496" aria-hidden="true" tabindex="-1"></a><span class="in">    "weighted_mean",</span></span>
<span id="cb171-1497"><a href="#cb171-1497" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = raster_area_data,</span></span>
<span id="cb171-1498"><a href="#cb171-1498" aria-hidden="true" tabindex="-1"></a><span class="in">    append_cols = "COUNTYFP",</span></span>
<span id="cb171-1499"><a href="#cb171-1499" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb171-1500"><a href="#cb171-1500" aria-hidden="true" tabindex="-1"></a><span class="in">  )   </span></span>
<span id="cb171-1501"><a href="#cb171-1501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1502"><a href="#cb171-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1503"><a href="#cb171-1503" aria-hidden="true" tabindex="-1"></a>Let's compare the difference in the calculated means from the two methods for the first polygon.</span>
<span id="cb171-1504"><a href="#cb171-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1505"><a href="#cb171-1505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r comparison}</span></span>
<span id="cb171-1506"><a href="#cb171-1506" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_weighted_mean[, 2] - extacted_mean[, 2]</span></span>
<span id="cb171-1507"><a href="#cb171-1507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb171-1508"><a href="#cb171-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-1509"><a href="#cb171-1509" aria-hidden="true" tabindex="-1"></a>As you can see the error is minimal. So, the consequence of using coverage-weighted means should be negligible in most cases. Indeed, unless polygons span a wide range of latitude and longitude, the error introduce by using the coverage-weighted mean instead of area-weighted mean should be negligible.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/06-stars.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>
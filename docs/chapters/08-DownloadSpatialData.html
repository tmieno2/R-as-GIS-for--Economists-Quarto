<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>8&nbsp; Download and process spatial datasets from within R – R as GIS for Economists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/07-CreateMaps-ggplot.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Google tag (gtag.js) --><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../style.css">
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/06-stars.html">Extensions</a></li><li class="breadcrumb-item"><a href="../chapters/08-DownloadSpatialData.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">R as GIS for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/R-as-GIS-for-Economists" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/00-preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Demonstrations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-Demonstration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-VectorDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-SpatialInteractionVectorVector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-RasterDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-SpatialInteractionVectorRaster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Extensions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-stars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-CreateMaps-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-DownloadSpatialData.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">(slightly) Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-SpeedThingsUp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-ParallelComputing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Loop and Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-ggplot2-appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">ggplot2 minimals</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#before-you-start" id="toc-before-you-start" class="nav-link active" data-scroll-target="#before-you-start">Before you start</a>
  <ul class="collapse">
<li><a href="#direction-for-replication" id="toc-direction-for-replication" class="nav-link" data-scroll-target="#direction-for-replication">Direction for replication</a></li>
  </ul>
</li>
  <li>
<a href="#sec-nass-quick" id="toc-sec-nass-quick" class="nav-link" data-scroll-target="#sec-nass-quick"><span class="header-section-number">8.1</span> USDA NASS QuickStat with <code>tidyUSDA</code></a>
  <ul class="collapse">
<li><a href="#look-for-parameter-values" id="toc-look-for-parameter-values" class="nav-link" data-scroll-target="#look-for-parameter-values"><span class="header-section-number">8.1.1</span> Look for parameter values</a></li>
  <li><a href="#caveats" id="toc-caveats" class="nav-link" data-scroll-target="#caveats"><span class="header-section-number">8.1.2</span> Caveats</a></li>
  </ul>
</li>
  <li>
<a href="#sec-CropScapeR" id="toc-sec-CropScapeR" class="nav-link" data-scroll-target="#sec-CropScapeR"><span class="header-section-number">8.2</span> CDL with <code>CropScapeR</code></a>
  <ul class="collapse">
<li><a href="#cropscapergetcdldata-download-the-cdl-data-as-raster-data" id="toc-cropscapergetcdldata-download-the-cdl-data-as-raster-data" class="nav-link" data-scroll-target="#cropscapergetcdldata-download-the-cdl-data-as-raster-data"><span class="header-section-number">8.2.1</span> <code>CropScapeR::GetCDLData</code>: Download the CDL data as raster data</a></li>
  <li><a href="#data-processing-after-downloading-data" id="toc-data-processing-after-downloading-data" class="nav-link" data-scroll-target="#data-processing-after-downloading-data"><span class="header-section-number">8.2.2</span> Data processing after downloading data</a></li>
  <li><a href="#other-forms-of-cdl-data" id="toc-other-forms-of-cdl-data" class="nav-link" data-scroll-target="#other-forms-of-cdl-data"><span class="header-section-number">8.2.3</span> Other forms of CDL data</a></li>
  </ul>
</li>
  <li>
<a href="#sec-download-prism" id="toc-sec-download-prism" class="nav-link" data-scroll-target="#sec-download-prism"><span class="header-section-number">8.3</span> PRISM with <code>prism</code></a>
  <ul class="collapse">
<li><a href="#basics" id="toc-basics" class="nav-link" data-scroll-target="#basics"><span class="header-section-number">8.3.1</span> Basics</a></li>
  <li><a href="#download-daily-prism-data-for-many-years-and-build-your-own-datasets" id="toc-download-daily-prism-data-for-many-years-and-build-your-own-datasets" class="nav-link" data-scroll-target="#download-daily-prism-data-for-many-years-and-build-your-own-datasets"><span class="header-section-number">8.3.2</span> Download daily PRISM data for many years and build your own datasets</a></li>
  </ul>
</li>
  <li>
<a href="#sec-daymetr" id="toc-sec-daymetr" class="nav-link" data-scroll-target="#sec-daymetr"><span class="header-section-number">8.4</span> Daymet with <code>daymetr</code> and <code>FedData</code></a>
  <ul class="collapse">
<li><a href="#for-points-data" id="toc-for-points-data" class="nav-link" data-scroll-target="#for-points-data"><span class="header-section-number">8.4.1</span> For points data</a></li>
  <li><a href="#sec-daymet-poly" id="toc-sec-daymet-poly" class="nav-link" data-scroll-target="#sec-daymet-poly"><span class="header-section-number">8.4.2</span> For polygons data</a></li>
  </ul>
</li>
  <li>
<a href="#sec-gridMET" id="toc-sec-gridMET" class="nav-link" data-scroll-target="#sec-gridMET"><span class="header-section-number">8.5</span> gridMET</a>
  <ul class="collapse">
<li><a href="#practical-examples" id="toc-practical-examples" class="nav-link" data-scroll-target="#practical-examples"><span class="header-section-number">8.5.1</span> Practical Examples</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/08-DownloadSpatialData.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/06-stars.html">Extensions</a></li><li class="breadcrumb-item"><a href="../chapters/08-DownloadSpatialData.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-download-data" class="quarto-section-identifier"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="before-you-start" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="before-you-start">Before you start</h2>
<p>There are many publicly available spatial datasets that can be downloaded using R. Programming data downloading using R instead of manually downloading data from websites can save lots of time and also enhances the reproducibility of your analysis. In this section, we will introduce some of such datasets and show how to download and process those data.</p>
<section id="direction-for-replication" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="direction-for-replication">Direction for replication</h3>
<p><strong>Datasets</strong></p>
<p>No datasets to download for this Chapter.</p>
<p><strong>Packages</strong></p>
<ul>
<li>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">stars</span>, <span class="co"># spatiotemporal data handling</span></span>
<span>  <span class="va">terra</span>, <span class="co"># raster data handling</span></span>
<span>  <span class="va">raster</span>, <span class="co"># raster data handling</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data handling</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">stringr</span>, <span class="co"># string manipulation</span></span>
<span>  <span class="va">lubridate</span>, <span class="co"># dates handling</span></span>
<span>  <span class="va">data.table</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">tidyr</span>, <span class="co"># reshape</span></span>
<span>  <span class="va">tidyUSDA</span>, <span class="co"># download USDA NASS data</span></span>
<span>  <span class="va">keyring</span>, <span class="co"># API key management</span></span>
<span>  <span class="va">FedData</span>, <span class="co"># download Daymet data</span></span>
<span>  <span class="va">daymetr</span>, <span class="co"># download Daymet data</span></span>
<span>  <span class="va">ggplot2</span>, <span class="co"># make maps</span></span>
<span>  <span class="va">ggthemes</span>, <span class="co"># ggplot themes</span></span>
<span>  <span class="va">future.apply</span>, <span class="co"># parallel processing</span></span>
<span>  <span class="va">CropScapeR</span>, <span class="co"># download CDL data</span></span>
<span>  <span class="va">prism</span>, <span class="co"># download PRISM data</span></span>
<span>  <span class="va">exactextractr</span> <span class="co"># extract raster values to sf</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Run the following code to define the theme for map:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">theme_for_map</span> <span class="op">&lt;-</span> <span class="fu">theme</span><span class="op">(</span></span>
<span>  axis.ticks <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  axis.text <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.border <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,</span>
<span>  panel.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span>, color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-nass-quick" class="level2 page-columns page-full" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="sec-nass-quick">
<span class="header-section-number">8.1</span> USDA NASS QuickStat with <code>tidyUSDA</code>
</h2>
<p>There are several packages available to download data from the USDA NASS QuickStat. In this example, we will use the <a href="https://github.com/bradlindblad/tidyUSDA">tidyUSDA package</a> <span class="citation" data-cites="tidyUSDA">(<a href="#ref-tidyUSDA" role="doc-biblioref">Lindblad 2020</a>)</span>. A great feature of tidyUSDA is that it allows you to download data as an <code>sf</code> object, which means you can immediately visualize or spatially interact with other spatial data.</p>
<p>The first step is to obtain an API key from the this <a href="https://quickstats.nass.usda.gov/api">website</a>, as you will need it to download data.</p>
<p>To download data, use the <code><a href="https://bradlindblad.github.io/tidyusda/reference/getQuickstat.html">tidyUSDA::getQuickstat()</a></code> function. There are numerous options to narrow the scope of the data, such as <code>data_item</code>, <code>geographic_level</code>, <code>year</code>, <code>commodity</code>, and more. You can refer to the <a href="https://cran.r-project.org/web/packages/tidyUSDA/tidyUSDA.pdf">package manual</a> for a complete list of available parameters.</p>
<p>As an example, the code below downloads corn-related data by county in Illinois for the year 2016 as an sf object:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">IL_corn_yield</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">getQuickstat</span><span class="op">(</span></span>
<span>      <span class="co">#--- put your API key in place of key_get("usda_nass_qs_api") ---#</span></span>
<span>      key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,</span>
<span>      program <span class="op">=</span> <span class="st">"SURVEY"</span>,</span>
<span>      commodity <span class="op">=</span> <span class="st">"CORN"</span>,</span>
<span>      geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,</span>
<span>      state <span class="op">=</span> <span class="st">"ILLINOIS"</span>,</span>
<span>      year <span class="op">=</span> <span class="st">"2016"</span>,</span>
<span>      geometry <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- keep only some of the variables ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>      <span class="va">year</span>, <span class="va">county_name</span>, <span class="va">county_code</span>, <span class="va">state_name</span>,</span>
<span>      <span class="va">state_fips_code</span>, <span class="va">short_desc</span>, <span class="va">Value</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 384 features and 7 fields (with 16 geometries empty)
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -91.51308 ymin: 36.9703 xmax: -87.01993 ymax: 42.50848
Geodetic CRS:  NAD83
First 10 features:
   year county_name county_code state_name state_fips_code           short_desc
1  2016      BUREAU         011   ILLINOIS              17 CORN - ACRES PLANTED
2  2016     CARROLL         015   ILLINOIS              17 CORN - ACRES PLANTED
3  2016       HENRY         073   ILLINOIS              17 CORN - ACRES PLANTED
4  2016  JO DAVIESS         085   ILLINOIS              17 CORN - ACRES PLANTED
5  2016         LEE         103   ILLINOIS              17 CORN - ACRES PLANTED
6  2016      MERCER         131   ILLINOIS              17 CORN - ACRES PLANTED
7  2016        OGLE         141   ILLINOIS              17 CORN - ACRES PLANTED
8  2016      PUTNAM         155   ILLINOIS              17 CORN - ACRES PLANTED
9  2016 ROCK ISLAND         161   ILLINOIS              17 CORN - ACRES PLANTED
10 2016  STEPHENSON         177   ILLINOIS              17 CORN - ACRES PLANTED
    Value                       geometry
1  273500 MULTIPOLYGON (((-89.85691 4...
2  147500 MULTIPOLYGON (((-90.16133 4...
3  235000 MULTIPOLYGON (((-90.43247 4...
4  100500 MULTIPOLYGON (((-90.50668 4...
5  258500 MULTIPOLYGON (((-89.63118 4...
6  142500 MULTIPOLYGON (((-90.99255 4...
7  228000 MULTIPOLYGON (((-89.68598 4...
8   37200 MULTIPOLYGON (((-89.33303 4...
9   65000 MULTIPOLYGON (((-90.33573 4...
10 179500 MULTIPOLYGON (((-89.92577 4...</code></pre>
</div>
</div>
<p>As you can see, the result is an sf object with a geometry column, thanks to the <code>geometry = TRUE</code> option. This allows you to immediately create a map with the data (<a href="#fig-corn-yield-IL" class="quarto-xref">Figure&nbsp;<span>8.1</span></a>).</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">IL_corn_yield</span>, <span class="va">short_desc</span> <span class="op">==</span> <span class="st">"CORN, GRAIN - YIELD, MEASURED IN BU / ACRE"</span><span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Value</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-corn-yield-IL" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-corn-yield-IL-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-corn-yield-IL-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-corn-yield-IL-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.1: Corn Yield (bu/acre) in Illinois in 2016
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>You can also download data for multiple states and years simultaneously, as shown in the example below. If you want data for the entire U.S., simply omit the state parameter.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">IL_CO_NE_corn</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">getQuickstat</span><span class="op">(</span></span>
<span>      key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,</span>
<span>      program <span class="op">=</span> <span class="st">"SURVEY"</span>,</span>
<span>      commodity <span class="op">=</span> <span class="st">"CORN"</span>,</span>
<span>      geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,</span>
<span>      state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ILLINOIS"</span>, <span class="st">"COLORADO"</span>, <span class="st">"NEBRASKA"</span><span class="op">)</span>,</span>
<span>      year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fl">2014</span><span class="op">:</span><span class="fl">2018</span><span class="op">)</span>,</span>
<span>      geometry <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- keep only some of the variables ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>      <span class="va">year</span>, <span class="va">county_name</span>, <span class="va">county_code</span>, <span class="va">state_name</span>,</span>
<span>      <span class="va">state_fips_code</span>, <span class="va">short_desc</span>, <span class="va">Value</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6384 features and 7 fields (with 588 geometries empty)
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -109.0459 ymin: 36.9703 xmax: -87.01993 ymax: 43.00171
Geodetic CRS:  NAD83
First 10 features:
   year               county_name county_code state_name state_fips_code
1  2018 OTHER (COMBINED) COUNTIES         998   COLORADO              08
2  2017 OTHER (COMBINED) COUNTIES         998   COLORADO              08
3  2016 OTHER (COMBINED) COUNTIES         998   COLORADO              08
4  2015 OTHER (COMBINED) COUNTIES         998   COLORADO              08
5  2014 OTHER (COMBINED) COUNTIES         998   COLORADO              08
6  2017                   BOULDER         013   COLORADO              08
7  2016                   BOULDER         013   COLORADO              08
8  2016                   LARIMER         069   COLORADO              08
9  2015                   LARIMER         069   COLORADO              08
10 2014                   LARIMER         069   COLORADO              08
             short_desc  Value                       geometry
1  CORN - ACRES PLANTED 107600             MULTIPOLYGON EMPTY
2  CORN - ACRES PLANTED 108900             MULTIPOLYGON EMPTY
3  CORN - ACRES PLANTED 163600             MULTIPOLYGON EMPTY
4  CORN - ACRES PLANTED   3100             MULTIPOLYGON EMPTY
5  CORN - ACRES PLANTED   5200             MULTIPOLYGON EMPTY
6  CORN - ACRES PLANTED   3000 MULTIPOLYGON (((-105.6486 4...
7  CORN - ACRES PLANTED   3300 MULTIPOLYGON (((-105.6486 4...
8  CORN - ACRES PLANTED  12800 MULTIPOLYGON (((-105.8225 4...
9  CORN - ACRES PLANTED  14900 MULTIPOLYGON (((-105.8225 4...
10 CORN - ACRES PLANTED  13600 MULTIPOLYGON (((-105.8225 4...</code></pre>
</div>
</div>
<section id="look-for-parameter-values" class="level3 page-columns page-full" data-number="8.1.1"><h3 data-number="8.1.1" class="anchored" data-anchor-id="look-for-parameter-values">
<span class="header-section-number">8.1.1</span> Look for parameter values</h3>
<p>This package includes a function that allows you to view all possible parameter values for many of the parameters. For instance, if you know you want data on irrigated corn yields in Colorado but are unsure of the exact string to provide for the <code>data_item</code> parameter, you can do the following:<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Alternatively, you can visit the QuickStat website to find the correct text values.</p></div></div><div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get all the possible values for data_item ---#</span></span>
<span><span class="va">all_items</span> <span class="op">&lt;-</span> <span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allDataItem.html">allDataItem</a></span></span>
<span></span>
<span><span class="co">#--- take a look at the first six ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_items</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                           short_desc1 
                                                                     "AG LAND - ACRES" 
                                                                           short_desc2 
                                                      "AG LAND - NUMBER OF OPERATIONS" 
                                                                           short_desc3 
                                                   "AG LAND - OPERATIONS WITH TREATED" 
                                                                           short_desc4 
                                                "AG LAND - TREATED, MEASURED IN ACRES" 
                                                                           short_desc5 
                           "AG LAND, (EXCL CROPLAND &amp; PASTURELAND &amp; WOODLAND) - ACRES" 
                                                                           short_desc6 
"AG LAND, (EXCL CROPLAND &amp; PASTURELAND &amp; WOODLAND) - AREA, MEASURED IN PCT OF AG LAND" </code></pre>
</div>
</div>
<p>You can use key words like “CORN”, “YIELD”, “IRRIGATED” to narrow the entire list using <code><a href="https://rdrr.io/r/base/grep.html">grep()</a></code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>:</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;<code><a href="https://rdrr.io/r/base/grep.html">grep()</a></code> is part of the base package, so no additional package install is needed.</p></div></div><div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_items</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"CORN"</span>, <span class="va">.</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"YIELD"</span>, <span class="va">.</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"IRRIGATED"</span>, <span class="va">.</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                          short_desc9227 
                 "CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9228 
     "CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / NET PLANTED ACRE" 
                                                          short_desc9233 
    "CORN, GRAIN, IRRIGATED, ENTIRE CROP - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9236 
   "CORN, GRAIN, IRRIGATED, NONE OF CROP - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9238 
   "CORN, GRAIN, IRRIGATED, PART OF CROP - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9249 
             "CORN, GRAIN, NON-IRRIGATED - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9250 
 "CORN, GRAIN, NON-IRRIGATED - YIELD, MEASURED IN BU / NET PLANTED ACRE" 
                                                          short_desc9291 
              "CORN, SILAGE, IRRIGATED - YIELD, MEASURED IN TONS / ACRE" 
                                                          short_desc9296 
 "CORN, SILAGE, IRRIGATED, ENTIRE CROP - YIELD, MEASURED IN TONS / ACRE" 
                                                          short_desc9299 
"CORN, SILAGE, IRRIGATED, NONE OF CROP - YIELD, MEASURED IN TONS / ACRE" 
                                                          short_desc9301 
"CORN, SILAGE, IRRIGATED, PART OF CROP - YIELD, MEASURED IN TONS / ACRE" 
                                                          short_desc9307 
          "CORN, SILAGE, NON-IRRIGATED - YIELD, MEASURED IN TONS / ACRE" 
                                                         short_desc28557 
                 "SWEET CORN, IRRIGATED - YIELD, MEASURED IN CWT / ACRE" 
                                                         short_desc28564 
             "SWEET CORN, NON-IRRIGATED - YIELD, MEASURED IN CWT / ACRE" </code></pre>
</div>
</div>
<p>Looking at the list, we know the exact text value we want, which is the first entry of the vector.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">CO_ir_corn_yield</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">getQuickstat</span><span class="op">(</span></span>
<span>      key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,</span>
<span>      program <span class="op">=</span> <span class="st">"SURVEY"</span>,</span>
<span>      data_item <span class="op">=</span> <span class="st">"CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE"</span>,</span>
<span>      geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,</span>
<span>      state <span class="op">=</span> <span class="st">"COLORADO"</span>,</span>
<span>      year <span class="op">=</span> <span class="st">"2018"</span>,</span>
<span>      geometry <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- keep only some of the variables ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">NAME</span>, <span class="va">county_code</span>, <span class="va">short_desc</span>, <span class="va">Value</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is the complete list of functions that provide the possible values for the parameters used in <code>getQuickstat()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allCategory.html">allCategory</a></span></span>
<span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allSector.html">allSector</a></span></span>
<span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allGroup.html">allGroup</a></span></span>
<span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allCommodity.html">allCommodity</a></span></span>
<span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allDomain.html">allDomain</a></span></span>
<span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allCounty.html">allCounty</a></span></span>
<span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allProgram.html">allProgram</a></span></span>
<span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allDataItem.html">allDataItem</a></span></span>
<span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allState.html">allState</a></span></span>
<span><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allGeogLevel.html">allGeogLevel</a></span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="caveats" class="level3" data-number="8.1.2"><h3 data-number="8.1.2" class="anchored" data-anchor-id="caveats">
<span class="header-section-number">8.1.2</span> Caveats</h3>
<p>You cannot retrieve more than <span class="math inline">\(50,000\)</span> rows of data (this limit is set by QuickStat). The query below requests far more than <span class="math inline">\(50,000\)</span> observations, and therefore, will fail. In such cases, you need to narrow your search and break the task into smaller, manageable queries.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- this results in an error ---#</span></span>
<span><span class="va">many_states_corn</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">getQuickstat</span><span class="op">(</span></span>
<span>    key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,</span>
<span>    program <span class="op">=</span> <span class="st">"SURVEY"</span>,</span>
<span>    commodity <span class="op">=</span> <span class="st">"CORN"</span>,</span>
<span>    geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,</span>
<span>    state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ILLINOIS"</span>, <span class="st">"COLORADO"</span>, <span class="st">"NEBRASKA"</span>, <span class="st">"IOWA"</span>, <span class="st">"KANSAS"</span><span class="op">)</span>,</span>
<span>    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fl">1995</span><span class="op">:</span><span class="fl">2018</span><span class="op">)</span>,</span>
<span>    geometry <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: API did not return results. First verify that your input parameters work on the NASS
    website: https://quickstats.nass.usda.gov/. If correct, try again in a few minutes; the API may
    be experiencing heavy traffic.</code></pre>
</div>
</div>
<p>Another caveat is that a query will return an error if no observations meet your query criteria. For example, even though “CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE” is a valid value for data_item, there are no entries for this statistic in Illinois in 2018. As a result, the following query will fail.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">many_states_corn</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">getQuickstat</span><span class="op">(</span></span>
<span>    key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,</span>
<span>    program <span class="op">=</span> <span class="st">"SURVEY"</span>,</span>
<span>    data_item <span class="op">=</span> <span class="st">"CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE"</span>,</span>
<span>    geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,</span>
<span>    state <span class="op">=</span> <span class="st">"ILLINOIS"</span>,</span>
<span>    year <span class="op">=</span> <span class="st">"2018"</span>,</span>
<span>    geometry <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: API did not return results. First verify that your input parameters work on the NASS
    website: https://quickstats.nass.usda.gov/. If correct, try again in a few minutes; the API may
    be experiencing heavy traffic.</code></pre>
</div>
</div>
<!-- 
#/*=================================================*/
#' # CDL
#/*=================================================*/
-->
</section></section><section id="sec-CropScapeR" class="level2 page-columns page-full" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="sec-CropScapeR">
<span class="header-section-number">8.2</span> CDL with <code>CropScapeR</code>
</h2>
<p>The Cropland Data Layer (CDL) is a data product produced by the National Agricultural Statistics Service (NASS) of the U.S. Department of Agriculture. The CDL provides geo-referenced, high-accuracy crop-specific land cover information at 30-meter resolution (since 2007) or 56-meter resolution (in 2006 and 2007) for up to 48 contiguous U.S. states, covering data from 1997 to the present. This dataset has been widely used in agricultural research. <a href="https://nassgeodata.gmu.edu/CropScape/">CropScape</a> is an interactive web-based system for exploring CDL data. It was developed to query, visualize, disseminate, and analyze CDL data geospatially using standard geospatial web services, all within a publicly accessible online environment (Han et al., 2012).</p>
<p>This section demonstrates how to use the <code>CropScapeR</code> package <span class="citation" data-cites="cropscaper">(<a href="#ref-cropscaper" role="doc-biblioref">Chen 2020</a>)</span> to download and explore CDL data. The package implements some of the most useful geospatial processing services provided by CropScape, allowing users to efficiently process CDL data within the R environment. The <code>CropScapeR</code> package provides four key functions that implement different geospatial processing services offered by CropScape. This section introduces these functions with examples. The <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">CropScapeR::GetCDLData()</a></code> function is particularly important, as it enables users to download raw CDL data. The other functions allow users to obtain CDL data that is summarized or transformed in specific ways to meet various needs.</p>
<section id="cropscapergetcdldata-download-the-cdl-data-as-raster-data" class="level3 page-columns page-full" data-number="8.2.1"><h3 data-number="8.2.1" class="anchored" data-anchor-id="cropscapergetcdldata-download-the-cdl-data-as-raster-data">
<span class="header-section-number">8.2.1</span> <code>CropScapeR::GetCDLData</code>: Download the CDL data as raster data</h3>
<p>The function <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">CropScapeR::GetCDLData()</a></code> allows us to obtain CDL data for any Area of Interest (AOI) for a given year. It requires three parameters to make a valid data request:</p>
<ul>
<li>
<code>aoi</code>: The Area of Interest.</li>
<li>`year: The year for which the data is requested.</li>
<li>
<code>type</code>: The type of AOI.</li>
</ul>
<p>The following AOI-type combinations are accepted:</p>
<ul>
<li>any spatial object as an <code>sf</code> or <code>sfc</code> object: <code>type = "b"</code>
</li>
<li>county (defined by a 5-digit county FIPS code): <code>type = "f"</code>
</li>
<li>state (defined by a 2-digit state FIPS code): <code>type = "f"</code>
</li>
<li>bounding box (defined by four corner points): <code>type = "b"</code>
</li>
<li>polygon area (defined by at least three coordinates): <code>type = "ps"</code>
</li>
<li>single point (defined by a coordinate): <code>type = "p"</code>
</li>
</ul>
<p>This section discusses how to download data for an <code>sf</code> object, county, and state as they are likely to be the most common AOI. See its <a href="https://github.com/cbw1243/CropScapeR">Github repository</a> to see how the other options work.</p>
<section id="downloading-cdl-data-for-sf-county-and-state" class="level4 page-columns page-full" data-number="8.2.1.1"><h4 data-number="8.2.1.1" class="anchored" data-anchor-id="downloading-cdl-data-for-sf-county-and-state">
<span class="header-section-number">8.2.1.1</span> Downloading CDL data for <code>sf</code>, county, and state</h4>
<p><strong>Downloading CDL data for <code>sf</code></strong></p>
<p>Let’s download the 2018 CDL data for the area covering Champaign, Vermilion, Ford, and Iroquois counties in Illinois (<a href="#fig-IL4-map" class="quarto-xref">Figure&nbsp;<span>8.2</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the sf for all the counties in Illinois ---#</span></span>
<span><span class="va">IL_county</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"IL"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- get the four counties  ---#</span></span>
<span><span class="va">IL_county_4</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">IL_county</span>, <span class="va">NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Champaign"</span>, <span class="st">"Vermilion"</span>, <span class="st">"Ford"</span>, <span class="st">"Iroquois"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">IL_county</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">IL_county_4</span>, fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-IL4-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-IL4-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-IL4-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-IL4-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.2: Location of the four counties in Illinois
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>When using an <code>sf</code> object for <code>aoi</code>, the CDL data will be downloaded for the bounding box (hence <code>type = "b"</code>) that encompasses the entire geographic area of the <code>sf</code> object, regardless of the type of objects within it (whether they are points, polygons, or lines). In this case, the CDL data is downloaded for the red area shown in <a href="#fig-aoi-sf" class="quarto-xref">Figure&nbsp;<span>8.3</span></a>.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">IL_county</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_as_sfc</span><span class="op">(</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">IL_county_4</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-aoi-sf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-aoi-sf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-aoi-sf-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-aoi-sf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.3: Bounding box of the four counties
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Let’s now download CDL data for the four counties:</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">cdl_IL_4</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span></span>
<span>      aoi <span class="op">=</span> <span class="va">IL_county_4</span>,</span>
<span>      year <span class="op">=</span> <span class="st">"2018"</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>class      : RasterLayer 
dimensions : 4431, 2826, 12522006  (nrow, ncol, ncell)
resolution : 30, 30  (x, y)
extent     : 631935, 716715, 1898745, 2031675  (xmin, xmax, ymin, ymax)
crs        : +proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs 
source     : IL4.tif 
names      : Layer_1 </code></pre>
</div>
</div>
<p>As you can see, the downloaded data is a <code>RasterLayer</code> object<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. You might want to convert it to <code>SpatRaster</code> if you are more familiar with the <code>terra</code> package (<a href="#fig-il-4-cdl" class="quarto-xref">Figure&nbsp;<span>8.4</span></a> presents the map).</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;an object class defined by the <code>raster</code> package. See <a href="04-RasterDataBasics.html" class="quarto-xref"><span>Chapter 4</span></a>.</p></div></div><div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cdl_IL_4</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">cdl_IL_4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cdl_IL_4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-il-4-cdl" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-il-4-cdl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-il-4-cdl-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-il-4-cdl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.4: Map of CDL values
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Note that the CDL data uses the Albers equal-area conic projection.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="va">cdl_IL_4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PROJCRS[\"unknown\",\n    BASEGEOGCRS[\"unknown\",\n        DATUM[\"North American Datum 1983\",\n            ELLIPSOID[\"GRS 1980\",6378137,298.257222101,\n                LENGTHUNIT[\"metre\",1]],\n            ID[\"EPSG\",6269]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8901]]],\n    CONVERSION[\"unknown\",\n        METHOD[\"Albers Equal Area\",\n            ID[\"EPSG\",9822]],\n        PARAMETER[\"Latitude of false origin\",23,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8821]],\n        PARAMETER[\"Longitude of false origin\",-96,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8822]],\n        PARAMETER[\"Latitude of 1st standard parallel\",29.5,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8823]],\n        PARAMETER[\"Latitude of 2nd standard parallel\",45.5,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8824]],\n        PARAMETER[\"Easting at false origin\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8826]],\n        PARAMETER[\"Northing at false origin\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8827]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1,\n                ID[\"EPSG\",9001]]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1,\n                ID[\"EPSG\",9001]]]]"</code></pre>
</div>
</div>
<hr>
<p><strong>Downloading CDL data for county</strong></p>
<p>The following code requests to download the CDL data for Champaign County, Illinois, for the year 2018 (<a href="#fig-cdl-champaign" class="quarto-xref">Figure&nbsp;<span>8.5</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">cdl_Champaign</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17019</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">"f"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 2060, 1626, 1  (nrow, ncol, nlyr)
resolution  : 30, 30  (x, y)
extent      : 633825, 682605, 1898745, 1960545  (xmin, xmax, ymin, ymax)
coord. ref. : +proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs 
source      : ch.tif 
color table : 1 
name        : Layer_1 </code></pre>
</div>
</div>
<p>In the above code, the FIPS code for Champaign County (17019) was supplied to the <code>aoi</code> option. Because a county is used here, the <code>type</code> argument is specified as <code>"f"</code>.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cdl_Champaign</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cdl-champaign" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cdl-champaign-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-cdl-champaign-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cdl-champaign-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.5: CDL values for Champaign County in Illinois
</figcaption></figure>
</div>
</div>
</div>
</div></div><hr>
<p><strong>Downloading CDL data for state</strong></p>
<p>The following code makes a request to download the CDL data for the state of Illinois in the year 2018 (<a href="#fig-cdl-illinois" class="quarto-xref">Figure&nbsp;<span>8.6</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">cdl_IL</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">"f"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cdl_IL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cdl-illinois" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cdl-illinois-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-cdl-illinois-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cdl-illinois-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.6: CDL values for Illinois
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>In the above code, the state FIPS code for Illinois (<span class="math inline">\(17\)</span>) was supplied to the <code>aoi</code> option. Because a county is used here, the <code>type</code> argument is specified as <code>"f"</code>.</p>
</section><section id="other-format-options" class="level4" data-number="8.2.1.2"><h4 data-number="8.2.1.2" class="anchored" data-anchor-id="other-format-options">
<span class="header-section-number">8.2.1.2</span> Other format options</h4>
<p><strong>GeoTiff</strong></p>
<p>You can save the downloaded CDL data as a tif file by adding <code>save_path =</code> option to <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">CropScapeR::GetCDLData()</a></code> as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">cdl_IL_4</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span></span>
<span>      aoi <span class="op">=</span> <span class="va">IL_county_4</span>,</span>
<span>      year <span class="op">=</span> <span class="st">"2018"</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>      save_path <span class="op">=</span> <span class="st">"Data/IL_4.tif"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With this code, the downloaded data will be saved as “IL_4.tif” in the “Data” folder located in the current working directory.</p>
<hr>
<p><strong>sf</strong></p>
<p>The <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">CropScapeR::GetCDLData()</a></code> function lets you download CDL data as an <code>sf</code> of points, where the coordinates of the points are the coordinates of the centroid of the raster cells. This can be done by adding <code>format = sf</code> as an option.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">cdl_sf</span> <span class="op">&lt;-</span> <span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17019</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">"f"</span>, format <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first column (<code>value</code>) is the crop code. Of course, you can manually convert a RasterLayer to an <code>sf</code> of points as follows:</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is very unlikely that you need to have raster data as <code>sf</code> rather then <code>RasterLayer</code> or <code>SpatRaster</code>.</p>
</div>
</div>
</section></section><section id="data-processing-after-downloading-data" class="level3" data-number="8.2.2"><h3 data-number="8.2.2" class="anchored" data-anchor-id="data-processing-after-downloading-data">
<span class="header-section-number">8.2.2</span> Data processing after downloading data</h3>
<p>The downloaded raster data is not immediately ready for analysis. Typically, the variable of interest is the frequency of land use types or their shares. You can use <code><a href="https://rspatial.github.io/terra/reference/freq.html">terra::freq()</a></code> to obtain the frequency (i.e., the number of raster cells) for each land use type.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">crop_freq</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/freq.html">freq</a></span><span class="op">(</span><span class="va">cdl_Champaign</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   layer value   count
1      1     0  476477
2      1     1 1211343
3      1     4      15
4      1     5 1173150
5      1    23       8
6      1    24    8869
7      1    26    1168
8      1    27      34
9      1    28      52
10     1    36    4418
11     1    37    6804
12     1    43       2
13     1    59    1064
14     1    60      79
15     1    61      54
16     1   111    6112
17     1   121  111191
18     1   122  155744
19     1   123   38898
20     1   124   12232
21     1   131    1333
22     1   141   49012
23     1   142      15
24     1   143       7
25     1   152      77
26     1   176   84463
27     1   190    6545
28     1   195     339
29     1   222       1
30     1   229      16
31     1   241      38</code></pre>
</div>
</div>
<p>Clearly, once frequencies are found, you can easily get shares as well:</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">crop_data</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">crop_freq</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- matrix to data.frame ---#</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- find share ---#</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>share <span class="op">=</span> <span class="va">count</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   layer value   count        share
1      1     0  476477 1.422506e-01
2      1     1 1211343 3.616424e-01
3      1     4      15 4.478200e-06
4      1     5 1173150 3.502400e-01
5      1    23       8 2.388373e-06
6      1    24    8869 2.647810e-03
7      1    26    1168 3.487025e-04
8      1    27      34 1.015059e-05
9      1    28      52 1.552443e-05
10     1    36    4418 1.318979e-03
11     1    37    6804 2.031312e-03
12     1    43       2 5.970933e-07
13     1    59    1064 3.176537e-04
14     1    60      79 2.358519e-05
15     1    61      54 1.612152e-05
16     1   111    6112 1.824717e-03
17     1   121  111191 3.319570e-02
18     1   122  155744 4.649685e-02
19     1   123   38898 1.161287e-02
20     1   124   12232 3.651823e-03
21     1   131    1333 3.979627e-04
22     1   141   49012 1.463237e-02
23     1   142      15 4.478200e-06
24     1   143       7 2.089827e-06
25     1   152      77 2.298809e-05
26     1   176   84463 2.521615e-02
27     1   190    6545 1.953988e-03
28     1   195     339 1.012073e-04
29     1   222       1 2.985467e-07
30     1   229      16 4.776747e-06
31     1   241      38 1.134477e-05</code></pre>
</div>
</div>
<p>At this point, the data does not indicate which value corresponds to which crop. To find the crop names associated with the crop codes (value), you can use the reference table provided by the <code>CropScapeR</code> package with <code>data(linkdata)</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- load the crop code reference data ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"linkdata"</span>, package <span class="op">=</span> <span class="st">"CropScapeR"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">linkdata</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   MasterCat     Crop
       &lt;int&gt;   &lt;char&gt;
1:         0   NoData
2:         1     Corn
3:         2   Cotton
4:         3     Rice
5:         4  Sorghum
6:         5 Soybeans</code></pre>
</div>
</div>
<p>You can merge the two data sets using <code>value</code> from the CDL data and <code>MasterCat</code> from <code>linkdata</code> as the merging keys:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">crop_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">crop_data</span>, <span class="va">linkdata</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"value"</span> <span class="op">=</span> <span class="st">"MasterCat"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   layer value   count        share                     Crop
1      1     0  476477 1.422506e-01                   NoData
2      1     1 1211343 3.616424e-01                     Corn
3      1     4      15 4.478200e-06                  Sorghum
4      1     5 1173150 3.502400e-01                 Soybeans
5      1    23       8 2.388373e-06             Spring_Wheat
6      1    24    8869 2.647810e-03             Winter_Wheat
7      1    26    1168 3.487025e-04 Dbl_Crop_WinWht/Soybeans
8      1    27      34 1.015059e-05                      Rye
9      1    28      52 1.552443e-05                     Oats
10     1    36    4418 1.318979e-03                  Alfalfa
11     1    37    6804 2.031312e-03    Other_Hay/Non_Alfalfa
12     1    43       2 5.970933e-07                 Potatoes
13     1    59    1064 3.176537e-04           Sod/Grass_Seed
14     1    60      79 2.358519e-05              Switchgrass
15     1    61      54 1.612152e-05     Fallow/Idle_Cropland
16     1   111    6112 1.824717e-03               Open_Water
17     1   121  111191 3.319570e-02     Developed/Open_Space
18     1   122  155744 4.649685e-02  Developed/Low_Intensity
19     1   123   38898 1.161287e-02  Developed/Med_Intensity
20     1   124   12232 3.651823e-03 Developed/High_Intensity
21     1   131    1333 3.979627e-04                   Barren
22     1   141   49012 1.463237e-02         Deciduous_Forest
23     1   142      15 4.478200e-06         Evergreen_Forest
24     1   143       7 2.089827e-06             Mixed_Forest
25     1   152      77 2.298809e-05                Shrubland
26     1   176   84463 2.521615e-02        Grassland/Pasture
27     1   190    6545 1.953988e-03           Woody_Wetlands
28     1   195     339 1.012073e-04      Herbaceous_Wetlands
29     1   222       1 2.985467e-07                   Squash
30     1   229      16 4.776747e-06                 Pumpkins
31     1   241      38 1.134477e-05   Dbl_Crop_Corn/Soybeans</code></pre>
</div>
</div>
<p>The <code>NoData</code> in the <code>Crop</code> column corresponds to the black areas in the figure above, representing portions of the raster data that do not overlap with the boundary of Champaign County. You can remove these points with <code>NoData</code> by using the <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter</a></code> function.</p>
</section><section id="other-forms-of-cdl-data" class="level3" data-number="8.2.3"><h3 data-number="8.2.3" class="anchored" data-anchor-id="other-forms-of-cdl-data">
<span class="header-section-number">8.2.3</span> Other forms of CDL data</h3>
<p>Instead of downloading the raw CDL data, CropScape provides an option to download summarized CDL data.</p>
<ul>
<li>
<code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">CropScapeR::GetCDLComp()</a></code>: request data on land use changes</li>
<li>
<code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLStat.html">CropScapeR::GetCDLStat()</a></code>: get acreage estimates from the CDL</li>
<li>
<code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLImage.html">CropScapeR::GetCDLImage()</a></code>: download the image files of the CDL data</li>
</ul>
<p>These may come handy if they satisfy your needs because you can skip post-downloading processing steps.</p>
<hr>
<p><strong><code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">CropScapeR::GetCDLComp()</a></code></strong>: request data on land use changes</p>
<p>The <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">CropScapeR::GetCDLComp()</a></code> function allows users to request data on land cover changes over time from the CDL. Specifically, this function returns the acreage that has changed from one crop category to another between two years for a user-defined AOI.</p>
<p>Let’s look at an example. The following code requests data on acreage changes in land cover for Champaign County (<code>FIPS = 17019</code>) from 2017 (<code>year1 = 2017</code>) to 2018 (<code>year2 = 2018</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">data_change</span> <span class="op">&lt;-</span> <span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">GetCDLComp</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="st">"17019"</span>, year1 <span class="op">=</span> <span class="fl">2017</span>, year2 <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">"f"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     From                       To   Count  Acreage    aoi
                   &lt;char&gt;                   &lt;char&gt;   &lt;int&gt;    &lt;num&gt; &lt;char&gt;
  1:                 Corn                     Corn  181490  40362.4  17019
  2:                 Corn                  Sorghum       1      0.2  17019
  3:                 Corn                 Soybeans 1081442 240506.9  17019
  4:                 Corn             Winter Wheat    1950    433.7  17019
  5:                 Corn Dbl Crop WinWht/Soybeans     110     24.5  17019
 ---                                                                      
241:  Herbaceous Wetlands      Herbaceous Wetlands      18      4.0  17019
242: Dbl Crop WinWht/Corn                     Corn       1      0.2  17019
243:             Pumpkins                     Corn      69     15.3  17019
244:             Pumpkins                  Sorghum       2      0.4  17019
245:             Pumpkins                 Soybeans      62     13.8  17019</code></pre>
</div>
</div>
<p>The result is a <code>data.frame</code> (or <code>data.table</code>) with five columns. The <code>From</code> and <code>To</code> columns represent the crop names, <code>Count</code> indicates the pixel count, and <code>Acreage</code> provides the corresponding acreage for those pixel counts. The last column, <code>aoi</code>, refers to the selected Area of Interest (AOI). For example, the first row of the returned data shows 40,362 acres of continuous corn during 2017 and 2018, while the third row shows 240,506 acres rotated from corn to soybeans over the same period.</p>
<p>Keep in mind that the spatial resolution of the CDL changes from 56 meters to 30 meters starting in 2008. This means that when you request land-use changes from 2007 to 2008, the two CDL raster layers have different spatial resolutions. As a result, the CropScape API cannot resolve this issue and will return an error message such as “Mismatch size of file 1 and file 2.”</p>
<p>The <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">CropScapeR::GetCDLComp()</a></code> function automatically addresses this problem by resampling the two CDL raster files using the nearest-neighbor resampling technique so that both rasters have the same spatial resolution. The finer-resolution raster is downscaled to match the lower resolution. The resampled raster layers are then merged to calculate cropland changes. Users can disable this default behavior by setting <code>manual_try = FALSE</code>, in which case an error message from the CropScape API will be returned without land-use change results.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_change</span> <span class="op">&lt;-</span> <span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">GetCDLComp</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="st">"17019"</span>, year1 <span class="op">=</span> <span class="fl">2007</span>, year2 <span class="op">=</span> <span class="fl">2008</span>, type <span class="op">=</span> <span class="st">"f"</span>, `manual_try` <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in GetCDLCompF(fips = aoi, year1 = year1, year2 = year2, mat = mat, : Error: The requested data might not exist in the CDL database. 
Error message from CropScape is :&lt;faultstring&gt;Error: Mismatch size of file 1 and file 2.
&lt;/faultstring&gt;</code></pre>
</div>
</div>
<hr>
<p><strong><code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLStat.html">CropScapeR::GetCDLStat()</a></code></strong>: get acreage estimates from the CDL</p>
<p>The <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLStat.html">CropScapeR::GetCDLStat()</a></code> function allows users to retrieve acreage by land cover category for a user-defined Area of Interest (AOI) in a specific year. For example, the following code requests data on acreage by land cover categories for Champaign County, Illinois, in 2018. You’ll notice that the pixel counts are already converted to acres, and the corresponding category names are included.</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">data_stat</span> <span class="op">&lt;-</span> <span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLStat.html">GetCDLStat</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17019</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">"f"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>    Value                   Category  Acreage
    &lt;int&gt;                     &lt;char&gt;    &lt;num&gt;
 1:     1                       Corn 269396.2
 2:     4                    Sorghum      3.3
 3:     5                   Soybeans 260902.3
 4:    23               Spring Wheat      1.8
 5:    24               Winter Wheat   1972.4
 6:    26   Dbl Crop WinWht/Soybeans    259.8
 7:    27                        Rye      7.6
 8:    28                       Oats     11.6
 9:    36                    Alfalfa    982.5
10:    37      Other Hay/Non Alfalfa   1513.2
11:    43                   Potatoes      0.4
12:    59             Sod/Grass Seed    236.6
13:    60                Switchgrass     17.6
14:    61       Fallow/Idle Cropland     12.0
15:   111                 Open Water   1359.3
16:   121       Developed/Open Space  24728.3
17:   122    Developed/Low Intensity  34636.6
18:   123 Developed/Medium Intensity   8650.7
19:   124   Developed/High Intensity   2720.3
20:   131                     Barren    296.5
21:   141           Deciduous Forest  10900.0
22:   142           Evergreen Forest      3.3
23:   143               Mixed Forest      1.6
24:   152                  Shrubland     17.1
25:   176              Grass/Pasture  18784.1
26:   190             Woody Wetlands   1455.6
27:   195        Herbaceous Wetlands     75.4
28:   222                     Squash      0.2
29:   229                   Pumpkins      3.6
30:   241     Dbl Crop Corn/Soybeans      8.5
    Value                   Category  Acreage</code></pre>
</div>
</div>
<hr>
<p><strong><code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLImage.html">CropScapeR::GetCDLImage()</a></code></strong>: Download the image files of the CDL data</p>
<p>The <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLImage.html">CropScapeR::GetCDLImage</a></code> function allows users to download image files of CDL data. This function works similarly to <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">CropScapeR::GetCDLData</a></code>, except that it returns image files instead of data. It’s particularly useful if you only want to visualize the CDL data. By default, the image is saved in “png” format, but you can also save it in “kml” format if needed.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLImage.html">GetCDLImage</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17019</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">"f"</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-download-prism" class="level2 page-columns page-full" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="sec-download-prism">
<span class="header-section-number">8.3</span> PRISM with <code>prism</code>
</h2>
<section id="basics" class="level3 page-columns page-full" data-number="8.3.1"><h3 data-number="8.3.1" class="anchored" data-anchor-id="basics">
<span class="header-section-number">8.3.1</span> Basics</h3>
<p><a href="https://prism.oregonstate.edu/">PRISM dataset</a> provides model-based estimates of precipitation, maximum temperature (tmax), and minimum temperature (tmin) for the U.S. at a 4 km by 4 km spatial resolution. To download daily data, we can use the <code><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">prism::get_prism_dailys()</a></code> function from the prism package <span class="citation" data-cites="prism">(<a href="#ref-prism" role="doc-biblioref">Hart and Bell 2015</a>)</span>. Below is its general syntax:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- NOT RUN ---#</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>prism<span class="sc">::</span><span class="fu">get_prism_dailys</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> variable type,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">minDate =</span> starting date as character,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxDate =</span> ending date as character,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">keepZip =</span> <span class="cn">TRUE</span> or <span class="cn">FALSE</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The variables types you can select from is <code>"ppt"</code> (precipitation), <code>"tmean"</code> (mean temperature), <code>"tmin"</code> (minimum temperature), and <code>"tmax"</code> (maximum temperature). For <code>minDate</code> and <code>maxDate</code>, the dates must be specified in a specific format of “YYYY-MM-DD”. <code>keepZip = FALSE</code> does not keep the zipped folders of the downloaded files as the name suggests.</p>
<p>Before downloading PRISM data using the <code><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">prism::get_prism_dailys()</a></code> function, it’s recommended to set the path to the folder where the downloaded data will be stored using options(<code>prism.path = "path"</code>). For example, the following code sets the path to <code>"Data/PRISM/"</code> relative to the current working directory:</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>prism.path <span class="op">=</span> <span class="st">"Data/PRISM/"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following code downloads daily tmax data from January 1, 2000 to Jan 10, 2000.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">prism</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">get_prism_dailys</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>  minDate <span class="op">=</span> <span class="st">"2000-01-01"</span>,</span>
<span>  maxDate <span class="op">=</span> <span class="st">"2000-01-10"</span>,</span>
<span>  keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When you download data using the above code, you will notice that it creates one folder for one day. For example, for tmax data for “2000-01-01”, you can get the path to the downloaded file as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">var_type</span> <span class="op">&lt;-</span> <span class="st">"tmax"</span> <span class="co"># variable type</span></span>
<span><span class="va">dates_prism_txt</span> <span class="op">&lt;-</span> <span class="fu">str_remove_all</span><span class="op">(</span><span class="st">"2000-01-01"</span>, <span class="st">"-"</span><span class="op">)</span> <span class="co"># date without dashes</span></span>
<span></span>
<span><span class="co">#--- folder name ---#</span></span>
<span><span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- file name of the downloaded data inside the above folder ---#</span></span>
<span><span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil.bil"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- path to the file relative to the designated data folder (here, it's "Data/PRISM/") ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span>, <span class="st">"/"</span>, <span class="va">file_name</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Data/PRISM/PRISM_tmax_stable_4kmD2_20000101_bil/PRISM_tmax_stable_4kmD2_20000101_bil.bil"</code></pre>
</div>
</div>
<p>We can then easily read the data using <code><a href="https://rspatial.github.io/terra/reference/rast.html">terra::rast()</a></code> or <code><a href="https://r-spatial.github.io/stars/reference/read_stars.html">stars::read_stars()</a></code> if you prefer the <code>stars</code> way.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- as SpatRaster ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">prism_2000_01_01_sr</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 621, 1405, 1  (nrow, ncol, nlyr)
resolution  : 0.04166667, 0.04166667  (x, y)
extent      : -125.0208, -66.47917, 24.0625, 49.9375  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 
source      : PRISM_tmax_stable_4kmD2_20000101_bil.bil 
name        : PRISM_tmax_stable_4kmD2_20000101_bil 
min value   :                              -16.309 
max value   :                               29.073 </code></pre>
</div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- as stars ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">prism_2000_01_01_stars</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
                                   Min. 1st Qu. Median     Mean 3rd Qu.   Max.
PRISM_tmax_stable_4kmD2_200...  -16.309   4.095 10.075 10.20043  16.953 29.073
                                  NA's
PRISM_tmax_stable_4kmD2_200...  390874
dimension(s):
  from   to offset    delta refsys x/y
x    1 1405   -125  0.04167  NAD83 [x]
y    1  621  49.94 -0.04167  NAD83 [y]</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">prism_2000_01_01_sr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-quick-viz" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-quick-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-quick-viz-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-quick-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.7: PRISM tmax data for January 1, 2000
</figcaption></figure>
</div>
</div>
</div>
</div></div><p><a href="#fig-quick-viz" class="quarto-xref">Figure&nbsp;<span>8.7</span></a> presents a quick visualization of the data. As you can see, the dataset covers the entire contiguous U.S.</p>
</section><section id="download-daily-prism-data-for-many-years-and-build-your-own-datasets" class="level3" data-number="8.3.2"><h3 data-number="8.3.2" class="anchored" data-anchor-id="download-daily-prism-data-for-many-years-and-build-your-own-datasets">
<span class="header-section-number">8.3.2</span> Download daily PRISM data for many years and build your own datasets</h3>
<p>Here, we provide an example of how to create your own PRISM datasets. Building such datasets and storing them locally can be beneficial if you plan to use the data for multiple projects in the future.</p>
<p>Suppose we are interested in saving daily PRISM precipitation data by year and month, from 1980 to 2018. To accomplish this, we will write a loop that iterates over all year-month combinations. Before constructing the loop, let’s start by working with a specific year-month combination—December 1990.</p>
<p>We will write the code in a way that can be easily adapted for looped operations later. Specifically, we will define the following variables and use them as placeholders for the values that will be looped over.</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- month to work on ---#</span></span>
<span><span class="va">temp_month</span> <span class="op">&lt;-</span> <span class="fl">12</span></span>
<span></span>
<span><span class="co">#--- year to work on ---#</span></span>
<span><span class="va">temp_year</span> <span class="op">&lt;-</span> <span class="fl">1990</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We first need to set the path to the folder in which daily PRISM files will be downloaded.</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- set your own path ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>prism.path <span class="op">=</span> <span class="st">"Data/PRISM/"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then set the start and end dates for <code><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">prism::get_prism_dailys()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- starting date of the working month-year ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">dmy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"1/"</span>, <span class="va">temp_month</span>, <span class="st">"/"</span>, <span class="va">temp_year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1990-12-01"</code></pre>
</div>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- ending date: add a month and then go back 1 day ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">end_date</span> <span class="op">&lt;-</span> <span class="va">start_date</span> <span class="op">%m+%</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1990-12-31"</code></pre>
</div>
</div>
<p>We now download PRISM data for the year-month we are working on.</p>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- download daily PRISM data for the working month-year ---#</span></span>
<span><span class="fu">prism</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">get_prism_dailys</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"ppt"</span>,</span>
<span>  minDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">start_date</span><span class="op">)</span>,</span>
<span>  maxDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">end_date</span><span class="op">)</span>,</span>
<span>  keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once all the data are downloaded, we will read and import them onto R. To do so, we will need the path to all the downloaded files.</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- list of dates of the working month-year ---#</span></span>
<span><span class="va">dates_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, <span class="st">"days"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- remove dashes ---#</span></span>
<span><span class="va">dates_prism_txt</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">dates_ls</span>, <span class="st">"-"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- folder names ---#</span></span>
<span><span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- the file name of the downloaded data ---#</span></span>
<span><span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil.bil"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- complete path to the downloaded files ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span>, <span class="st">"/"</span>, <span class="va">file_name</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901201_bil/PRISM_tmax_stable_4kmD2_19901201_bil.bil"
 [2] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901202_bil/PRISM_tmax_stable_4kmD2_19901202_bil.bil"
 [3] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901203_bil/PRISM_tmax_stable_4kmD2_19901203_bil.bil"
 [4] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901204_bil/PRISM_tmax_stable_4kmD2_19901204_bil.bil"
 [5] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901205_bil/PRISM_tmax_stable_4kmD2_19901205_bil.bil"
 [6] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901206_bil/PRISM_tmax_stable_4kmD2_19901206_bil.bil"
 [7] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901207_bil/PRISM_tmax_stable_4kmD2_19901207_bil.bil"
 [8] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901208_bil/PRISM_tmax_stable_4kmD2_19901208_bil.bil"
 [9] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901209_bil/PRISM_tmax_stable_4kmD2_19901209_bil.bil"
[10] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901210_bil/PRISM_tmax_stable_4kmD2_19901210_bil.bil"
[11] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901211_bil/PRISM_tmax_stable_4kmD2_19901211_bil.bil"
[12] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901212_bil/PRISM_tmax_stable_4kmD2_19901212_bil.bil"
[13] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901213_bil/PRISM_tmax_stable_4kmD2_19901213_bil.bil"
[14] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901214_bil/PRISM_tmax_stable_4kmD2_19901214_bil.bil"
[15] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901215_bil/PRISM_tmax_stable_4kmD2_19901215_bil.bil"
[16] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901216_bil/PRISM_tmax_stable_4kmD2_19901216_bil.bil"
[17] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901217_bil/PRISM_tmax_stable_4kmD2_19901217_bil.bil"
[18] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901218_bil/PRISM_tmax_stable_4kmD2_19901218_bil.bil"
[19] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901219_bil/PRISM_tmax_stable_4kmD2_19901219_bil.bil"
[20] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901220_bil/PRISM_tmax_stable_4kmD2_19901220_bil.bil"
[21] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901221_bil/PRISM_tmax_stable_4kmD2_19901221_bil.bil"
[22] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901222_bil/PRISM_tmax_stable_4kmD2_19901222_bil.bil"
[23] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901223_bil/PRISM_tmax_stable_4kmD2_19901223_bil.bil"
[24] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901224_bil/PRISM_tmax_stable_4kmD2_19901224_bil.bil"
[25] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901225_bil/PRISM_tmax_stable_4kmD2_19901225_bil.bil"
[26] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901226_bil/PRISM_tmax_stable_4kmD2_19901226_bil.bil"
[27] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901227_bil/PRISM_tmax_stable_4kmD2_19901227_bil.bil"
[28] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901228_bil/PRISM_tmax_stable_4kmD2_19901228_bil.bil"
[29] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901229_bil/PRISM_tmax_stable_4kmD2_19901229_bil.bil"
[30] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901230_bil/PRISM_tmax_stable_4kmD2_19901230_bil.bil"
[31] "Data/PRISM/PRISM_tmax_stable_4kmD2_19901231_bil/PRISM_tmax_stable_4kmD2_19901231_bil.bil"</code></pre>
</div>
</div>
<p>Next, we read the data as a <code>stars</code> object, set the third dimension as the date using the <code>Date</code> object class, and then save it as an R dataset. This ensures that the date dimension is preserved (see <a href="06-stars.html#sec-read-write-stars" class="quarto-xref"><span>Section 6.4</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co">#--- combine all the PRISM files as stars ---#</span></span>
<span>  <span class="va">temp_stars</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_path</span>, along <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- set the third dimension as data ---#</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span><span class="st">"new_dim"</span>, values <span class="op">=</span> <span class="va">dates_ls</span>, name <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- save the stars as an rds file ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span></span>
<span>  <span class="va">temp_stars</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_y"</span>, <span class="va">temp_year</span>, <span class="st">"_m"</span>, <span class="va">temp_month</span>, <span class="st">".rds"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You could alternatively read the files into a <code>SpatRaster</code> object and save it data as a GeoTIFF file.</p>
<div class="cell">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co">#--- combine all the PRISM files as a SpatRaster ---#</span></span>
<span>  <span class="va">temp_stars</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- save as a multi-band GeoTIFF file ---#</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html">writeRaster</a></span><span class="op">(</span><span class="va">temp_stars</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_y"</span>, <span class="va">temp_year</span>, <span class="st">"_m"</span>, <span class="va">temp_month</span>, <span class="st">".tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that this option of course does not have date as the third dimension. Moreover, the RDS file above takes up only 14 Mb, while the tif file occupies 108 Mb.</p>
<p>Finally, if you would like, you can delete all the individual PRISM files:</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- delete all the downloaded files ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>Okay, now that we know what to do with a particular year-month combination, we can easily write a loop to go over all the year-month combinations for the period of interest. Since all the processes we observed above for a single year-month combination is embarrassingly parallel, it is easy to parallelize using <code><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future.apply::future_lapply()</a></code> or <code><a href="https://rdrr.io/r/parallel/mclapply.html">parallel::mclapply()</a></code> (Linux/Mac users only). Here we use <code>future_lapply()</code> (see <a href="A1-ParallelComputing.html" class="quarto-xref"><span>Appendix A</span></a> if you are not familiar with looping and parallel processing). Let’s first get the number of logical cores.</p>
<div class="cell">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">num_cores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="va">num_cores</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following function goes through all the steps we saw above for a single year-month combination.</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- define a function to download and save PRISM data stacked by month ---#</span></span>
<span><span class="va">get_save_prism</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">var_type</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">#++++++++++++++++++++++++++++++++++++</span></span>
<span>  <span class="co">#+ Debug</span></span>
<span>  <span class="co">#++++++++++++++++++++++++++++++++++++</span></span>
<span>  <span class="co"># i &lt;- 1</span></span>
<span>  <span class="co"># var_type &lt;- "ppt"</span></span>
<span></span>
<span>  <span class="co">#++++++++++++++++++++++++++++++++++++</span></span>
<span>  <span class="co">#+ Main</span></span>
<span>  <span class="co">#++++++++++++++++++++++++++++++++++++</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"working on "</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">temp_month</span> <span class="op">&lt;-</span> <span class="va">month_year_data</span><span class="op">[</span><span class="va">i</span>, <span class="va">month</span><span class="op">]</span> <span class="co"># working month</span></span>
<span>  <span class="va">temp_year</span> <span class="op">&lt;-</span> <span class="va">month_year_data</span><span class="op">[</span><span class="va">i</span>, <span class="va">year</span><span class="op">]</span> <span class="co"># working year</span></span>
<span></span>
<span>  <span class="co">#--- starting date of the working month-year ---#</span></span>
<span>  <span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">dmy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"1/"</span>, <span class="va">temp_month</span>, <span class="st">"/"</span>, <span class="va">temp_year</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#--- end date ---#</span></span>
<span>  <span class="va">end_date</span> <span class="op">&lt;-</span> <span class="va">start_date</span> <span class="op">%m+%</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span></span>
<span>  <span class="co">#--- download daily PRISM data for the working month-year ---#</span></span>
<span>  <span class="fu">prism</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">get_prism_dailys</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="va">var_type</span>,</span>
<span>    minDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">start_date</span><span class="op">)</span>,</span>
<span>    maxDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">end_date</span><span class="op">)</span>,</span>
<span>    keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- list of dates of the working month-year ---#</span></span>
<span>  <span class="va">dates_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, <span class="st">"days"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- remove dashes ---#</span></span>
<span>  <span class="va">dates_prism_txt</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">dates_ls</span>, <span class="st">"-"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- folder names ---#</span></span>
<span>  <span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil"</span><span class="op">)</span></span>
<span>  <span class="co">#--- the file name of the downloaded data ---#</span></span>
<span>  <span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil.bil"</span><span class="op">)</span></span>
<span>  <span class="co">#--- complete path to the downloaded files ---#</span></span>
<span>  <span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span>, <span class="st">"/"</span>, <span class="va">file_name</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- combine all the PRISM files as a SpatRaster ---#</span></span>
<span>  <span class="va">temp_stars</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- convert to stars ---#</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- set the third dimension as data ---#</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span><span class="st">"band"</span>, values <span class="op">=</span> <span class="va">dates_ls</span>, name <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- save the stars as an rds file ---#</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span></span>
<span>    <span class="va">temp_stars</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_y"</span>, <span class="va">temp_year</span>, <span class="st">"_m"</span>, <span class="va">temp_month</span>, <span class="st">".rds"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- delete all the downloaded files ---#</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then create a <code>data.frame</code> of all the year-month combinations:</p>
<div class="cell">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co">#--- create a set of year-month combinations to loop over ---#</span></span>
<span>  <span class="va">month_year_data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/J.html">CJ</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, year <span class="op">=</span> <span class="fl">1990</span><span class="op">:</span><span class="fl">2018</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;month, year&gt;
     month  year
     &lt;int&gt; &lt;int&gt;
  1:     1  1990
  2:     1  1991
  3:     1  1992
  4:     1  1993
  5:     1  1994
 ---            
344:    12  2014
345:    12  2015
346:    12  2016
347:    12  2017
348:    12  2018</code></pre>
</div>
</div>
<p>We now do parallelized loop over all the year-month combinations (by looping over the rows of <code>month_year_data</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- run the above code in parallel ---#</span></span>
<span><span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future_lapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">month_year_data</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_save_prism</span><span class="op">(</span><span class="va">x</span>, <span class="st">"ppt"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s it. Of course, you can do the same thing for <code>tmax</code> by this:</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- run the above code in parallel ---#</span></span>
<span><span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future_lapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">month_year_data</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_save_prism</span><span class="op">(</span><span class="va">x</span>, <span class="st">"tmax"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that you have PRISM datasets, you can extract values from the raster layers for vector data for your analysis, which is covered extensively in Chapters <a href="05-SpatialInteractionVectorRaster.html" class="quarto-xref"><span>Chapter 5</span></a> and <a href="06-stars.html" class="quarto-xref"><span>Chapter 6</span></a> (for <code>stars</code> objects).</p>
<hr>
<p>If you want to save the data by year (each file would be about 168 Mb). You could do this.</p>
<div class="cell">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- define a function to download and save PRISM data stacked by year ---#</span></span>
<span><span class="va">get_save_prism_y</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">temp_year</span>, <span class="va">var_type</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"working on "</span>, <span class="va">temp_year</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- starting date of the working month-year ---#</span></span>
<span>  <span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">dmy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"1/1/"</span>, <span class="va">temp_year</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#--- end date ---#</span></span>
<span>  <span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">dmy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"1/1/"</span>, <span class="va">temp_year</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="co">#--- download daily PRISM data for the working month-year ---#</span></span>
<span>  <span class="fu">prism</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">get_prism_dailys</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="va">var_type</span>,</span>
<span>    minDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">start_date</span><span class="op">)</span>,</span>
<span>    maxDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">end_date</span><span class="op">)</span>,</span>
<span>    keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- list of dates of the working month-year ---#</span></span>
<span>  <span class="va">dates_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, <span class="st">"days"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- remove dashes ---#</span></span>
<span>  <span class="va">dates_prism_txt</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">dates_ls</span>, <span class="st">"-"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- folder names ---#</span></span>
<span>  <span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil"</span><span class="op">)</span></span>
<span>  <span class="co">#--- the file name of the downloaded data ---#</span></span>
<span>  <span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil.bil"</span><span class="op">)</span></span>
<span>  <span class="co">#--- complete path to the downloaded files ---#</span></span>
<span>  <span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span>, <span class="st">"/"</span>, <span class="va">file_name</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- combine all the PRISM files as a SpatRaster ---#</span></span>
<span>  <span class="va">temp_stars</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- convert to stars ---#</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- set the third dimension as data ---#</span></span>
<span>    <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span><span class="st">"band"</span>, values <span class="op">=</span> <span class="va">dates_ls</span>, name <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- save the stars as an rds file ---#</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span></span>
<span>    <span class="va">temp_stars</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_y"</span>, <span class="va">temp_year</span>, <span class="st">".rds"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- delete all the downloaded files ---#</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#--- run the above code in parallel ---#</span></span>
<span><span class="fu">future_lapply</span><span class="op">(</span></span>
<span>  <span class="fl">1990</span><span class="op">:</span><span class="fl">2018</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_save_prism_y</span><span class="op">(</span><span class="va">x</span>, <span class="st">"tmax"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-daymetr" class="level2 page-columns page-full" data-number="8.4"><h2 data-number="8.4" class="anchored" data-anchor-id="sec-daymetr">
<span class="header-section-number">8.4</span> Daymet with <code>daymetr</code> and <code>FedData</code>
</h2>
<p>For this section, we use the <code>daymetr</code> <span class="citation" data-cites="daymetr">(<a href="#ref-daymetr" role="doc-biblioref">Hufkens et al. 2018</a>)</span> and <code>FedData</code> packages <span class="citation" data-cites="feddata">(<a href="#ref-feddata" role="doc-biblioref">Bocinsky 2016</a>)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bluegreen-labs/daymetr">daymetr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/FedData/">FedData</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Daymet data consists of “tiles,” each of which consisting of raster cells of 1km by 1km. <a href="#fig-daymet-tiles" class="quarto-xref">Figure&nbsp;<span>8.8</span></a> is the map of the tiles.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">US_map</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="fu">maps</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html">map</a></span><span class="op">(</span>database <span class="op">=</span> <span class="st">"state"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">tile_outlines</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">tile_outlines</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">NA</span>, size <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">US_map</span>, fill <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-daymet-tiles" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-daymet-tiles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-daymet-tiles-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-daymet-tiles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.8: Daymet Tiles
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Here is the list of weather variables:</p>
<ul>
<li>vapor pressure</li>
<li>minimum and maximum temperature</li>
<li>snow water equivalent</li>
<li>solar radiation</li>
<li>precipitation</li>
<li>day length</li>
</ul>
<p>Daymet provides more weather variables than PRISM, which is useful for calculating weather-dependent metrics such as evapotranspiration.</p>
<p>The easiest way to find Daymet values for your vector data depends on whether you are working with points or polygons. For point data, <code><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">daymetr::download_daymet()</a></code> is the simplest option, as it directly returns weather values for the points of interest. Internally, it identifies the cell in which the point is located and returns the values for that cell over the specified period. <code><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">daymetr::download_daymet()</a></code> handles all of this automatically.</p>
<p>For polygons, however, you first need to download the relevant Daymet data for the region of interest and then extract the values for each polygon, a process covered in <code><a href="https://docs.ropensci.org/FedData/reference/get_daymet.html">FedData::get_daymet()</a></code> downloads the requested Daymet data and saves it as a <code>RasterBrick</code> object, which can be easily converted into a stars object using <code><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">stars::st_as_stars()</a></code>.</p>
<section id="for-points-data" class="level3" data-number="8.4.1"><h3 data-number="8.4.1" class="anchored" data-anchor-id="for-points-data">
<span class="header-section-number">8.4.1</span> For points data</h3>
<p>For points data, the easiest way to associate daily weather values to them is to use <code><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">daymetr::download_daymet()</a></code>.</p>
<p>Here are key parameters for the function:</p>
<ul>
<li>
<code>lat</code>: latitude</li>
<li>
<code>lon</code>: longitude</li>
<li>
<code>start</code>: start_year</li>
<li>
<code>end</code>: end_year</li>
<li>
<code>internal</code>: <code>TRUE</code> (dafault) or <code>FALSE</code>
</li>
</ul>
<p>For example, the code below downloads daily weather data for a point (<code>lat</code> = <span class="math inline">\(36\)</span>, <code>longitude</code> = <span class="math inline">\(-100\)</span>) starting from 2000 through 2002 and assigns the downloaded data to <code>temp_daymet</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- download daymet data ---#</span></span>
<span><span class="va">temp_daymet</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">daymetr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">download_daymet</a></span><span class="op">(</span></span>
<span>    lat <span class="op">=</span> <span class="fl">36</span>,</span>
<span>    lon <span class="op">=</span> <span class="op">-</span><span class="fl">100</span>,</span>
<span>    start <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>    end <span class="op">=</span> <span class="fl">2002</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- structure ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">temp_daymet</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 7
 $ site     : chr "Daymet"
 $ tile     : num 11380
 $ latitude : num 36
 $ longitude: num -100
 $ altitude : num 746
 $ tile     : num 11380
 $ data     :'data.frame':  1095 obs. of  9 variables:
  ..$ year         : int [1:1095] 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 ...
  ..$ yday         : int [1:1095] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ dayl..s.     : num [1:1095] 34571 34606 34644 34685 34729 ...
  ..$ prcp..mm.day.: num [1:1095] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ srad..W.m.2. : num [1:1095] 334 231 148 319 338 ...
  ..$ swe..kg.m.2. : num [1:1095] 18.2 15 13.6 13.6 13.6 ...
  ..$ tmax..deg.c. : num [1:1095] 20.9 13.88 4.49 9.18 13.37 ...
  ..$ tmin..deg.c. : num [1:1095] -2.73 1.69 -2.6 -10.16 -8.97 ...
  ..$ vp..Pa.      : num [1:1095] 500 690 504 282 310 ...
 - attr(*, "class")= chr "daymetr"</code></pre>
</div>
</div>
<p>As you can see, <code>temp_daymet</code> has bunch of site information other than the weather data. You can get the weather data portion of <code>temp_daymet</code> by accessing its <code>data</code> element.</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the data part ---#</span></span>
<span><span class="va">temp_daymet_data</span> <span class="op">&lt;-</span> <span class="va">temp_daymet</span><span class="op">$</span><span class="va">data</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">temp_daymet_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year yday dayl..s. prcp..mm.day. srad..W.m.2. swe..kg.m.2. tmax..deg.c.
1 2000    1 34571.11             0       334.34        18.23        20.90
2 2000    2 34606.19             0       231.20        15.00        13.88
3 2000    3 34644.13             0       148.29        13.57         4.49
4 2000    4 34684.93             0       319.13        13.57         9.18
5 2000    5 34728.55             0       337.67        13.57        13.37
6 2000    6 34774.96             0       275.72        13.11         9.98
  tmin..deg.c. vp..Pa.
1        -2.73  499.56
2         1.69  689.87
3        -2.60  504.40
4       -10.16  282.35
5        -8.97  310.05
6        -4.89  424.78</code></pre>
</div>
</div>
<p>As you might have noticed, <code>yday</code> is not the date of each observation, but the day of the year. You can easily convert it into dates like this:</p>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">temp_daymet_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">temp_daymet_data</span>, date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">yday</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>, <span class="st">"%Y-%j"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once dates are obtained, you can use the <code>lubridate</code> package to extract day, month, and year using <code>day()</code>, <code>month()</code>, and <code>year()</code>, respectively.</p>
<div class="cell">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">temp_daymet_data</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">temp_daymet_data</span>,</span>
<span>    day <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>    <span class="co">#--- this is already there though ---#</span></span>
<span>    year <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">temp_daymet_data</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year month day
1 2000     1   1
2 2000     1   2
3 2000     1   3
4 2000     1   4
5 2000     1   5
6 2000     1   6</code></pre>
</div>
</div>
<p>This helps you find group statistics like monthly precipitation.</p>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">temp_daymet_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>prcp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">prcp..mm.day.</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 2
   month  prcp
   &lt;dbl&gt; &lt;dbl&gt;
 1     1 0.762
 2     2 1.20 
 3     3 2.08 
 4     4 1.24 
 5     5 3.53 
 6     6 3.45 
 7     7 1.78 
 8     8 1.19 
 9     9 1.32 
10    10 4.78 
11    11 0.407
12    12 0.743</code></pre>
</div>
</div>
<p>Downloading Daymet data for many points is just applying the same operations above to them using a loop. Let’s create random points within California and get their coordinates.</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">389548</span><span class="op">)</span></span>
<span></span>
<span><span class="va">random_points</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"CA"</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- 10 points ---#</span></span>
<span>  <span class="fu">st_sample</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- get the coordinates ---#</span></span>
<span>  <span class="fu">st_coordinates</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- as tibble (data.frame) ---#</span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- assign site id ---#</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>site_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To loop over the points, you can first write a function like this:</p>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_daymet</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp_lat</span> <span class="op">&lt;-</span> <span class="va">random_points</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">pull</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span>  <span class="va">temp_lon</span> <span class="op">&lt;-</span> <span class="va">random_points</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">pull</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="va">temp_site</span> <span class="op">&lt;-</span> <span class="va">random_points</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">pull</span><span class="op">(</span><span class="va">site_id</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">temp_daymet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">download_daymet</a></span><span class="op">(</span></span>
<span>    lat <span class="op">=</span> <span class="va">temp_lat</span>,</span>
<span>    lon <span class="op">=</span> <span class="va">temp_lon</span>,</span>
<span>    start <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>    end <span class="op">=</span> <span class="fl">2002</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- just get the data part ---#</span></span>
<span>    <span class="va">.</span><span class="op">$</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- convert to tibble (not strictly necessary) ---#</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- assign site_id so you know which record is for which site_id ---#</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>site_id <span class="op">=</span> <span class="va">temp_site</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- get date from day of the year ---#</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">yday</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>, <span class="st">"%Y-%j"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">temp_daymet</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what the function returns for the 1st row of <code>random_points</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/FedData/reference/get_daymet.html">get_daymet</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,095 × 11
    year  yday dayl..s. prcp..mm.day. srad..W.m.2. swe..kg.m.2. tmax..deg.c.
   &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
 1  2000     1   34131.             0         246.            0         7.02
 2  2000     2   34168.             0         251.            0         4.67
 3  2000     3   34208.             0         247.            0         7.32
 4  2000     4   34251              0         267.            0        10   
 5  2000     5   34297              0         240.            0         4.87
 6  2000     6   34346.             0         274.            0         7.79
 7  2000     7   34398.             0         262.            0         7.29
 8  2000     8   34453.             0         291.            0        11.2 
 9  2000     9   34510.             0         268.            0        10.0 
10  2000    10   34570.             0         277.            0        11.8 
# ℹ 1,085 more rows
# ℹ 4 more variables: tmin..deg.c. &lt;dbl&gt;, vp..Pa. &lt;dbl&gt;, site_id &lt;int&gt;,
#   date &lt;date&gt;</code></pre>
</div>
</div>
<p>You can now simply loop over the rows.</p>
<div class="cell">
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">daymet_all_points</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">random_points</span><span class="op">)</span>, <span class="va">get_daymet</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- need to combine the list of data.frames into a single data.frame ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,950 × 11
    year  yday dayl..s. prcp..mm.day. srad..W.m.2. swe..kg.m.2. tmax..deg.c.
   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
 1  2000     1   33523.             0         230.            0         12  
 2  2000     2   33523.             0         240             0         11.5
 3  2000     3   33523.             0         243.            0         13.5
 4  2000     4   33523.             1         230.            0         13  
 5  2000     5   33523.             0         243.            0         14  
 6  2000     6   33523.             0         243.            0         13  
 7  2000     7   33523.             0         246.            0         14  
 8  2000     8   33869.             0         230.            0         13  
 9  2000     9   33869.             0         227.            0         12.5
10  2000    10   33869.             0         214.            0         14  
# ℹ 10,940 more rows
# ℹ 4 more variables: tmin..deg.c. &lt;dbl&gt;, vp..Pa. &lt;dbl&gt;, site_id &lt;int&gt;,
#   date &lt;date&gt;</code></pre>
</div>
</div>
<p>Or better yet, you can easily parallelize this process as follows (see <a href="A1-ParallelComputing.html" class="quarto-xref"><span>Appendix A</span></a> if you are not familiar with parallelization in R):</p>
<div class="cell">
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- parallelization planning ---#</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- parallelized lapply ---#</span></span>
<span><span class="va">daymet_all_points</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future_lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">random_points</span><span class="op">)</span>, <span class="va">get_daymet</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- need to combine the list of data.frames into a single data.frame ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sec-daymet-poly" class="level3 page-columns page-full" data-number="8.4.2"><h3 data-number="8.4.2" class="anchored" data-anchor-id="sec-daymet-poly">
<span class="header-section-number">8.4.2</span> For polygons data</h3>
<p>Suppose you are interested in getting Daymet data for select counties in Michigan (<a href="#fig-michi-fig" class="quarto-xref">Figure&nbsp;<span>8.9</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- entire MI ---#</span></span>
<span><span class="va">MI_counties</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"MI"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- select counties ---#</span></span>
<span><span class="va">MI_counties_select</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">MI_counties</span>, <span class="va">NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Luce"</span>, <span class="st">"Chippewa"</span>, <span class="st">"Mackinac"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">MI_counties</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">MI_counties_select</span>, fill <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-michi-fig" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-michi-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-michi-fig-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-michi-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.9: Select Michigan counties for which we download Daymet data
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>We can use <code><a href="https://docs.ropensci.org/FedData/reference/get_daymet.html">FedData::get_daymet()</a></code> to download Daymet data that covers the spatial extent of the polygon data. The downloaded dataset can be assigned to an R object as a <code>RasterBrick</code>, or alternatively, you could write the downloaded data to a file. To specify the spatial extent for which Daymet data should be downloaded, we provide a <code>SpatialPolygonsDataFrame</code> object supported by the <code>sp</code> package. Since we primarily handle vector data with the <code>sf</code> package, we need to convert the <code>sf</code> object to an <code>sp</code> object.</p>
<p>The code below downloads <code>prcp</code> and <code>tmax</code> for the spatial extent of Michigan counties for 2000 and 2001:</p>
<div class="cell">
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">MI_daymet_select</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">FedData</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/FedData/reference/get_daymet.html">get_daymet</a></span><span class="op">(</span></span>
<span>      <span class="co">#--- supply the vector data in sp ---#</span></span>
<span>      template <span class="op">=</span> <span class="fu">as</span><span class="op">(</span><span class="va">MI_counties_select</span>, <span class="st">"Spatial"</span><span class="op">)</span>,</span>
<span>      <span class="co">#--- label ---#</span></span>
<span>      label <span class="op">=</span> <span class="st">"MI_counties_select"</span>,</span>
<span>      <span class="co">#--- variables to download ---#</span></span>
<span>      elements <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"prcp"</span>, <span class="st">"tmax"</span><span class="op">)</span>,</span>
<span>      <span class="co">#--- years ---#</span></span>
<span>      years <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2001</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$prcp
class      : RasterBrick 
dimensions : 96, 156, 14976, 730  (nrow, ncol, ncell, nlayers)
resolution : 1000, 1000  (x, y)
extent     : 1027250, 1183250, 455500, 551500  (xmin, xmax, ymin, ymax)
crs        : +proj=lcc +lon_0=-100 +lat_0=42.5 +x_0=0 +y_0=0 +lat_1=25 +lat_2=60 +ellps=WGS84 
source     : memory
names      : X2000.01.01, X2000.01.02, X2000.01.03, X2000.01.04, X2000.01.05, X2000.01.06, X2000.01.07, X2000.01.08, X2000.01.09, X2000.01.10, X2000.01.11, X2000.01.12, X2000.01.13, X2000.01.14, X2000.01.15, ... 
min values :           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0, ... 
max values :           6,          26,          19,          17,           6,           9,           6,           1,           0,          13,          15,           6,           0,           4,           7, ... 


$tmax
class      : RasterBrick 
dimensions : 96, 156, 14976, 730  (nrow, ncol, ncell, nlayers)
resolution : 1000, 1000  (x, y)
extent     : 1027250, 1183250, 455500, 551500  (xmin, xmax, ymin, ymax)
crs        : +proj=lcc +lon_0=-100 +lat_0=42.5 +x_0=0 +y_0=0 +lat_1=25 +lat_2=60 +ellps=WGS84 
source     : memory
names      : X2000.01.01, X2000.01.02, X2000.01.03, X2000.01.04, X2000.01.05, X2000.01.06, X2000.01.07, X2000.01.08, X2000.01.09, X2000.01.10, X2000.01.11, X2000.01.12, X2000.01.13, X2000.01.14, X2000.01.15, ... 
min values :         0.5,        -4.5,        -8.0,        -8.5,        -7.0,        -2.5,        -6.5,        -1.5,         1.5,         2.0,        -1.5,        -8.5,       -14.0,        -9.5,        -3.0, ... 
max values :         3.0,         3.0,         0.5,        -2.5,        -2.5,         0.0,         0.5,         1.5,         4.0,         3.0,         3.5,         0.5,        -6.5,        -4.0,         0.0, ... </code></pre>
</div>
</div>
<p>As you can see, Daymet <code>prcp</code> and <code>tmax</code> data are stored separately as <code>RasterBrick</code> in a single list. The following code access <code>tmax</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">MI_daymet_select</span><span class="op">$</span><span class="va">tmax</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class      : RasterBrick 
dimensions : 96, 156, 14976, 730  (nrow, ncol, ncell, nlayers)
resolution : 1000, 1000  (x, y)
extent     : 1027250, 1183250, 455500, 551500  (xmin, xmax, ymin, ymax)
crs        : +proj=lcc +lon_0=-100 +lat_0=42.5 +x_0=0 +y_0=0 +lat_1=25 +lat_2=60 +ellps=WGS84 
source     : memory
names      : X2000.01.01, X2000.01.02, X2000.01.03, X2000.01.04, X2000.01.05, X2000.01.06, X2000.01.07, X2000.01.08, X2000.01.09, X2000.01.10, X2000.01.11, X2000.01.12, X2000.01.13, X2000.01.14, X2000.01.15, ... 
min values :         0.5,        -4.5,        -8.0,        -8.5,        -7.0,        -2.5,        -6.5,        -1.5,         1.5,         2.0,        -1.5,        -8.5,       -14.0,        -9.5,        -3.0, ... 
max values :         3.0,         3.0,         0.5,        -2.5,        -2.5,         0.0,         0.5,         1.5,         4.0,         3.0,         3.5,         0.5,        -6.5,        -4.0,         0.0, ... </code></pre>
</div>
</div>
<p>If you prefer <code>SpatRaster</code> from the <code>terra</code> package, convert it:</p>
<div class="cell">
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">MI_daymet_select</span><span class="op">$</span><span class="va">tmax</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can extract values for your target polygons data using the methods described in <a href="05-SpatialInteractionVectorRaster.html" class="quarto-xref"><span>Chapter 5</span></a>.</p>
<p>If you use the <code>stars</code> package for raster data handling (see <a href="06-stars.html" class="quarto-xref"><span>Chapter 6</span></a>), you can convert them into <code>stars</code> object using <code>st_as_stars()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- tmax as stars ---#</span></span>
<span><span class="va">tmax_stars</span> <span class="op">&lt;-</span> <span class="fu">st_as_stars</span><span class="op">(</span><span class="va">MI_daymet_select</span><span class="op">$</span><span class="va">tmax</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- prcp as stars ---#</span></span>
<span><span class="va">prcp_stars</span> <span class="op">&lt;-</span> <span class="fu">st_as_stars</span><span class="op">(</span><span class="va">MI_daymet_select</span><span class="op">$</span><span class="va">prcp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, the third dimension (band) is not recognized as dates. We can use <code>st_set_dimension()</code> to change that (see <a href="06-stars.html#sec-stars-set-time" class="quarto-xref"><span>Section 6.5</span></a>). Before that, we first need to recover <code>Date</code> values from the “band” values as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">date_values</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">tmax_stars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- get band values ---#</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_get_dimension_values</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"band"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- remove X ---#</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- convert to date ---#</span></span>
<span>  <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">date_values</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2000-01-01" "2000-01-02" "2000-01-03" "2000-01-04" "2000-01-05"
[6] "2000-01-06"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- tmax ---#</span></span>
<span><span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span><span class="va">tmax_stars</span>, <span class="fl">3</span>, values <span class="op">=</span> <span class="va">date_values</span>, names <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
             Min. 1st Qu. Median      Mean 3rd Qu. Max. NA's
X2000.01.01  -8.5      -4     -2 -1.884266       0    3  198
dimension(s):
     from  to  offset delta                       refsys
x       1 156 1027250  1000 +proj=lcc +lon_0=-100 +la...
y       1  96  551500 -1000 +proj=lcc +lon_0=-100 +la...
date    1 730      NA    NA                         Date
                        values x/y
x                         NULL [x]
y                         NULL [y]
date 2000-01-01,...,2001-12-31    </code></pre>
</div>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- prcp ---#</span></span>
<span><span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span><span class="va">prcp_stars</span>, <span class="fl">3</span>, values <span class="op">=</span> <span class="va">date_values</span>, names <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
             Min. 1st Qu. Median     Mean 3rd Qu. Max. NA's
X2000.01.01     0       0      3 6.231649      12   26  198
dimension(s):
     from  to  offset delta                       refsys
x       1 156 1027250  1000 +proj=lcc +lon_0=-100 +la...
y       1  96  551500 -1000 +proj=lcc +lon_0=-100 +la...
date    1 730      NA    NA                         Date
                        values x/y
x                         NULL [x]
y                         NULL [y]
date 2000-01-01,...,2001-12-31    </code></pre>
</div>
</div>
<p>Notice that the date dimension has NA for <code>delta</code>. This is because Daymet removes observations for December 31 in leap years to make the time dimension 365 consistently across years. This means that there is a one-day gap between “2000-12-30” and “2000-01-01” as you can see below:</p>
<div class="cell">
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">date_values</span><span class="op">[</span><span class="fl">364</span><span class="op">:</span><span class="fl">367</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2000-12-29" "2000-12-30" "2001-01-01" "2001-01-02"</code></pre>
</div>
</div>
</section></section><section id="sec-gridMET" class="level2 page-columns page-full" data-number="8.5"><h2 data-number="8.5" class="anchored" data-anchor-id="sec-gridMET">
<span class="header-section-number">8.5</span> gridMET</h2>
<p><a href="http://www.climatologylab.org/gridmet.html">gridMET</a> is a dataset of daily meteorological data covering the contiguous U.S. since 1979. Its spatial resolution matches that of PRISM data at 4 km by 4 km. In fact, gridMET is a product of combining <a href="https://prism.oregonstate.edu/">PRISM</a> with the <a href="https://ldas.gsfc.nasa.gov/nldas/NLDAS2forcing.php">Land Data Assimilation System</a> (specifically, NLDAS-2).</p>
<p>gridMET offers a broader range of variables than PRISM, including maximum temperature, minimum temperature, precipitation accumulation, downward surface shortwave radiation, wind velocity, and humidity (both maximum/minimum relative humidity and specific humidity). It also provides derived products, such as reference evapotranspiration, calculated using the Penman-Monteith equation.</p>
<p>You can use the <code>downloadr::download()</code> function to download gridMET data by variable-year. For example, to download precipitation data for 2018, you can run the following code:</p>
<div class="cell">
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">downloader</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/downloader/man/download.html">download</a></span><span class="op">(</span></span>
<span>  url <span class="op">=</span> <span class="st">"http://www.northwestknowledge.net/metdata/data/pr_2018.nc"</span>,</span>
<span>  destfile <span class="op">=</span> <span class="st">"Data/pr_2018.nc"</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"wb"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We set the url of the dataset of interest in the <code>url</code> option, set the destination file name in the <code>destfile</code> option, and the mode to the <code>wb</code> option for a binary download.</p>
<p>All the gridMET datasets for direct download has “http://www.northwestknowledge.net/metdata/data/” at the beginning, followed by the file name (here, <strong>pr_2018.nc</strong>). The file names follow the convention of <strong>variable_abbreviation</strong>_<strong>year</strong>.nc. So, we can easily write a loop to get data for multiple variables over multiple years.</p>
<p>Here is the list of variable abbreviations:</p>
<ul>
<li>sph: (Near-Surface Specific Humidity)</li>
<li>vpd: (Mean Vapor Pressure Deficit)</li>
<li>pr: (Precipitation)</li>
<li>rmin: (Minimum Near-Surface Relative Humidity)</li>
<li>rmax: (Maximum Near-Surface Relative Humidity)</li>
<li>srad: (Surface Downwelling Solar Radiation)</li>
<li>tmmn: (Minimum Near-Surface Air Temperature)</li>
<li>tmmx: (Maximum Near-Surface Air Temperature)</li>
<li>vs: (Wind speed at 10 m)</li>
<li>th: (Wind direction at 10 m)</li>
<li>pdsi: (Palmer Drought Severity Index)</li>
<li>pet: (Reference grass evaportranspiration)</li>
<li>etr: (Reference alfalfa evaportranspiration)</li>
<li>erc: (model-G)</li>
<li>bi: (model-G)</li>
<li>fm100: (100-hour dead fuel moisture)</li>
<li>fm1000: (1000-hour dead fuel moisture)</li>
</ul>
<p>As another example, if you are interested in downloading the wind speed data for 2020, then you can use the following code.</p>
<div class="cell">
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">downloader</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/downloader/man/download.html">download</a></span><span class="op">(</span></span>
<span>  url <span class="op">=</span> <span class="st">"http://www.northwestknowledge.net/metdata/data/vs_2020.nc"</span>,</span>
<span>  destfile <span class="op">=</span> <span class="st">"Data/vs_2020.nc"</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"wb"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="practical-examples" class="level3 page-columns page-full" data-number="8.5.1"><h3 data-number="8.5.1" class="anchored" data-anchor-id="practical-examples">
<span class="header-section-number">8.5.1</span> Practical Examples</h3>
<p>Suppose your final goal is to get average daily precipitation (<strong>pr</strong>) and reference grass evapotranspiration (<strong>pet</strong>) from 2015 through 2020 for each of the counties in California.</p>
<p>First get county boundaries for California:</p>
<div class="cell">
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">CA_counties</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"CA"</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">STATEFP</span>, <span class="va">COUNTYFP</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before writing a loop, let’s work on a single case (<strong>pet</strong> for 2015). First, we download and read the data.</p>
<div class="cell">
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- download data ---#</span></span>
<span><span class="fu">downloader</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/downloader/man/download.html">download</a></span><span class="op">(</span></span>
<span>  url <span class="op">=</span> <span class="st">"http://www.northwestknowledge.net/metdata/data/pet_2015.nc"</span>,</span>
<span>  destfile <span class="op">=</span> <span class="st">"Data/pet_2015.nc"</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"wb"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- read the raster data ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">pet_2015</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="st">"Data/pet_2015.nc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 585, 1386, 365  (nrow, ncol, nlyr)
resolution  : 0.04166667, 0.04166667  (x, y)
extent      : -124.7875, -67.0375, 25.04583, 49.42083  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source      : pet_2015.nc 
varname     : potential_evapotranspiration (pet) 
names       : poten~42003, poten~42004, poten~42005, poten~42006, poten~42007, poten~42008, ... 
unit        :          mm,          mm,          mm,          mm,          mm,          mm, ... </code></pre>
</div>
</div>
<p>As you can see, it is a multi-layer raster object where each layer represents a single day in 2015 (<a href="#fig-gm-2015-pet-viz" class="quarto-xref">Figure&nbsp;<span>8.10</span></a> is a quick visualization of the first layer).</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb117"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pet_2015</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-gm-2015-pet-viz" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-gm-2015-pet-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-DownloadSpatialData_files/figure-html/fig-gm-2015-pet-viz-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gm-2015-pet-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.10: Potential evapotranspiration in January 1st, 2015
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Now, we can use <code>exactexactr::exact_extract()</code> (or <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract</a></code>) to assign cell values to each county and transform it to a more convenient form:</p>
<div class="cell">
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pet_county</span> <span class="op">&lt;-</span></span>
<span>  <span class="co">#--- extract data for each county ---#</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">pet_2015</span>, <span class="va">CA_counties</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- list of data.frames into data.table ---#</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"rowid"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- check the dimension of the output ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">pet_county</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 28203   367</code></pre>
</div>
</div>
<p>As you can see the data has 367 columns: 365 (days) + 1 (<code>rowid</code>) + 1 (coverage fraction). Let’s take a look at the name of the first six variables.</p>
<div class="cell">
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">pet_county</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "rowid"                                 
[2] "potential_evapotranspiration_day=42003"
[3] "potential_evapotranspiration_day=42004"
[4] "potential_evapotranspiration_day=42005"
[5] "potential_evapotranspiration_day=42006"
[6] "potential_evapotranspiration_day=42007"</code></pre>
</div>
</div>
<p>The 5-digit number at the end of the name of the variables for evapotranspiration represents days since Jan 1st, 1900. This can be confirmed using <code>ncdf4:nc_open()</code> (see the middle of the output below under <strong>day</strong> of <strong>4 dimensions</strong>):</p>
<div class="cell">
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ncdf4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_open.html">nc_open</a></span><span class="op">(</span><span class="st">"Data/pet_2015.nc"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>File Data/pet_2015.nc (NC_FORMAT_NETCDF4):

     1 variables (excluding dimension variables):
        unsigned short potential_evapotranspiration[lon,lat,day]   (Chunking: [231,98,61])  (Compression: level 9)
            _FillValue: 32767
            units: mm
            description: Daily reference evapotranspiration (short grass)
            long_name: pet
            standard_name: pet
            missing_value: 32767
            dimensions: lon lat time
            grid_mapping: crs
            coordinate_system: WGS84,EPSG:4326
            scale_factor: 0.1
            add_offset: 0
            coordinates: lon lat
            _Unsigned: true

     4 dimensions:
        lon  Size:1386 
            units: degrees_east
            description: longitude
            long_name: longitude
            standard_name: longitude
            axis: X
        lat  Size:585 
            units: degrees_north
            description: latitude
            long_name: latitude
            standard_name: latitude
            axis: Y
        day  Size:365 
            description: days since 1900-01-01
            units: days since 1900-01-01 00:00:00
            long_name: time
            standard_name: time
            calendar: gregorian
        crs  Size:1 
            grid_mapping_name: latitude_longitude
            longitude_of_prime_meridian: 0
            semi_major_axis: 6378137
            long_name: WGS 84
            inverse_flattening: 298.257223563
            GeoTransform: -124.7666666333333 0.041666666666666 0  49.400000000000000 -0.041666666666666
            spatial_ref: GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]]

    19 global attributes:
        geospatial_bounds_crs: EPSG:4326
        Conventions: CF-1.6
        geospatial_bounds: POLYGON((-124.7666666333333 49.400000000000000, -124.7666666333333 25.066666666666666, -67.058333300000015 25.066666666666666, -67.058333300000015 49.400000000000000, -124.7666666333333 49.400000000000000))
        geospatial_lat_min: 25.066666666666666
        geospatial_lat_max: 49.40000000000000
        geospatial_lon_min: -124.7666666333333
        geospatial_lon_max: -67.058333300000015
        geospatial_lon_resolution: 0.041666666666666
        geospatial_lat_resolution: 0.041666666666666
        geospatial_lat_units: decimal_degrees north
        geospatial_lon_units: decimal_degrees east
        coordinate_system: EPSG:4326
        author: John Abatzoglou - University of Idaho, jabatzoglou@uidaho.edu
        date: 04 July 2019
        note1: The projection information for this file is: GCS WGS 1984.
        note2: Citation: Abatzoglou, J.T., 2013, Development of gridded surface meteorological data for ecological applications and modeling, International Journal of Climatology, DOI: 10.1002/joc.3413
        note3: Data in slices after last_permanent_slice (1-based) are considered provisional and subject to change with subsequent updates
        note4: Data in slices after last_provisional_slice (1-based) are considered early and subject to change with subsequent updates
        note5: Days correspond approximately to calendar days ending at midnight, Mountain Standard Time (7 UTC the next calendar day)</code></pre>
</div>
</div>
<p>This is universally true for all the gridMET data. We can use this information to recover date. First, let’s transform the data from a wide format to a long format for easier operations:</p>
<div class="cell">
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pet_county</span> <span class="op">&lt;-</span></span>
<span>  <span class="co">#--- wide to long ---#</span></span>
<span>  <span class="fu">melt</span><span class="op">(</span><span class="va">pet_county</span>, id.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rowid"</span>, <span class="st">"coverage_fraction"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- remove observations with NA values ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="va">pet_county</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          rowid coverage_fraction                               variable value
          &lt;int&gt;             &lt;num&gt;                                 &lt;fctr&gt; &lt;num&gt;
       1:     1       0.004266545 potential_evapotranspiration_day=42003   2.3
       2:     1       0.254054248 potential_evapotranspiration_day=42003   2.2
       3:     1       0.175513789 potential_evapotranspiration_day=42003   2.0
       4:     1       0.442011684 potential_evapotranspiration_day=42003   2.1
       5:     1       1.000000000 potential_evapotranspiration_day=42003   2.2
      ---                                                                     
10116701:    58       0.538234591 potential_evapotranspiration_day=42367   2.1
10116702:    58       0.197555855 potential_evapotranspiration_day=42367   2.7
10116703:    58       0.224901110 potential_evapotranspiration_day=42367   2.2
10116704:    58       0.554238617 potential_evapotranspiration_day=42367   2.2
10116705:    58       0.272462875 potential_evapotranspiration_day=42367   2.1</code></pre>
</div>
</div>
<p>We now use <code><a href="https://stringr.tidyverse.org/reference/str_sub.html">stringr::str_sub()</a></code> to get 5-digit numbers from <code>variable</code>, which represents days since Jan 1st, 1900. We can then recover dates using the <code>lubridate</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pet_county</span><span class="op">[</span>, <span class="va">variable</span> <span class="op">:=</span> <span class="fu">str_sub</span><span class="op">(</span><span class="va">variable</span>, <span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#--- recover dates ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">date</span> <span class="op">:=</span> <span class="va">variable</span> <span class="op">+</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"1900-01-01"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="va">pet_county</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          rowid coverage_fraction variable value       date
          &lt;int&gt;             &lt;num&gt;    &lt;num&gt; &lt;num&gt;     &lt;Date&gt;
       1:     1       0.004266545    42003   2.3 2015-01-01
       2:     1       0.254054248    42003   2.2 2015-01-01
       3:     1       0.175513789    42003   2.0 2015-01-01
       4:     1       0.442011684    42003   2.1 2015-01-01
       5:     1       1.000000000    42003   2.2 2015-01-01
      ---                                                  
10116701:    58       0.538234591    42367   2.1 2015-12-31
10116702:    58       0.197555855    42367   2.7 2015-12-31
10116703:    58       0.224901110    42367   2.2 2015-12-31
10116704:    58       0.554238617    42367   2.2 2015-12-31
10116705:    58       0.272462875    42367   2.1 2015-12-31</code></pre>
</div>
</div>
<p>Finally, let’s calculate the coverage-weighted average of <strong>pet</strong> by county-date.</p>
<div class="cell">
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pet_county_avg</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">pet_county</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">rowid</span>, <span class="va">date</span><span class="op">)</span></span>
<span>  <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">setnames</span><span class="op">(</span><span class="st">"value"</span>, <span class="st">"pet"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since <code>rowid</code> value of <strong>n</strong> corresponds to the <strong>n</strong>th row in <code>CA_counties</code>, it is easy to merge <code>pet_county_avg</code> with <code>CA_counties</code> (alternatively, you can use <code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code>).</p>
<div class="cell">
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">CA_pet</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">CA_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>rowid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">pet_county_avg</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"rowid"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we know how to process a single gridMET dataset, we are ready to write a function that goes through the same for a choice of gridMET dataset and then write a loop to achieve our goal. Here is the function:</p>
<div class="cell">
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_grid_MET</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">var_name</span>, <span class="va">year</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#--- for testing ---#</span></span>
<span>  <span class="co"># var_name &lt;- "pet"</span></span>
<span>  <span class="co"># year &lt;- 2020</span></span>
<span></span>
<span>  <span class="va">target_url</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"http://www.northwestknowledge.net/metdata/data/"</span>,</span>
<span>      <span class="va">var_name</span>, <span class="st">"_"</span>, <span class="va">year</span>,</span>
<span>      <span class="st">".nc"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="va">file_name</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"Data/"</span>,</span>
<span>      <span class="va">var_name</span>, <span class="st">"_"</span>, <span class="va">year</span>,</span>
<span>      <span class="st">".nc"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="fu">downloader</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/downloader/man/download.html">download</a></span><span class="op">(</span></span>
<span>    url <span class="op">=</span> <span class="va">target_url</span>,</span>
<span>    destfile <span class="op">=</span> <span class="va">file_name</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"wb"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- read the raster data ---#</span></span>
<span>  <span class="va">temp_rast</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">temp_data</span> <span class="op">&lt;-</span></span>
<span>    <span class="co">#--- extract data for each county ---#</span></span>
<span>    <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">temp_rast</span>, <span class="va">CA_counties</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- list of data.frames into data.table ---#</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"rowid"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- wide to long ---#</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span>id.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rowid"</span>, <span class="st">"coverage_fraction"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- remove observations with NA values ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- get only the numeric part ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">variable</span> <span class="op">:=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">variable</span>, <span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- recover dates ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">date</span> <span class="op">:=</span> <span class="va">variable</span> <span class="op">+</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"1900-01-01"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co">#--- find daily coverage-weight average by county ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>,</span>
<span>      <span class="fu">.</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">rowid</span>, <span class="va">date</span><span class="op">)</span></span>
<span>    <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">var</span> <span class="op">:=</span> <span class="va">var_name</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">temp_data</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now loop over the variables and years of interest. We first set up a dataset of variable-year combinations for which we loop over.</p>
<div class="cell">
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create a dataset of parameters to be looped over---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">par_data</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span></span>
<span>      var_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pr"</span>, <span class="st">"pet"</span><span class="op">)</span>,</span>
<span>      year <span class="op">=</span> <span class="fl">2015</span><span class="op">:</span><span class="fl">2020</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">var_name</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">var_name</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now loop over the rows of <code>par_data</code> in parallel:</p>
<div class="cell">
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- parallel processing ---#</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">all_data</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future_lapply</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">par_data</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_grid_MET</span><span class="op">(</span>var_name <span class="op">=</span> <span class="va">par_data</span><span class="op">[</span><span class="va">x</span>, <span class="va">var_name</span><span class="op">]</span>, year <span class="op">=</span> <span class="va">par_data</span><span class="op">[</span><span class="va">x</span>, <span class="va">year</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">rowid</span> <span class="op">+</span> <span class="va">date</span> <span class="op">~</span> <span class="va">var</span>, value.var <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- 
## USGS (under construction)

Under construction
 -->
<!-- [USGS R](https://owi.usgs.gov/R/index.html)

### Groundwater level data




::: {.cell}

```{.r .cell-code}
library(dataRetrieval)
state_ls <- state.abb

data_ne <- whatNWISdata(stateCd = "NE")

KS_gwl <- readNWISdata(
  stateCd = "Kansas",
  startDate = "1980-01-01",
  endDate = "2020-01-01",
  service = "gwlevels"
) %>%
  select(site_no, lev_dt, lev_va) %>%
  rename(date = lev_dt, dwt = lev_va)

KS_site_ls <- KS_gwl[, site_no] %>% unique()

sites_info <- readNWISsite(siteNumbers = KS_site_ls) %>%
  select(site_no, dec_lat_va, dec_long_va) %>%
  st_as_sf(coords = c("dec_long_va", "dec_lat_va")) %>%
  st_set_crs(4269)
```
:::




### Nitrogen concentration




::: {.cell}

```{.r .cell-code}
SaltLake_totalN <- readNWISdata(
  bBox = c(-113.0428, 40.6474, -112.0265, 41.7018),
  service = "qw",
  parameterCd = "00600",
  startDate = "2020-01-01"
)

attributes(SaltLake_totalN)

attr(SaltLake_totalN, "variableInfo")


phosphorous:00665
nitrogen:00665
```
:::





### Water temperature



::: {.cell}

```{.r .cell-code}
MauiCo_avgdailyQ <- readNWISdata(
  stateCd = "Hawaii",
  service = "dv",
  parameterCd = "00060"
)

head(MauiCo_avgdailyQ)
```
:::




### WQP 

[WQP user guide](https://www.waterqualitydata.us/portal_userguide/)

[WQP query](https://www.waterqualitydata.us/webservices_documentation/#WQPWebServicesGuide-Submitting)




::: {.cell}

```{.r .cell-code}
wqpcounts_ia <- readWQPdata(
  statecode = "US:19",
  querySummary = TRUE
)

IA_lake_phosphorus <- readWQPdata(
  statecode = "IA",
  siteType = "Lake, Reservoir, Impoundment",
  characteristicName = "Phosphorus",
  startDate = "1990-10-01"
) %>%
  filter(MonitoringLocationIdentifier, ResultMeasureValue, ActivityStartDate)

#--- get longitude and latitude ---#
siteInfo <- attr(IA_lake_phosphorus, "siteInfo") %>%
  select(MonitoringLocationIdentifier, dec_lat_va, dec_lon_va) %>%
  st_as_sf(coords = c("dec_lon_va", "dec_lat_va")) %>%
  st_set_crs(4269)

attributes()
```
:::



 -->
<!-- 
## Sentinel with `sen2r` (under construction)

Under construction


## Census with `tidycensus` (under construction)

Under construction

 -->


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-feddata" class="csl-entry" role="listitem">
Bocinsky, R. Kyle. 2016. <em><span>FedData</span>: Functions to Automate Downloading Geospatial Data Available from Several Federated Data Sources</em>. <a href="http://CRAN.R-project.org/package=FedData">http://CRAN.R-project.org/package=FedData</a>.
</div>
<div id="ref-cropscaper" class="csl-entry" role="listitem">
Chen, Bowen. 2020. <em>CropScapeR: Access Cropland Data Layer Data via the ’CropScape’ Web Service</em>.
</div>
<div id="ref-prism" class="csl-entry" role="listitem">
Hart, Edmund M., and Kendon Bell. 2015. <em>Prism: Download Data from the Oregon Prism Project</em>. <a href="https://doi.org/10.5281/zenodo.33663">https://doi.org/10.5281/zenodo.33663</a>.
</div>
<div id="ref-daymetr" class="csl-entry" role="listitem">
Hufkens, Koen, David Basler, Tom Milliman, Eli K. Melaas, and Andrew D. Richardson. 2018. <span>“An Integrated Phenology Modelling Framework in r: Modelling Vegetation Phenology with <span class="nocase">phenor</span>.”</span> <em>Methods in Ecology &amp; Evolution</em> 9: 1–10. <a href="http://onlinelibrary.wiley.com/doi/10.1111/2041-210X.12970/full">http://onlinelibrary.wiley.com/doi/10.1111/2041-210X.12970/full</a>.
</div>
<div id="ref-tidyUSDA" class="csl-entry" role="listitem">
Lindblad, Brad. 2020. <em><span class="nocase">tidyUSDA</span>: A Minimal Tool Set for Gathering USDA Quick Stat Data for Analysis and Visualization</em>. <a href="https://bradlindblad.github.io/tidyUSDA/">https://bradlindblad.github.io/tidyUSDA/</a>.
</div>
</div>
</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tmieno2\.github\.io\/R-as-GIS-for-Economists\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/07-CreateMaps-ggplot.html" class="pagination-link" aria-label="Creating Maps using `ggplot2`">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb133" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Download and process spatial datasets from within R {#sec-download-data}</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="fu">## Before you start {-}</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>There are many publicly available spatial datasets that can be downloaded using R. Programming data downloading using R instead of manually downloading data from websites can save lots of time and also enhances the reproducibility of your analysis. In this section, we will introduce some of such datasets and show how to download and process those data.  </span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direction for replication {-}</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>**Datasets**</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>No datasets to download for this Chapter.</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>**Packages**</span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Run the following code to install or load (if already installed) the <span class="in">`pacman`</span> package, and then install or load (if already installed) the listed package inside the <span class="in">`pacman::p_load()`</span> function.</span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Chap8_packages}</span></span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: false</span></span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require("pacman")) install.packages("pacman")</span></span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(</span></span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a><span class="in">  stars, # spatiotemporal data handling</span></span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a><span class="in">  terra, # raster data handling</span></span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a><span class="in">  raster, # raster data handling</span></span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a><span class="in">  sf, # vector data handling</span></span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr, # data wrangling</span></span>
<span id="cb133-26"><a href="#cb133-26" aria-hidden="true" tabindex="-1"></a><span class="in">  stringr, # string manipulation</span></span>
<span id="cb133-27"><a href="#cb133-27" aria-hidden="true" tabindex="-1"></a><span class="in">  lubridate, # dates handling</span></span>
<span id="cb133-28"><a href="#cb133-28" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table, # data wrangling</span></span>
<span id="cb133-29"><a href="#cb133-29" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyr, # reshape</span></span>
<span id="cb133-30"><a href="#cb133-30" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyUSDA, # download USDA NASS data</span></span>
<span id="cb133-31"><a href="#cb133-31" aria-hidden="true" tabindex="-1"></a><span class="in">  keyring, # API key management</span></span>
<span id="cb133-32"><a href="#cb133-32" aria-hidden="true" tabindex="-1"></a><span class="in">  FedData, # download Daymet data</span></span>
<span id="cb133-33"><a href="#cb133-33" aria-hidden="true" tabindex="-1"></a><span class="in">  daymetr, # download Daymet data</span></span>
<span id="cb133-34"><a href="#cb133-34" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot2, # make maps</span></span>
<span id="cb133-35"><a href="#cb133-35" aria-hidden="true" tabindex="-1"></a><span class="in">  ggthemes, # ggplot themes</span></span>
<span id="cb133-36"><a href="#cb133-36" aria-hidden="true" tabindex="-1"></a><span class="in">  future.apply, # parallel processing</span></span>
<span id="cb133-37"><a href="#cb133-37" aria-hidden="true" tabindex="-1"></a><span class="in">  CropScapeR, # download CDL data</span></span>
<span id="cb133-38"><a href="#cb133-38" aria-hidden="true" tabindex="-1"></a><span class="in">  prism, # download PRISM data</span></span>
<span id="cb133-39"><a href="#cb133-39" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr # extract raster values to sf</span></span>
<span id="cb133-40"><a href="#cb133-40" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-41"><a href="#cb133-41" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-42"><a href="#cb133-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-43"><a href="#cb133-43" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Run the following code to define the theme for map:</span>
<span id="cb133-44"><a href="#cb133-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-45"><a href="#cb133-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{r define_theme_Chap8, cache = F}</span></span>
<span id="cb133-46"><a href="#cb133-46" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot2::theme_set(theme_bw())</span></span>
<span id="cb133-47"><a href="#cb133-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-48"><a href="#cb133-48" aria-hidden="true" tabindex="-1"></a><span class="in">theme_for_map &lt;- theme(</span></span>
<span id="cb133-49"><a href="#cb133-49" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks = element_blank(),</span></span>
<span id="cb133-50"><a href="#cb133-50" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text = element_blank(),</span></span>
<span id="cb133-51"><a href="#cb133-51" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.line = element_blank(),</span></span>
<span id="cb133-52"><a href="#cb133-52" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.border = element_blank(),</span></span>
<span id="cb133-53"><a href="#cb133-53" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.major = element_line(color = "transparent"),</span></span>
<span id="cb133-54"><a href="#cb133-54" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.minor = element_line(color = "transparent"),</span></span>
<span id="cb133-55"><a href="#cb133-55" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.background = element_blank(),</span></span>
<span id="cb133-56"><a href="#cb133-56" aria-hidden="true" tabindex="-1"></a><span class="in">  plot.background = element_rect(fill = "transparent", color = "transparent")</span></span>
<span id="cb133-57"><a href="#cb133-57" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-58"><a href="#cb133-58" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-59"><a href="#cb133-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-60"><a href="#cb133-60" aria-hidden="true" tabindex="-1"></a><span class="fu">## USDA NASS QuickStat with `tidyUSDA` {#sec-nass-quick}</span></span>
<span id="cb133-61"><a href="#cb133-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-62"><a href="#cb133-62" aria-hidden="true" tabindex="-1"></a>There are several packages available to download data from the USDA NASS QuickStat. In this example, we will use the <span class="co">[</span><span class="ot">tidyUSDA package</span><span class="co">](https://github.com/bradlindblad/tidyUSDA)</span> <span class="co">[</span><span class="ot">@tidyUSDA</span><span class="co">]</span>. A great feature of tidyUSDA is that it allows you to download data as an <span class="in">`sf`</span> object, which means you can immediately visualize or spatially interact with other spatial data.</span>
<span id="cb133-63"><a href="#cb133-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-64"><a href="#cb133-64" aria-hidden="true" tabindex="-1"></a>The first step is to obtain an API key from the this <span class="co">[</span><span class="ot">website</span><span class="co">](https://quickstats.nass.usda.gov/api)</span>, as you will need it to download data.</span>
<span id="cb133-65"><a href="#cb133-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-66"><a href="#cb133-66" aria-hidden="true" tabindex="-1"></a>To download data, use the <span class="in">`tidyUSDA::getQuickstat()`</span> function. There are numerous options to narrow the scope of the data, such as <span class="in">`data_item`</span>, <span class="in">`geographic_level`</span>, <span class="in">`year`</span>, <span class="in">`commodity`</span>, and more. You can refer to the <span class="co">[</span><span class="ot">package manual</span><span class="co">](https://cran.r-project.org/web/packages/tidyUSDA/tidyUSDA.pdf)</span> for a complete list of available parameters.</span>
<span id="cb133-67"><a href="#cb133-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-68"><a href="#cb133-68" aria-hidden="true" tabindex="-1"></a>As an example, the code below downloads corn-related data by county in Illinois for the year 2016 as an sf object:</span>
<span id="cb133-69"><a href="#cb133-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-70"><a href="#cb133-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{r il_corn_download, eval = FALSE}</span></span>
<span id="cb133-71"><a href="#cb133-71" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-72"><a href="#cb133-72" aria-hidden="true" tabindex="-1"></a><span class="in">  IL_corn_yield &lt;-</span></span>
<span id="cb133-73"><a href="#cb133-73" aria-hidden="true" tabindex="-1"></a><span class="in">    getQuickstat(</span></span>
<span id="cb133-74"><a href="#cb133-74" aria-hidden="true" tabindex="-1"></a><span class="in">      #--- put your API key in place of key_get("usda_nass_qs_api") ---#</span></span>
<span id="cb133-75"><a href="#cb133-75" aria-hidden="true" tabindex="-1"></a><span class="in">      key = key_get("usda_nass_qs_api"),</span></span>
<span id="cb133-76"><a href="#cb133-76" aria-hidden="true" tabindex="-1"></a><span class="in">      program = "SURVEY",</span></span>
<span id="cb133-77"><a href="#cb133-77" aria-hidden="true" tabindex="-1"></a><span class="in">      commodity = "CORN",</span></span>
<span id="cb133-78"><a href="#cb133-78" aria-hidden="true" tabindex="-1"></a><span class="in">      geographic_level = "COUNTY",</span></span>
<span id="cb133-79"><a href="#cb133-79" aria-hidden="true" tabindex="-1"></a><span class="in">      state = "ILLINOIS",</span></span>
<span id="cb133-80"><a href="#cb133-80" aria-hidden="true" tabindex="-1"></a><span class="in">      year = "2016",</span></span>
<span id="cb133-81"><a href="#cb133-81" aria-hidden="true" tabindex="-1"></a><span class="in">      geometry = TRUE</span></span>
<span id="cb133-82"><a href="#cb133-82" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;%</span></span>
<span id="cb133-83"><a href="#cb133-83" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- keep only some of the variables ---#</span></span>
<span id="cb133-84"><a href="#cb133-84" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::select(</span></span>
<span id="cb133-85"><a href="#cb133-85" aria-hidden="true" tabindex="-1"></a><span class="in">      year, county_name, county_code, state_name,</span></span>
<span id="cb133-86"><a href="#cb133-86" aria-hidden="true" tabindex="-1"></a><span class="in">      state_fips_code, short_desc, Value</span></span>
<span id="cb133-87"><a href="#cb133-87" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb133-88"><a href="#cb133-88" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-89"><a href="#cb133-89" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-90"><a href="#cb133-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-91"><a href="#cb133-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r il_corn_disp, echo = F}</span></span>
<span id="cb133-92"><a href="#cb133-92" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(IL_corn_yield, "Data/il-corn-yield.rds")</span></span>
<span id="cb133-93"><a href="#cb133-93" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-94"><a href="#cb133-94" aria-hidden="true" tabindex="-1"></a><span class="in">  IL_corn_yield &lt;- readRDS("Data/il-corn-yield.rds")</span></span>
<span id="cb133-95"><a href="#cb133-95" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-96"><a href="#cb133-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-97"><a href="#cb133-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-98"><a href="#cb133-98" aria-hidden="true" tabindex="-1"></a>As you can see, the result is an sf object with a geometry column, thanks to the <span class="in">`geometry = TRUE`</span> option. This allows you to immediately create a map with the data (@fig-corn-yield-IL).</span>
<span id="cb133-99"><a href="#cb133-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-100"><a href="#cb133-100" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-103"><a href="#cb133-103" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-104"><a href="#cb133-104" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-corn-yield-IL</span></span>
<span id="cb133-105"><a href="#cb133-105" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Corn Yield (bu/acre) in Illinois in 2016"</span></span>
<span id="cb133-106"><a href="#cb133-106" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb133-107"><a href="#cb133-107" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb133-108"><a href="#cb133-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb133-109"><a href="#cb133-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">filter</span>(IL_corn_yield, short_desc <span class="sc">==</span> <span class="st">"CORN, GRAIN - YIELD, MEASURED IN BU / ACRE"</span>),</span>
<span id="cb133-110"><a href="#cb133-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> Value)</span>
<span id="cb133-111"><a href="#cb133-111" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb133-112"><a href="#cb133-112" aria-hidden="true" tabindex="-1"></a>  theme_for_map</span>
<span id="cb133-113"><a href="#cb133-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-114"><a href="#cb133-114" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-115"><a href="#cb133-115" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-116"><a href="#cb133-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-117"><a href="#cb133-117" aria-hidden="true" tabindex="-1"></a>You can also download data for multiple states and years simultaneously, as shown in the example below. If you want data for the entire U.S., simply omit the state parameter.</span>
<span id="cb133-118"><a href="#cb133-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-119"><a href="#cb133-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r il_co_ne_corn_download, eval = F}</span></span>
<span id="cb133-120"><a href="#cb133-120" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-121"><a href="#cb133-121" aria-hidden="true" tabindex="-1"></a><span class="in">  IL_CO_NE_corn &lt;-</span></span>
<span id="cb133-122"><a href="#cb133-122" aria-hidden="true" tabindex="-1"></a><span class="in">    getQuickstat(</span></span>
<span id="cb133-123"><a href="#cb133-123" aria-hidden="true" tabindex="-1"></a><span class="in">      key = key_get("usda_nass_qs_api"),</span></span>
<span id="cb133-124"><a href="#cb133-124" aria-hidden="true" tabindex="-1"></a><span class="in">      program = "SURVEY",</span></span>
<span id="cb133-125"><a href="#cb133-125" aria-hidden="true" tabindex="-1"></a><span class="in">      commodity = "CORN",</span></span>
<span id="cb133-126"><a href="#cb133-126" aria-hidden="true" tabindex="-1"></a><span class="in">      geographic_level = "COUNTY",</span></span>
<span id="cb133-127"><a href="#cb133-127" aria-hidden="true" tabindex="-1"></a><span class="in">      state = c("ILLINOIS", "COLORADO", "NEBRASKA"),</span></span>
<span id="cb133-128"><a href="#cb133-128" aria-hidden="true" tabindex="-1"></a><span class="in">      year = paste(2014:2018),</span></span>
<span id="cb133-129"><a href="#cb133-129" aria-hidden="true" tabindex="-1"></a><span class="in">      geometry = TRUE</span></span>
<span id="cb133-130"><a href="#cb133-130" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;%</span></span>
<span id="cb133-131"><a href="#cb133-131" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- keep only some of the variables ---#</span></span>
<span id="cb133-132"><a href="#cb133-132" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::select(</span></span>
<span id="cb133-133"><a href="#cb133-133" aria-hidden="true" tabindex="-1"></a><span class="in">      year, county_name, county_code, state_name,</span></span>
<span id="cb133-134"><a href="#cb133-134" aria-hidden="true" tabindex="-1"></a><span class="in">      state_fips_code, short_desc, Value</span></span>
<span id="cb133-135"><a href="#cb133-135" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb133-136"><a href="#cb133-136" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-137"><a href="#cb133-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-138"><a href="#cb133-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-139"><a href="#cb133-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{r il_co_ne_corn_disp, echo = F}</span></span>
<span id="cb133-140"><a href="#cb133-140" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(IL_CO_NE_corn, "Data/il-ne-corn-yield.rds")</span></span>
<span id="cb133-141"><a href="#cb133-141" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-142"><a href="#cb133-142" aria-hidden="true" tabindex="-1"></a><span class="in">  IL_CO_NE_corn &lt;- readRDS("Data/il-ne-corn-yield.rds")</span></span>
<span id="cb133-143"><a href="#cb133-143" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-144"><a href="#cb133-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-145"><a href="#cb133-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-146"><a href="#cb133-146" aria-hidden="true" tabindex="-1"></a><span class="fu">### Look for parameter values</span></span>
<span id="cb133-147"><a href="#cb133-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-148"><a href="#cb133-148" aria-hidden="true" tabindex="-1"></a>This package includes a function that allows you to view all possible parameter values for many of the parameters. For instance, if you know you want data on irrigated corn yields in Colorado but are unsure of the exact string to provide for the <span class="in">`data_item`</span> parameter, you can do the following:^<span class="co">[</span><span class="ot">Alternatively, you can visit the QuickStat website to find the correct text values.</span><span class="co">]</span></span>
<span id="cb133-149"><a href="#cb133-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-150"><a href="#cb133-150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r see_values_dataitem}</span></span>
<span id="cb133-151"><a href="#cb133-151" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get all the possible values for data_item ---#</span></span>
<span id="cb133-152"><a href="#cb133-152" aria-hidden="true" tabindex="-1"></a><span class="in">all_items &lt;- tidyUSDA::allDataItem</span></span>
<span id="cb133-153"><a href="#cb133-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-154"><a href="#cb133-154" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look at the first six ---#</span></span>
<span id="cb133-155"><a href="#cb133-155" aria-hidden="true" tabindex="-1"></a><span class="in">head(all_items)</span></span>
<span id="cb133-156"><a href="#cb133-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-157"><a href="#cb133-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-158"><a href="#cb133-158" aria-hidden="true" tabindex="-1"></a>You can use key words like "CORN", "YIELD", "IRRIGATED" to narrow the entire list using <span class="in">`grep()`</span>^<span class="co">[</span><span class="ot">`grep()` is part of the base package, so no additional package install is needed.</span><span class="co">]</span>: </span>
<span id="cb133-159"><a href="#cb133-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-160"><a href="#cb133-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb133-161"><a href="#cb133-161" aria-hidden="true" tabindex="-1"></a><span class="in">all_items %&gt;%</span></span>
<span id="cb133-162"><a href="#cb133-162" aria-hidden="true" tabindex="-1"></a><span class="in">  grep(pattern = "CORN", ., value = TRUE) %&gt;%</span></span>
<span id="cb133-163"><a href="#cb133-163" aria-hidden="true" tabindex="-1"></a><span class="in">  grep(pattern = "YIELD", ., value = TRUE) %&gt;%</span></span>
<span id="cb133-164"><a href="#cb133-164" aria-hidden="true" tabindex="-1"></a><span class="in">  grep(pattern = "IRRIGATED", ., value = TRUE)</span></span>
<span id="cb133-165"><a href="#cb133-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-166"><a href="#cb133-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-167"><a href="#cb133-167" aria-hidden="true" tabindex="-1"></a>Looking at the list, we know the exact text value we want, which is the first entry of the vector.</span>
<span id="cb133-168"><a href="#cb133-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-169"><a href="#cb133-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r co_corn_download, eval = F}</span></span>
<span id="cb133-170"><a href="#cb133-170" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-171"><a href="#cb133-171" aria-hidden="true" tabindex="-1"></a><span class="in">  CO_ir_corn_yield &lt;-</span></span>
<span id="cb133-172"><a href="#cb133-172" aria-hidden="true" tabindex="-1"></a><span class="in">    getQuickstat(</span></span>
<span id="cb133-173"><a href="#cb133-173" aria-hidden="true" tabindex="-1"></a><span class="in">      key = key_get("usda_nass_qs_api"),</span></span>
<span id="cb133-174"><a href="#cb133-174" aria-hidden="true" tabindex="-1"></a><span class="in">      program = "SURVEY",</span></span>
<span id="cb133-175"><a href="#cb133-175" aria-hidden="true" tabindex="-1"></a><span class="in">      data_item = "CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE",</span></span>
<span id="cb133-176"><a href="#cb133-176" aria-hidden="true" tabindex="-1"></a><span class="in">      geographic_level = "COUNTY",</span></span>
<span id="cb133-177"><a href="#cb133-177" aria-hidden="true" tabindex="-1"></a><span class="in">      state = "COLORADO",</span></span>
<span id="cb133-178"><a href="#cb133-178" aria-hidden="true" tabindex="-1"></a><span class="in">      year = "2018",</span></span>
<span id="cb133-179"><a href="#cb133-179" aria-hidden="true" tabindex="-1"></a><span class="in">      geometry = TRUE</span></span>
<span id="cb133-180"><a href="#cb133-180" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;%</span></span>
<span id="cb133-181"><a href="#cb133-181" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- keep only some of the variables ---#</span></span>
<span id="cb133-182"><a href="#cb133-182" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::select(year, NAME, county_code, short_desc, Value)</span></span>
<span id="cb133-183"><a href="#cb133-183" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-184"><a href="#cb133-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-185"><a href="#cb133-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-186"><a href="#cb133-186" aria-hidden="true" tabindex="-1"></a>Below is the complete list of functions that provide the possible values for the parameters used in <span class="in">`getQuickstat()`</span>.</span>
<span id="cb133-187"><a href="#cb133-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-188"><a href="#cb133-188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb133-189"><a href="#cb133-189" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allCategory</span></span>
<span id="cb133-190"><a href="#cb133-190" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allSector</span></span>
<span id="cb133-191"><a href="#cb133-191" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allGroup</span></span>
<span id="cb133-192"><a href="#cb133-192" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allCommodity</span></span>
<span id="cb133-193"><a href="#cb133-193" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allDomain</span></span>
<span id="cb133-194"><a href="#cb133-194" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allCounty</span></span>
<span id="cb133-195"><a href="#cb133-195" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allProgram</span></span>
<span id="cb133-196"><a href="#cb133-196" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allDataItem</span></span>
<span id="cb133-197"><a href="#cb133-197" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allState</span></span>
<span id="cb133-198"><a href="#cb133-198" aria-hidden="true" tabindex="-1"></a><span class="in">tidyUSDA::allGeogLevel</span></span>
<span id="cb133-199"><a href="#cb133-199" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-200"><a href="#cb133-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-201"><a href="#cb133-201" aria-hidden="true" tabindex="-1"></a><span class="fu">### Caveats</span></span>
<span id="cb133-202"><a href="#cb133-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-203"><a href="#cb133-203" aria-hidden="true" tabindex="-1"></a>You cannot retrieve more than $50,000$ rows of data (this limit is set by QuickStat). The query below requests far more than $50,000$ observations, and therefore, will fail. In such cases, you need to narrow your search and break the task into smaller, manageable queries.</span>
<span id="cb133-204"><a href="#cb133-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-205"><a href="#cb133-205" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cav_1, error = TRUE}</span></span>
<span id="cb133-206"><a href="#cb133-206" aria-hidden="true" tabindex="-1"></a><span class="in">#--- this results in an error ---#</span></span>
<span id="cb133-207"><a href="#cb133-207" aria-hidden="true" tabindex="-1"></a><span class="in">many_states_corn &lt;- </span></span>
<span id="cb133-208"><a href="#cb133-208" aria-hidden="true" tabindex="-1"></a><span class="in">  getQuickstat(</span></span>
<span id="cb133-209"><a href="#cb133-209" aria-hidden="true" tabindex="-1"></a><span class="in">    key = key_get("usda_nass_qs_api"),</span></span>
<span id="cb133-210"><a href="#cb133-210" aria-hidden="true" tabindex="-1"></a><span class="in">    program = "SURVEY",</span></span>
<span id="cb133-211"><a href="#cb133-211" aria-hidden="true" tabindex="-1"></a><span class="in">    commodity = "CORN",</span></span>
<span id="cb133-212"><a href="#cb133-212" aria-hidden="true" tabindex="-1"></a><span class="in">    geographic_level = "COUNTY",</span></span>
<span id="cb133-213"><a href="#cb133-213" aria-hidden="true" tabindex="-1"></a><span class="in">    state = c("ILLINOIS", "COLORADO", "NEBRASKA", "IOWA", "KANSAS"),</span></span>
<span id="cb133-214"><a href="#cb133-214" aria-hidden="true" tabindex="-1"></a><span class="in">    year = paste(1995:2018),</span></span>
<span id="cb133-215"><a href="#cb133-215" aria-hidden="true" tabindex="-1"></a><span class="in">    geometry = TRUE</span></span>
<span id="cb133-216"><a href="#cb133-216" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb133-217"><a href="#cb133-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-218"><a href="#cb133-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-219"><a href="#cb133-219" aria-hidden="true" tabindex="-1"></a>Another caveat is that a query will return an error if no observations meet your query criteria. For example, even though "CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE" is a valid value for data_item, there are no entries for this statistic in Illinois in 2018. As a result, the following query will fail.</span>
<span id="cb133-220"><a href="#cb133-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-221"><a href="#cb133-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cav_2, error = TRUE}</span></span>
<span id="cb133-222"><a href="#cb133-222" aria-hidden="true" tabindex="-1"></a><span class="in">many_states_corn &lt;-</span></span>
<span id="cb133-223"><a href="#cb133-223" aria-hidden="true" tabindex="-1"></a><span class="in">  getQuickstat(</span></span>
<span id="cb133-224"><a href="#cb133-224" aria-hidden="true" tabindex="-1"></a><span class="in">    key = key_get("usda_nass_qs_api"),</span></span>
<span id="cb133-225"><a href="#cb133-225" aria-hidden="true" tabindex="-1"></a><span class="in">    program = "SURVEY",</span></span>
<span id="cb133-226"><a href="#cb133-226" aria-hidden="true" tabindex="-1"></a><span class="in">    data_item = "CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE",</span></span>
<span id="cb133-227"><a href="#cb133-227" aria-hidden="true" tabindex="-1"></a><span class="in">    geographic_level = "COUNTY",</span></span>
<span id="cb133-228"><a href="#cb133-228" aria-hidden="true" tabindex="-1"></a><span class="in">    state = "ILLINOIS",</span></span>
<span id="cb133-229"><a href="#cb133-229" aria-hidden="true" tabindex="-1"></a><span class="in">    year = "2018",</span></span>
<span id="cb133-230"><a href="#cb133-230" aria-hidden="true" tabindex="-1"></a><span class="in">    geometry = TRUE</span></span>
<span id="cb133-231"><a href="#cb133-231" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb133-232"><a href="#cb133-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-233"><a href="#cb133-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-234"><a href="#cb133-234" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb133-235"><a href="#cb133-235" aria-hidden="true" tabindex="-1"></a><span class="co">#/*=================================================*/</span></span>
<span id="cb133-236"><a href="#cb133-236" aria-hidden="true" tabindex="-1"></a><span class="co">#' # CDL</span></span>
<span id="cb133-237"><a href="#cb133-237" aria-hidden="true" tabindex="-1"></a><span class="co">#/*=================================================*/</span></span>
<span id="cb133-238"><a href="#cb133-238" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb133-239"><a href="#cb133-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-240"><a href="#cb133-240" aria-hidden="true" tabindex="-1"></a><span class="fu">## CDL with `CropScapeR` {#sec-CropScapeR}</span></span>
<span id="cb133-241"><a href="#cb133-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-242"><a href="#cb133-242" aria-hidden="true" tabindex="-1"></a>The Cropland Data Layer (CDL) is a data product produced by the National Agricultural Statistics Service (NASS) of the U.S. Department of Agriculture. The CDL provides geo-referenced, high-accuracy crop-specific land cover information at 30-meter resolution (since 2007) or 56-meter resolution (in 2006 and 2007) for up to 48 contiguous U.S. states, covering data from 1997 to the present. This dataset has been widely used in agricultural research. <span class="co">[</span><span class="ot">CropScape</span><span class="co">](https://nassgeodata.gmu.edu/CropScape/)</span> is an interactive web-based system for exploring CDL data. It was developed to query, visualize, disseminate, and analyze CDL data geospatially using standard geospatial web services, all within a publicly accessible online environment (Han et al., 2012).</span>
<span id="cb133-243"><a href="#cb133-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-244"><a href="#cb133-244" aria-hidden="true" tabindex="-1"></a>This section demonstrates how to use the <span class="in">`CropScapeR`</span> package <span class="co">[</span><span class="ot">@cropscaper</span><span class="co">]</span> to download and explore CDL data. The package implements some of the most useful geospatial processing services provided by CropScape, allowing users to efficiently process CDL data within the R environment. The <span class="in">`CropScapeR`</span> package provides four key functions that implement different geospatial processing services offered by CropScape. This section introduces these functions with examples. The <span class="in">`CropScapeR::GetCDLData()`</span> function is particularly important, as it enables users to download raw CDL data. The other functions allow users to obtain CDL data that is summarized or transformed in specific ways to meet various needs.</span>
<span id="cb133-245"><a href="#cb133-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-246"><a href="#cb133-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include = F, message = F}</span></span>
<span id="cb133-247"><a href="#cb133-247" aria-hidden="true" tabindex="-1"></a><span class="in">httr::set_config(httr::config(ssl_verifypeer = 0L))</span></span>
<span id="cb133-248"><a href="#cb133-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-249"><a href="#cb133-249" aria-hidden="true" tabindex="-1"></a><span class="in"># data &lt;- GetCDLData(aoi = 17019, year = 2018, type = 'f', save_path = 'Data/data.tif')</span></span>
<span id="cb133-250"><a href="#cb133-250" aria-hidden="true" tabindex="-1"></a><span class="in">data &lt;- raster::raster("Data/data.tif")</span></span>
<span id="cb133-251"><a href="#cb133-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-252"><a href="#cb133-252" aria-hidden="true" tabindex="-1"></a><span class="in"># cdl_Champaign &lt;- GetCDLData(aoi = 17019, year = 2018, type = 'f', save_path = 'Data/ch.tif')</span></span>
<span id="cb133-253"><a href="#cb133-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-254"><a href="#cb133-254" aria-hidden="true" tabindex="-1"></a><span class="in">cdl_Champaign &lt;- raster::raster("Data/ch.tif")</span></span>
<span id="cb133-255"><a href="#cb133-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-256"><a href="#cb133-256" aria-hidden="true" tabindex="-1"></a><span class="in"># cdl_sf &lt;- GetCDLData(aoi = 17019, year = 2018, type = 'f', format = "sf", save_path = 'Data/cdl_sf.tif')</span></span>
<span id="cb133-257"><a href="#cb133-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-258"><a href="#cb133-258" aria-hidden="true" tabindex="-1"></a><span class="in">cdl_sf &lt;- raster::raster("Data/cdl_sf.tif")</span></span>
<span id="cb133-259"><a href="#cb133-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-260"><a href="#cb133-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-261"><a href="#cb133-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-262"><a href="#cb133-262" aria-hidden="true" tabindex="-1"></a><span class="fu">### `CropScapeR::GetCDLData`: Download the CDL data as raster data</span></span>
<span id="cb133-263"><a href="#cb133-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-264"><a href="#cb133-264" aria-hidden="true" tabindex="-1"></a>The function <span class="in">`CropScapeR::GetCDLData()`</span> allows us to obtain CDL data for any Area of Interest (AOI) for a given year. It requires three parameters to make a valid data request:</span>
<span id="cb133-265"><a href="#cb133-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-266"><a href="#cb133-266" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`aoi`</span>: The Area of Interest.</span>
<span id="cb133-267"><a href="#cb133-267" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>`year: The year for which the data is requested.</span>
<span id="cb133-268"><a href="#cb133-268" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`type`</span>: The type of AOI.</span>
<span id="cb133-269"><a href="#cb133-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-270"><a href="#cb133-270" aria-hidden="true" tabindex="-1"></a>The following AOI-type combinations are accepted:</span>
<span id="cb133-271"><a href="#cb133-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-272"><a href="#cb133-272" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>any spatial object as an <span class="in">`sf`</span> or <span class="in">`sfc`</span> object: <span class="in">`type = "b"`</span></span>
<span id="cb133-273"><a href="#cb133-273" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>county (defined by a 5-digit county FIPS code): <span class="in">`type = "f"`</span></span>
<span id="cb133-274"><a href="#cb133-274" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>state (defined by a 2-digit state FIPS code): <span class="in">`type = "f"`</span></span>
<span id="cb133-275"><a href="#cb133-275" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>bounding box (defined by four corner points): <span class="in">`type = "b"`</span></span>
<span id="cb133-276"><a href="#cb133-276" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>polygon area (defined by at least three coordinates): <span class="in">`type = "ps"`</span></span>
<span id="cb133-277"><a href="#cb133-277" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>single point (defined by a coordinate): <span class="in">`type = "p"`</span></span>
<span id="cb133-278"><a href="#cb133-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-279"><a href="#cb133-279" aria-hidden="true" tabindex="-1"></a>This section discusses how to download data for an <span class="in">`sf`</span> object, county, and state as they are likely to be the most common AOI. See its <span class="co">[</span><span class="ot">Github repository</span><span class="co">](https://github.com/cbw1243/CropScapeR)</span> to see how the other options work. </span>
<span id="cb133-280"><a href="#cb133-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-281"><a href="#cb133-281" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Downloading CDL data for `sf`, county, and state</span></span>
<span id="cb133-282"><a href="#cb133-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-283"><a href="#cb133-283" aria-hidden="true" tabindex="-1"></a>**Downloading CDL data for `sf`**</span>
<span id="cb133-284"><a href="#cb133-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-285"><a href="#cb133-285" aria-hidden="true" tabindex="-1"></a>Let’s download the 2018 CDL data for the area covering Champaign, Vermilion, Ford, and Iroquois counties in Illinois (@fig-IL4-map).</span>
<span id="cb133-286"><a href="#cb133-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-287"><a href="#cb133-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r IL_4_dips}</span></span>
<span id="cb133-288"><a href="#cb133-288" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the sf for all the counties in Illinois ---#</span></span>
<span id="cb133-289"><a href="#cb133-289" aria-hidden="true" tabindex="-1"></a><span class="in">IL_county &lt;-</span></span>
<span id="cb133-290"><a href="#cb133-290" aria-hidden="true" tabindex="-1"></a><span class="in">  tigris::counties(state = "IL", cb = TRUE, progress_bar = FALSE) %&gt;%</span></span>
<span id="cb133-291"><a href="#cb133-291" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sf()</span></span>
<span id="cb133-292"><a href="#cb133-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-293"><a href="#cb133-293" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the four counties  ---#</span></span>
<span id="cb133-294"><a href="#cb133-294" aria-hidden="true" tabindex="-1"></a><span class="in">IL_county_4 &lt;- dplyr::filter(IL_county, NAME %in% c("Champaign", "Vermilion", "Ford", "Iroquois"))</span></span>
<span id="cb133-295"><a href="#cb133-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-296"><a href="#cb133-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-297"><a href="#cb133-297" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-300"><a href="#cb133-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-301"><a href="#cb133-301" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-IL4-map</span></span>
<span id="cb133-302"><a href="#cb133-302" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb133-303"><a href="#cb133-303" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Location of the four counties in Illinois" </span></span>
<span id="cb133-304"><a href="#cb133-304" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb133-305"><a href="#cb133-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> IL_county) <span class="sc">+</span></span>
<span id="cb133-306"><a href="#cb133-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> IL_county_4, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb133-307"><a href="#cb133-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb133-308"><a href="#cb133-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-309"><a href="#cb133-309" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-310"><a href="#cb133-310" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-311"><a href="#cb133-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-312"><a href="#cb133-312" aria-hidden="true" tabindex="-1"></a>When using an <span class="in">`sf`</span> object for <span class="in">`aoi`</span>, the CDL data will be downloaded for the bounding box (hence <span class="in">`type = "b"`</span>) that encompasses the entire geographic area of the <span class="in">`sf`</span> object, regardless of the type of objects within it (whether they are points, polygons, or lines). In this case, the CDL data is downloaded for the red area shown in @fig-aoi-sf.</span>
<span id="cb133-313"><a href="#cb133-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-314"><a href="#cb133-314" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-315"><a href="#cb133-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r IL4-aoi-map}</span></span>
<span id="cb133-316"><a href="#cb133-316" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-aoi-sf</span></span>
<span id="cb133-317"><a href="#cb133-317" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Bounding box of the four counties" </span></span>
<span id="cb133-318"><a href="#cb133-318" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb133-319"><a href="#cb133-319" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb133-320"><a href="#cb133-320" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = IL_county) +</span></span>
<span id="cb133-321"><a href="#cb133-321" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = st_as_sfc(st_bbox(IL_county_4)), fill = "red", alpha = 0.4) +</span></span>
<span id="cb133-322"><a href="#cb133-322" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void()</span></span>
<span id="cb133-323"><a href="#cb133-323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-324"><a href="#cb133-324" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-325"><a href="#cb133-325" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-326"><a href="#cb133-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-327"><a href="#cb133-327" aria-hidden="true" tabindex="-1"></a>Let's now download CDL data for the four counties: </span>
<span id="cb133-328"><a href="#cb133-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-329"><a href="#cb133-329" aria-hidden="true" tabindex="-1"></a><span class="in">```{r IL4-download-disp, eval = F}</span></span>
<span id="cb133-330"><a href="#cb133-330" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-331"><a href="#cb133-331" aria-hidden="true" tabindex="-1"></a><span class="in">  cdl_IL_4 &lt;-</span></span>
<span id="cb133-332"><a href="#cb133-332" aria-hidden="true" tabindex="-1"></a><span class="in">    CropScapeR::GetCDLData(</span></span>
<span id="cb133-333"><a href="#cb133-333" aria-hidden="true" tabindex="-1"></a><span class="in">      aoi = IL_county_4,</span></span>
<span id="cb133-334"><a href="#cb133-334" aria-hidden="true" tabindex="-1"></a><span class="in">      year = "2018",</span></span>
<span id="cb133-335"><a href="#cb133-335" aria-hidden="true" tabindex="-1"></a><span class="in">      type = "b"</span></span>
<span id="cb133-336"><a href="#cb133-336" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb133-337"><a href="#cb133-337" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-338"><a href="#cb133-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-339"><a href="#cb133-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-340"><a href="#cb133-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r IL4-read, echo = F}</span></span>
<span id="cb133-341"><a href="#cb133-341" aria-hidden="true" tabindex="-1"></a><span class="in"># cdl_IL_4 &lt;- GetCDLData(</span></span>
<span id="cb133-342"><a href="#cb133-342" aria-hidden="true" tabindex="-1"></a><span class="in">#   aoi = IL_county_4,</span></span>
<span id="cb133-343"><a href="#cb133-343" aria-hidden="true" tabindex="-1"></a><span class="in">#   year = "2018",</span></span>
<span id="cb133-344"><a href="#cb133-344" aria-hidden="true" tabindex="-1"></a><span class="in">#   type = "b",</span></span>
<span id="cb133-345"><a href="#cb133-345" aria-hidden="true" tabindex="-1"></a><span class="in">#   save_path = "Data/IL4.tif",</span></span>
<span id="cb133-346"><a href="#cb133-346" aria-hidden="true" tabindex="-1"></a><span class="in">#   tol_time = 100</span></span>
<span id="cb133-347"><a href="#cb133-347" aria-hidden="true" tabindex="-1"></a><span class="in"># )</span></span>
<span id="cb133-348"><a href="#cb133-348" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-349"><a href="#cb133-349" aria-hidden="true" tabindex="-1"></a><span class="in">  cdl_IL_4 &lt;- raster("Data/IL4.tif")</span></span>
<span id="cb133-350"><a href="#cb133-350" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-351"><a href="#cb133-351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-352"><a href="#cb133-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-353"><a href="#cb133-353" aria-hidden="true" tabindex="-1"></a>As you can see, the downloaded data is a <span class="in">`RasterLayer`</span> object^<span class="co">[</span><span class="ot">an object class defined by the `raster` package. See @sec-raster-basics.</span><span class="co">]</span>. You might want to convert it to <span class="in">`SpatRaster`</span> if you are more familiar with the <span class="in">`terra`</span> package (@fig-il-4-cdl presents the map).</span>
<span id="cb133-354"><a href="#cb133-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-357"><a href="#cb133-357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-358"><a href="#cb133-358" aria-hidden="true" tabindex="-1"></a>cdl_IL_4 <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cdl_IL_4)</span>
<span id="cb133-359"><a href="#cb133-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-360"><a href="#cb133-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-361"><a href="#cb133-361" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-364"><a href="#cb133-364" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-365"><a href="#cb133-365" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-il-4-cdl</span></span>
<span id="cb133-366"><a href="#cb133-366" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of CDL values"</span></span>
<span id="cb133-367"><a href="#cb133-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb133-368"><a href="#cb133-368" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cdl_IL_4)</span>
<span id="cb133-369"><a href="#cb133-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-370"><a href="#cb133-370" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-371"><a href="#cb133-371" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-372"><a href="#cb133-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-373"><a href="#cb133-373" aria-hidden="true" tabindex="-1"></a>Note that the CDL data uses the Albers equal-area conic projection.</span>
<span id="cb133-374"><a href="#cb133-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-375"><a href="#cb133-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r proj-IL4}</span></span>
<span id="cb133-376"><a href="#cb133-376" aria-hidden="true" tabindex="-1"></a><span class="in">terra::crs(cdl_IL_4)</span></span>
<span id="cb133-377"><a href="#cb133-377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-378"><a href="#cb133-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-379"><a href="#cb133-379" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb133-380"><a href="#cb133-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-381"><a href="#cb133-381" aria-hidden="true" tabindex="-1"></a>**Downloading CDL data for county** </span>
<span id="cb133-382"><a href="#cb133-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-383"><a href="#cb133-383" aria-hidden="true" tabindex="-1"></a>The following code requests to download the CDL data for Champaign County, Illinois, for the year 2018 (@fig-cdl-champaign).</span>
<span id="cb133-384"><a href="#cb133-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-385"><a href="#cb133-385" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb133-386"><a href="#cb133-386" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-387"><a href="#cb133-387" aria-hidden="true" tabindex="-1"></a><span class="in">  cdl_Champaign &lt;- </span></span>
<span id="cb133-388"><a href="#cb133-388" aria-hidden="true" tabindex="-1"></a><span class="in">    CropScapeR::GetCDLData(aoi = 17019, year = 2018, type = "f") %&gt;%</span></span>
<span id="cb133-389"><a href="#cb133-389" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::rast()</span></span>
<span id="cb133-390"><a href="#cb133-390" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-391"><a href="#cb133-391" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-392"><a href="#cb133-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-393"><a href="#cb133-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo = F}</span></span>
<span id="cb133-394"><a href="#cb133-394" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-395"><a href="#cb133-395" aria-hidden="true" tabindex="-1"></a><span class="in">  cdl_Champaign &lt;- terra::rast("Data/ch.tif")</span></span>
<span id="cb133-396"><a href="#cb133-396" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-397"><a href="#cb133-397" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-398"><a href="#cb133-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-399"><a href="#cb133-399" aria-hidden="true" tabindex="-1"></a>In the above code, the FIPS code for Champaign County (17019) was supplied to the <span class="in">`aoi`</span> option. Because a county is used here, the <span class="in">`type`</span> argument is specified as <span class="in">`"f"`</span>. </span>
<span id="cb133-400"><a href="#cb133-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-401"><a href="#cb133-401" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-404"><a href="#cb133-404" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-405"><a href="#cb133-405" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cdl-champaign</span></span>
<span id="cb133-406"><a href="#cb133-406" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "CDL values for Champaign County in Illinois" </span></span>
<span id="cb133-407"><a href="#cb133-407" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb133-408"><a href="#cb133-408" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cdl_Champaign)</span>
<span id="cb133-409"><a href="#cb133-409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-410"><a href="#cb133-410" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-411"><a href="#cb133-411" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-412"><a href="#cb133-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-413"><a href="#cb133-413" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb133-414"><a href="#cb133-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-415"><a href="#cb133-415" aria-hidden="true" tabindex="-1"></a>**Downloading CDL data for state** </span>
<span id="cb133-416"><a href="#cb133-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-417"><a href="#cb133-417" aria-hidden="true" tabindex="-1"></a>The following code makes a request to download the CDL data for the state of Illinois in the year 2018 (@fig-cdl-illinois).</span>
<span id="cb133-418"><a href="#cb133-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-419"><a href="#cb133-419" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb133-420"><a href="#cb133-420" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-421"><a href="#cb133-421" aria-hidden="true" tabindex="-1"></a><span class="in">  cdl_IL &lt;- </span></span>
<span id="cb133-422"><a href="#cb133-422" aria-hidden="true" tabindex="-1"></a><span class="in">    CropScapeR::GetCDLData(aoi = 17, year = 2018, type = "f") %&gt;%</span></span>
<span id="cb133-423"><a href="#cb133-423" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::rast()</span></span>
<span id="cb133-424"><a href="#cb133-424" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-425"><a href="#cb133-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-426"><a href="#cb133-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-427"><a href="#cb133-427" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include = F}</span></span>
<span id="cb133-428"><a href="#cb133-428" aria-hidden="true" tabindex="-1"></a><span class="in"># (</span></span>
<span id="cb133-429"><a href="#cb133-429" aria-hidden="true" tabindex="-1"></a><span class="in"># cdl_IL &lt;- GetCDLData(aoi = 17, year = 2018, type = 'f', save_path = "Data/IL_cdl.tif", tol_time = 1000)</span></span>
<span id="cb133-430"><a href="#cb133-430" aria-hidden="true" tabindex="-1"></a><span class="in"># )</span></span>
<span id="cb133-431"><a href="#cb133-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-432"><a href="#cb133-432" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-433"><a href="#cb133-433" aria-hidden="true" tabindex="-1"></a><span class="in">  cdl_IL &lt;- terra::rast("Data/IL_cdl.tif")</span></span>
<span id="cb133-434"><a href="#cb133-434" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-435"><a href="#cb133-435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-436"><a href="#cb133-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-437"><a href="#cb133-437" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-440"><a href="#cb133-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-441"><a href="#cb133-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cdl-illinois</span></span>
<span id="cb133-442"><a href="#cb133-442" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "CDL values for Illinois" </span></span>
<span id="cb133-443"><a href="#cb133-443" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb133-444"><a href="#cb133-444" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cdl_IL)</span>
<span id="cb133-445"><a href="#cb133-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-446"><a href="#cb133-446" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-447"><a href="#cb133-447" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-448"><a href="#cb133-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-449"><a href="#cb133-449" aria-hidden="true" tabindex="-1"></a>In the above code, the state FIPS code for Illinois ($17$) was supplied to the <span class="in">`aoi`</span> option. Because a county is used here, the <span class="in">`type`</span> argument is specified as <span class="in">`"f"`</span>. </span>
<span id="cb133-450"><a href="#cb133-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-451"><a href="#cb133-451" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Other format options</span></span>
<span id="cb133-452"><a href="#cb133-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-453"><a href="#cb133-453" aria-hidden="true" tabindex="-1"></a>**GeoTiff**</span>
<span id="cb133-454"><a href="#cb133-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-455"><a href="#cb133-455" aria-hidden="true" tabindex="-1"></a>You can save the downloaded CDL data as a tif file by adding <span class="in">`save_path =`</span> option to <span class="in">`CropScapeR::GetCDLData()`</span> as follows:</span>
<span id="cb133-456"><a href="#cb133-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-457"><a href="#cb133-457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb133-458"><a href="#cb133-458" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-459"><a href="#cb133-459" aria-hidden="true" tabindex="-1"></a><span class="in">  cdl_IL_4 &lt;- </span></span>
<span id="cb133-460"><a href="#cb133-460" aria-hidden="true" tabindex="-1"></a><span class="in">    CropScapeR::GetCDLData(</span></span>
<span id="cb133-461"><a href="#cb133-461" aria-hidden="true" tabindex="-1"></a><span class="in">      aoi = IL_county_4,</span></span>
<span id="cb133-462"><a href="#cb133-462" aria-hidden="true" tabindex="-1"></a><span class="in">      year = "2018",</span></span>
<span id="cb133-463"><a href="#cb133-463" aria-hidden="true" tabindex="-1"></a><span class="in">      type = "b",</span></span>
<span id="cb133-464"><a href="#cb133-464" aria-hidden="true" tabindex="-1"></a><span class="in">      save_path = "Data/IL_4.tif"</span></span>
<span id="cb133-465"><a href="#cb133-465" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb133-466"><a href="#cb133-466" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-467"><a href="#cb133-467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-468"><a href="#cb133-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-469"><a href="#cb133-469" aria-hidden="true" tabindex="-1"></a>With this code, the downloaded data will be saved as "IL_4.tif" in the "Data" folder located in the current working directory.</span>
<span id="cb133-470"><a href="#cb133-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-471"><a href="#cb133-471" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb133-472"><a href="#cb133-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-473"><a href="#cb133-473" aria-hidden="true" tabindex="-1"></a>**sf**</span>
<span id="cb133-474"><a href="#cb133-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-475"><a href="#cb133-475" aria-hidden="true" tabindex="-1"></a>The <span class="in">`CropScapeR::GetCDLData()`</span> function lets you download CDL data as an <span class="in">`sf`</span> of points, where the coordinates of the points are the coordinates of the centroid of the raster cells. This can be done by adding <span class="in">`format = sf`</span> as an option. </span>
<span id="cb133-476"><a href="#cb133-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-477"><a href="#cb133-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb133-478"><a href="#cb133-478" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-479"><a href="#cb133-479" aria-hidden="true" tabindex="-1"></a><span class="in">  cdl_sf &lt;- CropScapeR::GetCDLData(aoi = 17019, year = 2018, type = "f", format = "sf")</span></span>
<span id="cb133-480"><a href="#cb133-480" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-481"><a href="#cb133-481" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-482"><a href="#cb133-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-483"><a href="#cb133-483" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include = F}</span></span>
<span id="cb133-484"><a href="#cb133-484" aria-hidden="true" tabindex="-1"></a><span class="in">cdl_sf</span></span>
<span id="cb133-485"><a href="#cb133-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-486"><a href="#cb133-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-487"><a href="#cb133-487" aria-hidden="true" tabindex="-1"></a>The first column (<span class="in">`value`</span>) is the crop code. Of course, you can manually convert a RasterLayer to an <span class="in">`sf`</span> of points as follows:</span>
<span id="cb133-488"><a href="#cb133-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-489"><a href="#cb133-489" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb133-490"><a href="#cb133-490" aria-hidden="true" tabindex="-1"></a>It is very unlikely that you need to have raster data as <span class="in">`sf`</span> rather then <span class="in">`RasterLayer`</span> or <span class="in">`SpatRaster`</span>.</span>
<span id="cb133-491"><a href="#cb133-491" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-492"><a href="#cb133-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-493"><a href="#cb133-493" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data processing after downloading data</span></span>
<span id="cb133-494"><a href="#cb133-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-495"><a href="#cb133-495" aria-hidden="true" tabindex="-1"></a>The downloaded raster data is not immediately ready for analysis. Typically, the variable of interest is the frequency of land use types or their shares. You can use <span class="in">`terra::freq()`</span> to obtain the frequency (i.e., the number of raster cells) for each land use type.</span>
<span id="cb133-496"><a href="#cb133-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-497"><a href="#cb133-497" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-freq}</span></span>
<span id="cb133-498"><a href="#cb133-498" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-499"><a href="#cb133-499" aria-hidden="true" tabindex="-1"></a><span class="in">  crop_freq &lt;- terra::freq(cdl_Champaign)</span></span>
<span id="cb133-500"><a href="#cb133-500" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-501"><a href="#cb133-501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-502"><a href="#cb133-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-503"><a href="#cb133-503" aria-hidden="true" tabindex="-1"></a>Clearly, once frequencies are found, you can easily get shares as well:</span>
<span id="cb133-504"><a href="#cb133-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-505"><a href="#cb133-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-share}</span></span>
<span id="cb133-506"><a href="#cb133-506" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-507"><a href="#cb133-507" aria-hidden="true" tabindex="-1"></a><span class="in">  crop_data &lt;- </span></span>
<span id="cb133-508"><a href="#cb133-508" aria-hidden="true" tabindex="-1"></a><span class="in">    crop_freq %&gt;%</span></span>
<span id="cb133-509"><a href="#cb133-509" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- matrix to data.frame ---#</span></span>
<span id="cb133-510"><a href="#cb133-510" aria-hidden="true" tabindex="-1"></a><span class="in">    data.frame(.) %&gt;%</span></span>
<span id="cb133-511"><a href="#cb133-511" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- find share ---#</span></span>
<span id="cb133-512"><a href="#cb133-512" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(share = count / sum(count))</span></span>
<span id="cb133-513"><a href="#cb133-513" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-514"><a href="#cb133-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-515"><a href="#cb133-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-516"><a href="#cb133-516" aria-hidden="true" tabindex="-1"></a>At this point, the data does not indicate which value corresponds to which crop. To find the crop names associated with the crop codes (value), you can use the reference table provided by the <span class="in">`CropScapeR`</span> package with <span class="in">`data(linkdata)`</span>.</span>
<span id="cb133-517"><a href="#cb133-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-520"><a href="#cb133-520" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-521"><a href="#cb133-521" aria-hidden="true" tabindex="-1"></a><span class="co">#--- load the crop code reference data ---#</span></span>
<span id="cb133-522"><a href="#cb133-522" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"linkdata"</span>, <span class="at">package =</span> <span class="st">"CropScapeR"</span>)</span>
<span id="cb133-523"><a href="#cb133-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-524"><a href="#cb133-524" aria-hidden="true" tabindex="-1"></a><span class="co">#--- take a look ---#</span></span>
<span id="cb133-525"><a href="#cb133-525" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(linkdata)</span>
<span id="cb133-526"><a href="#cb133-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-527"><a href="#cb133-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-528"><a href="#cb133-528" aria-hidden="true" tabindex="-1"></a>You can merge the two data sets using <span class="in">`value`</span> from the CDL data and <span class="in">`MasterCat`</span> from <span class="in">`linkdata`</span> as the merging keys:</span>
<span id="cb133-529"><a href="#cb133-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-530"><a href="#cb133-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb133-531"><a href="#cb133-531" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-532"><a href="#cb133-532" aria-hidden="true" tabindex="-1"></a><span class="in">  crop_data &lt;- dplyr::left_join(crop_data, linkdata, by = c("value" = "MasterCat"))</span></span>
<span id="cb133-533"><a href="#cb133-533" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-534"><a href="#cb133-534" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-535"><a href="#cb133-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-536"><a href="#cb133-536" aria-hidden="true" tabindex="-1"></a>The <span class="in">`NoData`</span> in the <span class="in">`Crop`</span> column corresponds to the black areas in the figure above, representing portions of the raster data that do not overlap with the boundary of Champaign County. You can remove these points with <span class="in">`NoData`</span> by using the <span class="in">`dplyr::filter`</span> function.</span>
<span id="cb133-537"><a href="#cb133-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-538"><a href="#cb133-538" aria-hidden="true" tabindex="-1"></a><span class="fu">### Other forms of CDL data</span></span>
<span id="cb133-539"><a href="#cb133-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-540"><a href="#cb133-540" aria-hidden="true" tabindex="-1"></a>Instead of downloading the raw CDL data, CropScape provides an option to download summarized CDL data.</span>
<span id="cb133-541"><a href="#cb133-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-542"><a href="#cb133-542" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`CropScapeR::GetCDLComp()`</span>: request data on land use changes</span>
<span id="cb133-543"><a href="#cb133-543" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`CropScapeR::GetCDLStat()`</span>: get acreage estimates from the CDL</span>
<span id="cb133-544"><a href="#cb133-544" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`CropScapeR::GetCDLImage()`</span>: download the image files of the CDL data</span>
<span id="cb133-545"><a href="#cb133-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-546"><a href="#cb133-546" aria-hidden="true" tabindex="-1"></a>These may come handy if they satisfy your needs because you can skip post-downloading processing steps. </span>
<span id="cb133-547"><a href="#cb133-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-548"><a href="#cb133-548" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb133-549"><a href="#cb133-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-550"><a href="#cb133-550" aria-hidden="true" tabindex="-1"></a>**`CropScapeR::GetCDLComp()`**: request data on land use changes</span>
<span id="cb133-551"><a href="#cb133-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-552"><a href="#cb133-552" aria-hidden="true" tabindex="-1"></a>The <span class="in">`CropScapeR::GetCDLComp()`</span> function allows users to request data on land cover changes over time from the CDL. Specifically, this function returns the acreage that has changed from one crop category to another between two years for a user-defined AOI.</span>
<span id="cb133-553"><a href="#cb133-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-554"><a href="#cb133-554" aria-hidden="true" tabindex="-1"></a>Let's look at an example. The following code requests data on acreage changes in land cover for Champaign County (<span class="in">`FIPS = 17019`</span>) from 2017 (<span class="in">`year1 = 2017`</span>) to 2018 (<span class="in">`year2 = 2018`</span>).</span>
<span id="cb133-555"><a href="#cb133-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-556"><a href="#cb133-556" aria-hidden="true" tabindex="-1"></a><span class="in">```{r getcdl-comp}</span></span>
<span id="cb133-557"><a href="#cb133-557" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-558"><a href="#cb133-558" aria-hidden="true" tabindex="-1"></a><span class="in">  data_change &lt;- CropScapeR::GetCDLComp(aoi = "17019", year1 = 2017, year2 = 2018, type = "f")</span></span>
<span id="cb133-559"><a href="#cb133-559" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-560"><a href="#cb133-560" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-561"><a href="#cb133-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-562"><a href="#cb133-562" aria-hidden="true" tabindex="-1"></a>The result is a <span class="in">`data.frame`</span> (or <span class="in">`data.table`</span>) with five columns. The <span class="in">`From`</span> and <span class="in">`To`</span> columns represent the crop names, <span class="in">`Count`</span> indicates the pixel count, and <span class="in">`Acreage`</span> provides the corresponding acreage for those pixel counts. The last column, <span class="in">`aoi`</span>, refers to the selected Area of Interest (AOI). For example, the first row of the returned data shows 40,362 acres of continuous corn during 2017 and 2018, while the third row shows 240,506 acres rotated from corn to soybeans over the same period.</span>
<span id="cb133-563"><a href="#cb133-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-564"><a href="#cb133-564" aria-hidden="true" tabindex="-1"></a>Keep in mind that the spatial resolution of the CDL changes from 56 meters to 30 meters starting in 2008. This means that when you request land-use changes from 2007 to 2008, the two CDL raster layers have different spatial resolutions. As a result, the CropScape API cannot resolve this issue and will return an error message such as "Mismatch size of file 1 and file 2."</span>
<span id="cb133-565"><a href="#cb133-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-566"><a href="#cb133-566" aria-hidden="true" tabindex="-1"></a>The <span class="in">`CropScapeR::GetCDLComp()`</span> function automatically addresses this problem by resampling the two CDL raster files using the nearest-neighbor resampling technique so that both rasters have the same spatial resolution. The finer-resolution raster is downscaled to match the lower resolution. The resampled raster layers are then merged to calculate cropland changes. Users can disable this default behavior by setting <span class="in">`manual_try = FALSE`</span>, in which case an error message from the CropScape API will be returned without land-use change results.</span>
<span id="cb133-567"><a href="#cb133-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-568"><a href="#cb133-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-569"><a href="#cb133-569" aria-hidden="true" tabindex="-1"></a><span class="in">```{r resolu-change, error = TRUE}</span></span>
<span id="cb133-570"><a href="#cb133-570" aria-hidden="true" tabindex="-1"></a><span class="in">data_change &lt;- CropScapeR::GetCDLComp(aoi = "17019", year1 = 2007, year2 = 2008, type = "f", `manual_try` = FALSE)</span></span>
<span id="cb133-571"><a href="#cb133-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-572"><a href="#cb133-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-573"><a href="#cb133-573" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb133-574"><a href="#cb133-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-575"><a href="#cb133-575" aria-hidden="true" tabindex="-1"></a>**`CropScapeR::GetCDLStat()`**: get acreage estimates from the CDL</span>
<span id="cb133-576"><a href="#cb133-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-577"><a href="#cb133-577" aria-hidden="true" tabindex="-1"></a>The <span class="in">`CropScapeR::GetCDLStat()`</span> function allows users to retrieve acreage by land cover category for a user-defined Area of Interest (AOI) in a specific year. For example, the following code requests data on acreage by land cover categories for Champaign County, Illinois, in 2018. You'll notice that the pixel counts are already converted to acres, and the corresponding category names are included.</span>
<span id="cb133-578"><a href="#cb133-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-579"><a href="#cb133-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r getcdl-stat, eval = F}</span></span>
<span id="cb133-580"><a href="#cb133-580" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-581"><a href="#cb133-581" aria-hidden="true" tabindex="-1"></a><span class="in">  data_stat &lt;- CropScapeR::GetCDLStat(aoi = 17019, year = 2018, type = "f")</span></span>
<span id="cb133-582"><a href="#cb133-582" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-583"><a href="#cb133-583" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-584"><a href="#cb133-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-585"><a href="#cb133-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo = F}</span></span>
<span id="cb133-586"><a href="#cb133-586" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(data_stat, "Data/cdl_stat.rds")</span></span>
<span id="cb133-587"><a href="#cb133-587" aria-hidden="true" tabindex="-1"></a><span class="in">readRDS("Data/cdl_stat.rds")</span></span>
<span id="cb133-588"><a href="#cb133-588" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-589"><a href="#cb133-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-590"><a href="#cb133-590" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb133-591"><a href="#cb133-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-592"><a href="#cb133-592" aria-hidden="true" tabindex="-1"></a>**`CropScapeR::GetCDLImage()`**: Download the image files of the CDL data</span>
<span id="cb133-593"><a href="#cb133-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-594"><a href="#cb133-594" aria-hidden="true" tabindex="-1"></a>The <span class="in">`CropScapeR::GetCDLImage`</span> function allows users to download image files of CDL data. This function works similarly to <span class="in">`CropScapeR::GetCDLData`</span>, except that it returns image files instead of data. It's particularly useful if you only want to visualize the CDL data. By default, the image is saved in "png" format, but you can also save it in "kml" format if needed.</span>
<span id="cb133-595"><a href="#cb133-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-596"><a href="#cb133-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-597"><a href="#cb133-597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r getcdl-image, eval = F}</span></span>
<span id="cb133-598"><a href="#cb133-598" aria-hidden="true" tabindex="-1"></a><span class="in">CropScapeR::GetCDLImage(aoi = 17019, year = 2018, type = "f", verbose = F)</span></span>
<span id="cb133-599"><a href="#cb133-599" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-600"><a href="#cb133-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-601"><a href="#cb133-601" aria-hidden="true" tabindex="-1"></a><span class="fu">## PRISM with `prism` {#sec-download-prism}</span></span>
<span id="cb133-602"><a href="#cb133-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-603"><a href="#cb133-603" aria-hidden="true" tabindex="-1"></a><span class="fu">### Basics</span></span>
<span id="cb133-604"><a href="#cb133-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-605"><a href="#cb133-605" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">PRISM dataset</span><span class="co">](https://prism.oregonstate.edu/)</span> provides model-based estimates of precipitation, maximum temperature (tmax), and minimum temperature (tmin) for the U.S. at a 4 km by 4 km spatial resolution. To download daily data, we can use the <span class="in">`prism::get_prism_dailys()`</span> function from the prism package <span class="co">[</span><span class="ot">@prism</span><span class="co">]</span>. Below is its general syntax:</span>
<span id="cb133-606"><a href="#cb133-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-607"><a href="#cb133-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prism_syntax, eval = F}</span></span>
<span id="cb133-608"><a href="#cb133-608" aria-hidden="true" tabindex="-1"></a><span class="in">#--- NOT RUN ---#</span></span>
<span id="cb133-609"><a href="#cb133-609" aria-hidden="true" tabindex="-1"></a><span class="in">prism::get_prism_dailys(</span></span>
<span id="cb133-610"><a href="#cb133-610" aria-hidden="true" tabindex="-1"></a><span class="in">  type = variable type,</span></span>
<span id="cb133-611"><a href="#cb133-611" aria-hidden="true" tabindex="-1"></a><span class="in">  minDate = starting date as character,</span></span>
<span id="cb133-612"><a href="#cb133-612" aria-hidden="true" tabindex="-1"></a><span class="in">  maxDate = ending date as character,</span></span>
<span id="cb133-613"><a href="#cb133-613" aria-hidden="true" tabindex="-1"></a><span class="in">  keepZip = TRUE or FALSE</span></span>
<span id="cb133-614"><a href="#cb133-614" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-615"><a href="#cb133-615" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-616"><a href="#cb133-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-617"><a href="#cb133-617" aria-hidden="true" tabindex="-1"></a>The variables types you can select from is <span class="in">`"ppt"`</span> (precipitation), <span class="in">`"tmean"`</span> (mean temperature), <span class="in">`"tmin"`</span> (minimum temperature), and <span class="in">`"tmax"`</span> (maximum temperature). For <span class="in">`minDate`</span> and <span class="in">`maxDate`</span>, the dates must be specified in a specific format of "YYYY-MM-DD". <span class="in">`keepZip = FALSE`</span> does not keep the zipped folders of the downloaded files as the name suggests. </span>
<span id="cb133-618"><a href="#cb133-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-619"><a href="#cb133-619" aria-hidden="true" tabindex="-1"></a>Before downloading PRISM data using the <span class="in">`prism::get_prism_dailys()`</span> function, it's recommended to set the path to the folder where the downloaded data will be stored using options(<span class="in">`prism.path = "path"`</span>). For example, the following code sets the path to <span class="in">`"Data/PRISM/"`</span> relative to the current working directory:</span>
<span id="cb133-620"><a href="#cb133-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-621"><a href="#cb133-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-622"><a href="#cb133-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r option-prism, eval = F}</span></span>
<span id="cb133-623"><a href="#cb133-623" aria-hidden="true" tabindex="-1"></a><span class="in">options(prism.path = "Data/PRISM/")</span></span>
<span id="cb133-624"><a href="#cb133-624" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-625"><a href="#cb133-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-626"><a href="#cb133-626" aria-hidden="true" tabindex="-1"></a>The following code downloads daily tmax data from January 1, 2000 to Jan 10, 2000.</span>
<span id="cb133-627"><a href="#cb133-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-628"><a href="#cb133-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ex, eval = F}</span></span>
<span id="cb133-629"><a href="#cb133-629" aria-hidden="true" tabindex="-1"></a><span class="in">prism::get_prism_dailys(</span></span>
<span id="cb133-630"><a href="#cb133-630" aria-hidden="true" tabindex="-1"></a><span class="in">  type = "tmax",</span></span>
<span id="cb133-631"><a href="#cb133-631" aria-hidden="true" tabindex="-1"></a><span class="in">  minDate = "2000-01-01",</span></span>
<span id="cb133-632"><a href="#cb133-632" aria-hidden="true" tabindex="-1"></a><span class="in">  maxDate = "2000-01-10",</span></span>
<span id="cb133-633"><a href="#cb133-633" aria-hidden="true" tabindex="-1"></a><span class="in">  keepZip = FALSE</span></span>
<span id="cb133-634"><a href="#cb133-634" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-635"><a href="#cb133-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-636"><a href="#cb133-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-637"><a href="#cb133-637" aria-hidden="true" tabindex="-1"></a>When you download data using the above code, you will notice that it creates one folder for one day. For example, for tmax data for "2000-01-01", you can get the path to the downloaded file as follows: </span>
<span id="cb133-638"><a href="#cb133-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-639"><a href="#cb133-639" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rule-folder}</span></span>
<span id="cb133-640"><a href="#cb133-640" aria-hidden="true" tabindex="-1"></a><span class="in">var_type &lt;- "tmax" # variable type</span></span>
<span id="cb133-641"><a href="#cb133-641" aria-hidden="true" tabindex="-1"></a><span class="in">dates_prism_txt &lt;- str_remove_all("2000-01-01", "-") # date without dashes</span></span>
<span id="cb133-642"><a href="#cb133-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-643"><a href="#cb133-643" aria-hidden="true" tabindex="-1"></a><span class="in">#--- folder name ---#</span></span>
<span id="cb133-644"><a href="#cb133-644" aria-hidden="true" tabindex="-1"></a><span class="in">folder_name &lt;- paste0("PRISM_", var_type, "_stable_4kmD2_", dates_prism_txt, "_bil")</span></span>
<span id="cb133-645"><a href="#cb133-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-646"><a href="#cb133-646" aria-hidden="true" tabindex="-1"></a><span class="in">#--- file name of the downloaded data inside the above folder ---#</span></span>
<span id="cb133-647"><a href="#cb133-647" aria-hidden="true" tabindex="-1"></a><span class="in">file_name &lt;- paste0("PRISM_", var_type, "_stable_4kmD2_", dates_prism_txt, "_bil.bil")</span></span>
<span id="cb133-648"><a href="#cb133-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-649"><a href="#cb133-649" aria-hidden="true" tabindex="-1"></a><span class="in">#--- path to the file relative to the designated data folder (here, it's "Data/PRISM/") ---#</span></span>
<span id="cb133-650"><a href="#cb133-650" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-651"><a href="#cb133-651" aria-hidden="true" tabindex="-1"></a><span class="in">  file_path &lt;- paste0("Data/PRISM/", folder_name, "/", file_name)</span></span>
<span id="cb133-652"><a href="#cb133-652" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-653"><a href="#cb133-653" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-654"><a href="#cb133-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-655"><a href="#cb133-655" aria-hidden="true" tabindex="-1"></a>We can then easily read the data using <span class="in">`terra::rast()`</span> or <span class="in">`stars::read_stars()`</span> if you prefer the <span class="in">`stars`</span> way.</span>
<span id="cb133-656"><a href="#cb133-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-657"><a href="#cb133-657" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read-prism-download}</span></span>
<span id="cb133-658"><a href="#cb133-658" aria-hidden="true" tabindex="-1"></a><span class="in">#--- as SpatRaster ---#</span></span>
<span id="cb133-659"><a href="#cb133-659" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-660"><a href="#cb133-660" aria-hidden="true" tabindex="-1"></a><span class="in">  prism_2000_01_01_sr &lt;- terra::rast(file_path)</span></span>
<span id="cb133-661"><a href="#cb133-661" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-662"><a href="#cb133-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-663"><a href="#cb133-663" aria-hidden="true" tabindex="-1"></a><span class="in">#--- as stars ---#</span></span>
<span id="cb133-664"><a href="#cb133-664" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-665"><a href="#cb133-665" aria-hidden="true" tabindex="-1"></a><span class="in">  prism_2000_01_01_stars &lt;- stars::read_stars(file_path)</span></span>
<span id="cb133-666"><a href="#cb133-666" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-667"><a href="#cb133-667" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-668"><a href="#cb133-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-669"><a href="#cb133-669" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-672"><a href="#cb133-672" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-673"><a href="#cb133-673" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-quick-viz</span></span>
<span id="cb133-674"><a href="#cb133-674" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "PRISM tmax data for January 1, 2000"</span></span>
<span id="cb133-675"><a href="#cb133-675" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb133-676"><a href="#cb133-676" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prism_2000_01_01_sr)</span>
<span id="cb133-677"><a href="#cb133-677" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-678"><a href="#cb133-678" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-679"><a href="#cb133-679" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-680"><a href="#cb133-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-681"><a href="#cb133-681" aria-hidden="true" tabindex="-1"></a>@fig-quick-viz presents a quick visualization of the data. As you can see, the dataset covers the entire contiguous U.S.</span>
<span id="cb133-682"><a href="#cb133-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-683"><a href="#cb133-683" aria-hidden="true" tabindex="-1"></a><span class="fu">### Download daily PRISM data for many years and build your own datasets</span></span>
<span id="cb133-684"><a href="#cb133-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-685"><a href="#cb133-685" aria-hidden="true" tabindex="-1"></a>Here, we provide an example of how to create your own PRISM datasets. Building such datasets and storing them locally can be beneficial if you plan to use the data for multiple projects in the future.</span>
<span id="cb133-686"><a href="#cb133-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-687"><a href="#cb133-687" aria-hidden="true" tabindex="-1"></a>Suppose we are interested in saving daily PRISM precipitation data by year and month, from 1980 to 2018. To accomplish this, we will write a loop that iterates over all year-month combinations. Before constructing the loop, let's start by working with a specific year-month combination—December 1990.</span>
<span id="cb133-688"><a href="#cb133-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-689"><a href="#cb133-689" aria-hidden="true" tabindex="-1"></a>We will write the code in a way that can be easily adapted for looped operations later. Specifically, we will define the following variables and use them as placeholders for the values that will be looped over.</span>
<span id="cb133-690"><a href="#cb133-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-691"><a href="#cb133-691" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb133-692"><a href="#cb133-692" aria-hidden="true" tabindex="-1"></a><span class="in">#--- month to work on ---#</span></span>
<span id="cb133-693"><a href="#cb133-693" aria-hidden="true" tabindex="-1"></a><span class="in">temp_month &lt;- 12</span></span>
<span id="cb133-694"><a href="#cb133-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-695"><a href="#cb133-695" aria-hidden="true" tabindex="-1"></a><span class="in">#--- year to work on ---#</span></span>
<span id="cb133-696"><a href="#cb133-696" aria-hidden="true" tabindex="-1"></a><span class="in">temp_year &lt;- 1990</span></span>
<span id="cb133-697"><a href="#cb133-697" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-698"><a href="#cb133-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-699"><a href="#cb133-699" aria-hidden="true" tabindex="-1"></a>We first need to set the path to the folder in which daily PRISM files will be downloaded. </span>
<span id="cb133-700"><a href="#cb133-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-701"><a href="#cb133-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r set-path}</span></span>
<span id="cb133-702"><a href="#cb133-702" aria-hidden="true" tabindex="-1"></a><span class="in">#--- set your own path ---#</span></span>
<span id="cb133-703"><a href="#cb133-703" aria-hidden="true" tabindex="-1"></a><span class="in">options(prism.path = "Data/PRISM/")</span></span>
<span id="cb133-704"><a href="#cb133-704" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-705"><a href="#cb133-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-706"><a href="#cb133-706" aria-hidden="true" tabindex="-1"></a>We then set the start and end dates for <span class="in">`prism::get_prism_dailys()`</span>.</span>
<span id="cb133-707"><a href="#cb133-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-708"><a href="#cb133-708" aria-hidden="true" tabindex="-1"></a><span class="in">```{r set-dates}</span></span>
<span id="cb133-709"><a href="#cb133-709" aria-hidden="true" tabindex="-1"></a><span class="in">#--- starting date of the working month-year ---#</span></span>
<span id="cb133-710"><a href="#cb133-710" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-711"><a href="#cb133-711" aria-hidden="true" tabindex="-1"></a><span class="in">  start_date &lt;- lubridate::dmy(paste0("1/", temp_month, "/", temp_year))</span></span>
<span id="cb133-712"><a href="#cb133-712" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-713"><a href="#cb133-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-714"><a href="#cb133-714" aria-hidden="true" tabindex="-1"></a><span class="in">#--- ending date: add a month and then go back 1 day ---#</span></span>
<span id="cb133-715"><a href="#cb133-715" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-716"><a href="#cb133-716" aria-hidden="true" tabindex="-1"></a><span class="in">  end_date &lt;- start_date %m+% months(1) - 1</span></span>
<span id="cb133-717"><a href="#cb133-717" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-718"><a href="#cb133-718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-719"><a href="#cb133-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-720"><a href="#cb133-720" aria-hidden="true" tabindex="-1"></a>We now download PRISM data for the year-month we are working on.</span>
<span id="cb133-721"><a href="#cb133-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-722"><a href="#cb133-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-prism-daily-month, eval = F}</span></span>
<span id="cb133-723"><a href="#cb133-723" aria-hidden="true" tabindex="-1"></a><span class="in">#--- download daily PRISM data for the working month-year ---#</span></span>
<span id="cb133-724"><a href="#cb133-724" aria-hidden="true" tabindex="-1"></a><span class="in">prism::get_prism_dailys(</span></span>
<span id="cb133-725"><a href="#cb133-725" aria-hidden="true" tabindex="-1"></a><span class="in">  type = "ppt",</span></span>
<span id="cb133-726"><a href="#cb133-726" aria-hidden="true" tabindex="-1"></a><span class="in">  minDate = as.character(start_date),</span></span>
<span id="cb133-727"><a href="#cb133-727" aria-hidden="true" tabindex="-1"></a><span class="in">  maxDate = as.character(end_date),</span></span>
<span id="cb133-728"><a href="#cb133-728" aria-hidden="true" tabindex="-1"></a><span class="in">  keepZip = FALSE</span></span>
<span id="cb133-729"><a href="#cb133-729" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-730"><a href="#cb133-730" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-731"><a href="#cb133-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-732"><a href="#cb133-732" aria-hidden="true" tabindex="-1"></a>Once all the data are downloaded, we will read and import them onto R. To do so, we will need the path to all the downloaded files.</span>
<span id="cb133-733"><a href="#cb133-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-734"><a href="#cb133-734" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-file-path}</span></span>
<span id="cb133-735"><a href="#cb133-735" aria-hidden="true" tabindex="-1"></a><span class="in">#--- list of dates of the working month-year ---#</span></span>
<span id="cb133-736"><a href="#cb133-736" aria-hidden="true" tabindex="-1"></a><span class="in">dates_ls &lt;- seq(start_date, end_date, "days")</span></span>
<span id="cb133-737"><a href="#cb133-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-738"><a href="#cb133-738" aria-hidden="true" tabindex="-1"></a><span class="in">#--- remove dashes ---#</span></span>
<span id="cb133-739"><a href="#cb133-739" aria-hidden="true" tabindex="-1"></a><span class="in">dates_prism_txt &lt;- stringr::str_remove_all(dates_ls, "-")</span></span>
<span id="cb133-740"><a href="#cb133-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-741"><a href="#cb133-741" aria-hidden="true" tabindex="-1"></a><span class="in">#--- folder names ---#</span></span>
<span id="cb133-742"><a href="#cb133-742" aria-hidden="true" tabindex="-1"></a><span class="in">folder_name &lt;- paste0("PRISM_", var_type, "_stable_4kmD2_", dates_prism_txt, "_bil")</span></span>
<span id="cb133-743"><a href="#cb133-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-744"><a href="#cb133-744" aria-hidden="true" tabindex="-1"></a><span class="in">#--- the file name of the downloaded data ---#</span></span>
<span id="cb133-745"><a href="#cb133-745" aria-hidden="true" tabindex="-1"></a><span class="in">file_name &lt;- paste0("PRISM_", var_type, "_stable_4kmD2_", dates_prism_txt, "_bil.bil")</span></span>
<span id="cb133-746"><a href="#cb133-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-747"><a href="#cb133-747" aria-hidden="true" tabindex="-1"></a><span class="in">#--- complete path to the downloaded files ---#</span></span>
<span id="cb133-748"><a href="#cb133-748" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-749"><a href="#cb133-749" aria-hidden="true" tabindex="-1"></a><span class="in">  file_path &lt;- paste0("Data/PRISM/", folder_name, "/", file_name)</span></span>
<span id="cb133-750"><a href="#cb133-750" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-751"><a href="#cb133-751" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-752"><a href="#cb133-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-753"><a href="#cb133-753" aria-hidden="true" tabindex="-1"></a>Next, we read the data as a <span class="in">`stars`</span> object, set the third dimension as the date using the <span class="in">`Date`</span> object class, and then save it as an R dataset. This ensures that the date dimension is preserved (see @sec-read-write-stars).</span>
<span id="cb133-754"><a href="#cb133-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-755"><a href="#cb133-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-756"><a href="#cb133-756" aria-hidden="true" tabindex="-1"></a><span class="in">```{r save-as-stars, eval = F}</span></span>
<span id="cb133-757"><a href="#cb133-757" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-758"><a href="#cb133-758" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- combine all the PRISM files as stars ---#</span></span>
<span id="cb133-759"><a href="#cb133-759" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_stars &lt;-</span></span>
<span id="cb133-760"><a href="#cb133-760" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::read_stars(file_path, along = 3) %&gt;%</span></span>
<span id="cb133-761"><a href="#cb133-761" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- set the third dimension as data ---#</span></span>
<span id="cb133-762"><a href="#cb133-762" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::st_set_dimensions("new_dim", values = dates_ls, name = "date")</span></span>
<span id="cb133-763"><a href="#cb133-763" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-764"><a href="#cb133-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-765"><a href="#cb133-765" aria-hidden="true" tabindex="-1"></a><span class="in">#--- save the stars as an rds file ---#</span></span>
<span id="cb133-766"><a href="#cb133-766" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(</span></span>
<span id="cb133-767"><a href="#cb133-767" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_stars,</span></span>
<span id="cb133-768"><a href="#cb133-768" aria-hidden="true" tabindex="-1"></a><span class="in">  paste0("Data/PRISM/PRISM_", var_type, "_y", temp_year, "_m", temp_month, ".rds")</span></span>
<span id="cb133-769"><a href="#cb133-769" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-770"><a href="#cb133-770" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-771"><a href="#cb133-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-772"><a href="#cb133-772" aria-hidden="true" tabindex="-1"></a>You could alternatively read the files into a <span class="in">`SpatRaster`</span> object and save it data as a GeoTIFF file.</span>
<span id="cb133-773"><a href="#cb133-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-774"><a href="#cb133-774" aria-hidden="true" tabindex="-1"></a><span class="in">```{r save-as-tiff, eval = F}</span></span>
<span id="cb133-775"><a href="#cb133-775" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-776"><a href="#cb133-776" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- combine all the PRISM files as a SpatRaster ---#</span></span>
<span id="cb133-777"><a href="#cb133-777" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_stars &lt;- terra::rast(file_path)</span></span>
<span id="cb133-778"><a href="#cb133-778" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-779"><a href="#cb133-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-780"><a href="#cb133-780" aria-hidden="true" tabindex="-1"></a><span class="in">#--- save as a multi-band GeoTIFF file ---#</span></span>
<span id="cb133-781"><a href="#cb133-781" aria-hidden="true" tabindex="-1"></a><span class="in">terra::writeRaster(temp_stars, paste0("Data/PRISM/PRISM_", var_type, "_y", temp_year, "_m", temp_month, ".tif"), overwrite = T)</span></span>
<span id="cb133-782"><a href="#cb133-782" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-783"><a href="#cb133-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-784"><a href="#cb133-784" aria-hidden="true" tabindex="-1"></a>Note that this option of course does not have date as the third dimension. Moreover, the RDS file above takes up only 14 Mb, while the tif file occupies 108 Mb.</span>
<span id="cb133-785"><a href="#cb133-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-786"><a href="#cb133-786" aria-hidden="true" tabindex="-1"></a>Finally, if you would like, you can delete all the individual PRISM files:</span>
<span id="cb133-787"><a href="#cb133-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-788"><a href="#cb133-788" aria-hidden="true" tabindex="-1"></a><span class="in">```{r remove-prism, eval = F}</span></span>
<span id="cb133-789"><a href="#cb133-789" aria-hidden="true" tabindex="-1"></a><span class="in">#--- delete all the downloaded files ---#</span></span>
<span id="cb133-790"><a href="#cb133-790" aria-hidden="true" tabindex="-1"></a><span class="in">unlink(paste0("Data/PRISM/", folder_name), recursive = TRUE)</span></span>
<span id="cb133-791"><a href="#cb133-791" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-792"><a href="#cb133-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-793"><a href="#cb133-793" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb133-794"><a href="#cb133-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-795"><a href="#cb133-795" aria-hidden="true" tabindex="-1"></a>Okay, now that we know what to do with a particular year-month combination, we can easily write a loop to go over all the year-month combinations for the period of interest. Since all the processes we observed above for a single year-month combination is embarrassingly parallel, it is easy to parallelize using <span class="in">`future.apply::future_lapply()`</span> or <span class="in">`parallel::mclapply()`</span> (Linux/Mac users only). Here we use <span class="in">`future_lapply()`</span> (see @sec-par-comp if you are not familiar with looping and parallel processing). Let's first get the number of logical cores.</span>
<span id="cb133-796"><a href="#cb133-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-797"><a href="#cb133-797" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_cores}</span></span>
<span id="cb133-798"><a href="#cb133-798" aria-hidden="true" tabindex="-1"></a><span class="in">num_cores &lt;- parallel::detectCores()</span></span>
<span id="cb133-799"><a href="#cb133-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-800"><a href="#cb133-800" aria-hidden="true" tabindex="-1"></a><span class="in">future::plan(multisession, workers = num_cores)</span></span>
<span id="cb133-801"><a href="#cb133-801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-802"><a href="#cb133-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-803"><a href="#cb133-803" aria-hidden="true" tabindex="-1"></a>The following function goes through all the steps we saw above for a single year-month combination.</span>
<span id="cb133-804"><a href="#cb133-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-805"><a href="#cb133-805" aria-hidden="true" tabindex="-1"></a><span class="in">```{r def-function}</span></span>
<span id="cb133-806"><a href="#cb133-806" aria-hidden="true" tabindex="-1"></a><span class="in">#--- define a function to download and save PRISM data stacked by month ---#</span></span>
<span id="cb133-807"><a href="#cb133-807" aria-hidden="true" tabindex="-1"></a><span class="in">get_save_prism &lt;- function(i, var_type) {</span></span>
<span id="cb133-808"><a href="#cb133-808" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb133-809"><a href="#cb133-809" aria-hidden="true" tabindex="-1"></a><span class="in">  #++++++++++++++++++++++++++++++++++++</span></span>
<span id="cb133-810"><a href="#cb133-810" aria-hidden="true" tabindex="-1"></a><span class="in">  #+ Debug</span></span>
<span id="cb133-811"><a href="#cb133-811" aria-hidden="true" tabindex="-1"></a><span class="in">  #++++++++++++++++++++++++++++++++++++</span></span>
<span id="cb133-812"><a href="#cb133-812" aria-hidden="true" tabindex="-1"></a><span class="in">  # i &lt;- 1</span></span>
<span id="cb133-813"><a href="#cb133-813" aria-hidden="true" tabindex="-1"></a><span class="in">  # var_type &lt;- "ppt"</span></span>
<span id="cb133-814"><a href="#cb133-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-815"><a href="#cb133-815" aria-hidden="true" tabindex="-1"></a><span class="in">  #++++++++++++++++++++++++++++++++++++</span></span>
<span id="cb133-816"><a href="#cb133-816" aria-hidden="true" tabindex="-1"></a><span class="in">  #+ Main</span></span>
<span id="cb133-817"><a href="#cb133-817" aria-hidden="true" tabindex="-1"></a><span class="in">  #++++++++++++++++++++++++++++++++++++</span></span>
<span id="cb133-818"><a href="#cb133-818" aria-hidden="true" tabindex="-1"></a><span class="in">  print(paste0("working on ", i))</span></span>
<span id="cb133-819"><a href="#cb133-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-820"><a href="#cb133-820" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_month &lt;- month_year_data[i, month] # working month</span></span>
<span id="cb133-821"><a href="#cb133-821" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_year &lt;- month_year_data[i, year] # working year</span></span>
<span id="cb133-822"><a href="#cb133-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-823"><a href="#cb133-823" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- starting date of the working month-year ---#</span></span>
<span id="cb133-824"><a href="#cb133-824" aria-hidden="true" tabindex="-1"></a><span class="in">  start_date &lt;- lubridate::dmy(paste0("1/", temp_month, "/", temp_year))</span></span>
<span id="cb133-825"><a href="#cb133-825" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- end date ---#</span></span>
<span id="cb133-826"><a href="#cb133-826" aria-hidden="true" tabindex="-1"></a><span class="in">  end_date &lt;- start_date %m+% months(1) - 1</span></span>
<span id="cb133-827"><a href="#cb133-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-828"><a href="#cb133-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-829"><a href="#cb133-829" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- download daily PRISM data for the working month-year ---#</span></span>
<span id="cb133-830"><a href="#cb133-830" aria-hidden="true" tabindex="-1"></a><span class="in">  prism::get_prism_dailys(</span></span>
<span id="cb133-831"><a href="#cb133-831" aria-hidden="true" tabindex="-1"></a><span class="in">    type = var_type,</span></span>
<span id="cb133-832"><a href="#cb133-832" aria-hidden="true" tabindex="-1"></a><span class="in">    minDate = as.character(start_date),</span></span>
<span id="cb133-833"><a href="#cb133-833" aria-hidden="true" tabindex="-1"></a><span class="in">    maxDate = as.character(end_date),</span></span>
<span id="cb133-834"><a href="#cb133-834" aria-hidden="true" tabindex="-1"></a><span class="in">    keepZip = FALSE</span></span>
<span id="cb133-835"><a href="#cb133-835" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb133-836"><a href="#cb133-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-837"><a href="#cb133-837" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- list of dates of the working month-year ---#</span></span>
<span id="cb133-838"><a href="#cb133-838" aria-hidden="true" tabindex="-1"></a><span class="in">  dates_ls &lt;- seq(start_date, end_date, "days")</span></span>
<span id="cb133-839"><a href="#cb133-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-840"><a href="#cb133-840" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- remove dashes ---#</span></span>
<span id="cb133-841"><a href="#cb133-841" aria-hidden="true" tabindex="-1"></a><span class="in">  dates_prism_txt &lt;- stringr::str_remove_all(dates_ls, "-")</span></span>
<span id="cb133-842"><a href="#cb133-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-843"><a href="#cb133-843" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- folder names ---#</span></span>
<span id="cb133-844"><a href="#cb133-844" aria-hidden="true" tabindex="-1"></a><span class="in">  folder_name &lt;- paste0("PRISM_", var_type, "_stable_4kmD2_", dates_prism_txt, "_bil")</span></span>
<span id="cb133-845"><a href="#cb133-845" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- the file name of the downloaded data ---#</span></span>
<span id="cb133-846"><a href="#cb133-846" aria-hidden="true" tabindex="-1"></a><span class="in">  file_name &lt;- paste0("PRISM_", var_type, "_stable_4kmD2_", dates_prism_txt, "_bil.bil")</span></span>
<span id="cb133-847"><a href="#cb133-847" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- complete path to the downloaded files ---#</span></span>
<span id="cb133-848"><a href="#cb133-848" aria-hidden="true" tabindex="-1"></a><span class="in">  file_path &lt;- paste0("Data/PRISM/", folder_name, "/", file_name)</span></span>
<span id="cb133-849"><a href="#cb133-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-850"><a href="#cb133-850" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- combine all the PRISM files as a SpatRaster ---#</span></span>
<span id="cb133-851"><a href="#cb133-851" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_stars &lt;-</span></span>
<span id="cb133-852"><a href="#cb133-852" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::rast(file_path) %&gt;%</span></span>
<span id="cb133-853"><a href="#cb133-853" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- convert to stars ---#</span></span>
<span id="cb133-854"><a href="#cb133-854" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::st_as_stars() %&gt;%</span></span>
<span id="cb133-855"><a href="#cb133-855" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- set the third dimension as data ---#</span></span>
<span id="cb133-856"><a href="#cb133-856" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::st_set_dimensions("band", values = dates_ls, name = "date")</span></span>
<span id="cb133-857"><a href="#cb133-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-858"><a href="#cb133-858" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- save the stars as an rds file ---#</span></span>
<span id="cb133-859"><a href="#cb133-859" aria-hidden="true" tabindex="-1"></a><span class="in">  saveRDS(</span></span>
<span id="cb133-860"><a href="#cb133-860" aria-hidden="true" tabindex="-1"></a><span class="in">    temp_stars,</span></span>
<span id="cb133-861"><a href="#cb133-861" aria-hidden="true" tabindex="-1"></a><span class="in">    paste0("Data/PRISM/PRISM_", var_type, "_y", temp_year, "_m", temp_month, ".rds")</span></span>
<span id="cb133-862"><a href="#cb133-862" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb133-863"><a href="#cb133-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-864"><a href="#cb133-864" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- delete all the downloaded files ---#</span></span>
<span id="cb133-865"><a href="#cb133-865" aria-hidden="true" tabindex="-1"></a><span class="in">  unlink(paste0("Data/PRISM/", folder_name), recursive = TRUE)</span></span>
<span id="cb133-866"><a href="#cb133-866" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb133-867"><a href="#cb133-867" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-868"><a href="#cb133-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-869"><a href="#cb133-869" aria-hidden="true" tabindex="-1"></a>We then create a <span class="in">`data.frame`</span> of all the year-month combinations: </span>
<span id="cb133-870"><a href="#cb133-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-871"><a href="#cb133-871" aria-hidden="true" tabindex="-1"></a><span class="in">```{r data_prep_par_ml}</span></span>
<span id="cb133-872"><a href="#cb133-872" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-873"><a href="#cb133-873" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- create a set of year-month combinations to loop over ---#</span></span>
<span id="cb133-874"><a href="#cb133-874" aria-hidden="true" tabindex="-1"></a><span class="in">  month_year_data &lt;- data.table::CJ(month = 1:12, year = 1990:2018)</span></span>
<span id="cb133-875"><a href="#cb133-875" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-876"><a href="#cb133-876" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-877"><a href="#cb133-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-878"><a href="#cb133-878" aria-hidden="true" tabindex="-1"></a>We now do parallelized loop over all the year-month combinations (by looping over the rows of <span class="in">`month_year_data`</span>):</span>
<span id="cb133-879"><a href="#cb133-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-880"><a href="#cb133-880" aria-hidden="true" tabindex="-1"></a><span class="in">```{r final-loop, eval = F}</span></span>
<span id="cb133-881"><a href="#cb133-881" aria-hidden="true" tabindex="-1"></a><span class="in">#--- run the above code in parallel ---#</span></span>
<span id="cb133-882"><a href="#cb133-882" aria-hidden="true" tabindex="-1"></a><span class="in">future.apply::future_lapply(</span></span>
<span id="cb133-883"><a href="#cb133-883" aria-hidden="true" tabindex="-1"></a><span class="in">  1:nrow(month_year_data),</span></span>
<span id="cb133-884"><a href="#cb133-884" aria-hidden="true" tabindex="-1"></a><span class="in">  function(x) get_save_prism(x, "ppt")</span></span>
<span id="cb133-885"><a href="#cb133-885" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-886"><a href="#cb133-886" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-887"><a href="#cb133-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-888"><a href="#cb133-888" aria-hidden="true" tabindex="-1"></a>That's it. Of course, you can do the same thing for <span class="in">`tmax`</span> by this:</span>
<span id="cb133-889"><a href="#cb133-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-890"><a href="#cb133-890" aria-hidden="true" tabindex="-1"></a><span class="in">```{r final-loop-tmax, eval = F}</span></span>
<span id="cb133-891"><a href="#cb133-891" aria-hidden="true" tabindex="-1"></a><span class="in">#--- run the above code in parallel ---#</span></span>
<span id="cb133-892"><a href="#cb133-892" aria-hidden="true" tabindex="-1"></a><span class="in">future.apply::future_lapply(</span></span>
<span id="cb133-893"><a href="#cb133-893" aria-hidden="true" tabindex="-1"></a><span class="in">  1:nrow(month_year_data),</span></span>
<span id="cb133-894"><a href="#cb133-894" aria-hidden="true" tabindex="-1"></a><span class="in">  function(x) get_save_prism(x, "tmax")</span></span>
<span id="cb133-895"><a href="#cb133-895" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-896"><a href="#cb133-896" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-897"><a href="#cb133-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-898"><a href="#cb133-898" aria-hidden="true" tabindex="-1"></a>Now that you have PRISM datasets, you can extract values from the raster layers for vector data for your analysis, which is covered extensively in Chapters @sec-int-RV and @sec-stars-basics (for <span class="in">`stars`</span> objects). </span>
<span id="cb133-899"><a href="#cb133-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-900"><a href="#cb133-900" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb133-901"><a href="#cb133-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-902"><a href="#cb133-902" aria-hidden="true" tabindex="-1"></a>If you want to save the data by year (each file would be about 168 Mb). You could do this.</span>
<span id="cb133-903"><a href="#cb133-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-904"><a href="#cb133-904" aria-hidden="true" tabindex="-1"></a><span class="in">```{r def-function-y, eval = F}</span></span>
<span id="cb133-905"><a href="#cb133-905" aria-hidden="true" tabindex="-1"></a><span class="in">#--- define a function to download and save PRISM data stacked by year ---#</span></span>
<span id="cb133-906"><a href="#cb133-906" aria-hidden="true" tabindex="-1"></a><span class="in">get_save_prism_y &lt;- function(temp_year, var_type) {</span></span>
<span id="cb133-907"><a href="#cb133-907" aria-hidden="true" tabindex="-1"></a><span class="in">  print(paste0("working on ", temp_year))</span></span>
<span id="cb133-908"><a href="#cb133-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-909"><a href="#cb133-909" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- starting date of the working month-year ---#</span></span>
<span id="cb133-910"><a href="#cb133-910" aria-hidden="true" tabindex="-1"></a><span class="in">  start_date &lt;- dmy(paste0("1/1/", temp_year))</span></span>
<span id="cb133-911"><a href="#cb133-911" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- end date ---#</span></span>
<span id="cb133-912"><a href="#cb133-912" aria-hidden="true" tabindex="-1"></a><span class="in">  end_date &lt;- dmy(paste0("1/1/", temp_year + 1)) - 1</span></span>
<span id="cb133-913"><a href="#cb133-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-914"><a href="#cb133-914" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- download daily PRISM data for the working month-year ---#</span></span>
<span id="cb133-915"><a href="#cb133-915" aria-hidden="true" tabindex="-1"></a><span class="in">  prism::get_prism_dailys(</span></span>
<span id="cb133-916"><a href="#cb133-916" aria-hidden="true" tabindex="-1"></a><span class="in">    type = var_type,</span></span>
<span id="cb133-917"><a href="#cb133-917" aria-hidden="true" tabindex="-1"></a><span class="in">    minDate = as.character(start_date),</span></span>
<span id="cb133-918"><a href="#cb133-918" aria-hidden="true" tabindex="-1"></a><span class="in">    maxDate = as.character(end_date),</span></span>
<span id="cb133-919"><a href="#cb133-919" aria-hidden="true" tabindex="-1"></a><span class="in">    keepZip = FALSE</span></span>
<span id="cb133-920"><a href="#cb133-920" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb133-921"><a href="#cb133-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-922"><a href="#cb133-922" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- list of dates of the working month-year ---#</span></span>
<span id="cb133-923"><a href="#cb133-923" aria-hidden="true" tabindex="-1"></a><span class="in">  dates_ls &lt;- seq(start_date, end_date, "days")</span></span>
<span id="cb133-924"><a href="#cb133-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-925"><a href="#cb133-925" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- remove dashes ---#</span></span>
<span id="cb133-926"><a href="#cb133-926" aria-hidden="true" tabindex="-1"></a><span class="in">  dates_prism_txt &lt;- stringr::str_remove_all(dates_ls, "-")</span></span>
<span id="cb133-927"><a href="#cb133-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-928"><a href="#cb133-928" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- folder names ---#</span></span>
<span id="cb133-929"><a href="#cb133-929" aria-hidden="true" tabindex="-1"></a><span class="in">  folder_name &lt;- paste0("PRISM_", var_type, "_stable_4kmD2_", dates_prism_txt, "_bil")</span></span>
<span id="cb133-930"><a href="#cb133-930" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- the file name of the downloaded data ---#</span></span>
<span id="cb133-931"><a href="#cb133-931" aria-hidden="true" tabindex="-1"></a><span class="in">  file_name &lt;- paste0("PRISM_", var_type, "_stable_4kmD2_", dates_prism_txt, "_bil.bil")</span></span>
<span id="cb133-932"><a href="#cb133-932" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- complete path to the downloaded files ---#</span></span>
<span id="cb133-933"><a href="#cb133-933" aria-hidden="true" tabindex="-1"></a><span class="in">  file_path &lt;- paste0("Data/PRISM/", folder_name, "/", file_name)</span></span>
<span id="cb133-934"><a href="#cb133-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-935"><a href="#cb133-935" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- combine all the PRISM files as a SpatRaster ---#</span></span>
<span id="cb133-936"><a href="#cb133-936" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_stars &lt;- </span></span>
<span id="cb133-937"><a href="#cb133-937" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::rast(file_path) %&gt;%</span></span>
<span id="cb133-938"><a href="#cb133-938" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- convert to stars ---#</span></span>
<span id="cb133-939"><a href="#cb133-939" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::st_as_stars() %&gt;%</span></span>
<span id="cb133-940"><a href="#cb133-940" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- set the third dimension as data ---#</span></span>
<span id="cb133-941"><a href="#cb133-941" aria-hidden="true" tabindex="-1"></a><span class="in">    stars::st_set_dimensions("band", values = dates_ls, name = "date")</span></span>
<span id="cb133-942"><a href="#cb133-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-943"><a href="#cb133-943" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- save the stars as an rds file ---#</span></span>
<span id="cb133-944"><a href="#cb133-944" aria-hidden="true" tabindex="-1"></a><span class="in">  saveRDS(</span></span>
<span id="cb133-945"><a href="#cb133-945" aria-hidden="true" tabindex="-1"></a><span class="in">    temp_stars,</span></span>
<span id="cb133-946"><a href="#cb133-946" aria-hidden="true" tabindex="-1"></a><span class="in">    paste0("Data/PRISM/PRISM_", var_type, "_y", temp_year, ".rds")</span></span>
<span id="cb133-947"><a href="#cb133-947" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb133-948"><a href="#cb133-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-949"><a href="#cb133-949" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- delete all the downloaded files ---#</span></span>
<span id="cb133-950"><a href="#cb133-950" aria-hidden="true" tabindex="-1"></a><span class="in">  unlink(paste0("Data/PRISM/", folder_name), recursive = TRUE)</span></span>
<span id="cb133-951"><a href="#cb133-951" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb133-952"><a href="#cb133-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-953"><a href="#cb133-953" aria-hidden="true" tabindex="-1"></a><span class="in">#--- run the above code in parallel ---#</span></span>
<span id="cb133-954"><a href="#cb133-954" aria-hidden="true" tabindex="-1"></a><span class="in">future_lapply(</span></span>
<span id="cb133-955"><a href="#cb133-955" aria-hidden="true" tabindex="-1"></a><span class="in">  1990:2018,</span></span>
<span id="cb133-956"><a href="#cb133-956" aria-hidden="true" tabindex="-1"></a><span class="in">  function(x) get_save_prism_y(x, "tmax")</span></span>
<span id="cb133-957"><a href="#cb133-957" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-958"><a href="#cb133-958" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-959"><a href="#cb133-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-960"><a href="#cb133-960" aria-hidden="true" tabindex="-1"></a><span class="fu">## Daymet with `daymetr` and `FedData` {#sec-daymetr}</span></span>
<span id="cb133-961"><a href="#cb133-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-962"><a href="#cb133-962" aria-hidden="true" tabindex="-1"></a>For this section, we use the <span class="in">`daymetr`</span> <span class="co">[</span><span class="ot">@daymetr</span><span class="co">]</span> and <span class="in">`FedData`</span> packages <span class="co">[</span><span class="ot">@feddata</span><span class="co">]</span>.</span>
<span id="cb133-963"><a href="#cb133-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-964"><a href="#cb133-964" aria-hidden="true" tabindex="-1"></a><span class="in">```{r daymetr_load}</span></span>
<span id="cb133-965"><a href="#cb133-965" aria-hidden="true" tabindex="-1"></a><span class="in">library(daymetr)</span></span>
<span id="cb133-966"><a href="#cb133-966" aria-hidden="true" tabindex="-1"></a><span class="in">library(FedData)</span></span>
<span id="cb133-967"><a href="#cb133-967" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-968"><a href="#cb133-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-969"><a href="#cb133-969" aria-hidden="true" tabindex="-1"></a>Daymet data consists of "tiles," each of which consisting of raster cells of 1km by 1km. @fig-daymet-tiles is the map of the tiles.</span>
<span id="cb133-970"><a href="#cb133-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-971"><a href="#cb133-971" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-974"><a href="#cb133-974" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-975"><a href="#cb133-975" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-daymet-tiles</span></span>
<span id="cb133-976"><a href="#cb133-976" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Daymet Tiles"</span></span>
<span id="cb133-977"><a href="#cb133-977" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb133-978"><a href="#cb133-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-979"><a href="#cb133-979" aria-hidden="true" tabindex="-1"></a>US_map <span class="ot">&lt;-</span> </span>
<span id="cb133-980"><a href="#cb133-980" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>(maps<span class="sc">::</span><span class="fu">map</span>(<span class="at">database =</span> <span class="st">"state"</span>, <span class="at">plot =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb133-981"><a href="#cb133-981" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="fu">st_crs</span>(tile_outlines))</span>
<span id="cb133-982"><a href="#cb133-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-983"><a href="#cb133-983" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb133-984"><a href="#cb133-984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_as_sf</span>(tile_outlines), <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb133-985"><a href="#cb133-985" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> US_map, <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb133-986"><a href="#cb133-986" aria-hidden="true" tabindex="-1"></a>  theme_for_map</span>
<span id="cb133-987"><a href="#cb133-987" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-988"><a href="#cb133-988" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-989"><a href="#cb133-989" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-990"><a href="#cb133-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-991"><a href="#cb133-991" aria-hidden="true" tabindex="-1"></a>Here is the list of weather variables:</span>
<span id="cb133-992"><a href="#cb133-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-993"><a href="#cb133-993" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>vapor pressure</span>
<span id="cb133-994"><a href="#cb133-994" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>minimum and maximum temperature</span>
<span id="cb133-995"><a href="#cb133-995" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>snow water equivalent</span>
<span id="cb133-996"><a href="#cb133-996" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>solar radiation</span>
<span id="cb133-997"><a href="#cb133-997" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>precipitation</span>
<span id="cb133-998"><a href="#cb133-998" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>day length</span>
<span id="cb133-999"><a href="#cb133-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1000"><a href="#cb133-1000" aria-hidden="true" tabindex="-1"></a>Daymet provides more weather variables than PRISM, which is useful for calculating weather-dependent metrics such as evapotranspiration.</span>
<span id="cb133-1001"><a href="#cb133-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1002"><a href="#cb133-1002" aria-hidden="true" tabindex="-1"></a>The easiest way to find Daymet values for your vector data depends on whether you are working with points or polygons. For point data, <span class="in">`daymetr::download_daymet()`</span> is the simplest option, as it directly returns weather values for the points of interest. Internally, it identifies the cell in which the point is located and returns the values for that cell over the specified period. <span class="in">`daymetr::download_daymet()`</span> handles all of this automatically.</span>
<span id="cb133-1003"><a href="#cb133-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1004"><a href="#cb133-1004" aria-hidden="true" tabindex="-1"></a>For polygons, however, you first need to download the relevant Daymet data for the region of interest and then extract the values for each polygon, a process covered in <span class="in">`FedData::get_daymet()`</span> downloads the requested Daymet data and saves it as a <span class="in">`RasterBrick`</span> object, which can be easily converted into a stars object using <span class="in">`stars::st_as_stars()`</span>.</span>
<span id="cb133-1005"><a href="#cb133-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1006"><a href="#cb133-1006" aria-hidden="true" tabindex="-1"></a><span class="fu">### For points data</span></span>
<span id="cb133-1007"><a href="#cb133-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1008"><a href="#cb133-1008" aria-hidden="true" tabindex="-1"></a>For points data, the easiest way to associate daily weather values to them is to use <span class="in">`daymetr::download_daymet()`</span>.</span>
<span id="cb133-1009"><a href="#cb133-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1010"><a href="#cb133-1010" aria-hidden="true" tabindex="-1"></a>Here are key parameters for the function:</span>
<span id="cb133-1011"><a href="#cb133-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1012"><a href="#cb133-1012" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`lat`</span>: latitude</span>
<span id="cb133-1013"><a href="#cb133-1013" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`lon`</span>: longitude</span>
<span id="cb133-1014"><a href="#cb133-1014" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`start`</span>: start_year</span>
<span id="cb133-1015"><a href="#cb133-1015" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`end`</span>: end_year</span>
<span id="cb133-1016"><a href="#cb133-1016" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`internal`</span>: <span class="in">`TRUE`</span> (dafault) or <span class="in">`FALSE`</span></span>
<span id="cb133-1017"><a href="#cb133-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1018"><a href="#cb133-1018" aria-hidden="true" tabindex="-1"></a>For example, the code below downloads daily weather data for a point (<span class="in">`lat`</span> = $36$, <span class="in">`longitude`</span> = $-100$) starting from 2000 through 2002 and assigns the downloaded data to <span class="in">`temp_daymet`</span>.</span>
<span id="cb133-1019"><a href="#cb133-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1020"><a href="#cb133-1020" aria-hidden="true" tabindex="-1"></a><span class="in">```{r download_daymet_point}</span></span>
<span id="cb133-1021"><a href="#cb133-1021" aria-hidden="true" tabindex="-1"></a><span class="in">#--- download daymet data ---#</span></span>
<span id="cb133-1022"><a href="#cb133-1022" aria-hidden="true" tabindex="-1"></a><span class="in">temp_daymet &lt;- </span></span>
<span id="cb133-1023"><a href="#cb133-1023" aria-hidden="true" tabindex="-1"></a><span class="in">  daymetr::download_daymet(</span></span>
<span id="cb133-1024"><a href="#cb133-1024" aria-hidden="true" tabindex="-1"></a><span class="in">    lat = 36,</span></span>
<span id="cb133-1025"><a href="#cb133-1025" aria-hidden="true" tabindex="-1"></a><span class="in">    lon = -100,</span></span>
<span id="cb133-1026"><a href="#cb133-1026" aria-hidden="true" tabindex="-1"></a><span class="in">    start = 2000,</span></span>
<span id="cb133-1027"><a href="#cb133-1027" aria-hidden="true" tabindex="-1"></a><span class="in">    end = 2002</span></span>
<span id="cb133-1028"><a href="#cb133-1028" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb133-1029"><a href="#cb133-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1030"><a href="#cb133-1030" aria-hidden="true" tabindex="-1"></a><span class="in">#--- structure ---#</span></span>
<span id="cb133-1031"><a href="#cb133-1031" aria-hidden="true" tabindex="-1"></a><span class="in">str(temp_daymet)</span></span>
<span id="cb133-1032"><a href="#cb133-1032" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1033"><a href="#cb133-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1034"><a href="#cb133-1034" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`temp_daymet`</span> has bunch of site information other than the weather data. You can get the weather data portion of <span class="in">`temp_daymet`</span> by accessing its <span class="in">`data`</span> element.</span>
<span id="cb133-1035"><a href="#cb133-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1036"><a href="#cb133-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_data_part}</span></span>
<span id="cb133-1037"><a href="#cb133-1037" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the data part ---#</span></span>
<span id="cb133-1038"><a href="#cb133-1038" aria-hidden="true" tabindex="-1"></a><span class="in">temp_daymet_data &lt;- temp_daymet$data</span></span>
<span id="cb133-1039"><a href="#cb133-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1040"><a href="#cb133-1040" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb133-1041"><a href="#cb133-1041" aria-hidden="true" tabindex="-1"></a><span class="in">head(temp_daymet_data)</span></span>
<span id="cb133-1042"><a href="#cb133-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1043"><a href="#cb133-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1044"><a href="#cb133-1044" aria-hidden="true" tabindex="-1"></a>As you might have noticed, <span class="in">`yday`</span> is not the date of each observation, but the day of the year. You can easily convert it into dates like this:</span>
<span id="cb133-1045"><a href="#cb133-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1046"><a href="#cb133-1046" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb133-1047"><a href="#cb133-1047" aria-hidden="true" tabindex="-1"></a><span class="in">temp_daymet_data &lt;- dplyr::mutate(temp_daymet_data, date = as.Date(paste(year, yday, sep = "-"), "%Y-%j"))</span></span>
<span id="cb133-1048"><a href="#cb133-1048" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1049"><a href="#cb133-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1050"><a href="#cb133-1050" aria-hidden="true" tabindex="-1"></a>Once dates are obtained, you can use the <span class="in">`lubridate`</span> package to extract day, month, and year using <span class="in">`day()`</span>, <span class="in">`month()`</span>, and <span class="in">`year()`</span>, respectively.</span>
<span id="cb133-1051"><a href="#cb133-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1052"><a href="#cb133-1052" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dates}</span></span>
<span id="cb133-1053"><a href="#cb133-1053" aria-hidden="true" tabindex="-1"></a><span class="in">temp_daymet_data &lt;- </span></span>
<span id="cb133-1054"><a href="#cb133-1054" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(temp_daymet_data,</span></span>
<span id="cb133-1055"><a href="#cb133-1055" aria-hidden="true" tabindex="-1"></a><span class="in">    day = lubridate::day(date),</span></span>
<span id="cb133-1056"><a href="#cb133-1056" aria-hidden="true" tabindex="-1"></a><span class="in">    month = lubridate::month(date),</span></span>
<span id="cb133-1057"><a href="#cb133-1057" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- this is already there though ---#</span></span>
<span id="cb133-1058"><a href="#cb133-1058" aria-hidden="true" tabindex="-1"></a><span class="in">    year = lubridate::year(date)</span></span>
<span id="cb133-1059"><a href="#cb133-1059" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb133-1060"><a href="#cb133-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1061"><a href="#cb133-1061" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb133-1062"><a href="#cb133-1062" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::select(temp_daymet_data, year, month, day) %&gt;% head()</span></span>
<span id="cb133-1063"><a href="#cb133-1063" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1064"><a href="#cb133-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1065"><a href="#cb133-1065" aria-hidden="true" tabindex="-1"></a>This helps you find group statistics like monthly precipitation.</span>
<span id="cb133-1066"><a href="#cb133-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1067"><a href="#cb133-1067" aria-hidden="true" tabindex="-1"></a><span class="in">```{r monthly_prcp}</span></span>
<span id="cb133-1068"><a href="#cb133-1068" aria-hidden="true" tabindex="-1"></a><span class="in">temp_daymet_data %&gt;%</span></span>
<span id="cb133-1069"><a href="#cb133-1069" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::group_by(month) %&gt;%</span></span>
<span id="cb133-1070"><a href="#cb133-1070" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::summarize(prcp = mean(prcp..mm.day.))</span></span>
<span id="cb133-1071"><a href="#cb133-1071" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1072"><a href="#cb133-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1073"><a href="#cb133-1073" aria-hidden="true" tabindex="-1"></a>Downloading Daymet data for many points is just applying the same operations above to them using a loop. Let's create random points within California and get their coordinates. </span>
<span id="cb133-1074"><a href="#cb133-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1075"><a href="#cb133-1075" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_random_poitns}</span></span>
<span id="cb133-1076"><a href="#cb133-1076" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(389548)</span></span>
<span id="cb133-1077"><a href="#cb133-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1078"><a href="#cb133-1078" aria-hidden="true" tabindex="-1"></a><span class="in">random_points &lt;-</span></span>
<span id="cb133-1079"><a href="#cb133-1079" aria-hidden="true" tabindex="-1"></a><span class="in">  tigris::counties(state = "CA", progress_bar = FALSE) %&gt;%</span></span>
<span id="cb133-1080"><a href="#cb133-1080" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sf() %&gt;%</span></span>
<span id="cb133-1081"><a href="#cb133-1081" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- 10 points ---#</span></span>
<span id="cb133-1082"><a href="#cb133-1082" aria-hidden="true" tabindex="-1"></a><span class="in">  st_sample(10) %&gt;%</span></span>
<span id="cb133-1083"><a href="#cb133-1083" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- get the coordinates ---#</span></span>
<span id="cb133-1084"><a href="#cb133-1084" aria-hidden="true" tabindex="-1"></a><span class="in">  st_coordinates() %&gt;%</span></span>
<span id="cb133-1085"><a href="#cb133-1085" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- as tibble (data.frame) ---#</span></span>
<span id="cb133-1086"><a href="#cb133-1086" aria-hidden="true" tabindex="-1"></a><span class="in">  as_tibble() %&gt;%</span></span>
<span id="cb133-1087"><a href="#cb133-1087" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- assign site id ---#</span></span>
<span id="cb133-1088"><a href="#cb133-1088" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(site_id = 1:n())</span></span>
<span id="cb133-1089"><a href="#cb133-1089" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1090"><a href="#cb133-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1091"><a href="#cb133-1091" aria-hidden="true" tabindex="-1"></a>To loop over the points, you can first write a function like this:</span>
<span id="cb133-1092"><a href="#cb133-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1093"><a href="#cb133-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb133-1094"><a href="#cb133-1094" aria-hidden="true" tabindex="-1"></a><span class="in">get_daymet &lt;- function(i) {</span></span>
<span id="cb133-1095"><a href="#cb133-1095" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_lat &lt;- random_points[i, ] %&gt;% pull(Y)</span></span>
<span id="cb133-1096"><a href="#cb133-1096" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_lon &lt;- random_points[i, ] %&gt;% pull(X)</span></span>
<span id="cb133-1097"><a href="#cb133-1097" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_site &lt;- random_points[i, ] %&gt;% pull(site_id)</span></span>
<span id="cb133-1098"><a href="#cb133-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1099"><a href="#cb133-1099" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_daymet &lt;- download_daymet(</span></span>
<span id="cb133-1100"><a href="#cb133-1100" aria-hidden="true" tabindex="-1"></a><span class="in">    lat = temp_lat,</span></span>
<span id="cb133-1101"><a href="#cb133-1101" aria-hidden="true" tabindex="-1"></a><span class="in">    lon = temp_lon,</span></span>
<span id="cb133-1102"><a href="#cb133-1102" aria-hidden="true" tabindex="-1"></a><span class="in">    start = 2000,</span></span>
<span id="cb133-1103"><a href="#cb133-1103" aria-hidden="true" tabindex="-1"></a><span class="in">    end = 2002</span></span>
<span id="cb133-1104"><a href="#cb133-1104" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb133-1105"><a href="#cb133-1105" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- just get the data part ---#</span></span>
<span id="cb133-1106"><a href="#cb133-1106" aria-hidden="true" tabindex="-1"></a><span class="in">    .$data %&gt;%</span></span>
<span id="cb133-1107"><a href="#cb133-1107" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- convert to tibble (not strictly necessary) ---#</span></span>
<span id="cb133-1108"><a href="#cb133-1108" aria-hidden="true" tabindex="-1"></a><span class="in">    as_tibble() %&gt;%</span></span>
<span id="cb133-1109"><a href="#cb133-1109" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- assign site_id so you know which record is for which site_id ---#</span></span>
<span id="cb133-1110"><a href="#cb133-1110" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(site_id = temp_site) %&gt;%</span></span>
<span id="cb133-1111"><a href="#cb133-1111" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- get date from day of the year ---#</span></span>
<span id="cb133-1112"><a href="#cb133-1112" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(date = as.Date(paste(year, yday, sep = "-"), "%Y-%j"))</span></span>
<span id="cb133-1113"><a href="#cb133-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1114"><a href="#cb133-1114" aria-hidden="true" tabindex="-1"></a><span class="in">  return(temp_daymet)</span></span>
<span id="cb133-1115"><a href="#cb133-1115" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb133-1116"><a href="#cb133-1116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1117"><a href="#cb133-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1118"><a href="#cb133-1118" aria-hidden="true" tabindex="-1"></a>Here is what the function returns for the 1st row of <span class="in">`random_points`</span>:</span>
<span id="cb133-1119"><a href="#cb133-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1120"><a href="#cb133-1120" aria-hidden="true" tabindex="-1"></a><span class="in">```{r first_daymet}</span></span>
<span id="cb133-1121"><a href="#cb133-1121" aria-hidden="true" tabindex="-1"></a><span class="in">get_daymet(1)</span></span>
<span id="cb133-1122"><a href="#cb133-1122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1123"><a href="#cb133-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1124"><a href="#cb133-1124" aria-hidden="true" tabindex="-1"></a>You can now simply loop over the rows.</span>
<span id="cb133-1125"><a href="#cb133-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1126"><a href="#cb133-1126" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loop_daymet, eval = F}</span></span>
<span id="cb133-1127"><a href="#cb133-1127" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-1128"><a href="#cb133-1128" aria-hidden="true" tabindex="-1"></a><span class="in">  daymet_all_points &lt;- </span></span>
<span id="cb133-1129"><a href="#cb133-1129" aria-hidden="true" tabindex="-1"></a><span class="in">    lapply(1:nrow(random_points), get_daymet) %&gt;%</span></span>
<span id="cb133-1130"><a href="#cb133-1130" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- need to combine the list of data.frames into a single data.frame ---#</span></span>
<span id="cb133-1131"><a href="#cb133-1131" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::bind_rows()</span></span>
<span id="cb133-1132"><a href="#cb133-1132" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1133"><a href="#cb133-1133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1134"><a href="#cb133-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1135"><a href="#cb133-1135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r disp_daymet, echo = F}</span></span>
<span id="cb133-1136"><a href="#cb133-1136" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(daymet_all_points, "Data/daymet_all_points.rds")</span></span>
<span id="cb133-1137"><a href="#cb133-1137" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-1138"><a href="#cb133-1138" aria-hidden="true" tabindex="-1"></a><span class="in">  daymet_all_points &lt;- readRDS("Data/daymet_all_points.rds")</span></span>
<span id="cb133-1139"><a href="#cb133-1139" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1140"><a href="#cb133-1140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1141"><a href="#cb133-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1142"><a href="#cb133-1142" aria-hidden="true" tabindex="-1"></a>Or better yet, you can easily parallelize this process as follows (see @sec-par-comp if you are not familiar with parallelization in R):</span>
<span id="cb133-1143"><a href="#cb133-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1144"><a href="#cb133-1144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r par_daymet, eval = F}</span></span>
<span id="cb133-1145"><a href="#cb133-1145" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallelization planning ---#</span></span>
<span id="cb133-1146"><a href="#cb133-1146" aria-hidden="true" tabindex="-1"></a><span class="in">future::plan(multisession, workers = parallel::detectCores() - 1)</span></span>
<span id="cb133-1147"><a href="#cb133-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1148"><a href="#cb133-1148" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallelized lapply ---#</span></span>
<span id="cb133-1149"><a href="#cb133-1149" aria-hidden="true" tabindex="-1"></a><span class="in">daymet_all_points &lt;- </span></span>
<span id="cb133-1150"><a href="#cb133-1150" aria-hidden="true" tabindex="-1"></a><span class="in">  future.apply::future_lapply(1:nrow(random_points), get_daymet) %&gt;%</span></span>
<span id="cb133-1151"><a href="#cb133-1151" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- need to combine the list of data.frames into a single data.frame ---#</span></span>
<span id="cb133-1152"><a href="#cb133-1152" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::bind_rows()</span></span>
<span id="cb133-1153"><a href="#cb133-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1154"><a href="#cb133-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1155"><a href="#cb133-1155" aria-hidden="true" tabindex="-1"></a><span class="fu">### For polygons data {#sec-daymet-poly}</span></span>
<span id="cb133-1156"><a href="#cb133-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1157"><a href="#cb133-1157" aria-hidden="true" tabindex="-1"></a>Suppose you are interested in getting Daymet data for select counties in Michigan (@fig-michi-fig).</span>
<span id="cb133-1158"><a href="#cb133-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1159"><a href="#cb133-1159" aria-hidden="true" tabindex="-1"></a><span class="in">```{r MI_counties}</span></span>
<span id="cb133-1160"><a href="#cb133-1160" aria-hidden="true" tabindex="-1"></a><span class="in">#--- entire MI ---#</span></span>
<span id="cb133-1161"><a href="#cb133-1161" aria-hidden="true" tabindex="-1"></a><span class="in">MI_counties &lt;- tigris::counties(state = "MI", cb = TRUE, progress_bar = FALSE)</span></span>
<span id="cb133-1162"><a href="#cb133-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1163"><a href="#cb133-1163" aria-hidden="true" tabindex="-1"></a><span class="in">#--- select counties ---#</span></span>
<span id="cb133-1164"><a href="#cb133-1164" aria-hidden="true" tabindex="-1"></a><span class="in">MI_counties_select &lt;- dplyr::filter(MI_counties, NAME %in% c("Luce", "Chippewa", "Mackinac"))</span></span>
<span id="cb133-1165"><a href="#cb133-1165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1166"><a href="#cb133-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1167"><a href="#cb133-1167" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-1170"><a href="#cb133-1170" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-1171"><a href="#cb133-1171" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-michi-fig</span></span>
<span id="cb133-1172"><a href="#cb133-1172" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Select Michigan counties for which we download Daymet data"</span></span>
<span id="cb133-1173"><a href="#cb133-1173" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb133-1174"><a href="#cb133-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1175"><a href="#cb133-1175" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb133-1176"><a href="#cb133-1176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> MI_counties, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb133-1177"><a href="#cb133-1177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> MI_counties_select, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb133-1178"><a href="#cb133-1178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb133-1179"><a href="#cb133-1179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1180"><a href="#cb133-1180" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-1181"><a href="#cb133-1181" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-1182"><a href="#cb133-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1183"><a href="#cb133-1183" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`FedData::get_daymet()`</span> to download Daymet data that covers the spatial extent of the polygon data. The downloaded dataset can be assigned to an R object as a <span class="in">`RasterBrick`</span>, or alternatively, you could write the downloaded data to a file. To specify the spatial extent for which Daymet data should be downloaded, we provide a <span class="in">`SpatialPolygonsDataFrame`</span> object supported by the <span class="in">`sp`</span> package. Since we primarily handle vector data with the <span class="in">`sf`</span> package, we need to convert the <span class="in">`sf`</span> object to an <span class="in">`sp`</span> object.</span>
<span id="cb133-1184"><a href="#cb133-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1185"><a href="#cb133-1185" aria-hidden="true" tabindex="-1"></a>The code below downloads <span class="in">`prcp`</span> and <span class="in">`tmax`</span> for the spatial extent of Michigan counties for 2000 and 2001:</span>
<span id="cb133-1186"><a href="#cb133-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1187"><a href="#cb133-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```{r MI_daymet_download, eval = F}</span></span>
<span id="cb133-1188"><a href="#cb133-1188" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-1189"><a href="#cb133-1189" aria-hidden="true" tabindex="-1"></a><span class="in">  MI_daymet_select &lt;- </span></span>
<span id="cb133-1190"><a href="#cb133-1190" aria-hidden="true" tabindex="-1"></a><span class="in">    FedData::get_daymet(</span></span>
<span id="cb133-1191"><a href="#cb133-1191" aria-hidden="true" tabindex="-1"></a><span class="in">      #--- supply the vector data in sp ---#</span></span>
<span id="cb133-1192"><a href="#cb133-1192" aria-hidden="true" tabindex="-1"></a><span class="in">      template = as(MI_counties_select, "Spatial"),</span></span>
<span id="cb133-1193"><a href="#cb133-1193" aria-hidden="true" tabindex="-1"></a><span class="in">      #--- label ---#</span></span>
<span id="cb133-1194"><a href="#cb133-1194" aria-hidden="true" tabindex="-1"></a><span class="in">      label = "MI_counties_select",</span></span>
<span id="cb133-1195"><a href="#cb133-1195" aria-hidden="true" tabindex="-1"></a><span class="in">      #--- variables to download ---#</span></span>
<span id="cb133-1196"><a href="#cb133-1196" aria-hidden="true" tabindex="-1"></a><span class="in">      elements = c("prcp", "tmax"),</span></span>
<span id="cb133-1197"><a href="#cb133-1197" aria-hidden="true" tabindex="-1"></a><span class="in">      #--- years ---#</span></span>
<span id="cb133-1198"><a href="#cb133-1198" aria-hidden="true" tabindex="-1"></a><span class="in">      years = 2000:2001</span></span>
<span id="cb133-1199"><a href="#cb133-1199" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb133-1200"><a href="#cb133-1200" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1201"><a href="#cb133-1201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1202"><a href="#cb133-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1203"><a href="#cb133-1203" aria-hidden="true" tabindex="-1"></a><span class="in">```{r MI_daymet_import, echo = F}</span></span>
<span id="cb133-1204"><a href="#cb133-1204" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(MI_daymet_select, "Data/tmi_prcp_MI_2000_2001.rds")</span></span>
<span id="cb133-1205"><a href="#cb133-1205" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-1206"><a href="#cb133-1206" aria-hidden="true" tabindex="-1"></a><span class="in">  MI_daymet_select &lt;- readRDS("Data/tmi_prcp_MI_2000_2001.rds")</span></span>
<span id="cb133-1207"><a href="#cb133-1207" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1208"><a href="#cb133-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1209"><a href="#cb133-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1210"><a href="#cb133-1210" aria-hidden="true" tabindex="-1"></a>As you can see, Daymet <span class="in">`prcp`</span> and <span class="in">`tmax`</span> data are stored separately as <span class="in">`RasterBrick`</span> in a single list. The following code access <span class="in">`tmax`</span>:</span>
<span id="cb133-1211"><a href="#cb133-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1214"><a href="#cb133-1214" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-1215"><a href="#cb133-1215" aria-hidden="true" tabindex="-1"></a>MI_daymet_select<span class="sc">$</span>tmax</span>
<span id="cb133-1216"><a href="#cb133-1216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1217"><a href="#cb133-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1218"><a href="#cb133-1218" aria-hidden="true" tabindex="-1"></a>If you prefer <span class="in">`SpatRaster`</span> from the <span class="in">`terra`</span> package, convert it:</span>
<span id="cb133-1219"><a href="#cb133-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1222"><a href="#cb133-1222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb133-1223"><a href="#cb133-1223" aria-hidden="true" tabindex="-1"></a>tmax <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(MI_daymet_select<span class="sc">$</span>tmax)</span>
<span id="cb133-1224"><a href="#cb133-1224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1225"><a href="#cb133-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1226"><a href="#cb133-1226" aria-hidden="true" tabindex="-1"></a>You can extract values for your target polygons data using the methods described in @sec-int-RV.</span>
<span id="cb133-1227"><a href="#cb133-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1228"><a href="#cb133-1228" aria-hidden="true" tabindex="-1"></a>If you use the <span class="in">`stars`</span> package for raster data handling (see @sec-stars-basics), you can convert them into <span class="in">`stars`</span> object using <span class="in">`st_as_stars()`</span>.</span>
<span id="cb133-1229"><a href="#cb133-1229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r convert_to_stars}</span></span>
<span id="cb133-1230"><a href="#cb133-1230" aria-hidden="true" tabindex="-1"></a><span class="in">#--- tmax as stars ---#</span></span>
<span id="cb133-1231"><a href="#cb133-1231" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_stars &lt;- st_as_stars(MI_daymet_select$tmax)</span></span>
<span id="cb133-1232"><a href="#cb133-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1233"><a href="#cb133-1233" aria-hidden="true" tabindex="-1"></a><span class="in">#--- prcp as stars ---#</span></span>
<span id="cb133-1234"><a href="#cb133-1234" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_stars &lt;- st_as_stars(MI_daymet_select$prcp)</span></span>
<span id="cb133-1235"><a href="#cb133-1235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1236"><a href="#cb133-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1237"><a href="#cb133-1237" aria-hidden="true" tabindex="-1"></a>Now, the third dimension (band) is not recognized as dates. We can use <span class="in">`st_set_dimension()`</span> to change that (see @sec-stars-set-time). Before that, we first need to recover <span class="in">`Date`</span> values from the "band" values as follows:</span>
<span id="cb133-1238"><a href="#cb133-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1239"><a href="#cb133-1239" aria-hidden="true" tabindex="-1"></a><span class="in">```{r band_to_date}</span></span>
<span id="cb133-1240"><a href="#cb133-1240" aria-hidden="true" tabindex="-1"></a><span class="in">date_values &lt;- </span></span>
<span id="cb133-1241"><a href="#cb133-1241" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_stars %&gt;%</span></span>
<span id="cb133-1242"><a href="#cb133-1242" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- get band values ---#</span></span>
<span id="cb133-1243"><a href="#cb133-1243" aria-hidden="true" tabindex="-1"></a><span class="in">  stars::st_get_dimension_values(., "band") %&gt;%</span></span>
<span id="cb133-1244"><a href="#cb133-1244" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- remove X ---#</span></span>
<span id="cb133-1245"><a href="#cb133-1245" aria-hidden="true" tabindex="-1"></a><span class="in">  gsub("X", "", .) %&gt;%</span></span>
<span id="cb133-1246"><a href="#cb133-1246" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- convert to date ---#</span></span>
<span id="cb133-1247"><a href="#cb133-1247" aria-hidden="true" tabindex="-1"></a><span class="in">  lubridate::ymd(.)</span></span>
<span id="cb133-1248"><a href="#cb133-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1249"><a href="#cb133-1249" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb133-1250"><a href="#cb133-1250" aria-hidden="true" tabindex="-1"></a><span class="in">head(date_values)</span></span>
<span id="cb133-1251"><a href="#cb133-1251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1252"><a href="#cb133-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1253"><a href="#cb133-1253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r assign_dates}</span></span>
<span id="cb133-1254"><a href="#cb133-1254" aria-hidden="true" tabindex="-1"></a><span class="in">#--- tmax ---#</span></span>
<span id="cb133-1255"><a href="#cb133-1255" aria-hidden="true" tabindex="-1"></a><span class="in">stars::st_set_dimensions(tmax_stars, 3, values = date_values, names = "date")</span></span>
<span id="cb133-1256"><a href="#cb133-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1257"><a href="#cb133-1257" aria-hidden="true" tabindex="-1"></a><span class="in">#--- prcp ---#</span></span>
<span id="cb133-1258"><a href="#cb133-1258" aria-hidden="true" tabindex="-1"></a><span class="in">stars::st_set_dimensions(prcp_stars, 3, values = date_values, names = "date")</span></span>
<span id="cb133-1259"><a href="#cb133-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1260"><a href="#cb133-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1261"><a href="#cb133-1261" aria-hidden="true" tabindex="-1"></a>Notice that the date dimension has NA for <span class="in">`delta`</span>. This is because Daymet removes observations for December 31 in leap years to make the time dimension 365 consistently across years. This means that there is a one-day gap between "2000-12-30" and "2000-01-01" as you can see below:</span>
<span id="cb133-1262"><a href="#cb133-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1263"><a href="#cb133-1263" aria-hidden="true" tabindex="-1"></a><span class="in">```{r one-day-skip}</span></span>
<span id="cb133-1264"><a href="#cb133-1264" aria-hidden="true" tabindex="-1"></a><span class="in">date_values[364:367]</span></span>
<span id="cb133-1265"><a href="#cb133-1265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1266"><a href="#cb133-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1267"><a href="#cb133-1267" aria-hidden="true" tabindex="-1"></a><span class="fu">## gridMET {#sec-gridMET}</span></span>
<span id="cb133-1268"><a href="#cb133-1268" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">gridMET</span><span class="co">](http://www.climatologylab.org/gridmet.html)</span> is a dataset of daily meteorological data covering the contiguous U.S. since 1979. Its spatial resolution matches that of PRISM data at 4 km by 4 km. In fact, gridMET is a product of combining <span class="co">[</span><span class="ot">PRISM</span><span class="co">](https://prism.oregonstate.edu/)</span> with the <span class="co">[</span><span class="ot">Land Data Assimilation System</span><span class="co">](https://ldas.gsfc.nasa.gov/nldas/NLDAS2forcing.php)</span> (specifically, NLDAS-2).</span>
<span id="cb133-1269"><a href="#cb133-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1270"><a href="#cb133-1270" aria-hidden="true" tabindex="-1"></a>gridMET offers a broader range of variables than PRISM, including maximum temperature, minimum temperature, precipitation accumulation, downward surface shortwave radiation, wind velocity, and humidity (both maximum/minimum relative humidity and specific humidity). It also provides derived products, such as reference evapotranspiration, calculated using the Penman-Monteith equation.</span>
<span id="cb133-1271"><a href="#cb133-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1272"><a href="#cb133-1272" aria-hidden="true" tabindex="-1"></a>You can use the <span class="in">`downloadr::download()`</span> function to download gridMET data by variable-year. For example, to download precipitation data for 2018, you can run the following code:</span>
<span id="cb133-1273"><a href="#cb133-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1274"><a href="#cb133-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb133-1275"><a href="#cb133-1275" aria-hidden="true" tabindex="-1"></a><span class="in">downloader::download(</span></span>
<span id="cb133-1276"><a href="#cb133-1276" aria-hidden="true" tabindex="-1"></a><span class="in">  url = "http://www.northwestknowledge.net/metdata/data/pr_2018.nc",</span></span>
<span id="cb133-1277"><a href="#cb133-1277" aria-hidden="true" tabindex="-1"></a><span class="in">  destfile = "Data/pr_2018.nc",</span></span>
<span id="cb133-1278"><a href="#cb133-1278" aria-hidden="true" tabindex="-1"></a><span class="in">  mode = "wb"</span></span>
<span id="cb133-1279"><a href="#cb133-1279" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1280"><a href="#cb133-1280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1281"><a href="#cb133-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1282"><a href="#cb133-1282" aria-hidden="true" tabindex="-1"></a>We set the url of the dataset of interest in the <span class="in">`url`</span> option, set the destination file name in the <span class="in">`destfile`</span> option, and the mode to the <span class="in">`wb`</span> option for a binary download.</span>
<span id="cb133-1283"><a href="#cb133-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1284"><a href="#cb133-1284" aria-hidden="true" tabindex="-1"></a>All the gridMET datasets for direct download has "http://www.northwestknowledge.net/metdata/data/" at the beginning, followed by the file name (here, **pr_2018.nc**). The file names follow the convention of **variable_abbreviation**\_**year**.nc. So, we can easily write a loop to get data for multiple variables over multiple years.</span>
<span id="cb133-1285"><a href="#cb133-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1286"><a href="#cb133-1286" aria-hidden="true" tabindex="-1"></a>Here is the list of variable abbreviations:</span>
<span id="cb133-1287"><a href="#cb133-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1288"><a href="#cb133-1288" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>sph: (Near-Surface Specific Humidity)</span>
<span id="cb133-1289"><a href="#cb133-1289" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>vpd: (Mean Vapor Pressure Deficit)</span>
<span id="cb133-1290"><a href="#cb133-1290" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>pr: (Precipitation)</span>
<span id="cb133-1291"><a href="#cb133-1291" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>rmin: (Minimum Near-Surface Relative Humidity)</span>
<span id="cb133-1292"><a href="#cb133-1292" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>rmax: (Maximum Near-Surface Relative Humidity)</span>
<span id="cb133-1293"><a href="#cb133-1293" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>srad: (Surface Downwelling Solar Radiation)</span>
<span id="cb133-1294"><a href="#cb133-1294" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>tmmn: (Minimum Near-Surface Air Temperature)</span>
<span id="cb133-1295"><a href="#cb133-1295" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>tmmx: (Maximum Near-Surface Air Temperature)</span>
<span id="cb133-1296"><a href="#cb133-1296" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>vs: (Wind speed at 10 m)</span>
<span id="cb133-1297"><a href="#cb133-1297" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>th: (Wind direction at 10 m)</span>
<span id="cb133-1298"><a href="#cb133-1298" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>pdsi: (Palmer Drought Severity Index)</span>
<span id="cb133-1299"><a href="#cb133-1299" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>pet: (Reference grass evaportranspiration)</span>
<span id="cb133-1300"><a href="#cb133-1300" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>etr: (Reference alfalfa evaportranspiration)</span>
<span id="cb133-1301"><a href="#cb133-1301" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>erc: (model-G)</span>
<span id="cb133-1302"><a href="#cb133-1302" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>bi: (model-G)</span>
<span id="cb133-1303"><a href="#cb133-1303" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>fm100: (100-hour dead fuel moisture)</span>
<span id="cb133-1304"><a href="#cb133-1304" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>fm1000: (1000-hour dead fuel moisture)</span>
<span id="cb133-1305"><a href="#cb133-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1306"><a href="#cb133-1306" aria-hidden="true" tabindex="-1"></a>As another example, if you are interested in downloading the wind speed data for 2020, then you can use the following code.</span>
<span id="cb133-1307"><a href="#cb133-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1308"><a href="#cb133-1308" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb133-1309"><a href="#cb133-1309" aria-hidden="true" tabindex="-1"></a><span class="in">downloader::download(</span></span>
<span id="cb133-1310"><a href="#cb133-1310" aria-hidden="true" tabindex="-1"></a><span class="in">  url = "http://www.northwestknowledge.net/metdata/data/vs_2020.nc",</span></span>
<span id="cb133-1311"><a href="#cb133-1311" aria-hidden="true" tabindex="-1"></a><span class="in">  destfile = "Data/vs_2020.nc",</span></span>
<span id="cb133-1312"><a href="#cb133-1312" aria-hidden="true" tabindex="-1"></a><span class="in">  mode = "wb"</span></span>
<span id="cb133-1313"><a href="#cb133-1313" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1314"><a href="#cb133-1314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1315"><a href="#cb133-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1316"><a href="#cb133-1316" aria-hidden="true" tabindex="-1"></a><span class="fu">### Practical Examples</span></span>
<span id="cb133-1317"><a href="#cb133-1317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1318"><a href="#cb133-1318" aria-hidden="true" tabindex="-1"></a>Suppose your final goal is to get average daily precipitation (**pr**) and reference grass evapotranspiration (**pet**) from 2015 through 2020 for each of the counties in California.</span>
<span id="cb133-1319"><a href="#cb133-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1320"><a href="#cb133-1320" aria-hidden="true" tabindex="-1"></a>First get county boundaries for California:</span>
<span id="cb133-1321"><a href="#cb133-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1322"><a href="#cb133-1322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-ca-counties}</span></span>
<span id="cb133-1323"><a href="#cb133-1323" aria-hidden="true" tabindex="-1"></a><span class="in">CA_counties &lt;- </span></span>
<span id="cb133-1324"><a href="#cb133-1324" aria-hidden="true" tabindex="-1"></a><span class="in">  tigris::counties(state = "CA", progress_bar = FALSE) %&gt;%</span></span>
<span id="cb133-1325"><a href="#cb133-1325" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(STATEFP, COUNTYFP)</span></span>
<span id="cb133-1326"><a href="#cb133-1326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1327"><a href="#cb133-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1328"><a href="#cb133-1328" aria-hidden="true" tabindex="-1"></a>Before writing a loop, let's work on a single case (**pet** for 2015). First, we download and read the data.</span>
<span id="cb133-1329"><a href="#cb133-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1330"><a href="#cb133-1330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-download-2015-pet-code, eval = F}</span></span>
<span id="cb133-1331"><a href="#cb133-1331" aria-hidden="true" tabindex="-1"></a><span class="in">#--- download data ---#</span></span>
<span id="cb133-1332"><a href="#cb133-1332" aria-hidden="true" tabindex="-1"></a><span class="in">downloader::download(</span></span>
<span id="cb133-1333"><a href="#cb133-1333" aria-hidden="true" tabindex="-1"></a><span class="in">  url = "http://www.northwestknowledge.net/metdata/data/pet_2015.nc",</span></span>
<span id="cb133-1334"><a href="#cb133-1334" aria-hidden="true" tabindex="-1"></a><span class="in">  destfile = "Data/pet_2015.nc",</span></span>
<span id="cb133-1335"><a href="#cb133-1335" aria-hidden="true" tabindex="-1"></a><span class="in">  mode = "wb"</span></span>
<span id="cb133-1336"><a href="#cb133-1336" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1337"><a href="#cb133-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1338"><a href="#cb133-1338" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read the raster data ---#</span></span>
<span id="cb133-1339"><a href="#cb133-1339" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-1340"><a href="#cb133-1340" aria-hidden="true" tabindex="-1"></a><span class="in">  pet_2015 &lt;- terra::rast("Data/pet_2015.nc")</span></span>
<span id="cb133-1341"><a href="#cb133-1341" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1342"><a href="#cb133-1342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1343"><a href="#cb133-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1344"><a href="#cb133-1344" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-download-2015-pet-show, echo = F}</span></span>
<span id="cb133-1345"><a href="#cb133-1345" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-1346"><a href="#cb133-1346" aria-hidden="true" tabindex="-1"></a><span class="in">  pet_2015 &lt;- terra::rast("Data/pet_2015.nc")</span></span>
<span id="cb133-1347"><a href="#cb133-1347" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1348"><a href="#cb133-1348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1349"><a href="#cb133-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1350"><a href="#cb133-1350" aria-hidden="true" tabindex="-1"></a>As you can see, it is a multi-layer raster object where each layer represents a single day in 2015 (@fig-gm-2015-pet-viz is a quick visualization of the first layer).</span>
<span id="cb133-1351"><a href="#cb133-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1352"><a href="#cb133-1352" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb133-1353"><a href="#cb133-1353" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb133-1354"><a href="#cb133-1354" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-gm-2015-pet-viz</span></span>
<span id="cb133-1355"><a href="#cb133-1355" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Potential evapotranspiration in January 1st, 2015"</span></span>
<span id="cb133-1356"><a href="#cb133-1356" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb133-1357"><a href="#cb133-1357" aria-hidden="true" tabindex="-1"></a><span class="in">plot(pet_2015[[1]])</span></span>
<span id="cb133-1358"><a href="#cb133-1358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1359"><a href="#cb133-1359" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb133-1360"><a href="#cb133-1360" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb133-1361"><a href="#cb133-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1362"><a href="#cb133-1362" aria-hidden="true" tabindex="-1"></a>Now, we can use <span class="in">`exactexactr::exact_extract()`</span> (or <span class="in">`terra::extract`</span>) to assign cell values to each county and transform it to a more convenient form:</span>
<span id="cb133-1363"><a href="#cb133-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1364"><a href="#cb133-1364" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-extract}</span></span>
<span id="cb133-1365"><a href="#cb133-1365" aria-hidden="true" tabindex="-1"></a><span class="in">pet_county &lt;-</span></span>
<span id="cb133-1366"><a href="#cb133-1366" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- extract data for each county ---#</span></span>
<span id="cb133-1367"><a href="#cb133-1367" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(pet_2015, CA_counties, progress = FALSE) %&gt;%</span></span>
<span id="cb133-1368"><a href="#cb133-1368" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- list of data.frames into data.table ---#</span></span>
<span id="cb133-1369"><a href="#cb133-1369" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table::rbindlist(idcol = "rowid")</span></span>
<span id="cb133-1370"><a href="#cb133-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1371"><a href="#cb133-1371" aria-hidden="true" tabindex="-1"></a><span class="in">#--- check the dimension of the output ---#</span></span>
<span id="cb133-1372"><a href="#cb133-1372" aria-hidden="true" tabindex="-1"></a><span class="in">dim(pet_county)</span></span>
<span id="cb133-1373"><a href="#cb133-1373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1374"><a href="#cb133-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1375"><a href="#cb133-1375" aria-hidden="true" tabindex="-1"></a>As you can see the data has 367 columns: 365 (days) + 1 (<span class="in">`rowid`</span>) + 1 (coverage fraction). Let's take a look at the name of the first six variables.</span>
<span id="cb133-1376"><a href="#cb133-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1377"><a href="#cb133-1377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-check-var-names}</span></span>
<span id="cb133-1378"><a href="#cb133-1378" aria-hidden="true" tabindex="-1"></a><span class="in">head(names(pet_county))</span></span>
<span id="cb133-1379"><a href="#cb133-1379" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1380"><a href="#cb133-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1381"><a href="#cb133-1381" aria-hidden="true" tabindex="-1"></a>The 5-digit number at the end of the name of the variables for evapotranspiration represents days since Jan 1st, 1900. This can be confirmed using <span class="in">`ncdf4:nc_open()`</span> (see the middle of the output below under **day** of **4 dimensions**):</span>
<span id="cb133-1382"><a href="#cb133-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1383"><a href="#cb133-1383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-ncdf4-check}</span></span>
<span id="cb133-1384"><a href="#cb133-1384" aria-hidden="true" tabindex="-1"></a><span class="in">ncdf4::nc_open("Data/pet_2015.nc")</span></span>
<span id="cb133-1385"><a href="#cb133-1385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1386"><a href="#cb133-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1387"><a href="#cb133-1387" aria-hidden="true" tabindex="-1"></a>This is universally true for all the gridMET data. We can use this information to recover date. First, let's transform the data from a wide format to a long format for easier operations:</span>
<span id="cb133-1388"><a href="#cb133-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1389"><a href="#cb133-1389" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-melt-et}</span></span>
<span id="cb133-1390"><a href="#cb133-1390" aria-hidden="true" tabindex="-1"></a><span class="in">pet_county &lt;-</span></span>
<span id="cb133-1391"><a href="#cb133-1391" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- wide to long ---#</span></span>
<span id="cb133-1392"><a href="#cb133-1392" aria-hidden="true" tabindex="-1"></a><span class="in">  melt(pet_county, id.var = c("rowid", "coverage_fraction")) %&gt;%</span></span>
<span id="cb133-1393"><a href="#cb133-1393" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- remove observations with NA values ---#</span></span>
<span id="cb133-1394"><a href="#cb133-1394" aria-hidden="true" tabindex="-1"></a><span class="in">  .[!is.na(value), ]</span></span>
<span id="cb133-1395"><a href="#cb133-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1396"><a href="#cb133-1396" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb133-1397"><a href="#cb133-1397" aria-hidden="true" tabindex="-1"></a><span class="in">pet_county</span></span>
<span id="cb133-1398"><a href="#cb133-1398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1399"><a href="#cb133-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1400"><a href="#cb133-1400" aria-hidden="true" tabindex="-1"></a>We now use <span class="in">`stringr::str_sub()`</span> to get 5-digit numbers from <span class="in">`variable`</span>, which represents days since Jan 1st, 1900. We can then recover dates using the <span class="in">`lubridate`</span> package.</span>
<span id="cb133-1401"><a href="#cb133-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1402"><a href="#cb133-1402" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-recover-date}</span></span>
<span id="cb133-1403"><a href="#cb133-1403" aria-hidden="true" tabindex="-1"></a><span class="in">pet_county[, variable := str_sub(variable, -5, -1) %&gt;% as.numeric()] %&gt;%</span></span>
<span id="cb133-1404"><a href="#cb133-1404" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- recover dates ---#</span></span>
<span id="cb133-1405"><a href="#cb133-1405" aria-hidden="true" tabindex="-1"></a><span class="in">  .[, date := variable + lubridate::ymd("1900-01-01")]</span></span>
<span id="cb133-1406"><a href="#cb133-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1407"><a href="#cb133-1407" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb133-1408"><a href="#cb133-1408" aria-hidden="true" tabindex="-1"></a><span class="in">pet_county</span></span>
<span id="cb133-1409"><a href="#cb133-1409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1410"><a href="#cb133-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1411"><a href="#cb133-1411" aria-hidden="true" tabindex="-1"></a>Finally, let's calculate the coverage-weighted average of **pet** by county-date.</span>
<span id="cb133-1412"><a href="#cb133-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1413"><a href="#cb133-1413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-get-aw-pet}</span></span>
<span id="cb133-1414"><a href="#cb133-1414" aria-hidden="true" tabindex="-1"></a><span class="in">pet_county_avg &lt;-</span></span>
<span id="cb133-1415"><a href="#cb133-1415" aria-hidden="true" tabindex="-1"></a><span class="in">  pet_county[,</span></span>
<span id="cb133-1416"><a href="#cb133-1416" aria-hidden="true" tabindex="-1"></a><span class="in">    .(value = sum(value * coverage_fraction) / sum(coverage_fraction)),</span></span>
<span id="cb133-1417"><a href="#cb133-1417" aria-hidden="true" tabindex="-1"></a><span class="in">    by = .(rowid, date)</span></span>
<span id="cb133-1418"><a href="#cb133-1418" aria-hidden="true" tabindex="-1"></a><span class="in">  ] %&gt;%</span></span>
<span id="cb133-1419"><a href="#cb133-1419" aria-hidden="true" tabindex="-1"></a><span class="in">  setnames("value", "pet")</span></span>
<span id="cb133-1420"><a href="#cb133-1420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1421"><a href="#cb133-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1422"><a href="#cb133-1422" aria-hidden="true" tabindex="-1"></a>Since <span class="in">`rowid`</span> value of **n** corresponds to the **n**th row in <span class="in">`CA_counties`</span>, it is easy to merge <span class="in">`pet_county_avg`</span> with <span class="in">`CA_counties`</span> (alternatively, you can use <span class="in">`cbind()`</span>).</span>
<span id="cb133-1423"><a href="#cb133-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1424"><a href="#cb133-1424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-merge-back}</span></span>
<span id="cb133-1425"><a href="#cb133-1425" aria-hidden="true" tabindex="-1"></a><span class="in">CA_pet &lt;- </span></span>
<span id="cb133-1426"><a href="#cb133-1426" aria-hidden="true" tabindex="-1"></a><span class="in">  CA_counties %&gt;%</span></span>
<span id="cb133-1427"><a href="#cb133-1427" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(rowid = seq_len(nrow(.))) %&gt;%</span></span>
<span id="cb133-1428"><a href="#cb133-1428" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(pet_county_avg, ., by = "rowid")</span></span>
<span id="cb133-1429"><a href="#cb133-1429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1430"><a href="#cb133-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1431"><a href="#cb133-1431" aria-hidden="true" tabindex="-1"></a>Now that we know how to process a single gridMET dataset, we are ready to write a function that goes through the same for a choice of gridMET dataset and then write a loop to achieve our goal. Here is the function:</span>
<span id="cb133-1432"><a href="#cb133-1432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1433"><a href="#cb133-1433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-define-function}</span></span>
<span id="cb133-1434"><a href="#cb133-1434" aria-hidden="true" tabindex="-1"></a><span class="in">get_grid_MET &lt;- function(var_name, year) {</span></span>
<span id="cb133-1435"><a href="#cb133-1435" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- for testing ---#</span></span>
<span id="cb133-1436"><a href="#cb133-1436" aria-hidden="true" tabindex="-1"></a><span class="in">  # var_name &lt;- "pet"</span></span>
<span id="cb133-1437"><a href="#cb133-1437" aria-hidden="true" tabindex="-1"></a><span class="in">  # year &lt;- 2020</span></span>
<span id="cb133-1438"><a href="#cb133-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1439"><a href="#cb133-1439" aria-hidden="true" tabindex="-1"></a><span class="in">  target_url &lt;-</span></span>
<span id="cb133-1440"><a href="#cb133-1440" aria-hidden="true" tabindex="-1"></a><span class="in">    paste0(</span></span>
<span id="cb133-1441"><a href="#cb133-1441" aria-hidden="true" tabindex="-1"></a><span class="in">      "http://www.northwestknowledge.net/metdata/data/",</span></span>
<span id="cb133-1442"><a href="#cb133-1442" aria-hidden="true" tabindex="-1"></a><span class="in">      var_name, "_", year,</span></span>
<span id="cb133-1443"><a href="#cb133-1443" aria-hidden="true" tabindex="-1"></a><span class="in">      ".nc"</span></span>
<span id="cb133-1444"><a href="#cb133-1444" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb133-1445"><a href="#cb133-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1446"><a href="#cb133-1446" aria-hidden="true" tabindex="-1"></a><span class="in">  file_name &lt;-</span></span>
<span id="cb133-1447"><a href="#cb133-1447" aria-hidden="true" tabindex="-1"></a><span class="in">    paste0(</span></span>
<span id="cb133-1448"><a href="#cb133-1448" aria-hidden="true" tabindex="-1"></a><span class="in">      "Data/",</span></span>
<span id="cb133-1449"><a href="#cb133-1449" aria-hidden="true" tabindex="-1"></a><span class="in">      var_name, "_", year,</span></span>
<span id="cb133-1450"><a href="#cb133-1450" aria-hidden="true" tabindex="-1"></a><span class="in">      ".nc"</span></span>
<span id="cb133-1451"><a href="#cb133-1451" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb133-1452"><a href="#cb133-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1453"><a href="#cb133-1453" aria-hidden="true" tabindex="-1"></a><span class="in">  downloader::download(</span></span>
<span id="cb133-1454"><a href="#cb133-1454" aria-hidden="true" tabindex="-1"></a><span class="in">    url = target_url,</span></span>
<span id="cb133-1455"><a href="#cb133-1455" aria-hidden="true" tabindex="-1"></a><span class="in">    destfile = file_name,</span></span>
<span id="cb133-1456"><a href="#cb133-1456" aria-hidden="true" tabindex="-1"></a><span class="in">    mode = "wb"</span></span>
<span id="cb133-1457"><a href="#cb133-1457" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb133-1458"><a href="#cb133-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1459"><a href="#cb133-1459" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- read the raster data ---#</span></span>
<span id="cb133-1460"><a href="#cb133-1460" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_rast &lt;- terra::rast(file_name)</span></span>
<span id="cb133-1461"><a href="#cb133-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1462"><a href="#cb133-1462" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_data &lt;-</span></span>
<span id="cb133-1463"><a href="#cb133-1463" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- extract data for each county ---#</span></span>
<span id="cb133-1464"><a href="#cb133-1464" aria-hidden="true" tabindex="-1"></a><span class="in">    exactextractr::exact_extract(temp_rast, CA_counties) %&gt;%</span></span>
<span id="cb133-1465"><a href="#cb133-1465" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- list of data.frames into data.table ---#</span></span>
<span id="cb133-1466"><a href="#cb133-1466" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::rbindlist(idcol = "rowid") %&gt;%</span></span>
<span id="cb133-1467"><a href="#cb133-1467" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- wide to long ---#</span></span>
<span id="cb133-1468"><a href="#cb133-1468" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::melt(id.var = c("rowid", "coverage_fraction")) %&gt;%</span></span>
<span id="cb133-1469"><a href="#cb133-1469" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- remove observations with NA values ---#</span></span>
<span id="cb133-1470"><a href="#cb133-1470" aria-hidden="true" tabindex="-1"></a><span class="in">    .[!is.na(value), ] %&gt;%</span></span>
<span id="cb133-1471"><a href="#cb133-1471" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- get only the numeric part ---#</span></span>
<span id="cb133-1472"><a href="#cb133-1472" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, variable := stringr::str_sub(variable, -5, -1) %&gt;% as.numeric()] %&gt;%</span></span>
<span id="cb133-1473"><a href="#cb133-1473" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- recover dates ---#</span></span>
<span id="cb133-1474"><a href="#cb133-1474" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, date := variable + lubridate::ymd("1900-01-01")] %&gt;%</span></span>
<span id="cb133-1475"><a href="#cb133-1475" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- find daily coverage-weight average by county ---#</span></span>
<span id="cb133-1476"><a href="#cb133-1476" aria-hidden="true" tabindex="-1"></a><span class="in">    .[,</span></span>
<span id="cb133-1477"><a href="#cb133-1477" aria-hidden="true" tabindex="-1"></a><span class="in">      .(value = sum(value * coverage_fraction) / sum(coverage_fraction)),</span></span>
<span id="cb133-1478"><a href="#cb133-1478" aria-hidden="true" tabindex="-1"></a><span class="in">      by = .(rowid, date)</span></span>
<span id="cb133-1479"><a href="#cb133-1479" aria-hidden="true" tabindex="-1"></a><span class="in">    ] %&gt;%</span></span>
<span id="cb133-1480"><a href="#cb133-1480" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, var := var_name]</span></span>
<span id="cb133-1481"><a href="#cb133-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1482"><a href="#cb133-1482" aria-hidden="true" tabindex="-1"></a><span class="in">  return(temp_data)</span></span>
<span id="cb133-1483"><a href="#cb133-1483" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb133-1484"><a href="#cb133-1484" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1485"><a href="#cb133-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1486"><a href="#cb133-1486" aria-hidden="true" tabindex="-1"></a>Let's now loop over the variables and years of interest. We first set up a dataset of variable-year combinations for which we loop over.</span>
<span id="cb133-1487"><a href="#cb133-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1488"><a href="#cb133-1488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-set-pars}</span></span>
<span id="cb133-1489"><a href="#cb133-1489" aria-hidden="true" tabindex="-1"></a><span class="in">#--- create a dataset of parameters to be looped over---#</span></span>
<span id="cb133-1490"><a href="#cb133-1490" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-1491"><a href="#cb133-1491" aria-hidden="true" tabindex="-1"></a><span class="in">  par_data &lt;-</span></span>
<span id="cb133-1492"><a href="#cb133-1492" aria-hidden="true" tabindex="-1"></a><span class="in">    expand.grid(</span></span>
<span id="cb133-1493"><a href="#cb133-1493" aria-hidden="true" tabindex="-1"></a><span class="in">      var_name = c("pr", "pet"),</span></span>
<span id="cb133-1494"><a href="#cb133-1494" aria-hidden="true" tabindex="-1"></a><span class="in">      year = 2015:2020</span></span>
<span id="cb133-1495"><a href="#cb133-1495" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;%</span></span>
<span id="cb133-1496"><a href="#cb133-1496" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::data.table() %&gt;%</span></span>
<span id="cb133-1497"><a href="#cb133-1497" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, var_name := as.character(var_name)]</span></span>
<span id="cb133-1498"><a href="#cb133-1498" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1499"><a href="#cb133-1499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1500"><a href="#cb133-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1501"><a href="#cb133-1501" aria-hidden="true" tabindex="-1"></a>We now loop over the rows of <span class="in">`par_data`</span> in parallel:</span>
<span id="cb133-1502"><a href="#cb133-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1503"><a href="#cb133-1503" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gm-get-data, results = "hide", eval = F}</span></span>
<span id="cb133-1504"><a href="#cb133-1504" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallel processing ---#</span></span>
<span id="cb133-1505"><a href="#cb133-1505" aria-hidden="true" tabindex="-1"></a><span class="in">future::plan(multisession, workers = parallel::detectCores() - 2)</span></span>
<span id="cb133-1506"><a href="#cb133-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1507"><a href="#cb133-1507" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb133-1508"><a href="#cb133-1508" aria-hidden="true" tabindex="-1"></a><span class="in">  all_data &lt;-</span></span>
<span id="cb133-1509"><a href="#cb133-1509" aria-hidden="true" tabindex="-1"></a><span class="in">    future.apply::future_lapply(</span></span>
<span id="cb133-1510"><a href="#cb133-1510" aria-hidden="true" tabindex="-1"></a><span class="in">      seq_len(nrow(par_data)),</span></span>
<span id="cb133-1511"><a href="#cb133-1511" aria-hidden="true" tabindex="-1"></a><span class="in">      \(x) get_grid_MET(var_name = par_data[x, var_name], year = par_data[x, year])</span></span>
<span id="cb133-1512"><a href="#cb133-1512" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;%</span></span>
<span id="cb133-1513"><a href="#cb133-1513" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::rbindlist() %&gt;%</span></span>
<span id="cb133-1514"><a href="#cb133-1514" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::dcast(rowid + date ~ var, value.var = "value")</span></span>
<span id="cb133-1515"><a href="#cb133-1515" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb133-1516"><a href="#cb133-1516" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb133-1517"><a href="#cb133-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1518"><a href="#cb133-1518" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb133-1519"><a href="#cb133-1519" aria-hidden="true" tabindex="-1"></a><span class="co">## USGS (under construction)</span></span>
<span id="cb133-1520"><a href="#cb133-1520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1521"><a href="#cb133-1521" aria-hidden="true" tabindex="-1"></a><span class="co">Under construction</span></span>
<span id="cb133-1522"><a href="#cb133-1522" aria-hidden="true" tabindex="-1"></a><span class="co"> --&gt;</span></span>
<span id="cb133-1523"><a href="#cb133-1523" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- [USGS R](https://owi.usgs.gov/R/index.html)</span></span>
<span id="cb133-1524"><a href="#cb133-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1525"><a href="#cb133-1525" aria-hidden="true" tabindex="-1"></a><span class="al">###</span><span class="co"> Groundwater level data</span></span>
<span id="cb133-1526"><a href="#cb133-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1527"><a href="#cb133-1527" aria-hidden="true" tabindex="-1"></a><span class="co">```{r , eval = F}</span></span>
<span id="cb133-1528"><a href="#cb133-1528" aria-hidden="true" tabindex="-1"></a><span class="co">library(dataRetrieval)</span></span>
<span id="cb133-1529"><a href="#cb133-1529" aria-hidden="true" tabindex="-1"></a><span class="co">state_ls &lt;- state.abb</span></span>
<span id="cb133-1530"><a href="#cb133-1530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1531"><a href="#cb133-1531" aria-hidden="true" tabindex="-1"></a><span class="co">data_ne &lt;- whatNWISdata(stateCd = "NE")</span></span>
<span id="cb133-1532"><a href="#cb133-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1533"><a href="#cb133-1533" aria-hidden="true" tabindex="-1"></a><span class="co">KS_gwl &lt;- readNWISdata(</span></span>
<span id="cb133-1534"><a href="#cb133-1534" aria-hidden="true" tabindex="-1"></a><span class="co">  stateCd = "Kansas",</span></span>
<span id="cb133-1535"><a href="#cb133-1535" aria-hidden="true" tabindex="-1"></a><span class="co">  startDate = "1980-01-01",</span></span>
<span id="cb133-1536"><a href="#cb133-1536" aria-hidden="true" tabindex="-1"></a><span class="co">  endDate = "2020-01-01",</span></span>
<span id="cb133-1537"><a href="#cb133-1537" aria-hidden="true" tabindex="-1"></a><span class="co">  service = "gwlevels"</span></span>
<span id="cb133-1538"><a href="#cb133-1538" aria-hidden="true" tabindex="-1"></a><span class="co">) %&gt;%</span></span>
<span id="cb133-1539"><a href="#cb133-1539" aria-hidden="true" tabindex="-1"></a><span class="co">  select(site_no, lev_dt, lev_va) %&gt;%</span></span>
<span id="cb133-1540"><a href="#cb133-1540" aria-hidden="true" tabindex="-1"></a><span class="co">  rename(date = lev_dt, dwt = lev_va)</span></span>
<span id="cb133-1541"><a href="#cb133-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1542"><a href="#cb133-1542" aria-hidden="true" tabindex="-1"></a><span class="co">KS_site_ls &lt;- KS_gwl[, site_no] %&gt;% unique()</span></span>
<span id="cb133-1543"><a href="#cb133-1543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1544"><a href="#cb133-1544" aria-hidden="true" tabindex="-1"></a><span class="co">sites_info &lt;- readNWISsite(siteNumbers = KS_site_ls) %&gt;%</span></span>
<span id="cb133-1545"><a href="#cb133-1545" aria-hidden="true" tabindex="-1"></a><span class="co">  select(site_no, dec_lat_va, dec_long_va) %&gt;%</span></span>
<span id="cb133-1546"><a href="#cb133-1546" aria-hidden="true" tabindex="-1"></a><span class="co">  st_as_sf(coords = c("dec_long_va", "dec_lat_va")) %&gt;%</span></span>
<span id="cb133-1547"><a href="#cb133-1547" aria-hidden="true" tabindex="-1"></a><span class="co">  st_set_crs(4269)</span></span>
<span id="cb133-1548"><a href="#cb133-1548" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb133-1549"><a href="#cb133-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1550"><a href="#cb133-1550" aria-hidden="true" tabindex="-1"></a><span class="al">###</span><span class="co"> Nitrogen concentration</span></span>
<span id="cb133-1551"><a href="#cb133-1551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1552"><a href="#cb133-1552" aria-hidden="true" tabindex="-1"></a><span class="co">```{r , eval = F}</span></span>
<span id="cb133-1553"><a href="#cb133-1553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1554"><a href="#cb133-1554" aria-hidden="true" tabindex="-1"></a><span class="co">SaltLake_totalN &lt;- readNWISdata(</span></span>
<span id="cb133-1555"><a href="#cb133-1555" aria-hidden="true" tabindex="-1"></a><span class="co">  bBox = c(-113.0428, 40.6474, -112.0265, 41.7018),</span></span>
<span id="cb133-1556"><a href="#cb133-1556" aria-hidden="true" tabindex="-1"></a><span class="co">  service = "qw",</span></span>
<span id="cb133-1557"><a href="#cb133-1557" aria-hidden="true" tabindex="-1"></a><span class="co">  parameterCd = "00600",</span></span>
<span id="cb133-1558"><a href="#cb133-1558" aria-hidden="true" tabindex="-1"></a><span class="co">  startDate = "2020-01-01"</span></span>
<span id="cb133-1559"><a href="#cb133-1559" aria-hidden="true" tabindex="-1"></a><span class="co">)</span></span>
<span id="cb133-1560"><a href="#cb133-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1561"><a href="#cb133-1561" aria-hidden="true" tabindex="-1"></a><span class="co">attributes(SaltLake_totalN)</span></span>
<span id="cb133-1562"><a href="#cb133-1562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1563"><a href="#cb133-1563" aria-hidden="true" tabindex="-1"></a><span class="co">attr(SaltLake_totalN, "variableInfo")</span></span>
<span id="cb133-1564"><a href="#cb133-1564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1565"><a href="#cb133-1565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1566"><a href="#cb133-1566" aria-hidden="true" tabindex="-1"></a><span class="co">phosphorous:00665</span></span>
<span id="cb133-1567"><a href="#cb133-1567" aria-hidden="true" tabindex="-1"></a><span class="co">nitrogen:00665</span></span>
<span id="cb133-1568"><a href="#cb133-1568" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb133-1569"><a href="#cb133-1569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1570"><a href="#cb133-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1571"><a href="#cb133-1571" aria-hidden="true" tabindex="-1"></a><span class="al">###</span><span class="co"> Water temperature</span></span>
<span id="cb133-1572"><a href="#cb133-1572" aria-hidden="true" tabindex="-1"></a><span class="co">```{r , eval = F}</span></span>
<span id="cb133-1573"><a href="#cb133-1573" aria-hidden="true" tabindex="-1"></a><span class="co">MauiCo_avgdailyQ &lt;- readNWISdata(</span></span>
<span id="cb133-1574"><a href="#cb133-1574" aria-hidden="true" tabindex="-1"></a><span class="co">  stateCd = "Hawaii",</span></span>
<span id="cb133-1575"><a href="#cb133-1575" aria-hidden="true" tabindex="-1"></a><span class="co">  service = "dv",</span></span>
<span id="cb133-1576"><a href="#cb133-1576" aria-hidden="true" tabindex="-1"></a><span class="co">  parameterCd = "00060"</span></span>
<span id="cb133-1577"><a href="#cb133-1577" aria-hidden="true" tabindex="-1"></a><span class="co">)</span></span>
<span id="cb133-1578"><a href="#cb133-1578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1579"><a href="#cb133-1579" aria-hidden="true" tabindex="-1"></a><span class="co">head(MauiCo_avgdailyQ)</span></span>
<span id="cb133-1580"><a href="#cb133-1580" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb133-1581"><a href="#cb133-1581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1582"><a href="#cb133-1582" aria-hidden="true" tabindex="-1"></a><span class="al">###</span><span class="co"> WQP </span></span>
<span id="cb133-1583"><a href="#cb133-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1584"><a href="#cb133-1584" aria-hidden="true" tabindex="-1"></a><span class="co">[WQP user guide](https://www.waterqualitydata.us/portal_userguide/)</span></span>
<span id="cb133-1585"><a href="#cb133-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1586"><a href="#cb133-1586" aria-hidden="true" tabindex="-1"></a><span class="co">[WQP query](https://www.waterqualitydata.us/webservices_documentation/#WQPWebServicesGuide-Submitting)</span></span>
<span id="cb133-1587"><a href="#cb133-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1588"><a href="#cb133-1588" aria-hidden="true" tabindex="-1"></a><span class="co">```{r , eval = F}</span></span>
<span id="cb133-1589"><a href="#cb133-1589" aria-hidden="true" tabindex="-1"></a><span class="co">wqpcounts_ia &lt;- readWQPdata(</span></span>
<span id="cb133-1590"><a href="#cb133-1590" aria-hidden="true" tabindex="-1"></a><span class="co">  statecode = "US:19",</span></span>
<span id="cb133-1591"><a href="#cb133-1591" aria-hidden="true" tabindex="-1"></a><span class="co">  querySummary = TRUE</span></span>
<span id="cb133-1592"><a href="#cb133-1592" aria-hidden="true" tabindex="-1"></a><span class="co">)</span></span>
<span id="cb133-1593"><a href="#cb133-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1594"><a href="#cb133-1594" aria-hidden="true" tabindex="-1"></a><span class="co">IA_lake_phosphorus &lt;- readWQPdata(</span></span>
<span id="cb133-1595"><a href="#cb133-1595" aria-hidden="true" tabindex="-1"></a><span class="co">  statecode = "IA",</span></span>
<span id="cb133-1596"><a href="#cb133-1596" aria-hidden="true" tabindex="-1"></a><span class="co">  siteType = "Lake, Reservoir, Impoundment",</span></span>
<span id="cb133-1597"><a href="#cb133-1597" aria-hidden="true" tabindex="-1"></a><span class="co">  characteristicName = "Phosphorus",</span></span>
<span id="cb133-1598"><a href="#cb133-1598" aria-hidden="true" tabindex="-1"></a><span class="co">  startDate = "1990-10-01"</span></span>
<span id="cb133-1599"><a href="#cb133-1599" aria-hidden="true" tabindex="-1"></a><span class="co">) %&gt;%</span></span>
<span id="cb133-1600"><a href="#cb133-1600" aria-hidden="true" tabindex="-1"></a><span class="co">  filter(MonitoringLocationIdentifier, ResultMeasureValue, ActivityStartDate)</span></span>
<span id="cb133-1601"><a href="#cb133-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1602"><a href="#cb133-1602" aria-hidden="true" tabindex="-1"></a><span class="co">#--- get longitude and latitude ---#</span></span>
<span id="cb133-1603"><a href="#cb133-1603" aria-hidden="true" tabindex="-1"></a><span class="co">siteInfo &lt;- attr(IA_lake_phosphorus, "siteInfo") %&gt;%</span></span>
<span id="cb133-1604"><a href="#cb133-1604" aria-hidden="true" tabindex="-1"></a><span class="co">  select(MonitoringLocationIdentifier, dec_lat_va, dec_lon_va) %&gt;%</span></span>
<span id="cb133-1605"><a href="#cb133-1605" aria-hidden="true" tabindex="-1"></a><span class="co">  st_as_sf(coords = c("dec_lon_va", "dec_lat_va")) %&gt;%</span></span>
<span id="cb133-1606"><a href="#cb133-1606" aria-hidden="true" tabindex="-1"></a><span class="co">  st_set_crs(4269)</span></span>
<span id="cb133-1607"><a href="#cb133-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1608"><a href="#cb133-1608" aria-hidden="true" tabindex="-1"></a><span class="co">attributes()</span></span>
<span id="cb133-1609"><a href="#cb133-1609" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb133-1610"><a href="#cb133-1610" aria-hidden="true" tabindex="-1"></a><span class="co"> --&gt;</span></span>
<span id="cb133-1611"><a href="#cb133-1611" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb133-1612"><a href="#cb133-1612" aria-hidden="true" tabindex="-1"></a><span class="co">## Sentinel with `sen2r` (under construction)</span></span>
<span id="cb133-1613"><a href="#cb133-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1614"><a href="#cb133-1614" aria-hidden="true" tabindex="-1"></a><span class="co">Under construction</span></span>
<span id="cb133-1615"><a href="#cb133-1615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1616"><a href="#cb133-1616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1617"><a href="#cb133-1617" aria-hidden="true" tabindex="-1"></a><span class="co">## Census with `tidycensus` (under construction)</span></span>
<span id="cb133-1618"><a href="#cb133-1618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1619"><a href="#cb133-1619" aria-hidden="true" tabindex="-1"></a><span class="co">Under construction</span></span>
<span id="cb133-1620"><a href="#cb133-1620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-1621"><a href="#cb133-1621" aria-hidden="true" tabindex="-1"></a><span class="co"> --&gt;</span></span>
<span id="cb133-1622"><a href="#cb133-1622" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/08-DownloadSpatialData.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>
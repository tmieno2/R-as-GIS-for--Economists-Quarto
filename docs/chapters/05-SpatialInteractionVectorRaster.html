<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>5&nbsp; Spatial Interactions of Vector and Raster Data – R as GIS for Economists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/04-RasterDataBasics.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Google tag (gtag.js) --><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../style.css">
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-VectorDataBasics.html">Foundations</a></li><li class="breadcrumb-item"><a href="../chapters/05-SpatialInteractionVectorRaster.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">R as GIS for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/R-as-GIS-for-Economists" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/00-preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Demonstrations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-Demonstration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-VectorDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-SpatialInteractionVectorVector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-RasterDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-SpatialInteractionVectorRaster.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Extensions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-stars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-CreateMaps-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-DownloadSpatialData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">(slightly) Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-SpeedThingsUp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-ParallelComputing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Loop and Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-ggplot2-appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">ggplot2 minimals</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#before-you-start" id="toc-before-you-start" class="nav-link active" data-scroll-target="#before-you-start">Before you start</a>
  <ul class="collapse">
<li><a href="#direction-for-replication" id="toc-direction-for-replication" class="nav-link" data-scroll-target="#direction-for-replication">Direction for replication</a></li>
  </ul>
</li>
  <li><a href="#sec-raster-crop" id="toc-sec-raster-crop" class="nav-link" data-scroll-target="#sec-raster-crop"><span class="header-section-number">5.1</span> Cropping to the Area of Interest</a></li>
  <li>
<a href="#sec-extract-raster-to-vector" id="toc-sec-extract-raster-to-vector" class="nav-link" data-scroll-target="#sec-extract-raster-to-vector"><span class="header-section-number">5.2</span> Extracting Values from Raster Layers for Vector Data</a>
  <ul class="collapse">
<li><a href="#simple-visual-illustrations-of-raster-data-extraction" id="toc-simple-visual-illustrations-of-raster-data-extraction" class="nav-link" data-scroll-target="#simple-visual-illustrations-of-raster-data-extraction"><span class="header-section-number">5.2.1</span> Simple visual illustrations of raster data extraction</a></li>
  <li><a href="#extracting-to-points" id="toc-extracting-to-points" class="nav-link" data-scroll-target="#extracting-to-points"><span class="header-section-number">5.2.2</span> Extracting to Points</a></li>
  <li><a href="#extracting-to-polygons-terra-way" id="toc-extracting-to-polygons-terra-way" class="nav-link" data-scroll-target="#extracting-to-polygons-terra-way"><span class="header-section-number">5.2.3</span> Extracting to Polygons (<code>terra</code> way)</a></li>
  <li><a href="#sec-exactextractr" id="toc-sec-exactextractr" class="nav-link" data-scroll-target="#sec-exactextractr"><span class="header-section-number">5.2.4</span> Extracting to Polygons (<code>exactextractr</code> way)</a></li>
  </ul>
</li>
  <li>
<a href="#sec-extract-speed" id="toc-sec-extract-speed" class="nav-link" data-scroll-target="#sec-extract-speed"><span class="header-section-number">5.3</span> Extraction speed comparison</a>
  <ul class="collapse">
<li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">5.3.1</span> Data preparation</a></li>
  <li><a href="#points-terraextract" id="toc-points-terraextract" class="nav-link" data-scroll-target="#points-terraextract"><span class="header-section-number">5.3.2</span> Points: <code>terra::extract()</code></a></li>
  <li><a href="#polygons-exactextractrexact_extract-and-terraextract" id="toc-polygons-exactextractrexact_extract-and-terraextract" class="nav-link" data-scroll-target="#polygons-exactextractrexact_extract-and-terraextract"><span class="header-section-number">5.3.3</span> Polygons: <code>exactextractr::exact_extract()</code> and <code>terra::extract()</code></a></li>
  <li><a href="#single-layer-vs-multi-layer" id="toc-single-layer-vs-multi-layer" class="nav-link" data-scroll-target="#single-layer-vs-multi-layer"><span class="header-section-number">5.3.4</span> Single-layer vs multi-layer</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/05-SpatialInteractionVectorRaster.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-VectorDataBasics.html">Foundations</a></li><li class="breadcrumb-item"><a href="../chapters/05-SpatialInteractionVectorRaster.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-int-RV" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="before-you-start" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="before-you-start">Before you start</h2>
<p>In this chapter we learn the spatial interactions of a vector and raster dataset. We first look at how to crop (spatially subset) a raster dataset based on the geographic extent of a vector dataset. We then cover how to extract values from raster data for points and polygons. To be precise, here is what we mean by raster data extraction and what it does for points and polygons data:</p>
<ul>
<li><p><strong>Points</strong>: For each of the points, find which raster cell it is located within, and assign the value of the cell to the point.</p></li>
<li><p><strong>Polygons</strong>: For each of the polygons, identify all the raster cells that intersect with the polygon, and assign a vector of the cell values to the polygon</p></li>
</ul>
<p>We will show how we can use <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> for both cases. But, we will also see that for polygons, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> from the <code>exactextractr</code> package is often considerably faster than <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>.</p>
<section id="direction-for-replication" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="direction-for-replication">Direction for replication</h3>
<p><strong>Datasets</strong></p>
<p>All the datasets that you need to import are available <a href="https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0">here</a>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</p>
<ul>
<li>set a folder (any folder) as the working directory using <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code>
</li>
<li>create a folder called “Data” inside the folder designated as the working directory (if you have created a “Data” folder previously, skip this step)</li>
<li>download the pertinent datasets from <a href="https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0">here</a>
</li>
<li>place all the files in the downloaded folder in the “Data” folder</li>
</ul>
<p><strong>Packages</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">terra</span>, <span class="co"># handle raster data</span></span>
<span>  <span class="va">tidyterra</span>, <span class="co"># handle and visualize raster data</span></span>
<span>  <span class="va">raster</span>, <span class="co"># handle raster data</span></span>
<span>  <span class="va">exactextractr</span>, <span class="co"># fast extractions</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">tidyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">data.table</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">prism</span>, <span class="co"># download PRISM data</span></span>
<span>  <span class="va">tictoc</span>, <span class="co"># timing codes</span></span>
<span>  <span class="va">tigris</span>, <span class="co"># to get county sf</span></span>
<span>  <span class="va">tmap</span> <span class="co"># for mapping</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-raster-crop" class="level2 page-columns page-full" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="sec-raster-crop">
<span class="header-section-number">5.1</span> Cropping to the Area of Interest</h2>
<p>Here we use PRISM maximum temperature (tmax) data as a raster dataset and Kansas county boundaries as a vector dataset.</p>
<p>Let’s download the tmax data for July 1, 2018 (<a href="#fig-prism-tmax-map" class="quarto-xref">Figure&nbsp;<span>5.1</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- set the path to the folder to which you save the downloaded PRISM data ---#</span></span>
<span><span class="co"># This code sets the current working directory as the designated folder</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>prism.path <span class="op">=</span> <span class="st">"Data"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- download PRISM precipitation data ---#</span></span>
<span><span class="fu">prism</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">get_prism_dailys</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>  date <span class="op">=</span> <span class="st">"2018-07-01"</span>,</span>
<span>  keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span><span class="va">prism_file</span> <span class="op">&lt;-</span> <span class="st">"Data/PRISM_tmax_stable_4kmD2_20180701_bil/PRISM_tmax_stable_4kmD2_20180701_bil.bil"</span></span>
<span></span>
<span><span class="co">#--- read in the prism data ---#</span></span>
<span><span class="va">prism_tmax_0701_sr</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">prism_file</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">prism_tmax_0701_sr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_whitebox_c</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"muted"</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op">(</span>suffix <span class="op">=</span> <span class="st">"º"</span><span class="op">)</span>,</span>
<span>    n.breaks <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-prism-tmax-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-prism-tmax-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-prism-tmax-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prism-tmax-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.1: Map of PRISM tmax data on July 1, 2018
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>We now get Kansas county border data from the <code>tigris</code> package (<a href="#fig-ks-county-map" class="quarto-xref">Figure&nbsp;<span>5.2</span></a>) as <code>sf</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- Kansas boundary (sf) ---#</span></span>
<span><span class="va">KS_county_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="co">#--- get Kansas county boundary ---</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Kansas"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- sp to sf ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- transform using the CRS of the PRISM tmax data  ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="va">prism_tmax_0701_sr</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- gen map ---#</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_county_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-ks-county-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ks-county-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-ks-county-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ks-county-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.2: Kansas county boundaries
</figcaption></figure>
</div>
</div>
</div>
</div></div><hr>
<p>Cropping a raster layer to the area of interest can be useful, as it eliminates unnecessary data and reduces processing time. A smaller raster also makes value extraction faster. You can crop a raster layer using <code><a href="https://rspatial.github.io/terra/reference/crop.html">terra::crop()</a></code>, as shown below:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- syntax (this does not run) ---#</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">SpatRaster</span>, <span class="va">sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, in this case, this does the job.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- crop the entire PRISM to its KS portion---#</span></span>
<span><span class="va">prism_tmax_0701_KS_sr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-prism-ks-viz" class="quarto-xref">Figure&nbsp;<span>5.3</span></a> shows the PRISM tmax raster data cropped to the geographic extent of Kansas. Notice that the cropped raster layer extends beyond the outer boundary of Kansas state boundary (it is a bit hard to see, but look at the upper right corner).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">prism_tmax_0701_KS_sr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_county_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_whitebox_c</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"muted"</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op">(</span>suffix <span class="op">=</span> <span class="st">"º"</span><span class="op">)</span>,</span>
<span>    n.breaks <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-prism-ks-viz" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-prism-ks-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-prism-ks-viz-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prism-ks-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.3: PRISM tmax raster data cropped to the geographic extent of Kansas
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-extract-raster-to-vector" class="level2 page-columns page-full" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="sec-extract-raster-to-vector">
<span class="header-section-number">5.2</span> Extracting Values from Raster Layers for Vector Data</h2>
<p>In this section, we will learn how to extract information from raster layers for spatial units represented as vector data (points and polygons). For the demonstrations in this section, we use the following datasets:</p>
<ul>
<li>Raster: PRISM tmax data cropped to Kansas state border for 07/01/2018 (obtained in <a href="#sec-raster-crop" class="quarto-xref"><span>Section 5.1</span></a>) and 07/02/2018 (downloaded below)</li>
<li>Polygons: Kansas county boundaries (obtained in <a href="#sec-raster-crop" class="quarto-xref"><span>Section 5.1</span></a>)</li>
<li>Points: Irrigation wells in Kansas (imported below)</li>
</ul>
<section id="simple-visual-illustrations-of-raster-data-extraction" class="level3" data-number="5.2.1"><h3 data-number="5.2.1" class="anchored" data-anchor-id="simple-visual-illustrations-of-raster-data-extraction">
<span class="header-section-number">5.2.1</span> Simple visual illustrations of raster data extraction</h3>
<p><strong>Extracting to Points</strong></p>
<p><a href="#fig-illustrate-points" class="quarto-xref">Figure&nbsp;<span>5.4</span></a> shows visually what we mean by “extract raster values to points.”</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">378533</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- create polygons ---#</span></span>
<span><span class="va">polygon</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raster_like_cells</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid</a></span><span class="op">(</span><span class="va">polygon</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">64</span>, <span class="fl">64</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stars_cells</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html">st_rasterize</a></span><span class="op">(</span><span class="va">raster_like_cells</span>, nx <span class="op">=</span> <span class="fl">8</span>, ny <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cell_centroids</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">raster_like_cells</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="co"># Create points for which values are extracted</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="co">#--- points ---#</span></span>
<span><span class="va">point_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.4</span>, <span class="fl">2.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">point_2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6.7</span>, <span class="fl">1.8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">point_3</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.2</span>, <span class="fl">7.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- combine the points to make a single  sf of points ---#</span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">point_1</span>, <span class="va">point_2</span>, <span class="va">point_3</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>point_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Point 1"</span>, <span class="st">"Point 2"</span>, <span class="st">"Point 3"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="co"># Create maps</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stars_cells</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Value"</span>, palette <span class="op">=</span> <span class="st">"Spectral"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">raster_like_cells</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points</span>, <span class="fu">aes</span><span class="op">(</span>shape <span class="op">=</span> <span class="va">point_name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_shape</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Points"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-illustrate-points" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-illustrate-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-illustrate-points-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-illustrate-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.4: Visual illustration of raster data extraction for points data
</figcaption></figure>
</div>
</div>
</div>
<p>In the figure, we have grids (cells) and each grid holds a value (presented at the center). There are three points. We will find which grid the points fall inside and get the associated values and assign them to the points. In this example, Points 1, 2, and 3 will have 50, 4, 54, respectively,</p>
<p><strong>Extracting to Polygons</strong></p>
<p><a href="#fig-polygons-extact-viz" class="quarto-xref">Figure&nbsp;<span>5.5</span></a> shows visually what we mean by “extract raster values to polygons.”</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--------------------------</span></span>
<span><span class="co"># Create a polygon for which values are extracted</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="va">polygon_extract</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">2.3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">6.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">polygons_extract_viz</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stars_cells</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Value"</span>, palette <span class="op">=</span> <span class="st">"Spectral"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygon_extract</span>, fill <span class="op">=</span> <span class="st">"gray"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">cell_centroids</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">raster_like_cells</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">value</span><span class="op">)</span>,</span>
<span>    nudge_x <span class="op">=</span> <span class="op">-</span><span class="fl">0.25</span>,</span>
<span>    nudge_y <span class="op">=</span> <span class="fl">0.25</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span>
<span></span>
<span><span class="va">polygons_extract_viz</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-polygons-extact-viz" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-polygons-extact-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-polygons-extact-viz-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-polygons-extact-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.5: Visual illustration of raster data extraction for polygons data
</figcaption></figure>
</div>
</div>
</div>
<p>There is a polygon overlaid on top of the cells along with their centroids represented by black dots. Extracting raster values to a polygon means finding raster cells that intersect with the polygons and get the value of all those cells and assigns them to the polygon. As you can see some cells are completely inside the polygon, while others are only partially overlapping with the polygon. Depending on the function you use and its options, you regard different cells as being spatially related to the polygons. For example, by default, <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> will extract only the cells whose centroid is inside the polygon. But, you can add an option to include the cells that are only partially intersected with the polygon. In such a case, you can also get the fraction of the cell what is overlapped with the polygon, which enables us to find area-weighted values later. We will discuss the details these below.</p>
<p><strong>PRISM tmax data for 07/02/2018</strong></p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- download PRISM precipitation data ---#</span></span>
<span><span class="fu">prism</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">get_prism_dailys</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>  date <span class="op">=</span> <span class="st">"2018-07-02"</span>,</span>
<span>  keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span><span class="va">prism_file</span> <span class="op">&lt;-</span> <span class="st">"Data/PRISM_tmax_stable_4kmD2_20180702_bil/PRISM_tmax_stable_4kmD2_20180702_bil.bil"</span></span>
<span></span>
<span><span class="co">#--- read in the prism data and crop it to Kansas state border ---#</span></span>
<span><span class="va">prism_tmax_0702_KS_sr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">prism_file</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Irrigation wells in Kansas:</strong></p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read in the KS points data ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">KS_wells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/Chap_5_wells_KS.rds"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37647 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -102.0495 ymin: 36.99552 xmax: -94.62089 ymax: 40.00199
Geodetic CRS:  NAD83
First 10 features:
   well_id                   geometry
1        1 POINT (-100.4423 37.52046)
2        3 POINT (-100.7118 39.91526)
3        5 POINT (-99.15168 38.48849)
4        7 POINT (-101.8995 38.78077)
5        8  POINT (-100.7122 38.0731)
6        9 POINT (-97.70265 39.04055)
7       11 POINT (-101.7114 39.55035)
8       12 POINT (-95.97031 39.16121)
9       15 POINT (-98.30759 38.26787)
10      17 POINT (-100.2785 37.71539)</code></pre>
</div>
</div>
<hr>
<p>Here is how the wells are spatially distributed over the PRISM grids and Kansas county borders (<a href="06-stars.html#fig-tmax-prism-wells" class="quarto-xref">Figure&nbsp;<span>6.9</span></a>):</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_symbols</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_layout</span><span class="op">(</span></span>
<span>    frame <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    legend.outside <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    legend.outside.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-tmax-prism-wells" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-tmax-prism-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-tmax-prism-wells-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tmax-prism-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.6: Map of Kansas county borders, irrigation wells, and PRISM tmax
</figcaption></figure>
</div>
</div>
</div>
</section><section id="extracting-to-points" class="level3 page-columns page-full" data-number="5.2.2"><h3 data-number="5.2.2" class="anchored" data-anchor-id="extracting-to-points">
<span class="header-section-number">5.2.2</span> Extracting to Points</h3>
<p>You can extract values from raster layers to points using <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>. <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> finds which raster cell each of the points is located within and assigns the value of the cell to the point.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- syntax (this does not run) ---#</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">raster</span>, <span class="va">points</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>points</code> objects can be either <code>sf</code> or <code>SpatVect</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;<code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract</a></code> used to accept only <code>SpatVect</code> and the <code>sf</code> objects had to be converted to a <code>SpatVect</code> using <code><a href="https://rspatial.github.io/terra/reference/vect.html">terra::vect()</a></code></p></div></div><p>Let’s extract <code>tmax</code> values from the PRISM tmax layer (<code>prism_tmax_0701_KS_sr</code>) to the irrigation wells (<code>KS_wells</code> as <code>sf</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_from_prism</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_from_prism</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                               34.241
2  2                               29.288
3  3                               32.585
4  4                               30.104
5  5                               34.232
6  6                               35.168</code></pre>
</div>
</div>
<p>The resulting object is a <code>data.frame</code>, where the <code>ID</code> variable represents the order of the observations in the points data and the second column represents that values extracted for the points from the raster cells. So, you can assign the extracted values as a new variable of the points data as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells</span><span class="op">$</span><span class="va">tmax_07_01</span> <span class="op">&lt;-</span> <span class="va">tmax_from_prism</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Extracting values from a multi-layer <code>SpatRaster</code> works the same way. Here, we combine <code>prism_tmax_0701_KS_sr</code> and <code>prism_tmax_0702_KS_sr</code> to create a multi-layer <code>SpatRaster</code> and then extract values from them.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create a multi-layer SpatRaster ---#</span></span>
<span><span class="va">prism_tmax_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">prism_tmax_0702_KS_sr</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- extract tmax values ---#</span></span>
<span><span class="va">tmax_from_prism_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_stack</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_from_prism_stack</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               34.241                               30.544
2  2                               29.288                               29.569
3  3                               32.585                               29.866
4  4                               30.104                               29.819
5  5                               34.232                               30.481
6  6                               35.168                               30.640</code></pre>
</div>
</div>
<p>We now have two columns that hold values extracted from the raster cells: the 2nd column for the 1st raster layer and the 3rd column for the 2nd raster layer in <code>prism_tmax_stack</code>.</p>
</section><section id="extracting-to-polygons-terra-way" class="level3" data-number="5.2.3"><h3 data-number="5.2.3" class="anchored" data-anchor-id="extracting-to-polygons-terra-way">
<span class="header-section-number">5.2.3</span> Extracting to Polygons (<code>terra</code> way)</h3>
<p>You can use <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> for extracting raster cell values for polygons as well. For each of the polygons, it will identify all the raster cells whose center lies inside the polygon and assign the vector of values of the cells to the polygon.</p>
<section id="extract-from-a-single-layer-spatraster" class="level4" data-number="5.2.3.1"><h4 data-number="5.2.3.1" class="anchored" data-anchor-id="extract-from-a-single-layer-spatraster">
<span class="header-section-number">5.2.3.1</span> extract from a single-layer <code>SpatRaster</code>
</h4>
<p>Let’s extract <code>tmax</code> values from <code>prism_tmax_0701_KS_sr</code> for each of the KS counties.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract values from the raster for each county ---#</span></span>
<span><span class="va">tmax_by_county</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">KS_county_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- check the class ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "data.frame"</code></pre>
</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                               34.228
2  1                               34.222
3  1                               34.256
4  1                               34.268
5  1                               34.262
6  1                               34.477</code></pre>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       ID PRISM_tmax_stable_4kmD2_20180701_bil
12840 105                               34.185
12841 105                               34.180
12842 105                               34.241
12843 105                               34.381
12844 105                               34.295
12845 105                               34.267</code></pre>
</div>
</div>
<p>So, <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> returns a <code>data.frame</code>, where <code>ID</code> values represent the corresponding row number in the polygons data. For example, the observations with <code>ID == n</code> are for the <strong>n</strong>th polygon. Using this information, you can easily merge the extraction results to the polygons data. Suppose you are interested in the mean of the <code>tmax</code> values of the intersecting cells for each of the polygons, then you can do the following:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get mean tmax ---#</span></span>
<span><span class="va">mean_tmax</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tmax_by_county</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">PRISM_tmax_stable_4kmD2_20180701_bil</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">KS_county_sf</span> <span class="op">&lt;-</span></span>
<span>    <span class="co">#--- back to sf ---#</span></span>
<span>    <span class="va">KS_county_sf</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- define ID ---#</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span><span class="va">ID</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- merge by ID ---#</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">.</span>, <span class="va">mean_tmax</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 14 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -102.0517 ymin: 36.99302 xmax: -94.58841 ymax: 40.00316
Geodetic CRS:  NAD83
First 10 features:
   STATEFP COUNTYFP COUNTYNS       AFFGEOID GEOID         NAME
1       20      175 00485050 0500000US20175 20175       Seward
2       20      027 00484983 0500000US20027 20027         Clay
3       20      171 00485048 0500000US20171 20171        Scott
4       20      047 00484993 0500000US20047 20047      Edwards
5       20      147 00485037 0500000US20147 20147     Phillips
6       20      149 00485038 0500000US20149 20149 Pottawatomie
7       20      055 00485326 0500000US20055 20055       Finney
8       20      167 00485046 0500000US20167 20167      Russell
9       20      135 00485031 0500000US20135 20135         Ness
10      20      093 00485011 0500000US20093 20093       Kearny
              NAMELSAD STUSPS STATE_NAME LSAD      ALAND   AWATER ID     tmax
1        Seward County     KS     Kansas   06 1656693304  1961444  1 34.21421
2          Clay County     KS     Kansas   06 1671314413 26701337  2 32.58354
3         Scott County     KS     Kansas   06 1858536838   306079  3 34.63195
4       Edwards County     KS     Kansas   06 1610699245   206413  4 33.40829
5      Phillips County     KS     Kansas   06 2294395636 22493383  5 34.01768
6  Pottawatomie County     KS     Kansas   06 2177493041 54149843  6 35.54426
7        Finney County     KS     Kansas   06 3372157854  1716371  7 34.47948
8       Russell County     KS     Kansas   06 2295402858 34126776  8 33.55797
9          Ness County     KS     Kansas   06 2783562234   667491  9 34.77049
10       Kearny County     KS     Kansas   06 2254696661  1133601 10 33.56413
                         geometry
1  MULTIPOLYGON (((-101.0681 3...
2  MULTIPOLYGON (((-97.3707 39...
3  MULTIPOLYGON (((-101.1284 3...
4  MULTIPOLYGON (((-99.56988 3...
5  MULTIPOLYGON (((-99.62821 3...
6  MULTIPOLYGON (((-96.72774 3...
7  MULTIPOLYGON (((-101.103 37...
8  MULTIPOLYGON (((-99.04234 3...
9  MULTIPOLYGON (((-100.2477 3...
10 MULTIPOLYGON (((-101.5419 3...</code></pre>
</div>
</div>
</section><section id="extract-and-summarize-in-one-step" class="level4" data-number="5.2.3.2"><h4 data-number="5.2.3.2" class="anchored" data-anchor-id="extract-and-summarize-in-one-step">
<span class="header-section-number">5.2.3.2</span> extract and summarize in one step</h4>
<p>Instead of finding the mean after applying <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> as done above, you can do that within <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> using the <code>fun</code> option.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract values from the raster for each county ---#</span></span>
<span><span class="va">tmax_by_county</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    fun <span class="op">=</span> <span class="va">mean</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                             34.21421
2  2                             32.58354
3  3                             34.63195
4  4                             33.40829
5  5                             34.01768
6  6                             35.54426</code></pre>
</div>
</div>
<p>You can apply other summary functions like <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code>, <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code>.</p>
</section><section id="extract-from-multi-layer-spatraster" class="level4" data-number="5.2.3.3"><h4 data-number="5.2.3.3" class="anchored" data-anchor-id="extract-from-multi-layer-spatraster">
<span class="header-section-number">5.2.3.3</span> extract from multi-layer <code>SpatRaster</code>
</h4>
<p>Extracting values from a multi-layer raster data works exactly the same way except that data processing after the value extraction is slightly more complicated.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from a multi-layer raster object ---#</span></span>
<span><span class="va">tmax_by_county_from_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>,</span>
<span>    <span class="va">KS_county_sf</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county_from_stack</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               34.181                               30.414
2  1                               34.180                               30.314
3  1                               34.210                               30.238
4  1                               34.190                               30.163
5  1                               34.292                               30.207
6  1                               34.258                               30.222</code></pre>
</div>
</div>
<p>Similar to the single-layer case, the resulting object is a <code>data.frame</code> and you have two columns corresponding to each of the layers in the two-layer raster object.</p>
</section><section id="exact-true-option" class="level4" data-number="5.2.3.4"><h4 data-number="5.2.3.4" class="anchored" data-anchor-id="exact-true-option">
<span class="header-section-number">5.2.3.4</span> <code>exact = TRUE</code> option</h4>
<p>Sometimes, you would like to have how much of the raster cells are intersecting with the intersecting polygon to find area-weighted summary later. In that case, you can add <code>exact = TRUE</code> option to <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from a multi-layer raster object ---#</span></span>
<span><span class="va">tmax_by_county_from_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    exact <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county_from_stack</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               34.222                               30.489
2  1                               34.181                               30.414
3  1                               34.180                               30.314
4  1                               34.210                               30.238
5  1                               34.190                               30.163
6  1                               34.292                               30.207
   fraction
1 0.1074196
2 0.8066955
3 0.8067041
4 0.8066761
5 0.8061875
6 0.8054752</code></pre>
</div>
</div>
<p>As you can see, now you have <code>fraction</code> column to the resulting <code>data.frame</code> and you can find area-weighted summary of the extracted values like this:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_by_county_from_stack</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    tmax_0701 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span> <span class="op">*</span> <span class="va">PRISM_tmax_stable_4kmD2_20180701_bil</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span><span class="op">)</span>,</span>
<span>    tmax_0702 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span> <span class="op">*</span> <span class="va">PRISM_tmax_stable_4kmD2_20180702_bil</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 105 × 3
      ID tmax_0701 tmax_0702
   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1     1      34.5      30.5
 2     2      34.5      29.8
 3     3      33.6      31.2
 4     4      32.3      29.5
 5     5      32.6      28.7
 6     6      35.7      28.8
 7     7      34.0      30.6
 8     8      33.4      29.9
 9     9      32.9      30.4
10    10      33.4      30.6
# ℹ 95 more rows</code></pre>
</div>
</div>
</section></section><section id="sec-exactextractr" class="level3 page-columns page-full" data-number="5.2.4"><h3 data-number="5.2.4" class="anchored" data-anchor-id="sec-exactextractr">
<span class="header-section-number">5.2.4</span> Extracting to Polygons (<code>exactextractr</code> way)</h3>
<p><code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> function from the <code>exactextractr</code> package is a faster alternative than <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> for a large raster data as we confirm later (<code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> does not work with points data at the moment).<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> also provides a coverage fraction value for each of the cell-polygon intersections. The syntax of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> is very much similar to <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;See <a href="https://github.com/isciences/exactextract">here</a> for how it does extraction tasks differently from other major GIS software.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- syntax (this does not run) ---#</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>(raster, polygons sf, <span class="at">include_cols =</span> list of vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A notable difference and advantage of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> is that you can specify a list of variables from the polygons <code>sf</code> to be inherited to the output. This means that we do not have to merge the output with the polygons <code>sf</code> using the rule that the <strong>n</strong>th element of the output corresponds to the <strong>n</strong>th row of polygons <code>sf</code> unlike the <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> way. <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> can accept both <code>SpatRaster</code> and <code>Raster</code><span class="math inline">\(^*\)</span> objects as the raster object. However, while it accepts <code>sf</code> as the polygons object, but it does not accept <code>SpatVect</code>.</p>
<section id="extract-from-a-single-layer-spatraster-1" class="level4 page-columns page-full" data-number="5.2.4.1"><h4 data-number="5.2.4.1" class="anchored" data-anchor-id="extract-from-a-single-layer-spatraster-1">
<span class="header-section-number">5.2.4.1</span> extract from a single-layer <code>SpatRaster</code>
</h4>
<p>Let’s get <code>tmax</code> values from the PRISM raster layer for Kansas county polygons, the following does the job:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract values from the raster for each county ---#</span></span>
<span><span class="va">tmax_by_county</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    <span class="co">#--- inherit COUNTYFP from KS_county_sf ---#</span></span>
<span>    include_cols <span class="op">=</span> <span class="st">"COUNTYFP"</span>,</span>
<span>    <span class="co">#--- this is for not displaying progress bar ---#</span></span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting object is a list of <code>data.frame</code>s.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- take a look at the first 6 rows of the first two list elements ---#</span></span>
<span><span class="va">tmax_by_county</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
  COUNTYFP  value coverage_fraction
1      175 34.222         0.1074141
2      175 34.181         0.8066747
3      175 34.180         0.8066615
4      175 34.210         0.8066448
5      175 34.190         0.8061629
6      175 34.292         0.8054324

[[2]]
  COUNTYFP  value coverage_fraction
1      027 33.847        0.03732148
2      027 33.897        0.10592906
3      027 34.010        0.10249268
4      027 34.186        0.10018899
5      027 34.293        0.10074520
6      027 34.220        0.09701102</code></pre>
</div>
</div>
<p>For each element of the list, you see <code>value</code> and <code>coverage_fraction</code>. <code>value</code> is the <code>tmax</code> value of the intersecting raster cells, and <code>coverage_fraction</code> is the fraction of the intersecting area relative to the full raster grid, which can help find coverage-weighted summary of the extracted values (like <code>fraction</code> variable when you use <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> with <code>exact = TRUE</code>).</p>
<p>We can take advantage of <code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">dplyr::bind_rows()</a></code> to combine the list of the datasets into a single <code>data.frame</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co">#--- combine ---#</span></span>
<span>  <span class="va">tmax_combined</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">tmax_by_county</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15,149 × 3
   COUNTYFP value coverage_fraction
   &lt;chr&gt;    &lt;dbl&gt;             &lt;dbl&gt;
 1 175       34.2             0.107
 2 175       34.2             0.807
 3 175       34.2             0.807
 4 175       34.2             0.807
 5 175       34.2             0.806
 6 175       34.3             0.805
 7 175       34.3             0.805
 8 175       34.2             0.805
 9 175       34.2             0.803
10 175       34.2             0.803
# ℹ 15,139 more rows</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<p><code>data.table</code> users can use <code><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">data.table::rbindlist()</a></code> instead.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="va">tmax_by_county</span>, idcol <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          id COUNTYFP  value coverage_fraction
       &lt;int&gt;   &lt;char&gt;  &lt;num&gt;             &lt;num&gt;
    1:     1      175 34.222         0.1074141
    2:     1      175 34.181         0.8066747
    3:     1      175 34.180         0.8066615
    4:     1      175 34.210         0.8066448
    5:     1      175 34.190         0.8061629
   ---                                        
15145:   105      197 34.847         0.7625142
15146:   105      197 34.840         0.7627296
15147:   105      197 34.625         0.7640904
15148:   105      197 34.755         0.7634417
15149:   105      197 34.953         0.6051113</code></pre>
</div>
</div>
</div></div><p>Let’s summarize the data by <code>COUNTYFP</code> and then merge it back to the polygons <code>sf</code> data. Here, we calculate coverage-weighted mean of tmax.</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- weighted mean ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">tmax_by_county</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">tmax_combined</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- group summary ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">COUNTYFP</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>tmax_aw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 105 × 2
   COUNTYFP tmax_aw
   &lt;chr&gt;      &lt;dbl&gt;
 1 001         34.3
 2 003         34.9
 3 005         35.3
 4 007         34.1
 5 009         32.9
 6 011         34.8
 7 013         34.9
 8 015         34.3
 9 017         35.8
10 019         33.4
# ℹ 95 more rows</code></pre>
</div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- merge ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">KS_county_sf</span>, <span class="va">tmax_by_county</span>, by <span class="op">=</span> <span class="st">"COUNTYFP"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">tmax_aw</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -102.0517 ymin: 36.99302 xmax: -94.58841 ymax: 40.00316
Geodetic CRS:  NAD83
First 10 features:
   COUNTYFP  tmax_aw                       geometry
1       175 34.46388 MULTIPOLYGON (((-101.0681 3...
2       027 34.53894 MULTIPOLYGON (((-97.3707 39...
3       171 33.56887 MULTIPOLYGON (((-101.1284 3...
4       047 32.26198 MULTIPOLYGON (((-99.56988 3...
5       147 32.62552 MULTIPOLYGON (((-99.62821 3...
6       149 35.67416 MULTIPOLYGON (((-96.72774 3...
7       055 33.96688 MULTIPOLYGON (((-101.103 37...
8       167 33.35979 MULTIPOLYGON (((-99.04234 3...
9       135 32.86975 MULTIPOLYGON (((-100.2477 3...
10      093 33.41405 MULTIPOLYGON (((-101.5419 3...</code></pre>
</div>
</div>
</section><section id="extract-from-multi-layer-spatraster-1" class="level4 page-columns page-full" data-number="5.2.4.2"><h4 data-number="5.2.4.2" class="anchored" data-anchor-id="extract-from-multi-layer-spatraster-1">
<span class="header-section-number">5.2.4.2</span> extract from multi-layer <code>SpatRaster</code>
</h4>
<p>Extracting values from a multi-layer <code>SpatRaster</code> object works in exactly the same manner as a single-layer <code>SpatRaster</code> object.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_by_county_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    include_cols <span class="op">=</span> <span class="st">"COUNTYFP"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look at the first 6 lines of the first element---#</span></span>
<span><span class="va">tmax_by_county_stack</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  COUNTYFP PRISM_tmax_stable_4kmD2_20180701_bil
1      175                               34.222
2      175                               34.181
3      175                               34.180
4      175                               34.210
5      175                               34.190
6      175                               34.292
  PRISM_tmax_stable_4kmD2_20180702_bil coverage_fraction
1                               30.489         0.1074141
2                               30.414         0.8066747
3                               30.314         0.8066615
4                               30.238         0.8066448
5                               30.163         0.8061629
6                               30.207         0.8054324</code></pre>
</div>
</div>
<p>As you can see above, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> appends additional columns for additional layers.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- combine them ---#</span></span>
<span><span class="va">tmax_all_combined</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">tmax_by_county_stack</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_all_combined</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  COUNTYFP PRISM_tmax_stable_4kmD2_20180701_bil
1      175                               34.222
2      175                               34.181
3      175                               34.180
4      175                               34.210
5      175                               34.190
6      175                               34.292
  PRISM_tmax_stable_4kmD2_20180702_bil coverage_fraction
1                               30.489         0.1074141
2                               30.414         0.8066747
3                               30.314         0.8066615
4                               30.238         0.8066448
5                               30.163         0.8061629
6                               30.207         0.8054324</code></pre>
</div>
</div>
<p>In order to find the coverage-weighted <code>tmax</code> by date, you can first pivot it to a long format using <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">tidyr::pivot_longer()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- pivot to a longer format ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">tmax_long</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>      <span class="va">tmax_all_combined</span>,</span>
<span>      <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">coverage_fraction</span><span class="op">)</span>,</span>
<span>      names_to <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>      values_to <span class="op">=</span> <span class="st">"tmax"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30,298 × 4
   COUNTYFP coverage_fraction date                                  tmax
   &lt;chr&gt;                &lt;dbl&gt; &lt;chr&gt;                                &lt;dbl&gt;
 1 175                  0.107 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 2 175                  0.107 PRISM_tmax_stable_4kmD2_20180702_bil  30.5
 3 175                  0.807 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 4 175                  0.807 PRISM_tmax_stable_4kmD2_20180702_bil  30.4
 5 175                  0.807 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 6 175                  0.807 PRISM_tmax_stable_4kmD2_20180702_bil  30.3
 7 175                  0.807 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 8 175                  0.807 PRISM_tmax_stable_4kmD2_20180702_bil  30.2
 9 175                  0.806 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
10 175                  0.806 PRISM_tmax_stable_4kmD2_20180702_bil  30.2
# ℹ 30,288 more rows</code></pre>
</div>
</div>
<p>And then find coverage-weighted <code>tmax</code> by date:</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_long</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tmax</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 210 × 3
# Groups:   COUNTYFP [105]
   COUNTYFP date                                  tmax
   &lt;chr&gt;    &lt;chr&gt;                                &lt;dbl&gt;
 1 001      PRISM_tmax_stable_4kmD2_20180701_bil  34.3
 2 001      PRISM_tmax_stable_4kmD2_20180702_bil  29.4
 3 003      PRISM_tmax_stable_4kmD2_20180701_bil  34.9
 4 003      PRISM_tmax_stable_4kmD2_20180702_bil  29.4
 5 005      PRISM_tmax_stable_4kmD2_20180701_bil  35.3
 6 005      PRISM_tmax_stable_4kmD2_20180702_bil  28.9
 7 007      PRISM_tmax_stable_4kmD2_20180701_bil  34.1
 8 007      PRISM_tmax_stable_4kmD2_20180702_bil  29.7
 9 009      PRISM_tmax_stable_4kmD2_20180701_bil  32.9
10 009      PRISM_tmax_stable_4kmD2_20180702_bil  29.8
# ℹ 200 more rows</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<p>For <code>data.table</code> users, this does the same:</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_all_combined</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">melt</span><span class="op">(</span>id.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"COUNTYFP"</span>, <span class="st">"coverage_fraction"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     COUNTYFP                             variable     tmax
       &lt;char&gt;                               &lt;fctr&gt;    &lt;num&gt;
  1:      175 PRISM_tmax_stable_4kmD2_20180701_bil 34.46388
  2:      027 PRISM_tmax_stable_4kmD2_20180701_bil 34.53894
  3:      171 PRISM_tmax_stable_4kmD2_20180701_bil 33.56887
  4:      047 PRISM_tmax_stable_4kmD2_20180701_bil 32.26198
  5:      147 PRISM_tmax_stable_4kmD2_20180701_bil 32.62552
 ---                                                       
206:      169 PRISM_tmax_stable_4kmD2_20180702_bil 30.54567
207:      073 PRISM_tmax_stable_4kmD2_20180702_bil 29.64180
208:      071 PRISM_tmax_stable_4kmD2_20180702_bil 30.13041
209:      001 PRISM_tmax_stable_4kmD2_20180702_bil 29.43459
210:      197 PRISM_tmax_stable_4kmD2_20180702_bil 29.97933</code></pre>
</div>
</div>
</div></div></section><section id="extract-and-summarize-in-one-step-1" class="level4" data-number="5.2.4.3"><h4 data-number="5.2.4.3" class="anchored" data-anchor-id="extract-and-summarize-in-one-step-1">
<span class="header-section-number">5.2.4.3</span> extract and summarize in one step</h4>
<p>Instead of returning the value from all the intersecting cells, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> can summarize the extracted values by polygon and then return the summarized numbers. This is much like how <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> with <code>FUN</code> option works. There are multiple default options you can choose from. All you need to do is to add the desired summary function name as the third argument of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. For example, the following will get us the mean of the extracted values weighted by <code>coverage_fraction</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extacted_mean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>, </span>
<span>    <span class="va">KS_county_sf</span>, </span>
<span>    <span class="st">"mean"</span>, </span>
<span>    append_cols <span class="op">=</span> <span class="st">"COUNTYFP"</span>, </span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">extacted_mean</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that you use <code>append_cols</code> instead of <code>include_cols</code> when you summarize within <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">mean_tmax_long</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">extacted_mean</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- wide to long ---#</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">-</span><span class="va">COUNTYFP</span>, names_to <span class="op">=</span> <span class="st">"date"</span>, values_to <span class="op">=</span> <span class="st">"tmax"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- recover date ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"mean.date"</span>, <span class="st">""</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 210 × 3
   COUNTYFP date    tmax
   &lt;chr&gt;    &lt;date&gt; &lt;dbl&gt;
 1 175      NA      34.5
 2 175      NA      30.5
 3 027      NA      34.5
 4 027      NA      29.8
 5 171      NA      33.6
 6 171      NA      31.2
 7 047      NA      32.3
 8 047      NA      29.5
 9 147      NA      32.6
10 147      NA      28.7
# ℹ 200 more rows</code></pre>
</div>
</div>
<p>There are other summary function options that may be of interest, such as “max”, “min.” You can see all the default options at <a href="https://isciences.gitlab.io/exactextractr/index.html#summary-operations">the package website</a>.</p>
</section></section></section><section id="sec-extract-speed" class="level2 page-columns page-full" data-number="5.3"><h2 data-number="5.3" class="anchored" data-anchor-id="sec-extract-speed">
<span class="header-section-number">5.3</span> Extraction speed comparison</h2>
<p>Here we compare the extraction speed of <code><a href="https://rspatial.github.io/terra/reference/extract.html">raster::extract()</a></code>, <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>, and <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. A more comprehensive discussion on the speed of raster extraction can be found in <a href="09-SpeedThingsUp.html" class="quarto-xref"><span>Chapter 9</span></a>.</p>
<section id="data-preparation" class="level3" data-number="5.3.1"><h3 data-number="5.3.1" class="anchored" data-anchor-id="data-preparation">
<span class="header-section-number">5.3.1</span> Data preparation</h3>
<p>We first create two new R objects here:</p>
<ul>
<li>
<code>SpatVectore</code> version of <code>KS_wells</code>, which is currently an <code>sf</code> object.</li>
<li>
<code>SpatVectore</code> version of <code>KS_county_sf</code>, which is currently an <code>sf</code> object.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells_sv</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span></span>
<span><span class="va">KS_county_sv</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also create a version of <code>prism_tmax_0701_KS_sr</code> that is disaggregated by a factor of 10 to create a much larger raster data.</p>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- disaggregate ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">prism_tmax_0701_KS_sr_10</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/disaggregate.html">disagg</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, fact <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 730, 1790, 1  (nrow, ncol, nlyr)
resolution  : 0.004166667, 0.004166667  (x, y)
extent      : -102.0625, -94.60417, 36.97917, 40.02083  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 
source(s)   : memory
varname     : PRISM_tmax_stable_4kmD2_20180701_bil 
name        : PRISM_tmax_stable_4kmD2_20180701_bil 
min value   :                               27.711 
max value   :                               37.656 </code></pre>
</div>
</div>
<p>The disaggregated PRISM data now has 10 times more rows and columns.</p>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- original ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  73 179   1</code></pre>
</div>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- disaggregated ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  730 1790    1</code></pre>
</div>
</div>
</section><section id="points-terraextract" class="level3 page-columns page-full" data-number="5.3.2"><h3 data-number="5.3.2" class="anchored" data-anchor-id="points-terraextract">
<span class="header-section-number">5.3.2</span> Points: <code>terra::extract()</code>
</h3>
<p>Extraction speed of <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> depends on the class of the raster and vector (points) objects<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. Whether the points data is <code>sf</code> or <code>SpatVector</code> makes a difference as you can see below with <code>SpatVector</code> being faster.</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;Until recently, <code><a href="https://rspatial.github.io/terra/reference/extract.html">raster::extract()</a></code> was much much slower compared to <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>. However, recent updates to the package made significant improvement in extraction speed and <code><a href="https://rspatial.github.io/terra/reference/extract.html">raster::extract()</a></code> is comparable to <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> in speed.</p></div></div><div class="cell">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- SpatRaster and sf ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.221 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- SpatRaster and SpatVector ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_wells_sv</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.024 sec elapsed</code></pre>
</div>
</div>
<p>Although the time difference may seem small, it can accumulate significantly when extracting data from numerous raster layers to the same set of points, resulting in a notable increase in overall processing time. In such cases, it is recommended to first convert the points from <code>sf</code> to <code>SpatVector</code> before performing the extractions.</p>
</section><section id="polygons-exactextractrexact_extract-and-terraextract" class="level3" data-number="5.3.3"><h3 data-number="5.3.3" class="anchored" data-anchor-id="polygons-exactextractrexact_extract-and-terraextract">
<span class="header-section-number">5.3.3</span> Polygons: <code>exactextractr::exact_extract()</code> and <code>terra::extract()</code>
</h3>
<p><code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> is faster than <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> for a relatively small raster data. Let’s use <code>prism_tmax_0701_KS_sr</code> and time them to see the difference.</p>
<div class="cell" data-cahce="false">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- terra::extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">terra_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sv</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.031 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- exact_extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">exact_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.069 sec elapsed</code></pre>
</div>
</div>
<p>As you can see, <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> is faster than <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. However, once the raster data becomes larger (or spatially finer), then <code>exact_extact()</code> starts to shine.</p>
<hr>
<p>Now, let’s compare <code>terra::extrct()</code> and <code>exact_extrct()</code> using the disaggregated data.</p>
<div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- terra extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">terra_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">KS_county_sv</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.864 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- exact extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">exact_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exact_extract</span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.132 sec elapsed</code></pre>
</div>
</div>
<p>As you can see, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> is considerably faster. The difference in time becomes even more pronounced as the size of the raster data becomes larger and the number of polygons are greater. The time difference of several seconds seem nothing, but imagine processing Cropland Data Layer (CDL) files for the entire US over 10 years, then you would appreciate the speed of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. See <a href="09-SpeedThingsUp.html" class="quarto-xref"><span>Chapter 9</span></a> for more comprehensive treatment of raster value extraction speed.</p>
</section><section id="single-layer-vs-multi-layer" class="level3" data-number="5.3.4"><h3 data-number="5.3.4" class="anchored" data-anchor-id="single-layer-vs-multi-layer">
<span class="header-section-number">5.3.4</span> Single-layer vs multi-layer</h3>
<p>Pretend that you have five dates of PRISM tmax data (here we repeat the same file five times) and would like to extract values from all of them. Extracting values from a multi-layer raster objects (<code>RasterStack</code> for <code>raster</code> package) takes less time than extracting values from the individual layers one at a time. This can be observed below.</p>
<hr>
<p><strong><code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from 5 layers one at a time ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10.505 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from a 5-layer SpatRaster ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">prism_tmax_ml_5</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_ml_5</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3.094 sec elapsed</code></pre>
</div>
</div>
<hr>
<p><strong><code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from 5 layers one at a time ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.691 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from from a 5-layer SpatRaster ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">prism_tmax_stack_5</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- set layer names ---#</span></span>
<span><span class="co"># exact_extract() does not like multi-layer raster with the same layer name</span></span>
<span><span class="fu">set.names</span><span class="op">(</span><span class="va">prism_tmax_stack_5</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"layer_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack_5</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.384 sec elapsed</code></pre>
</div>
</div>
<p>The reduction in computation time for both methods makes sense. Since both layers have exactly the same geographic extent and resolution, finding the polygons-cells correspondence is done once and then it can be used repeatedly across the layers for the multi-layer <code>SparRaster</code> and <code>RasterStack</code>. This clearly suggests that when you are processing many layers of the same spatial resolution and extent, you should first stack them and then extract values at the same time instead of processing them one by one as long as your memory allows you to do so.</p>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tmieno2\.github\.io\/R-as-GIS-for-Economists\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/04-RasterDataBasics.html" class="pagination-link" aria-label="Raster Data Handling">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb91" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatial Interactions of Vector and Raster Data {#sec-int-RV}</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="in">```{r , eval = FALSE, echo = FALSE}</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="in">setwd(here::here("chapters"))</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="co">#--- load packages ---#</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(exactextractr)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prism)</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyterra)</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a><span class="in">```{r figure_setup}</span></span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a><span class="in">#| include: false</span></span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(</span></span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.title.x = element_text(size = 12, angle = 0, hjust = .5, vjust = -0.3, face = "plain", family = "Times"),</span></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.title.y = element_text(size = 12, angle = 90, hjust = .5, vjust = .9, face = "plain", family = "Times"),</span></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text.x = element_text(size = 10, angle = 0, hjust = .5, vjust = 1.5, face = "plain", family = "Times"),</span></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text.y = element_text(size = 10, angle = 0, hjust = 1, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks = element_line(size = 0.3, linetype = "solid"),</span></span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.ticks = element_blank(),</span></span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks.length = unit(.15, "cm"),</span></span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.ticks.margin = unit(.1,'cm'),</span></span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.text = element_text(margin=unit(.1,'cm')),</span></span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- legend ---#</span></span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.text = element_text(size = 10, angle = 0, hjust = 0, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.title = element_text(size = 10, angle = 0, hjust = 0, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.key.size = unit(0.5, "cm"),</span></span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- strip (for faceting) ---#</span></span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a><span class="in">  strip.text = element_text(size = 10, family = "Times"),</span></span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- plot title ---#</span></span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a><span class="in">  plot.title = element_text(family = "Times", face = "bold", size = 12),</span></span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- margin ---#</span></span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a><span class="in">  # plot.margin = margin(0, 0, 0, 0, "cm"),</span></span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- panel ---#</span></span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.major = element_blank(),</span></span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.minor = element_blank(),</span></span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.background = element_blank(),</span></span>
<span id="cb91-59"><a href="#cb91-59" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.border = element_rect(fill = NA)</span></span>
<span id="cb91-60"><a href="#cb91-60" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-61"><a href="#cb91-61" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-62"><a href="#cb91-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-63"><a href="#cb91-63" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ch05-define_theme}</span></span>
<span id="cb91-64"><a href="#cb91-64" aria-hidden="true" tabindex="-1"></a><span class="in">#| include: false</span></span>
<span id="cb91-65"><a href="#cb91-65" aria-hidden="true" tabindex="-1"></a><span class="in">theme_set(theme_bw())</span></span>
<span id="cb91-66"><a href="#cb91-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-67"><a href="#cb91-67" aria-hidden="true" tabindex="-1"></a><span class="in">theme_for_map &lt;- theme(</span></span>
<span id="cb91-68"><a href="#cb91-68" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks = element_blank(),</span></span>
<span id="cb91-69"><a href="#cb91-69" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text = element_blank(),</span></span>
<span id="cb91-70"><a href="#cb91-70" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.line = element_blank(),</span></span>
<span id="cb91-71"><a href="#cb91-71" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.border = element_blank(),</span></span>
<span id="cb91-72"><a href="#cb91-72" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.major = element_line(color = "transparent"),</span></span>
<span id="cb91-73"><a href="#cb91-73" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.minor = element_line(color = "transparent"),</span></span>
<span id="cb91-74"><a href="#cb91-74" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.background = element_blank(),</span></span>
<span id="cb91-75"><a href="#cb91-75" aria-hidden="true" tabindex="-1"></a><span class="in">  plot.background = element_rect(fill = "transparent", color = "transparent")</span></span>
<span id="cb91-76"><a href="#cb91-76" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-77"><a href="#cb91-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-78"><a href="#cb91-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-79"><a href="#cb91-79" aria-hidden="true" tabindex="-1"></a><span class="fu">## Before you start {-}</span></span>
<span id="cb91-80"><a href="#cb91-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-81"><a href="#cb91-81" aria-hidden="true" tabindex="-1"></a>In this chapter we learn the spatial interactions of a vector and raster dataset. We first look at how to crop (spatially subset) a raster dataset based on the geographic extent of a vector dataset. We then cover how to extract values from raster data for points and polygons. To be precise, here is what we mean by raster data extraction and what it does for points and polygons data:</span>
<span id="cb91-82"><a href="#cb91-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-83"><a href="#cb91-83" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**Points**: For each of the points, find which raster cell it is located within, and assign the value of the cell to the point.  </span>
<span id="cb91-84"><a href="#cb91-84" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb91-85"><a href="#cb91-85" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**Polygons**: For each of the polygons, identify all the raster cells that intersect with the polygon, and assign a vector of the cell values to the polygon</span>
<span id="cb91-86"><a href="#cb91-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-87"><a href="#cb91-87" aria-hidden="true" tabindex="-1"></a>We will show how we can use <span class="in">`terra::extract()`</span> for both cases. But, we will also see that for polygons, <span class="in">`exactextractr::exact_extract()`</span> from the <span class="in">`exactextractr`</span> package is often considerably faster than <span class="in">`terra::extract()`</span>.</span>
<span id="cb91-88"><a href="#cb91-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-89"><a href="#cb91-89" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direction for replication {-}</span></span>
<span id="cb91-90"><a href="#cb91-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-91"><a href="#cb91-91" aria-hidden="true" tabindex="-1"></a>**Datasets**</span>
<span id="cb91-92"><a href="#cb91-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-93"><a href="#cb91-93" aria-hidden="true" tabindex="-1"></a>All the datasets that you need to import are available <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0)</span>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</span>
<span id="cb91-94"><a href="#cb91-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-95"><a href="#cb91-95" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>set a folder (any folder) as the working directory using <span class="in">`setwd()`</span></span>
<span id="cb91-96"><a href="#cb91-96" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>create a folder called "Data" inside the folder designated as the working directory (if you have created a "Data" folder previously, skip this step)</span>
<span id="cb91-97"><a href="#cb91-97" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>download the pertinent datasets from <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0)</span> </span>
<span id="cb91-98"><a href="#cb91-98" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>place all the files in the downloaded folder in the "Data" folder</span>
<span id="cb91-99"><a href="#cb91-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-100"><a href="#cb91-100" aria-hidden="true" tabindex="-1"></a>**Packages**</span>
<span id="cb91-101"><a href="#cb91-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-102"><a href="#cb91-102" aria-hidden="true" tabindex="-1"></a>Run the following code to install or load (if already installed) the <span class="in">`pacman`</span> package, and then install or load (if already installed) the listed package inside the <span class="in">`pacman::p_load()`</span> function.</span>
<span id="cb91-103"><a href="#cb91-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-104"><a href="#cb91-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Chap5_packages}</span></span>
<span id="cb91-105"><a href="#cb91-105" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: false</span></span>
<span id="cb91-106"><a href="#cb91-106" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require("pacman")) install.packages("pacman")</span></span>
<span id="cb91-107"><a href="#cb91-107" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(</span></span>
<span id="cb91-108"><a href="#cb91-108" aria-hidden="true" tabindex="-1"></a><span class="in">  terra, # handle raster data</span></span>
<span id="cb91-109"><a href="#cb91-109" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyterra, # handle and visualize raster data</span></span>
<span id="cb91-110"><a href="#cb91-110" aria-hidden="true" tabindex="-1"></a><span class="in">  raster, # handle raster data</span></span>
<span id="cb91-111"><a href="#cb91-111" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr, # fast extractions</span></span>
<span id="cb91-112"><a href="#cb91-112" aria-hidden="true" tabindex="-1"></a><span class="in">  sf, # vector data operations</span></span>
<span id="cb91-113"><a href="#cb91-113" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr, # data wrangling</span></span>
<span id="cb91-114"><a href="#cb91-114" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyr, # data wrangling</span></span>
<span id="cb91-115"><a href="#cb91-115" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table, # data wrangling</span></span>
<span id="cb91-116"><a href="#cb91-116" aria-hidden="true" tabindex="-1"></a><span class="in">  prism, # download PRISM data</span></span>
<span id="cb91-117"><a href="#cb91-117" aria-hidden="true" tabindex="-1"></a><span class="in">  tictoc, # timing codes</span></span>
<span id="cb91-118"><a href="#cb91-118" aria-hidden="true" tabindex="-1"></a><span class="in">  tigris, # to get county sf</span></span>
<span id="cb91-119"><a href="#cb91-119" aria-hidden="true" tabindex="-1"></a><span class="in">  tmap # for mapping</span></span>
<span id="cb91-120"><a href="#cb91-120" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-121"><a href="#cb91-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-122"><a href="#cb91-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-123"><a href="#cb91-123" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cropping to the Area of Interest {#sec-raster-crop}</span></span>
<span id="cb91-124"><a href="#cb91-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-125"><a href="#cb91-125" aria-hidden="true" tabindex="-1"></a>Here we use PRISM maximum temperature (tmax) data as a raster dataset and Kansas county boundaries as a vector dataset. </span>
<span id="cb91-126"><a href="#cb91-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-127"><a href="#cb91-127" aria-hidden="true" tabindex="-1"></a>Let's download the tmax data for July 1, 2018 (@fig-prism-tmax-map).</span>
<span id="cb91-128"><a href="#cb91-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-129"><a href="#cb91-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prism_download, cache = F, results = "hide"}</span></span>
<span id="cb91-130"><a href="#cb91-130" aria-hidden="true" tabindex="-1"></a><span class="in">#--- set the path to the folder to which you save the downloaded PRISM data ---#</span></span>
<span id="cb91-131"><a href="#cb91-131" aria-hidden="true" tabindex="-1"></a><span class="in"># This code sets the current working directory as the designated folder</span></span>
<span id="cb91-132"><a href="#cb91-132" aria-hidden="true" tabindex="-1"></a><span class="in">options(prism.path = "Data")</span></span>
<span id="cb91-133"><a href="#cb91-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-134"><a href="#cb91-134" aria-hidden="true" tabindex="-1"></a><span class="in">#--- download PRISM precipitation data ---#</span></span>
<span id="cb91-135"><a href="#cb91-135" aria-hidden="true" tabindex="-1"></a><span class="in">prism::get_prism_dailys(</span></span>
<span id="cb91-136"><a href="#cb91-136" aria-hidden="true" tabindex="-1"></a><span class="in">  type = "tmax",</span></span>
<span id="cb91-137"><a href="#cb91-137" aria-hidden="true" tabindex="-1"></a><span class="in">  date = "2018-07-01",</span></span>
<span id="cb91-138"><a href="#cb91-138" aria-hidden="true" tabindex="-1"></a><span class="in">  keepZip = FALSE</span></span>
<span id="cb91-139"><a href="#cb91-139" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-140"><a href="#cb91-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-141"><a href="#cb91-141" aria-hidden="true" tabindex="-1"></a><span class="in">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span id="cb91-142"><a href="#cb91-142" aria-hidden="true" tabindex="-1"></a><span class="in">prism_file &lt;- "Data/PRISM_tmax_stable_4kmD2_20180701_bil/PRISM_tmax_stable_4kmD2_20180701_bil.bil"</span></span>
<span id="cb91-143"><a href="#cb91-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-144"><a href="#cb91-144" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read in the prism data ---#</span></span>
<span id="cb91-145"><a href="#cb91-145" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_0701_sr &lt;- terra::rast(prism_file)</span></span>
<span id="cb91-146"><a href="#cb91-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-147"><a href="#cb91-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-148"><a href="#cb91-148" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb91-151"><a href="#cb91-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-152"><a href="#cb91-152" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-prism-tmax-map</span></span>
<span id="cb91-153"><a href="#cb91-153" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of PRISM tmax data on July 1, 2018"</span></span>
<span id="cb91-154"><a href="#cb91-154" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb91-155"><a href="#cb91-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-156"><a href="#cb91-156" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-157"><a href="#cb91-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_spatraster</span>(<span class="at">data =</span> prism_tmax_0701_sr) <span class="sc">+</span></span>
<span id="cb91-158"><a href="#cb91-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_whitebox_c</span>(</span>
<span id="cb91-159"><a href="#cb91-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"tmax"</span>,</span>
<span id="cb91-160"><a href="#cb91-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette =</span> <span class="st">"muted"</span>,</span>
<span id="cb91-161"><a href="#cb91-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">suffix =</span> <span class="st">"º"</span>),</span>
<span id="cb91-162"><a href="#cb91-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">12</span>,</span>
<span id="cb91-163"><a href="#cb91-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-164"><a href="#cb91-164" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-165"><a href="#cb91-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb91-166"><a href="#cb91-166" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-167"><a href="#cb91-167" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-168"><a href="#cb91-168" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb91-169"><a href="#cb91-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-170"><a href="#cb91-170" aria-hidden="true" tabindex="-1"></a>We now get Kansas county border data from the <span class="in">`tigris`</span> package (@fig-ks-county-map) as <span class="in">`sf`</span>. </span>
<span id="cb91-171"><a href="#cb91-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-174"><a href="#cb91-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-175"><a href="#cb91-175" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb91-176"><a href="#cb91-176" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: "hide"</span></span>
<span id="cb91-177"><a href="#cb91-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-178"><a href="#cb91-178" aria-hidden="true" tabindex="-1"></a><span class="co">#--- Kansas boundary (sf) ---#</span></span>
<span id="cb91-179"><a href="#cb91-179" aria-hidden="true" tabindex="-1"></a>KS_county_sf <span class="ot">&lt;-</span></span>
<span id="cb91-180"><a href="#cb91-180" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- get Kansas county boundary ---</span></span>
<span id="cb91-181"><a href="#cb91-181" aria-hidden="true" tabindex="-1"></a>  tigris<span class="sc">::</span><span class="fu">counties</span>(<span class="at">state =</span> <span class="st">"Kansas"</span>, <span class="at">cb =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb91-182"><a href="#cb91-182" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- sp to sf ---#</span></span>
<span id="cb91-183"><a href="#cb91-183" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-184"><a href="#cb91-184" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- transform using the CRS of the PRISM tmax data  ---#</span></span>
<span id="cb91-185"><a href="#cb91-185" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(prism_tmax_0701_sr))</span>
<span id="cb91-186"><a href="#cb91-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-187"><a href="#cb91-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-188"><a href="#cb91-188" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb91-189"><a href="#cb91-189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ks-county-map}</span></span>
<span id="cb91-190"><a href="#cb91-190" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-ks-county-map</span></span>
<span id="cb91-191"><a href="#cb91-191" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Kansas county boundaries"</span></span>
<span id="cb91-192"><a href="#cb91-192" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb91-193"><a href="#cb91-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-194"><a href="#cb91-194" aria-hidden="true" tabindex="-1"></a><span class="in">#--- gen map ---#</span></span>
<span id="cb91-195"><a href="#cb91-195" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb91-196"><a href="#cb91-196" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = KS_county_sf, fill = NA, color = "blue") +</span></span>
<span id="cb91-197"><a href="#cb91-197" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void()</span></span>
<span id="cb91-198"><a href="#cb91-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-199"><a href="#cb91-199" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-200"><a href="#cb91-200" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb91-201"><a href="#cb91-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-202"><a href="#cb91-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-203"><a href="#cb91-203" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-204"><a href="#cb91-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-205"><a href="#cb91-205" aria-hidden="true" tabindex="-1"></a>Cropping a raster layer to the area of interest can be useful, as it eliminates unnecessary data and reduces processing time. A smaller raster also makes value extraction faster. You can crop a raster layer using <span class="in">`terra::crop()`</span>, as shown below:</span>
<span id="cb91-206"><a href="#cb91-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-207"><a href="#cb91-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r crop_syntax, eval = FALSE}</span></span>
<span id="cb91-208"><a href="#cb91-208" aria-hidden="true" tabindex="-1"></a><span class="in">#--- syntax (this does not run) ---#</span></span>
<span id="cb91-209"><a href="#cb91-209" aria-hidden="true" tabindex="-1"></a><span class="in">terra::crop(SpatRaster, sf)</span></span>
<span id="cb91-210"><a href="#cb91-210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-211"><a href="#cb91-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-212"><a href="#cb91-212" aria-hidden="true" tabindex="-1"></a>So, in this case, this does the job.</span>
<span id="cb91-213"><a href="#cb91-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-214"><a href="#cb91-214" aria-hidden="true" tabindex="-1"></a><span class="in">```{r crop_prism_to_KS, cache = F}</span></span>
<span id="cb91-215"><a href="#cb91-215" aria-hidden="true" tabindex="-1"></a><span class="in">#--- crop the entire PRISM to its KS portion---#</span></span>
<span id="cb91-216"><a href="#cb91-216" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_0701_KS_sr &lt;-</span></span>
<span id="cb91-217"><a href="#cb91-217" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::crop(</span></span>
<span id="cb91-218"><a href="#cb91-218" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_sr,</span></span>
<span id="cb91-219"><a href="#cb91-219" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf</span></span>
<span id="cb91-220"><a href="#cb91-220" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-221"><a href="#cb91-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-222"><a href="#cb91-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-223"><a href="#cb91-223" aria-hidden="true" tabindex="-1"></a>@fig-prism-ks-viz shows the PRISM tmax raster data cropped to the geographic extent of Kansas. Notice that the cropped raster layer extends beyond the outer boundary of Kansas state boundary (it is a bit hard to see, but look at the upper right corner).  </span>
<span id="cb91-224"><a href="#cb91-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-227"><a href="#cb91-227" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-228"><a href="#cb91-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-prism-ks-viz</span></span>
<span id="cb91-229"><a href="#cb91-229" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "PRISM tmax raster data cropped to the geographic extent of Kansas"</span></span>
<span id="cb91-230"><a href="#cb91-230" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb91-231"><a href="#cb91-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-232"><a href="#cb91-232" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-233"><a href="#cb91-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_spatraster</span>(<span class="at">data =</span> prism_tmax_0701_KS_sr) <span class="sc">+</span></span>
<span id="cb91-234"><a href="#cb91-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_county_sf, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb91-235"><a href="#cb91-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_whitebox_c</span>(</span>
<span id="cb91-236"><a href="#cb91-236" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"tmax"</span>,</span>
<span id="cb91-237"><a href="#cb91-237" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette =</span> <span class="st">"muted"</span>,</span>
<span id="cb91-238"><a href="#cb91-238" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">suffix =</span> <span class="st">"º"</span>),</span>
<span id="cb91-239"><a href="#cb91-239" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">12</span>,</span>
<span id="cb91-240"><a href="#cb91-240" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-241"><a href="#cb91-241" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-242"><a href="#cb91-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb91-243"><a href="#cb91-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-244"><a href="#cb91-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-245"><a href="#cb91-245" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extracting Values from Raster Layers for Vector Data {#sec-extract-raster-to-vector}</span></span>
<span id="cb91-246"><a href="#cb91-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-247"><a href="#cb91-247" aria-hidden="true" tabindex="-1"></a>In this section, we will learn how to extract information from raster layers for spatial units represented as vector data (points and polygons). For the demonstrations in this section, we use the following datasets:</span>
<span id="cb91-248"><a href="#cb91-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-249"><a href="#cb91-249" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Raster: PRISM tmax data cropped to Kansas state border for 07/01/2018 (obtained in @sec-raster-crop) and 07/02/2018 (downloaded below)</span>
<span id="cb91-250"><a href="#cb91-250" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Polygons: Kansas county boundaries (obtained in @sec-raster-crop)</span>
<span id="cb91-251"><a href="#cb91-251" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Points: Irrigation wells in Kansas (imported below) </span>
<span id="cb91-252"><a href="#cb91-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-253"><a href="#cb91-253" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simple visual illustrations of raster data extraction</span></span>
<span id="cb91-254"><a href="#cb91-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-255"><a href="#cb91-255" aria-hidden="true" tabindex="-1"></a>**Extracting to Points**</span>
<span id="cb91-256"><a href="#cb91-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-257"><a href="#cb91-257" aria-hidden="true" tabindex="-1"></a>@fig-illustrate-points shows visually what we mean by "extract raster values to points."</span>
<span id="cb91-258"><a href="#cb91-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-261"><a href="#cb91-261" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-262"><a href="#cb91-262" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-illustrate-points</span></span>
<span id="cb91-263"><a href="#cb91-263" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visual illustration of raster data extraction for points data"</span></span>
<span id="cb91-264"><a href="#cb91-264" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb91-265"><a href="#cb91-265" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">378533</span>)</span>
<span id="cb91-266"><a href="#cb91-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-267"><a href="#cb91-267" aria-hidden="true" tabindex="-1"></a><span class="co">#--- create polygons ---#</span></span>
<span id="cb91-268"><a href="#cb91-268" aria-hidden="true" tabindex="-1"></a>polygon <span class="ot">&lt;-</span></span>
<span id="cb91-269"><a href="#cb91-269" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_polygon</span>(<span class="fu">list</span>(</span>
<span id="cb91-270"><a href="#cb91-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">8</span>), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">8</span>), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb91-271"><a href="#cb91-271" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb91-272"><a href="#cb91-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-273"><a href="#cb91-273" aria-hidden="true" tabindex="-1"></a>raster_like_cells <span class="ot">&lt;-</span></span>
<span id="cb91-274"><a href="#cb91-274" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_grid</span>(polygon, <span class="at">n =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">8</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb91-275"><a href="#cb91-275" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-276"><a href="#cb91-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">64</span>, <span class="dv">64</span>))</span>
<span id="cb91-277"><a href="#cb91-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-278"><a href="#cb91-278" aria-hidden="true" tabindex="-1"></a>stars_cells <span class="ot">&lt;-</span></span>
<span id="cb91-279"><a href="#cb91-279" aria-hidden="true" tabindex="-1"></a>  stars<span class="sc">::</span><span class="fu">st_rasterize</span>(raster_like_cells, <span class="at">nx =</span> <span class="dv">8</span>, <span class="at">ny =</span> <span class="dv">8</span>)</span>
<span id="cb91-280"><a href="#cb91-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-281"><a href="#cb91-281" aria-hidden="true" tabindex="-1"></a>cell_centroids <span class="ot">&lt;-</span></span>
<span id="cb91-282"><a href="#cb91-282" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_centroid</span>(raster_like_cells) <span class="sc">%&gt;%</span></span>
<span id="cb91-283"><a href="#cb91-283" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>()</span>
<span id="cb91-284"><a href="#cb91-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-285"><a href="#cb91-285" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb91-286"><a href="#cb91-286" aria-hidden="true" tabindex="-1"></a><span class="co"># Create points for which values are extracted</span></span>
<span id="cb91-287"><a href="#cb91-287" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb91-288"><a href="#cb91-288" aria-hidden="true" tabindex="-1"></a><span class="co">#--- points ---#</span></span>
<span id="cb91-289"><a href="#cb91-289" aria-hidden="true" tabindex="-1"></a>point_1 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">2.4</span>, <span class="fl">2.2</span>))</span>
<span id="cb91-290"><a href="#cb91-290" aria-hidden="true" tabindex="-1"></a>point_2 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">6.7</span>, <span class="fl">1.8</span>))</span>
<span id="cb91-291"><a href="#cb91-291" aria-hidden="true" tabindex="-1"></a>point_3 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">4.2</span>, <span class="fl">7.1</span>))</span>
<span id="cb91-292"><a href="#cb91-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-293"><a href="#cb91-293" aria-hidden="true" tabindex="-1"></a><span class="co">#--- combine the points to make a single  sf of points ---#</span></span>
<span id="cb91-294"><a href="#cb91-294" aria-hidden="true" tabindex="-1"></a>points <span class="ot">&lt;-</span> <span class="fu">list</span>(point_1, point_2, point_3) <span class="sc">%&gt;%</span></span>
<span id="cb91-295"><a href="#cb91-295" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_sfc</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-296"><a href="#cb91-296" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-297"><a href="#cb91-297" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">point_name =</span> <span class="fu">c</span>(<span class="st">"Point 1"</span>, <span class="st">"Point 2"</span>, <span class="st">"Point 3"</span>))</span>
<span id="cb91-298"><a href="#cb91-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-299"><a href="#cb91-299" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb91-300"><a href="#cb91-300" aria-hidden="true" tabindex="-1"></a><span class="co"># Create maps</span></span>
<span id="cb91-301"><a href="#cb91-301" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb91-302"><a href="#cb91-302" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-303"><a href="#cb91-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> stars_cells, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-304"><a href="#cb91-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">name =</span> <span class="st">"Value"</span>, <span class="at">palette =</span> <span class="st">"Spectral"</span>) <span class="sc">+</span></span>
<span id="cb91-305"><a href="#cb91-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> raster_like_cells, <span class="fu">aes</span>(<span class="at">label =</span> value)) <span class="sc">+</span></span>
<span id="cb91-306"><a href="#cb91-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> points, <span class="fu">aes</span>(<span class="at">shape =</span> point_name), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb91-307"><a href="#cb91-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape</span>(<span class="at">name =</span> <span class="st">"Points"</span>) <span class="sc">+</span></span>
<span id="cb91-308"><a href="#cb91-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb91-309"><a href="#cb91-309" aria-hidden="true" tabindex="-1"></a>  theme_for_map</span>
<span id="cb91-310"><a href="#cb91-310" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-311"><a href="#cb91-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-312"><a href="#cb91-312" aria-hidden="true" tabindex="-1"></a>In the figure, we have grids (cells) and each grid holds a value (presented at the center). There are three points. We will find which grid the points fall inside and get the associated values and assign them to the points. In this example, Points 1, 2, and 3 will have 50, 4, 54, respectively,</span>
<span id="cb91-313"><a href="#cb91-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-314"><a href="#cb91-314" aria-hidden="true" tabindex="-1"></a>**Extracting to Polygons**</span>
<span id="cb91-315"><a href="#cb91-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-316"><a href="#cb91-316" aria-hidden="true" tabindex="-1"></a>@fig-polygons-extact-viz shows visually what we mean by "extract raster values to polygons."</span>
<span id="cb91-317"><a href="#cb91-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-320"><a href="#cb91-320" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-321"><a href="#cb91-321" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb91-322"><a href="#cb91-322" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-polygons-extact-viz</span></span>
<span id="cb91-323"><a href="#cb91-323" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visual illustration of raster data extraction for polygons data" </span></span>
<span id="cb91-324"><a href="#cb91-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-325"><a href="#cb91-325" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb91-326"><a href="#cb91-326" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a polygon for which values are extracted</span></span>
<span id="cb91-327"><a href="#cb91-327" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb91-328"><a href="#cb91-328" aria-hidden="true" tabindex="-1"></a>polygon_extract <span class="ot">&lt;-</span></span>
<span id="cb91-329"><a href="#cb91-329" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_polygon</span>(<span class="fu">list</span>(</span>
<span id="cb91-330"><a href="#cb91-330" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="fl">1.5</span>, <span class="dv">2</span>), <span class="fu">c</span>(<span class="dv">6</span>, <span class="fl">2.3</span>), <span class="fu">c</span>(<span class="dv">7</span>, <span class="fl">6.5</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>), <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="dv">2</span>))</span>
<span id="cb91-331"><a href="#cb91-331" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb91-332"><a href="#cb91-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-333"><a href="#cb91-333" aria-hidden="true" tabindex="-1"></a>polygons_extract_viz <span class="ot">&lt;-</span></span>
<span id="cb91-334"><a href="#cb91-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-335"><a href="#cb91-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> stars_cells, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-336"><a href="#cb91-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">name =</span> <span class="st">"Value"</span>, <span class="at">palette =</span> <span class="st">"Spectral"</span>) <span class="sc">+</span></span>
<span id="cb91-337"><a href="#cb91-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygon_extract, <span class="at">fill =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-338"><a href="#cb91-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> cell_centroids, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb91-339"><a href="#cb91-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(</span>
<span id="cb91-340"><a href="#cb91-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> raster_like_cells, </span>
<span id="cb91-341"><a href="#cb91-341" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> value),</span>
<span id="cb91-342"><a href="#cb91-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="sc">-</span><span class="fl">0.25</span>,</span>
<span id="cb91-343"><a href="#cb91-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="fl">0.25</span></span>
<span id="cb91-344"><a href="#cb91-344" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-345"><a href="#cb91-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb91-346"><a href="#cb91-346" aria-hidden="true" tabindex="-1"></a>  theme_for_map</span>
<span id="cb91-347"><a href="#cb91-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-348"><a href="#cb91-348" aria-hidden="true" tabindex="-1"></a>polygons_extract_viz</span>
<span id="cb91-349"><a href="#cb91-349" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-350"><a href="#cb91-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-351"><a href="#cb91-351" aria-hidden="true" tabindex="-1"></a>There is a polygon overlaid on top of the cells along with their centroids represented by black dots. Extracting raster values to a polygon means finding raster cells that intersect with the polygons and get the value of all those cells and assigns them to the polygon. As you can see some cells are completely inside the polygon, while others are only partially overlapping with the polygon. Depending on the function you use and its options, you regard different cells as being spatially related to the polygons. For example, by default, <span class="in">`terra::extract()`</span> will extract only the cells whose centroid is inside the polygon. But, you can add an option to include the cells that are only partially intersected with the polygon. In such a case, you can also get the fraction of the cell what is overlapped with the polygon, which enables us to find area-weighted values later. We will discuss the details these below.</span>
<span id="cb91-352"><a href="#cb91-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-353"><a href="#cb91-353" aria-hidden="true" tabindex="-1"></a>**PRISM tmax data for 07/02/2018**</span>
<span id="cb91-354"><a href="#cb91-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-355"><a href="#cb91-355" aria-hidden="true" tabindex="-1"></a><span class="in">```{r download_07022018, cache = F, results = "hide"}</span></span>
<span id="cb91-356"><a href="#cb91-356" aria-hidden="true" tabindex="-1"></a><span class="in">#--- download PRISM precipitation data ---#</span></span>
<span id="cb91-357"><a href="#cb91-357" aria-hidden="true" tabindex="-1"></a><span class="in">prism::get_prism_dailys(</span></span>
<span id="cb91-358"><a href="#cb91-358" aria-hidden="true" tabindex="-1"></a><span class="in">  type = "tmax",</span></span>
<span id="cb91-359"><a href="#cb91-359" aria-hidden="true" tabindex="-1"></a><span class="in">  date = "2018-07-02",</span></span>
<span id="cb91-360"><a href="#cb91-360" aria-hidden="true" tabindex="-1"></a><span class="in">  keepZip = FALSE</span></span>
<span id="cb91-361"><a href="#cb91-361" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-362"><a href="#cb91-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-363"><a href="#cb91-363" aria-hidden="true" tabindex="-1"></a><span class="in">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span id="cb91-364"><a href="#cb91-364" aria-hidden="true" tabindex="-1"></a><span class="in">prism_file &lt;- "Data/PRISM_tmax_stable_4kmD2_20180702_bil/PRISM_tmax_stable_4kmD2_20180702_bil.bil"</span></span>
<span id="cb91-365"><a href="#cb91-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-366"><a href="#cb91-366" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read in the prism data and crop it to Kansas state border ---#</span></span>
<span id="cb91-367"><a href="#cb91-367" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_0702_KS_sr &lt;-</span></span>
<span id="cb91-368"><a href="#cb91-368" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::rast(prism_file) %&gt;%</span></span>
<span id="cb91-369"><a href="#cb91-369" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::crop(KS_county_sf)</span></span>
<span id="cb91-370"><a href="#cb91-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-371"><a href="#cb91-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-372"><a href="#cb91-372" aria-hidden="true" tabindex="-1"></a>**Irrigation wells in Kansas:**</span>
<span id="cb91-373"><a href="#cb91-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-374"><a href="#cb91-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{r import_KS_wells}</span></span>
<span id="cb91-375"><a href="#cb91-375" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read in the KS points data ---#</span></span>
<span id="cb91-376"><a href="#cb91-376" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb91-377"><a href="#cb91-377" aria-hidden="true" tabindex="-1"></a><span class="in">  KS_wells &lt;- readRDS("Data/Chap_5_wells_KS.rds")</span></span>
<span id="cb91-378"><a href="#cb91-378" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-379"><a href="#cb91-379" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-380"><a href="#cb91-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-381"><a href="#cb91-381" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-382"><a href="#cb91-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-383"><a href="#cb91-383" aria-hidden="true" tabindex="-1"></a>Here is how the wells are spatially distributed over the PRISM grids and Kansas county borders (@fig-tmax-prism-wells):</span>
<span id="cb91-384"><a href="#cb91-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-387"><a href="#cb91-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-388"><a href="#cb91-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb91-389"><a href="#cb91-389" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of Kansas county borders, irrigation wells, and PRISM tmax" </span></span>
<span id="cb91-390"><a href="#cb91-390" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tmax-prism-wells</span></span>
<span id="cb91-391"><a href="#cb91-391" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(KS_county_sf) <span class="sc">+</span></span>
<span id="cb91-392"><a href="#cb91-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb91-393"><a href="#cb91-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(KS_wells) <span class="sc">+</span></span>
<span id="cb91-394"><a href="#cb91-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_symbols</span>(<span class="at">size =</span> <span class="fl">0.02</span>) <span class="sc">+</span></span>
<span id="cb91-395"><a href="#cb91-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(</span>
<span id="cb91-396"><a href="#cb91-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">frame =</span> <span class="cn">FALSE</span>,</span>
<span id="cb91-397"><a href="#cb91-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.outside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb91-398"><a href="#cb91-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.outside.position =</span> <span class="st">"bottom"</span></span>
<span id="cb91-399"><a href="#cb91-399" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-400"><a href="#cb91-400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-401"><a href="#cb91-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-402"><a href="#cb91-402" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting to Points</span></span>
<span id="cb91-403"><a href="#cb91-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-404"><a href="#cb91-404" aria-hidden="true" tabindex="-1"></a>You can extract values from raster layers to points using <span class="in">`terra::extract()`</span>. <span class="in">`terra::extract()`</span> finds which raster cell each of the points is located within and assigns the value of the cell to the point. </span>
<span id="cb91-405"><a href="#cb91-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-406"><a href="#cb91-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb91-407"><a href="#cb91-407" aria-hidden="true" tabindex="-1"></a><span class="in">#--- syntax (this does not run) ---#</span></span>
<span id="cb91-408"><a href="#cb91-408" aria-hidden="true" tabindex="-1"></a><span class="in">terra::extract(raster, points)</span></span>
<span id="cb91-409"><a href="#cb91-409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-410"><a href="#cb91-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-411"><a href="#cb91-411" aria-hidden="true" tabindex="-1"></a>The <span class="in">`points`</span> objects can be either <span class="in">`sf`</span> or <span class="in">`SpatVect`</span>^<span class="co">[</span><span class="ot">`terra::extract` used to accept only `SpatVect` and the `sf` objects had to be converted to a `SpatVect` using `terra::vect()`</span><span class="co">]</span>. </span>
<span id="cb91-412"><a href="#cb91-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-413"><a href="#cb91-413" aria-hidden="true" tabindex="-1"></a>Let's extract <span class="in">`tmax`</span> values from the PRISM tmax layer (<span class="in">`prism_tmax_0701_KS_sr`</span>) to the irrigation wells (<span class="in">`KS_wells`</span> as <span class="in">`sf`</span>):</span>
<span id="cb91-414"><a href="#cb91-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-417"><a href="#cb91-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-418"><a href="#cb91-418" aria-hidden="true" tabindex="-1"></a>tmax_from_prism <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(prism_tmax_0701_KS_sr, KS_wells)</span>
<span id="cb91-419"><a href="#cb91-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-420"><a href="#cb91-420" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tmax_from_prism)</span>
<span id="cb91-421"><a href="#cb91-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-422"><a href="#cb91-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-423"><a href="#cb91-423" aria-hidden="true" tabindex="-1"></a>The resulting object is a <span class="in">`data.frame`</span>, where the <span class="in">`ID`</span> variable represents the order of the observations in the points data and the second column represents that values extracted for the points from the raster cells. So, you can assign the extracted values as a new variable of the points data as follows: </span>
<span id="cb91-424"><a href="#cb91-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-427"><a href="#cb91-427" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-428"><a href="#cb91-428" aria-hidden="true" tabindex="-1"></a>KS_wells<span class="sc">$</span>tmax_07_01 <span class="ot">&lt;-</span> tmax_from_prism[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb91-429"><a href="#cb91-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span>   </span>
<span id="cb91-430"><a href="#cb91-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-431"><a href="#cb91-431" aria-hidden="true" tabindex="-1"></a>Extracting values from a multi-layer <span class="in">`SpatRaster`</span> works the same way. Here, we combine <span class="in">`prism_tmax_0701_KS_sr`</span> and <span class="in">`prism_tmax_0702_KS_sr`</span> to create a multi-layer <span class="in">`SpatRaster`</span> and then extract values from them.</span>
<span id="cb91-432"><a href="#cb91-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-433"><a href="#cb91-433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract_tmax_run_stack}</span></span>
<span id="cb91-434"><a href="#cb91-434" aria-hidden="true" tabindex="-1"></a><span class="in">#--- create a multi-layer SpatRaster ---#</span></span>
<span id="cb91-435"><a href="#cb91-435" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_stack &lt;- c(prism_tmax_0701_KS_sr, prism_tmax_0702_KS_sr)</span></span>
<span id="cb91-436"><a href="#cb91-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-437"><a href="#cb91-437" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract tmax values ---#</span></span>
<span id="cb91-438"><a href="#cb91-438" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_from_prism_stack &lt;- terra::extract(prism_tmax_stack, KS_wells)</span></span>
<span id="cb91-439"><a href="#cb91-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-440"><a href="#cb91-440" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb91-441"><a href="#cb91-441" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_from_prism_stack)</span></span>
<span id="cb91-442"><a href="#cb91-442" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-443"><a href="#cb91-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-444"><a href="#cb91-444" aria-hidden="true" tabindex="-1"></a>We now have two columns that hold values extracted from the raster cells: the 2nd column for the 1st raster layer and the 3rd column for the 2nd raster layer in <span class="in">`prism_tmax_stack`</span>.</span>
<span id="cb91-445"><a href="#cb91-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-446"><a href="#cb91-446" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting to Polygons (`terra` way)</span></span>
<span id="cb91-447"><a href="#cb91-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-448"><a href="#cb91-448" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`terra::extract()`</span> for extracting raster cell values for polygons as well. For each of the polygons, it will identify all the raster cells whose center lies inside the polygon and assign the vector of values of the cells to the polygon. </span>
<span id="cb91-449"><a href="#cb91-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-450"><a href="#cb91-450" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract from a single-layer `SpatRaster`</span></span>
<span id="cb91-451"><a href="#cb91-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-452"><a href="#cb91-452" aria-hidden="true" tabindex="-1"></a>Let's extract <span class="in">`tmax`</span> values from <span class="in">`prism_tmax_0701_KS_sr`</span> for each of the KS counties.</span>
<span id="cb91-453"><a href="#cb91-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-454"><a href="#cb91-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra-extract-polygon, eval = F}</span></span>
<span id="cb91-455"><a href="#cb91-455" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract values from the raster for each county ---#</span></span>
<span id="cb91-456"><a href="#cb91-456" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;- terra::extract(prism_tmax_0701_KS_sr, KS_county_sf)</span></span>
<span id="cb91-457"><a href="#cb91-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-458"><a href="#cb91-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-459"><a href="#cb91-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra-extract-polygon-show, echo = F}</span></span>
<span id="cb91-460"><a href="#cb91-460" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(tmax_by_county, "Data/tmax-by-county-terra.rds")</span></span>
<span id="cb91-461"><a href="#cb91-461" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;- readRDS("Data/tmax-by-county-terra.rds")</span></span>
<span id="cb91-462"><a href="#cb91-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-463"><a href="#cb91-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-464"><a href="#cb91-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r check-the-extracted-values}</span></span>
<span id="cb91-465"><a href="#cb91-465" aria-hidden="true" tabindex="-1"></a><span class="in">#--- check the class ---#</span></span>
<span id="cb91-466"><a href="#cb91-466" aria-hidden="true" tabindex="-1"></a><span class="in">class(tmax_by_county)</span></span>
<span id="cb91-467"><a href="#cb91-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-468"><a href="#cb91-468" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb91-469"><a href="#cb91-469" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_by_county)</span></span>
<span id="cb91-470"><a href="#cb91-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-471"><a href="#cb91-471" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb91-472"><a href="#cb91-472" aria-hidden="true" tabindex="-1"></a><span class="in">tail(tmax_by_county)</span></span>
<span id="cb91-473"><a href="#cb91-473" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-474"><a href="#cb91-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-475"><a href="#cb91-475" aria-hidden="true" tabindex="-1"></a>So, <span class="in">`terra::extract()`</span> returns a <span class="in">`data.frame`</span>, where <span class="in">`ID`</span> values represent the corresponding row number in the polygons data. For example, the observations with <span class="in">`ID == n`</span> are for the **n**th polygon. Using this information, you can easily merge the extraction results to the polygons data. Suppose you are interested in the mean of the <span class="in">`tmax`</span> values of the intersecting cells for each of the polygons, then you can do the following:</span>
<span id="cb91-476"><a href="#cb91-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-477"><a href="#cb91-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r c05-mean-merge}</span></span>
<span id="cb91-478"><a href="#cb91-478" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get mean tmax ---#</span></span>
<span id="cb91-479"><a href="#cb91-479" aria-hidden="true" tabindex="-1"></a><span class="in">mean_tmax &lt;-</span></span>
<span id="cb91-480"><a href="#cb91-480" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_by_county %&gt;%</span></span>
<span id="cb91-481"><a href="#cb91-481" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(ID) %&gt;%</span></span>
<span id="cb91-482"><a href="#cb91-482" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(tmax = mean(PRISM_tmax_stable_4kmD2_20180701_bil))</span></span>
<span id="cb91-483"><a href="#cb91-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-484"><a href="#cb91-484" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb91-485"><a href="#cb91-485" aria-hidden="true" tabindex="-1"></a><span class="in">  KS_county_sf &lt;-</span></span>
<span id="cb91-486"><a href="#cb91-486" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- back to sf ---#</span></span>
<span id="cb91-487"><a href="#cb91-487" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf %&gt;%</span></span>
<span id="cb91-488"><a href="#cb91-488" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- define ID ---#</span></span>
<span id="cb91-489"><a href="#cb91-489" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(ID := seq_len(nrow(.))) %&gt;%</span></span>
<span id="cb91-490"><a href="#cb91-490" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- merge by ID ---#</span></span>
<span id="cb91-491"><a href="#cb91-491" aria-hidden="true" tabindex="-1"></a><span class="in">    left_join(., mean_tmax, by = "ID")</span></span>
<span id="cb91-492"><a href="#cb91-492" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-493"><a href="#cb91-493" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-494"><a href="#cb91-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-495"><a href="#cb91-495" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract and summarize in one step</span></span>
<span id="cb91-496"><a href="#cb91-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-497"><a href="#cb91-497" aria-hidden="true" tabindex="-1"></a>Instead of finding the mean after applying <span class="in">`terra::extract()`</span> as done above, you can do that within <span class="in">`terra::extract()`</span> using the <span class="in">`fun`</span> option. </span>
<span id="cb91-498"><a href="#cb91-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-499"><a href="#cb91-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra-extract-polygon-mean, eval = F}</span></span>
<span id="cb91-500"><a href="#cb91-500" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract values from the raster for each county ---#</span></span>
<span id="cb91-501"><a href="#cb91-501" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;-</span></span>
<span id="cb91-502"><a href="#cb91-502" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb91-503"><a href="#cb91-503" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr,</span></span>
<span id="cb91-504"><a href="#cb91-504" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb91-505"><a href="#cb91-505" aria-hidden="true" tabindex="-1"></a><span class="in">    fun = mean</span></span>
<span id="cb91-506"><a href="#cb91-506" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-507"><a href="#cb91-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-508"><a href="#cb91-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-509"><a href="#cb91-509" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra-extract-polygon-mean-show, echo = F}</span></span>
<span id="cb91-510"><a href="#cb91-510" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(tmax_by_county, "Data/tmax-by-county-mean.rds")</span></span>
<span id="cb91-511"><a href="#cb91-511" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;- readRDS("Data/tmax-by-county-mean.rds")</span></span>
<span id="cb91-512"><a href="#cb91-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-513"><a href="#cb91-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-514"><a href="#cb91-514" aria-hidden="true" tabindex="-1"></a><span class="in">```{r take-a-look-e-polygons-sum}</span></span>
<span id="cb91-515"><a href="#cb91-515" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb91-516"><a href="#cb91-516" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_by_county)</span></span>
<span id="cb91-517"><a href="#cb91-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-518"><a href="#cb91-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-519"><a href="#cb91-519" aria-hidden="true" tabindex="-1"></a>You can apply other summary functions like <span class="in">`min()`</span>, <span class="in">`max()`</span>, <span class="in">`sum()`</span>.</span>
<span id="cb91-520"><a href="#cb91-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-521"><a href="#cb91-521" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract from multi-layer `SpatRaster`</span></span>
<span id="cb91-522"><a href="#cb91-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-523"><a href="#cb91-523" aria-hidden="true" tabindex="-1"></a>Extracting values from a multi-layer raster data works exactly the same way except that data processing after the value extraction is slightly more complicated. </span>
<span id="cb91-524"><a href="#cb91-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-525"><a href="#cb91-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra_exatrac_from_stack_run}</span></span>
<span id="cb91-526"><a href="#cb91-526" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from a multi-layer raster object ---#</span></span>
<span id="cb91-527"><a href="#cb91-527" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_from_stack &lt;-</span></span>
<span id="cb91-528"><a href="#cb91-528" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb91-529"><a href="#cb91-529" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack,</span></span>
<span id="cb91-530"><a href="#cb91-530" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf</span></span>
<span id="cb91-531"><a href="#cb91-531" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-532"><a href="#cb91-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-533"><a href="#cb91-533" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb91-534"><a href="#cb91-534" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_by_county_from_stack)</span></span>
<span id="cb91-535"><a href="#cb91-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-536"><a href="#cb91-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-537"><a href="#cb91-537" aria-hidden="true" tabindex="-1"></a>Similar to the single-layer case, the resulting object is a <span class="in">`data.frame`</span> and you have two columns corresponding to each of the layers in the two-layer raster object. </span>
<span id="cb91-538"><a href="#cb91-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-539"><a href="#cb91-539" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `exact = TRUE` option</span></span>
<span id="cb91-540"><a href="#cb91-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-541"><a href="#cb91-541" aria-hidden="true" tabindex="-1"></a>Sometimes, you would like to have how much of the raster cells are intersecting with the intersecting polygon to find area-weighted summary later. In that case, you can add <span class="in">`exact = TRUE`</span> option to <span class="in">`terra::extract()`</span>.</span>
<span id="cb91-542"><a href="#cb91-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-543"><a href="#cb91-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-with-weights}</span></span>
<span id="cb91-544"><a href="#cb91-544" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from a multi-layer raster object ---#</span></span>
<span id="cb91-545"><a href="#cb91-545" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_from_stack &lt;-</span></span>
<span id="cb91-546"><a href="#cb91-546" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb91-547"><a href="#cb91-547" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack,</span></span>
<span id="cb91-548"><a href="#cb91-548" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb91-549"><a href="#cb91-549" aria-hidden="true" tabindex="-1"></a><span class="in">    exact = TRUE</span></span>
<span id="cb91-550"><a href="#cb91-550" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-551"><a href="#cb91-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-552"><a href="#cb91-552" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb91-553"><a href="#cb91-553" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_by_county_from_stack)</span></span>
<span id="cb91-554"><a href="#cb91-554" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-555"><a href="#cb91-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-556"><a href="#cb91-556" aria-hidden="true" tabindex="-1"></a>As you can see, now you have <span class="in">`fraction`</span> column to the resulting <span class="in">`data.frame`</span> and you can find area-weighted summary of the extracted values like this:</span>
<span id="cb91-557"><a href="#cb91-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-558"><a href="#cb91-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{r area-weighted-extract}</span></span>
<span id="cb91-559"><a href="#cb91-559" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_from_stack %&gt;%</span></span>
<span id="cb91-560"><a href="#cb91-560" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(ID) %&gt;%</span></span>
<span id="cb91-561"><a href="#cb91-561" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(</span></span>
<span id="cb91-562"><a href="#cb91-562" aria-hidden="true" tabindex="-1"></a><span class="in">    tmax_0701 = sum(fraction * PRISM_tmax_stable_4kmD2_20180701_bil) / sum(fraction),</span></span>
<span id="cb91-563"><a href="#cb91-563" aria-hidden="true" tabindex="-1"></a><span class="in">    tmax_0702 = sum(fraction * PRISM_tmax_stable_4kmD2_20180702_bil) / sum(fraction)</span></span>
<span id="cb91-564"><a href="#cb91-564" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-565"><a href="#cb91-565" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-566"><a href="#cb91-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-567"><a href="#cb91-567" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting to Polygons (`exactextractr` way) {#sec-exactextractr}</span></span>
<span id="cb91-568"><a href="#cb91-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-569"><a href="#cb91-569" aria-hidden="true" tabindex="-1"></a><span class="in">`exactextractr::exact_extract()`</span> function from the <span class="in">`exactextractr`</span> package is a faster alternative than <span class="in">`terra::extract()`</span> for a large raster data as we confirm later (<span class="in">`exactextractr::exact_extract()`</span> does not work with points data at the moment).^<span class="co">[</span><span class="ot">See [here](https://github.com/isciences/exactextract) for how it does extraction tasks differently from other major GIS software.</span><span class="co">]</span> <span class="in">`exactextractr::exact_extract()`</span> also provides a coverage fraction value for each of the cell-polygon intersections. The syntax of <span class="in">`exactextractr::exact_extract()`</span> is very much similar to <span class="in">`terra::extract()`</span>. </span>
<span id="cb91-570"><a href="#cb91-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-571"><a href="#cb91-571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = FALSE}</span></span>
<span id="cb91-572"><a href="#cb91-572" aria-hidden="true" tabindex="-1"></a><span class="in">#--- syntax (this does not run) ---#</span></span>
<span id="cb91-573"><a href="#cb91-573" aria-hidden="true" tabindex="-1"></a><span class="in">exactextractr::exact_extract(raster, polygons sf, include_cols = list of vars)</span></span>
<span id="cb91-574"><a href="#cb91-574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-575"><a href="#cb91-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-576"><a href="#cb91-576" aria-hidden="true" tabindex="-1"></a>A notable difference and advantage of <span class="in">`exactextractr::exact_extract()`</span> is that you can specify a list of variables from the polygons <span class="in">`sf`</span> to be inherited to the output. This means that we do not have to merge the output with the polygons <span class="in">`sf`</span> using the rule that the **n**th element of the output corresponds to the **n**th row of polygons <span class="in">`sf`</span> unlike the <span class="in">`terra::extract()`</span> way. <span class="in">`exactextractr::exact_extract()`</span> can accept both <span class="in">`SpatRaster`</span> and <span class="in">`Raster`</span>$^*$ objects as the raster object. However, while it accepts <span class="in">`sf`</span> as the polygons object, but it does not accept <span class="in">`SpatVect`</span>. </span>
<span id="cb91-577"><a href="#cb91-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-578"><a href="#cb91-578" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract from a single-layer `SpatRaster`</span></span>
<span id="cb91-579"><a href="#cb91-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-580"><a href="#cb91-580" aria-hidden="true" tabindex="-1"></a>Let's get <span class="in">`tmax`</span> values from the PRISM raster layer for Kansas county polygons, the following does the job: </span>
<span id="cb91-581"><a href="#cb91-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-582"><a href="#cb91-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r exact_extract}</span></span>
<span id="cb91-583"><a href="#cb91-583" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract values from the raster for each county ---#</span></span>
<span id="cb91-584"><a href="#cb91-584" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;-</span></span>
<span id="cb91-585"><a href="#cb91-585" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb91-586"><a href="#cb91-586" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr,</span></span>
<span id="cb91-587"><a href="#cb91-587" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb91-588"><a href="#cb91-588" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- inherit COUNTYFP from KS_county_sf ---#</span></span>
<span id="cb91-589"><a href="#cb91-589" aria-hidden="true" tabindex="-1"></a><span class="in">    include_cols = "COUNTYFP",</span></span>
<span id="cb91-590"><a href="#cb91-590" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- this is for not displaying progress bar ---#</span></span>
<span id="cb91-591"><a href="#cb91-591" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb91-592"><a href="#cb91-592" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-593"><a href="#cb91-593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-594"><a href="#cb91-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-595"><a href="#cb91-595" aria-hidden="true" tabindex="-1"></a>The resulting object is a list of <span class="in">`data.frame`</span>s.</span>
<span id="cb91-596"><a href="#cb91-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-597"><a href="#cb91-597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show_the_results}</span></span>
<span id="cb91-598"><a href="#cb91-598" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look at the first 6 rows of the first two list elements ---#</span></span>
<span id="cb91-599"><a href="#cb91-599" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county[1:2] %&gt;% lapply(function(x) head(x))</span></span>
<span id="cb91-600"><a href="#cb91-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-601"><a href="#cb91-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-602"><a href="#cb91-602" aria-hidden="true" tabindex="-1"></a>For each element of the list, you see <span class="in">`value`</span> and <span class="in">`coverage_fraction`</span>. <span class="in">`value`</span> is the <span class="in">`tmax`</span> value of the intersecting raster cells, and <span class="in">`coverage_fraction`</span> is the fraction of the intersecting area relative to the full raster grid, which can help find coverage-weighted summary of the extracted values (like <span class="in">`fraction`</span> variable when you use <span class="in">`terra::extract()`</span> with <span class="in">`exact = TRUE`</span>). </span>
<span id="cb91-603"><a href="#cb91-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-604"><a href="#cb91-604" aria-hidden="true" tabindex="-1"></a>We can take advantage of <span class="in">`dplyr::bind_rows()`</span> to combine the list of the datasets into a single <span class="in">`data.frame`</span>.</span>
<span id="cb91-605"><a href="#cb91-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-606"><a href="#cb91-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{r combine_after_ee, cache = F}</span></span>
<span id="cb91-607"><a href="#cb91-607" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb91-608"><a href="#cb91-608" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- combine ---#</span></span>
<span id="cb91-609"><a href="#cb91-609" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_combined &lt;- </span></span>
<span id="cb91-610"><a href="#cb91-610" aria-hidden="true" tabindex="-1"></a><span class="in">    tmax_by_county %&gt;%</span></span>
<span id="cb91-611"><a href="#cb91-611" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::bind_rows() %&gt;%</span></span>
<span id="cb91-612"><a href="#cb91-612" aria-hidden="true" tabindex="-1"></a><span class="in">    tibble::as_tibble()</span></span>
<span id="cb91-613"><a href="#cb91-613" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-614"><a href="#cb91-614" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-615"><a href="#cb91-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-616"><a href="#cb91-616" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb91-617"><a href="#cb91-617" aria-hidden="true" tabindex="-1"></a><span class="in">`data.table`</span> users can use <span class="in">`data.table::rbindlist()`</span> instead.</span>
<span id="cb91-618"><a href="#cb91-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-619"><a href="#cb91-619" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rbindlist-dt}</span></span>
<span id="cb91-620"><a href="#cb91-620" aria-hidden="true" tabindex="-1"></a><span class="in">data.table::rbindlist(tmax_by_county, idcol = "id")</span></span>
<span id="cb91-621"><a href="#cb91-621" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-622"><a href="#cb91-622" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-623"><a href="#cb91-623" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb91-624"><a href="#cb91-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-625"><a href="#cb91-625" aria-hidden="true" tabindex="-1"></a>Let's summarize the data by <span class="in">`COUNTYFP`</span> and then merge it back to the polygons <span class="in">`sf`</span> data. Here, we calculate coverage-weighted mean of tmax.</span>
<span id="cb91-626"><a href="#cb91-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-627"><a href="#cb91-627" aria-hidden="true" tabindex="-1"></a><span class="in">```{r transform_after_ee, cache = F}</span></span>
<span id="cb91-628"><a href="#cb91-628" aria-hidden="true" tabindex="-1"></a><span class="in">#--- weighted mean ---#</span></span>
<span id="cb91-629"><a href="#cb91-629" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb91-630"><a href="#cb91-630" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_by_county &lt;-</span></span>
<span id="cb91-631"><a href="#cb91-631" aria-hidden="true" tabindex="-1"></a><span class="in">    tmax_combined %&gt;%</span></span>
<span id="cb91-632"><a href="#cb91-632" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- group summary ---#</span></span>
<span id="cb91-633"><a href="#cb91-633" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::group_by(COUNTYFP) %&gt;%</span></span>
<span id="cb91-634"><a href="#cb91-634" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::summarise(tmax_aw = sum(value * coverage_fraction) / sum(coverage_fraction))</span></span>
<span id="cb91-635"><a href="#cb91-635" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-636"><a href="#cb91-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-637"><a href="#cb91-637" aria-hidden="true" tabindex="-1"></a><span class="in">#--- merge ---#</span></span>
<span id="cb91-638"><a href="#cb91-638" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::left_join(KS_county_sf, tmax_by_county, by = "COUNTYFP") %&gt;%</span></span>
<span id="cb91-639"><a href="#cb91-639" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(COUNTYFP, tmax_aw)</span></span>
<span id="cb91-640"><a href="#cb91-640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-641"><a href="#cb91-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-642"><a href="#cb91-642" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract from multi-layer `SpatRaster`</span></span>
<span id="cb91-643"><a href="#cb91-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-644"><a href="#cb91-644" aria-hidden="true" tabindex="-1"></a>Extracting values from a multi-layer <span class="in">`SpatRaster`</span> object works in exactly the same manner as a single-layer <span class="in">`SpatRaster`</span> object.</span>
<span id="cb91-645"><a href="#cb91-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-646"><a href="#cb91-646" aria-hidden="true" tabindex="-1"></a><span class="in">```{r exatrac_from_stack_run}</span></span>
<span id="cb91-647"><a href="#cb91-647" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_stack &lt;-</span></span>
<span id="cb91-648"><a href="#cb91-648" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb91-649"><a href="#cb91-649" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack,</span></span>
<span id="cb91-650"><a href="#cb91-650" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb91-651"><a href="#cb91-651" aria-hidden="true" tabindex="-1"></a><span class="in">    include_cols = "COUNTYFP",</span></span>
<span id="cb91-652"><a href="#cb91-652" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb91-653"><a href="#cb91-653" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-654"><a href="#cb91-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-655"><a href="#cb91-655" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look at the first 6 lines of the first element---#</span></span>
<span id="cb91-656"><a href="#cb91-656" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_stack[[1]] %&gt;% head()</span></span>
<span id="cb91-657"><a href="#cb91-657" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-658"><a href="#cb91-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-659"><a href="#cb91-659" aria-hidden="true" tabindex="-1"></a>As you can see above, <span class="in">`exactextractr::exact_extract()`</span> appends additional columns for additional layers.</span>
<span id="cb91-660"><a href="#cb91-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-661"><a href="#cb91-661" aria-hidden="true" tabindex="-1"></a><span class="in">```{r combine_them}</span></span>
<span id="cb91-662"><a href="#cb91-662" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine them ---#</span></span>
<span id="cb91-663"><a href="#cb91-663" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_all_combined &lt;- bind_rows(tmax_by_county_stack)</span></span>
<span id="cb91-664"><a href="#cb91-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-665"><a href="#cb91-665" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb91-666"><a href="#cb91-666" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_all_combined)</span></span>
<span id="cb91-667"><a href="#cb91-667" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-668"><a href="#cb91-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-669"><a href="#cb91-669" aria-hidden="true" tabindex="-1"></a>In order to find the coverage-weighted <span class="in">`tmax`</span> by date, you can first pivot it to a long format using <span class="in">`tidyr::pivot_longer()`</span>.</span>
<span id="cb91-670"><a href="#cb91-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-671"><a href="#cb91-671" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pivot_to_longer}</span></span>
<span id="cb91-672"><a href="#cb91-672" aria-hidden="true" tabindex="-1"></a><span class="in">#--- pivot to a longer format ---#</span></span>
<span id="cb91-673"><a href="#cb91-673" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb91-674"><a href="#cb91-674" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_long &lt;-</span></span>
<span id="cb91-675"><a href="#cb91-675" aria-hidden="true" tabindex="-1"></a><span class="in">    tidyr::pivot_longer(</span></span>
<span id="cb91-676"><a href="#cb91-676" aria-hidden="true" tabindex="-1"></a><span class="in">      tmax_all_combined,</span></span>
<span id="cb91-677"><a href="#cb91-677" aria-hidden="true" tabindex="-1"></a><span class="in">      -c(COUNTYFP, coverage_fraction),</span></span>
<span id="cb91-678"><a href="#cb91-678" aria-hidden="true" tabindex="-1"></a><span class="in">      names_to = "date",</span></span>
<span id="cb91-679"><a href="#cb91-679" aria-hidden="true" tabindex="-1"></a><span class="in">      values_to = "tmax"</span></span>
<span id="cb91-680"><a href="#cb91-680" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb91-681"><a href="#cb91-681" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-682"><a href="#cb91-682" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-683"><a href="#cb91-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-684"><a href="#cb91-684" aria-hidden="true" tabindex="-1"></a>And then find coverage-weighted <span class="in">`tmax`</span> by date:</span>
<span id="cb91-685"><a href="#cb91-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-686"><a href="#cb91-686" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dplyr_way_tmax_cov}</span></span>
<span id="cb91-687"><a href="#cb91-687" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb91-688"><a href="#cb91-688" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_long %&gt;%</span></span>
<span id="cb91-689"><a href="#cb91-689" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::group_by(COUNTYFP, date) %&gt;%</span></span>
<span id="cb91-690"><a href="#cb91-690" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::summarize(tmax = sum(tmax * coverage_fraction) / sum(coverage_fraction))</span></span>
<span id="cb91-691"><a href="#cb91-691" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-692"><a href="#cb91-692" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-693"><a href="#cb91-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-694"><a href="#cb91-694" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb91-695"><a href="#cb91-695" aria-hidden="true" tabindex="-1"></a>For <span class="in">`data.table`</span> users, this does the same:</span>
<span id="cb91-696"><a href="#cb91-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-697"><a href="#cb91-697" aria-hidden="true" tabindex="-1"></a><span class="in">```{r datatable_way_tmax_cov}</span></span>
<span id="cb91-698"><a href="#cb91-698" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb91-699"><a href="#cb91-699" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_all_combined %&gt;%</span></span>
<span id="cb91-700"><a href="#cb91-700" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table() %&gt;%</span></span>
<span id="cb91-701"><a href="#cb91-701" aria-hidden="true" tabindex="-1"></a><span class="in">    melt(id.var = c("COUNTYFP", "coverage_fraction")) %&gt;%</span></span>
<span id="cb91-702"><a href="#cb91-702" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, .(tmax = sum(value * coverage_fraction) / sum(coverage_fraction)), by = .(COUNTYFP, variable)]</span></span>
<span id="cb91-703"><a href="#cb91-703" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-704"><a href="#cb91-704" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-705"><a href="#cb91-705" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb91-706"><a href="#cb91-706" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb91-707"><a href="#cb91-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-708"><a href="#cb91-708" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract and summarize in one step</span></span>
<span id="cb91-709"><a href="#cb91-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-710"><a href="#cb91-710" aria-hidden="true" tabindex="-1"></a>Instead of returning the value from all the intersecting cells, <span class="in">`exactextractr::exact_extract()`</span> can summarize the extracted values by polygon and then return the summarized numbers. This is much like how <span class="in">`terra::extract()`</span> with <span class="in">`FUN`</span> option works. There are multiple default options you can choose from. All you need to do is to add the desired summary function name as the third argument of <span class="in">`exactextractr::exact_extract()`</span>. For example, the following will get us the mean of the extracted values weighted by <span class="in">`coverage_fraction`</span>.</span>
<span id="cb91-711"><a href="#cb91-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-712"><a href="#cb91-712" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mean-cov, results = "hide"}</span></span>
<span id="cb91-713"><a href="#cb91-713" aria-hidden="true" tabindex="-1"></a><span class="in">extacted_mean &lt;- </span></span>
<span id="cb91-714"><a href="#cb91-714" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb91-715"><a href="#cb91-715" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack, </span></span>
<span id="cb91-716"><a href="#cb91-716" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf, </span></span>
<span id="cb91-717"><a href="#cb91-717" aria-hidden="true" tabindex="-1"></a><span class="in">    "mean", </span></span>
<span id="cb91-718"><a href="#cb91-718" aria-hidden="true" tabindex="-1"></a><span class="in">    append_cols = "COUNTYFP", </span></span>
<span id="cb91-719"><a href="#cb91-719" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb91-720"><a href="#cb91-720" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-721"><a href="#cb91-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-722"><a href="#cb91-722" aria-hidden="true" tabindex="-1"></a><span class="in">head(extacted_mean)</span></span>
<span id="cb91-723"><a href="#cb91-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-724"><a href="#cb91-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-725"><a href="#cb91-725" aria-hidden="true" tabindex="-1"></a>Notice that you use <span class="in">`append_cols`</span> instead of <span class="in">`include_cols`</span> when you summarize within <span class="in">`exactextractr::exact_extract()`</span>.</span>
<span id="cb91-726"><a href="#cb91-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-727"><a href="#cb91-727" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb91-728"><a href="#cb91-728" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb91-729"><a href="#cb91-729" aria-hidden="true" tabindex="-1"></a><span class="in">mean_tmax_long &lt;- </span></span>
<span id="cb91-730"><a href="#cb91-730" aria-hidden="true" tabindex="-1"></a><span class="in">  extacted_mean %&gt;% </span></span>
<span id="cb91-731"><a href="#cb91-731" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- wide to long ---#</span></span>
<span id="cb91-732"><a href="#cb91-732" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(-COUNTYFP, names_to = "date", values_to = "tmax") %&gt;%</span></span>
<span id="cb91-733"><a href="#cb91-733" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- recover date ---#</span></span>
<span id="cb91-734"><a href="#cb91-734" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(date = gsub("mean.date", "", date) %&gt;% lubridate::ymd())</span></span>
<span id="cb91-735"><a href="#cb91-735" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-736"><a href="#cb91-736" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-737"><a href="#cb91-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-738"><a href="#cb91-738" aria-hidden="true" tabindex="-1"></a>There are other summary function options that may be of interest, such as "max", "min." You can see all the default options at <span class="co">[</span><span class="ot">the package website</span><span class="co">](https://isciences.gitlab.io/exactextractr/index.html#summary-operations)</span>.</span>
<span id="cb91-739"><a href="#cb91-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-740"><a href="#cb91-740" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extraction speed comparison {#sec-extract-speed}</span></span>
<span id="cb91-741"><a href="#cb91-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-742"><a href="#cb91-742" aria-hidden="true" tabindex="-1"></a>Here we compare the extraction speed of <span class="in">`raster::extract()`</span>, <span class="in">`terra::extract()`</span>, and <span class="in">`exactextractr::exact_extract()`</span>. A more comprehensive discussion on the speed of raster extraction can be found in <span class="co">[</span><span class="ot">@sec-EE</span><span class="co">]</span>.</span>
<span id="cb91-743"><a href="#cb91-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-744"><a href="#cb91-744" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data preparation</span></span>
<span id="cb91-745"><a href="#cb91-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-746"><a href="#cb91-746" aria-hidden="true" tabindex="-1"></a>We first create two new R objects here:</span>
<span id="cb91-747"><a href="#cb91-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-748"><a href="#cb91-748" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`SpatVectore`</span> version of <span class="in">`KS_wells`</span>, which is currently an <span class="in">`sf`</span> object.</span>
<span id="cb91-749"><a href="#cb91-749" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`SpatVectore`</span> version of <span class="in">`KS_county_sf`</span>, which is currently an <span class="in">`sf`</span> object.</span>
<span id="cb91-750"><a href="#cb91-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-751"><a href="#cb91-751" aria-hidden="true" tabindex="-1"></a><span class="in">```{r points-extraction-comp-prep}</span></span>
<span id="cb91-752"><a href="#cb91-752" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells_sv &lt;- terra::vect(KS_wells)</span></span>
<span id="cb91-753"><a href="#cb91-753" aria-hidden="true" tabindex="-1"></a><span class="in">KS_county_sv &lt;- terra::vect(KS_county_sf)</span></span>
<span id="cb91-754"><a href="#cb91-754" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-755"><a href="#cb91-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-756"><a href="#cb91-756" aria-hidden="true" tabindex="-1"></a>We also create a version of <span class="in">`prism_tmax_0701_KS_sr`</span> that is disaggregated by a factor of 10 to create a much larger raster data.</span>
<span id="cb91-757"><a href="#cb91-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-758"><a href="#cb91-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prism_disaggregate}</span></span>
<span id="cb91-759"><a href="#cb91-759" aria-hidden="true" tabindex="-1"></a><span class="in">#--- disaggregate ---#</span></span>
<span id="cb91-760"><a href="#cb91-760" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb91-761"><a href="#cb91-761" aria-hidden="true" tabindex="-1"></a><span class="in">  prism_tmax_0701_KS_sr_10 &lt;- terra::disagg(prism_tmax_0701_KS_sr, fact = 10)</span></span>
<span id="cb91-762"><a href="#cb91-762" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb91-763"><a href="#cb91-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-764"><a href="#cb91-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-765"><a href="#cb91-765" aria-hidden="true" tabindex="-1"></a>The disaggregated PRISM data now has 10 times more rows and columns.</span>
<span id="cb91-766"><a href="#cb91-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-767"><a href="#cb91-767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dimensions}</span></span>
<span id="cb91-768"><a href="#cb91-768" aria-hidden="true" tabindex="-1"></a><span class="in">#--- original ---#</span></span>
<span id="cb91-769"><a href="#cb91-769" aria-hidden="true" tabindex="-1"></a><span class="in">dim(prism_tmax_0701_KS_sr)</span></span>
<span id="cb91-770"><a href="#cb91-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-771"><a href="#cb91-771" aria-hidden="true" tabindex="-1"></a><span class="in">#--- disaggregated ---#</span></span>
<span id="cb91-772"><a href="#cb91-772" aria-hidden="true" tabindex="-1"></a><span class="in">dim(prism_tmax_0701_KS_sr_10)</span></span>
<span id="cb91-773"><a href="#cb91-773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-774"><a href="#cb91-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-775"><a href="#cb91-775" aria-hidden="true" tabindex="-1"></a><span class="fu">### Points: `terra::extract()`</span></span>
<span id="cb91-776"><a href="#cb91-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-777"><a href="#cb91-777" aria-hidden="true" tabindex="-1"></a>Extraction speed of <span class="in">`terra::extract()`</span> depends on the class of the raster and vector (points) objects^<span class="co">[</span><span class="ot">Until recently, `raster::extract()` was much much slower compared to `terra::extract()`. However, recent updates to the package made significant improvement in extraction speed and `raster::extract()` is comparable to `terra::extract()` in speed.</span><span class="co">]</span>. Whether the points data is <span class="in">`sf`</span> or <span class="in">`SpatVector`</span> makes a difference as you can see below with <span class="in">`SpatVector`</span> being faster.</span>
<span id="cb91-778"><a href="#cb91-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-779"><a href="#cb91-779" aria-hidden="true" tabindex="-1"></a><span class="in">```{r points-extraction-terra-sr-sf}</span></span>
<span id="cb91-780"><a href="#cb91-780" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: true</span></span>
<span id="cb91-781"><a href="#cb91-781" aria-hidden="true" tabindex="-1"></a><span class="in">#--- SpatRaster and sf ---#</span></span>
<span id="cb91-782"><a href="#cb91-782" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-783"><a href="#cb91-783" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_wells)</span></span>
<span id="cb91-784"><a href="#cb91-784" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-785"><a href="#cb91-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-786"><a href="#cb91-786" aria-hidden="true" tabindex="-1"></a><span class="in">#--- SpatRaster and SpatVector ---#</span></span>
<span id="cb91-787"><a href="#cb91-787" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-788"><a href="#cb91-788" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_wells_sv)</span></span>
<span id="cb91-789"><a href="#cb91-789" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-790"><a href="#cb91-790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-791"><a href="#cb91-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-792"><a href="#cb91-792" aria-hidden="true" tabindex="-1"></a>Although the time difference may seem small, it can accumulate significantly when extracting data from numerous raster layers to the same set of points, resulting in a notable increase in overall processing time. In such cases, it is recommended to first convert the points from <span class="in">`sf`</span> to <span class="in">`SpatVector`</span> before performing the extractions.</span>
<span id="cb91-793"><a href="#cb91-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-794"><a href="#cb91-794" aria-hidden="true" tabindex="-1"></a><span class="fu">### Polygons: `exactextractr::exact_extract()` and `terra::extract()`</span></span>
<span id="cb91-795"><a href="#cb91-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-796"><a href="#cb91-796" aria-hidden="true" tabindex="-1"></a><span class="in">`terra::extract()`</span> is faster than <span class="in">`exactextractr::exact_extract()`</span> for a relatively small raster data. Let's use <span class="in">`prism_tmax_0701_KS_sr`</span> and time them to see the difference.</span>
<span id="cb91-797"><a href="#cb91-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-798"><a href="#cb91-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-799"><a href="#cb91-799" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-from-polygons-comp, cahce = F}</span></span>
<span id="cb91-800"><a href="#cb91-800" aria-hidden="true" tabindex="-1"></a><span class="in">#--- terra::extract ---#</span></span>
<span id="cb91-801"><a href="#cb91-801" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-802"><a href="#cb91-802" aria-hidden="true" tabindex="-1"></a><span class="in">terra_extract_temp &lt;-</span></span>
<span id="cb91-803"><a href="#cb91-803" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb91-804"><a href="#cb91-804" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr,</span></span>
<span id="cb91-805"><a href="#cb91-805" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sv</span></span>
<span id="cb91-806"><a href="#cb91-806" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-807"><a href="#cb91-807" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-808"><a href="#cb91-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-809"><a href="#cb91-809" aria-hidden="true" tabindex="-1"></a><span class="in">#--- exact_extract ---#</span></span>
<span id="cb91-810"><a href="#cb91-810" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-811"><a href="#cb91-811" aria-hidden="true" tabindex="-1"></a><span class="in">exact_extract_temp &lt;-</span></span>
<span id="cb91-812"><a href="#cb91-812" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb91-813"><a href="#cb91-813" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr,</span></span>
<span id="cb91-814"><a href="#cb91-814" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb91-815"><a href="#cb91-815" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb91-816"><a href="#cb91-816" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-817"><a href="#cb91-817" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-818"><a href="#cb91-818" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-819"><a href="#cb91-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-820"><a href="#cb91-820" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`terra::extract()`</span> is faster than <span class="in">`exactextractr::exact_extract()`</span>. However, once the raster data becomes larger (or spatially finer), then <span class="in">`exact_extact()`</span> starts to shine. </span>
<span id="cb91-821"><a href="#cb91-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-822"><a href="#cb91-822" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-823"><a href="#cb91-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-824"><a href="#cb91-824" aria-hidden="true" tabindex="-1"></a>Now, let's compare <span class="in">`terra::extrct()`</span> and <span class="in">`exact_extrct()`</span> using the disaggregated data.</span>
<span id="cb91-825"><a href="#cb91-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-826"><a href="#cb91-826" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract_from_polygons_comp_2}</span></span>
<span id="cb91-827"><a href="#cb91-827" aria-hidden="true" tabindex="-1"></a><span class="in">#--- terra extract ---#</span></span>
<span id="cb91-828"><a href="#cb91-828" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-829"><a href="#cb91-829" aria-hidden="true" tabindex="-1"></a><span class="in">terra_extract_temp &lt;-</span></span>
<span id="cb91-830"><a href="#cb91-830" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb91-831"><a href="#cb91-831" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-832"><a href="#cb91-832" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sv</span></span>
<span id="cb91-833"><a href="#cb91-833" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-834"><a href="#cb91-834" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-835"><a href="#cb91-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-836"><a href="#cb91-836" aria-hidden="true" tabindex="-1"></a><span class="in">#--- exact extract ---#</span></span>
<span id="cb91-837"><a href="#cb91-837" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-838"><a href="#cb91-838" aria-hidden="true" tabindex="-1"></a><span class="in">exact_extract_temp &lt;-</span></span>
<span id="cb91-839"><a href="#cb91-839" aria-hidden="true" tabindex="-1"></a><span class="in">  exact_extract(</span></span>
<span id="cb91-840"><a href="#cb91-840" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-841"><a href="#cb91-841" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb91-842"><a href="#cb91-842" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb91-843"><a href="#cb91-843" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-844"><a href="#cb91-844" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-845"><a href="#cb91-845" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-846"><a href="#cb91-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-847"><a href="#cb91-847" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`exactextractr::exact_extract()`</span> is considerably faster. The difference in time becomes even more pronounced as the size of the raster data becomes larger and the number of polygons are greater. The time difference of several seconds seem nothing, but imagine processing Cropland Data Layer (CDL) files for the entire US over 10 years, then you would appreciate the speed of <span class="in">`exactextractr::exact_extract()`</span>. See @sec-EE for more comprehensive treatment of raster value extraction speed.</span>
<span id="cb91-848"><a href="#cb91-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-849"><a href="#cb91-849" aria-hidden="true" tabindex="-1"></a><span class="fu">### Single-layer vs multi-layer</span></span>
<span id="cb91-850"><a href="#cb91-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-851"><a href="#cb91-851" aria-hidden="true" tabindex="-1"></a>Pretend that you have five dates of PRISM tmax data (here we repeat the same file five times) and would like to extract values from all of them. Extracting values from a multi-layer raster objects (<span class="in">`RasterStack`</span> for <span class="in">`raster`</span> package) takes less time than extracting values from the individual layers one at a time. This can be observed below.</span>
<span id="cb91-852"><a href="#cb91-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-853"><a href="#cb91-853" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-854"><a href="#cb91-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-855"><a href="#cb91-855" aria-hidden="true" tabindex="-1"></a>**`terra::extract()`**</span>
<span id="cb91-856"><a href="#cb91-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-857"><a href="#cb91-857" aria-hidden="true" tabindex="-1"></a><span class="in">```{r write_raster_prism_10, echo = F}</span></span>
<span id="cb91-858"><a href="#cb91-858" aria-hidden="true" tabindex="-1"></a><span class="in"># terra::writeRaster(prism_tmax_0701_KS_sr_10, "Data/prism_tmax_0701_KS_sr_10.tif", overwrite = TRUE)</span></span>
<span id="cb91-859"><a href="#cb91-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-860"><a href="#cb91-860" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_0701_KS_sr_10 &lt;- rast("Data/prism_tmax_0701_KS_sr_10.tif")</span></span>
<span id="cb91-861"><a href="#cb91-861" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-862"><a href="#cb91-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-863"><a href="#cb91-863" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare_speed_te}</span></span>
<span id="cb91-864"><a href="#cb91-864" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: true</span></span>
<span id="cb91-865"><a href="#cb91-865" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from 5 layers one at a time ---#</span></span>
<span id="cb91-866"><a href="#cb91-866" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-867"><a href="#cb91-867" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb91-868"><a href="#cb91-868" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb91-869"><a href="#cb91-869" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb91-870"><a href="#cb91-870" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb91-871"><a href="#cb91-871" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb91-872"><a href="#cb91-872" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-873"><a href="#cb91-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-874"><a href="#cb91-874" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from a 5-layer SpatRaster ---#</span></span>
<span id="cb91-875"><a href="#cb91-875" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-876"><a href="#cb91-876" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_ml_5 &lt;-</span></span>
<span id="cb91-877"><a href="#cb91-877" aria-hidden="true" tabindex="-1"></a><span class="in">  c(</span></span>
<span id="cb91-878"><a href="#cb91-878" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-879"><a href="#cb91-879" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-880"><a href="#cb91-880" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-881"><a href="#cb91-881" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-882"><a href="#cb91-882" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10</span></span>
<span id="cb91-883"><a href="#cb91-883" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-884"><a href="#cb91-884" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_ml_5, KS_county_sv)</span></span>
<span id="cb91-885"><a href="#cb91-885" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-886"><a href="#cb91-886" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-887"><a href="#cb91-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-888"><a href="#cb91-888" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb91-889"><a href="#cb91-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-890"><a href="#cb91-890" aria-hidden="true" tabindex="-1"></a>**`exactextractr::exact_extract()`**</span>
<span id="cb91-891"><a href="#cb91-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-892"><a href="#cb91-892" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare_speed_ee}</span></span>
<span id="cb91-893"><a href="#cb91-893" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: true</span></span>
<span id="cb91-894"><a href="#cb91-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-895"><a href="#cb91-895" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from 5 layers one at a time ---#</span></span>
<span id="cb91-896"><a href="#cb91-896" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-897"><a href="#cb91-897" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb91-898"><a href="#cb91-898" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb91-899"><a href="#cb91-899" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb91-900"><a href="#cb91-900" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb91-901"><a href="#cb91-901" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb91-902"><a href="#cb91-902" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-903"><a href="#cb91-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-904"><a href="#cb91-904" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from from a 5-layer SpatRaster ---#</span></span>
<span id="cb91-905"><a href="#cb91-905" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb91-906"><a href="#cb91-906" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_stack_5 &lt;-</span></span>
<span id="cb91-907"><a href="#cb91-907" aria-hidden="true" tabindex="-1"></a><span class="in">  c(</span></span>
<span id="cb91-908"><a href="#cb91-908" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-909"><a href="#cb91-909" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-910"><a href="#cb91-910" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-911"><a href="#cb91-911" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb91-912"><a href="#cb91-912" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10</span></span>
<span id="cb91-913"><a href="#cb91-913" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-914"><a href="#cb91-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-915"><a href="#cb91-915" aria-hidden="true" tabindex="-1"></a><span class="in">#--- set layer names ---#</span></span>
<span id="cb91-916"><a href="#cb91-916" aria-hidden="true" tabindex="-1"></a><span class="in"># exact_extract() does not like multi-layer raster with the same layer name</span></span>
<span id="cb91-917"><a href="#cb91-917" aria-hidden="true" tabindex="-1"></a><span class="in">set.names(prism_tmax_stack_5, paste0("layer_", 1:5))</span></span>
<span id="cb91-918"><a href="#cb91-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-919"><a href="#cb91-919" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;-</span></span>
<span id="cb91-920"><a href="#cb91-920" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb91-921"><a href="#cb91-921" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack_5,</span></span>
<span id="cb91-922"><a href="#cb91-922" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb91-923"><a href="#cb91-923" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb91-924"><a href="#cb91-924" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb91-925"><a href="#cb91-925" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb91-926"><a href="#cb91-926" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-927"><a href="#cb91-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-928"><a href="#cb91-928" aria-hidden="true" tabindex="-1"></a>The reduction in computation time for both methods makes sense. Since both layers have exactly the same geographic extent and resolution, finding the polygons-cells correspondence is done once and then it can be used repeatedly across the layers for the multi-layer <span class="in">`SparRaster`</span> and <span class="in">`RasterStack`</span>. This clearly suggests that when you are processing many layers of the same spatial resolution and extent, you should first stack them and then extract values at the same time instead of processing them one by one as long as your memory allows you to do so. </span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/05-SpatialInteractionVectorRaster.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>
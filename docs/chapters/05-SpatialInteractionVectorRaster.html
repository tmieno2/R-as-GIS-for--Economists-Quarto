<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>5&nbsp; Spatial Interactions of Vector and Raster Data – R as GIS for Economists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/04-RasterDataBasics.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Google tag (gtag.js) --><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/editor/editor.main.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style type="text/css">
.monaco-editor pre {
  background-color: unset !important;
}

.qwebr-editor-toolbar {
  width: 100%;
  display: flex;
  justify-content: space-between;
  box-sizing: border-box;
}

.qwebr-editor-toolbar-left-buttons, .qwebr-editor-toolbar-right-buttons {
  display: flex;
}

.qwebr-non-interactive-loading-container.qwebr-cell-needs-evaluation, .qwebr-non-interactive-loading-container.qwebr-cell-evaluated {
  justify-content: center;
  display: flex;
  background-color: rgba(250, 250, 250, 0.65);
  border: 1px solid rgba(233, 236, 239, 0.65);
  border-radius: 0.5rem;
  margin-top: 15px;
  margin-bottom: 15px;
}

.qwebr-r-project-logo {
  color: #2767B0; /* R Project's blue color */
}

.qwebr-icon-status-spinner {
  color: #7894c4;
}

.qwebr-icon-run-code {
  color: #0d9c29
}

body.quarto-light .qwebr-output-code-stdout {
  color: #111;
}

body.quarto-dark .qwebr-output-code-stdout {
  color: #EEE;
}

.qwebr-output-code-stderr {
  color: #db4133;
}

body.quarto-light .qwebr-editor {
  border: 1px solid #EEEEEE;
}

body.quarto-light .qwebr-editor-toolbar {
  background-color: #EEEEEE;
  padding: 0.2rem 0.5rem;
}

body.quarto-dark .qwebr-editor {
  border: 1px solid #111;
}

body.quarto-dark .qwebr-editor-toolbar {
  background-color: #111;
  padding: 0.2rem 0.5rem;
}

.qwebr-button {
  display: inline-block;
  font-weight: 400;
  line-height: 1;
  text-decoration: none;
  text-align: center;
  padding: 0.375rem 0.75rem;
  font-size: .9rem;
  border-radius: 0.25rem;
  transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
}

body.quarto-light .qwebr-button {
  background-color: #EEEEEE;
  color: #000;
  border-color: #dee2e6;
  border: 1px solid rgba(0,0,0,0);
}

body.quarto-dark .qwebr-button {
  background-color: #111;
  color: #EEE;
  border-color: #dee2e6;
  border: 1px solid rgba(0,0,0,0);
}

body.quarto-light .qwebr-button:hover {
  color: #000;
  background-color: #d9dce0;
  border-color: #c8ccd0;
}

body.quarto-dark .qwebr-button:hover {
  color: #d9dce0;
  background-color: #323232;
  border-color: #d9dce0;
}

.qwebr-button:disabled,.qwebr-button.disabled,fieldset:disabled .qwebr-button {
  pointer-events: none;
  opacity: .65
}

.qwebr-button-reset {
  color: #696969; /*#4682b4;*/
}

.qwebr-button-copy {
  color: #696969;
}

/* Style the code highlight lines */
body.quarto-light .qwebr-editor-highlight-line {
  background-color: lightblue;
}

body.quarto-dark .qwebr-editor-highlight-line {
  background-color: darkblue;
}

/* Style the modal pop-up */

/* The Modal (background) */
.qwebr-modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  padding-top: 60px;
}

/* Modal Content */
.qwebr-modal-content {
  background-color: #fefefe;
  margin: 5% auto; /* 15% from the top and centered */
  padding: 20px;
  border: 1px solid #888;
  width: 80%; /* Could be more or less, depending on screen size */
}

.qwebr-modal-content-code {
  max-height: 50vh;
  min-height: 5vh;
  overflow: scroll;
  border: 1px solid #888;
}

/* The Close Button */
.qwebr-modal-close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.qwebr-modal-close:hover,
.qwebr-modal-close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

.qwebr-download-btn {
  margin-top: 10px;
  text-decoration: none !important;
}

/* Styling to download image that is created */

.qwebr-canvas-image {
  position: relative;
  display: inline-block;
  margin: 10px;
}

.qwebr-canvas-image-download-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 5px 10px;
  background-color: #007BFF;
  color: white;
  border: none;
  cursor: pointer;
  display: none;
}

figure:hover .qwebr-canvas-image-download-btn {
  display: block;
}

/* Custom styling for RevealJS Presentations*/

/* Reset the style of the interactive area */
.reveal div.qwebr-interactive-area {
  display: block;
  box-shadow: none;
  max-width: 100%;
  max-height: 100%;
  margin: 0;
  padding: 0;
} 

/* Provide space to entries */
.reveal div.qwebr-output-code-area pre div {
  margin: 1px 2px 1px 10px;
}

/* Collapse the inside code tags to avoid extra space between line outputs */
.reveal pre div code.qwebr-output-code-stdout, .reveal pre div code.qwebr-output-code-stderr {
  padding: 0;
  display: contents;
}

body.reveal.quarto-light pre div code.qwebr-output-code-stdout {
  color: #111;
}

body.reveal.quarto-dark pre div code.qwebr-output-code-stdout {
  color: #EEEEEE;
}

.reveal pre div code.qwebr-output-code-stderr {
  color: #db4133;
}


/* Create a border around console and output (does not effect graphs) */
body.reveal.quarto-light div.qwebr-console-area {
  border: 1px solid #EEEEEE;
  box-shadow: 2px 2px 10px #EEEEEE;
}

body.reveal.quarto-dark div.qwebr-console-area {
  border: 1px solid #111;
  box-shadow: 2px 2px 10px #111;
}


/* Cap output height and allow text to scroll */
/* TODO: Is there a better way to fit contents/max it parallel to the monaco editor size? */
.reveal div.qwebr-output-code-area pre {
  max-height: 400px;
  overflow: scroll;
}

</style>
<script type="module">
// Document level settings ----

// Determine if we need to install R packages
globalThis.qwebrInstallRPackagesList = [''];

// Specify possible locations to search for the repository
globalThis.qwebrPackageRepoURLS = ['https://repo.r-wasm.org/'];

// Check to see if we have an empty array, if we do set to skip the installation.
globalThis.qwebrSetupRPackages = !(qwebrInstallRPackagesList.indexOf("") !== -1);
globalThis.qwebrAutoloadRPackages = true;

// Display a startup message?
globalThis.qwebrShowStartupMessage = true;
globalThis.qwebrShowHeaderMessage = false;

// Describe the webR settings that should be used
globalThis.qwebrCustomizedWebROptions = {
  "baseURL": "https://webr.r-wasm.org/v0.4.0/",
  "serviceWorkerUrl": "",
  "homedir": "/home/web_user", 
  "channelType": "ChannelType.Automatic"
};

// Store cell data
globalThis.qwebrCellDetails = [{"code":"library(dplyr)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(stars)\nlibrary(terra)\ninstall.packages(\n  \"r.spatial.workshop.datasets\", \n  repos = c(\"https://tmieno2.r-universe.dev\")\n)\nlibrary(r.spatial.workshop.datasets)","id":1,"options":{"editor-word-wrap":"true","editor-quick-suggestions":"false","results":"markup","editor-font-scale":"0.8","out-height":"","context":"interactive","dpi":72,"fig-height":5,"message":"false","classes":"","read-only":"false","fig-width":7,"label":"unnamed-chunk-1","comment":"","editor-max-height":"","output":"true","warning":"false","autorun":"false","fig-cap":"","out-width":"70%"}},{"code":"data(corn_yield)\ndata(NDRE)\nNDRE <- terra::rast(NDRE)","id":2,"options":{"editor-word-wrap":"true","editor-quick-suggestions":"false","results":"markup","editor-font-scale":"0.8","out-height":"","context":"interactive","dpi":72,"fig-height":5,"message":"true","classes":"","read-only":"false","fig-width":7,"label":"unnamed-chunk-2","comment":"","editor-max-height":"","output":"true","warning":"true","autorun":"false","fig-cap":"","out-width":"70%"}},{"code":"#--- work here ---#\n\n\n\n","id":3,"options":{"editor-word-wrap":"true","editor-quick-suggestions":"false","results":"markup","editor-font-scale":"0.8","out-height":"","context":"interactive","dpi":72,"fig-height":5,"message":"true","classes":"","read-only":"false","fig-width":7,"label":"unnamed-chunk-3","comment":"","editor-max-height":"","output":"true","warning":"true","autorun":"false","fig-cap":"","out-width":"70%"}},{"code":"data(ne_counties)\ndata(prism_us)\nprism_us <- terra::rast(prism_us)","id":4,"options":{"editor-word-wrap":"true","editor-quick-suggestions":"false","results":"markup","editor-font-scale":"0.8","out-height":"","context":"interactive","dpi":72,"fig-height":5,"message":"true","classes":"","read-only":"false","fig-width":7,"label":"unnamed-chunk-4","comment":"","editor-max-height":"","output":"true","warning":"true","autorun":"false","fig-cap":"","out-width":"70%"}},{"code":"#--- work here ---#\n\n\n\n\n","id":5,"options":{"editor-word-wrap":"true","editor-quick-suggestions":"false","results":"markup","editor-font-scale":"0.8","out-height":"","context":"interactive","dpi":72,"fig-height":5,"message":"true","classes":"","read-only":"false","fig-width":7,"label":"unnamed-chunk-5","comment":"","editor-max-height":"","output":"true","warning":"true","autorun":"false","fig-cap":"","out-width":"70%"}}];

</script><script type="module">
// Declare startupMessageQWebR globally
globalThis.qwebrStartupMessage = document.createElement("p");

// Verify if OffScreenCanvas is supported
globalThis.qwebrOffScreenCanvasSupport = function() {
  return typeof OffscreenCanvas !== 'undefined'
}

// Function to set the button text
globalThis.qwebrSetInteractiveButtonState = function(buttonText, enableCodeButton = true) {
  document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
    btn.innerHTML = buttonText;
    btn.disabled = !enableCodeButton;
  });
}

// Function to update the status message in non-interactive cells
globalThis.qwebrUpdateStatusMessage = function(message) {
  document.querySelectorAll(".qwebr-status-text.qwebr-cell-needs-evaluation").forEach((elem) => {
    elem.innerText = message;
  });
}

// Function to update the status message
globalThis.qwebrUpdateStatusHeader = function(message) {
  qwebrStartupMessage.innerHTML = `
    <i class="fa-solid fa-spinner fa-spin qwebr-icon-status-spinner"></i>
    <span>${message}</span>`;
}

// Function to return true if element is found, false if not
globalThis.qwebrCheckHTMLElementExists = function(selector) {
  const element = document.querySelector(selector);
  return !!element;
}

// Function that detects whether reveal.js slides are present
globalThis.qwebrIsRevealJS = function() {
  // If the '.reveal .slides' selector exists, RevealJS is likely present
  return qwebrCheckHTMLElementExists('.reveal .slides');
}

// Initialize the Quarto sidebar element
function qwebrSetupQuartoSidebar() {
  var newSideBarDiv = document.createElement('div');
  newSideBarDiv.id = 'quarto-margin-sidebar';
  newSideBarDiv.className = 'sidebar margin-sidebar';
  newSideBarDiv.style.top = '0px';
  newSideBarDiv.style.maxHeight = 'calc(0px + 100vh)';

  return newSideBarDiv;
}

// Position the sidebar in the document
function qwebrPlaceQuartoSidebar() {
  // Get the reference to the element with id 'quarto-document-content'
  var referenceNode = document.getElementById('quarto-document-content');

  // Create the new div element
  var newSideBarDiv = qwebrSetupQuartoSidebar();

  // Insert the new div before the 'quarto-document-content' element
  referenceNode.parentNode.insertBefore(newSideBarDiv, referenceNode);
}

function qwebrPlaceMessageContents(content, html_location = "title-block-header", revealjs_location = "title-slide") {

  // Get references to header elements
  const headerHTML = document.getElementById(html_location);
  const headerRevealJS = document.getElementById(revealjs_location);

  // Determine where to insert the quartoTitleMeta element
  if (headerHTML || headerRevealJS) {
    // Append to the existing "title-block-header" element or "title-slide" div
    (headerHTML || headerRevealJS).appendChild(content);
  } else {
    // If neither headerHTML nor headerRevealJS is found, insert after "webr-monaco-editor-init" script
    const monacoScript = document.getElementById("qwebr-monaco-editor-init");
    const header = document.createElement("header");
    header.setAttribute("id", "title-block-header");
    header.appendChild(content);
    monacoScript.after(header);
  }
}



function qwebrOffScreenCanvasSupportWarningMessage() {
  
  // Verify canvas is supported.
  if(qwebrOffScreenCanvasSupport()) return;

  // Create the main container div
  var calloutContainer = document.createElement('div');
  calloutContainer.classList.add('callout', 'callout-style-default', 'callout-warning', 'callout-titled');

  // Create the header div
  var headerDiv = document.createElement('div');
  headerDiv.classList.add('callout-header', 'd-flex', 'align-content-center');

  // Create the icon container div
  var iconContainer = document.createElement('div');
  iconContainer.classList.add('callout-icon-container');

  // Create the icon element
  var iconElement = document.createElement('i');
  iconElement.classList.add('callout-icon');

  // Append the icon element to the icon container
  iconContainer.appendChild(iconElement);

  // Create the title container div
  var titleContainer = document.createElement('div');
  titleContainer.classList.add('callout-title-container', 'flex-fill');
  titleContainer.innerText = 'Warning: Web Browser Does Not Support Graphing!';

  // Append the icon container and title container to the header div
  headerDiv.appendChild(iconContainer);
  headerDiv.appendChild(titleContainer);

  // Create the body container div
  var bodyContainer = document.createElement('div');
  bodyContainer.classList.add('callout-body-container', 'callout-body');

  // Create the paragraph element for the body content
  var paragraphElement = document.createElement('p');
  paragraphElement.innerHTML = 'This web browser does not have support for displaying graphs through the <code>quarto-webr</code> extension since it lacks an <code>OffScreenCanvas</code>. Please upgrade your web browser to one that supports <code>OffScreenCanvas</code>.';

  // Append the paragraph element to the body container
  bodyContainer.appendChild(paragraphElement);

  // Append the header div and body container to the main container div
  calloutContainer.appendChild(headerDiv);
  calloutContainer.appendChild(bodyContainer);

  // Append the main container div to the document depending on format
  qwebrPlaceMessageContents(calloutContainer, "title-block-header"); 

}


// Function that attaches the document status message and diagnostics
function displayStartupMessage(showStartupMessage, showHeaderMessage) {
  if (!showStartupMessage) {
    return;
  }

  // Create the outermost div element for metadata
  const quartoTitleMeta = document.createElement("div");
  quartoTitleMeta.classList.add("quarto-title-meta");

  // Create the first inner div element
  const firstInnerDiv = document.createElement("div");
  firstInnerDiv.setAttribute("id", "qwebr-status-message-area");

  // Create the second inner div element for "WebR Status" heading and contents
  const secondInnerDiv = document.createElement("div");
  secondInnerDiv.setAttribute("id", "qwebr-status-message-title");
  secondInnerDiv.classList.add("quarto-title-meta-heading");
  secondInnerDiv.innerText = "WebR Status";

  // Create another inner div for contents
  const secondInnerDivContents = document.createElement("div");
  secondInnerDivContents.setAttribute("id", "qwebr-status-message-body");
  secondInnerDivContents.classList.add("quarto-title-meta-contents");

  // Describe the WebR state
  qwebrStartupMessage.innerText = "🟡 Loading...";
  qwebrStartupMessage.setAttribute("id", "qwebr-status-message-text");
  // Add `aria-live` to auto-announce the startup status to screen readers
  qwebrStartupMessage.setAttribute("aria-live", "assertive");

  // Append the startup message to the contents
  secondInnerDivContents.appendChild(qwebrStartupMessage);

  // Add a status indicator for COOP and COEP Headers if needed
  if (showHeaderMessage) {
    const crossOriginMessage = document.createElement("p");
    crossOriginMessage.innerText = `${crossOriginIsolated ? '🟢' : '🟡'} COOP & COEP Headers`;
    crossOriginMessage.setAttribute("id", "qwebr-coop-coep-header");
    secondInnerDivContents.appendChild(crossOriginMessage);
  }

  // Combine the inner divs and contents
  firstInnerDiv.appendChild(secondInnerDiv);
  firstInnerDiv.appendChild(secondInnerDivContents);
  quartoTitleMeta.appendChild(firstInnerDiv);

  // Place message on webpage
  qwebrPlaceMessageContents(quartoTitleMeta); 
}

function qwebrAddCommandHistoryModal() {
  // Create the modal div
  var modalDiv = document.createElement('div');
  modalDiv.id = 'qwebr-history-modal';
  modalDiv.className = 'qwebr-modal';

  // Create the modal content div
  var modalContentDiv = document.createElement('div');
  modalContentDiv.className = 'qwebr-modal-content';

  // Create the span for closing the modal
  var closeSpan = document.createElement('span');
  closeSpan.id = 'qwebr-command-history-close-btn';
  closeSpan.className = 'qwebr-modal-close';
  closeSpan.innerHTML = '&times;';

  // Create the h1 element for the modal
  var modalH1 = document.createElement('h1');
  modalH1.textContent = 'R History Command Contents';

  // Create an anchor element for downloading the Rhistory file 
  var downloadLink = document.createElement('a');
  downloadLink.href = '#';
  downloadLink.id = 'qwebr-download-history-btn';
  downloadLink.className = 'qwebr-download-btn';

  // Create an 'i' element for the icon
  var icon = document.createElement('i');
  icon.className = 'bi bi-file-code';

  // Append the icon to the anchor element
  downloadLink.appendChild(icon);

  // Add the text 'Download R History' to the anchor element
  downloadLink.appendChild(document.createTextNode(' Download R History File'));

  // Create the pre for command history contents
  var commandContentsPre = document.createElement('pre');
  commandContentsPre.id = 'qwebr-command-history-contents';
  commandContentsPre.className = 'qwebr-modal-content-code';

  // Append the close span, h1, and history contents pre to the modal content div
  modalContentDiv.appendChild(closeSpan);
  modalContentDiv.appendChild(modalH1);
  modalContentDiv.appendChild(downloadLink);
  modalContentDiv.appendChild(commandContentsPre);

  // Append the modal content div to the modal div
  modalDiv.appendChild(modalContentDiv);

  // Append the modal div to the body
  document.body.appendChild(modalDiv);
}

function qwebrRegisterRevealJSCommandHistoryModal() {
  // Select the <ul> element inside the <div> with data-panel="Custom0"
  let ulElement = document.querySelector('div[data-panel="Custom0"] > ul.slide-menu-items');

  // Find the last <li> element with class slide-tool-item
  let lastItem = ulElement.querySelector('li.slide-tool-item:last-child');

  // Calculate the next data-item value
  let nextItemValue = 0;
  if (lastItem) {
      nextItemValue = parseInt(lastItem.dataset.item) + 1;
  }

  // Create a new <li> element
  let newListItem = document.createElement('li');
  newListItem.className = 'slide-tool-item';
  newListItem.dataset.item = nextItemValue.toString(); // Set the next available data-item value

  // Create the <a> element inside the <li>
  let newLink = document.createElement('a');
  newLink.href = '#';
  newLink.id = 'qwebrRHistoryButton'; // Set the ID for the new link
  
  // Create the <kbd> element inside the <a>
  let newKbd = document.createElement('kbd');
  newKbd.textContent = ' '; // Set to empty as we are not registering a keyboard shortcut

  // Create text node for the link text
  let newText = document.createTextNode(' View R History');

  // Append <kbd> and text node to <a>
  newLink.appendChild(newKbd);
  newLink.appendChild(newText);

  // Append <a> to <li>
  newListItem.appendChild(newLink);

  // Append <li> to <ul>
  ulElement.appendChild(newListItem);
}

// Handle setting up the R history modal
function qwebrCodeLinks() {

  if (qwebrIsRevealJS()) {
    qwebrRegisterRevealJSCommandHistoryModal();
    return;
  }

  // Create the container div
  var containerDiv = document.createElement('div');
  containerDiv.className = 'quarto-code-links';

  // Create the h2 element
  var h2 = document.createElement('h2');
  h2.textContent = 'webR Code Links';

  // Create the ul element
  var ul = document.createElement('ul');

  // Create the li element
  var li = document.createElement('li');

  // Create the a_history_btn element
  var a_history_btn = document.createElement('a');
  a_history_btn.href = 'javascript:void(0)';
  a_history_btn.setAttribute('id', 'qwebrRHistoryButton');

  // Create the i_history_btn element
  var i_history_btn = document.createElement('i');
  i_history_btn.className = 'bi bi-file-code';

  // Create the text node for the link text
  var text_history_btn = document.createTextNode('View R History');

  // Append the icon element and link text to the a element
  a_history_btn.appendChild(i_history_btn);
  a_history_btn.appendChild(text_history_btn);

  // Append the a element to the li element
  li.appendChild(a_history_btn);

  // Append the li element to the ul element
  ul.appendChild(li);

  // Append the h2 and ul elements to the container div
  containerDiv.appendChild(h2);
  containerDiv.appendChild(ul);

  // Append the container div to the element with the ID 'quarto-margin-sidebar'
  var sidebar = document.getElementById('quarto-margin-sidebar');
    
  // If the sidebar element is not found, create it
  if(!sidebar) {
    qwebrPlaceQuartoSidebar();
  }
  
  // Re-select the sidebar element (if it was just created)
  sidebar = document.getElementById('quarto-margin-sidebar');   


  // If the sidebar element exists, append the container div to it
  if(sidebar) {
    // Append the container div to the sidebar
    sidebar.appendChild(containerDiv);
    // Force the sidebar to be clickable by removing the 'zindex-bottom' class
    // added in pre-release: https://github.com/quarto-dev/quarto-cli/commit/f0c53a1ffcaa1de4eccbf07803b096898248adcc
    sidebar.className = 'sidebar margin-sidebar';
  } else {
    // Get a debugger ...
    console.warn('Element with ID "quarto-margin-sidebar" not found.');
  }
}

// Call the function to append the code links for qwebR into the right sidebar
qwebrCodeLinks();

// Add the command history modal
qwebrAddCommandHistoryModal();

displayStartupMessage(qwebrShowStartupMessage, qwebrShowHeaderMessage);
qwebrOffScreenCanvasSupportWarningMessage();
</script><script type="module">
// Define a global storage and retrieval solution ----

// Store commands executed in R
globalThis.qwebrRCommandHistory = [];

// Function to retrieve the command history
globalThis.qwebrFormatRHistory = function() {
   return qwebrRCommandHistory.join("\n\n");
}

// Retrieve HTML Elements ----

// Get the command modal
const command_history_modal = document.getElementById("qwebr-history-modal");

// Get the button that opens the command modal
const command_history_btn = document.getElementById("qwebrRHistoryButton");

// Get the <span> element that closes the command modal
const command_history_close_span = document.getElementById("qwebr-command-history-close-btn");

// Get the download button for r history information
const command_history_download_btn = document.getElementById("qwebr-download-history-btn");

// Plug in command history into modal/download button ----

// Function to populate the modal with command history
function populateCommandHistoryModal() {
    document.getElementById("qwebr-command-history-contents").innerHTML = qwebrFormatRHistory() || "No commands have been executed yet.";
}

// Function to format the current date and time to
// a string with the format YYYY-MM-DD-HH-MM-SS
function formatDateTime() {
    const now = new Date();

    const year = now.getFullYear();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are zero-based
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day}-${hours}-${minutes}-${seconds}`;
}


// Function to convert document title with datetime to a safe filename
function safeFileName() {
    // Get the current page title
    let pageTitle = document.title;

    // Combine the current page title with the current date and time
    let pageNameWithDateTime = `Rhistory-${pageTitle}-${formatDateTime()}`;

    // Replace unsafe characters with safe alternatives
    let safeFilename = pageNameWithDateTime.replace(/[\\/:\*\?! "<>\|]/g, '-');

    return safeFilename;
}


// Function to download list contents as text file
function downloadRHistory() {
    // Get the current page title + datetime and use it as the filename
    const filename = `${safeFileName()}.R`;

    // Get the text contents of the R History list
    const text = qwebrFormatRHistory();

    // Create a new Blob object with the text contents
    const blob = new Blob([text], { type: 'text/plain' });
  
    // Create a new anchor element for the download
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = URL.createObjectURL(blob);
    a.download = filename;

    // Append the anchor to the body, click it, and remove it
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Register event handlers ----

// When the user clicks the View R History button, open the command modal
command_history_btn.onclick = function() {
    populateCommandHistoryModal();
    command_history_modal.style.display = "block";
}

// When the user clicks on <span> (x), close the command modal
command_history_close_span.onclick = function() {
    command_history_modal.style.display = "none";
}

// When the user clicks anywhere outside of the command modal, close it
window.onclick = function(event) {
    if (event.target == command_history_modal) {
        command_history_modal.style.display = "none";
    }
}

// Add an onclick event listener to the download button so that
// the user can download the R history as a text file
command_history_download_btn.onclick = function() {
    downloadRHistory();
};
</script><script type="module">
// Supported Evaluation Types for Context
globalThis.EvalTypes = Object.freeze({
  Interactive: 'interactive',
  Setup: 'setup',
  Output: 'output',
});

// Function that obtains the font size for a given element 
globalThis.qwebrCurrentFontSizeOnElement = function(element, cssProperty = 'font-size') {

  const currentFontSize = parseFloat(
    window
    .getComputedStyle(element)
    .getPropertyValue(cssProperty)
  );
  
  return currentFontSize;
}

// Function to determine font scaling
globalThis.qwebrScaledFontSize = function(div, qwebrOptions) {
  // Determine if we should compute font-size using RevealJS's `--r-main-font-size` 
  // or if we can directly use the document's `font-size`.
  const cssProperty = document.body.classList.contains('reveal') ? 
    "--r-main-font-size" : "font-size";
  
  // Get the current font size on the div element
  const elementFontSize = qwebrCurrentFontSizeOnElement(div, cssProperty);

  // Determine the scaled font size value
  const scaledFontSize = ((qwebrOptions['editor-font-scale'] ?? 1) * elementFontSize) ?? 17.5;

  return scaledFontSize;
}


// Function that dispatches the creation request
globalThis.qwebrCreateHTMLElement = function (
  cellData
) {

  // Extract key components
  const evalType = cellData.options.context;
  const qwebrCounter = cellData.id;

  // We make an assumption that insertion points are defined by the Lua filter as:
  // qwebr-insertion-location-{qwebrCounter} 
  const elementLocator = document.getElementById(`qwebr-insertion-location-${qwebrCounter}`);

  // Figure out the routine to use to insert the element.
  let qwebrElement;
  switch ( evalType ) {
    case EvalTypes.Interactive:
      qwebrElement = qwebrCreateInteractiveElement(qwebrCounter, cellData.options);
      break;
    case EvalTypes.Output: 
      qwebrElement = qwebrCreateNonInteractiveOutputElement(qwebrCounter, cellData.options);
      break;
    case EvalTypes.Setup: 
      qwebrElement = qwebrCreateNonInteractiveSetupElement(qwebrCounter, cellData.options);
      break;
    default: 
      qwebrElement = document.createElement('div');
      qwebrElement.textContent = 'Error creating `quarto-webr` element';
  }

  // Insert the dynamically generated object at the document location.
  elementLocator.appendChild(qwebrElement);
};

// Function that setups the interactive element creation
globalThis.qwebrCreateInteractiveElement = function (qwebrCounter, qwebrOptions) {

  // Create main div element
  var mainDiv = document.createElement('div');
  mainDiv.id = 'qwebr-interactive-area-' + qwebrCounter;
  mainDiv.className = `qwebr-interactive-area`;
  if (qwebrOptions.classes) {
    mainDiv.className += " " + qwebrOptions.classes
  }

  // Add a unique cell identifier that users can customize
  if (qwebrOptions.label) {
    mainDiv.setAttribute('data-id', qwebrOptions.label);
  }

  // Create toolbar div
  var toolbarDiv = document.createElement('div');
  toolbarDiv.className = 'qwebr-editor-toolbar';
  toolbarDiv.id = 'qwebr-editor-toolbar-' + qwebrCounter;

  // Create a div to hold the left buttons
  var leftButtonsDiv = document.createElement('div');
  leftButtonsDiv.className = 'qwebr-editor-toolbar-left-buttons';

  // Create a div to hold the right buttons
  var rightButtonsDiv = document.createElement('div');
  rightButtonsDiv.className = 'qwebr-editor-toolbar-right-buttons';

  // Create Run Code button
  var runCodeButton = document.createElement('button');
  runCodeButton.className = 'btn btn-default qwebr-button qwebr-button-run';
  runCodeButton.disabled = true;
  runCodeButton.type = 'button';
  runCodeButton.id = 'qwebr-button-run-' + qwebrCounter;
  runCodeButton.textContent = '🟡 Loading webR...';
  runCodeButton.title = `Run code (Shift + Enter)`;

  // Append buttons to the leftButtonsDiv
  leftButtonsDiv.appendChild(runCodeButton);

  // Create Reset button
  var resetButton = document.createElement('button');
  resetButton.className = 'btn btn-light btn-xs qwebr-button qwebr-button-reset';
  resetButton.type = 'button';
  resetButton.id = 'qwebr-button-reset-' + qwebrCounter;
  resetButton.title = 'Start over';
  resetButton.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i>';

  // Create Copy button
  var copyButton = document.createElement('button');
  copyButton.className = 'btn btn-light btn-xs qwebr-button qwebr-button-copy';
  copyButton.type = 'button';
  copyButton.id = 'qwebr-button-copy-' + qwebrCounter;
  copyButton.title = 'Copy code';
  copyButton.innerHTML = '<i class="fa-regular fa-copy"></i>';

  // Append buttons to the rightButtonsDiv
  rightButtonsDiv.appendChild(resetButton);
  rightButtonsDiv.appendChild(copyButton);

  // Create console area div
  var consoleAreaDiv = document.createElement('div');
  consoleAreaDiv.id = 'qwebr-console-area-' + qwebrCounter;
  consoleAreaDiv.className = 'qwebr-console-area';

  // Create editor div
  var editorDiv = document.createElement('div');
  editorDiv.id = 'qwebr-editor-' + qwebrCounter;
  editorDiv.className = 'qwebr-editor';

  // Create output code area div
  var outputCodeAreaDiv = document.createElement('div');
  outputCodeAreaDiv.id = 'qwebr-output-code-area-' + qwebrCounter;
  outputCodeAreaDiv.className = 'qwebr-output-code-area';
  outputCodeAreaDiv.setAttribute('aria-live', 'assertive');

  // Create pre element inside output code area
  var preElement = document.createElement('pre');
  preElement.style.visibility = 'hidden';
  outputCodeAreaDiv.appendChild(preElement);

  // Create output graph area div
  var outputGraphAreaDiv = document.createElement('div');
  outputGraphAreaDiv.id = 'qwebr-output-graph-area-' + qwebrCounter;
  outputGraphAreaDiv.className = 'qwebr-output-graph-area';

  // Append buttons to the toolbar
  toolbarDiv.appendChild(leftButtonsDiv);
  toolbarDiv.appendChild(rightButtonsDiv);

  // Append all elements to the main div
  mainDiv.appendChild(toolbarDiv);
  consoleAreaDiv.appendChild(editorDiv);
  consoleAreaDiv.appendChild(outputCodeAreaDiv);
  mainDiv.appendChild(consoleAreaDiv);
  mainDiv.appendChild(outputGraphAreaDiv);

  return mainDiv;
}

// Function that adds output structure for non-interactive output
globalThis.qwebrCreateNonInteractiveOutputElement = function(qwebrCounter, qwebrOptions) {
  // Create main div element
  var mainDiv = document.createElement('div');
  mainDiv.id = 'qwebr-noninteractive-area-' + qwebrCounter;
  mainDiv.className = `qwebr-noninteractive-area`;
  if (qwebrOptions.classes) {
    mainDiv.className += " " + qwebrOptions.classes
  }
  
  // Add a unique cell identifier that users can customize
  if (qwebrOptions.label) {
    mainDiv.setAttribute('data-id', qwebrOptions.label);
  }
  
  // Create a status container div
  var statusContainer = createLoadingContainer(qwebrCounter);

  // Create output code area div
  var outputCodeAreaDiv = document.createElement('div');
  outputCodeAreaDiv.id = 'qwebr-output-code-area-' + qwebrCounter;
  outputCodeAreaDiv.className = 'qwebr-output-code-area';
  outputCodeAreaDiv.setAttribute('aria-live', 'assertive');

  // Create pre element inside output code area
  var preElement = document.createElement('pre');
  preElement.style.visibility = 'hidden';
  outputCodeAreaDiv.appendChild(preElement);

  // Create output graph area div
  var outputGraphAreaDiv = document.createElement('div');
  outputGraphAreaDiv.id = 'qwebr-output-graph-area-' + qwebrCounter;
  outputGraphAreaDiv.className = 'qwebr-output-graph-area';

  // Append all elements to the main div
  mainDiv.appendChild(statusContainer);
  mainDiv.appendChild(outputCodeAreaDiv);
  mainDiv.appendChild(outputGraphAreaDiv);

  return mainDiv;
};

// Function that adds a stub in the page to indicate a setup cell was used.
globalThis.qwebrCreateNonInteractiveSetupElement = function(qwebrCounter, qwebrOptions) {
  // Create main div element
  var mainDiv = document.createElement('div');
  mainDiv.id = `qwebr-noninteractive-setup-area-${qwebrCounter}`;
  mainDiv.className = `qwebr-noninteractive-setup-area`;
  if (qwebrOptions.classes) {
    mainDiv.className += " " + qwebrOptions.classes
  }


  // Add a unique cell identifier that users can customize
  if (qwebrOptions.label) {
    mainDiv.setAttribute('data-id', qwebrOptions.label);
  }

  // Create a status container div
  var statusContainer = createLoadingContainer(qwebrCounter);

  // Append status onto the main div
  mainDiv.appendChild(statusContainer);

  return mainDiv;
}


// Function to create loading container with specified ID
globalThis.createLoadingContainer = function(qwebrCounter) {

  // Create a status container
  const container = document.createElement('div');
  container.id = `qwebr-non-interactive-loading-container-${qwebrCounter}`;
  container.className = 'qwebr-non-interactive-loading-container qwebr-cell-needs-evaluation';

  // Create an R project logo to indicate its a code space
  const rProjectIcon = document.createElement('i');
  rProjectIcon.className = 'fa-brands fa-r-project fa-3x qwebr-r-project-logo';

  // Setup a loading icon from font awesome
  const spinnerIcon = document.createElement('i');
  spinnerIcon.className = 'fa-solid fa-spinner fa-spin fa-1x qwebr-icon-status-spinner';

  // Add a section for status text
  const statusText = document.createElement('p');
  statusText.id = `qwebr-status-text-${qwebrCounter}`;
  statusText.className = `qwebr-status-text qwebr-cell-needs-evaluation`;
  statusText.innerText = 'Loading webR...';

  // Incorporate an inner container
  const innerContainer = document.createElement('div');

  // Append elements to the inner container
  innerContainer.appendChild(spinnerIcon);
  innerContainer.appendChild(statusText);

  // Append elements to the main container
  container.appendChild(rProjectIcon);
  container.appendChild(innerContainer);

  return container;
}
</script><script type="module">
// Function to install a single package
async function qwebrInstallRPackage(packageName) {
  await mainWebR.evalRVoid(`webr::install('${packageName}');`);
}

// Function to load a single package
async function qwebrLoadRPackage(packageName) {
  await mainWebR.evalRVoid(`require('${packageName}', quietly = TRUE)`);
}

// Generic function to process R packages
async function qwebrProcessRPackagesWithStatus(packages, processType, displayStatusMessageUpdate = true) {
  // Switch between contexts
  const messagePrefix = processType === 'install' ? 'Installing' : 'Loading';

  // Modify button state
  qwebrSetInteractiveButtonState(`🟡 ${messagePrefix} package ...`, false);

  // Iterate over packages
  for (let i = 0; i < packages.length; i++) {
    const activePackage = packages[i];
    const formattedMessage = `${messagePrefix} package ${i + 1} out of ${packages.length}: ${activePackage}`;

    // Display the update in header
    if (displayStatusMessageUpdate) {
      qwebrUpdateStatusHeader(formattedMessage);
    }

    // Display the update in non-active areas
    qwebrUpdateStatusMessage(formattedMessage);

    // Run package installation
    if (processType === 'install') {
      await qwebrInstallRPackage(activePackage);
    } else {
      await qwebrLoadRPackage(activePackage);
    }
  }

  // Clean slate
  if (processType === 'load') {
    await mainWebR.flush();
  }
}

// Start a timer
const initializeWebRTimerStart = performance.now();

// Encase with a dynamic import statement
globalThis.qwebrInstance = import(qwebrCustomizedWebROptions.baseURL + "webr.mjs").then(
  async ({ WebR, ChannelType }) => {
    // Populate WebR options with defaults or new values based on `webr` meta
    globalThis.mainWebR = new WebR(qwebrCustomizedWebROptions);

    // Initialization WebR
    await mainWebR.init();

    // Setup a shelter
    globalThis.mainWebRCodeShelter = await new mainWebR.Shelter();

    // Setup a pager to allow processing help documentation 
    await mainWebR.evalRVoid('webr::pager_install()'); 

    // Override the existing install.packages() to use webr::install()
    await mainWebR.evalRVoid('webr::shim_install()'); 

    // Specify the repositories to pull from
    // Note: webR does not use the `repos` option, but instead uses `webr_pkg_repos`
    // inside of `install()`. However, other R functions still pull from `repos`.
    await mainWebR.evalRVoid(`
      options(
        webr_pkg_repos = c(${qwebrPackageRepoURLS.map(repoURL => `'${repoURL}'`).join(',')}),
        repos = c(${qwebrPackageRepoURLS.map(repoURL => `'${repoURL}'`).join(',')})
      )
    `);

    // Check to see if any packages need to be installed
    if (qwebrSetupRPackages) {
      // Obtain only a unique list of packages
      const uniqueRPackageList = Array.from(new Set(qwebrInstallRPackagesList));

      // Install R packages one at a time (either silently or with a status update)
      await qwebrProcessRPackagesWithStatus(uniqueRPackageList, 'install', qwebrShowStartupMessage);

      if (qwebrAutoloadRPackages) {
        // Load R packages one at a time (either silently or with a status update)
        await qwebrProcessRPackagesWithStatus(uniqueRPackageList, 'load', qwebrShowStartupMessage);
      }
    }
  }
);

// Stop timer
const initializeWebRTimerEnd = performance.now();

</script><script type="module">
// Function to verify a given JavaScript Object is empty
globalThis.qwebrIsObjectEmpty = function (arr) {
    return Object.keys(arr).length === 0;
}

// Global version of the Escape HTML function that converts HTML 
// characters to their HTML entities.
globalThis.qwebrEscapeHTMLCharacters = function(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  };

// Passthrough results
globalThis.qwebrIdentity = function(x) {
    return x;
};

// Append a comment
globalThis.qwebrPrefixComment = function(x, comment) {
    return `${comment}${x}`;
};

// Function to store the code in the history
globalThis.qwebrLogCodeToHistory = function(codeToRun, options) {
    qwebrRCommandHistory.push(
        `# Ran code in ${options.label} at ${new Date().toLocaleString()} ----\n${codeToRun}`
    );
}

// Function to attach a download button onto the canvas
// allowing the user to download the image.
function qwebrImageCanvasDownloadButton(canvas, canvasContainer) {

    // Create the download button
    const downloadButton = document.createElement('button');
    downloadButton.className = 'qwebr-canvas-image-download-btn';
    downloadButton.textContent = 'Download Image';
    canvasContainer.appendChild(downloadButton);

    // Trigger a download of the image when the button is clicked
    downloadButton.addEventListener('click', function() {
        const image = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = image;
        link.download = 'qwebr-canvas-image.png';
        link.click();
    });
  }
  

// Function to parse the pager results
globalThis.qwebrParseTypePager = async function (msg) { 

    // Split out the event data
    const { path, title, deleteFile } = msg.data; 

    // Process the pager data by reading the information from disk
    const paged_data = await mainWebR.FS.readFile(path).then((data) => {
        // Obtain the file content
        let content = new TextDecoder().decode(data);

        // Remove excessive backspace characters until none remain
        while(content.match(/.[\b]/)){
        content = content.replace(/.[\b]/g, '');
        }

        // Returned cleaned data
        return content;
    });

    // Unlink file if needed
    if (deleteFile) { 
        await mainWebR.FS.unlink(path); 
    } 

    // Return extracted data with spaces
    return paged_data;
} 

// Function to run the code using webR and parse the output
globalThis.qwebrComputeEngine = async function(
    codeToRun, 
    elements, 
    options) {

    // Call into the R compute engine that persists within the document scope.
    // To be prepared for all scenarios, the following happens: 
    // 1. We setup a canvas device to write to by making a namespace call into the {webr} package
    // 2. We use values inside of the options array to set the figure size.
    // 3. We capture the output stream information (STDOUT and STERR)
    // 4. We disable the current device's image creation.
    // 5. Piece-wise parse the results into the different output areas

    // Create a pager variable for help/file contents
    let pager = [];

    // Handle how output is processed
    let showMarkup = options.results === "markup" && options.output !== "asis";
    let processOutput;

    if (showMarkup) {
        processOutput = qwebrEscapeHTMLCharacters;
    } else {
        processOutput = qwebrIdentity;
    }

    // ---- 
    // Convert from Inches to Pixels by using DPI (dots per inch)
    // for bitmap devices (dpi * inches = pixels)
    let fig_width = options["fig-width"] * options["dpi"]
    let fig_height = options["fig-height"] * options["dpi"]

    // Initialize webR
    await mainWebR.init();

    // Configure capture output
    let captureOutputOptions = {
        withAutoprint: true,
        captureStreams: true,
        captureConditions: false,
        // env: webR.objs.emptyEnv, // maintain a global environment for webR v0.2.0
    };
    
    // Determine if the browser supports OffScreen
    if (qwebrOffScreenCanvasSupport()) {
        // Mirror default options of webr::canvas()
        // with changes to figure height and width.
        captureOutputOptions.captureGraphics = {
            width: fig_width,
            height: fig_height,
            bg: "white", // default: transparent
            pointsize: 12,
            capture: true
        };
    }  else {
        // Disable generating graphics
        captureOutputOptions.captureGraphics = false;
    }

    // Store the code to run in history
    qwebrLogCodeToHistory(codeToRun, options);

    // Setup a webR canvas by making a namespace call into the {webr} package
    // Evaluate the R code
    // Remove the active canvas silently
    const result = await mainWebRCodeShelter.captureR(
        `${codeToRun}`,
        captureOutputOptions
    );

    // -----

    // Start attempting to parse the result data
    processResultOutput:try {
        
        // Avoid running through output processing
        if (options.results === "hide" || options.output === "false") { 
            break processResultOutput; 
        }

        // Merge output streams of STDOUT and STDErr (messages and errors are combined.)
        // Require both `warning` and `message` to be true to display `STDErr`. 
        const out = result.output
        .filter(
            evt => evt.type === "stdout" || 
            ( evt.type === "stderr" && (options.warning === "true" && options.message === "true")) 
        )
        .map((evt, index) => {
            const className = `qwebr-output-code-${evt.type}`;
            const outputResult = qwebrPrefixComment(processOutput(evt.data), options.comment);
            return `<code id="${className}-editor-${elements.id}-result-${index + 1}" class="${className}">${outputResult}</code>`;
        })
        .join("\n");


        // Clean the state
        // We're now able to process pager events.
        // As a result, we cannot maintain a true 1-to-1 output order 
        // without individually feeding each line
        const msgs = await mainWebR.flush();

        // Use `map` to process the filtered "pager" events asynchronously
        const pager = await Promise.all(
            msgs.filter(msg => msg.type === 'pager').map(
                async (msg) => {
                    return await qwebrParseTypePager(msg);
                }
            )
        );

        // Nullify the output area of content
        elements.outputCodeDiv.innerHTML = "";
        elements.outputGraphDiv.innerHTML = "";

        // Design an output object for messages
        const pre = document.createElement("pre");
        if (/\S/.test(out)) {
            // Display results as HTML elements to retain output styling
            const div = document.createElement("div");
            div.innerHTML = out;

            // Calculate a scaled font-size value
            const scaledFontSize = qwebrScaledFontSize(
                elements.outputCodeDiv, options);

            // Override output code cell size
            pre.style.fontSize = `${scaledFontSize}px`;
            pre.appendChild(div);
        } else {
            // If nothing is present, hide the element.
            pre.style.visibility = "hidden";
        }

        elements.outputCodeDiv.appendChild(pre);

        // Determine if we have graphs to display
        if (result.images.length > 0) {

            // Create figure element
            const figureElement = document.createElement("figure");
            figureElement.className = "qwebr-canvas-image";

            // Place each rendered graphic onto a canvas element
            result.images.forEach((img) => {

                // Construct canvas for object
                const canvas = document.createElement("canvas");

                // Add an image download button
                qwebrImageCanvasDownloadButton(canvas, figureElement);

                // Set canvas size to image
                canvas.width = img.width;
                canvas.height = img.height;

                // Apply output truncations
                canvas.style.width = options["out-width"] ? options["out-width"] : `${fig_width}px`;
                if (options["out-height"]) {
                    canvas.style.height = options["out-height"];
                }

                // Apply styling
                canvas.style.display = "block";
                canvas.style.margin = "auto";

                // Draw image onto Canvas
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, img.width, img.height);
          
                // Append canvas to figure output area
                figureElement.appendChild(canvas);

            });
            
            if (options['fig-cap']) {
                // Create figcaption element
                const figcaptionElement = document.createElement('figcaption');
                figcaptionElement.innerText = options['fig-cap'];
                // Append figcaption to figure
                figureElement.appendChild(figcaptionElement);    
            }
        
            elements.outputGraphDiv.appendChild(figureElement);

        }

        // Display the pager data
        if (pager) {
        // Use the `pre` element to preserve whitespace.
        pager.forEach((paged_data, index) => {
            let pre_pager = document.createElement("pre");
            pre_pager.innerText = paged_data;
            pre_pager.classList.add("qwebr-output-code-pager");
            pre_pager.setAttribute("id", `qwebr-output-code-pager-editor-${elements.id}-result-${index + 1}`);
            elements.outputCodeDiv.appendChild(pre_pager);
        });
        }
    } finally {
        // Clean up the remaining code
        mainWebRCodeShelter.purge();
    }
}

// Function to execute the code (accepts code as an argument)
globalThis.qwebrExecuteCode = async function (
    codeToRun,
    id,
    options = {}) {

    // If options are not passed, we fall back on the bare minimum to handle the computation
    if (qwebrIsObjectEmpty(options)) {
        options = { 
            "context": "interactive", 
            "fig-width": 7, "fig-height": 5, 
            "out-width": "700px", "out-height": "", 
            "dpi": 72,
            "results": "markup", 
            "warning": "true", "message": "true",
        };
    }

    // Next, we access the compute areas values
    const elements = {
        runButton: document.getElementById(`qwebr-button-run-${id}`),
        outputCodeDiv: document.getElementById(`qwebr-output-code-area-${id}`),
        outputGraphDiv: document.getElementById(`qwebr-output-graph-area-${id}`),
        id: id,
    }

    // Disallowing execution of other code cells
    document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
        btn.disabled = true;
    });

    if (options.context == EvalTypes.Interactive) {
        // Emphasize the active code cell
        elements.runButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin qwebr-icon-status-spinner"></i> <span>Run Code</span>';
    }

    // Evaluate the code and parse the output into the document
    await qwebrComputeEngine(codeToRun, elements, options);

    // Switch to allowing execution of code
    document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
        btn.disabled = false;
    });

    if (options.context == EvalTypes.Interactive) {
        // Revert to the initial code cell state
        elements.runButton.innerHTML = '<i class="fa-solid fa-play qwebr-icon-run-code"></i> <span>Run Code</span>';
    }
}

</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../style.css">
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-VectorDataBasics.html">Foundations</a></li><li class="breadcrumb-item"><a href="../chapters/05-SpatialInteractionVectorRaster.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">R as GIS for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/R-as-GIS-for-Economists" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/00-preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Demonstrations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-Demonstration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-VectorDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-SpatialInteractionVectorVector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-RasterDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-SpatialInteractionVectorRaster.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Extensions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-stars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-CreateMaps-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-DownloadSpatialData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">(slightly) Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-SpeedThingsUp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-ParallelComputing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Loop and Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-ggplot2-appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">ggplot2 minimals</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#before-you-start" id="toc-before-you-start" class="nav-link active" data-scroll-target="#before-you-start">Before you start</a>
  <ul class="collapse">
<li><a href="#direction-for-replication" id="toc-direction-for-replication" class="nav-link" data-scroll-target="#direction-for-replication">Direction for replication</a></li>
  </ul>
</li>
  <li><a href="#sec-raster-crop" id="toc-sec-raster-crop" class="nav-link" data-scroll-target="#sec-raster-crop"><span class="header-section-number">5.1</span> Cropping to the Area of Interest</a></li>
  <li>
<a href="#sec-extract-raster-to-vector" id="toc-sec-extract-raster-to-vector" class="nav-link" data-scroll-target="#sec-extract-raster-to-vector"><span class="header-section-number">5.2</span> Extracting Values from Raster Layers for Vector Data</a>
  <ul class="collapse">
<li><a href="#simple-visual-illustrations-of-raster-data-extraction" id="toc-simple-visual-illustrations-of-raster-data-extraction" class="nav-link" data-scroll-target="#simple-visual-illustrations-of-raster-data-extraction"><span class="header-section-number">5.2.1</span> Simple visual illustrations of raster data extraction</a></li>
  <li><a href="#extracting-to-points" id="toc-extracting-to-points" class="nav-link" data-scroll-target="#extracting-to-points"><span class="header-section-number">5.2.2</span> Extracting to Points</a></li>
  <li><a href="#extracting-to-polygons-terra-way" id="toc-extracting-to-polygons-terra-way" class="nav-link" data-scroll-target="#extracting-to-polygons-terra-way"><span class="header-section-number">5.2.3</span> Extracting to Polygons (<code>terra</code> way)</a></li>
  <li><a href="#sec-exactextractr" id="toc-sec-exactextractr" class="nav-link" data-scroll-target="#sec-exactextractr"><span class="header-section-number">5.2.4</span> Extracting to Polygons (<code>exactextractr</code> way)</a></li>
  </ul>
</li>
  <li>
<a href="#sec-extract-speed" id="toc-sec-extract-speed" class="nav-link" data-scroll-target="#sec-extract-speed"><span class="header-section-number">5.3</span> Extraction speed comparison</a>
  <ul class="collapse">
<li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">5.3.1</span> Data preparation</a></li>
  <li><a href="#points-terraextract" id="toc-points-terraextract" class="nav-link" data-scroll-target="#points-terraextract"><span class="header-section-number">5.3.2</span> Points: <code>terra::extract()</code></a></li>
  <li><a href="#polygons-exactextractrexact_extract-and-terraextract" id="toc-polygons-exactextractrexact_extract-and-terraextract" class="nav-link" data-scroll-target="#polygons-exactextractrexact_extract-and-terraextract"><span class="header-section-number">5.3.3</span> Polygons: <code>exactextractr::exact_extract()</code> and <code>terra::extract()</code></a></li>
  <li><a href="#single-layer-vs-multi-layer" id="toc-single-layer-vs-multi-layer" class="nav-link" data-scroll-target="#single-layer-vs-multi-layer"><span class="header-section-number">5.3.4</span> Single-layer vs multi-layer</a></li>
  </ul>
</li>
  <li>
<a href="#sec-exercises-int-rv" id="toc-sec-exercises-int-rv" class="nav-link" data-scroll-target="#sec-exercises-int-rv"><span class="header-section-number">5.4</span> Exercises</a>
  <ul class="collapse">
<li><a href="#exercise-1-extraction-to-points" id="toc-exercise-1-extraction-to-points" class="nav-link" data-scroll-target="#exercise-1-extraction-to-points"><span class="header-section-number">5.4.1</span> Exercise 1: Extraction to points</a></li>
  <li><a href="#exercise-2-extraction-to-polygons" id="toc-exercise-2-extraction-to-polygons" class="nav-link" data-scroll-target="#exercise-2-extraction-to-polygons"><span class="header-section-number">5.4.2</span> Exercise 2: Extraction to polygons</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/05-SpatialInteractionVectorRaster.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script><script type="module" id="qwebr-monaco-editor-init">

  // Configure the Monaco Editor's loader
  require.config({
    paths: {
      'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs'
    }
  });
</script><script type="module">
// Function to update Monaco Editors when body class changes
function updateMonacoEditorsOnBodyClassChange() {
    // Select the body element
    const body = document.querySelector('body');

    // Options for the observer (which mutations to observe)
    const observerOptions = {
        attributes: true,  // Observe changes to attributes
        attributeFilter: ['class'] // Only observe changes to the 'class' attribute
    };

    // Callback function to execute when mutations are observed
    const bodyClassChangeCallback = function(mutationsList, observer) {
        for(let mutation of mutationsList) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                // Class attribute has changed
                // Update all Monaco Editors on the page
                updateMonacoEditorTheme();
            }
        }
    };

    // Create an observer instance linked to the callback function
    const observer = new MutationObserver(bodyClassChangeCallback);

    // Start observing the target node for configured mutations
    observer.observe(body, observerOptions);
}

// Function to update all instances of Monaco Editors on the page
function updateMonacoEditorTheme() {
    // Determine what VS Theme to use
    const vsThemeToUse = document.body.classList.contains("quarto-dark") ? 'vs-dark' : 'vs' ;

    // Iterate through all initialized Monaco Editors
    qwebrEditorInstances.forEach( function(editorInstance) { 
        editorInstance.updateOptions({ theme: vsThemeToUse }); 
    });
}

// Call the function to start observing changes to body class
updateMonacoEditorsOnBodyClassChange();
</script><script type="module">
// Global array to store Monaco Editor instances
globalThis.qwebrEditorInstances = [];

function isValidCodeLineNumbers(stringCodeLineNumbers) {
  // Regular expression to match valid input strings
  const regex = /^(\d+(-\d+)?)(,\d+(-\d+)?)*$/;
  return regex.test(stringCodeLineNumbers);
}

// Function that builds and registers a Monaco Editor instance    
globalThis.qwebrCreateMonacoEditorInstance = function (cellData) {

  const initialCode = cellData.code;
  const qwebrCounter = cellData.id;
  const qwebrOptions = cellData.options;

  // Retrieve the previously created document elements
  let runButton = document.getElementById(`qwebr-button-run-${qwebrCounter}`);
  let resetButton = document.getElementById(`qwebr-button-reset-${qwebrCounter}`);
  let copyButton = document.getElementById(`qwebr-button-copy-${qwebrCounter}`);
  let editorDiv = document.getElementById(`qwebr-editor-${qwebrCounter}`);

  // Load the Monaco Editor and create an instance
  let editor;
  require(['vs/editor/editor.main'], function () {
    editor = monaco.editor.create(editorDiv, {
      value: initialCode,
      language: 'r',
      theme: 'vs-light',
      automaticLayout: true,           // Works wonderfully with RevealJS
      scrollBeyondLastLine: false,
      minimap: {
        enabled: false
      },
      fontSize: qwebrScaledFontSize(editorDiv, qwebrOptions),         
      renderLineHighlight: "none",      // Disable current line highlighting
      hideCursorInOverviewRuler: true,  // Remove cursor indictor in right hand side scroll bar
      readOnly: qwebrOptions['read-only'] ?? false,
      quickSuggestions: qwebrOptions['editor-quick-suggestions'] ?? false,
      wordWrap: (qwebrOptions['editor-word-wrap'] == 'true' ? "on" : "off")
    });

    // Store the official counter ID to be used in keyboard shortcuts
    editor.__qwebrCounter = qwebrCounter;

    // Store the official div container ID
    editor.__qwebrEditorId = `qwebr-editor-${qwebrCounter}`;

    // Store the initial code value and options
    editor.__qwebrinitialCode = initialCode;
    editor.__qwebrOptions = qwebrOptions;

    // Set at the model level the preferred end of line (EOL) character to LF.
    // This prevent `\r\n` from being given to the webR engine if the user is on Windows.
    // See details in: https://github.com/coatless/quarto-webr/issues/94
    // Associated error text: 
    // Error: <text>:1:7 unexpected input

    // Retrieve the underlying model
    const model = editor.getModel();
    // Set EOL for the model
    model.setEOL(monaco.editor.EndOfLineSequence.LF);
    
    // Dynamically modify the height of the editor window if new lines are added.
    let ignoreEvent = false;
    const updateHeight = () => {
      // Increment editor height by 2 to prevent vertical scroll bar from appearing
      const contentHeight = editor.getContentHeight() + 2;

      // Retrieve editor-max-height option
      const maxEditorHeight = qwebrOptions['editor-max-height'];

      // If editor-max-height is missing, allow infinite growth. Otherwise, threshold.
      const editorHeight = !maxEditorHeight ?  contentHeight : Math.min(contentHeight, maxEditorHeight);

      // We're avoiding a width change
      //editorDiv.style.width = `${width}px`;
      editorDiv.style.height = `${editorHeight}px`;
      try {
        ignoreEvent = true;

        // The key to resizing is this call
        editor.layout();
      } finally {
        ignoreEvent = false;
      }
    };

    // Function to generate decorations to highlight lines
    // in the editor based on input string.
    function decoratorHighlightLines(codeLineNumbers) {
      // Store the lines to be lighlight
      let linesToHighlight = [];
      
      // Parse the codeLineNumbers string to get the line numbers to highlight
      // First, split the string by commas
      codeLineNumbers.split(',').forEach(part => {
        // Check if we have a range of lines
        if (part.includes('-')) {
            // Handle range of lines (e.g., "6-8")
            const [start, end] = part.split('-').map(Number);
            for (let i = start; i <= end; i++) {
                linesToHighlight.push(i);
            }
        } else {
            // Handle single line (e.g., "7")
            linesToHighlight.push(Number(part));
        }
      });
  
      // Create monaco decorations for the lines to highlight
      const decorations = linesToHighlight.map(lineNumber => ({
          range: new monaco.Range(lineNumber, 1, lineNumber, 1),
          options: {
              isWholeLine: true,
              className: 'qwebr-editor-highlight-line'
          }
      }));
  
      // Return decorations to be applied to the editor
      return decorations;
    }

    // Ensure that the editor-code-line-numbers option is set and valid
    // then apply styling
    if (qwebrOptions['editor-code-line-numbers']) {
      // Remove all whitespace from the string
      const codeLineNumbers = qwebrOptions['editor-code-line-numbers'].replace(/\s/g,'');
      // Check if the string is valid for line numbers, e.g., "1,3-5,7"
      if (isValidCodeLineNumbers(codeLineNumbers)) {
        // Apply the decorations to the editor
        editor.createDecorationsCollection(decoratorHighlightLines(codeLineNumbers));
      } else {
        // Warn the user that the input is invalid
        console.warn(`Invalid "editor-code-line-numbers" value in code cell ${qwebrOptions['label']}: ${codeLineNumbers}`);
      }
    }

    // Helper function to check if selected text is empty
    function isEmptyCodeText(selectedCodeText) {
      return (selectedCodeText === null || selectedCodeText === undefined || selectedCodeText === "");
    }

    // Registry of keyboard shortcuts that should be re-added to each editor window
    // when focus changes.
    const addWebRKeyboardShortCutCommands = () => {
      // Add a keydown event listener for Shift+Enter to run all code in cell
      editor.addCommand(monaco.KeyMod.Shift | monaco.KeyCode.Enter, () => {

        // Retrieve all text inside the editor
        qwebrExecuteCode(editor.getValue(), editor.__qwebrCounter, editor.__qwebrOptions);
      });

      // Add a keydown event listener for CMD/Ctrl+Enter to run selected code
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {

        // Get the selected text from the editor
        const selectedText = editor.getModel().getValueInRange(editor.getSelection());
        // Check if no code is selected
        if (isEmptyCodeText(selectedText)) {
          // Obtain the current cursor position
          let currentPosition = editor.getPosition();
          // Retrieve the current line content
          let currentLine = editor.getModel().getLineContent(currentPosition.lineNumber);

          // Propose a new position to move the cursor to
          let newPosition = new monaco.Position(currentPosition.lineNumber + 1, 1);

          // Check if the new position is beyond the last line of the editor
          if (newPosition.lineNumber > editor.getModel().getLineCount()) {
            // Add a new line at the end of the editor
            editor.executeEdits("addNewLine", [{
            range: new monaco.Range(newPosition.lineNumber, 1, newPosition.lineNumber, 1),
            text: "\n", 
            forceMoveMarkers: true,
            }]);
          }
          
          // Run the entire line of code.
          qwebrExecuteCode(currentLine, editor.__qwebrCounter, editor.__qwebrOptions);

          // Move cursor to new position
          editor.setPosition(newPosition);
        } else {
          // Code to run when Ctrl+Enter is pressed with selected code
          qwebrExecuteCode(selectedText, editor.__qwebrCounter, editor.__qwebrOptions);
        }
      });
    }

    // Register an on focus event handler for when a code cell is selected to update
    // what keyboard shortcut commands should work.
    // This is a workaround to fix a regression that happened with multiple
    // editor windows since Monaco 0.32.0 
    // https://github.com/microsoft/monaco-editor/issues/2947
    editor.onDidFocusEditorText(addWebRKeyboardShortCutCommands);

    // Register an on change event for when new code is added to the editor window
    editor.onDidContentSizeChange(updateHeight);

    // Manually re-update height to account for the content we inserted into the call
    updateHeight();

    // Store the editor instance in the global dictionary
    qwebrEditorInstances[editor.__qwebrCounter] = editor;

  });

  // Add a click event listener to the run button
  runButton.onclick = function () {
    qwebrExecuteCode(editor.getValue(), editor.__qwebrCounter, editor.__qwebrOptions);
  };

  // Add a click event listener to the reset button
  copyButton.onclick = function () {
    // Retrieve current code data
    const data = editor.getValue();
    
    // Write code data onto the clipboard.
    navigator.clipboard.writeText(data || "");
  };
  
  // Add a click event listener to the copy button
  resetButton.onclick = function () {
    editor.setValue(editor.__qwebrinitialCode);
  };
  
}
</script><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-VectorDataBasics.html">Foundations</a></li><li class="breadcrumb-item"><a href="../chapters/05-SpatialInteractionVectorRaster.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-int-RV" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="before-you-start" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="before-you-start">Before you start</h2>
<p>In this chapter we learn the spatial interactions of a vector and raster dataset. We first look at how to crop (spatially subset) a raster dataset based on the geographic extent of a vector dataset. We then cover how to extract values from raster data for points and polygons. To be precise, here is what we mean by raster data extraction and what it does for points and polygons data:</p>
<ul>
<li><p><strong>Points</strong>: For each of the points, find which raster cell it is located within, and assign the value of the cell to the point.</p></li>
<li><p><strong>Polygons</strong>: For each of the polygons, identify all the raster cells that intersect with the polygon, and assign a vector of the cell values to the polygon</p></li>
</ul>
<p>We will show how we can use <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> for both cases. But, we will also see that for polygons, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> from the <code>exactextractr</code> package is often considerably faster than <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>.</p>
<p>To test your knowledge, you can work on coding exercises at <a href="#sec-exercises-int-rv" class="quarto-xref"><span>Section 5.4</span></a>.</p>
<section id="direction-for-replication" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="direction-for-replication">Direction for replication</h3>
<p><strong>Datasets</strong></p>
<p>All the datasets that you need to import are available <a href="https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0">here</a>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</p>
<ul>
<li>set a folder (any folder) as the working directory using <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code>
</li>
<li>create a folder called “Data” inside the folder designated as the working directory (if you have created a “Data” folder previously, skip this step)</li>
<li>download the pertinent datasets from <a href="https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0">here</a>
</li>
<li>place all the files in the downloaded folder in the “Data” folder</li>
</ul>
<p><strong>Packages</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">terra</span>, <span class="co"># handle raster data</span></span>
<span>  <span class="va">tidyterra</span>, <span class="co"># handle and visualize raster data</span></span>
<span>  <span class="va">raster</span>, <span class="co"># handle raster data</span></span>
<span>  <span class="va">exactextractr</span>, <span class="co"># fast extractions</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">tidyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">data.table</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">prism</span>, <span class="co"># download PRISM data</span></span>
<span>  <span class="va">tictoc</span>, <span class="co"># timing codes</span></span>
<span>  <span class="va">tigris</span> <span class="co"># to get county sf</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-raster-crop" class="level2 page-columns page-full" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="sec-raster-crop">
<span class="header-section-number">5.1</span> Cropping to the Area of Interest</h2>
<p>Here we use PRISM maximum temperature (tmax) data as a raster dataset and Kansas county boundaries as a vector dataset.</p>
<p>Let’s download the tmax data for July 1, 2018 (<a href="#fig-prism-tmax-map" class="quarto-xref">Figure&nbsp;<span>5.1</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- set the path to the folder to which you save the downloaded PRISM data ---#</span></span>
<span><span class="co"># This code sets the current working directory as the designated folder</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>prism.path <span class="op">=</span> <span class="st">"Data"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- download PRISM precipitation data ---#</span></span>
<span><span class="fu">prism</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">get_prism_dailys</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>  date <span class="op">=</span> <span class="st">"2018-07-01"</span>,</span>
<span>  keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span><span class="va">prism_file</span> <span class="op">&lt;-</span> <span class="st">"Data/PRISM_tmax_stable_4kmD2_20180701_bil/PRISM_tmax_stable_4kmD2_20180701_bil.bil"</span></span>
<span></span>
<span><span class="co">#--- read in the prism data ---#</span></span>
<span><span class="va">prism_tmax_0701_sr</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">prism_file</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">prism_tmax_0701_sr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_whitebox_c</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"muted"</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op">(</span>suffix <span class="op">=</span> <span class="st">"º"</span><span class="op">)</span>,</span>
<span>    n.breaks <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-prism-tmax-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-prism-tmax-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-prism-tmax-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prism-tmax-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.1: Map of PRISM tmax data on July 1, 2018
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>We now get Kansas county border data from the <code>tigris</code> package (<a href="#fig-ks-county-map" class="quarto-xref">Figure&nbsp;<span>5.2</span></a>) as <code>sf</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- Kansas boundary (sf) ---#</span></span>
<span><span class="va">KS_county_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="co">#--- get Kansas county boundary ---</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Kansas"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- sp to sf ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- transform using the CRS of the PRISM tmax data  ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="va">prism_tmax_0701_sr</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- gen map ---#</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_county_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-ks-county-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ks-county-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-ks-county-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ks-county-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.2: Kansas county boundaries
</figcaption></figure>
</div>
</div>
</div>
</div></div><hr>
<p>Cropping a raster layer to the area of interest can be useful, as it eliminates unnecessary data and reduces processing time. A smaller raster also makes value extraction faster. You can crop a raster layer using <code><a href="https://rspatial.github.io/terra/reference/crop.html">terra::crop()</a></code>, as shown below:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- syntax (this does not run) ---#</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">SpatRaster</span>, <span class="va">sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, in this case, this does the job.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- crop the entire PRISM to its KS portion---#</span></span>
<span><span class="va">prism_tmax_0701_KS_sr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-prism-ks-viz" class="quarto-xref">Figure&nbsp;<span>5.3</span></a> shows the PRISM tmax raster data cropped to the geographic extent of Kansas. Notice that the cropped raster layer extends beyond the outer boundary of Kansas state boundary (it is a bit hard to see, but look at the upper right corner).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">prism_tmax_0701_KS_sr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_county_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_whitebox_c</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"muted"</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op">(</span>suffix <span class="op">=</span> <span class="st">"º"</span><span class="op">)</span>,</span>
<span>    n.breaks <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-prism-ks-viz" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-prism-ks-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-prism-ks-viz-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prism-ks-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.3: PRISM tmax raster data cropped to the geographic extent of Kansas
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-extract-raster-to-vector" class="level2 page-columns page-full" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="sec-extract-raster-to-vector">
<span class="header-section-number">5.2</span> Extracting Values from Raster Layers for Vector Data</h2>
<p>In this section, we will learn how to extract information from raster layers for spatial units represented as vector data (points and polygons). For the demonstrations in this section, we use the following datasets:</p>
<ul>
<li>Raster: PRISM tmax data cropped to Kansas state border for 07/01/2018 (obtained in <a href="#sec-raster-crop" class="quarto-xref"><span>Section 5.1</span></a>) and 07/02/2018 (downloaded below)</li>
<li>Polygons: Kansas county boundaries (obtained in <a href="#sec-raster-crop" class="quarto-xref"><span>Section 5.1</span></a>)</li>
<li>Points: Irrigation wells in Kansas (imported below)</li>
</ul>
<section id="simple-visual-illustrations-of-raster-data-extraction" class="level3" data-number="5.2.1"><h3 data-number="5.2.1" class="anchored" data-anchor-id="simple-visual-illustrations-of-raster-data-extraction">
<span class="header-section-number">5.2.1</span> Simple visual illustrations of raster data extraction</h3>
<p><strong>Extracting to Points</strong></p>
<p><a href="#fig-illustrate-points" class="quarto-xref">Figure&nbsp;<span>5.4</span></a> shows visually what we mean by “extract raster values to points.”</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">378533</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- create polygons ---#</span></span>
<span><span class="va">polygon</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raster_like_cells</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid</a></span><span class="op">(</span><span class="va">polygon</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">64</span>, <span class="fl">64</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stars_cells</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html">st_rasterize</a></span><span class="op">(</span><span class="va">raster_like_cells</span>, nx <span class="op">=</span> <span class="fl">8</span>, ny <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cell_centroids</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">raster_like_cells</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="co"># Create points for which values are extracted</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="co">#--- points ---#</span></span>
<span><span class="va">point_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.4</span>, <span class="fl">2.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">point_2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6.7</span>, <span class="fl">1.8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">point_3</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.2</span>, <span class="fl">7.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- combine the points to make a single  sf of points ---#</span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">point_1</span>, <span class="va">point_2</span>, <span class="va">point_3</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>point_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Point 1"</span>, <span class="st">"Point 2"</span>, <span class="st">"Point 3"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="co"># Create maps</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stars_cells</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Value"</span>, palette <span class="op">=</span> <span class="st">"Spectral"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">raster_like_cells</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points</span>, <span class="fu">aes</span><span class="op">(</span>shape <span class="op">=</span> <span class="va">point_name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_shape</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Points"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-illustrate-points" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-illustrate-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-illustrate-points-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-illustrate-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.4: Visual illustration of raster data extraction for points data
</figcaption></figure>
</div>
</div>
</div>
<p>In the figure, we have grids (cells) and each grid holds a value (presented at the center). There are three points. We will find which grid the points fall inside and get the associated values and assign them to the points. In this example, Points 1, 2, and 3 will have 50, 4, 54, respectively,</p>
<p><strong>Extracting to Polygons</strong></p>
<p><a href="#fig-polygons-extact-viz" class="quarto-xref">Figure&nbsp;<span>5.5</span></a> shows visually what we mean by “extract raster values to polygons.”</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--------------------------</span></span>
<span><span class="co"># Create a polygon for which values are extracted</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="va">polygon_extract</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">2.3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">6.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">polygons_extract_viz</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stars_cells</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Value"</span>, palette <span class="op">=</span> <span class="st">"Spectral"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygon_extract</span>, fill <span class="op">=</span> <span class="st">"gray"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">cell_centroids</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">raster_like_cells</span>, </span>
<span>    <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">value</span><span class="op">)</span>,</span>
<span>    nudge_x <span class="op">=</span> <span class="op">-</span><span class="fl">0.25</span>,</span>
<span>    nudge_y <span class="op">=</span> <span class="fl">0.25</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span>
<span></span>
<span><span class="va">polygons_extract_viz</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-polygons-extact-viz" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-polygons-extact-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-polygons-extact-viz-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-polygons-extact-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.5: Visual illustration of raster data extraction for polygons data
</figcaption></figure>
</div>
</div>
</div>
<p>There is a polygon overlaid on top of the cells along with their centroids represented by black dots. Extracting raster values to a polygon means finding raster cells that intersect with the polygons and get the value of all those cells and assigns them to the polygon. As you can see some cells are completely inside the polygon, while others are only partially overlapping with the polygon. Depending on the function you use and its options, you regard different cells as being spatially related to the polygons. For example, by default, <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> will extract only the cells whose centroid is inside the polygon. But, you can add an option to include the cells that are only partially intersected with the polygon. In such a case, you can also get the fraction of the cell what is overlapped with the polygon, which enables us to find area-weighted values later. We will discuss the details these below.</p>
<p><strong>PRISM tmax data for 07/02/2018</strong></p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- download PRISM precipitation data ---#</span></span>
<span><span class="fu">prism</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">get_prism_dailys</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>  date <span class="op">=</span> <span class="st">"2018-07-02"</span>,</span>
<span>  keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span><span class="va">prism_file</span> <span class="op">&lt;-</span> <span class="st">"Data/PRISM_tmax_stable_4kmD2_20180702_bil/PRISM_tmax_stable_4kmD2_20180702_bil.bil"</span></span>
<span></span>
<span><span class="co">#--- read in the prism data and crop it to Kansas state border ---#</span></span>
<span><span class="va">prism_tmax_0702_KS_sr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">prism_file</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Irrigation wells in Kansas:</strong></p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read in the KS points data ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">KS_wells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/Chap_5_wells_KS.rds"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37647 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -102.0495 ymin: 36.99552 xmax: -94.62089 ymax: 40.00199
Geodetic CRS:  NAD83
First 10 features:
   well_id                   geometry
1        1 POINT (-100.4423 37.52046)
2        3 POINT (-100.7118 39.91526)
3        5 POINT (-99.15168 38.48849)
4        7 POINT (-101.8995 38.78077)
5        8  POINT (-100.7122 38.0731)
6        9 POINT (-97.70265 39.04055)
7       11 POINT (-101.7114 39.55035)
8       12 POINT (-95.97031 39.16121)
9       15 POINT (-98.30759 38.26787)
10      17 POINT (-100.2785 37.71539)</code></pre>
</div>
</div>
<hr>
<p>Here is how the wells are spatially distributed over the PRISM grids and Kansas county borders (<a href="06-stars.html#fig-tmax-prism-wells" class="quarto-xref">Figure&nbsp;<span>6.9</span></a>):</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_county_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells</span>, size <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-tmax-prism-wells" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-tmax-prism-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-tmax-prism-wells-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tmax-prism-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.6: Map of Kansas county borders, irrigation wells, and PRISM tmax
</figcaption></figure>
</div>
</div>
</div>
</section><section id="extracting-to-points" class="level3 page-columns page-full" data-number="5.2.2"><h3 data-number="5.2.2" class="anchored" data-anchor-id="extracting-to-points">
<span class="header-section-number">5.2.2</span> Extracting to Points</h3>
<p>You can extract values from raster layers to points using <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>. <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> finds which raster cell each of the points is located within and assigns the value of the cell to the point.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- syntax (this does not run) ---#</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">raster</span>, <span class="va">points</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>points</code> objects can be either <code>sf</code> or <code>SpatVect</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;<code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract</a></code> used to accept only <code>SpatVect</code> and the <code>sf</code> objects had to be converted to a <code>SpatVect</code> using <code><a href="https://rspatial.github.io/terra/reference/vect.html">terra::vect()</a></code></p></div></div><p>Let’s extract <code>tmax</code> values from the PRISM tmax layer (<code>prism_tmax_0701_KS_sr</code>) to the irrigation wells (<code>KS_wells</code> as <code>sf</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_from_prism</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_from_prism</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                               34.241
2  2                               29.288
3  3                               32.585
4  4                               30.104
5  5                               34.232
6  6                               35.168</code></pre>
</div>
</div>
<p>The resulting object is a <code>data.frame</code>, where the <code>ID</code> variable represents the order of the observations in the points data and the second column represents that values extracted for the points from the raster cells. So, you can assign the extracted values as a new variable of the points data as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells</span><span class="op">$</span><span class="va">tmax_07_01</span> <span class="op">&lt;-</span> <span class="va">tmax_from_prism</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Extracting values from a multi-layer <code>SpatRaster</code> works the same way. Here, we combine <code>prism_tmax_0701_KS_sr</code> and <code>prism_tmax_0702_KS_sr</code> to create a multi-layer <code>SpatRaster</code> and then extract values from them.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create a multi-layer SpatRaster ---#</span></span>
<span><span class="va">prism_tmax_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">prism_tmax_0702_KS_sr</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- extract tmax values ---#</span></span>
<span><span class="va">tmax_from_prism_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_stack</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_from_prism_stack</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               34.241                               30.544
2  2                               29.288                               29.569
3  3                               32.585                               29.866
4  4                               30.104                               29.819
5  5                               34.232                               30.481
6  6                               35.168                               30.640</code></pre>
</div>
</div>
<p>We now have two columns that hold values extracted from the raster cells: the 2nd column for the 1st raster layer and the 3rd column for the 2nd raster layer in <code>prism_tmax_stack</code>.</p>
</section><section id="extracting-to-polygons-terra-way" class="level3" data-number="5.2.3"><h3 data-number="5.2.3" class="anchored" data-anchor-id="extracting-to-polygons-terra-way">
<span class="header-section-number">5.2.3</span> Extracting to Polygons (<code>terra</code> way)</h3>
<p>You can use <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> for extracting raster cell values for polygons as well. For each of the polygons, it will identify all the raster cells whose center lies inside the polygon and assign the vector of values of the cells to the polygon.</p>
<section id="extract-from-a-single-layer-spatraster" class="level4" data-number="5.2.3.1"><h4 data-number="5.2.3.1" class="anchored" data-anchor-id="extract-from-a-single-layer-spatraster">
<span class="header-section-number">5.2.3.1</span> extract from a single-layer <code>SpatRaster</code>
</h4>
<p>Let’s extract <code>tmax</code> values from <code>prism_tmax_0701_KS_sr</code> for each of the KS counties.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract values from the raster for each county ---#</span></span>
<span><span class="va">tmax_by_county</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">KS_county_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- check the class ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "data.frame"</code></pre>
</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                               34.228
2  1                               34.222
3  1                               34.256
4  1                               34.268
5  1                               34.262
6  1                               34.477</code></pre>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       ID PRISM_tmax_stable_4kmD2_20180701_bil
12840 105                               34.185
12841 105                               34.180
12842 105                               34.241
12843 105                               34.381
12844 105                               34.295
12845 105                               34.267</code></pre>
</div>
</div>
<p>So, <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> returns a <code>data.frame</code>, where <code>ID</code> values represent the corresponding row number in the polygons data. For example, the observations with <code>ID == n</code> are for the <strong>n</strong>th polygon. Using this information, you can easily merge the extraction results to the polygons data. Suppose you are interested in the mean of the <code>tmax</code> values of the intersecting cells for each of the polygons, then you can do the following:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get mean tmax ---#</span></span>
<span><span class="va">mean_tmax</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tmax_by_county</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">PRISM_tmax_stable_4kmD2_20180701_bil</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">KS_county_sf</span> <span class="op">&lt;-</span></span>
<span>    <span class="co">#--- back to sf ---#</span></span>
<span>    <span class="va">KS_county_sf</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- define ID ---#</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span><span class="va">ID</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- merge by ID ---#</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">.</span>, <span class="va">mean_tmax</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 14 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -102.0517 ymin: 36.99302 xmax: -94.58841 ymax: 40.00316
Geodetic CRS:  NAD83
First 10 features:
   STATEFP COUNTYFP COUNTYNS       AFFGEOID GEOID         NAME
1       20      175 00485050 0500000US20175 20175       Seward
2       20      027 00484983 0500000US20027 20027         Clay
3       20      171 00485048 0500000US20171 20171        Scott
4       20      047 00484993 0500000US20047 20047      Edwards
5       20      147 00485037 0500000US20147 20147     Phillips
6       20      149 00485038 0500000US20149 20149 Pottawatomie
7       20      055 00485326 0500000US20055 20055       Finney
8       20      167 00485046 0500000US20167 20167      Russell
9       20      135 00485031 0500000US20135 20135         Ness
10      20      093 00485011 0500000US20093 20093       Kearny
              NAMELSAD STUSPS STATE_NAME LSAD      ALAND   AWATER ID     tmax
1        Seward County     KS     Kansas   06 1656693304  1961444  1 34.21421
2          Clay County     KS     Kansas   06 1671314413 26701337  2 32.58354
3         Scott County     KS     Kansas   06 1858536838   306079  3 34.63195
4       Edwards County     KS     Kansas   06 1610699245   206413  4 33.40829
5      Phillips County     KS     Kansas   06 2294395636 22493383  5 34.01768
6  Pottawatomie County     KS     Kansas   06 2177493041 54149843  6 35.54426
7        Finney County     KS     Kansas   06 3372157854  1716371  7 34.47948
8       Russell County     KS     Kansas   06 2295402858 34126776  8 33.55797
9          Ness County     KS     Kansas   06 2783562234   667491  9 34.77049
10       Kearny County     KS     Kansas   06 2254696661  1133601 10 33.56413
                         geometry
1  MULTIPOLYGON (((-101.0681 3...
2  MULTIPOLYGON (((-97.3707 39...
3  MULTIPOLYGON (((-101.1284 3...
4  MULTIPOLYGON (((-99.56988 3...
5  MULTIPOLYGON (((-99.62821 3...
6  MULTIPOLYGON (((-96.72774 3...
7  MULTIPOLYGON (((-101.103 37...
8  MULTIPOLYGON (((-99.04234 3...
9  MULTIPOLYGON (((-100.2477 3...
10 MULTIPOLYGON (((-101.5419 3...</code></pre>
</div>
</div>
</section><section id="extract-and-summarize-in-one-step" class="level4" data-number="5.2.3.2"><h4 data-number="5.2.3.2" class="anchored" data-anchor-id="extract-and-summarize-in-one-step">
<span class="header-section-number">5.2.3.2</span> extract and summarize in one step</h4>
<p>Instead of finding the mean after applying <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> as done above, you can do that within <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> using the <code>fun</code> option.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract values from the raster for each county ---#</span></span>
<span><span class="va">tmax_by_county</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    fun <span class="op">=</span> <span class="va">mean</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                             34.21421
2  2                             32.58354
3  3                             34.63195
4  4                             33.40829
5  5                             34.01768
6  6                             35.54426</code></pre>
</div>
</div>
<p>You can apply other summary functions like <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code>, <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code>.</p>
</section><section id="extract-from-multi-layer-spatraster" class="level4" data-number="5.2.3.3"><h4 data-number="5.2.3.3" class="anchored" data-anchor-id="extract-from-multi-layer-spatraster">
<span class="header-section-number">5.2.3.3</span> extract from multi-layer <code>SpatRaster</code>
</h4>
<p>Extracting values from a multi-layer raster data works exactly the same way except that data processing after the value extraction is slightly more complicated.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from a multi-layer raster object ---#</span></span>
<span><span class="va">tmax_by_county_from_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>,</span>
<span>    <span class="va">KS_county_sf</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county_from_stack</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               34.181                               30.414
2  1                               34.180                               30.314
3  1                               34.210                               30.238
4  1                               34.190                               30.163
5  1                               34.292                               30.207
6  1                               34.258                               30.222</code></pre>
</div>
</div>
<p>Similar to the single-layer case, the resulting object is a <code>data.frame</code> and you have two columns corresponding to each of the layers in the two-layer raster object.</p>
</section><section id="exact-true-option" class="level4" data-number="5.2.3.4"><h4 data-number="5.2.3.4" class="anchored" data-anchor-id="exact-true-option">
<span class="header-section-number">5.2.3.4</span> <code>exact = TRUE</code> option</h4>
<p>Sometimes, you would like to have how much of the raster cells are intersecting with the intersecting polygon to find area-weighted summary later. In that case, you can add <code>exact = TRUE</code> option to <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from a multi-layer raster object ---#</span></span>
<span><span class="va">tmax_by_county_from_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    exact <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county_from_stack</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               34.222                               30.489
2  1                               34.181                               30.414
3  1                               34.180                               30.314
4  1                               34.210                               30.238
5  1                               34.190                               30.163
6  1                               34.292                               30.207
   fraction
1 0.1074196
2 0.8066955
3 0.8067041
4 0.8066761
5 0.8061875
6 0.8054752</code></pre>
</div>
</div>
<p>As you can see, now you have <code>fraction</code> column to the resulting <code>data.frame</code> and you can find area-weighted summary of the extracted values like this:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_by_county_from_stack</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    tmax_0701 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span> <span class="op">*</span> <span class="va">PRISM_tmax_stable_4kmD2_20180701_bil</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span><span class="op">)</span>,</span>
<span>    tmax_0702 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span> <span class="op">*</span> <span class="va">PRISM_tmax_stable_4kmD2_20180702_bil</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 105 × 3
      ID tmax_0701 tmax_0702
   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1     1      34.5      30.5
 2     2      34.5      29.8
 3     3      33.6      31.2
 4     4      32.3      29.5
 5     5      32.6      28.7
 6     6      35.7      28.8
 7     7      34.0      30.6
 8     8      33.4      29.9
 9     9      32.9      30.4
10    10      33.4      30.6
# ℹ 95 more rows</code></pre>
</div>
</div>
</section></section><section id="sec-exactextractr" class="level3 page-columns page-full" data-number="5.2.4"><h3 data-number="5.2.4" class="anchored" data-anchor-id="sec-exactextractr">
<span class="header-section-number">5.2.4</span> Extracting to Polygons (<code>exactextractr</code> way)</h3>
<p><code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> function from the <code>exactextractr</code> package is a faster alternative than <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> for a large raster data as we confirm later (<code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> does not work with points data at the moment).<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> also provides a coverage fraction value for each of the cell-polygon intersections. The syntax of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> is very much similar to <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;See <a href="https://github.com/isciences/exactextract">here</a> for how it does extraction tasks differently from other major GIS software.</p></div></div><div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- syntax (this does not run) ---#</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>(raster, polygons sf, <span class="at">include_cols =</span> list of vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A notable difference and advantage of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> is that you can specify a list of variables from the polygons <code>sf</code> to be inherited to the output. This means that we do not have to merge the output with the polygons <code>sf</code> using the rule that the <strong>n</strong>th element of the output corresponds to the <strong>n</strong>th row of polygons <code>sf</code> unlike the <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> way. <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> can accept both <code>SpatRaster</code> and <code>Raster</code><span class="math inline">\(^*\)</span> objects as the raster object. However, while it accepts <code>sf</code> as the polygons object, but it does not accept <code>SpatVect</code>.</p>
<section id="extract-from-a-single-layer-spatraster-1" class="level4 page-columns page-full" data-number="5.2.4.1"><h4 data-number="5.2.4.1" class="anchored" data-anchor-id="extract-from-a-single-layer-spatraster-1">
<span class="header-section-number">5.2.4.1</span> extract from a single-layer <code>SpatRaster</code>
</h4>
<p>Let’s get <code>tmax</code> values from the PRISM raster layer for Kansas county polygons, the following does the job:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract values from the raster for each county ---#</span></span>
<span><span class="va">tmax_by_county</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    <span class="co">#--- inherit COUNTYFP from KS_county_sf ---#</span></span>
<span>    include_cols <span class="op">=</span> <span class="st">"COUNTYFP"</span>,</span>
<span>    <span class="co">#--- this is for not displaying progress bar ---#</span></span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting object is a list of <code>data.frame</code>s.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- take a look at the first 6 rows of the first two list elements ---#</span></span>
<span><span class="va">tmax_by_county</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
  COUNTYFP  value coverage_fraction
1      175 34.222         0.1074141
2      175 34.181         0.8066747
3      175 34.180         0.8066615
4      175 34.210         0.8066448
5      175 34.190         0.8061629
6      175 34.292         0.8054324

[[2]]
  COUNTYFP  value coverage_fraction
1      027 33.847        0.03732148
2      027 33.897        0.10592906
3      027 34.010        0.10249268
4      027 34.186        0.10018899
5      027 34.293        0.10074520
6      027 34.220        0.09701102</code></pre>
</div>
</div>
<p>For each element of the list, you see <code>value</code> and <code>coverage_fraction</code>. <code>value</code> is the <code>tmax</code> value of the intersecting raster cells, and <code>coverage_fraction</code> is the fraction of the intersecting area relative to the full raster grid, which can help find coverage-weighted summary of the extracted values (like <code>fraction</code> variable when you use <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> with <code>exact = TRUE</code>).</p>
<p>We can take advantage of <code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">dplyr::bind_rows()</a></code> to combine the list of the datasets into a single <code>data.frame</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co">#--- combine ---#</span></span>
<span>  <span class="va">tmax_combined</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">tmax_by_county</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15,149 × 3
   COUNTYFP value coverage_fraction
   &lt;chr&gt;    &lt;dbl&gt;             &lt;dbl&gt;
 1 175       34.2             0.107
 2 175       34.2             0.807
 3 175       34.2             0.807
 4 175       34.2             0.807
 5 175       34.2             0.806
 6 175       34.3             0.805
 7 175       34.3             0.805
 8 175       34.2             0.805
 9 175       34.2             0.803
10 175       34.2             0.803
# ℹ 15,139 more rows</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<p><code>data.table</code> users can use <code><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">data.table::rbindlist()</a></code> instead.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="va">tmax_by_county</span>, idcol <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          id COUNTYFP  value coverage_fraction
       &lt;int&gt;   &lt;char&gt;  &lt;num&gt;             &lt;num&gt;
    1:     1      175 34.222         0.1074141
    2:     1      175 34.181         0.8066747
    3:     1      175 34.180         0.8066615
    4:     1      175 34.210         0.8066448
    5:     1      175 34.190         0.8061629
   ---                                        
15145:   105      197 34.847         0.7625142
15146:   105      197 34.840         0.7627296
15147:   105      197 34.625         0.7640904
15148:   105      197 34.755         0.7634417
15149:   105      197 34.953         0.6051113</code></pre>
</div>
</div>
</div></div><p>Let’s summarize the data by <code>COUNTYFP</code> and then merge it back to the polygons <code>sf</code> data. Here, we calculate coverage-weighted mean of tmax.</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- weighted mean ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">tmax_by_county</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">tmax_combined</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- group summary ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">COUNTYFP</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>tmax_aw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 105 × 2
   COUNTYFP tmax_aw
   &lt;chr&gt;      &lt;dbl&gt;
 1 001         34.3
 2 003         34.9
 3 005         35.3
 4 007         34.1
 5 009         32.9
 6 011         34.8
 7 013         34.9
 8 015         34.3
 9 017         35.8
10 019         33.4
# ℹ 95 more rows</code></pre>
</div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- merge ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">KS_county_sf</span>, <span class="va">tmax_by_county</span>, by <span class="op">=</span> <span class="st">"COUNTYFP"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">tmax_aw</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -102.0517 ymin: 36.99302 xmax: -94.58841 ymax: 40.00316
Geodetic CRS:  NAD83
First 10 features:
   COUNTYFP  tmax_aw                       geometry
1       175 34.46388 MULTIPOLYGON (((-101.0681 3...
2       027 34.53894 MULTIPOLYGON (((-97.3707 39...
3       171 33.56887 MULTIPOLYGON (((-101.1284 3...
4       047 32.26198 MULTIPOLYGON (((-99.56988 3...
5       147 32.62552 MULTIPOLYGON (((-99.62821 3...
6       149 35.67416 MULTIPOLYGON (((-96.72774 3...
7       055 33.96688 MULTIPOLYGON (((-101.103 37...
8       167 33.35979 MULTIPOLYGON (((-99.04234 3...
9       135 32.86975 MULTIPOLYGON (((-100.2477 3...
10      093 33.41405 MULTIPOLYGON (((-101.5419 3...</code></pre>
</div>
</div>
</section><section id="extract-from-multi-layer-spatraster-1" class="level4 page-columns page-full" data-number="5.2.4.2"><h4 data-number="5.2.4.2" class="anchored" data-anchor-id="extract-from-multi-layer-spatraster-1">
<span class="header-section-number">5.2.4.2</span> extract from multi-layer <code>SpatRaster</code>
</h4>
<p>Extracting values from a multi-layer <code>SpatRaster</code> object works in exactly the same manner as a single-layer <code>SpatRaster</code> object.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_by_county_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    include_cols <span class="op">=</span> <span class="st">"COUNTYFP"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look at the first 6 lines of the first element---#</span></span>
<span><span class="va">tmax_by_county_stack</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  COUNTYFP PRISM_tmax_stable_4kmD2_20180701_bil
1      175                               34.222
2      175                               34.181
3      175                               34.180
4      175                               34.210
5      175                               34.190
6      175                               34.292
  PRISM_tmax_stable_4kmD2_20180702_bil coverage_fraction
1                               30.489         0.1074141
2                               30.414         0.8066747
3                               30.314         0.8066615
4                               30.238         0.8066448
5                               30.163         0.8061629
6                               30.207         0.8054324</code></pre>
</div>
</div>
<p>As you can see above, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> appends additional columns for additional layers.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- combine them ---#</span></span>
<span><span class="va">tmax_all_combined</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">tmax_by_county_stack</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_all_combined</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  COUNTYFP PRISM_tmax_stable_4kmD2_20180701_bil
1      175                               34.222
2      175                               34.181
3      175                               34.180
4      175                               34.210
5      175                               34.190
6      175                               34.292
  PRISM_tmax_stable_4kmD2_20180702_bil coverage_fraction
1                               30.489         0.1074141
2                               30.414         0.8066747
3                               30.314         0.8066615
4                               30.238         0.8066448
5                               30.163         0.8061629
6                               30.207         0.8054324</code></pre>
</div>
</div>
<p>In order to find the coverage-weighted <code>tmax</code> by date, you can first pivot it to a long format using <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">tidyr::pivot_longer()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- pivot to a longer format ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">tmax_long</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>      <span class="va">tmax_all_combined</span>,</span>
<span>      <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">coverage_fraction</span><span class="op">)</span>,</span>
<span>      names_to <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>      values_to <span class="op">=</span> <span class="st">"tmax"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30,298 × 4
   COUNTYFP coverage_fraction date                                  tmax
   &lt;chr&gt;                &lt;dbl&gt; &lt;chr&gt;                                &lt;dbl&gt;
 1 175                  0.107 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 2 175                  0.107 PRISM_tmax_stable_4kmD2_20180702_bil  30.5
 3 175                  0.807 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 4 175                  0.807 PRISM_tmax_stable_4kmD2_20180702_bil  30.4
 5 175                  0.807 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 6 175                  0.807 PRISM_tmax_stable_4kmD2_20180702_bil  30.3
 7 175                  0.807 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 8 175                  0.807 PRISM_tmax_stable_4kmD2_20180702_bil  30.2
 9 175                  0.806 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
10 175                  0.806 PRISM_tmax_stable_4kmD2_20180702_bil  30.2
# ℹ 30,288 more rows</code></pre>
</div>
</div>
<p>And then find coverage-weighted <code>tmax</code> by date:</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_long</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tmax</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 210 × 3
# Groups:   COUNTYFP [105]
   COUNTYFP date                                  tmax
   &lt;chr&gt;    &lt;chr&gt;                                &lt;dbl&gt;
 1 001      PRISM_tmax_stable_4kmD2_20180701_bil  34.3
 2 001      PRISM_tmax_stable_4kmD2_20180702_bil  29.4
 3 003      PRISM_tmax_stable_4kmD2_20180701_bil  34.9
 4 003      PRISM_tmax_stable_4kmD2_20180702_bil  29.4
 5 005      PRISM_tmax_stable_4kmD2_20180701_bil  35.3
 6 005      PRISM_tmax_stable_4kmD2_20180702_bil  28.9
 7 007      PRISM_tmax_stable_4kmD2_20180701_bil  34.1
 8 007      PRISM_tmax_stable_4kmD2_20180702_bil  29.7
 9 009      PRISM_tmax_stable_4kmD2_20180701_bil  32.9
10 009      PRISM_tmax_stable_4kmD2_20180702_bil  29.8
# ℹ 200 more rows</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<p>For <code>data.table</code> users, this does the same:</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_all_combined</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">melt</span><span class="op">(</span>id.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"COUNTYFP"</span>, <span class="st">"coverage_fraction"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     COUNTYFP                             variable     tmax
       &lt;char&gt;                               &lt;fctr&gt;    &lt;num&gt;
  1:      175 PRISM_tmax_stable_4kmD2_20180701_bil 34.46388
  2:      027 PRISM_tmax_stable_4kmD2_20180701_bil 34.53894
  3:      171 PRISM_tmax_stable_4kmD2_20180701_bil 33.56887
  4:      047 PRISM_tmax_stable_4kmD2_20180701_bil 32.26198
  5:      147 PRISM_tmax_stable_4kmD2_20180701_bil 32.62552
 ---                                                       
206:      169 PRISM_tmax_stable_4kmD2_20180702_bil 30.54567
207:      073 PRISM_tmax_stable_4kmD2_20180702_bil 29.64180
208:      071 PRISM_tmax_stable_4kmD2_20180702_bil 30.13041
209:      001 PRISM_tmax_stable_4kmD2_20180702_bil 29.43459
210:      197 PRISM_tmax_stable_4kmD2_20180702_bil 29.97933</code></pre>
</div>
</div>
</div></div></section><section id="extract-and-summarize-in-one-step-1" class="level4" data-number="5.2.4.3"><h4 data-number="5.2.4.3" class="anchored" data-anchor-id="extract-and-summarize-in-one-step-1">
<span class="header-section-number">5.2.4.3</span> extract and summarize in one step</h4>
<p>Instead of returning the value from all the intersecting cells, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> can summarize the extracted values by polygon and then return the summarized numbers. This is much like how <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> with <code>FUN</code> option works. There are multiple default options you can choose from. All you need to do is to add the desired summary function name as the third argument of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. For example, the following will get us the mean of the extracted values weighted by <code>coverage_fraction</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extacted_mean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>, </span>
<span>    <span class="va">KS_county_sf</span>, </span>
<span>    <span class="st">"mean"</span>, </span>
<span>    append_cols <span class="op">=</span> <span class="st">"COUNTYFP"</span>, </span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">extacted_mean</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that you use <code>append_cols</code> instead of <code>include_cols</code> when you summarize within <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">mean_tmax_long</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">extacted_mean</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- wide to long ---#</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">-</span><span class="va">COUNTYFP</span>, names_to <span class="op">=</span> <span class="st">"date"</span>, values_to <span class="op">=</span> <span class="st">"tmax"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- recover date ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"mean.date"</span>, <span class="st">""</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 210 × 3
   COUNTYFP date    tmax
   &lt;chr&gt;    &lt;date&gt; &lt;dbl&gt;
 1 175      NA      34.5
 2 175      NA      30.5
 3 027      NA      34.5
 4 027      NA      29.8
 5 171      NA      33.6
 6 171      NA      31.2
 7 047      NA      32.3
 8 047      NA      29.5
 9 147      NA      32.6
10 147      NA      28.7
# ℹ 200 more rows</code></pre>
</div>
</div>
<p>There are other summary function options that may be of interest, such as “max”, “min.” You can see all the default options at <a href="https://isciences.gitlab.io/exactextractr/index.html#summary-operations">the package website</a>.</p>
</section></section></section><section id="sec-extract-speed" class="level2 page-columns page-full" data-number="5.3"><h2 data-number="5.3" class="anchored" data-anchor-id="sec-extract-speed">
<span class="header-section-number">5.3</span> Extraction speed comparison</h2>
<p>Here we compare the extraction speed of <code><a href="https://rspatial.github.io/terra/reference/extract.html">raster::extract()</a></code>, <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>, and <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. A more comprehensive discussion on the speed of raster extraction can be found in <a href="09-SpeedThingsUp.html" class="quarto-xref"><span>Chapter 9</span></a>.</p>
<section id="data-preparation" class="level3" data-number="5.3.1"><h3 data-number="5.3.1" class="anchored" data-anchor-id="data-preparation">
<span class="header-section-number">5.3.1</span> Data preparation</h3>
<p>We first create two new R objects here:</p>
<ul>
<li>
<code>SpatVectore</code> version of <code>KS_wells</code>, which is currently an <code>sf</code> object.</li>
<li>
<code>SpatVectore</code> version of <code>KS_county_sf</code>, which is currently an <code>sf</code> object.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells_sv</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span></span>
<span><span class="va">KS_county_sv</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also create a version of <code>prism_tmax_0701_KS_sr</code> that is disaggregated by a factor of 10 to create a much larger raster data.</p>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- disaggregate ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">prism_tmax_0701_KS_sr_10</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/disaggregate.html">disagg</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, fact <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 730, 1790, 1  (nrow, ncol, nlyr)
resolution  : 0.004166667, 0.004166667  (x, y)
extent      : -102.0625, -94.60417, 36.97917, 40.02083  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 
source(s)   : memory
varname     : PRISM_tmax_stable_4kmD2_20180701_bil 
name        : PRISM_tmax_stable_4kmD2_20180701_bil 
min value   :                               27.711 
max value   :                               37.656 </code></pre>
</div>
</div>
<p>The disaggregated PRISM data now has 10 times more rows and columns.</p>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- original ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  73 179   1</code></pre>
</div>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- disaggregated ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  730 1790    1</code></pre>
</div>
</div>
</section><section id="points-terraextract" class="level3 page-columns page-full" data-number="5.3.2"><h3 data-number="5.3.2" class="anchored" data-anchor-id="points-terraextract">
<span class="header-section-number">5.3.2</span> Points: <code>terra::extract()</code>
</h3>
<p>Extraction speed of <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> depends on the class of the raster and vector (points) objects<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. Whether the points data is <code>sf</code> or <code>SpatVector</code> makes a difference as you can see below with <code>SpatVector</code> being faster.</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;Until recently, <code><a href="https://rspatial.github.io/terra/reference/extract.html">raster::extract()</a></code> was much much slower compared to <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>. However, recent updates to the package made significant improvement in extraction speed and <code><a href="https://rspatial.github.io/terra/reference/extract.html">raster::extract()</a></code> is comparable to <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> in speed.</p></div></div><div class="cell">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- SpatRaster and sf ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.221 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- SpatRaster and SpatVector ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_wells_sv</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.024 sec elapsed</code></pre>
</div>
</div>
<p>Although the time difference may seem small, it can accumulate significantly when extracting data from numerous raster layers to the same set of points, resulting in a notable increase in overall processing time. In such cases, it is recommended to first convert the points from <code>sf</code> to <code>SpatVector</code> before performing the extractions.</p>
</section><section id="polygons-exactextractrexact_extract-and-terraextract" class="level3" data-number="5.3.3"><h3 data-number="5.3.3" class="anchored" data-anchor-id="polygons-exactextractrexact_extract-and-terraextract">
<span class="header-section-number">5.3.3</span> Polygons: <code>exactextractr::exact_extract()</code> and <code>terra::extract()</code>
</h3>
<p><code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> is faster than <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> for a relatively small raster data. Let’s use <code>prism_tmax_0701_KS_sr</code> and time them to see the difference.</p>
<div class="cell" data-cahce="false">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- terra::extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">terra_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sv</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.031 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- exact_extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">exact_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.069 sec elapsed</code></pre>
</div>
</div>
<p>As you can see, <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> is faster than <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. However, once the raster data becomes larger (or spatially finer), then <code>exact_extact()</code> starts to shine.</p>
<hr>
<p>Now, let’s compare <code>terra::extrct()</code> and <code>exact_extrct()</code> using the disaggregated data.</p>
<div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- terra extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">terra_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">KS_county_sv</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.864 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- exact extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">exact_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exact_extract</span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.132 sec elapsed</code></pre>
</div>
</div>
<p>As you can see, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> is considerably faster. The difference in time becomes even more pronounced as the size of the raster data becomes larger and the number of polygons are greater. The time difference of several seconds seem nothing, but imagine processing Cropland Data Layer (CDL) files for the entire US over 10 years, then you would appreciate the speed of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. See <a href="09-SpeedThingsUp.html" class="quarto-xref"><span>Chapter 9</span></a> for more comprehensive treatment of raster value extraction speed.</p>
</section><section id="single-layer-vs-multi-layer" class="level3" data-number="5.3.4"><h3 data-number="5.3.4" class="anchored" data-anchor-id="single-layer-vs-multi-layer">
<span class="header-section-number">5.3.4</span> Single-layer vs multi-layer</h3>
<p>Pretend that you have five dates of PRISM tmax data (here we repeat the same file five times) and would like to extract values from all of them. Extracting values from a multi-layer raster objects (<code>RasterStack</code> for <code>raster</code> package) takes less time than extracting values from the individual layers one at a time. This can be observed below.</p>
<hr>
<p><strong><code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from 5 layers one at a time ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10.505 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from a 5-layer SpatRaster ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">prism_tmax_ml_5</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_ml_5</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3.094 sec elapsed</code></pre>
</div>
</div>
<hr>
<p><strong><code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from 5 layers one at a time ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.691 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- extract from from a 5-layer SpatRaster ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">prism_tmax_stack_5</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- set layer names ---#</span></span>
<span><span class="co"># exact_extract() does not like multi-layer raster with the same layer name</span></span>
<span><span class="fu">set.names</span><span class="op">(</span><span class="va">prism_tmax_stack_5</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"layer_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack_5</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.384 sec elapsed</code></pre>
</div>
</div>
<p>The reduction in computation time for both methods makes sense. Since both layers have exactly the same geographic extent and resolution, finding the polygons-cells correspondence is done once and then it can be used repeatedly across the layers for the multi-layer <code>SparRaster</code> and <code>RasterStack</code>. This clearly suggests that when you are processing many layers of the same spatial resolution and extent, you should first stack them and then extract values at the same time instead of processing them one by one as long as your memory allows you to do so.</p>
</section></section><section id="sec-exercises-int-rv" class="level2 page-columns page-full" data-number="5.4"><h2 data-number="5.4" class="anchored" data-anchor-id="sec-exercises-int-rv">
<span class="header-section-number">5.4</span> Exercises</h2>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Before working on exercises, please run the following codes by hitting the <strong>Run Code</strong> button.</p>
<div id="qwebr-insertion-location-1"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Tips for working with an `webr` session">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tips for working with an <code>webr</code> session
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Hit the <strong>Run Code</strong> button to run all the codes in the code area.</li>
<li>To run only parts of the code, highlight the section you want to execute with your cursor and then press <strong>Cmd + Return</strong> (Mac) or <strong>Ctrl + Enter</strong> (Windows).</li>
<li>All the code blocks are interconnected and R objects defined in one R code block is available in another R code block.</li>
</ul>
</div>
</div>
<section id="exercise-1-extraction-to-points" class="level3 page-columns page-full" data-number="5.4.1"><h3 data-number="5.4.1" class="anchored" data-anchor-id="exercise-1-extraction-to-points">
<span class="header-section-number">5.4.1</span> Exercise 1: Extraction to points</h3>
<p>In this exercise, we will use corn yield points data as <code>sf</code> and NDRE value as a <code>SpatRaster</code> (<a href="#fig-corn-ndre" class="quarto-xref">Figure&nbsp;<span>5.7</span></a> shows the map of the two spatial objects). Please run the following codes first to make them avaialable.</p>
<div id="qwebr-insertion-location-2"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">r.spatial.workshop.datasets</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">corn_yield</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">NDRE</span><span class="op">)</span></span>
<span><span class="va">NDRE</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">NDRE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDRE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">corn_yield</span>, size <span class="op">=</span> <span class="fl">0.03</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"NDRE"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-corn-ndre" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-corn-ndre-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-corn-ndre-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-corn-ndre-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.7: Map of corn yield data points and NDRE values
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Extract NDRE values to corn yield data points using <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> and find the correlation between corn yield (<code>yield</code>) and NDRE using <code><a href="https://rdrr.io/r/stats/cor.html">cor()</a></code>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Work here</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Answer</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div id="qwebr-insertion-location-3"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ndre_extracted</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">NDRE</span>, <span class="va">corn_yield</span><span class="op">)</span></span>
<span><span class="va">corn_yield</span><span class="op">$</span><span class="va">ndre</span> <span class="op">&lt;-</span> <span class="va">ndre_extracted</span><span class="op">$</span><span class="va">NDRE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">corn_yield</span><span class="op">$</span><span class="va">yield</span>, <span class="va">corn_yield</span><span class="op">$</span><span class="va">ndre</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section><section id="exercise-2-extraction-to-polygons" class="level3 page-columns page-full" data-number="5.4.2"><h3 data-number="5.4.2" class="anchored" data-anchor-id="exercise-2-extraction-to-polygons">
<span class="header-section-number">5.4.2</span> Exercise 2: Extraction to polygons</h3>
<p>In this exercise, we will use Nebraska’s county borders as an <code>sf</code> object and the aggregated version of the PRISM precipitation data from August 1st, 2012 as a <code>SpatRaster</code> (see <a href="#fig-prism-ne" class="quarto-xref">Figure&nbsp;<span>5.8</span></a> for their maps). Run the following codes first.</p>
<div id="qwebr-insertion-location-4"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">ne_counties</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">prism_us</span><span class="op">)</span></span>
<span><span class="va">prism_us</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">prism_us</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">prism_us</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ne_counties</span>, color <span class="op">=</span> <span class="st">"red"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_whitebox_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Precipitation"</span>, na.value <span class="op">=</span> <span class="st">"transparent"</span>, palette <span class="op">=</span> <span class="st">"muted"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-prism-ne" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-prism-ne-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05-SpatialInteractionVectorRaster_files/figure-html/fig-prism-ne-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prism-ne-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.8: PRISM precipitation data and Nebrask’s county borders
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Extract precipitation values from <code>prism_us</code> to <code>ne_counties</code> and find the average precipitation by county. You can use either <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> or <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>. Then, merge the precipitation data with <code>ne_counties</code>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Work here</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Answer</a></li>
</ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div id="qwebr-insertion-location-5"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- terra ---#</span></span>
<span><span class="va">prcp_data</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_us</span>, <span class="va">ne_counties</span>, fun <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="va">ne_counties</span><span class="op">$</span><span class="va">prcp</span> <span class="op">&lt;-</span> <span class="va">prcp_data</span><span class="op">$</span><span class="va">PRISM_ppt_stable_4kmD2_20120801_bil</span></span>
<span></span>
<span><span class="co">#--- exactextractr ---#</span></span>
<span><span class="va">prcp_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_us</span>,</span>
<span>    <span class="va">ne_counties</span>,</span>
<span>    <span class="st">"mean"</span>,</span>
<span>    append_cols <span class="op">=</span> <span class="st">"name"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">left_join</span><span class="op">(</span><span class="va">ne_counties</span>, <span class="va">prcp_data</span>, by <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tmieno2\.github\.io\/R-as-GIS-for-Economists\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/04-RasterDataBasics.html" class="pagination-link" aria-label="Raster Data Handling">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb95" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="an">webr:</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="co">  # packages: ['dplyr', 'ggplot2', 'sf']</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="co">  cell-options:</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="co">    editor-font-scale: 0.8</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="co">    out-width: 70%</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="an">filters:</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - webr</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatial Interactions of Vector and Raster Data {#sec-int-RV}</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a><span class="in">```{r , eval = FALSE, echo = FALSE}</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="in">setwd(here::here("chapters"))</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a><span class="co">#--- load packages ---#</span></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(exactextractr)</span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prism)</span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyterra)</span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{r figure_setup}</span></span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a><span class="in">#| include: false</span></span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(</span></span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.title.x = element_text(size = 12, angle = 0, hjust = .5, vjust = -0.3, face = "plain", family = "Times"),</span></span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.title.y = element_text(size = 12, angle = 90, hjust = .5, vjust = .9, face = "plain", family = "Times"),</span></span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text.x = element_text(size = 10, angle = 0, hjust = .5, vjust = 1.5, face = "plain", family = "Times"),</span></span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text.y = element_text(size = 10, angle = 0, hjust = 1, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb95-45"><a href="#cb95-45" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks = element_line(size = 0.3, linetype = "solid"),</span></span>
<span id="cb95-46"><a href="#cb95-46" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.ticks = element_blank(),</span></span>
<span id="cb95-47"><a href="#cb95-47" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks.length = unit(.15, "cm"),</span></span>
<span id="cb95-48"><a href="#cb95-48" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.ticks.margin = unit(.1,'cm'),</span></span>
<span id="cb95-49"><a href="#cb95-49" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.text = element_text(margin=unit(.1,'cm')),</span></span>
<span id="cb95-50"><a href="#cb95-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-51"><a href="#cb95-51" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- legend ---#</span></span>
<span id="cb95-52"><a href="#cb95-52" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.text = element_text(size = 10, angle = 0, hjust = 0, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb95-53"><a href="#cb95-53" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.title = element_text(size = 10, angle = 0, hjust = 0, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb95-54"><a href="#cb95-54" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.key.size = unit(0.5, "cm"),</span></span>
<span id="cb95-55"><a href="#cb95-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-56"><a href="#cb95-56" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- strip (for faceting) ---#</span></span>
<span id="cb95-57"><a href="#cb95-57" aria-hidden="true" tabindex="-1"></a><span class="in">  strip.text = element_text(size = 10, family = "Times"),</span></span>
<span id="cb95-58"><a href="#cb95-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-59"><a href="#cb95-59" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- plot title ---#</span></span>
<span id="cb95-60"><a href="#cb95-60" aria-hidden="true" tabindex="-1"></a><span class="in">  plot.title = element_text(family = "Times", face = "bold", size = 12),</span></span>
<span id="cb95-61"><a href="#cb95-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-62"><a href="#cb95-62" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- margin ---#</span></span>
<span id="cb95-63"><a href="#cb95-63" aria-hidden="true" tabindex="-1"></a><span class="in">  # plot.margin = margin(0, 0, 0, 0, "cm"),</span></span>
<span id="cb95-64"><a href="#cb95-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-65"><a href="#cb95-65" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- panel ---#</span></span>
<span id="cb95-66"><a href="#cb95-66" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.major = element_blank(),</span></span>
<span id="cb95-67"><a href="#cb95-67" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.minor = element_blank(),</span></span>
<span id="cb95-68"><a href="#cb95-68" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.background = element_blank(),</span></span>
<span id="cb95-69"><a href="#cb95-69" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.border = element_rect(fill = NA)</span></span>
<span id="cb95-70"><a href="#cb95-70" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-71"><a href="#cb95-71" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-72"><a href="#cb95-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-73"><a href="#cb95-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ch05-define_theme}</span></span>
<span id="cb95-74"><a href="#cb95-74" aria-hidden="true" tabindex="-1"></a><span class="in">#| include: false</span></span>
<span id="cb95-75"><a href="#cb95-75" aria-hidden="true" tabindex="-1"></a><span class="in">theme_set(theme_bw())</span></span>
<span id="cb95-76"><a href="#cb95-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-77"><a href="#cb95-77" aria-hidden="true" tabindex="-1"></a><span class="in">theme_for_map &lt;- theme(</span></span>
<span id="cb95-78"><a href="#cb95-78" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks = element_blank(),</span></span>
<span id="cb95-79"><a href="#cb95-79" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text = element_blank(),</span></span>
<span id="cb95-80"><a href="#cb95-80" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.line = element_blank(),</span></span>
<span id="cb95-81"><a href="#cb95-81" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.border = element_blank(),</span></span>
<span id="cb95-82"><a href="#cb95-82" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.major = element_line(color = "transparent"),</span></span>
<span id="cb95-83"><a href="#cb95-83" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.minor = element_line(color = "transparent"),</span></span>
<span id="cb95-84"><a href="#cb95-84" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.background = element_blank(),</span></span>
<span id="cb95-85"><a href="#cb95-85" aria-hidden="true" tabindex="-1"></a><span class="in">  plot.background = element_rect(fill = "transparent", color = "transparent")</span></span>
<span id="cb95-86"><a href="#cb95-86" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-87"><a href="#cb95-87" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-88"><a href="#cb95-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-89"><a href="#cb95-89" aria-hidden="true" tabindex="-1"></a><span class="fu">## Before you start {-}</span></span>
<span id="cb95-90"><a href="#cb95-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-91"><a href="#cb95-91" aria-hidden="true" tabindex="-1"></a>In this chapter we learn the spatial interactions of a vector and raster dataset. We first look at how to crop (spatially subset) a raster dataset based on the geographic extent of a vector dataset. We then cover how to extract values from raster data for points and polygons. To be precise, here is what we mean by raster data extraction and what it does for points and polygons data:</span>
<span id="cb95-92"><a href="#cb95-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-93"><a href="#cb95-93" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**Points**: For each of the points, find which raster cell it is located within, and assign the value of the cell to the point.  </span>
<span id="cb95-94"><a href="#cb95-94" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb95-95"><a href="#cb95-95" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**Polygons**: For each of the polygons, identify all the raster cells that intersect with the polygon, and assign a vector of the cell values to the polygon</span>
<span id="cb95-96"><a href="#cb95-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-97"><a href="#cb95-97" aria-hidden="true" tabindex="-1"></a>We will show how we can use <span class="in">`terra::extract()`</span> for both cases. But, we will also see that for polygons, <span class="in">`exactextractr::exact_extract()`</span> from the <span class="in">`exactextractr`</span> package is often considerably faster than <span class="in">`terra::extract()`</span>.</span>
<span id="cb95-98"><a href="#cb95-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-99"><a href="#cb95-99" aria-hidden="true" tabindex="-1"></a>To test your knowledge, you can work on coding exercises at @sec-exercises-int-rv.</span>
<span id="cb95-100"><a href="#cb95-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-101"><a href="#cb95-101" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direction for replication {-}</span></span>
<span id="cb95-102"><a href="#cb95-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-103"><a href="#cb95-103" aria-hidden="true" tabindex="-1"></a>**Datasets**</span>
<span id="cb95-104"><a href="#cb95-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-105"><a href="#cb95-105" aria-hidden="true" tabindex="-1"></a>All the datasets that you need to import are available <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0)</span>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</span>
<span id="cb95-106"><a href="#cb95-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-107"><a href="#cb95-107" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>set a folder (any folder) as the working directory using <span class="in">`setwd()`</span></span>
<span id="cb95-108"><a href="#cb95-108" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>create a folder called "Data" inside the folder designated as the working directory (if you have created a "Data" folder previously, skip this step)</span>
<span id="cb95-109"><a href="#cb95-109" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>download the pertinent datasets from <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0)</span> </span>
<span id="cb95-110"><a href="#cb95-110" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>place all the files in the downloaded folder in the "Data" folder</span>
<span id="cb95-111"><a href="#cb95-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-112"><a href="#cb95-112" aria-hidden="true" tabindex="-1"></a>**Packages**</span>
<span id="cb95-113"><a href="#cb95-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-114"><a href="#cb95-114" aria-hidden="true" tabindex="-1"></a>Run the following code to install or load (if already installed) the <span class="in">`pacman`</span> package, and then install or load (if already installed) the listed package inside the <span class="in">`pacman::p_load()`</span> function.</span>
<span id="cb95-115"><a href="#cb95-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-116"><a href="#cb95-116" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Chap5_packages}</span></span>
<span id="cb95-117"><a href="#cb95-117" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: false</span></span>
<span id="cb95-118"><a href="#cb95-118" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require("pacman")) install.packages("pacman")</span></span>
<span id="cb95-119"><a href="#cb95-119" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(</span></span>
<span id="cb95-120"><a href="#cb95-120" aria-hidden="true" tabindex="-1"></a><span class="in">  terra, # handle raster data</span></span>
<span id="cb95-121"><a href="#cb95-121" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyterra, # handle and visualize raster data</span></span>
<span id="cb95-122"><a href="#cb95-122" aria-hidden="true" tabindex="-1"></a><span class="in">  raster, # handle raster data</span></span>
<span id="cb95-123"><a href="#cb95-123" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr, # fast extractions</span></span>
<span id="cb95-124"><a href="#cb95-124" aria-hidden="true" tabindex="-1"></a><span class="in">  sf, # vector data operations</span></span>
<span id="cb95-125"><a href="#cb95-125" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr, # data wrangling</span></span>
<span id="cb95-126"><a href="#cb95-126" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyr, # data wrangling</span></span>
<span id="cb95-127"><a href="#cb95-127" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table, # data wrangling</span></span>
<span id="cb95-128"><a href="#cb95-128" aria-hidden="true" tabindex="-1"></a><span class="in">  prism, # download PRISM data</span></span>
<span id="cb95-129"><a href="#cb95-129" aria-hidden="true" tabindex="-1"></a><span class="in">  tictoc, # timing codes</span></span>
<span id="cb95-130"><a href="#cb95-130" aria-hidden="true" tabindex="-1"></a><span class="in">  tigris # to get county sf</span></span>
<span id="cb95-131"><a href="#cb95-131" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-132"><a href="#cb95-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-133"><a href="#cb95-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-134"><a href="#cb95-134" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cropping to the Area of Interest {#sec-raster-crop}</span></span>
<span id="cb95-135"><a href="#cb95-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-136"><a href="#cb95-136" aria-hidden="true" tabindex="-1"></a>Here we use PRISM maximum temperature (tmax) data as a raster dataset and Kansas county boundaries as a vector dataset. </span>
<span id="cb95-137"><a href="#cb95-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-138"><a href="#cb95-138" aria-hidden="true" tabindex="-1"></a>Let's download the tmax data for July 1, 2018 (@fig-prism-tmax-map).</span>
<span id="cb95-139"><a href="#cb95-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-140"><a href="#cb95-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prism_download, cache = F, results = "hide"}</span></span>
<span id="cb95-141"><a href="#cb95-141" aria-hidden="true" tabindex="-1"></a><span class="in">#--- set the path to the folder to which you save the downloaded PRISM data ---#</span></span>
<span id="cb95-142"><a href="#cb95-142" aria-hidden="true" tabindex="-1"></a><span class="in"># This code sets the current working directory as the designated folder</span></span>
<span id="cb95-143"><a href="#cb95-143" aria-hidden="true" tabindex="-1"></a><span class="in">options(prism.path = "Data")</span></span>
<span id="cb95-144"><a href="#cb95-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-145"><a href="#cb95-145" aria-hidden="true" tabindex="-1"></a><span class="in">#--- download PRISM precipitation data ---#</span></span>
<span id="cb95-146"><a href="#cb95-146" aria-hidden="true" tabindex="-1"></a><span class="in">prism::get_prism_dailys(</span></span>
<span id="cb95-147"><a href="#cb95-147" aria-hidden="true" tabindex="-1"></a><span class="in">  type = "tmax",</span></span>
<span id="cb95-148"><a href="#cb95-148" aria-hidden="true" tabindex="-1"></a><span class="in">  date = "2018-07-01",</span></span>
<span id="cb95-149"><a href="#cb95-149" aria-hidden="true" tabindex="-1"></a><span class="in">  keepZip = FALSE</span></span>
<span id="cb95-150"><a href="#cb95-150" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-151"><a href="#cb95-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-152"><a href="#cb95-152" aria-hidden="true" tabindex="-1"></a><span class="in">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span id="cb95-153"><a href="#cb95-153" aria-hidden="true" tabindex="-1"></a><span class="in">prism_file &lt;- "Data/PRISM_tmax_stable_4kmD2_20180701_bil/PRISM_tmax_stable_4kmD2_20180701_bil.bil"</span></span>
<span id="cb95-154"><a href="#cb95-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-155"><a href="#cb95-155" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read in the prism data ---#</span></span>
<span id="cb95-156"><a href="#cb95-156" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_0701_sr &lt;- terra::rast(prism_file)</span></span>
<span id="cb95-157"><a href="#cb95-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-158"><a href="#cb95-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-159"><a href="#cb95-159" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb95-162"><a href="#cb95-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-163"><a href="#cb95-163" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-prism-tmax-map</span></span>
<span id="cb95-164"><a href="#cb95-164" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of PRISM tmax data on July 1, 2018"</span></span>
<span id="cb95-165"><a href="#cb95-165" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb95-166"><a href="#cb95-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-167"><a href="#cb95-167" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb95-168"><a href="#cb95-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_spatraster</span>(<span class="at">data =</span> prism_tmax_0701_sr) <span class="sc">+</span></span>
<span id="cb95-169"><a href="#cb95-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_whitebox_c</span>(</span>
<span id="cb95-170"><a href="#cb95-170" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"tmax"</span>,</span>
<span id="cb95-171"><a href="#cb95-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette =</span> <span class="st">"muted"</span>,</span>
<span id="cb95-172"><a href="#cb95-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">suffix =</span> <span class="st">"º"</span>),</span>
<span id="cb95-173"><a href="#cb95-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">12</span>,</span>
<span id="cb95-174"><a href="#cb95-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb95-175"><a href="#cb95-175" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb95-176"><a href="#cb95-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb95-177"><a href="#cb95-177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-178"><a href="#cb95-178" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-179"><a href="#cb95-179" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb95-180"><a href="#cb95-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-181"><a href="#cb95-181" aria-hidden="true" tabindex="-1"></a>We now get Kansas county border data from the <span class="in">`tigris`</span> package (@fig-ks-county-map) as <span class="in">`sf`</span>. </span>
<span id="cb95-182"><a href="#cb95-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-185"><a href="#cb95-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-186"><a href="#cb95-186" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb95-187"><a href="#cb95-187" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: "hide"</span></span>
<span id="cb95-188"><a href="#cb95-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-189"><a href="#cb95-189" aria-hidden="true" tabindex="-1"></a><span class="co">#--- Kansas boundary (sf) ---#</span></span>
<span id="cb95-190"><a href="#cb95-190" aria-hidden="true" tabindex="-1"></a>KS_county_sf <span class="ot">&lt;-</span></span>
<span id="cb95-191"><a href="#cb95-191" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- get Kansas county boundary ---</span></span>
<span id="cb95-192"><a href="#cb95-192" aria-hidden="true" tabindex="-1"></a>  tigris<span class="sc">::</span><span class="fu">counties</span>(<span class="at">state =</span> <span class="st">"Kansas"</span>, <span class="at">cb =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-193"><a href="#cb95-193" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- sp to sf ---#</span></span>
<span id="cb95-194"><a href="#cb95-194" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb95-195"><a href="#cb95-195" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- transform using the CRS of the PRISM tmax data  ---#</span></span>
<span id="cb95-196"><a href="#cb95-196" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(terra<span class="sc">::</span><span class="fu">crs</span>(prism_tmax_0701_sr))</span>
<span id="cb95-197"><a href="#cb95-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-198"><a href="#cb95-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-199"><a href="#cb95-199" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb95-200"><a href="#cb95-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ks-county-map}</span></span>
<span id="cb95-201"><a href="#cb95-201" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-ks-county-map</span></span>
<span id="cb95-202"><a href="#cb95-202" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Kansas county boundaries"</span></span>
<span id="cb95-203"><a href="#cb95-203" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb95-204"><a href="#cb95-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-205"><a href="#cb95-205" aria-hidden="true" tabindex="-1"></a><span class="in">#--- gen map ---#</span></span>
<span id="cb95-206"><a href="#cb95-206" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb95-207"><a href="#cb95-207" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = KS_county_sf, fill = NA, color = "blue") +</span></span>
<span id="cb95-208"><a href="#cb95-208" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void()</span></span>
<span id="cb95-209"><a href="#cb95-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-210"><a href="#cb95-210" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-211"><a href="#cb95-211" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb95-212"><a href="#cb95-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-213"><a href="#cb95-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-214"><a href="#cb95-214" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb95-215"><a href="#cb95-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-216"><a href="#cb95-216" aria-hidden="true" tabindex="-1"></a>Cropping a raster layer to the area of interest can be useful, as it eliminates unnecessary data and reduces processing time. A smaller raster also makes value extraction faster. You can crop a raster layer using <span class="in">`terra::crop()`</span>, as shown below:</span>
<span id="cb95-217"><a href="#cb95-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-218"><a href="#cb95-218" aria-hidden="true" tabindex="-1"></a><span class="in">```{r crop_syntax, eval = FALSE}</span></span>
<span id="cb95-219"><a href="#cb95-219" aria-hidden="true" tabindex="-1"></a><span class="in">#--- syntax (this does not run) ---#</span></span>
<span id="cb95-220"><a href="#cb95-220" aria-hidden="true" tabindex="-1"></a><span class="in">terra::crop(SpatRaster, sf)</span></span>
<span id="cb95-221"><a href="#cb95-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-222"><a href="#cb95-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-223"><a href="#cb95-223" aria-hidden="true" tabindex="-1"></a>So, in this case, this does the job.</span>
<span id="cb95-224"><a href="#cb95-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-225"><a href="#cb95-225" aria-hidden="true" tabindex="-1"></a><span class="in">```{r crop_prism_to_KS, cache = F}</span></span>
<span id="cb95-226"><a href="#cb95-226" aria-hidden="true" tabindex="-1"></a><span class="in">#--- crop the entire PRISM to its KS portion---#</span></span>
<span id="cb95-227"><a href="#cb95-227" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_0701_KS_sr &lt;-</span></span>
<span id="cb95-228"><a href="#cb95-228" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::crop(</span></span>
<span id="cb95-229"><a href="#cb95-229" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_sr,</span></span>
<span id="cb95-230"><a href="#cb95-230" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf</span></span>
<span id="cb95-231"><a href="#cb95-231" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-232"><a href="#cb95-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-233"><a href="#cb95-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-234"><a href="#cb95-234" aria-hidden="true" tabindex="-1"></a>@fig-prism-ks-viz shows the PRISM tmax raster data cropped to the geographic extent of Kansas. Notice that the cropped raster layer extends beyond the outer boundary of Kansas state boundary (it is a bit hard to see, but look at the upper right corner).  </span>
<span id="cb95-235"><a href="#cb95-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-238"><a href="#cb95-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-239"><a href="#cb95-239" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-prism-ks-viz</span></span>
<span id="cb95-240"><a href="#cb95-240" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "PRISM tmax raster data cropped to the geographic extent of Kansas"</span></span>
<span id="cb95-241"><a href="#cb95-241" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb95-242"><a href="#cb95-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-243"><a href="#cb95-243" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb95-244"><a href="#cb95-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_spatraster</span>(<span class="at">data =</span> prism_tmax_0701_KS_sr) <span class="sc">+</span></span>
<span id="cb95-245"><a href="#cb95-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_county_sf, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb95-246"><a href="#cb95-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_whitebox_c</span>(</span>
<span id="cb95-247"><a href="#cb95-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"tmax"</span>,</span>
<span id="cb95-248"><a href="#cb95-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette =</span> <span class="st">"muted"</span>,</span>
<span id="cb95-249"><a href="#cb95-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">suffix =</span> <span class="st">"º"</span>),</span>
<span id="cb95-250"><a href="#cb95-250" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.breaks =</span> <span class="dv">12</span>,</span>
<span id="cb95-251"><a href="#cb95-251" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb95-252"><a href="#cb95-252" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb95-253"><a href="#cb95-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb95-254"><a href="#cb95-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-255"><a href="#cb95-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-256"><a href="#cb95-256" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extracting Values from Raster Layers for Vector Data {#sec-extract-raster-to-vector}</span></span>
<span id="cb95-257"><a href="#cb95-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-258"><a href="#cb95-258" aria-hidden="true" tabindex="-1"></a>In this section, we will learn how to extract information from raster layers for spatial units represented as vector data (points and polygons). For the demonstrations in this section, we use the following datasets:</span>
<span id="cb95-259"><a href="#cb95-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-260"><a href="#cb95-260" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Raster: PRISM tmax data cropped to Kansas state border for 07/01/2018 (obtained in @sec-raster-crop) and 07/02/2018 (downloaded below)</span>
<span id="cb95-261"><a href="#cb95-261" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Polygons: Kansas county boundaries (obtained in @sec-raster-crop)</span>
<span id="cb95-262"><a href="#cb95-262" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Points: Irrigation wells in Kansas (imported below) </span>
<span id="cb95-263"><a href="#cb95-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-264"><a href="#cb95-264" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simple visual illustrations of raster data extraction</span></span>
<span id="cb95-265"><a href="#cb95-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-266"><a href="#cb95-266" aria-hidden="true" tabindex="-1"></a>**Extracting to Points**</span>
<span id="cb95-267"><a href="#cb95-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-268"><a href="#cb95-268" aria-hidden="true" tabindex="-1"></a>@fig-illustrate-points shows visually what we mean by "extract raster values to points."</span>
<span id="cb95-269"><a href="#cb95-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-272"><a href="#cb95-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-273"><a href="#cb95-273" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-illustrate-points</span></span>
<span id="cb95-274"><a href="#cb95-274" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visual illustration of raster data extraction for points data"</span></span>
<span id="cb95-275"><a href="#cb95-275" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb95-276"><a href="#cb95-276" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">378533</span>)</span>
<span id="cb95-277"><a href="#cb95-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-278"><a href="#cb95-278" aria-hidden="true" tabindex="-1"></a><span class="co">#--- create polygons ---#</span></span>
<span id="cb95-279"><a href="#cb95-279" aria-hidden="true" tabindex="-1"></a>polygon <span class="ot">&lt;-</span></span>
<span id="cb95-280"><a href="#cb95-280" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_polygon</span>(<span class="fu">list</span>(</span>
<span id="cb95-281"><a href="#cb95-281" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">8</span>), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">8</span>), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb95-282"><a href="#cb95-282" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb95-283"><a href="#cb95-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-284"><a href="#cb95-284" aria-hidden="true" tabindex="-1"></a>raster_like_cells <span class="ot">&lt;-</span></span>
<span id="cb95-285"><a href="#cb95-285" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_grid</span>(polygon, <span class="at">n =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">8</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb95-286"><a href="#cb95-286" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb95-287"><a href="#cb95-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">64</span>, <span class="dv">64</span>))</span>
<span id="cb95-288"><a href="#cb95-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-289"><a href="#cb95-289" aria-hidden="true" tabindex="-1"></a>stars_cells <span class="ot">&lt;-</span></span>
<span id="cb95-290"><a href="#cb95-290" aria-hidden="true" tabindex="-1"></a>  stars<span class="sc">::</span><span class="fu">st_rasterize</span>(raster_like_cells, <span class="at">nx =</span> <span class="dv">8</span>, <span class="at">ny =</span> <span class="dv">8</span>)</span>
<span id="cb95-291"><a href="#cb95-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-292"><a href="#cb95-292" aria-hidden="true" tabindex="-1"></a>cell_centroids <span class="ot">&lt;-</span></span>
<span id="cb95-293"><a href="#cb95-293" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_centroid</span>(raster_like_cells) <span class="sc">%&gt;%</span></span>
<span id="cb95-294"><a href="#cb95-294" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>()</span>
<span id="cb95-295"><a href="#cb95-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-296"><a href="#cb95-296" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb95-297"><a href="#cb95-297" aria-hidden="true" tabindex="-1"></a><span class="co"># Create points for which values are extracted</span></span>
<span id="cb95-298"><a href="#cb95-298" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb95-299"><a href="#cb95-299" aria-hidden="true" tabindex="-1"></a><span class="co">#--- points ---#</span></span>
<span id="cb95-300"><a href="#cb95-300" aria-hidden="true" tabindex="-1"></a>point_1 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">2.4</span>, <span class="fl">2.2</span>))</span>
<span id="cb95-301"><a href="#cb95-301" aria-hidden="true" tabindex="-1"></a>point_2 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">6.7</span>, <span class="fl">1.8</span>))</span>
<span id="cb95-302"><a href="#cb95-302" aria-hidden="true" tabindex="-1"></a>point_3 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">4.2</span>, <span class="fl">7.1</span>))</span>
<span id="cb95-303"><a href="#cb95-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-304"><a href="#cb95-304" aria-hidden="true" tabindex="-1"></a><span class="co">#--- combine the points to make a single  sf of points ---#</span></span>
<span id="cb95-305"><a href="#cb95-305" aria-hidden="true" tabindex="-1"></a>points <span class="ot">&lt;-</span> <span class="fu">list</span>(point_1, point_2, point_3) <span class="sc">%&gt;%</span></span>
<span id="cb95-306"><a href="#cb95-306" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_sfc</span>() <span class="sc">%&gt;%</span></span>
<span id="cb95-307"><a href="#cb95-307" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb95-308"><a href="#cb95-308" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">point_name =</span> <span class="fu">c</span>(<span class="st">"Point 1"</span>, <span class="st">"Point 2"</span>, <span class="st">"Point 3"</span>))</span>
<span id="cb95-309"><a href="#cb95-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-310"><a href="#cb95-310" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb95-311"><a href="#cb95-311" aria-hidden="true" tabindex="-1"></a><span class="co"># Create maps</span></span>
<span id="cb95-312"><a href="#cb95-312" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb95-313"><a href="#cb95-313" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb95-314"><a href="#cb95-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> stars_cells, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb95-315"><a href="#cb95-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">name =</span> <span class="st">"Value"</span>, <span class="at">palette =</span> <span class="st">"Spectral"</span>) <span class="sc">+</span></span>
<span id="cb95-316"><a href="#cb95-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> raster_like_cells, <span class="fu">aes</span>(<span class="at">label =</span> value)) <span class="sc">+</span></span>
<span id="cb95-317"><a href="#cb95-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> points, <span class="fu">aes</span>(<span class="at">shape =</span> point_name), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb95-318"><a href="#cb95-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape</span>(<span class="at">name =</span> <span class="st">"Points"</span>) <span class="sc">+</span></span>
<span id="cb95-319"><a href="#cb95-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb95-320"><a href="#cb95-320" aria-hidden="true" tabindex="-1"></a>  theme_for_map</span>
<span id="cb95-321"><a href="#cb95-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-322"><a href="#cb95-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-323"><a href="#cb95-323" aria-hidden="true" tabindex="-1"></a>In the figure, we have grids (cells) and each grid holds a value (presented at the center). There are three points. We will find which grid the points fall inside and get the associated values and assign them to the points. In this example, Points 1, 2, and 3 will have 50, 4, 54, respectively,</span>
<span id="cb95-324"><a href="#cb95-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-325"><a href="#cb95-325" aria-hidden="true" tabindex="-1"></a>**Extracting to Polygons**</span>
<span id="cb95-326"><a href="#cb95-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-327"><a href="#cb95-327" aria-hidden="true" tabindex="-1"></a>@fig-polygons-extact-viz shows visually what we mean by "extract raster values to polygons."</span>
<span id="cb95-328"><a href="#cb95-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-331"><a href="#cb95-331" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-332"><a href="#cb95-332" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb95-333"><a href="#cb95-333" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-polygons-extact-viz</span></span>
<span id="cb95-334"><a href="#cb95-334" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visual illustration of raster data extraction for polygons data" </span></span>
<span id="cb95-335"><a href="#cb95-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-336"><a href="#cb95-336" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb95-337"><a href="#cb95-337" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a polygon for which values are extracted</span></span>
<span id="cb95-338"><a href="#cb95-338" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb95-339"><a href="#cb95-339" aria-hidden="true" tabindex="-1"></a>polygon_extract <span class="ot">&lt;-</span></span>
<span id="cb95-340"><a href="#cb95-340" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_polygon</span>(<span class="fu">list</span>(</span>
<span id="cb95-341"><a href="#cb95-341" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="fl">1.5</span>, <span class="dv">2</span>), <span class="fu">c</span>(<span class="dv">6</span>, <span class="fl">2.3</span>), <span class="fu">c</span>(<span class="dv">7</span>, <span class="fl">6.5</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>), <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="dv">2</span>))</span>
<span id="cb95-342"><a href="#cb95-342" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb95-343"><a href="#cb95-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-344"><a href="#cb95-344" aria-hidden="true" tabindex="-1"></a>polygons_extract_viz <span class="ot">&lt;-</span></span>
<span id="cb95-345"><a href="#cb95-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb95-346"><a href="#cb95-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> stars_cells, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb95-347"><a href="#cb95-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">name =</span> <span class="st">"Value"</span>, <span class="at">palette =</span> <span class="st">"Spectral"</span>) <span class="sc">+</span></span>
<span id="cb95-348"><a href="#cb95-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygon_extract, <span class="at">fill =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb95-349"><a href="#cb95-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> cell_centroids, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb95-350"><a href="#cb95-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(</span>
<span id="cb95-351"><a href="#cb95-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> raster_like_cells, </span>
<span id="cb95-352"><a href="#cb95-352" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> value),</span>
<span id="cb95-353"><a href="#cb95-353" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="sc">-</span><span class="fl">0.25</span>,</span>
<span id="cb95-354"><a href="#cb95-354" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="fl">0.25</span></span>
<span id="cb95-355"><a href="#cb95-355" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb95-356"><a href="#cb95-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb95-357"><a href="#cb95-357" aria-hidden="true" tabindex="-1"></a>  theme_for_map</span>
<span id="cb95-358"><a href="#cb95-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-359"><a href="#cb95-359" aria-hidden="true" tabindex="-1"></a>polygons_extract_viz</span>
<span id="cb95-360"><a href="#cb95-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-361"><a href="#cb95-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-362"><a href="#cb95-362" aria-hidden="true" tabindex="-1"></a>There is a polygon overlaid on top of the cells along with their centroids represented by black dots. Extracting raster values to a polygon means finding raster cells that intersect with the polygons and get the value of all those cells and assigns them to the polygon. As you can see some cells are completely inside the polygon, while others are only partially overlapping with the polygon. Depending on the function you use and its options, you regard different cells as being spatially related to the polygons. For example, by default, <span class="in">`terra::extract()`</span> will extract only the cells whose centroid is inside the polygon. But, you can add an option to include the cells that are only partially intersected with the polygon. In such a case, you can also get the fraction of the cell what is overlapped with the polygon, which enables us to find area-weighted values later. We will discuss the details these below.</span>
<span id="cb95-363"><a href="#cb95-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-364"><a href="#cb95-364" aria-hidden="true" tabindex="-1"></a>**PRISM tmax data for 07/02/2018**</span>
<span id="cb95-365"><a href="#cb95-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-366"><a href="#cb95-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{r download_07022018, cache = F, results = "hide"}</span></span>
<span id="cb95-367"><a href="#cb95-367" aria-hidden="true" tabindex="-1"></a><span class="in">#--- download PRISM precipitation data ---#</span></span>
<span id="cb95-368"><a href="#cb95-368" aria-hidden="true" tabindex="-1"></a><span class="in">prism::get_prism_dailys(</span></span>
<span id="cb95-369"><a href="#cb95-369" aria-hidden="true" tabindex="-1"></a><span class="in">  type = "tmax",</span></span>
<span id="cb95-370"><a href="#cb95-370" aria-hidden="true" tabindex="-1"></a><span class="in">  date = "2018-07-02",</span></span>
<span id="cb95-371"><a href="#cb95-371" aria-hidden="true" tabindex="-1"></a><span class="in">  keepZip = FALSE</span></span>
<span id="cb95-372"><a href="#cb95-372" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-373"><a href="#cb95-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-374"><a href="#cb95-374" aria-hidden="true" tabindex="-1"></a><span class="in">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span id="cb95-375"><a href="#cb95-375" aria-hidden="true" tabindex="-1"></a><span class="in">prism_file &lt;- "Data/PRISM_tmax_stable_4kmD2_20180702_bil/PRISM_tmax_stable_4kmD2_20180702_bil.bil"</span></span>
<span id="cb95-376"><a href="#cb95-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-377"><a href="#cb95-377" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read in the prism data and crop it to Kansas state border ---#</span></span>
<span id="cb95-378"><a href="#cb95-378" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_0702_KS_sr &lt;-</span></span>
<span id="cb95-379"><a href="#cb95-379" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::rast(prism_file) %&gt;%</span></span>
<span id="cb95-380"><a href="#cb95-380" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::crop(KS_county_sf)</span></span>
<span id="cb95-381"><a href="#cb95-381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-382"><a href="#cb95-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-383"><a href="#cb95-383" aria-hidden="true" tabindex="-1"></a>**Irrigation wells in Kansas:**</span>
<span id="cb95-384"><a href="#cb95-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-385"><a href="#cb95-385" aria-hidden="true" tabindex="-1"></a><span class="in">```{r import_KS_wells}</span></span>
<span id="cb95-386"><a href="#cb95-386" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read in the KS points data ---#</span></span>
<span id="cb95-387"><a href="#cb95-387" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb95-388"><a href="#cb95-388" aria-hidden="true" tabindex="-1"></a><span class="in">  KS_wells &lt;- readRDS("Data/Chap_5_wells_KS.rds")</span></span>
<span id="cb95-389"><a href="#cb95-389" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-390"><a href="#cb95-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-391"><a href="#cb95-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-392"><a href="#cb95-392" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb95-393"><a href="#cb95-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-394"><a href="#cb95-394" aria-hidden="true" tabindex="-1"></a>Here is how the wells are spatially distributed over the PRISM grids and Kansas county borders (@fig-tmax-prism-wells):</span>
<span id="cb95-395"><a href="#cb95-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-398"><a href="#cb95-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-399"><a href="#cb95-399" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb95-400"><a href="#cb95-400" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of Kansas county borders, irrigation wells, and PRISM tmax" </span></span>
<span id="cb95-401"><a href="#cb95-401" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tmax-prism-wells</span></span>
<span id="cb95-402"><a href="#cb95-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-403"><a href="#cb95-403" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()  <span class="sc">+</span></span>
<span id="cb95-404"><a href="#cb95-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_county_sf, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb95-405"><a href="#cb95-405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells, <span class="at">size =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb95-406"><a href="#cb95-406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb95-407"><a href="#cb95-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-408"><a href="#cb95-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-409"><a href="#cb95-409" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting to Points</span></span>
<span id="cb95-410"><a href="#cb95-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-411"><a href="#cb95-411" aria-hidden="true" tabindex="-1"></a>You can extract values from raster layers to points using <span class="in">`terra::extract()`</span>. <span class="in">`terra::extract()`</span> finds which raster cell each of the points is located within and assigns the value of the cell to the point. </span>
<span id="cb95-412"><a href="#cb95-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-413"><a href="#cb95-413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = F}</span></span>
<span id="cb95-414"><a href="#cb95-414" aria-hidden="true" tabindex="-1"></a><span class="in">#--- syntax (this does not run) ---#</span></span>
<span id="cb95-415"><a href="#cb95-415" aria-hidden="true" tabindex="-1"></a><span class="in">terra::extract(raster, points)</span></span>
<span id="cb95-416"><a href="#cb95-416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-417"><a href="#cb95-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-418"><a href="#cb95-418" aria-hidden="true" tabindex="-1"></a>The <span class="in">`points`</span> objects can be either <span class="in">`sf`</span> or <span class="in">`SpatVect`</span>^<span class="co">[</span><span class="ot">`terra::extract` used to accept only `SpatVect` and the `sf` objects had to be converted to a `SpatVect` using `terra::vect()`</span><span class="co">]</span>. </span>
<span id="cb95-419"><a href="#cb95-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-420"><a href="#cb95-420" aria-hidden="true" tabindex="-1"></a>Let's extract <span class="in">`tmax`</span> values from the PRISM tmax layer (<span class="in">`prism_tmax_0701_KS_sr`</span>) to the irrigation wells (<span class="in">`KS_wells`</span> as <span class="in">`sf`</span>):</span>
<span id="cb95-421"><a href="#cb95-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-424"><a href="#cb95-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-425"><a href="#cb95-425" aria-hidden="true" tabindex="-1"></a>tmax_from_prism <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(prism_tmax_0701_KS_sr, KS_wells)</span>
<span id="cb95-426"><a href="#cb95-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-427"><a href="#cb95-427" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tmax_from_prism)</span>
<span id="cb95-428"><a href="#cb95-428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-429"><a href="#cb95-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-430"><a href="#cb95-430" aria-hidden="true" tabindex="-1"></a>The resulting object is a <span class="in">`data.frame`</span>, where the <span class="in">`ID`</span> variable represents the order of the observations in the points data and the second column represents that values extracted for the points from the raster cells. So, you can assign the extracted values as a new variable of the points data as follows: </span>
<span id="cb95-431"><a href="#cb95-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-434"><a href="#cb95-434" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-435"><a href="#cb95-435" aria-hidden="true" tabindex="-1"></a>KS_wells<span class="sc">$</span>tmax_07_01 <span class="ot">&lt;-</span> tmax_from_prism[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb95-436"><a href="#cb95-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span>   </span>
<span id="cb95-437"><a href="#cb95-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-438"><a href="#cb95-438" aria-hidden="true" tabindex="-1"></a>Extracting values from a multi-layer <span class="in">`SpatRaster`</span> works the same way. Here, we combine <span class="in">`prism_tmax_0701_KS_sr`</span> and <span class="in">`prism_tmax_0702_KS_sr`</span> to create a multi-layer <span class="in">`SpatRaster`</span> and then extract values from them.</span>
<span id="cb95-439"><a href="#cb95-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-440"><a href="#cb95-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract_tmax_run_stack}</span></span>
<span id="cb95-441"><a href="#cb95-441" aria-hidden="true" tabindex="-1"></a><span class="in">#--- create a multi-layer SpatRaster ---#</span></span>
<span id="cb95-442"><a href="#cb95-442" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_stack &lt;- c(prism_tmax_0701_KS_sr, prism_tmax_0702_KS_sr)</span></span>
<span id="cb95-443"><a href="#cb95-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-444"><a href="#cb95-444" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract tmax values ---#</span></span>
<span id="cb95-445"><a href="#cb95-445" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_from_prism_stack &lt;- terra::extract(prism_tmax_stack, KS_wells)</span></span>
<span id="cb95-446"><a href="#cb95-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-447"><a href="#cb95-447" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb95-448"><a href="#cb95-448" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_from_prism_stack)</span></span>
<span id="cb95-449"><a href="#cb95-449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-450"><a href="#cb95-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-451"><a href="#cb95-451" aria-hidden="true" tabindex="-1"></a>We now have two columns that hold values extracted from the raster cells: the 2nd column for the 1st raster layer and the 3rd column for the 2nd raster layer in <span class="in">`prism_tmax_stack`</span>.</span>
<span id="cb95-452"><a href="#cb95-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-453"><a href="#cb95-453" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting to Polygons (`terra` way)</span></span>
<span id="cb95-454"><a href="#cb95-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-455"><a href="#cb95-455" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`terra::extract()`</span> for extracting raster cell values for polygons as well. For each of the polygons, it will identify all the raster cells whose center lies inside the polygon and assign the vector of values of the cells to the polygon. </span>
<span id="cb95-456"><a href="#cb95-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-457"><a href="#cb95-457" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract from a single-layer `SpatRaster`</span></span>
<span id="cb95-458"><a href="#cb95-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-459"><a href="#cb95-459" aria-hidden="true" tabindex="-1"></a>Let's extract <span class="in">`tmax`</span> values from <span class="in">`prism_tmax_0701_KS_sr`</span> for each of the KS counties.</span>
<span id="cb95-460"><a href="#cb95-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-461"><a href="#cb95-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra-extract-polygon, eval = F}</span></span>
<span id="cb95-462"><a href="#cb95-462" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract values from the raster for each county ---#</span></span>
<span id="cb95-463"><a href="#cb95-463" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;- terra::extract(prism_tmax_0701_KS_sr, KS_county_sf)</span></span>
<span id="cb95-464"><a href="#cb95-464" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-465"><a href="#cb95-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-466"><a href="#cb95-466" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra-extract-polygon-show, echo = F}</span></span>
<span id="cb95-467"><a href="#cb95-467" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(tmax_by_county, "Data/tmax-by-county-terra.rds")</span></span>
<span id="cb95-468"><a href="#cb95-468" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;- readRDS("Data/tmax-by-county-terra.rds")</span></span>
<span id="cb95-469"><a href="#cb95-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-470"><a href="#cb95-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-471"><a href="#cb95-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r check-the-extracted-values}</span></span>
<span id="cb95-472"><a href="#cb95-472" aria-hidden="true" tabindex="-1"></a><span class="in">#--- check the class ---#</span></span>
<span id="cb95-473"><a href="#cb95-473" aria-hidden="true" tabindex="-1"></a><span class="in">class(tmax_by_county)</span></span>
<span id="cb95-474"><a href="#cb95-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-475"><a href="#cb95-475" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb95-476"><a href="#cb95-476" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_by_county)</span></span>
<span id="cb95-477"><a href="#cb95-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-478"><a href="#cb95-478" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb95-479"><a href="#cb95-479" aria-hidden="true" tabindex="-1"></a><span class="in">tail(tmax_by_county)</span></span>
<span id="cb95-480"><a href="#cb95-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-481"><a href="#cb95-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-482"><a href="#cb95-482" aria-hidden="true" tabindex="-1"></a>So, <span class="in">`terra::extract()`</span> returns a <span class="in">`data.frame`</span>, where <span class="in">`ID`</span> values represent the corresponding row number in the polygons data. For example, the observations with <span class="in">`ID == n`</span> are for the **n**th polygon. Using this information, you can easily merge the extraction results to the polygons data. Suppose you are interested in the mean of the <span class="in">`tmax`</span> values of the intersecting cells for each of the polygons, then you can do the following:</span>
<span id="cb95-483"><a href="#cb95-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-484"><a href="#cb95-484" aria-hidden="true" tabindex="-1"></a><span class="in">```{r c05-mean-merge}</span></span>
<span id="cb95-485"><a href="#cb95-485" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get mean tmax ---#</span></span>
<span id="cb95-486"><a href="#cb95-486" aria-hidden="true" tabindex="-1"></a><span class="in">mean_tmax &lt;-</span></span>
<span id="cb95-487"><a href="#cb95-487" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_by_county %&gt;%</span></span>
<span id="cb95-488"><a href="#cb95-488" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(ID) %&gt;%</span></span>
<span id="cb95-489"><a href="#cb95-489" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(tmax = mean(PRISM_tmax_stable_4kmD2_20180701_bil))</span></span>
<span id="cb95-490"><a href="#cb95-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-491"><a href="#cb95-491" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb95-492"><a href="#cb95-492" aria-hidden="true" tabindex="-1"></a><span class="in">  KS_county_sf &lt;-</span></span>
<span id="cb95-493"><a href="#cb95-493" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- back to sf ---#</span></span>
<span id="cb95-494"><a href="#cb95-494" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf %&gt;%</span></span>
<span id="cb95-495"><a href="#cb95-495" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- define ID ---#</span></span>
<span id="cb95-496"><a href="#cb95-496" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(ID := seq_len(nrow(.))) %&gt;%</span></span>
<span id="cb95-497"><a href="#cb95-497" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- merge by ID ---#</span></span>
<span id="cb95-498"><a href="#cb95-498" aria-hidden="true" tabindex="-1"></a><span class="in">    left_join(., mean_tmax, by = "ID")</span></span>
<span id="cb95-499"><a href="#cb95-499" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-500"><a href="#cb95-500" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-501"><a href="#cb95-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-502"><a href="#cb95-502" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract and summarize in one step</span></span>
<span id="cb95-503"><a href="#cb95-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-504"><a href="#cb95-504" aria-hidden="true" tabindex="-1"></a>Instead of finding the mean after applying <span class="in">`terra::extract()`</span> as done above, you can do that within <span class="in">`terra::extract()`</span> using the <span class="in">`fun`</span> option. </span>
<span id="cb95-505"><a href="#cb95-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-506"><a href="#cb95-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra-extract-polygon-mean, eval = F}</span></span>
<span id="cb95-507"><a href="#cb95-507" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract values from the raster for each county ---#</span></span>
<span id="cb95-508"><a href="#cb95-508" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;-</span></span>
<span id="cb95-509"><a href="#cb95-509" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb95-510"><a href="#cb95-510" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr,</span></span>
<span id="cb95-511"><a href="#cb95-511" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb95-512"><a href="#cb95-512" aria-hidden="true" tabindex="-1"></a><span class="in">    fun = mean</span></span>
<span id="cb95-513"><a href="#cb95-513" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-514"><a href="#cb95-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-515"><a href="#cb95-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-516"><a href="#cb95-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra-extract-polygon-mean-show, echo = F}</span></span>
<span id="cb95-517"><a href="#cb95-517" aria-hidden="true" tabindex="-1"></a><span class="in"># saveRDS(tmax_by_county, "Data/tmax-by-county-mean.rds")</span></span>
<span id="cb95-518"><a href="#cb95-518" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;- readRDS("Data/tmax-by-county-mean.rds")</span></span>
<span id="cb95-519"><a href="#cb95-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-520"><a href="#cb95-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-521"><a href="#cb95-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r take-a-look-e-polygons-sum}</span></span>
<span id="cb95-522"><a href="#cb95-522" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb95-523"><a href="#cb95-523" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_by_county)</span></span>
<span id="cb95-524"><a href="#cb95-524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-525"><a href="#cb95-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-526"><a href="#cb95-526" aria-hidden="true" tabindex="-1"></a>You can apply other summary functions like <span class="in">`min()`</span>, <span class="in">`max()`</span>, <span class="in">`sum()`</span>.</span>
<span id="cb95-527"><a href="#cb95-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-528"><a href="#cb95-528" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract from multi-layer `SpatRaster`</span></span>
<span id="cb95-529"><a href="#cb95-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-530"><a href="#cb95-530" aria-hidden="true" tabindex="-1"></a>Extracting values from a multi-layer raster data works exactly the same way except that data processing after the value extraction is slightly more complicated. </span>
<span id="cb95-531"><a href="#cb95-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-532"><a href="#cb95-532" aria-hidden="true" tabindex="-1"></a><span class="in">```{r terra_exatrac_from_stack_run}</span></span>
<span id="cb95-533"><a href="#cb95-533" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from a multi-layer raster object ---#</span></span>
<span id="cb95-534"><a href="#cb95-534" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_from_stack &lt;-</span></span>
<span id="cb95-535"><a href="#cb95-535" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb95-536"><a href="#cb95-536" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack,</span></span>
<span id="cb95-537"><a href="#cb95-537" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf</span></span>
<span id="cb95-538"><a href="#cb95-538" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-539"><a href="#cb95-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-540"><a href="#cb95-540" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb95-541"><a href="#cb95-541" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_by_county_from_stack)</span></span>
<span id="cb95-542"><a href="#cb95-542" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-543"><a href="#cb95-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-544"><a href="#cb95-544" aria-hidden="true" tabindex="-1"></a>Similar to the single-layer case, the resulting object is a <span class="in">`data.frame`</span> and you have two columns corresponding to each of the layers in the two-layer raster object. </span>
<span id="cb95-545"><a href="#cb95-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-546"><a href="#cb95-546" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `exact = TRUE` option</span></span>
<span id="cb95-547"><a href="#cb95-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-548"><a href="#cb95-548" aria-hidden="true" tabindex="-1"></a>Sometimes, you would like to have how much of the raster cells are intersecting with the intersecting polygon to find area-weighted summary later. In that case, you can add <span class="in">`exact = TRUE`</span> option to <span class="in">`terra::extract()`</span>.</span>
<span id="cb95-549"><a href="#cb95-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-550"><a href="#cb95-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-with-weights}</span></span>
<span id="cb95-551"><a href="#cb95-551" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from a multi-layer raster object ---#</span></span>
<span id="cb95-552"><a href="#cb95-552" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_from_stack &lt;-</span></span>
<span id="cb95-553"><a href="#cb95-553" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb95-554"><a href="#cb95-554" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack,</span></span>
<span id="cb95-555"><a href="#cb95-555" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb95-556"><a href="#cb95-556" aria-hidden="true" tabindex="-1"></a><span class="in">    exact = TRUE</span></span>
<span id="cb95-557"><a href="#cb95-557" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-558"><a href="#cb95-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-559"><a href="#cb95-559" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb95-560"><a href="#cb95-560" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_by_county_from_stack)</span></span>
<span id="cb95-561"><a href="#cb95-561" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-562"><a href="#cb95-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-563"><a href="#cb95-563" aria-hidden="true" tabindex="-1"></a>As you can see, now you have <span class="in">`fraction`</span> column to the resulting <span class="in">`data.frame`</span> and you can find area-weighted summary of the extracted values like this:</span>
<span id="cb95-564"><a href="#cb95-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-565"><a href="#cb95-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r area-weighted-extract}</span></span>
<span id="cb95-566"><a href="#cb95-566" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_from_stack %&gt;%</span></span>
<span id="cb95-567"><a href="#cb95-567" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(ID) %&gt;%</span></span>
<span id="cb95-568"><a href="#cb95-568" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(</span></span>
<span id="cb95-569"><a href="#cb95-569" aria-hidden="true" tabindex="-1"></a><span class="in">    tmax_0701 = sum(fraction * PRISM_tmax_stable_4kmD2_20180701_bil) / sum(fraction),</span></span>
<span id="cb95-570"><a href="#cb95-570" aria-hidden="true" tabindex="-1"></a><span class="in">    tmax_0702 = sum(fraction * PRISM_tmax_stable_4kmD2_20180702_bil) / sum(fraction)</span></span>
<span id="cb95-571"><a href="#cb95-571" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-572"><a href="#cb95-572" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-573"><a href="#cb95-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-574"><a href="#cb95-574" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting to Polygons (`exactextractr` way) {#sec-exactextractr}</span></span>
<span id="cb95-575"><a href="#cb95-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-576"><a href="#cb95-576" aria-hidden="true" tabindex="-1"></a><span class="in">`exactextractr::exact_extract()`</span> function from the <span class="in">`exactextractr`</span> package is a faster alternative than <span class="in">`terra::extract()`</span> for a large raster data as we confirm later (<span class="in">`exactextractr::exact_extract()`</span> does not work with points data at the moment).^<span class="co">[</span><span class="ot">See [here](https://github.com/isciences/exactextract) for how it does extraction tasks differently from other major GIS software.</span><span class="co">]</span> <span class="in">`exactextractr::exact_extract()`</span> also provides a coverage fraction value for each of the cell-polygon intersections. The syntax of <span class="in">`exactextractr::exact_extract()`</span> is very much similar to <span class="in">`terra::extract()`</span>. </span>
<span id="cb95-577"><a href="#cb95-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-578"><a href="#cb95-578" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = FALSE}</span></span>
<span id="cb95-579"><a href="#cb95-579" aria-hidden="true" tabindex="-1"></a><span class="in">#--- syntax (this does not run) ---#</span></span>
<span id="cb95-580"><a href="#cb95-580" aria-hidden="true" tabindex="-1"></a><span class="in">exactextractr::exact_extract(raster, polygons sf, include_cols = list of vars)</span></span>
<span id="cb95-581"><a href="#cb95-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-582"><a href="#cb95-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-583"><a href="#cb95-583" aria-hidden="true" tabindex="-1"></a>A notable difference and advantage of <span class="in">`exactextractr::exact_extract()`</span> is that you can specify a list of variables from the polygons <span class="in">`sf`</span> to be inherited to the output. This means that we do not have to merge the output with the polygons <span class="in">`sf`</span> using the rule that the **n**th element of the output corresponds to the **n**th row of polygons <span class="in">`sf`</span> unlike the <span class="in">`terra::extract()`</span> way. <span class="in">`exactextractr::exact_extract()`</span> can accept both <span class="in">`SpatRaster`</span> and <span class="in">`Raster`</span>$^*$ objects as the raster object. However, while it accepts <span class="in">`sf`</span> as the polygons object, but it does not accept <span class="in">`SpatVect`</span>. </span>
<span id="cb95-584"><a href="#cb95-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-585"><a href="#cb95-585" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract from a single-layer `SpatRaster`</span></span>
<span id="cb95-586"><a href="#cb95-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-587"><a href="#cb95-587" aria-hidden="true" tabindex="-1"></a>Let's get <span class="in">`tmax`</span> values from the PRISM raster layer for Kansas county polygons, the following does the job: </span>
<span id="cb95-588"><a href="#cb95-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-589"><a href="#cb95-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{r exact_extract}</span></span>
<span id="cb95-590"><a href="#cb95-590" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract values from the raster for each county ---#</span></span>
<span id="cb95-591"><a href="#cb95-591" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county &lt;-</span></span>
<span id="cb95-592"><a href="#cb95-592" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb95-593"><a href="#cb95-593" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr,</span></span>
<span id="cb95-594"><a href="#cb95-594" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb95-595"><a href="#cb95-595" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- inherit COUNTYFP from KS_county_sf ---#</span></span>
<span id="cb95-596"><a href="#cb95-596" aria-hidden="true" tabindex="-1"></a><span class="in">    include_cols = "COUNTYFP",</span></span>
<span id="cb95-597"><a href="#cb95-597" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- this is for not displaying progress bar ---#</span></span>
<span id="cb95-598"><a href="#cb95-598" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb95-599"><a href="#cb95-599" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-600"><a href="#cb95-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-601"><a href="#cb95-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-602"><a href="#cb95-602" aria-hidden="true" tabindex="-1"></a>The resulting object is a list of <span class="in">`data.frame`</span>s.</span>
<span id="cb95-603"><a href="#cb95-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-604"><a href="#cb95-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show_the_results}</span></span>
<span id="cb95-605"><a href="#cb95-605" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look at the first 6 rows of the first two list elements ---#</span></span>
<span id="cb95-606"><a href="#cb95-606" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county[1:2] %&gt;% lapply(function(x) head(x))</span></span>
<span id="cb95-607"><a href="#cb95-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-608"><a href="#cb95-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-609"><a href="#cb95-609" aria-hidden="true" tabindex="-1"></a>For each element of the list, you see <span class="in">`value`</span> and <span class="in">`coverage_fraction`</span>. <span class="in">`value`</span> is the <span class="in">`tmax`</span> value of the intersecting raster cells, and <span class="in">`coverage_fraction`</span> is the fraction of the intersecting area relative to the full raster grid, which can help find coverage-weighted summary of the extracted values (like <span class="in">`fraction`</span> variable when you use <span class="in">`terra::extract()`</span> with <span class="in">`exact = TRUE`</span>). </span>
<span id="cb95-610"><a href="#cb95-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-611"><a href="#cb95-611" aria-hidden="true" tabindex="-1"></a>We can take advantage of <span class="in">`dplyr::bind_rows()`</span> to combine the list of the datasets into a single <span class="in">`data.frame`</span>.</span>
<span id="cb95-612"><a href="#cb95-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-613"><a href="#cb95-613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r combine_after_ee, cache = F}</span></span>
<span id="cb95-614"><a href="#cb95-614" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb95-615"><a href="#cb95-615" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- combine ---#</span></span>
<span id="cb95-616"><a href="#cb95-616" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_combined &lt;- </span></span>
<span id="cb95-617"><a href="#cb95-617" aria-hidden="true" tabindex="-1"></a><span class="in">    tmax_by_county %&gt;%</span></span>
<span id="cb95-618"><a href="#cb95-618" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::bind_rows() %&gt;%</span></span>
<span id="cb95-619"><a href="#cb95-619" aria-hidden="true" tabindex="-1"></a><span class="in">    tibble::as_tibble()</span></span>
<span id="cb95-620"><a href="#cb95-620" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-621"><a href="#cb95-621" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-622"><a href="#cb95-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-623"><a href="#cb95-623" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb95-624"><a href="#cb95-624" aria-hidden="true" tabindex="-1"></a><span class="in">`data.table`</span> users can use <span class="in">`data.table::rbindlist()`</span> instead.</span>
<span id="cb95-625"><a href="#cb95-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-626"><a href="#cb95-626" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rbindlist-dt}</span></span>
<span id="cb95-627"><a href="#cb95-627" aria-hidden="true" tabindex="-1"></a><span class="in">data.table::rbindlist(tmax_by_county, idcol = "id")</span></span>
<span id="cb95-628"><a href="#cb95-628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-629"><a href="#cb95-629" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-630"><a href="#cb95-630" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb95-631"><a href="#cb95-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-632"><a href="#cb95-632" aria-hidden="true" tabindex="-1"></a>Let's summarize the data by <span class="in">`COUNTYFP`</span> and then merge it back to the polygons <span class="in">`sf`</span> data. Here, we calculate coverage-weighted mean of tmax.</span>
<span id="cb95-633"><a href="#cb95-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-634"><a href="#cb95-634" aria-hidden="true" tabindex="-1"></a><span class="in">```{r transform_after_ee, cache = F}</span></span>
<span id="cb95-635"><a href="#cb95-635" aria-hidden="true" tabindex="-1"></a><span class="in">#--- weighted mean ---#</span></span>
<span id="cb95-636"><a href="#cb95-636" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb95-637"><a href="#cb95-637" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_by_county &lt;-</span></span>
<span id="cb95-638"><a href="#cb95-638" aria-hidden="true" tabindex="-1"></a><span class="in">    tmax_combined %&gt;%</span></span>
<span id="cb95-639"><a href="#cb95-639" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- group summary ---#</span></span>
<span id="cb95-640"><a href="#cb95-640" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::group_by(COUNTYFP) %&gt;%</span></span>
<span id="cb95-641"><a href="#cb95-641" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::summarise(tmax_aw = sum(value * coverage_fraction) / sum(coverage_fraction))</span></span>
<span id="cb95-642"><a href="#cb95-642" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-643"><a href="#cb95-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-644"><a href="#cb95-644" aria-hidden="true" tabindex="-1"></a><span class="in">#--- merge ---#</span></span>
<span id="cb95-645"><a href="#cb95-645" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::left_join(KS_county_sf, tmax_by_county, by = "COUNTYFP") %&gt;%</span></span>
<span id="cb95-646"><a href="#cb95-646" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(COUNTYFP, tmax_aw)</span></span>
<span id="cb95-647"><a href="#cb95-647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-648"><a href="#cb95-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-649"><a href="#cb95-649" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract from multi-layer `SpatRaster`</span></span>
<span id="cb95-650"><a href="#cb95-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-651"><a href="#cb95-651" aria-hidden="true" tabindex="-1"></a>Extracting values from a multi-layer <span class="in">`SpatRaster`</span> object works in exactly the same manner as a single-layer <span class="in">`SpatRaster`</span> object.</span>
<span id="cb95-652"><a href="#cb95-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-653"><a href="#cb95-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{r exatrac_from_stack_run}</span></span>
<span id="cb95-654"><a href="#cb95-654" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_stack &lt;-</span></span>
<span id="cb95-655"><a href="#cb95-655" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb95-656"><a href="#cb95-656" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack,</span></span>
<span id="cb95-657"><a href="#cb95-657" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb95-658"><a href="#cb95-658" aria-hidden="true" tabindex="-1"></a><span class="in">    include_cols = "COUNTYFP",</span></span>
<span id="cb95-659"><a href="#cb95-659" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb95-660"><a href="#cb95-660" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-661"><a href="#cb95-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-662"><a href="#cb95-662" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look at the first 6 lines of the first element---#</span></span>
<span id="cb95-663"><a href="#cb95-663" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_by_county_stack[[1]] %&gt;% head()</span></span>
<span id="cb95-664"><a href="#cb95-664" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-665"><a href="#cb95-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-666"><a href="#cb95-666" aria-hidden="true" tabindex="-1"></a>As you can see above, <span class="in">`exactextractr::exact_extract()`</span> appends additional columns for additional layers.</span>
<span id="cb95-667"><a href="#cb95-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-668"><a href="#cb95-668" aria-hidden="true" tabindex="-1"></a><span class="in">```{r combine_them}</span></span>
<span id="cb95-669"><a href="#cb95-669" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine them ---#</span></span>
<span id="cb95-670"><a href="#cb95-670" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_all_combined &lt;- bind_rows(tmax_by_county_stack)</span></span>
<span id="cb95-671"><a href="#cb95-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-672"><a href="#cb95-672" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb95-673"><a href="#cb95-673" aria-hidden="true" tabindex="-1"></a><span class="in">head(tmax_all_combined)</span></span>
<span id="cb95-674"><a href="#cb95-674" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-675"><a href="#cb95-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-676"><a href="#cb95-676" aria-hidden="true" tabindex="-1"></a>In order to find the coverage-weighted <span class="in">`tmax`</span> by date, you can first pivot it to a long format using <span class="in">`tidyr::pivot_longer()`</span>.</span>
<span id="cb95-677"><a href="#cb95-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-678"><a href="#cb95-678" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pivot_to_longer}</span></span>
<span id="cb95-679"><a href="#cb95-679" aria-hidden="true" tabindex="-1"></a><span class="in">#--- pivot to a longer format ---#</span></span>
<span id="cb95-680"><a href="#cb95-680" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb95-681"><a href="#cb95-681" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_long &lt;-</span></span>
<span id="cb95-682"><a href="#cb95-682" aria-hidden="true" tabindex="-1"></a><span class="in">    tidyr::pivot_longer(</span></span>
<span id="cb95-683"><a href="#cb95-683" aria-hidden="true" tabindex="-1"></a><span class="in">      tmax_all_combined,</span></span>
<span id="cb95-684"><a href="#cb95-684" aria-hidden="true" tabindex="-1"></a><span class="in">      -c(COUNTYFP, coverage_fraction),</span></span>
<span id="cb95-685"><a href="#cb95-685" aria-hidden="true" tabindex="-1"></a><span class="in">      names_to = "date",</span></span>
<span id="cb95-686"><a href="#cb95-686" aria-hidden="true" tabindex="-1"></a><span class="in">      values_to = "tmax"</span></span>
<span id="cb95-687"><a href="#cb95-687" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb95-688"><a href="#cb95-688" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-689"><a href="#cb95-689" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-690"><a href="#cb95-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-691"><a href="#cb95-691" aria-hidden="true" tabindex="-1"></a>And then find coverage-weighted <span class="in">`tmax`</span> by date:</span>
<span id="cb95-692"><a href="#cb95-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-693"><a href="#cb95-693" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dplyr_way_tmax_cov}</span></span>
<span id="cb95-694"><a href="#cb95-694" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb95-695"><a href="#cb95-695" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_long %&gt;%</span></span>
<span id="cb95-696"><a href="#cb95-696" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::group_by(COUNTYFP, date) %&gt;%</span></span>
<span id="cb95-697"><a href="#cb95-697" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::summarize(tmax = sum(tmax * coverage_fraction) / sum(coverage_fraction))</span></span>
<span id="cb95-698"><a href="#cb95-698" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-699"><a href="#cb95-699" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-700"><a href="#cb95-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-701"><a href="#cb95-701" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb95-702"><a href="#cb95-702" aria-hidden="true" tabindex="-1"></a>For <span class="in">`data.table`</span> users, this does the same:</span>
<span id="cb95-703"><a href="#cb95-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-704"><a href="#cb95-704" aria-hidden="true" tabindex="-1"></a><span class="in">```{r datatable_way_tmax_cov}</span></span>
<span id="cb95-705"><a href="#cb95-705" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb95-706"><a href="#cb95-706" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_all_combined %&gt;%</span></span>
<span id="cb95-707"><a href="#cb95-707" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table() %&gt;%</span></span>
<span id="cb95-708"><a href="#cb95-708" aria-hidden="true" tabindex="-1"></a><span class="in">    melt(id.var = c("COUNTYFP", "coverage_fraction")) %&gt;%</span></span>
<span id="cb95-709"><a href="#cb95-709" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, .(tmax = sum(value * coverage_fraction) / sum(coverage_fraction)), by = .(COUNTYFP, variable)]</span></span>
<span id="cb95-710"><a href="#cb95-710" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-711"><a href="#cb95-711" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-712"><a href="#cb95-712" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-713"><a href="#cb95-713" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb95-714"><a href="#cb95-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-715"><a href="#cb95-715" aria-hidden="true" tabindex="-1"></a><span class="fu">#### extract and summarize in one step</span></span>
<span id="cb95-716"><a href="#cb95-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-717"><a href="#cb95-717" aria-hidden="true" tabindex="-1"></a>Instead of returning the value from all the intersecting cells, <span class="in">`exactextractr::exact_extract()`</span> can summarize the extracted values by polygon and then return the summarized numbers. This is much like how <span class="in">`terra::extract()`</span> with <span class="in">`FUN`</span> option works. There are multiple default options you can choose from. All you need to do is to add the desired summary function name as the third argument of <span class="in">`exactextractr::exact_extract()`</span>. For example, the following will get us the mean of the extracted values weighted by <span class="in">`coverage_fraction`</span>.</span>
<span id="cb95-718"><a href="#cb95-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-719"><a href="#cb95-719" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mean-cov, results = "hide"}</span></span>
<span id="cb95-720"><a href="#cb95-720" aria-hidden="true" tabindex="-1"></a><span class="in">extacted_mean &lt;- </span></span>
<span id="cb95-721"><a href="#cb95-721" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb95-722"><a href="#cb95-722" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack, </span></span>
<span id="cb95-723"><a href="#cb95-723" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf, </span></span>
<span id="cb95-724"><a href="#cb95-724" aria-hidden="true" tabindex="-1"></a><span class="in">    "mean", </span></span>
<span id="cb95-725"><a href="#cb95-725" aria-hidden="true" tabindex="-1"></a><span class="in">    append_cols = "COUNTYFP", </span></span>
<span id="cb95-726"><a href="#cb95-726" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb95-727"><a href="#cb95-727" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-728"><a href="#cb95-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-729"><a href="#cb95-729" aria-hidden="true" tabindex="-1"></a><span class="in">head(extacted_mean)</span></span>
<span id="cb95-730"><a href="#cb95-730" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-731"><a href="#cb95-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-732"><a href="#cb95-732" aria-hidden="true" tabindex="-1"></a>Notice that you use <span class="in">`append_cols`</span> instead of <span class="in">`include_cols`</span> when you summarize within <span class="in">`exactextractr::exact_extract()`</span>.</span>
<span id="cb95-733"><a href="#cb95-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-734"><a href="#cb95-734" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb95-735"><a href="#cb95-735" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb95-736"><a href="#cb95-736" aria-hidden="true" tabindex="-1"></a><span class="in">mean_tmax_long &lt;- </span></span>
<span id="cb95-737"><a href="#cb95-737" aria-hidden="true" tabindex="-1"></a><span class="in">  extacted_mean %&gt;% </span></span>
<span id="cb95-738"><a href="#cb95-738" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- wide to long ---#</span></span>
<span id="cb95-739"><a href="#cb95-739" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(-COUNTYFP, names_to = "date", values_to = "tmax") %&gt;%</span></span>
<span id="cb95-740"><a href="#cb95-740" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- recover date ---#</span></span>
<span id="cb95-741"><a href="#cb95-741" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(date = gsub("mean.date", "", date) %&gt;% lubridate::ymd())</span></span>
<span id="cb95-742"><a href="#cb95-742" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-743"><a href="#cb95-743" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-744"><a href="#cb95-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-745"><a href="#cb95-745" aria-hidden="true" tabindex="-1"></a>There are other summary function options that may be of interest, such as "max", "min." You can see all the default options at <span class="co">[</span><span class="ot">the package website</span><span class="co">](https://isciences.gitlab.io/exactextractr/index.html#summary-operations)</span>.</span>
<span id="cb95-746"><a href="#cb95-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-747"><a href="#cb95-747" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extraction speed comparison {#sec-extract-speed}</span></span>
<span id="cb95-748"><a href="#cb95-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-749"><a href="#cb95-749" aria-hidden="true" tabindex="-1"></a>Here we compare the extraction speed of <span class="in">`raster::extract()`</span>, <span class="in">`terra::extract()`</span>, and <span class="in">`exactextractr::exact_extract()`</span>. A more comprehensive discussion on the speed of raster extraction can be found in <span class="co">[</span><span class="ot">@sec-EE</span><span class="co">]</span>.</span>
<span id="cb95-750"><a href="#cb95-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-751"><a href="#cb95-751" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data preparation</span></span>
<span id="cb95-752"><a href="#cb95-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-753"><a href="#cb95-753" aria-hidden="true" tabindex="-1"></a>We first create two new R objects here:</span>
<span id="cb95-754"><a href="#cb95-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-755"><a href="#cb95-755" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`SpatVectore`</span> version of <span class="in">`KS_wells`</span>, which is currently an <span class="in">`sf`</span> object.</span>
<span id="cb95-756"><a href="#cb95-756" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`SpatVectore`</span> version of <span class="in">`KS_county_sf`</span>, which is currently an <span class="in">`sf`</span> object.</span>
<span id="cb95-757"><a href="#cb95-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-758"><a href="#cb95-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{r points-extraction-comp-prep}</span></span>
<span id="cb95-759"><a href="#cb95-759" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells_sv &lt;- terra::vect(KS_wells)</span></span>
<span id="cb95-760"><a href="#cb95-760" aria-hidden="true" tabindex="-1"></a><span class="in">KS_county_sv &lt;- terra::vect(KS_county_sf)</span></span>
<span id="cb95-761"><a href="#cb95-761" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-762"><a href="#cb95-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-763"><a href="#cb95-763" aria-hidden="true" tabindex="-1"></a>We also create a version of <span class="in">`prism_tmax_0701_KS_sr`</span> that is disaggregated by a factor of 10 to create a much larger raster data.</span>
<span id="cb95-764"><a href="#cb95-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-765"><a href="#cb95-765" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prism_disaggregate}</span></span>
<span id="cb95-766"><a href="#cb95-766" aria-hidden="true" tabindex="-1"></a><span class="in">#--- disaggregate ---#</span></span>
<span id="cb95-767"><a href="#cb95-767" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb95-768"><a href="#cb95-768" aria-hidden="true" tabindex="-1"></a><span class="in">  prism_tmax_0701_KS_sr_10 &lt;- terra::disagg(prism_tmax_0701_KS_sr, fact = 10)</span></span>
<span id="cb95-769"><a href="#cb95-769" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-770"><a href="#cb95-770" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-771"><a href="#cb95-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-772"><a href="#cb95-772" aria-hidden="true" tabindex="-1"></a>The disaggregated PRISM data now has 10 times more rows and columns.</span>
<span id="cb95-773"><a href="#cb95-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-774"><a href="#cb95-774" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dimensions}</span></span>
<span id="cb95-775"><a href="#cb95-775" aria-hidden="true" tabindex="-1"></a><span class="in">#--- original ---#</span></span>
<span id="cb95-776"><a href="#cb95-776" aria-hidden="true" tabindex="-1"></a><span class="in">dim(prism_tmax_0701_KS_sr)</span></span>
<span id="cb95-777"><a href="#cb95-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-778"><a href="#cb95-778" aria-hidden="true" tabindex="-1"></a><span class="in">#--- disaggregated ---#</span></span>
<span id="cb95-779"><a href="#cb95-779" aria-hidden="true" tabindex="-1"></a><span class="in">dim(prism_tmax_0701_KS_sr_10)</span></span>
<span id="cb95-780"><a href="#cb95-780" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-781"><a href="#cb95-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-782"><a href="#cb95-782" aria-hidden="true" tabindex="-1"></a><span class="fu">### Points: `terra::extract()`</span></span>
<span id="cb95-783"><a href="#cb95-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-784"><a href="#cb95-784" aria-hidden="true" tabindex="-1"></a>Extraction speed of <span class="in">`terra::extract()`</span> depends on the class of the raster and vector (points) objects^<span class="co">[</span><span class="ot">Until recently, `raster::extract()` was much much slower compared to `terra::extract()`. However, recent updates to the package made significant improvement in extraction speed and `raster::extract()` is comparable to `terra::extract()` in speed.</span><span class="co">]</span>. Whether the points data is <span class="in">`sf`</span> or <span class="in">`SpatVector`</span> makes a difference as you can see below with <span class="in">`SpatVector`</span> being faster.</span>
<span id="cb95-785"><a href="#cb95-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-786"><a href="#cb95-786" aria-hidden="true" tabindex="-1"></a><span class="in">```{r points-extraction-terra-sr-sf}</span></span>
<span id="cb95-787"><a href="#cb95-787" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: true</span></span>
<span id="cb95-788"><a href="#cb95-788" aria-hidden="true" tabindex="-1"></a><span class="in">#--- SpatRaster and sf ---#</span></span>
<span id="cb95-789"><a href="#cb95-789" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-790"><a href="#cb95-790" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_wells)</span></span>
<span id="cb95-791"><a href="#cb95-791" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-792"><a href="#cb95-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-793"><a href="#cb95-793" aria-hidden="true" tabindex="-1"></a><span class="in">#--- SpatRaster and SpatVector ---#</span></span>
<span id="cb95-794"><a href="#cb95-794" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-795"><a href="#cb95-795" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_wells_sv)</span></span>
<span id="cb95-796"><a href="#cb95-796" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-797"><a href="#cb95-797" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-798"><a href="#cb95-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-799"><a href="#cb95-799" aria-hidden="true" tabindex="-1"></a>Although the time difference may seem small, it can accumulate significantly when extracting data from numerous raster layers to the same set of points, resulting in a notable increase in overall processing time. In such cases, it is recommended to first convert the points from <span class="in">`sf`</span> to <span class="in">`SpatVector`</span> before performing the extractions.</span>
<span id="cb95-800"><a href="#cb95-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-801"><a href="#cb95-801" aria-hidden="true" tabindex="-1"></a><span class="fu">### Polygons: `exactextractr::exact_extract()` and `terra::extract()`</span></span>
<span id="cb95-802"><a href="#cb95-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-803"><a href="#cb95-803" aria-hidden="true" tabindex="-1"></a><span class="in">`terra::extract()`</span> is faster than <span class="in">`exactextractr::exact_extract()`</span> for a relatively small raster data. Let's use <span class="in">`prism_tmax_0701_KS_sr`</span> and time them to see the difference.</span>
<span id="cb95-804"><a href="#cb95-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-805"><a href="#cb95-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-806"><a href="#cb95-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-from-polygons-comp, cahce = F}</span></span>
<span id="cb95-807"><a href="#cb95-807" aria-hidden="true" tabindex="-1"></a><span class="in">#--- terra::extract ---#</span></span>
<span id="cb95-808"><a href="#cb95-808" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-809"><a href="#cb95-809" aria-hidden="true" tabindex="-1"></a><span class="in">terra_extract_temp &lt;-</span></span>
<span id="cb95-810"><a href="#cb95-810" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb95-811"><a href="#cb95-811" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr,</span></span>
<span id="cb95-812"><a href="#cb95-812" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sv</span></span>
<span id="cb95-813"><a href="#cb95-813" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-814"><a href="#cb95-814" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-815"><a href="#cb95-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-816"><a href="#cb95-816" aria-hidden="true" tabindex="-1"></a><span class="in">#--- exact_extract ---#</span></span>
<span id="cb95-817"><a href="#cb95-817" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-818"><a href="#cb95-818" aria-hidden="true" tabindex="-1"></a><span class="in">exact_extract_temp &lt;-</span></span>
<span id="cb95-819"><a href="#cb95-819" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb95-820"><a href="#cb95-820" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr,</span></span>
<span id="cb95-821"><a href="#cb95-821" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb95-822"><a href="#cb95-822" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb95-823"><a href="#cb95-823" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-824"><a href="#cb95-824" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-825"><a href="#cb95-825" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-826"><a href="#cb95-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-827"><a href="#cb95-827" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`terra::extract()`</span> is faster than <span class="in">`exactextractr::exact_extract()`</span>. However, once the raster data becomes larger (or spatially finer), then <span class="in">`exact_extact()`</span> starts to shine. </span>
<span id="cb95-828"><a href="#cb95-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-829"><a href="#cb95-829" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb95-830"><a href="#cb95-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-831"><a href="#cb95-831" aria-hidden="true" tabindex="-1"></a>Now, let's compare <span class="in">`terra::extrct()`</span> and <span class="in">`exact_extrct()`</span> using the disaggregated data.</span>
<span id="cb95-832"><a href="#cb95-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-833"><a href="#cb95-833" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract_from_polygons_comp_2}</span></span>
<span id="cb95-834"><a href="#cb95-834" aria-hidden="true" tabindex="-1"></a><span class="in">#--- terra extract ---#</span></span>
<span id="cb95-835"><a href="#cb95-835" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-836"><a href="#cb95-836" aria-hidden="true" tabindex="-1"></a><span class="in">terra_extract_temp &lt;-</span></span>
<span id="cb95-837"><a href="#cb95-837" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::extract(</span></span>
<span id="cb95-838"><a href="#cb95-838" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-839"><a href="#cb95-839" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sv</span></span>
<span id="cb95-840"><a href="#cb95-840" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-841"><a href="#cb95-841" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-842"><a href="#cb95-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-843"><a href="#cb95-843" aria-hidden="true" tabindex="-1"></a><span class="in">#--- exact extract ---#</span></span>
<span id="cb95-844"><a href="#cb95-844" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-845"><a href="#cb95-845" aria-hidden="true" tabindex="-1"></a><span class="in">exact_extract_temp &lt;-</span></span>
<span id="cb95-846"><a href="#cb95-846" aria-hidden="true" tabindex="-1"></a><span class="in">  exact_extract(</span></span>
<span id="cb95-847"><a href="#cb95-847" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-848"><a href="#cb95-848" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb95-849"><a href="#cb95-849" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb95-850"><a href="#cb95-850" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-851"><a href="#cb95-851" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-852"><a href="#cb95-852" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-853"><a href="#cb95-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-854"><a href="#cb95-854" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`exactextractr::exact_extract()`</span> is considerably faster. The difference in time becomes even more pronounced as the size of the raster data becomes larger and the number of polygons are greater. The time difference of several seconds seem nothing, but imagine processing Cropland Data Layer (CDL) files for the entire US over 10 years, then you would appreciate the speed of <span class="in">`exactextractr::exact_extract()`</span>. See @sec-EE for more comprehensive treatment of raster value extraction speed.</span>
<span id="cb95-855"><a href="#cb95-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-856"><a href="#cb95-856" aria-hidden="true" tabindex="-1"></a><span class="fu">### Single-layer vs multi-layer</span></span>
<span id="cb95-857"><a href="#cb95-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-858"><a href="#cb95-858" aria-hidden="true" tabindex="-1"></a>Pretend that you have five dates of PRISM tmax data (here we repeat the same file five times) and would like to extract values from all of them. Extracting values from a multi-layer raster objects (<span class="in">`RasterStack`</span> for <span class="in">`raster`</span> package) takes less time than extracting values from the individual layers one at a time. This can be observed below.</span>
<span id="cb95-859"><a href="#cb95-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-860"><a href="#cb95-860" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb95-861"><a href="#cb95-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-862"><a href="#cb95-862" aria-hidden="true" tabindex="-1"></a>**`terra::extract()`**</span>
<span id="cb95-863"><a href="#cb95-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-864"><a href="#cb95-864" aria-hidden="true" tabindex="-1"></a><span class="in">```{r write_raster_prism_10, echo = F}</span></span>
<span id="cb95-865"><a href="#cb95-865" aria-hidden="true" tabindex="-1"></a><span class="in"># terra::writeRaster(prism_tmax_0701_KS_sr_10, "Data/prism_tmax_0701_KS_sr_10.tif", overwrite = TRUE)</span></span>
<span id="cb95-866"><a href="#cb95-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-867"><a href="#cb95-867" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_0701_KS_sr_10 &lt;- rast("Data/prism_tmax_0701_KS_sr_10.tif")</span></span>
<span id="cb95-868"><a href="#cb95-868" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-869"><a href="#cb95-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-870"><a href="#cb95-870" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare_speed_te}</span></span>
<span id="cb95-871"><a href="#cb95-871" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: true</span></span>
<span id="cb95-872"><a href="#cb95-872" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from 5 layers one at a time ---#</span></span>
<span id="cb95-873"><a href="#cb95-873" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-874"><a href="#cb95-874" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb95-875"><a href="#cb95-875" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb95-876"><a href="#cb95-876" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb95-877"><a href="#cb95-877" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb95-878"><a href="#cb95-878" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_0701_KS_sr_10, KS_county_sv)</span></span>
<span id="cb95-879"><a href="#cb95-879" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-880"><a href="#cb95-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-881"><a href="#cb95-881" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from a 5-layer SpatRaster ---#</span></span>
<span id="cb95-882"><a href="#cb95-882" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-883"><a href="#cb95-883" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_ml_5 &lt;-</span></span>
<span id="cb95-884"><a href="#cb95-884" aria-hidden="true" tabindex="-1"></a><span class="in">  c(</span></span>
<span id="cb95-885"><a href="#cb95-885" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-886"><a href="#cb95-886" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-887"><a href="#cb95-887" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-888"><a href="#cb95-888" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-889"><a href="#cb95-889" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10</span></span>
<span id="cb95-890"><a href="#cb95-890" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-891"><a href="#cb95-891" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- terra::extract(prism_tmax_ml_5, KS_county_sv)</span></span>
<span id="cb95-892"><a href="#cb95-892" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-893"><a href="#cb95-893" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-894"><a href="#cb95-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-895"><a href="#cb95-895" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb95-896"><a href="#cb95-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-897"><a href="#cb95-897" aria-hidden="true" tabindex="-1"></a>**`exactextractr::exact_extract()`**</span>
<span id="cb95-898"><a href="#cb95-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-899"><a href="#cb95-899" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare_speed_ee}</span></span>
<span id="cb95-900"><a href="#cb95-900" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: true</span></span>
<span id="cb95-901"><a href="#cb95-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-902"><a href="#cb95-902" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from 5 layers one at a time ---#</span></span>
<span id="cb95-903"><a href="#cb95-903" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-904"><a href="#cb95-904" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb95-905"><a href="#cb95-905" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb95-906"><a href="#cb95-906" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb95-907"><a href="#cb95-907" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb95-908"><a href="#cb95-908" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- exact_extract(prism_tmax_0701_KS_sr_10, KS_county_sf, progress = FALSE)</span></span>
<span id="cb95-909"><a href="#cb95-909" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-910"><a href="#cb95-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-911"><a href="#cb95-911" aria-hidden="true" tabindex="-1"></a><span class="in">#--- extract from from a 5-layer SpatRaster ---#</span></span>
<span id="cb95-912"><a href="#cb95-912" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb95-913"><a href="#cb95-913" aria-hidden="true" tabindex="-1"></a><span class="in">prism_tmax_stack_5 &lt;-</span></span>
<span id="cb95-914"><a href="#cb95-914" aria-hidden="true" tabindex="-1"></a><span class="in">  c(</span></span>
<span id="cb95-915"><a href="#cb95-915" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-916"><a href="#cb95-916" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-917"><a href="#cb95-917" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-918"><a href="#cb95-918" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10,</span></span>
<span id="cb95-919"><a href="#cb95-919" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_0701_KS_sr_10</span></span>
<span id="cb95-920"><a href="#cb95-920" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-921"><a href="#cb95-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-922"><a href="#cb95-922" aria-hidden="true" tabindex="-1"></a><span class="in">#--- set layer names ---#</span></span>
<span id="cb95-923"><a href="#cb95-923" aria-hidden="true" tabindex="-1"></a><span class="in"># exact_extract() does not like multi-layer raster with the same layer name</span></span>
<span id="cb95-924"><a href="#cb95-924" aria-hidden="true" tabindex="-1"></a><span class="in">set.names(prism_tmax_stack_5, paste0("layer_", 1:5))</span></span>
<span id="cb95-925"><a href="#cb95-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-926"><a href="#cb95-926" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;-</span></span>
<span id="cb95-927"><a href="#cb95-927" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb95-928"><a href="#cb95-928" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_tmax_stack_5,</span></span>
<span id="cb95-929"><a href="#cb95-929" aria-hidden="true" tabindex="-1"></a><span class="in">    KS_county_sf,</span></span>
<span id="cb95-930"><a href="#cb95-930" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = FALSE</span></span>
<span id="cb95-931"><a href="#cb95-931" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-932"><a href="#cb95-932" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb95-933"><a href="#cb95-933" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-934"><a href="#cb95-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-935"><a href="#cb95-935" aria-hidden="true" tabindex="-1"></a>The reduction in computation time for both methods makes sense. Since both layers have exactly the same geographic extent and resolution, finding the polygons-cells correspondence is done once and then it can be used repeatedly across the layers for the multi-layer <span class="in">`SparRaster`</span> and <span class="in">`RasterStack`</span>. This clearly suggests that when you are processing many layers of the same spatial resolution and extent, you should first stack them and then extract values at the same time instead of processing them one by one as long as your memory allows you to do so. </span>
<span id="cb95-936"><a href="#cb95-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-937"><a href="#cb95-937" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises {#sec-exercises-int-rv}</span></span>
<span id="cb95-938"><a href="#cb95-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-939"><a href="#cb95-939" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb95-940"><a href="#cb95-940" aria-hidden="true" tabindex="-1"></a>Before working on exercises, please run the following codes by hitting the **Run Code** button.</span>
<span id="cb95-941"><a href="#cb95-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-942"><a href="#cb95-942" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb95-943"><a href="#cb95-943" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb95-944"><a href="#cb95-944" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb95-945"><a href="#cb95-945" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb95-946"><a href="#cb95-946" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb95-947"><a href="#cb95-947" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb95-948"><a href="#cb95-948" aria-hidden="true" tabindex="-1"></a><span class="in">library(stars)</span></span>
<span id="cb95-949"><a href="#cb95-949" aria-hidden="true" tabindex="-1"></a><span class="in">library(terra)</span></span>
<span id="cb95-950"><a href="#cb95-950" aria-hidden="true" tabindex="-1"></a><span class="in">install.packages(</span></span>
<span id="cb95-951"><a href="#cb95-951" aria-hidden="true" tabindex="-1"></a><span class="in">  "r.spatial.workshop.datasets", </span></span>
<span id="cb95-952"><a href="#cb95-952" aria-hidden="true" tabindex="-1"></a><span class="in">  repos = c("https://tmieno2.r-universe.dev")</span></span>
<span id="cb95-953"><a href="#cb95-953" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb95-954"><a href="#cb95-954" aria-hidden="true" tabindex="-1"></a><span class="in">library(r.spatial.workshop.datasets)</span></span>
<span id="cb95-955"><a href="#cb95-955" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-956"><a href="#cb95-956" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-957"><a href="#cb95-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-958"><a href="#cb95-958" aria-hidden="true" tabindex="-1"></a>:::{.callout-note title="Tips for working with an <span class="in">`webr`</span> session"}</span>
<span id="cb95-959"><a href="#cb95-959" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Hit the **Run Code** button to run all the codes in the code area.</span>
<span id="cb95-960"><a href="#cb95-960" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>To run only parts of the code, highlight the section you want to execute with your cursor and then press **Cmd + Return** (Mac) or **Ctrl + Enter** (Windows).</span>
<span id="cb95-961"><a href="#cb95-961" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>All the code blocks are interconnected and R objects defined in one R code block is available in another R code block.</span>
<span id="cb95-962"><a href="#cb95-962" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-963"><a href="#cb95-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-964"><a href="#cb95-964" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 1: Extraction to points</span></span>
<span id="cb95-965"><a href="#cb95-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-966"><a href="#cb95-966" aria-hidden="true" tabindex="-1"></a>In this exercise, we will use corn yield points data as <span class="in">`sf`</span> and NDRE value as a <span class="in">`SpatRaster`</span> (@fig-corn-ndre shows the map of the two spatial objects). Please run the following codes first to make them avaialable.</span>
<span id="cb95-967"><a href="#cb95-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-968"><a href="#cb95-968" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb95-969"><a href="#cb95-969" aria-hidden="true" tabindex="-1"></a><span class="in">data(corn_yield)</span></span>
<span id="cb95-970"><a href="#cb95-970" aria-hidden="true" tabindex="-1"></a><span class="in">data(NDRE)</span></span>
<span id="cb95-971"><a href="#cb95-971" aria-hidden="true" tabindex="-1"></a><span class="in">NDRE &lt;- terra::rast(NDRE)</span></span>
<span id="cb95-972"><a href="#cb95-972" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-973"><a href="#cb95-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-974"><a href="#cb95-974" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb95-977"><a href="#cb95-977" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-978"><a href="#cb95-978" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-corn-ndre</span></span>
<span id="cb95-979"><a href="#cb95-979" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of corn yield data points and NDRE values"</span></span>
<span id="cb95-980"><a href="#cb95-980" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb95-981"><a href="#cb95-981" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(r.spatial.workshop.datasets)</span>
<span id="cb95-982"><a href="#cb95-982" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(corn_yield)</span>
<span id="cb95-983"><a href="#cb95-983" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(NDRE)</span>
<span id="cb95-984"><a href="#cb95-984" aria-hidden="true" tabindex="-1"></a>NDRE <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(NDRE)</span>
<span id="cb95-985"><a href="#cb95-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-986"><a href="#cb95-986" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb95-987"><a href="#cb95-987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_spatraster</span>(<span class="at">data =</span> NDRE) <span class="sc">+</span></span>
<span id="cb95-988"><a href="#cb95-988" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> corn_yield, <span class="at">size =</span> <span class="fl">0.03</span>) <span class="sc">+</span></span>
<span id="cb95-989"><a href="#cb95-989" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"NDRE"</span>)</span>
<span id="cb95-990"><a href="#cb95-990" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-991"><a href="#cb95-991" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-992"><a href="#cb95-992" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb95-993"><a href="#cb95-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-994"><a href="#cb95-994" aria-hidden="true" tabindex="-1"></a>Extract NDRE values to corn yield data points using <span class="in">`terra::extract()`</span> and find the correlation between corn yield (<span class="in">`yield`</span>) and NDRE using <span class="in">`cor()`</span>. </span>
<span id="cb95-995"><a href="#cb95-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-996"><a href="#cb95-996" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb95-997"><a href="#cb95-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-998"><a href="#cb95-998" aria-hidden="true" tabindex="-1"></a><span class="fu">### Work here</span></span>
<span id="cb95-999"><a href="#cb95-999" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb95-1000"><a href="#cb95-1000" aria-hidden="true" tabindex="-1"></a><span class="in">#--- work here ---#</span></span>
<span id="cb95-1001"><a href="#cb95-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1002"><a href="#cb95-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1003"><a href="#cb95-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1004"><a href="#cb95-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1005"><a href="#cb95-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1006"><a href="#cb95-1006" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-1007"><a href="#cb95-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1008"><a href="#cb95-1008" aria-hidden="true" tabindex="-1"></a><span class="fu">### Answer</span></span>
<span id="cb95-1009"><a href="#cb95-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb95-1010"><a href="#cb95-1010" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb95-1011"><a href="#cb95-1011" aria-hidden="true" tabindex="-1"></a><span class="in">ndre_extracted &lt;- terra::extract(NDRE, corn_yield)</span></span>
<span id="cb95-1012"><a href="#cb95-1012" aria-hidden="true" tabindex="-1"></a><span class="in">corn_yield$ndre &lt;- ndre_extracted$NDRE</span></span>
<span id="cb95-1013"><a href="#cb95-1013" aria-hidden="true" tabindex="-1"></a><span class="in">cor(corn_yield$yield, corn_yield$ndre)</span></span>
<span id="cb95-1014"><a href="#cb95-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-1015"><a href="#cb95-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1016"><a href="#cb95-1016" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-1017"><a href="#cb95-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1018"><a href="#cb95-1018" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 2: Extraction to polygons</span></span>
<span id="cb95-1019"><a href="#cb95-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1020"><a href="#cb95-1020" aria-hidden="true" tabindex="-1"></a>In this exercise, we will use Nebraska's county borders as an <span class="in">`sf`</span> object and the aggregated version of the PRISM precipitation data from August 1st, 2012 as a <span class="in">`SpatRaster`</span> (see @fig-prism-ne for their maps). Run the following codes first.</span>
<span id="cb95-1021"><a href="#cb95-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1022"><a href="#cb95-1022" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb95-1023"><a href="#cb95-1023" aria-hidden="true" tabindex="-1"></a><span class="in">data(ne_counties)</span></span>
<span id="cb95-1024"><a href="#cb95-1024" aria-hidden="true" tabindex="-1"></a><span class="in">data(prism_us)</span></span>
<span id="cb95-1025"><a href="#cb95-1025" aria-hidden="true" tabindex="-1"></a><span class="in">prism_us &lt;- terra::rast(prism_us)</span></span>
<span id="cb95-1026"><a href="#cb95-1026" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-1027"><a href="#cb95-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1028"><a href="#cb95-1028" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb95-1031"><a href="#cb95-1031" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb95-1032"><a href="#cb95-1032" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-prism-ne </span></span>
<span id="cb95-1033"><a href="#cb95-1033" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb95-1034"><a href="#cb95-1034" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "PRISM precipitation data and Nebrask's county borders"</span></span>
<span id="cb95-1035"><a href="#cb95-1035" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ne_counties)</span>
<span id="cb95-1036"><a href="#cb95-1036" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(prism_us)</span>
<span id="cb95-1037"><a href="#cb95-1037" aria-hidden="true" tabindex="-1"></a>prism_us <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(prism_us)</span>
<span id="cb95-1038"><a href="#cb95-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1039"><a href="#cb95-1039" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb95-1040"><a href="#cb95-1040" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_spatraster</span>(<span class="at">data =</span> prism_us) <span class="sc">+</span></span>
<span id="cb95-1041"><a href="#cb95-1041" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> ne_counties, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb95-1042"><a href="#cb95-1042" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_whitebox_c</span>(<span class="at">name =</span> <span class="st">"Precipitation"</span>, <span class="at">na.value =</span> <span class="st">"transparent"</span>, <span class="at">palette =</span> <span class="st">"muted"</span>) <span class="sc">+</span></span>
<span id="cb95-1043"><a href="#cb95-1043" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb95-1044"><a href="#cb95-1044" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-1045"><a href="#cb95-1045" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-1046"><a href="#cb95-1046" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb95-1047"><a href="#cb95-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1048"><a href="#cb95-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1049"><a href="#cb95-1049" aria-hidden="true" tabindex="-1"></a>Extract precipitation values from <span class="in">`prism_us`</span> to <span class="in">`ne_counties`</span> and find the average precipitation by county. You can use either <span class="in">`terra::extract()`</span> or <span class="in">`exactextractr::exact_extract()`</span>. Then, merge the precipitation data with <span class="in">`ne_counties`</span>.</span>
<span id="cb95-1050"><a href="#cb95-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1051"><a href="#cb95-1051" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb95-1052"><a href="#cb95-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1053"><a href="#cb95-1053" aria-hidden="true" tabindex="-1"></a><span class="fu">### Work here</span></span>
<span id="cb95-1054"><a href="#cb95-1054" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb95-1055"><a href="#cb95-1055" aria-hidden="true" tabindex="-1"></a><span class="in">#--- work here ---#</span></span>
<span id="cb95-1056"><a href="#cb95-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1057"><a href="#cb95-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1058"><a href="#cb95-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1059"><a href="#cb95-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1060"><a href="#cb95-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1061"><a href="#cb95-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1062"><a href="#cb95-1062" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-1063"><a href="#cb95-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1064"><a href="#cb95-1064" aria-hidden="true" tabindex="-1"></a><span class="fu">### Answer</span></span>
<span id="cb95-1065"><a href="#cb95-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb95-1066"><a href="#cb95-1066" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb95-1067"><a href="#cb95-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1068"><a href="#cb95-1068" aria-hidden="true" tabindex="-1"></a><span class="in">#--- terra ---#</span></span>
<span id="cb95-1069"><a href="#cb95-1069" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_data &lt;- terra::extract(prism_us, ne_counties, fun = "mean")</span></span>
<span id="cb95-1070"><a href="#cb95-1070" aria-hidden="true" tabindex="-1"></a><span class="in">ne_counties$prcp &lt;- prcp_data$PRISM_ppt_stable_4kmD2_20120801_bil</span></span>
<span id="cb95-1071"><a href="#cb95-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1072"><a href="#cb95-1072" aria-hidden="true" tabindex="-1"></a><span class="in">#--- exactextractr ---#</span></span>
<span id="cb95-1073"><a href="#cb95-1073" aria-hidden="true" tabindex="-1"></a><span class="in">prcp_data &lt;-</span></span>
<span id="cb95-1074"><a href="#cb95-1074" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb95-1075"><a href="#cb95-1075" aria-hidden="true" tabindex="-1"></a><span class="in">    prism_us,</span></span>
<span id="cb95-1076"><a href="#cb95-1076" aria-hidden="true" tabindex="-1"></a><span class="in">    ne_counties,</span></span>
<span id="cb95-1077"><a href="#cb95-1077" aria-hidden="true" tabindex="-1"></a><span class="in">    "mean",</span></span>
<span id="cb95-1078"><a href="#cb95-1078" aria-hidden="true" tabindex="-1"></a><span class="in">    append_cols = "name"</span></span>
<span id="cb95-1079"><a href="#cb95-1079" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb95-1080"><a href="#cb95-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1081"><a href="#cb95-1081" aria-hidden="true" tabindex="-1"></a><span class="in">left_join(ne_counties, prcp_data, by = "name")</span></span>
<span id="cb95-1082"><a href="#cb95-1082" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb95-1083"><a href="#cb95-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1084"><a href="#cb95-1084" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb95-1085"><a href="#cb95-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-1086"><a href="#cb95-1086" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/05-SpatialInteractionVectorRaster.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer><script type="module">
// Handle cell initialization initialization
qwebrCellDetails.map(
  (entry) => {
    // Handle the creation of the element
    qwebrCreateHTMLElement(entry);
    // In the event of interactive, initialize the monaco editor
    if (entry.options.context == EvalTypes.Interactive) {
      qwebrCreateMonacoEditorInstance(entry);
    }
  }
);

// Identify non-interactive cells (in order)
const filteredEntries = qwebrCellDetails.filter(entry => {
  const contextOption = entry.options && entry.options.context;
  return ['output', 'setup'].includes(contextOption) || (contextOption == "interactive" && entry.options && entry.options.autorun === 'true');
});

// Condition non-interactive cells to only be run after webR finishes its initialization.
qwebrInstance.then(
  async () => {
    const nHiddenCells = filteredEntries.length;
    var currentHiddenCell = 0;


    // Modify button state
    qwebrSetInteractiveButtonState(`🟡 Running hidden code cells ...`, false);

    // Begin processing non-interactive sections
    // Due to the iteration policy, we must use a for() loop.
    // Otherwise, we would need to switch to using reduce with an empty
    // starting promise
    for (const entry of filteredEntries) {

      // Determine cell being examined
      currentHiddenCell = currentHiddenCell + 1;
      const formattedMessage = `Evaluating hidden cell ${currentHiddenCell} out of ${nHiddenCells}`;

      // Update the document status header
      if (qwebrShowStartupMessage) {
        qwebrUpdateStatusHeader(formattedMessage);
      }

      // Display the update in non-active areas
      qwebrUpdateStatusMessage(formattedMessage);

      // Extract details on the active cell
      const evalType = entry.options.context;
      const cellCode = entry.code;
      const qwebrCounter = entry.id;

      if (['output', 'setup'].includes(evalType)) {
        // Disable further global status updates
        const activeContainer = document.getElementById(`qwebr-non-interactive-loading-container-${qwebrCounter}`);
        activeContainer.classList.remove('qwebr-cell-needs-evaluation');
        activeContainer.classList.add('qwebr-cell-evaluated');

        // Update status on the code cell
        const activeStatus = document.getElementById(`qwebr-status-text-${qwebrCounter}`);
        activeStatus.innerText = " Evaluating hidden code cell...";
        activeStatus.classList.remove('qwebr-cell-needs-evaluation');
        activeStatus.classList.add('qwebr-cell-evaluated');
      }

      switch (evalType) {
        case 'interactive':
          // TODO: Make this more standardized.
          // At the moment, we're overriding the interactive status update by pretending its
          // output-like. 
          const tempOptions = entry.options;
          tempOptions["context"] = "output"
          // Run the code in a non-interactive state that is geared to displaying output
          await qwebrExecuteCode(`${cellCode}`, qwebrCounter, tempOptions);
          break;
        case 'output':
          // Run the code in a non-interactive state that is geared to displaying output
          await qwebrExecuteCode(`${cellCode}`, qwebrCounter, entry.options);
          break;
        case 'setup':
          const activeDiv = document.getElementById(`qwebr-noninteractive-setup-area-${qwebrCounter}`);

          // Store code in history
          qwebrLogCodeToHistory(cellCode, entry.options);

          // Run the code in a non-interactive state with all output thrown away
          await mainWebR.evalRVoid(`${cellCode}`);
          break;
        default: 
          break; 
      }

      if (['output', 'setup'].includes(evalType)) {
        // Disable further global status updates
        const activeContainer = document.getElementById(`qwebr-non-interactive-loading-container-${qwebrCounter}`);
        // Disable visibility
        activeContainer.style.visibility = 'hidden';
        activeContainer.style.display = 'none';
      }
    }
  }
).then(
  () => {
    // Release document status as ready

    if (qwebrShowStartupMessage) {
      qwebrStartupMessage.innerText = "🟢 Ready!"
    }
  
    qwebrSetInteractiveButtonState(
      `<i class="fa-solid fa-play qwebr-icon-run-code"></i> <span>Run Code</span>`, 
      true
    );  
  }
);
</script>


</body></html>
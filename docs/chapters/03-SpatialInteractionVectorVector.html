<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>3&nbsp; Spatial Interactions of Vector Data: Subsetting and Joining – R as GIS for Economists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/04-RasterDataBasics.html" rel="next">
<link href="../chapters/02-VectorDataBasics.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Google tag (gtag.js) --><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/editor/editor.main.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style type="text/css">
.monaco-editor pre {
  background-color: unset !important;
}

.qwebr-editor-toolbar {
  width: 100%;
  display: flex;
  justify-content: space-between;
  box-sizing: border-box;
}

.qwebr-editor-toolbar-left-buttons, .qwebr-editor-toolbar-right-buttons {
  display: flex;
}

.qwebr-non-interactive-loading-container.qwebr-cell-needs-evaluation, .qwebr-non-interactive-loading-container.qwebr-cell-evaluated {
  justify-content: center;
  display: flex;
  background-color: rgba(250, 250, 250, 0.65);
  border: 1px solid rgba(233, 236, 239, 0.65);
  border-radius: 0.5rem;
  margin-top: 15px;
  margin-bottom: 15px;
}

.qwebr-r-project-logo {
  color: #2767B0; /* R Project's blue color */
}

.qwebr-icon-status-spinner {
  color: #7894c4;
}

.qwebr-icon-run-code {
  color: #0d9c29
}

body.quarto-light .qwebr-output-code-stdout {
  color: #111;
}

body.quarto-dark .qwebr-output-code-stdout {
  color: #EEE;
}

.qwebr-output-code-stderr {
  color: #db4133;
}

body.quarto-light .qwebr-editor {
  border: 1px solid #EEEEEE;
}

body.quarto-light .qwebr-editor-toolbar {
  background-color: #EEEEEE;
  padding: 0.2rem 0.5rem;
}

body.quarto-dark .qwebr-editor {
  border: 1px solid #111;
}

body.quarto-dark .qwebr-editor-toolbar {
  background-color: #111;
  padding: 0.2rem 0.5rem;
}

.qwebr-button {
  display: inline-block;
  font-weight: 400;
  line-height: 1;
  text-decoration: none;
  text-align: center;
  padding: 0.375rem 0.75rem;
  font-size: .9rem;
  border-radius: 0.25rem;
  transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
}

body.quarto-light .qwebr-button {
  background-color: #EEEEEE;
  color: #000;
  border-color: #dee2e6;
  border: 1px solid rgba(0,0,0,0);
}

body.quarto-dark .qwebr-button {
  background-color: #111;
  color: #EEE;
  border-color: #dee2e6;
  border: 1px solid rgba(0,0,0,0);
}

body.quarto-light .qwebr-button:hover {
  color: #000;
  background-color: #d9dce0;
  border-color: #c8ccd0;
}

body.quarto-dark .qwebr-button:hover {
  color: #d9dce0;
  background-color: #323232;
  border-color: #d9dce0;
}

.qwebr-button:disabled,.qwebr-button.disabled,fieldset:disabled .qwebr-button {
  pointer-events: none;
  opacity: .65
}

.qwebr-button-reset {
  color: #696969; /*#4682b4;*/
}

.qwebr-button-copy {
  color: #696969;
}

/* Style the code highlight lines */
body.quarto-light .qwebr-editor-highlight-line {
  background-color: lightblue;
}

body.quarto-dark .qwebr-editor-highlight-line {
  background-color: darkblue;
}

/* Style the modal pop-up */

/* The Modal (background) */
.qwebr-modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  padding-top: 60px;
}

/* Modal Content */
.qwebr-modal-content {
  background-color: #fefefe;
  margin: 5% auto; /* 15% from the top and centered */
  padding: 20px;
  border: 1px solid #888;
  width: 80%; /* Could be more or less, depending on screen size */
}

.qwebr-modal-content-code {
  max-height: 50vh;
  min-height: 5vh;
  overflow: scroll;
  border: 1px solid #888;
}

/* The Close Button */
.qwebr-modal-close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.qwebr-modal-close:hover,
.qwebr-modal-close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

.qwebr-download-btn {
  margin-top: 10px;
  text-decoration: none !important;
}

/* Styling to download image that is created */

.qwebr-canvas-image {
  position: relative;
  display: inline-block;
  margin: 10px;
}

.qwebr-canvas-image-download-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 5px 10px;
  background-color: #007BFF;
  color: white;
  border: none;
  cursor: pointer;
  display: none;
}

figure:hover .qwebr-canvas-image-download-btn {
  display: block;
}

/* Custom styling for RevealJS Presentations*/

/* Reset the style of the interactive area */
.reveal div.qwebr-interactive-area {
  display: block;
  box-shadow: none;
  max-width: 100%;
  max-height: 100%;
  margin: 0;
  padding: 0;
} 

/* Provide space to entries */
.reveal div.qwebr-output-code-area pre div {
  margin: 1px 2px 1px 10px;
}

/* Collapse the inside code tags to avoid extra space between line outputs */
.reveal pre div code.qwebr-output-code-stdout, .reveal pre div code.qwebr-output-code-stderr {
  padding: 0;
  display: contents;
}

body.reveal.quarto-light pre div code.qwebr-output-code-stdout {
  color: #111;
}

body.reveal.quarto-dark pre div code.qwebr-output-code-stdout {
  color: #EEEEEE;
}

.reveal pre div code.qwebr-output-code-stderr {
  color: #db4133;
}


/* Create a border around console and output (does not effect graphs) */
body.reveal.quarto-light div.qwebr-console-area {
  border: 1px solid #EEEEEE;
  box-shadow: 2px 2px 10px #EEEEEE;
}

body.reveal.quarto-dark div.qwebr-console-area {
  border: 1px solid #111;
  box-shadow: 2px 2px 10px #111;
}


/* Cap output height and allow text to scroll */
/* TODO: Is there a better way to fit contents/max it parallel to the monaco editor size? */
.reveal div.qwebr-output-code-area pre {
  max-height: 400px;
  overflow: scroll;
}

</style>
<script type="module">
// Document level settings ----

// Determine if we need to install R packages
globalThis.qwebrInstallRPackagesList = [''];

// Specify possible locations to search for the repository
globalThis.qwebrPackageRepoURLS = ['https://repo.r-wasm.org/'];

// Check to see if we have an empty array, if we do set to skip the installation.
globalThis.qwebrSetupRPackages = !(qwebrInstallRPackagesList.indexOf("") !== -1);
globalThis.qwebrAutoloadRPackages = true;

// Display a startup message?
globalThis.qwebrShowStartupMessage = true;
globalThis.qwebrShowHeaderMessage = false;

// Describe the webR settings that should be used
globalThis.qwebrCustomizedWebROptions = {
  "baseURL": "https://webr.r-wasm.org/v0.4.0/",
  "serviceWorkerUrl": "",
  "homedir": "/home/web_user", 
  "channelType": "ChannelType.Automatic"
};

// Store cell data
globalThis.qwebrCellDetails = [{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"false","editor-max-height":"","message":"false","classes":"","out-height":"","label":"unnamed-chunk-1","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":1,"code":"library(dplyr)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(tigris)\ninstall.packages(\n  \"r.spatial.workshop.datasets\", \n  repos = c(\"https://tmieno2.r-universe.dev\")\n)\nlibrary(r.spatial.workshop.datasets)"},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-2","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":2,"code":"data(fairway_grid)\ndata(mower_sensor)\nmower_sensor_sf <- \n  sf::st_as_sf(\n    mower_sensor, \n    coords = c(\"LNG\", \"LAT\"),\n    crs = sf::st_crs(fairway_grid)\n  )\n\n#--- write codes below  ---#\n"},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-3","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":3,"code":"data(hp_boundary)\ndata(co_counties)\n\nggplot() +\n  geom_sf(data = hp_boundary, fill = \"blue\", alpha = 0.3) +\n  geom_sf(data = co_counties, fill = NA) +\n  theme_void()"},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-4","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":4,"code":"#--- write codes below  ---#\n\n\n\n"},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-5","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":5,"code":"#--- write codes below  ---#\n\n\n\n"},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-6","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":6,"code":"#--- write codes below  ---#\n\n\n\n"},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-7","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":7,"code":"data(ne_counties)\ndata(wells_ne_sf)\n\n#--- visualize ---#\nggplot() +\n  geom_sf(data = ne_counties) +\n  geom_sf(data = wells_ne_sf) +\n  theme_void()"},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-8","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":8,"code":""},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-9","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":9,"code":""},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-10","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":10,"code":"#--- soybean yield ---#\ndata(soy_yield)\n\n#--- seed rate ---#\ndata(as_applied_s_rate)\n\n#--- visualize ---#\nggplot() +\n  geom_sf(data = soy_yield, size = 0.4, color = \"red\") +\n  geom_sf(data = as_applied_s_rate, size = 0.4, color = \"darkgreen\") +\n  theme_void()"},{"options":{"comment":"","results":"markup","fig-cap":"","editor-font-scale":"0.8","context":"interactive","editor-word-wrap":"true","out-width":"70%","editor-quick-suggestions":"false","warning":"true","editor-max-height":"","message":"true","classes":"","out-height":"","label":"unnamed-chunk-11","autorun":"false","read-only":"false","output":"true","fig-width":7,"dpi":72,"fig-height":5},"id":11,"code":""}];

</script><script type="module">
// Declare startupMessageQWebR globally
globalThis.qwebrStartupMessage = document.createElement("p");

// Verify if OffScreenCanvas is supported
globalThis.qwebrOffScreenCanvasSupport = function() {
  return typeof OffscreenCanvas !== 'undefined'
}

// Function to set the button text
globalThis.qwebrSetInteractiveButtonState = function(buttonText, enableCodeButton = true) {
  document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
    btn.innerHTML = buttonText;
    btn.disabled = !enableCodeButton;
  });
}

// Function to update the status message in non-interactive cells
globalThis.qwebrUpdateStatusMessage = function(message) {
  document.querySelectorAll(".qwebr-status-text.qwebr-cell-needs-evaluation").forEach((elem) => {
    elem.innerText = message;
  });
}

// Function to update the status message
globalThis.qwebrUpdateStatusHeader = function(message) {
  qwebrStartupMessage.innerHTML = `
    <i class="fa-solid fa-spinner fa-spin qwebr-icon-status-spinner"></i>
    <span>${message}</span>`;
}

// Function to return true if element is found, false if not
globalThis.qwebrCheckHTMLElementExists = function(selector) {
  const element = document.querySelector(selector);
  return !!element;
}

// Function that detects whether reveal.js slides are present
globalThis.qwebrIsRevealJS = function() {
  // If the '.reveal .slides' selector exists, RevealJS is likely present
  return qwebrCheckHTMLElementExists('.reveal .slides');
}

// Initialize the Quarto sidebar element
function qwebrSetupQuartoSidebar() {
  var newSideBarDiv = document.createElement('div');
  newSideBarDiv.id = 'quarto-margin-sidebar';
  newSideBarDiv.className = 'sidebar margin-sidebar';
  newSideBarDiv.style.top = '0px';
  newSideBarDiv.style.maxHeight = 'calc(0px + 100vh)';

  return newSideBarDiv;
}

// Position the sidebar in the document
function qwebrPlaceQuartoSidebar() {
  // Get the reference to the element with id 'quarto-document-content'
  var referenceNode = document.getElementById('quarto-document-content');

  // Create the new div element
  var newSideBarDiv = qwebrSetupQuartoSidebar();

  // Insert the new div before the 'quarto-document-content' element
  referenceNode.parentNode.insertBefore(newSideBarDiv, referenceNode);
}

function qwebrPlaceMessageContents(content, html_location = "title-block-header", revealjs_location = "title-slide") {

  // Get references to header elements
  const headerHTML = document.getElementById(html_location);
  const headerRevealJS = document.getElementById(revealjs_location);

  // Determine where to insert the quartoTitleMeta element
  if (headerHTML || headerRevealJS) {
    // Append to the existing "title-block-header" element or "title-slide" div
    (headerHTML || headerRevealJS).appendChild(content);
  } else {
    // If neither headerHTML nor headerRevealJS is found, insert after "webr-monaco-editor-init" script
    const monacoScript = document.getElementById("qwebr-monaco-editor-init");
    const header = document.createElement("header");
    header.setAttribute("id", "title-block-header");
    header.appendChild(content);
    monacoScript.after(header);
  }
}



function qwebrOffScreenCanvasSupportWarningMessage() {
  
  // Verify canvas is supported.
  if(qwebrOffScreenCanvasSupport()) return;

  // Create the main container div
  var calloutContainer = document.createElement('div');
  calloutContainer.classList.add('callout', 'callout-style-default', 'callout-warning', 'callout-titled');

  // Create the header div
  var headerDiv = document.createElement('div');
  headerDiv.classList.add('callout-header', 'd-flex', 'align-content-center');

  // Create the icon container div
  var iconContainer = document.createElement('div');
  iconContainer.classList.add('callout-icon-container');

  // Create the icon element
  var iconElement = document.createElement('i');
  iconElement.classList.add('callout-icon');

  // Append the icon element to the icon container
  iconContainer.appendChild(iconElement);

  // Create the title container div
  var titleContainer = document.createElement('div');
  titleContainer.classList.add('callout-title-container', 'flex-fill');
  titleContainer.innerText = 'Warning: Web Browser Does Not Support Graphing!';

  // Append the icon container and title container to the header div
  headerDiv.appendChild(iconContainer);
  headerDiv.appendChild(titleContainer);

  // Create the body container div
  var bodyContainer = document.createElement('div');
  bodyContainer.classList.add('callout-body-container', 'callout-body');

  // Create the paragraph element for the body content
  var paragraphElement = document.createElement('p');
  paragraphElement.innerHTML = 'This web browser does not have support for displaying graphs through the <code>quarto-webr</code> extension since it lacks an <code>OffScreenCanvas</code>. Please upgrade your web browser to one that supports <code>OffScreenCanvas</code>.';

  // Append the paragraph element to the body container
  bodyContainer.appendChild(paragraphElement);

  // Append the header div and body container to the main container div
  calloutContainer.appendChild(headerDiv);
  calloutContainer.appendChild(bodyContainer);

  // Append the main container div to the document depending on format
  qwebrPlaceMessageContents(calloutContainer, "title-block-header"); 

}


// Function that attaches the document status message and diagnostics
function displayStartupMessage(showStartupMessage, showHeaderMessage) {
  if (!showStartupMessage) {
    return;
  }

  // Create the outermost div element for metadata
  const quartoTitleMeta = document.createElement("div");
  quartoTitleMeta.classList.add("quarto-title-meta");

  // Create the first inner div element
  const firstInnerDiv = document.createElement("div");
  firstInnerDiv.setAttribute("id", "qwebr-status-message-area");

  // Create the second inner div element for "WebR Status" heading and contents
  const secondInnerDiv = document.createElement("div");
  secondInnerDiv.setAttribute("id", "qwebr-status-message-title");
  secondInnerDiv.classList.add("quarto-title-meta-heading");
  secondInnerDiv.innerText = "WebR Status";

  // Create another inner div for contents
  const secondInnerDivContents = document.createElement("div");
  secondInnerDivContents.setAttribute("id", "qwebr-status-message-body");
  secondInnerDivContents.classList.add("quarto-title-meta-contents");

  // Describe the WebR state
  qwebrStartupMessage.innerText = "🟡 Loading...";
  qwebrStartupMessage.setAttribute("id", "qwebr-status-message-text");
  // Add `aria-live` to auto-announce the startup status to screen readers
  qwebrStartupMessage.setAttribute("aria-live", "assertive");

  // Append the startup message to the contents
  secondInnerDivContents.appendChild(qwebrStartupMessage);

  // Add a status indicator for COOP and COEP Headers if needed
  if (showHeaderMessage) {
    const crossOriginMessage = document.createElement("p");
    crossOriginMessage.innerText = `${crossOriginIsolated ? '🟢' : '🟡'} COOP & COEP Headers`;
    crossOriginMessage.setAttribute("id", "qwebr-coop-coep-header");
    secondInnerDivContents.appendChild(crossOriginMessage);
  }

  // Combine the inner divs and contents
  firstInnerDiv.appendChild(secondInnerDiv);
  firstInnerDiv.appendChild(secondInnerDivContents);
  quartoTitleMeta.appendChild(firstInnerDiv);

  // Place message on webpage
  qwebrPlaceMessageContents(quartoTitleMeta); 
}

function qwebrAddCommandHistoryModal() {
  // Create the modal div
  var modalDiv = document.createElement('div');
  modalDiv.id = 'qwebr-history-modal';
  modalDiv.className = 'qwebr-modal';

  // Create the modal content div
  var modalContentDiv = document.createElement('div');
  modalContentDiv.className = 'qwebr-modal-content';

  // Create the span for closing the modal
  var closeSpan = document.createElement('span');
  closeSpan.id = 'qwebr-command-history-close-btn';
  closeSpan.className = 'qwebr-modal-close';
  closeSpan.innerHTML = '&times;';

  // Create the h1 element for the modal
  var modalH1 = document.createElement('h1');
  modalH1.textContent = 'R History Command Contents';

  // Create an anchor element for downloading the Rhistory file 
  var downloadLink = document.createElement('a');
  downloadLink.href = '#';
  downloadLink.id = 'qwebr-download-history-btn';
  downloadLink.className = 'qwebr-download-btn';

  // Create an 'i' element for the icon
  var icon = document.createElement('i');
  icon.className = 'bi bi-file-code';

  // Append the icon to the anchor element
  downloadLink.appendChild(icon);

  // Add the text 'Download R History' to the anchor element
  downloadLink.appendChild(document.createTextNode(' Download R History File'));

  // Create the pre for command history contents
  var commandContentsPre = document.createElement('pre');
  commandContentsPre.id = 'qwebr-command-history-contents';
  commandContentsPre.className = 'qwebr-modal-content-code';

  // Append the close span, h1, and history contents pre to the modal content div
  modalContentDiv.appendChild(closeSpan);
  modalContentDiv.appendChild(modalH1);
  modalContentDiv.appendChild(downloadLink);
  modalContentDiv.appendChild(commandContentsPre);

  // Append the modal content div to the modal div
  modalDiv.appendChild(modalContentDiv);

  // Append the modal div to the body
  document.body.appendChild(modalDiv);
}

function qwebrRegisterRevealJSCommandHistoryModal() {
  // Select the <ul> element inside the <div> with data-panel="Custom0"
  let ulElement = document.querySelector('div[data-panel="Custom0"] > ul.slide-menu-items');

  // Find the last <li> element with class slide-tool-item
  let lastItem = ulElement.querySelector('li.slide-tool-item:last-child');

  // Calculate the next data-item value
  let nextItemValue = 0;
  if (lastItem) {
      nextItemValue = parseInt(lastItem.dataset.item) + 1;
  }

  // Create a new <li> element
  let newListItem = document.createElement('li');
  newListItem.className = 'slide-tool-item';
  newListItem.dataset.item = nextItemValue.toString(); // Set the next available data-item value

  // Create the <a> element inside the <li>
  let newLink = document.createElement('a');
  newLink.href = '#';
  newLink.id = 'qwebrRHistoryButton'; // Set the ID for the new link
  
  // Create the <kbd> element inside the <a>
  let newKbd = document.createElement('kbd');
  newKbd.textContent = ' '; // Set to empty as we are not registering a keyboard shortcut

  // Create text node for the link text
  let newText = document.createTextNode(' View R History');

  // Append <kbd> and text node to <a>
  newLink.appendChild(newKbd);
  newLink.appendChild(newText);

  // Append <a> to <li>
  newListItem.appendChild(newLink);

  // Append <li> to <ul>
  ulElement.appendChild(newListItem);
}

// Handle setting up the R history modal
function qwebrCodeLinks() {

  if (qwebrIsRevealJS()) {
    qwebrRegisterRevealJSCommandHistoryModal();
    return;
  }

  // Create the container div
  var containerDiv = document.createElement('div');
  containerDiv.className = 'quarto-code-links';

  // Create the h2 element
  var h2 = document.createElement('h2');
  h2.textContent = 'webR Code Links';

  // Create the ul element
  var ul = document.createElement('ul');

  // Create the li element
  var li = document.createElement('li');

  // Create the a_history_btn element
  var a_history_btn = document.createElement('a');
  a_history_btn.href = 'javascript:void(0)';
  a_history_btn.setAttribute('id', 'qwebrRHistoryButton');

  // Create the i_history_btn element
  var i_history_btn = document.createElement('i');
  i_history_btn.className = 'bi bi-file-code';

  // Create the text node for the link text
  var text_history_btn = document.createTextNode('View R History');

  // Append the icon element and link text to the a element
  a_history_btn.appendChild(i_history_btn);
  a_history_btn.appendChild(text_history_btn);

  // Append the a element to the li element
  li.appendChild(a_history_btn);

  // Append the li element to the ul element
  ul.appendChild(li);

  // Append the h2 and ul elements to the container div
  containerDiv.appendChild(h2);
  containerDiv.appendChild(ul);

  // Append the container div to the element with the ID 'quarto-margin-sidebar'
  var sidebar = document.getElementById('quarto-margin-sidebar');
    
  // If the sidebar element is not found, create it
  if(!sidebar) {
    qwebrPlaceQuartoSidebar();
  }
  
  // Re-select the sidebar element (if it was just created)
  sidebar = document.getElementById('quarto-margin-sidebar');   


  // If the sidebar element exists, append the container div to it
  if(sidebar) {
    // Append the container div to the sidebar
    sidebar.appendChild(containerDiv);
    // Force the sidebar to be clickable by removing the 'zindex-bottom' class
    // added in pre-release: https://github.com/quarto-dev/quarto-cli/commit/f0c53a1ffcaa1de4eccbf07803b096898248adcc
    sidebar.className = 'sidebar margin-sidebar';
  } else {
    // Get a debugger ...
    console.warn('Element with ID "quarto-margin-sidebar" not found.');
  }
}

// Call the function to append the code links for qwebR into the right sidebar
qwebrCodeLinks();

// Add the command history modal
qwebrAddCommandHistoryModal();

displayStartupMessage(qwebrShowStartupMessage, qwebrShowHeaderMessage);
qwebrOffScreenCanvasSupportWarningMessage();
</script><script type="module">
// Define a global storage and retrieval solution ----

// Store commands executed in R
globalThis.qwebrRCommandHistory = [];

// Function to retrieve the command history
globalThis.qwebrFormatRHistory = function() {
   return qwebrRCommandHistory.join("\n\n");
}

// Retrieve HTML Elements ----

// Get the command modal
const command_history_modal = document.getElementById("qwebr-history-modal");

// Get the button that opens the command modal
const command_history_btn = document.getElementById("qwebrRHistoryButton");

// Get the <span> element that closes the command modal
const command_history_close_span = document.getElementById("qwebr-command-history-close-btn");

// Get the download button for r history information
const command_history_download_btn = document.getElementById("qwebr-download-history-btn");

// Plug in command history into modal/download button ----

// Function to populate the modal with command history
function populateCommandHistoryModal() {
    document.getElementById("qwebr-command-history-contents").innerHTML = qwebrFormatRHistory() || "No commands have been executed yet.";
}

// Function to format the current date and time to
// a string with the format YYYY-MM-DD-HH-MM-SS
function formatDateTime() {
    const now = new Date();

    const year = now.getFullYear();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are zero-based
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day}-${hours}-${minutes}-${seconds}`;
}


// Function to convert document title with datetime to a safe filename
function safeFileName() {
    // Get the current page title
    let pageTitle = document.title;

    // Combine the current page title with the current date and time
    let pageNameWithDateTime = `Rhistory-${pageTitle}-${formatDateTime()}`;

    // Replace unsafe characters with safe alternatives
    let safeFilename = pageNameWithDateTime.replace(/[\\/:\*\?! "<>\|]/g, '-');

    return safeFilename;
}


// Function to download list contents as text file
function downloadRHistory() {
    // Get the current page title + datetime and use it as the filename
    const filename = `${safeFileName()}.R`;

    // Get the text contents of the R History list
    const text = qwebrFormatRHistory();

    // Create a new Blob object with the text contents
    const blob = new Blob([text], { type: 'text/plain' });
  
    // Create a new anchor element for the download
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = URL.createObjectURL(blob);
    a.download = filename;

    // Append the anchor to the body, click it, and remove it
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Register event handlers ----

// When the user clicks the View R History button, open the command modal
command_history_btn.onclick = function() {
    populateCommandHistoryModal();
    command_history_modal.style.display = "block";
}

// When the user clicks on <span> (x), close the command modal
command_history_close_span.onclick = function() {
    command_history_modal.style.display = "none";
}

// When the user clicks anywhere outside of the command modal, close it
window.onclick = function(event) {
    if (event.target == command_history_modal) {
        command_history_modal.style.display = "none";
    }
}

// Add an onclick event listener to the download button so that
// the user can download the R history as a text file
command_history_download_btn.onclick = function() {
    downloadRHistory();
};
</script><script type="module">
// Supported Evaluation Types for Context
globalThis.EvalTypes = Object.freeze({
  Interactive: 'interactive',
  Setup: 'setup',
  Output: 'output',
});

// Function that obtains the font size for a given element 
globalThis.qwebrCurrentFontSizeOnElement = function(element, cssProperty = 'font-size') {

  const currentFontSize = parseFloat(
    window
    .getComputedStyle(element)
    .getPropertyValue(cssProperty)
  );
  
  return currentFontSize;
}

// Function to determine font scaling
globalThis.qwebrScaledFontSize = function(div, qwebrOptions) {
  // Determine if we should compute font-size using RevealJS's `--r-main-font-size` 
  // or if we can directly use the document's `font-size`.
  const cssProperty = document.body.classList.contains('reveal') ? 
    "--r-main-font-size" : "font-size";
  
  // Get the current font size on the div element
  const elementFontSize = qwebrCurrentFontSizeOnElement(div, cssProperty);

  // Determine the scaled font size value
  const scaledFontSize = ((qwebrOptions['editor-font-scale'] ?? 1) * elementFontSize) ?? 17.5;

  return scaledFontSize;
}


// Function that dispatches the creation request
globalThis.qwebrCreateHTMLElement = function (
  cellData
) {

  // Extract key components
  const evalType = cellData.options.context;
  const qwebrCounter = cellData.id;

  // We make an assumption that insertion points are defined by the Lua filter as:
  // qwebr-insertion-location-{qwebrCounter} 
  const elementLocator = document.getElementById(`qwebr-insertion-location-${qwebrCounter}`);

  // Figure out the routine to use to insert the element.
  let qwebrElement;
  switch ( evalType ) {
    case EvalTypes.Interactive:
      qwebrElement = qwebrCreateInteractiveElement(qwebrCounter, cellData.options);
      break;
    case EvalTypes.Output: 
      qwebrElement = qwebrCreateNonInteractiveOutputElement(qwebrCounter, cellData.options);
      break;
    case EvalTypes.Setup: 
      qwebrElement = qwebrCreateNonInteractiveSetupElement(qwebrCounter, cellData.options);
      break;
    default: 
      qwebrElement = document.createElement('div');
      qwebrElement.textContent = 'Error creating `quarto-webr` element';
  }

  // Insert the dynamically generated object at the document location.
  elementLocator.appendChild(qwebrElement);
};

// Function that setups the interactive element creation
globalThis.qwebrCreateInteractiveElement = function (qwebrCounter, qwebrOptions) {

  // Create main div element
  var mainDiv = document.createElement('div');
  mainDiv.id = 'qwebr-interactive-area-' + qwebrCounter;
  mainDiv.className = `qwebr-interactive-area`;
  if (qwebrOptions.classes) {
    mainDiv.className += " " + qwebrOptions.classes
  }

  // Add a unique cell identifier that users can customize
  if (qwebrOptions.label) {
    mainDiv.setAttribute('data-id', qwebrOptions.label);
  }

  // Create toolbar div
  var toolbarDiv = document.createElement('div');
  toolbarDiv.className = 'qwebr-editor-toolbar';
  toolbarDiv.id = 'qwebr-editor-toolbar-' + qwebrCounter;

  // Create a div to hold the left buttons
  var leftButtonsDiv = document.createElement('div');
  leftButtonsDiv.className = 'qwebr-editor-toolbar-left-buttons';

  // Create a div to hold the right buttons
  var rightButtonsDiv = document.createElement('div');
  rightButtonsDiv.className = 'qwebr-editor-toolbar-right-buttons';

  // Create Run Code button
  var runCodeButton = document.createElement('button');
  runCodeButton.className = 'btn btn-default qwebr-button qwebr-button-run';
  runCodeButton.disabled = true;
  runCodeButton.type = 'button';
  runCodeButton.id = 'qwebr-button-run-' + qwebrCounter;
  runCodeButton.textContent = '🟡 Loading webR...';
  runCodeButton.title = `Run code (Shift + Enter)`;

  // Append buttons to the leftButtonsDiv
  leftButtonsDiv.appendChild(runCodeButton);

  // Create Reset button
  var resetButton = document.createElement('button');
  resetButton.className = 'btn btn-light btn-xs qwebr-button qwebr-button-reset';
  resetButton.type = 'button';
  resetButton.id = 'qwebr-button-reset-' + qwebrCounter;
  resetButton.title = 'Start over';
  resetButton.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i>';

  // Create Copy button
  var copyButton = document.createElement('button');
  copyButton.className = 'btn btn-light btn-xs qwebr-button qwebr-button-copy';
  copyButton.type = 'button';
  copyButton.id = 'qwebr-button-copy-' + qwebrCounter;
  copyButton.title = 'Copy code';
  copyButton.innerHTML = '<i class="fa-regular fa-copy"></i>';

  // Append buttons to the rightButtonsDiv
  rightButtonsDiv.appendChild(resetButton);
  rightButtonsDiv.appendChild(copyButton);

  // Create console area div
  var consoleAreaDiv = document.createElement('div');
  consoleAreaDiv.id = 'qwebr-console-area-' + qwebrCounter;
  consoleAreaDiv.className = 'qwebr-console-area';

  // Create editor div
  var editorDiv = document.createElement('div');
  editorDiv.id = 'qwebr-editor-' + qwebrCounter;
  editorDiv.className = 'qwebr-editor';

  // Create output code area div
  var outputCodeAreaDiv = document.createElement('div');
  outputCodeAreaDiv.id = 'qwebr-output-code-area-' + qwebrCounter;
  outputCodeAreaDiv.className = 'qwebr-output-code-area';
  outputCodeAreaDiv.setAttribute('aria-live', 'assertive');

  // Create pre element inside output code area
  var preElement = document.createElement('pre');
  preElement.style.visibility = 'hidden';
  outputCodeAreaDiv.appendChild(preElement);

  // Create output graph area div
  var outputGraphAreaDiv = document.createElement('div');
  outputGraphAreaDiv.id = 'qwebr-output-graph-area-' + qwebrCounter;
  outputGraphAreaDiv.className = 'qwebr-output-graph-area';

  // Append buttons to the toolbar
  toolbarDiv.appendChild(leftButtonsDiv);
  toolbarDiv.appendChild(rightButtonsDiv);

  // Append all elements to the main div
  mainDiv.appendChild(toolbarDiv);
  consoleAreaDiv.appendChild(editorDiv);
  consoleAreaDiv.appendChild(outputCodeAreaDiv);
  mainDiv.appendChild(consoleAreaDiv);
  mainDiv.appendChild(outputGraphAreaDiv);

  return mainDiv;
}

// Function that adds output structure for non-interactive output
globalThis.qwebrCreateNonInteractiveOutputElement = function(qwebrCounter, qwebrOptions) {
  // Create main div element
  var mainDiv = document.createElement('div');
  mainDiv.id = 'qwebr-noninteractive-area-' + qwebrCounter;
  mainDiv.className = `qwebr-noninteractive-area`;
  if (qwebrOptions.classes) {
    mainDiv.className += " " + qwebrOptions.classes
  }
  
  // Add a unique cell identifier that users can customize
  if (qwebrOptions.label) {
    mainDiv.setAttribute('data-id', qwebrOptions.label);
  }
  
  // Create a status container div
  var statusContainer = createLoadingContainer(qwebrCounter);

  // Create output code area div
  var outputCodeAreaDiv = document.createElement('div');
  outputCodeAreaDiv.id = 'qwebr-output-code-area-' + qwebrCounter;
  outputCodeAreaDiv.className = 'qwebr-output-code-area';
  outputCodeAreaDiv.setAttribute('aria-live', 'assertive');

  // Create pre element inside output code area
  var preElement = document.createElement('pre');
  preElement.style.visibility = 'hidden';
  outputCodeAreaDiv.appendChild(preElement);

  // Create output graph area div
  var outputGraphAreaDiv = document.createElement('div');
  outputGraphAreaDiv.id = 'qwebr-output-graph-area-' + qwebrCounter;
  outputGraphAreaDiv.className = 'qwebr-output-graph-area';

  // Append all elements to the main div
  mainDiv.appendChild(statusContainer);
  mainDiv.appendChild(outputCodeAreaDiv);
  mainDiv.appendChild(outputGraphAreaDiv);

  return mainDiv;
};

// Function that adds a stub in the page to indicate a setup cell was used.
globalThis.qwebrCreateNonInteractiveSetupElement = function(qwebrCounter, qwebrOptions) {
  // Create main div element
  var mainDiv = document.createElement('div');
  mainDiv.id = `qwebr-noninteractive-setup-area-${qwebrCounter}`;
  mainDiv.className = `qwebr-noninteractive-setup-area`;
  if (qwebrOptions.classes) {
    mainDiv.className += " " + qwebrOptions.classes
  }


  // Add a unique cell identifier that users can customize
  if (qwebrOptions.label) {
    mainDiv.setAttribute('data-id', qwebrOptions.label);
  }

  // Create a status container div
  var statusContainer = createLoadingContainer(qwebrCounter);

  // Append status onto the main div
  mainDiv.appendChild(statusContainer);

  return mainDiv;
}


// Function to create loading container with specified ID
globalThis.createLoadingContainer = function(qwebrCounter) {

  // Create a status container
  const container = document.createElement('div');
  container.id = `qwebr-non-interactive-loading-container-${qwebrCounter}`;
  container.className = 'qwebr-non-interactive-loading-container qwebr-cell-needs-evaluation';

  // Create an R project logo to indicate its a code space
  const rProjectIcon = document.createElement('i');
  rProjectIcon.className = 'fa-brands fa-r-project fa-3x qwebr-r-project-logo';

  // Setup a loading icon from font awesome
  const spinnerIcon = document.createElement('i');
  spinnerIcon.className = 'fa-solid fa-spinner fa-spin fa-1x qwebr-icon-status-spinner';

  // Add a section for status text
  const statusText = document.createElement('p');
  statusText.id = `qwebr-status-text-${qwebrCounter}`;
  statusText.className = `qwebr-status-text qwebr-cell-needs-evaluation`;
  statusText.innerText = 'Loading webR...';

  // Incorporate an inner container
  const innerContainer = document.createElement('div');

  // Append elements to the inner container
  innerContainer.appendChild(spinnerIcon);
  innerContainer.appendChild(statusText);

  // Append elements to the main container
  container.appendChild(rProjectIcon);
  container.appendChild(innerContainer);

  return container;
}
</script><script type="module">
// Function to install a single package
async function qwebrInstallRPackage(packageName) {
  await mainWebR.evalRVoid(`webr::install('${packageName}');`);
}

// Function to load a single package
async function qwebrLoadRPackage(packageName) {
  await mainWebR.evalRVoid(`require('${packageName}', quietly = TRUE)`);
}

// Generic function to process R packages
async function qwebrProcessRPackagesWithStatus(packages, processType, displayStatusMessageUpdate = true) {
  // Switch between contexts
  const messagePrefix = processType === 'install' ? 'Installing' : 'Loading';

  // Modify button state
  qwebrSetInteractiveButtonState(`🟡 ${messagePrefix} package ...`, false);

  // Iterate over packages
  for (let i = 0; i < packages.length; i++) {
    const activePackage = packages[i];
    const formattedMessage = `${messagePrefix} package ${i + 1} out of ${packages.length}: ${activePackage}`;

    // Display the update in header
    if (displayStatusMessageUpdate) {
      qwebrUpdateStatusHeader(formattedMessage);
    }

    // Display the update in non-active areas
    qwebrUpdateStatusMessage(formattedMessage);

    // Run package installation
    if (processType === 'install') {
      await qwebrInstallRPackage(activePackage);
    } else {
      await qwebrLoadRPackage(activePackage);
    }
  }

  // Clean slate
  if (processType === 'load') {
    await mainWebR.flush();
  }
}

// Start a timer
const initializeWebRTimerStart = performance.now();

// Encase with a dynamic import statement
globalThis.qwebrInstance = import(qwebrCustomizedWebROptions.baseURL + "webr.mjs").then(
  async ({ WebR, ChannelType }) => {
    // Populate WebR options with defaults or new values based on `webr` meta
    globalThis.mainWebR = new WebR(qwebrCustomizedWebROptions);

    // Initialization WebR
    await mainWebR.init();

    // Setup a shelter
    globalThis.mainWebRCodeShelter = await new mainWebR.Shelter();

    // Setup a pager to allow processing help documentation 
    await mainWebR.evalRVoid('webr::pager_install()'); 

    // Override the existing install.packages() to use webr::install()
    await mainWebR.evalRVoid('webr::shim_install()'); 

    // Specify the repositories to pull from
    // Note: webR does not use the `repos` option, but instead uses `webr_pkg_repos`
    // inside of `install()`. However, other R functions still pull from `repos`.
    await mainWebR.evalRVoid(`
      options(
        webr_pkg_repos = c(${qwebrPackageRepoURLS.map(repoURL => `'${repoURL}'`).join(',')}),
        repos = c(${qwebrPackageRepoURLS.map(repoURL => `'${repoURL}'`).join(',')})
      )
    `);

    // Check to see if any packages need to be installed
    if (qwebrSetupRPackages) {
      // Obtain only a unique list of packages
      const uniqueRPackageList = Array.from(new Set(qwebrInstallRPackagesList));

      // Install R packages one at a time (either silently or with a status update)
      await qwebrProcessRPackagesWithStatus(uniqueRPackageList, 'install', qwebrShowStartupMessage);

      if (qwebrAutoloadRPackages) {
        // Load R packages one at a time (either silently or with a status update)
        await qwebrProcessRPackagesWithStatus(uniqueRPackageList, 'load', qwebrShowStartupMessage);
      }
    }
  }
);

// Stop timer
const initializeWebRTimerEnd = performance.now();

</script><script type="module">
// Function to verify a given JavaScript Object is empty
globalThis.qwebrIsObjectEmpty = function (arr) {
    return Object.keys(arr).length === 0;
}

// Global version of the Escape HTML function that converts HTML 
// characters to their HTML entities.
globalThis.qwebrEscapeHTMLCharacters = function(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  };

// Passthrough results
globalThis.qwebrIdentity = function(x) {
    return x;
};

// Append a comment
globalThis.qwebrPrefixComment = function(x, comment) {
    return `${comment}${x}`;
};

// Function to store the code in the history
globalThis.qwebrLogCodeToHistory = function(codeToRun, options) {
    qwebrRCommandHistory.push(
        `# Ran code in ${options.label} at ${new Date().toLocaleString()} ----\n${codeToRun}`
    );
}

// Function to attach a download button onto the canvas
// allowing the user to download the image.
function qwebrImageCanvasDownloadButton(canvas, canvasContainer) {

    // Create the download button
    const downloadButton = document.createElement('button');
    downloadButton.className = 'qwebr-canvas-image-download-btn';
    downloadButton.textContent = 'Download Image';
    canvasContainer.appendChild(downloadButton);

    // Trigger a download of the image when the button is clicked
    downloadButton.addEventListener('click', function() {
        const image = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = image;
        link.download = 'qwebr-canvas-image.png';
        link.click();
    });
  }
  

// Function to parse the pager results
globalThis.qwebrParseTypePager = async function (msg) { 

    // Split out the event data
    const { path, title, deleteFile } = msg.data; 

    // Process the pager data by reading the information from disk
    const paged_data = await mainWebR.FS.readFile(path).then((data) => {
        // Obtain the file content
        let content = new TextDecoder().decode(data);

        // Remove excessive backspace characters until none remain
        while(content.match(/.[\b]/)){
        content = content.replace(/.[\b]/g, '');
        }

        // Returned cleaned data
        return content;
    });

    // Unlink file if needed
    if (deleteFile) { 
        await mainWebR.FS.unlink(path); 
    } 

    // Return extracted data with spaces
    return paged_data;
} 

// Function to run the code using webR and parse the output
globalThis.qwebrComputeEngine = async function(
    codeToRun, 
    elements, 
    options) {

    // Call into the R compute engine that persists within the document scope.
    // To be prepared for all scenarios, the following happens: 
    // 1. We setup a canvas device to write to by making a namespace call into the {webr} package
    // 2. We use values inside of the options array to set the figure size.
    // 3. We capture the output stream information (STDOUT and STERR)
    // 4. We disable the current device's image creation.
    // 5. Piece-wise parse the results into the different output areas

    // Create a pager variable for help/file contents
    let pager = [];

    // Handle how output is processed
    let showMarkup = options.results === "markup" && options.output !== "asis";
    let processOutput;

    if (showMarkup) {
        processOutput = qwebrEscapeHTMLCharacters;
    } else {
        processOutput = qwebrIdentity;
    }

    // ---- 
    // Convert from Inches to Pixels by using DPI (dots per inch)
    // for bitmap devices (dpi * inches = pixels)
    let fig_width = options["fig-width"] * options["dpi"]
    let fig_height = options["fig-height"] * options["dpi"]

    // Initialize webR
    await mainWebR.init();

    // Configure capture output
    let captureOutputOptions = {
        withAutoprint: true,
        captureStreams: true,
        captureConditions: false,
        // env: webR.objs.emptyEnv, // maintain a global environment for webR v0.2.0
    };
    
    // Determine if the browser supports OffScreen
    if (qwebrOffScreenCanvasSupport()) {
        // Mirror default options of webr::canvas()
        // with changes to figure height and width.
        captureOutputOptions.captureGraphics = {
            width: fig_width,
            height: fig_height,
            bg: "white", // default: transparent
            pointsize: 12,
            capture: true
        };
    }  else {
        // Disable generating graphics
        captureOutputOptions.captureGraphics = false;
    }

    // Store the code to run in history
    qwebrLogCodeToHistory(codeToRun, options);

    // Setup a webR canvas by making a namespace call into the {webr} package
    // Evaluate the R code
    // Remove the active canvas silently
    const result = await mainWebRCodeShelter.captureR(
        `${codeToRun}`,
        captureOutputOptions
    );

    // -----

    // Start attempting to parse the result data
    processResultOutput:try {
        
        // Avoid running through output processing
        if (options.results === "hide" || options.output === "false") { 
            break processResultOutput; 
        }

        // Merge output streams of STDOUT and STDErr (messages and errors are combined.)
        // Require both `warning` and `message` to be true to display `STDErr`. 
        const out = result.output
        .filter(
            evt => evt.type === "stdout" || 
            ( evt.type === "stderr" && (options.warning === "true" && options.message === "true")) 
        )
        .map((evt, index) => {
            const className = `qwebr-output-code-${evt.type}`;
            const outputResult = qwebrPrefixComment(processOutput(evt.data), options.comment);
            return `<code id="${className}-editor-${elements.id}-result-${index + 1}" class="${className}">${outputResult}</code>`;
        })
        .join("\n");


        // Clean the state
        // We're now able to process pager events.
        // As a result, we cannot maintain a true 1-to-1 output order 
        // without individually feeding each line
        const msgs = await mainWebR.flush();

        // Use `map` to process the filtered "pager" events asynchronously
        const pager = await Promise.all(
            msgs.filter(msg => msg.type === 'pager').map(
                async (msg) => {
                    return await qwebrParseTypePager(msg);
                }
            )
        );

        // Nullify the output area of content
        elements.outputCodeDiv.innerHTML = "";
        elements.outputGraphDiv.innerHTML = "";

        // Design an output object for messages
        const pre = document.createElement("pre");
        if (/\S/.test(out)) {
            // Display results as HTML elements to retain output styling
            const div = document.createElement("div");
            div.innerHTML = out;

            // Calculate a scaled font-size value
            const scaledFontSize = qwebrScaledFontSize(
                elements.outputCodeDiv, options);

            // Override output code cell size
            pre.style.fontSize = `${scaledFontSize}px`;
            pre.appendChild(div);
        } else {
            // If nothing is present, hide the element.
            pre.style.visibility = "hidden";
        }

        elements.outputCodeDiv.appendChild(pre);

        // Determine if we have graphs to display
        if (result.images.length > 0) {

            // Create figure element
            const figureElement = document.createElement("figure");
            figureElement.className = "qwebr-canvas-image";

            // Place each rendered graphic onto a canvas element
            result.images.forEach((img) => {

                // Construct canvas for object
                const canvas = document.createElement("canvas");

                // Add an image download button
                qwebrImageCanvasDownloadButton(canvas, figureElement);

                // Set canvas size to image
                canvas.width = img.width;
                canvas.height = img.height;

                // Apply output truncations
                canvas.style.width = options["out-width"] ? options["out-width"] : `${fig_width}px`;
                if (options["out-height"]) {
                    canvas.style.height = options["out-height"];
                }

                // Apply styling
                canvas.style.display = "block";
                canvas.style.margin = "auto";

                // Draw image onto Canvas
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, img.width, img.height);
          
                // Append canvas to figure output area
                figureElement.appendChild(canvas);

            });
            
            if (options['fig-cap']) {
                // Create figcaption element
                const figcaptionElement = document.createElement('figcaption');
                figcaptionElement.innerText = options['fig-cap'];
                // Append figcaption to figure
                figureElement.appendChild(figcaptionElement);    
            }
        
            elements.outputGraphDiv.appendChild(figureElement);

        }

        // Display the pager data
        if (pager) {
        // Use the `pre` element to preserve whitespace.
        pager.forEach((paged_data, index) => {
            let pre_pager = document.createElement("pre");
            pre_pager.innerText = paged_data;
            pre_pager.classList.add("qwebr-output-code-pager");
            pre_pager.setAttribute("id", `qwebr-output-code-pager-editor-${elements.id}-result-${index + 1}`);
            elements.outputCodeDiv.appendChild(pre_pager);
        });
        }
    } finally {
        // Clean up the remaining code
        mainWebRCodeShelter.purge();
    }
}

// Function to execute the code (accepts code as an argument)
globalThis.qwebrExecuteCode = async function (
    codeToRun,
    id,
    options = {}) {

    // If options are not passed, we fall back on the bare minimum to handle the computation
    if (qwebrIsObjectEmpty(options)) {
        options = { 
            "context": "interactive", 
            "fig-width": 7, "fig-height": 5, 
            "out-width": "700px", "out-height": "", 
            "dpi": 72,
            "results": "markup", 
            "warning": "true", "message": "true",
        };
    }

    // Next, we access the compute areas values
    const elements = {
        runButton: document.getElementById(`qwebr-button-run-${id}`),
        outputCodeDiv: document.getElementById(`qwebr-output-code-area-${id}`),
        outputGraphDiv: document.getElementById(`qwebr-output-graph-area-${id}`),
        id: id,
    }

    // Disallowing execution of other code cells
    document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
        btn.disabled = true;
    });

    if (options.context == EvalTypes.Interactive) {
        // Emphasize the active code cell
        elements.runButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin qwebr-icon-status-spinner"></i> <span>Run Code</span>';
    }

    // Evaluate the code and parse the output into the document
    await qwebrComputeEngine(codeToRun, elements, options);

    // Switch to allowing execution of code
    document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
        btn.disabled = false;
    });

    if (options.context == EvalTypes.Interactive) {
        // Revert to the initial code cell state
        elements.runButton.innerHTML = '<i class="fa-solid fa-play qwebr-icon-run-code"></i> <span>Run Code</span>';
    }
}

</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../style.css">
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-VectorDataBasics.html">Foundations</a></li><li class="breadcrumb-item"><a href="../chapters/03-SpatialInteractionVectorVector.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">R as GIS for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/R-as-GIS-for-Economists" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/00-preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Demonstrations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-Demonstration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-VectorDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-SpatialInteractionVectorVector.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-RasterDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-SpatialInteractionVectorRaster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Extensions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-stars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-CreateMaps-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-DownloadSpatialData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">(slightly) Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-SpeedThingsUp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-ParallelComputing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Loop and Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-ggplot2-appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">ggplot2 minimals</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#before-you-start" id="toc-before-you-start" class="nav-link active" data-scroll-target="#before-you-start">Before you start</a>
  <ul class="collapse">
<li><a href="#direction-for-replication" id="toc-direction-for-replication" class="nav-link" data-scroll-target="#direction-for-replication">Direction for replication</a></li>
  </ul>
</li>
  <li>
<a href="#sec-topo" id="toc-sec-topo" class="nav-link" data-scroll-target="#sec-topo"><span class="header-section-number">3.1</span> Topological relations</a>
  <ul class="collapse">
<li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">3.1.1</span> Data preparation</a></li>
  <li><a href="#sfst_intersects" id="toc-sfst_intersects" class="nav-link" data-scroll-target="#sfst_intersects"><span class="header-section-number">3.1.2</span> <code>sf::st_intersects()</code></a></li>
  <li><a href="#sfst_is_within_distance" id="toc-sfst_is_within_distance" class="nav-link" data-scroll-target="#sfst_is_within_distance"><span class="header-section-number">3.1.3</span> <code>sf::st_is_within_distance()</code></a></li>
  </ul>
</li>
  <li>
<a href="#spatial-cropping" id="toc-spatial-cropping" class="nav-link" data-scroll-target="#spatial-cropping"><span class="header-section-number">3.2</span> Spatial cropping</a>
  <ul class="collapse">
<li><a href="#data-preparation-1" id="toc-data-preparation-1" class="nav-link" data-scroll-target="#data-preparation-1"><span class="header-section-number">3.2.1</span> Data preparation</a></li>
  <li><a href="#bounding-box" id="toc-bounding-box" class="nav-link" data-scroll-target="#bounding-box"><span class="header-section-number">3.2.2</span> Bounding box</a></li>
  <li><a href="#spatial-cropping-1" id="toc-spatial-cropping-1" class="nav-link" data-scroll-target="#spatial-cropping-1"><span class="header-section-number">3.2.3</span> Spatial cropping</a></li>
  </ul>
</li>
  <li>
<a href="#sec-sf-subset" id="toc-sec-sf-subset" class="nav-link" data-scroll-target="#sec-sf-subset"><span class="header-section-number">3.3</span> Spatial subsetting</a>
  <ul class="collapse">
<li><a href="#polygons-source-vs-polygons-target" id="toc-polygons-source-vs-polygons-target" class="nav-link" data-scroll-target="#polygons-source-vs-polygons-target"><span class="header-section-number">3.3.1</span> polygons (source) vs polygons (target)</a></li>
  <li><a href="#points-source-vs-polygons-target" id="toc-points-source-vs-polygons-target" class="nav-link" data-scroll-target="#points-source-vs-polygons-target"><span class="header-section-number">3.3.2</span> points (source) vs polygons (target)</a></li>
  <li><a href="#sec-lines_polygons" id="toc-sec-lines_polygons" class="nav-link" data-scroll-target="#sec-lines_polygons"><span class="header-section-number">3.3.3</span> lines (source) vs polygons (target)</a></li>
  <li><a href="#sec-polygons_points" id="toc-sec-polygons_points" class="nav-link" data-scroll-target="#sec-polygons_points"><span class="header-section-number">3.3.4</span> polygons (source) vs points (target)</a></li>
  </ul>
</li>
  <li>
<a href="#sec-sp-join" id="toc-sec-sp-join" class="nav-link" data-scroll-target="#sec-sp-join"><span class="header-section-number">3.4</span> Spatial join</a>
  <ul class="collapse">
<li><a href="#syntax" id="toc-syntax" class="nav-link" data-scroll-target="#syntax"><span class="header-section-number">3.4.1</span> Syntax</a></li>
  <li><a href="#case-1-points-target-vs-polygons-source" id="toc-case-1-points-target-vs-polygons-source" class="nav-link" data-scroll-target="#case-1-points-target-vs-polygons-source"><span class="header-section-number">3.4.2</span> Case 1: points (target) vs polygons (source)</a></li>
  <li><a href="#sec-polygons-points" id="toc-sec-polygons-points" class="nav-link" data-scroll-target="#sec-polygons-points"><span class="header-section-number">3.4.3</span> Case 2: polygons (target) vs points (source)</a></li>
  <li><a href="#sec-polygon-polygon" id="toc-sec-polygon-polygon" class="nav-link" data-scroll-target="#sec-polygon-polygon"><span class="header-section-number">3.4.4</span> Case 3: polygons (target) vs polygons (source)</a></li>
  </ul>
</li>
  <li><a href="#spatial-join-and-summary-in-one-step" id="toc-spatial-join-and-summary-in-one-step" class="nav-link" data-scroll-target="#spatial-join-and-summary-in-one-step"><span class="header-section-number">3.5</span> Spatial join and summary in one step</a></li>
  <li>
<a href="#spatial-intersection-cropping-join" id="toc-spatial-intersection-cropping-join" class="nav-link" data-scroll-target="#spatial-intersection-cropping-join"><span class="header-section-number">3.6</span> Spatial intersection (cropping join)</a>
  <ul class="collapse">
<li><a href="#sec-st-intersection" id="toc-sec-st-intersection" class="nav-link" data-scroll-target="#sec-st-intersection"><span class="header-section-number">3.6.1</span> <code>sf::st_intersection()</code></a></li>
  <li><a href="#area-weighted-average" id="toc-area-weighted-average" class="nav-link" data-scroll-target="#area-weighted-average"><span class="header-section-number">3.6.2</span> Area-weighted average</a></li>
  </ul>
</li>
  <li>
<a href="#sec-exercises-int-vv" id="toc-sec-exercises-int-vv" class="nav-link" data-scroll-target="#sec-exercises-int-vv"><span class="header-section-number">3.7</span> Exercises</a>
  <ul class="collapse">
<li><a href="#exercise-1-spatially-intersecting-objects" id="toc-exercise-1-spatially-intersecting-objects" class="nav-link" data-scroll-target="#exercise-1-spatially-intersecting-objects"><span class="header-section-number">3.7.1</span> Exercise 1: Spatially intersecting objects</a></li>
  <li><a href="#exercise-2-spatial-subset-and-cropping" id="toc-exercise-2-spatial-subset-and-cropping" class="nav-link" data-scroll-target="#exercise-2-spatial-subset-and-cropping"><span class="header-section-number">3.7.2</span> Exercise 2: Spatial subset and cropping</a></li>
  <li><a href="#exercise-3-spatial-join" id="toc-exercise-3-spatial-join" class="nav-link" data-scroll-target="#exercise-3-spatial-join"><span class="header-section-number">3.7.3</span> Exercise 3: Spatial join</a></li>
  <li><a href="#exercise-3-spatial-join-1" id="toc-exercise-3-spatial-join-1" class="nav-link" data-scroll-target="#exercise-3-spatial-join-1"><span class="header-section-number">3.7.4</span> Exercise 3: Spatial join</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/03-SpatialInteractionVectorVector.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script><script type="module" id="qwebr-monaco-editor-init">

  // Configure the Monaco Editor's loader
  require.config({
    paths: {
      'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs'
    }
  });
</script><script type="module">
// Function to update Monaco Editors when body class changes
function updateMonacoEditorsOnBodyClassChange() {
    // Select the body element
    const body = document.querySelector('body');

    // Options for the observer (which mutations to observe)
    const observerOptions = {
        attributes: true,  // Observe changes to attributes
        attributeFilter: ['class'] // Only observe changes to the 'class' attribute
    };

    // Callback function to execute when mutations are observed
    const bodyClassChangeCallback = function(mutationsList, observer) {
        for(let mutation of mutationsList) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                // Class attribute has changed
                // Update all Monaco Editors on the page
                updateMonacoEditorTheme();
            }
        }
    };

    // Create an observer instance linked to the callback function
    const observer = new MutationObserver(bodyClassChangeCallback);

    // Start observing the target node for configured mutations
    observer.observe(body, observerOptions);
}

// Function to update all instances of Monaco Editors on the page
function updateMonacoEditorTheme() {
    // Determine what VS Theme to use
    const vsThemeToUse = document.body.classList.contains("quarto-dark") ? 'vs-dark' : 'vs' ;

    // Iterate through all initialized Monaco Editors
    qwebrEditorInstances.forEach( function(editorInstance) { 
        editorInstance.updateOptions({ theme: vsThemeToUse }); 
    });
}

// Call the function to start observing changes to body class
updateMonacoEditorsOnBodyClassChange();
</script><script type="module">
// Global array to store Monaco Editor instances
globalThis.qwebrEditorInstances = [];

function isValidCodeLineNumbers(stringCodeLineNumbers) {
  // Regular expression to match valid input strings
  const regex = /^(\d+(-\d+)?)(,\d+(-\d+)?)*$/;
  return regex.test(stringCodeLineNumbers);
}

// Function that builds and registers a Monaco Editor instance    
globalThis.qwebrCreateMonacoEditorInstance = function (cellData) {

  const initialCode = cellData.code;
  const qwebrCounter = cellData.id;
  const qwebrOptions = cellData.options;

  // Retrieve the previously created document elements
  let runButton = document.getElementById(`qwebr-button-run-${qwebrCounter}`);
  let resetButton = document.getElementById(`qwebr-button-reset-${qwebrCounter}`);
  let copyButton = document.getElementById(`qwebr-button-copy-${qwebrCounter}`);
  let editorDiv = document.getElementById(`qwebr-editor-${qwebrCounter}`);

  // Load the Monaco Editor and create an instance
  let editor;
  require(['vs/editor/editor.main'], function () {
    editor = monaco.editor.create(editorDiv, {
      value: initialCode,
      language: 'r',
      theme: 'vs-light',
      automaticLayout: true,           // Works wonderfully with RevealJS
      scrollBeyondLastLine: false,
      minimap: {
        enabled: false
      },
      fontSize: qwebrScaledFontSize(editorDiv, qwebrOptions),         
      renderLineHighlight: "none",      // Disable current line highlighting
      hideCursorInOverviewRuler: true,  // Remove cursor indictor in right hand side scroll bar
      readOnly: qwebrOptions['read-only'] ?? false,
      quickSuggestions: qwebrOptions['editor-quick-suggestions'] ?? false,
      wordWrap: (qwebrOptions['editor-word-wrap'] == 'true' ? "on" : "off")
    });

    // Store the official counter ID to be used in keyboard shortcuts
    editor.__qwebrCounter = qwebrCounter;

    // Store the official div container ID
    editor.__qwebrEditorId = `qwebr-editor-${qwebrCounter}`;

    // Store the initial code value and options
    editor.__qwebrinitialCode = initialCode;
    editor.__qwebrOptions = qwebrOptions;

    // Set at the model level the preferred end of line (EOL) character to LF.
    // This prevent `\r\n` from being given to the webR engine if the user is on Windows.
    // See details in: https://github.com/coatless/quarto-webr/issues/94
    // Associated error text: 
    // Error: <text>:1:7 unexpected input

    // Retrieve the underlying model
    const model = editor.getModel();
    // Set EOL for the model
    model.setEOL(monaco.editor.EndOfLineSequence.LF);
    
    // Dynamically modify the height of the editor window if new lines are added.
    let ignoreEvent = false;
    const updateHeight = () => {
      // Increment editor height by 2 to prevent vertical scroll bar from appearing
      const contentHeight = editor.getContentHeight() + 2;

      // Retrieve editor-max-height option
      const maxEditorHeight = qwebrOptions['editor-max-height'];

      // If editor-max-height is missing, allow infinite growth. Otherwise, threshold.
      const editorHeight = !maxEditorHeight ?  contentHeight : Math.min(contentHeight, maxEditorHeight);

      // We're avoiding a width change
      //editorDiv.style.width = `${width}px`;
      editorDiv.style.height = `${editorHeight}px`;
      try {
        ignoreEvent = true;

        // The key to resizing is this call
        editor.layout();
      } finally {
        ignoreEvent = false;
      }
    };

    // Function to generate decorations to highlight lines
    // in the editor based on input string.
    function decoratorHighlightLines(codeLineNumbers) {
      // Store the lines to be lighlight
      let linesToHighlight = [];
      
      // Parse the codeLineNumbers string to get the line numbers to highlight
      // First, split the string by commas
      codeLineNumbers.split(',').forEach(part => {
        // Check if we have a range of lines
        if (part.includes('-')) {
            // Handle range of lines (e.g., "6-8")
            const [start, end] = part.split('-').map(Number);
            for (let i = start; i <= end; i++) {
                linesToHighlight.push(i);
            }
        } else {
            // Handle single line (e.g., "7")
            linesToHighlight.push(Number(part));
        }
      });
  
      // Create monaco decorations for the lines to highlight
      const decorations = linesToHighlight.map(lineNumber => ({
          range: new monaco.Range(lineNumber, 1, lineNumber, 1),
          options: {
              isWholeLine: true,
              className: 'qwebr-editor-highlight-line'
          }
      }));
  
      // Return decorations to be applied to the editor
      return decorations;
    }

    // Ensure that the editor-code-line-numbers option is set and valid
    // then apply styling
    if (qwebrOptions['editor-code-line-numbers']) {
      // Remove all whitespace from the string
      const codeLineNumbers = qwebrOptions['editor-code-line-numbers'].replace(/\s/g,'');
      // Check if the string is valid for line numbers, e.g., "1,3-5,7"
      if (isValidCodeLineNumbers(codeLineNumbers)) {
        // Apply the decorations to the editor
        editor.createDecorationsCollection(decoratorHighlightLines(codeLineNumbers));
      } else {
        // Warn the user that the input is invalid
        console.warn(`Invalid "editor-code-line-numbers" value in code cell ${qwebrOptions['label']}: ${codeLineNumbers}`);
      }
    }

    // Helper function to check if selected text is empty
    function isEmptyCodeText(selectedCodeText) {
      return (selectedCodeText === null || selectedCodeText === undefined || selectedCodeText === "");
    }

    // Registry of keyboard shortcuts that should be re-added to each editor window
    // when focus changes.
    const addWebRKeyboardShortCutCommands = () => {
      // Add a keydown event listener for Shift+Enter to run all code in cell
      editor.addCommand(monaco.KeyMod.Shift | monaco.KeyCode.Enter, () => {

        // Retrieve all text inside the editor
        qwebrExecuteCode(editor.getValue(), editor.__qwebrCounter, editor.__qwebrOptions);
      });

      // Add a keydown event listener for CMD/Ctrl+Enter to run selected code
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {

        // Get the selected text from the editor
        const selectedText = editor.getModel().getValueInRange(editor.getSelection());
        // Check if no code is selected
        if (isEmptyCodeText(selectedText)) {
          // Obtain the current cursor position
          let currentPosition = editor.getPosition();
          // Retrieve the current line content
          let currentLine = editor.getModel().getLineContent(currentPosition.lineNumber);

          // Propose a new position to move the cursor to
          let newPosition = new monaco.Position(currentPosition.lineNumber + 1, 1);

          // Check if the new position is beyond the last line of the editor
          if (newPosition.lineNumber > editor.getModel().getLineCount()) {
            // Add a new line at the end of the editor
            editor.executeEdits("addNewLine", [{
            range: new monaco.Range(newPosition.lineNumber, 1, newPosition.lineNumber, 1),
            text: "\n", 
            forceMoveMarkers: true,
            }]);
          }
          
          // Run the entire line of code.
          qwebrExecuteCode(currentLine, editor.__qwebrCounter, editor.__qwebrOptions);

          // Move cursor to new position
          editor.setPosition(newPosition);
        } else {
          // Code to run when Ctrl+Enter is pressed with selected code
          qwebrExecuteCode(selectedText, editor.__qwebrCounter, editor.__qwebrOptions);
        }
      });
    }

    // Register an on focus event handler for when a code cell is selected to update
    // what keyboard shortcut commands should work.
    // This is a workaround to fix a regression that happened with multiple
    // editor windows since Monaco 0.32.0 
    // https://github.com/microsoft/monaco-editor/issues/2947
    editor.onDidFocusEditorText(addWebRKeyboardShortCutCommands);

    // Register an on change event for when new code is added to the editor window
    editor.onDidContentSizeChange(updateHeight);

    // Manually re-update height to account for the content we inserted into the call
    updateHeight();

    // Store the editor instance in the global dictionary
    qwebrEditorInstances[editor.__qwebrCounter] = editor;

  });

  // Add a click event listener to the run button
  runButton.onclick = function () {
    qwebrExecuteCode(editor.getValue(), editor.__qwebrCounter, editor.__qwebrOptions);
  };

  // Add a click event listener to the reset button
  copyButton.onclick = function () {
    // Retrieve current code data
    const data = editor.getValue();
    
    // Write code data onto the clipboard.
    navigator.clipboard.writeText(data || "");
  };
  
  // Add a click event listener to the copy button
  resetButton.onclick = function () {
    editor.setValue(editor.__qwebrinitialCode);
  };
  
}
</script><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-VectorDataBasics.html">Foundations</a></li><li class="breadcrumb-item"><a href="../chapters/03-SpatialInteractionVectorVector.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-int-vv" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="before-you-start" class="level2 unnumbered page-columns page-full"><h2 class="unnumbered anchored" data-anchor-id="before-you-start">Before you start</h2>
<p>In this chapter, we explore the spatial interactions between two <code>sf</code> objects. We begin by examining topological relations—how two spatial objects relate to each other—focusing on <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_is_within_distance()</a></code>. <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> is particularly important as it is the most commonly used topological relation and serves as the default for spatial subsetting and joining in <code>sf</code>.</p>
<p>Next, we cover spatial subsetting, which involves filtering spatial data based on the geographic features of another dataset. Finally, we will discuss spatial joining, where attribute values from one spatial dataset are assigned to another based on their topological relationship<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;For those familiar with the <code>sp</code> package, these operations are similar to <code><a href="https://edzer.github.io/sp/reference/over.html">sp::over()</a></code>.</p></div></div><p>To test your knowledge, you can work on coding exercises at <a href="#sec-exercises-int-vv" class="quarto-xref"><span>Section 3.7</span></a>.</p>
<section id="direction-for-replication" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="direction-for-replication">Direction for replication</h3>
<p><strong>Datasets</strong></p>
<p>All the datasets that you need to import are available <a href="https://www.dropbox.com/sh/vhtpjiezijb97lj/AABpvzqdyZMkR1DgUBeI_mOja?dl=0">here</a>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</p>
<ul>
<li>set a folder (any folder) as the working directory using <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code><br>
</li>
<li>create a folder called “Data” inside the folder designated as the working directory (if you have created a “Data” folder previously, skip this step)</li>
<li>download the pertinent datasets from <a href="https://www.dropbox.com/sh/vhtpjiezijb97lj/AABpvzqdyZMkR1DgUBeI_mOja?dl=0">here</a>
</li>
<li>place all the files in the downloaded folder in the “Data” folder</li>
</ul>
<p><strong>Packages</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">data.table</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">ggplot2</span>, <span class="co"># for map creation</span></span>
<span>  <span class="va">tmap</span> <span class="co"># for map creation</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-topo" class="level2 page-columns page-full" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="sec-topo">
<span class="header-section-number">3.1</span> Topological relations</h2>
<p>Before diving into spatial subsetting and joining, we first examine topological relations. These refer to how multiple spatial objects are related to each other in space. The <code>sf</code> package provides various functions to identify these spatial relationships, with our primary focus being on intersections, which can be identified using <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. We will also briefly explore <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_is_within_distance()</a></code>. If you’re interested in other topological relations, you can check the documentation with <code>?geos_binary_pred</code>.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;Other topological relations like <code>st_within()</code> or <code>st_touches()</code> are rarely used.</p></div></div><section id="data-preparation" class="level3" data-number="3.1.1"><h3 data-number="3.1.1" class="anchored" data-anchor-id="data-preparation">
<span class="header-section-number">3.1.1</span> Data preparation</h3>
<p>We will use three <code>sf</code> objects: <code>points</code>, <code>lines</code>, and <code>polygons</code>.</p>
<p><strong>POINTS</strong></p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create points ---#</span></span>
<span><span class="va">point_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">point_2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">point_3</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- combine the points to make a single  sf of points ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">point_1</span>, <span class="va">point_2</span>, <span class="va">point_3</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>point_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"point 1"</span>, <span class="st">"point 2"</span>, <span class="st">"point 3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 1 ymin: 1 xmax: 2 ymax: 3
CRS:           NA
            x point_name
1 POINT (2 2)    point 1
2 POINT (1 1)    point 2
3 POINT (1 3)    point 3</code></pre>
</div>
</div>
<p><strong>LINES</strong></p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create points ---#</span></span>
<span><span class="va">line_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">line_2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- combine the points to make a single  sf of points ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">lines</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">line_1</span>, <span class="va">line_2</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>line_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"line 1"</span>, <span class="st">"line 2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 2 features and 1 field
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 0 ymin: 0 xmax: 2.5 ymax: 2
CRS:           NA
                            x line_name
1   LINESTRING (0 0, 2.5 0.5)    line 1
2 LINESTRING (1.5 0.5, 2.5 2)    line 2</code></pre>
</div>
</div>
<p><strong>POLYGONS</strong></p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create polygons ---#</span></span>
<span><span class="va">polygon_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">polygon_2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">3.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">polygon_3</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3.2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.3</span>, <span class="fl">3.2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2.5</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- combine the polygons to make an sf of polygons ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">polygons</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">polygon_1</span>, <span class="va">polygon_2</span>, <span class="va">polygon_3</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>polygon_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"polygon 1"</span>, <span class="st">"polygon 2"</span>, <span class="st">"polygon 3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 0 ymin: 0 xmax: 2.5 ymax: 3.5
CRS:           NA
                               x polygon_name
1 POLYGON ((0 0, 2 0, 2 2, 0 ...    polygon 1
2 POLYGON ((0.5 1.5, 0.5 3.5,...    polygon 2
3 POLYGON ((0.5 2.5, 0.5 3.2,...    polygon 3</code></pre>
</div>
</div>
<hr>
<p><a href="#fig-plot-point-polygons" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> shows how they look together:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">line_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Lines"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points</span>, <span class="fu">aes</span><span class="op">(</span>shape <span class="op">=</span> <span class="va">point_name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_shape_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Points"</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-plot-point-polygons" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plot-point-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-plot-point-polygons-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-point-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Visualization of the points, lines, and polygons
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sfst_intersects" class="level3 page-columns page-full" data-number="3.1.2"><h3 data-number="3.1.2" class="anchored" data-anchor-id="sfst_intersects">
<span class="header-section-number">3.1.2</span> <code>sf::st_intersects()</code>
</h3>
<p><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> identifies which <code>sfg</code> object in an <code>sf</code> (or <code>sfc</code>) intersects with <code>sfg</code> object(s) in another <code>sf</code>. For example, you can use the function to identify which well is located within which county. <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> is the most commonly used topological relation. It is important to understand what it does as it is the default topological relation used when performing spatial subsetting and joining, which we will cover later.</p>
<hr>
<p><strong>points and polygons</strong> (<a href="#fig-points-polygons" class="quarto-xref">Figure&nbsp;<span>3.2</span></a>)</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points</span>, <span class="fu">aes</span><span class="op">(</span>shape <span class="op">=</span> <span class="va">point_name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_shape_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Points"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-points-polygons" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-points-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-points-polygons-1.png" id="fig-points-polygons" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-points-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2
</figcaption></figure>
</div>
</div>
</div>
</div></div><div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">points</span>, <span class="va">polygons</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 3, where the predicate
was `intersects'
 1: 1, 2, 3
 2: 1
 3: 2, 3</code></pre>
</div>
</div>
<p>As you can see, the output is a list of which polygon(s) each of the points intersect with. The numbers 1, 2, and 3 in the first row mean that 1st (polygon 1), 2nd (polygon 2), and 3rd (polygon 3) objects of the <code>polygons</code> intersect with the first point (point 1) of the <code>points</code> object. The fact that point 1 is considered to be intersecting with polygon 2 means that the area inside the border is considered a part of the polygon (of course).</p>
<p>If you would like the results of <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> in a matrix form with boolean values filling the matrix, you can add <code>sparse = FALSE</code> option.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">points</span>, <span class="va">polygons</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]  [,2]  [,3]
[1,]  TRUE  TRUE  TRUE
[2,]  TRUE FALSE FALSE
[3,] FALSE  TRUE  TRUE</code></pre>
</div>
</div>
<hr>
<p><strong>lines and polygons</strong> (<a href="#fig-lines-polygons" class="quarto-xref">Figure&nbsp;<span>3.3</span></a>)</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">line_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Lines"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-lines-polygons" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lines-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-lines-polygons-1.png" id="fig-lines-polygons" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-lines-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3
</figcaption></figure>
</div>
</div>
</div>
</div></div><div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">lines</span>, <span class="va">polygons</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 2, where the predicate
was `intersects'
 1: 1
 2: 1, 2</code></pre>
</div>
</div>
<p>The output is a list of which polygon(s) each of the lines intersect with. For example, line intersects with the 1st and 2nd elements of <code>polygons</code>, which are <code>polygon 1</code> and <code>polygon 2</code>.</p>
<hr>
<p><strong>polygons and polygons</strong> (<a href="#fig-polygons-polygons" class="quarto-xref">Figure&nbsp;<span>3.4</span></a>)</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-polygons-polygons" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-polygons-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-polygons-polygons-1.png" id="fig-polygons-polygons" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-polygons-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>For polygons vs polygons interaction, <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> identifies any polygons that either touches (even at a point like polygons 1 and 3) or share some area.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">polygons</span>, <span class="va">polygons</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 3, where the predicate
was `intersects'
 1: 1, 2, 3
 2: 1, 2, 3
 3: 1, 2, 3</code></pre>
</div>
</div>
<p>Clearly, all of them interact with all the polygons (including themselves) in this case.</p>
</section><section id="sfst_is_within_distance" class="level3 page-columns page-full" data-number="3.1.3"><h3 data-number="3.1.3" class="anchored" data-anchor-id="sfst_is_within_distance">
<span class="header-section-number">3.1.3</span> <code>sf::st_is_within_distance()</code>
</h3>
<p>This function identifies whether two spatial objects are within the distance you specify<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;For example, this function can be useful to identify neighbors. For example, you may want to find irrigation wells located around well <span class="math inline">\(i\)</span> to label them as well <span class="math inline">\(i\)</span>’s neighbor.</p></div></div><p>We will use two sets of points data.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">38424738</span><span class="op">)</span></span>
<span></span>
<span><span class="va">points_set_1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">points_set_2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">points_set_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 5 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 0.2641607 ymin: 0.2094549 xmax: 0.789738 ymax: 0.9198815
CRS:           NA
                            x id
1 POINT (0.2809702 0.7930091)  1
2 POINT (0.4907635 0.9198815)  2
3  POINT (0.789738 0.2094549)  3
4 POINT (0.2641607 0.3031891)  4
5 POINT (0.4544901 0.6499282)  5</code></pre>
</div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">points_set_2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 5 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 0.01389647 ymin: 0.2871567 xmax: 0.7799449 ymax: 0.8535346
CRS:           NA
                             x id
1  POINT (0.2641116 0.8535346)  1
2 POINT (0.01389647 0.2871567)  2
3  POINT (0.5088085 0.6107668)  3
4   POINT (0.248774 0.5386513)  4
5  POINT (0.7799449 0.6599416)  5</code></pre>
</div>
</div>
<p>Here is how they are spatially distributed (<a href="#fig-map-points-points-points" class="quarto-xref">Figure&nbsp;<span>3.5</span></a>). Instead of circles of points, their corresponding <code>id</code> (or equivalently row number here) values are displayed.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points_set_1</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points_set_2</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-points-points-points" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-points-points-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-points-points-points-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-points-points-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.5: The locations of the set of points
</figcaption></figure>
</div>
</div>
</div>
<p>We want to know which of the blue points (<code>points_set_2</code>) are located within 0.2 from each of the red points (<code>points_set_1</code>). <a href="#fig-points-points-within" class="quarto-xref">Figure&nbsp;<span>3.6</span></a> gives us the answer visually.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create 0.2 buffers around points in points_set_1 ---#</span></span>
<span><span class="va">buffer_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">points_set_1</span>, dist <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">buffer_1</span>, color <span class="op">=</span> <span class="st">"red"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points_set_1</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points_set_2</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-points-points-within" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-points-points-within-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-points-points-within-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-points-points-within-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.6: The blue points within 0.2 radius of the red points
</figcaption></figure>
</div>
</div>
</div>
<p>Confirm your visual inspection results with the outcome of the following code using <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_is_within_distance()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_is_within_distance</a></span><span class="op">(</span><span class="va">points_set_1</span>, <span class="va">points_set_2</span>, dist <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 5, where the predicate
was `is_within_distance'
 1: 1
 2: (empty)
 3: (empty)
 4: (empty)
 5: 3</code></pre>
</div>
</div>
</section></section><section id="spatial-cropping" class="level2 page-columns page-full" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="spatial-cropping">
<span class="header-section-number">3.2</span> Spatial cropping</h2>
<section id="data-preparation-1" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="data-preparation-1">
<span class="header-section-number">3.2.1</span> Data preparation</h3>
<p>Let’s import the following files:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- Kansas county borders ---#</span></span>
<span><span class="va">KS_counties</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/KS_county_borders.rds"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">32614</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- High-Plains Aquifer boundary ---#</span></span>
<span><span class="va">hpa</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/hp_bound2010.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">KS_counties</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- all the irrigation wells in KS ---#</span></span>
<span><span class="va">KS_wells</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/Kansas_wells.rds"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">KS_counties</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- US railroads in the Mid West region ---#</span></span>
<span><span class="va">rail_roads_mw</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/mw_railroads.geojson"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="bounding-box" class="level3" data-number="3.2.2"><h3 data-number="3.2.2" class="anchored" data-anchor-id="bounding-box">
<span class="header-section-number">3.2.2</span> Bounding box</h3>
<p>We can use <code>st_crop()</code> to crop a spatial object to a spatial bounding box (extent) of another spatial object. The bounding box of an <code>sf</code> is a rectangle represented by the minimum and maximum of <code>x</code> and <code>y</code> that encompass/contain all the spatial objects in the <code>sf</code>. You can use <code>st_bbox()</code> to find the bounding box of an <code>sf</code> object. Let’s get the bounding box of irrigation wells in Kansas (<code>KS_wells</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the bounding box of KS_wells ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">bbox_KS_wells</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span>  </span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     xmin      ymin      xmax      ymax 
 230332.0 4095052.5  887329.7 4433596.9 </code></pre>
</div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- check the class ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">bbox_KS_wells</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "bbox"</code></pre>
</div>
</div>
<p>As you can see, <code><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">sf::st_bbox()</a></code> returns an object of class <code>bbox</code>. You cannot directly create a map using a <code>bbox</code>. So, let’s convert it to an <code>sfc</code> using <code><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">sf::st_as_sfc()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells_bbox_sfc</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="va">bbox_KS_wells</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-bbox-fig" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> shows the bounding box (red rectangle).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">KS_wells_bbox_sfc</span>, </span>
<span>    fill <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1.2</span></span>
<span>   <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">KS_wells</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">0.4</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-bbox-fig" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-bbox-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-bbox-fig-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bbox-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.7: The bounding box of the irrigation wells in Kansas that overlie HPA
</figcaption></figure>
</div>
</div>
</div>
</section><section id="spatial-cropping-1" class="level3 page-columns page-full" data-number="3.2.3"><h3 data-number="3.2.3" class="anchored" data-anchor-id="spatial-cropping-1">
<span class="header-section-number">3.2.3</span> Spatial cropping</h3>
<p>Let’s now crop High-Plains aquifer boundary (<code>hpa</code>) to the bounding box of Kansas wells (<a href="#fig-hpa" class="quarto-xref">Figure&nbsp;<span>3.8</span></a>).</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_bbox_sfc</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-hpa" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-hpa-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.8: HPA and irrigation wells in Kansas
</figcaption></figure>
</div>
</div>
</div>
</div></div><div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hpa_cropped_to_KS</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">hpa</span>, <span class="va">KS_wells</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what the cropped version of <code>hpa</code> looks like (<a href="#fig-cropped-hpa" class="quarto-xref">Figure&nbsp;<span>3.9</span></a>):</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_bbox_sfc</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cropped-hpa" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cropped-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-cropped-hpa-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cropped-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.9: The bounding box of the irrigation wells in Kansas that overlie HPA
</figcaption></figure>
</div>
</div>
</div>
<p>As you can see, the <code>st_crop()</code> operation cut the parts of <code>hpa</code> that are not intersecting with the bounding box of <code>KS_wells</code>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please note that we did not explicilty crop <code>hpa</code> to the bouding box of <code>KS_wells</code> (<code>bbox_KS_wells</code>) above. That is, we just run <code>hpa_cropped_to_KS &lt;- sf::st_crop(hpa, KS_wells)</code> instead of <code>hpa_cropped_to_KS &lt;- sf::st_crop(hpa, bbox_KS_wells)</code>. When <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">sf::st_crop()</a></code> is used, it automatically finds the bounding box of the <code>sf</code> as second argument and implements cropping.</p>
</div>
</div>
</section></section><section id="sec-sf-subset" class="level2 page-columns page-full" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="sec-sf-subset">
<span class="header-section-number">3.3</span> Spatial subsetting</h2>
<p>Spatial subsetting refers to operations that narrow down the geographic scope of a spatial object (source data) based on another spatial object (target data). We illustrate spatial subsetting using Kansas county borders (<code>KS_counties</code>), the boundary of the Kansas portion of the High-Plains Aquifer (<code>hpa_cropped_to_KS</code>), and agricultural irrigation wells in Kansas (<code>KS_wells</code>).</p>
<section id="polygons-source-vs-polygons-target" class="level3 page-columns page-full" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="polygons-source-vs-polygons-target">
<span class="header-section-number">3.3.1</span> polygons (source) vs polygons (target)</h3>
<p><a href="#fig-overlap-KS-county-HPA" class="quarto-xref">Figure&nbsp;<span>3.10</span></a> shows the Kansas portion of the HPA and Kansas counties.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-overlap-KS-county-HPA" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-overlap-KS-county-HPA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-overlap-KS-county-HPA-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-overlap-KS-county-HPA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.10: Kansas portion of High-Plains Aquifer and Kansas counties
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>The goal is to select only the counties that intersect with the HPA boundary. Spatial subsetting of <code>sf</code> objects follows this syntax:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- this does not run ---#</span></span>
<span><span class="va">sf_1</span><span class="op">[</span><span class="va">sf_2</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where you are subsetting <code>sf_1</code> based on <code>sf_2</code>. Instead of row numbers, you provide another sf object in place. The following code spatially subsets Kansas counties based on the HPA boundary.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">counties_intersecting_hpa</span> <span class="op">&lt;-</span> <span class="va">KS_counties</span><span class="op">[</span><span class="va">hpa_cropped_to_KS</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-default-subset" class="quarto-xref">Figure&nbsp;<span>3.11</span></a> presents counties in <code>counties_intersecting_hpa</code> and the cropped HPA boundary.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- add US counties layer ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">counties_intersecting_hpa</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- add High-Plains Aquifer layer ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-default-subset" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-default-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-default-subset-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-default-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.11: The results of spatially subsetting Kansas counties based on HPA boundary
</figcaption></figure>
</div>
</div>
</div>
<p>You can see that only the counties intersecting with the HPA boundary remain. This is because, when using the syntax <code>sf_1[sf_2, ]</code>, the default topological relation is <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>. If objects in <code>sf_1</code> intersect with any of the objects in <code>sf_2</code>, even slightly, they will remain after subsetting.</p>
<p>Sometimes, instead of removing non-intersecting observations, you may just want to flag whether two spatial objects intersect. To do this, you can first retrieve the IDs of the intersecting counties from <code>counties_intersecting_hpa</code> and then create a variable in the original dataset (<code>KS_counties</code>) that indicates whether an intersection occurs.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- check the intersections of HPA and counties  ---#</span></span>
<span><span class="va">intersecting_counties_list</span> <span class="op">&lt;-</span> <span class="va">counties_intersecting_hpa</span><span class="op">$</span><span class="va">COUNTYFP</span></span>
<span></span>
<span><span class="co">#--- assign true/false ---#</span></span>
<span><span class="va">KS_counties</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">KS_counties</span>, intersects_hpa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">COUNTYFP</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">intersecting_counties_list</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">KS_counties</span>, <span class="va">COUNTYFP</span>, <span class="va">intersects_hpa</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
   COUNTYFP intersects_hpa                       geometry
1       133          FALSE MULTIPOLYGON (((806203.1 41...
2       075           TRUE MULTIPOLYGON (((233615.1 42...
3       123          FALSE MULTIPOLYGON (((544031.7 43...
4       189           TRUE MULTIPOLYGON (((273665.9 41...
5       155           TRUE MULTIPOLYGON (((546178.6 42...
6       129           TRUE MULTIPOLYGON (((229431.1 41...
7       073          FALSE MULTIPOLYGON (((717254.1 42...
8       023           TRUE MULTIPOLYGON (((239494.1 44...
9       089           TRUE MULTIPOLYGON (((542298.2 44...
10      059          FALSE MULTIPOLYGON (((804792.9 42...</code></pre>
</div>
</div>
<hr>
<p><strong>Other topological relations</strong></p>
<p>As mentioned above, the default topological relation used in <code>sf_1[sf_2, ]</code> is <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>. However, you can specify other topological relations using the following syntax:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- this does not run ---#</span></span>
<span><span class="va">sf_1</span><span class="op">[</span><span class="va">sf_2</span>, op <span class="op">=</span> <span class="va">topological_relation_type</span><span class="op">]</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, if you only want counties that are completely within the HPA boundary, you can use the following approach:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">counties_within_hpa</span> <span class="op">&lt;-</span> <span class="va">KS_counties</span><span class="op">[</span><span class="va">hpa_cropped_to_KS</span>, op <span class="op">=</span> <span class="va">st_within</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-within-subset" class="quarto-xref">Figure&nbsp;<span>3.12</span></a> shows the resulting set of counties.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">counties_within_hpa</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-within-subset" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-within-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-within-subset-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-within-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.12: Kansas counties that are completely within the HPA boundary
</figcaption></figure>
</div>
</div>
</div>
<!-- 
#%%%%%%%%%%%%%%%%%%%%%
# Points vs Polygons 
#%%%%%%%%%%%%%%%%%%%%%
-->
</section><section id="points-source-vs-polygons-target" class="level3" data-number="3.3.2"><h3 data-number="3.3.2" class="anchored" data-anchor-id="points-source-vs-polygons-target">
<span class="header-section-number">3.3.2</span> points (source) vs polygons (target)</h3>
<p>The following map (<a href="#fig-map-wells-county" class="quarto-xref">Figure&nbsp;<span>3.13</span></a>) shows the Kansas portion of the HPA and all the irrigation wells in Kansas. We can select only wells that reside within the HPA boundary using the same syntax as the above example.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells</span>, size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-wells-county" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-wells-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-wells-county-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-wells-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.13: A map of Kansas irrigation wells and HPA
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells_in_hpa</span> <span class="op">&lt;-</span> <span class="va">KS_wells</span><span class="op">[</span><span class="va">hpa_cropped_to_KS</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see in <a href="#fig-map-wells-in-hpa" class="quarto-xref">Figure&nbsp;<span>3.14</span></a> below, only the wells that are inside (or intersect with) the HPA remained because the default topological relation is <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_in_hpa</span>, size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-wells-in-hpa" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-wells-in-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-wells-in-hpa-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-wells-in-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.14: A map of Kansas irrigation wells and HPA
</figcaption></figure>
</div>
</div>
</div>
<p>If you want to flag wells that intersect with HPA, use the following approach:</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">site_list</span> <span class="op">&lt;-</span> <span class="va">KS_wells_in_hpa</span><span class="op">$</span><span class="va">site</span></span>
<span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">KS_wells</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">KS_wells</span>, in_hpa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">site_list</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37647 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 230332 ymin: 4095052 xmax: 887329.7 ymax: 4433597
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
   site    af_used                 geometry in_hpa
1     1 232.099948   POINT (372548 4153588)   TRUE
2     3  13.183940 POINT (353698.6 4419755)   TRUE
3     5  99.187052 POINT (486771.7 4260027)   TRUE
4     7   0.000000 POINT (248127.1 4296442)   TRUE
5     8 145.520499 POINT (349813.2 4215310)   TRUE
6     9   3.614535 POINT (612277.6 4322077)  FALSE
7    11 188.423543 POINT (267030.7 4381364)   TRUE
8    12  77.335960 POINT (761774.6 4339039)  FALSE
9    15   0.000000 POINT (560570.3 4235763)   TRUE
10   17 167.819034 POINT (387315.1 4175007)   TRUE</code></pre>
</div>
</div>
<!-- 
#%%%%%%%%%%%%%%%%%%%%%
# Lines vs Polygons 
#%%%%%%%%%%%%%%%%%%%%%
-->
</section><section id="sec-lines_polygons" class="level3 page-columns page-full" data-number="3.3.3"><h3 data-number="3.3.3" class="anchored" data-anchor-id="sec-lines_polygons">
<span class="header-section-number">3.3.3</span> lines (source) vs polygons (target)</h3>
<p><a href="#fig-map-lines-county" class="quarto-xref">Figure&nbsp;<span>3.15</span></a> shows the Kansas counties (in red) and U.S. railroads in the Mid West region(in blue).</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">rail_roads_mw</span>, color <span class="op">=</span> <span class="st">"blue"</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-lines-county" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-lines-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-lines-county-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-lines-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.15: U.S. railroads and Kansas county boundaries
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>We can select only the railroads that intersect with Kansas.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">railroads_KS</span> <span class="op">&lt;-</span> <span class="va">rail_roads_mw</span><span class="op">[</span><span class="va">KS_counties</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see in <a href="#fig-map-rail-ks" class="quarto-xref">Figure&nbsp;<span>3.16</span></a> below, only the railroads that intersect with Kansas were selected. Note the lines that go beyond the Kansas boundary are also selected. Remember, the default is <code>sf::st_intersect()</code>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">railroads_KS</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">KS_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-rail-ks" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-rail-ks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-rail-ks-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-rail-ks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.16: Railroads that intersect Kansas county boundaries
</figcaption></figure>
</div>
</div>
</div>
<p>If you would like the lines beyond the state boundary to be cut out but the intersecting parts of those lines to remain, use <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code>, which is explained in <a href="#sec-st-intersection" class="quarto-xref"><span>Section 3.6.1</span></a>.</p>
<p>If you want to flag railroads that intersect with Kansas counties in <code>railroads</code>, use the following approach:</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the list of lines ---#</span></span>
<span><span class="va">lines_list</span> <span class="op">&lt;-</span> <span class="va">railroads_KS</span><span class="op">$</span><span class="va">LINEARID</span></span>
<span></span>
<span><span class="co">#--- railroads ---#</span></span>
<span><span class="va">rail_roads_mw</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">rail_roads_mw</span>, intersect_ks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">LINEARID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">lines_list</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">rail_roads_mw</span>, <span class="va">LINEARID</span>, <span class="va">intersect_ks</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 100661 features and 2 fields
Geometry type: MULTILINESTRING
Dimension:     XY
Bounding box:  xmin: -414024 ymin: 3692172 xmax: 2094886 ymax: 5446589
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
      LINEARID intersect_ks                       geometry
1  11050905483        FALSE MULTILINESTRING ((1250147 3...
2  11050905484        FALSE MULTILINESTRING ((1250147 3...
3  11050905485        FALSE MULTILINESTRING ((1250429 3...
4  11050905486        FALSE MULTILINESTRING ((1248249 3...
5  11050905487        FALSE MULTILINESTRING ((1248249 3...
6  11050905488        FALSE MULTILINESTRING ((1249095 3...
7  11050905489        FALSE MULTILINESTRING ((1250429 3...
8  11050905490        FALSE MULTILINESTRING ((1250383 3...
9  11050905492        FALSE MULTILINESTRING ((1250329 3...
10 11050905494        FALSE MULTILINESTRING ((1250033 3...</code></pre>
</div>
</div>
</section><section id="sec-polygons_points" class="level3 page-columns page-full" data-number="3.3.4"><h3 data-number="3.3.4" class="anchored" data-anchor-id="sec-polygons_points">
<span class="header-section-number">3.3.4</span> polygons (source) vs points (target)</h3>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_in_hpa</span>, fill <span class="op">=</span> <span class="cn">NA</span>, size <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-county-point" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-county-point-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-county-point-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-county-point-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.17: Kansas county boundaries and wells that overlie the HPA
</figcaption></figure>
</div>
</div>
</div>
</div></div><p><a href="#fig-map-county-point" class="quarto-xref">Figure&nbsp;<span>3.17</span></a> shows the Kansas counties and irrigation wells in Kansas that overlie HPA. We can select only the counties that intersect with at least one well.</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_counties_intersected</span> <span class="op">&lt;-</span> <span class="va">KS_counties</span><span class="op">[</span><span class="va">KS_wells_in_hpa</span>, <span class="op">]</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see in <a href="#fig-subset-county-point" class="quarto-xref">Figure&nbsp;<span>3.18</span></a> below, only the counties that intersect with at least one well remained.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties_intersected</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_in_hpa</span>, fill <span class="op">=</span> <span class="cn">NA</span>, size <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-subset-county-point" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-subset-county-point-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-subset-county-point-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-subset-county-point-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.18: Counties that have at least one well
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="sec-sp-join" class="level2 page-columns page-full" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="sec-sp-join">
<span class="header-section-number">3.4</span> Spatial join</h2>
<p>A spatial join refers to spatial operations that involve the following steps:</p>
<ul>
<li>Overlay one spatial layer (target layer) onto another (source layer).</li>
<li>For each observation in the target layer:</li>
<li>Identify which objects in the source layer it geographically intersects with (or has another specified topological relationship).</li>
<li>Extract values associated with the intersecting objects in the source layer, summarizing if necessary.</li>
<li>Assign the extracted values to the corresponding objects in the target layer.</li>
</ul>
<p>We can classify spatial join into four categories by the type of the underlying spatial objects:</p>
<ul>
<li>
<strong>vector-vector</strong>: vector data (target) against vector data (source)</li>
<li>
<strong>vector-raster</strong>: vector data (target) against raster data (source)</li>
<li>
<strong>raster-vector</strong>: raster data (target) against vector data (source)</li>
<li>
<strong>raster-raster</strong>: raster data (target) against raster data (source)</li>
</ul>
<p>Among these four types, our focus here is on the first case, <strong>vector-vector</strong>. The second case will be discussed in <a href="05-SpatialInteractionVectorRaster.html" class="quarto-xref"><span>Chapter 5</span></a>. The third and fourth cases are not covered in this book, as the target data is almost always vector data (e.g., cities or farm fields as points, political boundaries as polygons, etc.).</p>
<p>The <strong>vector-vector</strong> category can be further divided into subcategories depending on the type of spatial object: point, line, or polygon. In this context, we will exclude spatial joins involving lines. This is because line objects are rarely used as observation units in subsequent analyses or as the source data for extracting values.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;For example, in <a href="01-Demonstration.html#sec-demo-railroad" class="quarto-xref"><span>Section 1.4</span></a>, we did not extract any attribute values from the railroads. Instead, we calculated the travel length of the railroads, meaning the geometry of the railroads was of interest rather than the values associated with them.</p></div></div><p>Below is a list of the types of spatial joins we will cover:</p>
<ol type="1">
<li>points (target) against polygons (source)</li>
<li>polygons (target) against points (source)</li>
<li>polygons (target) against polygons (source)</li>
</ol>
<!-- 
#=========================================
# Spatial Joining 
#=========================================
--><section id="syntax" class="level3" data-number="3.4.1"><h3 data-number="3.4.1" class="anchored" data-anchor-id="syntax">
<span class="header-section-number">3.4.1</span> Syntax</h3>
<p>To perform spatial join, we can use the <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> function, with the following syntax:</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- this does not run ---#</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">target_sf</span>, <span class="va">source_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similar to spatial subsetting, the default topological relation is <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>.</p>
</section><section id="case-1-points-target-vs-polygons-source" class="level3 page-columns page-full" data-number="3.4.2"><h3 data-number="3.4.2" class="anchored" data-anchor-id="case-1-points-target-vs-polygons-source">
<span class="header-section-number">3.4.2</span> Case 1: points (target) vs polygons (source)</h3>
<p>In this case, for each observation (point) in the target data, it identifies which polygon in the source data it intersects with and then assigns the value associated with the polygon to the point.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;A practical example of this case is shown in Demonstration 1 of <a href="01-Demonstration.html" class="quarto-xref"><span>Chapter 1</span></a>.</p></div></div><p>We use the Kansas irrigation well data (points) and Kansas county boundary data (polygons) for a demonstration. Our goal is to assign the county-level corn price information from the Kansas county data to wells. First let me create and add a fake county-level corn price variable to the Kansas county data.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_corn_price</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">KS_counties</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>corn_price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">3.2</span>, <span class="fl">3.9</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">corn_price</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-map-corn-price" class="quarto-xref">Figure&nbsp;<span>3.19</span></a> presents Kansas counties color-differentiated by the fake corn price.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">KS_corn_price</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">corn_price</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-corn-price" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-corn-price-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-corn-price-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-corn-price-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.19: Map of county-level fake corn price
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>For this particular context, the following code will do the job:</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- spatial join ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">KS_wells_County</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">KS_wells</span>, <span class="va">KS_corn_price</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37647 features and 5 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 230332 ymin: 4095052 xmax: 887329.7 ymax: 4433597
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
   site    af_used in_hpa COUNTYFP corn_price                 geometry
1     1 232.099948   TRUE      069   3.556731   POINT (372548 4153588)
2     3  13.183940   TRUE      039   3.449038 POINT (353698.6 4419755)
3     5  99.187052   TRUE      165   3.287500 POINT (486771.7 4260027)
4     7   0.000000   TRUE      199   3.644231 POINT (248127.1 4296442)
5     8 145.520499   TRUE      055   3.832692 POINT (349813.2 4215310)
6     9   3.614535  FALSE      143   3.799038 POINT (612277.6 4322077)
7    11 188.423543   TRUE      181   3.590385 POINT (267030.7 4381364)
8    12  77.335960  FALSE      177   3.550000 POINT (761774.6 4339039)
9    15   0.000000   TRUE      159   3.610577 POINT (560570.3 4235763)
10   17 167.819034   TRUE      069   3.556731 POINT (387315.1 4175007)</code></pre>
</div>
</div>
<p>You can see from <a href="#fig-map-corn-wells" class="quarto-xref">Figure&nbsp;<span>3.20</span></a> that all the wells inside the same county have the same corn price value.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">

</div></div><div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_County</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">corn_price</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-corn-wells" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-corn-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-corn-wells-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-corn-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.20: Map of wells color-differentiated by corn price
</figcaption></figure>
</div>
</div>
</div>
<p>We can also confirm that the <code>corn_price</code> value associated with all the wells in a single county is identical with the <code>corn_price</code> value associated with that county in the original corn price data (<code>KS_corn_price</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells_County</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">COUNTYFP</span> <span class="op">==</span> <span class="st">"069"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">corn_price</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.556731</code></pre>
</div>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_corn_price</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">COUNTYFP</span> <span class="op">==</span> <span class="st">"069"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">corn_price</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.556731</code></pre>
</div>
</div>
</section><section id="sec-polygons-points" class="level3 page-columns page-full" data-number="3.4.3"><h3 data-number="3.4.3" class="anchored" data-anchor-id="sec-polygons-points">
<span class="header-section-number">3.4.3</span> Case 2: polygons (target) vs points (source)</h3>
<p>In this case, for each observation (polygon) in the target data, it identifies which observations (points) in the source data intersect with it, and then assigns the values associated with those points to the polygon (A practical example of this case is shown in Demonstration 2 of <a href="01-Demonstration.html" class="quarto-xref"><span>Chapter 1</span></a>.).</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">af_used</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Groundwater Pumping (acre-feet)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-wells-county-gw" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wells-county-gw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-wells-county-gw-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wells-county-gw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.21: Map of wells color-differentiated by corn price
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>For instance, if you are conducting a county-level analysis and want to calculate the total groundwater pumping for each county, the target data would be <code>KS_counties</code>, and the source data would be <code>KS_wells</code> (<a href="#fig-wells-county-gw" class="quarto-xref">Figure&nbsp;<span>3.21</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- spatial join ---#</span></span>
<span><span class="va">KS_County_wells</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">KS_counties</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">KS_County_wells</span>, <span class="va">COUNTYFP</span>, <span class="va">site</span>, <span class="va">af_used</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37652 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
    COUNTYFP  site   af_used                       geometry
1        133 53861  17.01790 MULTIPOLYGON (((806203.1 41...
1.1      133 70592   0.00000 MULTIPOLYGON (((806203.1 41...
2        075   328 394.04513 MULTIPOLYGON (((233615.1 42...
2.1      075   336  80.65036 MULTIPOLYGON (((233615.1 42...
2.2      075   436 568.25359 MULTIPOLYGON (((233615.1 42...
2.3      075  1007 215.80416 MULTIPOLYGON (((233615.1 42...
2.4      075  1170   0.00000 MULTIPOLYGON (((233615.1 42...
2.5      075  1192  77.39120 MULTIPOLYGON (((233615.1 42...
2.6      075  1249   0.00000 MULTIPOLYGON (((233615.1 42...
2.7      075  1300 320.22612 MULTIPOLYGON (((233615.1 42...</code></pre>
</div>
</div>
<p>As seen in the resulting dataset, each unique polygon-point intersection forms an observation. For each polygon, there will be as many observations as there are wells intersecting with that polygon. After joining the two layers, you can calculate statistics for each polygon (in this case, each county). Since the goal is to calculate groundwater extraction by county, the following code will accomplish this:</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_County_wells</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">COUNTYFP</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>af_used <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">af_used</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
# A tibble: 105 × 3
   COUNTYFP af_used                                                     geometry
   &lt;fct&gt;      &lt;dbl&gt;                                           &lt;MULTIPOLYGON [m]&gt;
 1 001           0  (((806387 4191583, 805512 4215779, 844240.9 4217265, 845100…
 2 003           0  (((804971.3 4254894, 843634.8 4256415, 844240.9 4217265, 80…
 3 005         771. (((794798 4394875, 814054.6 4395649, 833328.7 4396412, 8396…
 4 007        4972. (((498886 4147060, 547336.9 4147260, 547367.8 4137622, 5575…
 5 009       61083. (((497132.8 4283127, 544688.2 4283265, 545236.6 4281565, 54…
 6 011           0  (((844767.7 4183342, 845100.4 4193068, 844240.9 4217265, 88…
 7 013         480. (((774189.2 4432752, 774491.2 4432762, 812462.5 4434180, 81…
 8 015         343. (((662406.7 4197742, 661982.8 4217157, 689364.6 4217517, 71…
 9 017           0  (((688956.3 4246711, 690085.5 4266038, 730694.2 4267016, 73…
10 019           0  (((719369.2 4131329, 769067.5 4132390, 770145.1 4099095, 76…
# ℹ 95 more rows</code></pre>
</div>
</div>
<p>It is just as easy to get other types of statistics by simply modifying the <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code> part.</p>
</section><section id="sec-polygon-polygon" class="level3 page-columns page-full" data-number="3.4.4"><h3 data-number="3.4.4" class="anchored" data-anchor-id="sec-polygon-polygon">
<span class="header-section-number">3.4.4</span> Case 3: polygons (target) vs polygons (source)</h3>
<p>In this case, <code>sf::st_join(target_sf, source_sf)</code> returns all the unique polygon-polygon intersections, with the attributes from <code>source_sf</code> attached to the intersecting polygons.</p>
<p>We will use county-level corn acres data in Iowa for 2018 from USDA NASS<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> and Hydrologic Units. Our objective is to estimate corn acres by HUC units based on county-level corn acres data.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;See <a href="08-DownloadSpatialData.html#sec-nass-quick" class="quarto-xref"><span>Section 8.1</span></a> for instructions on downloading Quick Stats data from within R.</p></div><div id="fn7"><p><sup>7</sup>&nbsp;There will be substantial measurement errors because the source polygons (corn acres by county) are large compared to the target polygons (HUC units). However, this serves as a useful illustration of a polygon-polygon join.</p></div></div><p>We first import the Iowa corn acre data (<a href="#fig-map-IA-corn" class="quarto-xref">Figure&nbsp;<span>3.22</span></a> is the map of Iowa counties color-differentiated by corn acres):</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- IA boundary ---#</span></span>
<span><span class="va">IA_corn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/IA_corn.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="va">IA_corn</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 93 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 203228.6 ymin: 4470941 xmax: 736832.9 ymax: 4822687
Projected CRS: NAD83 / UTM zone 15N
First 10 features:
   county_code year  acres                       geometry
1          083 2018 183500 MULTIPOLYGON (((458997 4711...
2          141 2018 167000 MULTIPOLYGON (((267700.8 47...
3          081 2018 184500 MULTIPOLYGON (((421231.2 47...
4          019 2018 189500 MULTIPOLYGON (((575285.6 47...
5          023 2018 165500 MULTIPOLYGON (((497947.5 47...
6          195 2018 111500 MULTIPOLYGON (((459791.6 48...
7          063 2018 110500 MULTIPOLYGON (((345214.3 48...
8          027 2018 183000 MULTIPOLYGON (((327408.5 46...
9          121 2018  70000 MULTIPOLYGON (((396378.1 45...
10         077 2018 107000 MULTIPOLYGON (((355180.1 46...</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">IA_corn</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">acres</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-IA-corn" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-IA-corn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-IA-corn-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-IA-corn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.22: Map of Iowa counties color-differentiated by corn planted acreage
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Now import the HUC units data (<a href="#fig-HUC-map" class="quarto-xref">Figure&nbsp;<span>3.23</span></a> presents the map of HUC units):</p>
<div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- import HUC units ---#</span></span>
<span><span class="va">HUC_IA</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/huc250k.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">HUC_CODE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- reproject to the CRS of IA ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">IA_corn</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- select HUC units that overlaps with IA ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="va">IA_corn</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">HUC_IA</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-HUC-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-HUC-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-HUC-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-HUC-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.23: Map of HUC units that intersect with Iowa state boundary
</figcaption></figure>
</div>
</div>
</div>
</div></div><p><a href="#fig-HUC-county-map" class="quarto-xref">Figure&nbsp;<span>3.24</span></a> presents a map of Iowa counties superimposed on the HUC units:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">HUC_IA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">IA_corn</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">acres</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-HUC-county-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-HUC-county-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-HUC-county-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-HUC-county-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.24: Map of HUC units superimposed on the counties in Iowas
</figcaption></figure>
</div>
</div>
</div>
<p>Spatial join using <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> will produce the following:</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">HUC_joined</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">HUC_IA</span>, <span class="va">IA_corn</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 349 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 154941.7 ymin: 4346327 xmax: 773299.8 ymax: 4907735
Projected CRS: NAD83 / UTM zone 15N
First 10 features:
      HUC_CODE county_code year  acres                       geometry
608   10170203         149 2018 226500 POLYGON ((235551.4 4907513,...
608.1 10170203         167 2018 249000 POLYGON ((235551.4 4907513,...
608.2 10170203         193 2018 201000 POLYGON ((235551.4 4907513,...
608.3 10170203         119 2018 184500 POLYGON ((235551.4 4907513,...
621   07020009         063 2018 110500 POLYGON ((408580.7 4880798,...
621.1 07020009         109 2018 304000 POLYGON ((408580.7 4880798,...
621.2 07020009         189 2018 120000 POLYGON ((408580.7 4880798,...
627   10170204         141 2018 167000 POLYGON ((248115.2 4891652,...
627.1 10170204         143 2018 116000 POLYGON ((248115.2 4891652,...
627.2 10170204         167 2018 249000 POLYGON ((248115.2 4891652,...</code></pre>
</div>
</div>
<p>Each intersecting HUC-county combination becomes a separate observation, with the resulting geometry being the same as that of the HUC unit. To illustrate this, let’s take a closer look at one of the HUC units. The HUC unit with <code>HUC_CODE ==10170203</code> intersects with four County.</p>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the HUC unit with `HUC_CODE ==10170203`  ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">temp_HUC_county</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">HUC_joined</span>, <span class="va">HUC_CODE</span> <span class="op">==</span> <span class="fl">10170203</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 4 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 154941.7 ymin: 4709628 xmax: 248115.2 ymax: 4907735
Projected CRS: NAD83 / UTM zone 15N
      HUC_CODE county_code year  acres                       geometry
608   10170203         149 2018 226500 POLYGON ((235551.4 4907513,...
608.1 10170203         167 2018 249000 POLYGON ((235551.4 4907513,...
608.2 10170203         193 2018 201000 POLYGON ((235551.4 4907513,...
608.3 10170203         119 2018 184500 POLYGON ((235551.4 4907513,...</code></pre>
</div>
</div>
<p>All of the four observations in <code>temp_HUC_county</code> has the identical geometry (<a href="#fig-identical-geometry" class="quarto-xref">Figure&nbsp;<span>3.25</span></a> shows this visually.).</p>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">temp_HUC_county</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">temp_HUC_county</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>county_text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"County Code: "</span>, <span class="va">county_code</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="va">county_text</span> <span class="op">~</span> <span class="va">.</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-identical-geometry" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-identical-geometry-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-identical-geometry-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-identical-geometry-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.25: Geoemetry of the four observations in the joined object
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Moreover, they are identical with the geometry of the intersecting HUC unit (the HUC unit with <code>HUC_CODE ==10170203</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span></span>
<span>  <span class="co">#--- geometry of the one of the observations from the joined object ---#</span></span>
<span>  <span class="va">temp_HUC_county</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>  <span class="co">#--- original HUC geometry ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">HUC_IA</span>, <span class="va">HUC_CODE</span> <span class="op">==</span> <span class="fl">10170203</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">pull</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>So, all four observations have identical geometry, which corresponds to the geometry of the HUC unit. This indicates that <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> does not retain information about the extent of the intersection between the HUC unit and the four counties. Keep in mind that the default behavior uses <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>, which only checks whether the spatial objects intersect, without providing further details.</p>
<p>If you are calculating a simple average of corn acres and are not concerned with the degree of spatial overlap, this method works just fine. However, if you want to compute an area-weighted average, the information provided is insufficient. You will learn how to calculate the area-weighted average in the next subsection.</p>
</section></section><section id="spatial-join-and-summary-in-one-step" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="spatial-join-and-summary-in-one-step">
<span class="header-section-number">3.5</span> Spatial join and summary in one step</h2>
<p>In <a href="#sec-polygons-points" class="quarto-xref"><span>Section 3.4.3</span></a>, we first joined <code>KS_counties</code> and <code>KS_wells</code> uusing <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> and then applied <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code> to find total groundwater use per county. This two-step procedure can be done in one step using <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> with the summarizing function specified for the <code>FUN</code> option.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(source layer, target layer, <span class="at">FUN =</span> <span class="cf">function</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we are trying to find total groundwater use for each county, the target layer is <code>KS_counties</code>, the source layer is <code>KS_wells</code>, which has <code>af_used</code>, and the function to summarize is <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code>. So, the following code will replicate what we just did above:</p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- sum ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">KS_wells</span>, <span class="va">KS_counties</span>, FUN <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
       site      af_used in_hpa                       geometry
1    124453 1.701790e+01      0 MULTIPOLYGON (((806203.1 41...
2  12514550 6.261704e+04    159 MULTIPOLYGON (((233615.1 42...
3   1964254 1.737791e+03      0 MULTIPOLYGON (((544031.7 43...
4  42442400 3.023589e+05   1056 MULTIPOLYGON (((273665.9 41...
5  68068173 6.110576e+04   1294 MULTIPOLYGON (((546178.6 42...
6  15756801 9.664610e+04    477 MULTIPOLYGON (((229431.1 41...
7    149202 0.000000e+00      0 MULTIPOLYGON (((717254.1 42...
8  17167377 5.750807e+04    592 MULTIPOLYGON (((239494.1 44...
9   1809003 2.201696e+03     15 MULTIPOLYGON (((542298.2 44...
10   160064 4.571102e+00      0 MULTIPOLYGON (((804792.9 42...</code></pre>
</div>
</div>
<p>Notice that the <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> function was applied to all the columns in <code>KS_wells</code>, including site id number. So, you might want to select variables you want to join before you apply the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> function like this:</p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">KS_wells</span>, <span class="va">af_used</span><span class="op">)</span>, <span class="va">KS_counties</span>, FUN <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 1 field
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
        af_used                       geometry
1  1.701790e+01 MULTIPOLYGON (((806203.1 41...
2  6.261704e+04 MULTIPOLYGON (((233615.1 42...
3  1.737791e+03 MULTIPOLYGON (((544031.7 43...
4  3.023589e+05 MULTIPOLYGON (((273665.9 41...
5  6.110576e+04 MULTIPOLYGON (((546178.6 42...
6  9.664610e+04 MULTIPOLYGON (((229431.1 41...
7  0.000000e+00 MULTIPOLYGON (((717254.1 42...
8  5.750807e+04 MULTIPOLYGON (((239494.1 44...
9  2.201696e+03 MULTIPOLYGON (((542298.2 44...
10 4.571102e+00 MULTIPOLYGON (((804792.9 42...</code></pre>
</div>
</div>
</section><section id="spatial-intersection-cropping-join" class="level2 page-columns page-full" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="spatial-intersection-cropping-join">
<span class="header-section-number">3.6</span> Spatial intersection (cropping join)</h2>
<p>Sometimes, you may need to crop spatial objects by polygon boundaries. For instance, in the demonstration in <a href="01-Demonstration.html#sec-demo-railroad" class="quarto-xref"><span>Section 1.4</span></a>, we calculated the total length of railroads within each county by trimming the parts of the railroads that extended beyond county boundaries. Similarly, we cannot find area-weighted averages using <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> alone because it does not provide information about how much of each HUC unit intersects with a county. However, if we can obtain the geometry of the intersecting portions of the HUC unit and the county, we can calculate their areas, allowing us to compute area-weighted averages of the joined attributes.</p>
<p>For these purposes, we can use <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code>. Below, we illustrate how <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> works for line-polygon and polygon-polygon intersections (using data generated in <a href="#sec-topo" class="quarto-xref"><span>Section 3.1</span></a>). Intersections involving points with <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> are equivalent to using <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> since points have neither length nor area (nothing to crop). Therefore, they are not discussed here.</p>
<section id="sec-st-intersection" class="level3 page-columns page-full" data-number="3.6.1"><h3 data-number="3.6.1" class="anchored" data-anchor-id="sec-st-intersection">
<span class="header-section-number">3.6.1</span> <code>sf::st_intersection()</code>
</h3>
<p>While <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> returns the indices of intersecting objects, <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> returns the actual intersecting spatial objects, with the non-intersecting parts of the sf objects removed. Additionally, the attribute values from the source sf are merged with the intersecting geometries (<code>sfg</code>) in the target <code>sf</code>.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">line_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Lines"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-plot-lines-polygons" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plot-lines-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-plot-lines-polygons-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-lines-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.26: Visualization of the points, lines, and polygons
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>We will now explore how this works for both line-polygon and polygon-polygon intersections, using the same toy examples we used to demonstrate how <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> functions (<a href="#fig-plot-lines-polygons" class="quarto-xref">Figure&nbsp;<span>3.26</span></a> shows the lines and polygons).</p>
<hr>
<p><strong>lines and polygons</strong></p>
<p>The following code finds the intersection of the lines and the polygons.</p>
<div class="cell">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">intersections_lp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">lines</span>, <span class="va">polygons</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>int_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">line_name</span>, <span class="st">"-"</span>, <span class="va">polygon_name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 3 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 0 ymin: 0 xmax: 2.5 ymax: 2
CRS:           NA
    line_name polygon_name                              x         int_name
1      line 1    polygon 1        LINESTRING (0 0, 2 0.4) line 1-polygon 1
2      line 2    polygon 1   LINESTRING (1.5 0.5, 2 1.25) line 2-polygon 1
2.1    line 2    polygon 2 LINESTRING (2.166667 1.5, 2... line 2-polygon 2</code></pre>
</div>
</div>
<p>As shown in the output, each intersection between the lines and polygons becomes an observation (e.g., line 1-polygon 1, line 2-polygon 1, and line 2-polygon 2). Any part of the lines that does not intersect with a polygon is removed and does not appear in the returned sf object. To confirm this, see <a href="#fig-lines-polygons-int" class="quarto-xref">Figure&nbsp;<span>3.27</span></a> below:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- here are all the original polygons  ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- here is what is returned after st_intersection ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">intersections_lp</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">int_name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-lines-polygons-int" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lines-polygons-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-lines-polygons-int-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lines-polygons-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.27: The outcome of the intersections of the lines and polygons
</figcaption></figure>
</div>
</div>
</div>
<p>This approach also allows us to calculate the length of the line segments that are fully contained within the polygons, similar to what we did in <a href="01-Demonstration.html#sec-demo-railroad" class="quarto-xref"><span>Section 1.4</span></a>. Additionally, the attributes (e.g., <code>polygon_name</code>) from the source <code>sf</code> (the polygons) are merged with their intersecting lines. As a result, <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> not only transforms the original geometries but also joins the attributes, which is why I refer to this as a “cropping join.”</p>
<hr>
<p><strong>polygons and polygons</strong></p>
<p>The following code finds the intersection of polygon 1 and polygon 3 with polygon 2.</p>
<div class="cell">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">intersections_pp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">polygons</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, <span class="op">]</span>, <span class="va">polygons</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>int_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">polygon_name</span>, <span class="st">"-"</span>, <span class="va">polygon_name.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 2 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 0.5 ymin: 1.5 xmax: 2.3 ymax: 3.2
CRS:           NA
  polygon_name polygon_name.1                              x
1    polygon 1      polygon 2 POLYGON ((2 2, 2 1.5, 0.5 1...
3    polygon 3      polygon 2 POLYGON ((0.5 3.2, 2.3 3.2,...
             int_name
1 polygon 1-polygon 2
3 polygon 3-polygon 2</code></pre>
</div>
</div>
<p>As shown in <a href="#fig-polygons-polygons-int" class="quarto-xref">Figure&nbsp;<span>3.28</span></a>, each intersection between polygons 1 and 3 with polygon 2 becomes a separate observation (e.g., polygon 1-polygon 2 and polygon 3-polygon 2). Similar to the lines-polygons case, the non-intersecting parts of polygons 1 and 3 are removed and do not appear in the returned sf. Later, we will explore how <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> can be used to calculate area-weighted values from the intersecting polygons with the help of <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">sf::st_area()</a></code>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- here are all the original polygons  ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- here is what is returned after st_intersection ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">intersections_pp</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">int_name</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-polygons-polygons-int" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-polygons-polygons-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-polygons-polygons-int-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-polygons-polygons-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.28: The outcome of the intersections of polygon 2 and polygons 1 and 3
</figcaption></figure>
</div>
</div>
</div>
</section><section id="area-weighted-average" class="level3" data-number="3.6.2"><h3 data-number="3.6.2" class="anchored" data-anchor-id="area-weighted-average">
<span class="header-section-number">3.6.2</span> Area-weighted average</h3>
<p>Let’s now return to the example of HUC units and county-level corn acres data from <a href="#sec-sp-join" class="quarto-xref"><span>Section 3.4</span></a>. This time, we aim to calculate the area-weighted average of corn acres, rather than just the simple average.</p>
<p>Using <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code>, we can divide each HUC polygon into parts based on the boundaries of the intersecting counties. For each HUC polygon, the intersecting counties are identified, and the polygon is split according to these boundaries.</p>
<div class="cell">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">HUC_intersections</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">HUC_IA</span>, <span class="va">IA_corn</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>huc_county <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">HUC_CODE</span>, <span class="st">"-"</span>, <span class="va">county_code</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 349 features and 5 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 203228.6 ymin: 4470941 xmax: 736832.9 ymax: 4822687
Projected CRS: NAD83 / UTM zone 15N
First 10 features:
      HUC_CODE county_code year  acres                       geometry
732   07080207         083 2018 183500 POLYGON ((482923.9 4711643,...
803   07080205         083 2018 183500 POLYGON ((499725.6 4696873,...
826   07080105         083 2018 183500 POLYGON ((461853.2 4682925,...
627   10170204         141 2018 167000 POLYGON ((269364.9 4793311,...
687   10230003         141 2018 167000 POLYGON ((271504.3 4754685,...
731   10230002         141 2018 167000 POLYGON ((267684.6 4790972,...
683   07100003         081 2018 184500 POLYGON ((435951.2 4789348,...
686   07080203         081 2018 184500 MULTIPOLYGON (((459303.2 47...
732.1 07080207         081 2018 184500 POLYGON ((429573.1 4779788,...
747   07100005         081 2018 184500 POLYGON ((421044.8 4772268,...
        huc_county
732   07080207-083
803   07080205-083
826   07080105-083
627   10170204-141
687   10230003-141
731   10230002-141
683   07100003-081
686   07080203-081
732.1 07080207-081
747   07100005-081</code></pre>
</div>
</div>
<p>The key difference from the <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> example is that each observation in the returned data represents a unique HUC-county intersection. <a href="#fig-inter-ex" class="quarto-xref">Figure&nbsp;<span>3.29</span></a> below shows a map of all the intersections between the HUC unit with <code>HUC_CODE == 10170203</code> and its four intersecting counties.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>      <span class="va">HUC_intersections</span>,</span>
<span>      <span class="va">HUC_CODE</span> <span class="op">==</span> <span class="st">"10170203"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">huc_county</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_d</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-inter-ex" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-inter-ex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-inter-ex-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-inter-ex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.29: Intersections of a HUC unit and Iowa counties
</figcaption></figure>
</div>
</div>
</div>
<p>Note that the attributes from the county data, such as acres, are joined to the resulting intersections, as seen in the output above. As mentioned earlier, <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> performs a spetial type of join where the resulting observations are the intersections between the target and source <code>sf</code> objects.</p>
<p>To calculate the area-weighted average of corn acres, you can first use <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">sf::st_area()</a></code> to determine the area of each intersection. Then, compute the area-weighted average as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">HUC_aw_acres</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">HUC_intersections</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- get area ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">st_area</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- get area-weight by HUC unit ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">HUC_CODE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="va">area</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">area</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- calculate area-weighted corn acreage by HUC unit ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>aw_acres <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">*</span> <span class="va">acres</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 55 features and 2 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 203228.6 ymin: 4470941 xmax: 736832.9 ymax: 4822687
Projected CRS: NAD83 / UTM zone 15N
# A tibble: 55 × 3
   HUC_CODE aw_acres                                                    geometry
   &lt;chr&gt;       &lt;dbl&gt;                                              &lt;GEOMETRY [m]&gt;
 1 07020009  251185. POLYGON ((421060.3 4797550, 420940.3 4797420, 420860.3 479…
 2 07040008  165000  POLYGON ((602922.4 4817166, 602862.4 4816996, 602772.4 481…
 3 07060001  105234. MULTIPOLYGON (((649333.8 4761761, 648933.7 4761621, 648793…
 4 07060002  140201. MULTIPOLYGON (((593780.7 4816946, 594000.7 4816865, 594380…
 5 07060003  149000  MULTIPOLYGON (((692011.6 4712966, 691981.6 4712956, 691881…
 6 07060004  162123. POLYGON ((652046.5 4718813, 651916.4 4718783, 651786.4 471…
 7 07060005  142428. POLYGON ((734140.4 4642126, 733620.4 4641926, 733520.3 464…
 8 07060006  159635. POLYGON ((673976.9 4651911, 673950.7 4651910, 673887.8 465…
 9 07080101  115572. POLYGON ((666760.8 4558401, 666630.9 4558362, 666510.8 455…
10 07080102  160008. POLYGON ((576151.1 4706650, 575891 4706810, 575741 4706890…
# ℹ 45 more rows</code></pre>
</div>
</div>
</section></section><section id="sec-exercises-int-vv" class="level2 page-columns page-full" data-number="3.7"><h2 data-number="3.7" class="anchored" data-anchor-id="sec-exercises-int-vv">
<span class="header-section-number">3.7</span> Exercises</h2>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Before working on exercises, please run the following codes by hitting the <strong>Run Code</strong> button.</p>
<div id="qwebr-insertion-location-1"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Tips for working with an `webr` session">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tips for working with an <code>webr</code> session
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Hit the <strong>Run Code</strong> button to run all the codes in the code area.</li>
<li>To run only parts of the code, highlight the section you want to execute with your cursor and then press <strong>Cmd + Return</strong> (Mac) or <strong>Ctrl + Enter</strong> (Windows).</li>
<li>All the code blocks are interconnected and R objects defined in one R code block is available in another R code block.</li>
</ul>
</div>
</div>
<section id="exercise-1-spatially-intersecting-objects" class="level3 page-columns page-full" data-number="3.7.1"><h3 data-number="3.7.1" class="anchored" data-anchor-id="exercise-1-spatially-intersecting-objects">
<span class="header-section-number">3.7.1</span> Exercise 1: Spatially intersecting objects</h3>
<p>Find the points in <code>mower_sensor_sf</code> that are intersecting with any of the polygons in <code>fairway_grid</code>.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;Hint: see <a href="#sec-sf-subset" class="quarto-xref"><span>Section 3.3</span></a></p></div></div><div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Work here</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Answer</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div id="qwebr-insertion-location-2"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">intersecting_points</span> <span class="op">&lt;-</span> <span class="va">mower_sensor_sf</span><span class="op">[</span><span class="va">fairway_grid</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section><section id="exercise-2-spatial-subset-and-cropping" class="level3" data-number="3.7.2"><h3 data-number="3.7.2" class="anchored" data-anchor-id="exercise-2-spatial-subset-and-cropping">
<span class="header-section-number">3.7.2</span> Exercise 2: Spatial subset and cropping</h3>
<p>Run the following codes first and get the sense of their spatial positions:</p>
<div id="qwebr-insertion-location-3"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">Problem 1</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">Problem 2</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-3" role="tab" aria-controls="tabset-5-3" aria-selected="false">Problem 3</a></li>
</ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<p>Find the counties in Colorado that are intersecting with the High-Plains aquifer (<code>hp_boundary</code>) and name the resulting R object <code>subset_co_counties</code>. If you know how to create a map from <code>sf</code> objects using <code>ggplot2</code> (<a href="07-CreateMaps-ggplot.html" class="quarto-xref"><span>Chapter 7</span></a>), then create a map of the intersecting Colorado counties.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Work here</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Answer</a></li>
</ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div id="qwebr-insertion-location-4"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb109"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">subset_co_counties</span> <span class="op">&lt;-</span> <span class="va">co_counties</span><span class="op">[</span><span class="va">hp_boundary</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">subset_co_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<p>Crop the Colorado counties to <code>hpa_boundary</code> and name it <code>cropped_co_counties</code> If you know how to create a map from <code>sf</code> objects using <code>ggplot2</code> (<a href="07-CreateMaps-ggplot.html" class="quarto-xref"><span>Chapter 7</span></a>), then create a map of the cropped Colorado counties (with <code>aes(fill = "blue, alpha = 0.3)</code>) on top of all the Colorado counties.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Work here</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Answer</a></li>
</ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div id="qwebr-insertion-location-5"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb110"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cropped_co_counties</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">co_counties</span>, <span class="va">hp_boundary</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">co_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">cropped_co_counties</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-5-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-3-tab">
<p>Find the area of counties in <code>co_counties</code> (name the column <code>area</code>) and <code>cropped_co_counties</code> (name the column <code>area_cropped</code>). Then, join them together using <code>left_join</code> and filter the ones that satisfy <code>area_cropped &lt; area</code> to find out which counties were chopped off.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Work here</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Answer</a></li>
</ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div id="qwebr-insertion-location-6"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb111"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">subset_co_area</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">co_counties</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>area <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- make it non-sf so it can be merged with left_join later  ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">area</span>, <span class="va">COUNTYFP</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cropped_co_area</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">cropped_co_counties</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>area_cro <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- make it non-sf so it can be merged with left_join later  ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">area_cro</span>, <span class="va">COUNTYFP</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cut_off_counties</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">subset_co_area</span>, <span class="va">cropped_co_area</span>, by <span class="op">=</span> <span class="st">"COUNTYFP"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">area</span> <span class="op">&lt;</span> <span class="va">area_cro</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!--end of panel-->
</section><section id="exercise-3-spatial-join" class="level3" data-number="3.7.3"><h3 data-number="3.7.3" class="anchored" data-anchor-id="exercise-3-spatial-join">
<span class="header-section-number">3.7.3</span> Exercise 3: Spatial join</h3>
<p>In this exercise, we will use Nebraska county boundaries (<code>ne_counties</code>) and irrigation wells in Nebraska (<code>wells_ne_sf</code>).</p>
<div id="qwebr-insertion-location-7"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" role="tab" aria-controls="tabset-8-1" aria-selected="true">Problem 1</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" role="tab" aria-controls="tabset-8-2" aria-selected="false">Problem 2</a></li>
</ul>
<div class="tab-content">
<div id="tabset-8-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-8-1-tab">
<p>Spatially join <code>ne_counties</code> with <code>wells_ne_sf</code> and then find the total amount of groundwater extracted (<code>gw_extracted</code>) per county.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">Work here</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">Answer</a></li>
</ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div id="qwebr-insertion-location-8"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb112"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">ne_counties</span>, <span class="va">wells_ne_sf</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- geometry no longer neded (makes summary faster later) ---#</span></span>
<span>  <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">countyfp</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>tot_gw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">gw_extracted</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-8-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-2-tab">
<p>Use <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> instead to do the process implemented in Problem 1 in one step.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true">Work here</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false">Answer</a></li>
</ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<div id="qwebr-insertion-location-9"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb113"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">wells_ne_sf</span>, <span class="va">ne_counties</span>, FUN <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!--end of panel-->
</section><section id="exercise-3-spatial-join-1" class="level3" data-number="3.7.4"><h3 data-number="3.7.4" class="anchored" data-anchor-id="exercise-3-spatial-join-1">
<span class="header-section-number">3.7.4</span> Exercise 3: Spatial join</h3>
<p>In this exercise, we use soybean yield (<code>soy_yield</code>) and as-applied seed rate (<code>as_applied_s_rate</code>) within a production field.</p>
<div id="qwebr-insertion-location-10"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
<p>For each of the yield points, find all the seed rate points within 10 meter. Then, find the average of the neighboring seed rates by yield point.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-9-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-1" role="tab" aria-controls="tabset-9-1" aria-selected="true">Work here</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-2" role="tab" aria-controls="tabset-9-2" aria-selected="false">Answer</a></li>
</ul>
<div class="tab-content">
<div id="tabset-9-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-9-1-tab">
<div id="qwebr-insertion-location-11"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</div>
<div id="tabset-9-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-2-tab">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb114"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">soy_seed</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">st_join</span><span class="op">(</span></span>
<span>    <span class="va">soy_yield</span>,</span>
<span>    <span class="va">as_applied_s_rate</span>,</span>
<span>    join <span class="op">=</span> \<span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fu">st_is_within_distance</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, dist <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">soy_seed</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">yield_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>avg_seed_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">seed_rate</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tmieno2\.github\.io\/R-as-GIS-for-Economists\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/02-VectorDataBasics.html" class="pagination-link" aria-label="Vector Data Handling with `sf`">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/04-RasterDataBasics.html" class="pagination-link" aria-label="Raster Data Handling">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb115" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="an">webr:</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="co">  # packages: ['dplyr', 'ggplot2', 'sf']</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="co">  cell-options:</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a><span class="co">    editor-font-scale: 0.8</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="co">    out-width: 70%</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a><span class="an">filters:</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - webr</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatial Interactions of Vector Data: Subsetting and Joining {#sec-int-vv}</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setwd, eval = FALSE, echo = FALSE}</span></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a><span class="in">setwd(here::here())</span></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include = FALSE, cache = FALSE}</span></span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a><span class="in">#--- load packages ---#</span></span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a><span class="in">library(data.table)</span></span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a><span class="in">library(exactextractr)</span></span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a><span class="in">library(stringr)</span></span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a><span class="in">library(raster)</span></span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a><span class="in">library(tictoc)</span></span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a><span class="in">library(stargazer)</span></span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a><span class="in">library(tmap)</span></span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a><span class="in">library(future.apply)</span></span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a><span class="in">library(lubridate)</span></span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a><span class="in">```{r chap3_figure_setup, echo = FALSE, cache = FALSE}</span></span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(</span></span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.title.x = element_text(size = 12, angle = 0, hjust = .5, vjust = -0.3, face = "plain", family = "Times"),</span></span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.title.y = element_text(size = 12, angle = 90, hjust = .5, vjust = .9, face = "plain", family = "Times"),</span></span>
<span id="cb115-39"><a href="#cb115-39" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text.x = element_text(size = 12, angle = 0, hjust = .5, vjust = 1.5, face = "plain", family = "Times"),</span></span>
<span id="cb115-40"><a href="#cb115-40" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text.y = element_text(size = 12, angle = 0, hjust = 1, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb115-41"><a href="#cb115-41" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks = element_line(size = 0.3, linetype = "solid"),</span></span>
<span id="cb115-42"><a href="#cb115-42" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.ticks = element_blank(),</span></span>
<span id="cb115-43"><a href="#cb115-43" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks.length = unit(.15, "cm"),</span></span>
<span id="cb115-44"><a href="#cb115-44" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.ticks.margin = unit(.1,'cm'),</span></span>
<span id="cb115-45"><a href="#cb115-45" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.text = element_text(margin=unit(.1,'cm')),</span></span>
<span id="cb115-46"><a href="#cb115-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-47"><a href="#cb115-47" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- legend ---#</span></span>
<span id="cb115-48"><a href="#cb115-48" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.text = element_text(size = 12, angle = 0, hjust = 0, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb115-49"><a href="#cb115-49" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.title = element_text(size = 12, angle = 0, hjust = 0, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb115-50"><a href="#cb115-50" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.key.size = unit(0.5, "cm"),</span></span>
<span id="cb115-51"><a href="#cb115-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-52"><a href="#cb115-52" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- strip (for faceting) ---#</span></span>
<span id="cb115-53"><a href="#cb115-53" aria-hidden="true" tabindex="-1"></a><span class="in">  strip.text = element_text(size = 12, family = "Times"),</span></span>
<span id="cb115-54"><a href="#cb115-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-55"><a href="#cb115-55" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- plot title ---#</span></span>
<span id="cb115-56"><a href="#cb115-56" aria-hidden="true" tabindex="-1"></a><span class="in">  plot.title = element_text(family = "Times", face = "bold", size = 12),</span></span>
<span id="cb115-57"><a href="#cb115-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-58"><a href="#cb115-58" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- margin ---#</span></span>
<span id="cb115-59"><a href="#cb115-59" aria-hidden="true" tabindex="-1"></a><span class="in">  # plot.margin = margin(0, 0, 0, 0, "cm"),</span></span>
<span id="cb115-60"><a href="#cb115-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-61"><a href="#cb115-61" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- panel ---#</span></span>
<span id="cb115-62"><a href="#cb115-62" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.major = element_blank(),</span></span>
<span id="cb115-63"><a href="#cb115-63" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.minor = element_blank(),</span></span>
<span id="cb115-64"><a href="#cb115-64" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.background = element_blank(),</span></span>
<span id="cb115-65"><a href="#cb115-65" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.border = element_rect(fill = NA)</span></span>
<span id="cb115-66"><a href="#cb115-66" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-67"><a href="#cb115-67" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-68"><a href="#cb115-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-69"><a href="#cb115-69" aria-hidden="true" tabindex="-1"></a><span class="fu">## Before you start {-}</span></span>
<span id="cb115-70"><a href="#cb115-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-71"><a href="#cb115-71" aria-hidden="true" tabindex="-1"></a>In this chapter, we explore the spatial interactions between two <span class="in">`sf`</span> objects. We begin by examining topological relations—how two spatial objects relate to each other—focusing on <span class="in">`sf::st_intersects()`</span> and <span class="in">`sf::st_is_within_distance()`</span>. <span class="in">`sf::st_intersects()`</span> is particularly important as it is the most commonly used topological relation and serves as the default for spatial subsetting and joining in <span class="in">`sf`</span>.</span>
<span id="cb115-72"><a href="#cb115-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-73"><a href="#cb115-73" aria-hidden="true" tabindex="-1"></a>Next, we cover spatial subsetting, which involves filtering spatial data based on the geographic features of another dataset. Finally, we will discuss spatial joining, where attribute values from one spatial dataset are assigned to another based on their topological relationship^<span class="co">[</span><span class="ot">For those familiar with the `sp` package, these operations are similar to `sp::over()`.</span><span class="co">]</span>. </span>
<span id="cb115-74"><a href="#cb115-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-75"><a href="#cb115-75" aria-hidden="true" tabindex="-1"></a>To test your knowledge, you can work on coding exercises at @sec-exercises-int-vv.</span>
<span id="cb115-76"><a href="#cb115-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-77"><a href="#cb115-77" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direction for replication {-}</span></span>
<span id="cb115-78"><a href="#cb115-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-79"><a href="#cb115-79" aria-hidden="true" tabindex="-1"></a>**Datasets**</span>
<span id="cb115-80"><a href="#cb115-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-81"><a href="#cb115-81" aria-hidden="true" tabindex="-1"></a>All the datasets that you need to import are available <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/vhtpjiezijb97lj/AABpvzqdyZMkR1DgUBeI_mOja?dl=0)</span>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</span>
<span id="cb115-82"><a href="#cb115-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-83"><a href="#cb115-83" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>set a folder (any folder) as the working directory using <span class="in">`setwd()`</span>  </span>
<span id="cb115-84"><a href="#cb115-84" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>create a folder called "Data" inside the folder designated as the working directory (if you have created a "Data" folder previously, skip this step)</span>
<span id="cb115-85"><a href="#cb115-85" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>download the pertinent datasets from <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/vhtpjiezijb97lj/AABpvzqdyZMkR1DgUBeI_mOja?dl=0)</span> </span>
<span id="cb115-86"><a href="#cb115-86" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>place all the files in the downloaded folder in the "Data" folder</span>
<span id="cb115-87"><a href="#cb115-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-88"><a href="#cb115-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-89"><a href="#cb115-89" aria-hidden="true" tabindex="-1"></a>**Packages**</span>
<span id="cb115-90"><a href="#cb115-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-91"><a href="#cb115-91" aria-hidden="true" tabindex="-1"></a>Run the following code to install or load (if already installed) the <span class="in">`pacman`</span> package, and then install or load (if already installed) the listed package inside the <span class="in">`pacman::p_load()`</span> function.</span>
<span id="cb115-92"><a href="#cb115-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-93"><a href="#cb115-93" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Chap_3_packages, cache = F}</span></span>
<span id="cb115-94"><a href="#cb115-94" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require("pacman")) install.packages("pacman")</span></span>
<span id="cb115-95"><a href="#cb115-95" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(</span></span>
<span id="cb115-96"><a href="#cb115-96" aria-hidden="true" tabindex="-1"></a><span class="in">  sf, # vector data operations</span></span>
<span id="cb115-97"><a href="#cb115-97" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr, # data wrangling</span></span>
<span id="cb115-98"><a href="#cb115-98" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table, # data wrangling</span></span>
<span id="cb115-99"><a href="#cb115-99" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot2, # for map creation</span></span>
<span id="cb115-100"><a href="#cb115-100" aria-hidden="true" tabindex="-1"></a><span class="in">  tmap # for map creation</span></span>
<span id="cb115-101"><a href="#cb115-101" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-102"><a href="#cb115-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-103"><a href="#cb115-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-104"><a href="#cb115-104" aria-hidden="true" tabindex="-1"></a><span class="fu">## Topological relations {#sec-topo}</span></span>
<span id="cb115-105"><a href="#cb115-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-106"><a href="#cb115-106" aria-hidden="true" tabindex="-1"></a>Before diving into spatial subsetting and joining, we first examine topological relations. These refer to how multiple spatial objects are related to each other in space. The <span class="in">`sf`</span> package provides various functions to identify these spatial relationships, with our primary focus being on intersections, which can be identified using <span class="in">`sf::st_intersects()`</span>^<span class="co">[</span><span class="ot">Other topological relations like `st_within()` or `st_touches()` are rarely used.</span><span class="co">]</span>. We will also briefly explore <span class="in">`sf::st_is_within_distance()`</span>. If you're interested in other topological relations, you can check the documentation with <span class="in">`?geos_binary_pred`</span>.</span>
<span id="cb115-107"><a href="#cb115-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-108"><a href="#cb115-108" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data preparation</span></span>
<span id="cb115-109"><a href="#cb115-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-110"><a href="#cb115-110" aria-hidden="true" tabindex="-1"></a>We will use three <span class="in">`sf`</span> objects: <span class="in">`points`</span>, <span class="in">`lines`</span>, and <span class="in">`polygons`</span>. </span>
<span id="cb115-111"><a href="#cb115-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-112"><a href="#cb115-112" aria-hidden="true" tabindex="-1"></a>**POINTS**</span>
<span id="cb115-113"><a href="#cb115-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-114"><a href="#cb115-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_points}</span></span>
<span id="cb115-115"><a href="#cb115-115" aria-hidden="true" tabindex="-1"></a><span class="in">#--- create points ---#</span></span>
<span id="cb115-116"><a href="#cb115-116" aria-hidden="true" tabindex="-1"></a><span class="in">point_1 &lt;- sf::st_point(c(2, 2))</span></span>
<span id="cb115-117"><a href="#cb115-117" aria-hidden="true" tabindex="-1"></a><span class="in">point_2 &lt;- sf::st_point(c(1, 1))</span></span>
<span id="cb115-118"><a href="#cb115-118" aria-hidden="true" tabindex="-1"></a><span class="in">point_3 &lt;- sf::st_point(c(1, 3))</span></span>
<span id="cb115-119"><a href="#cb115-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-120"><a href="#cb115-120" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine the points to make a single  sf of points ---#</span></span>
<span id="cb115-121"><a href="#cb115-121" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-122"><a href="#cb115-122" aria-hidden="true" tabindex="-1"></a><span class="in">points &lt;- </span></span>
<span id="cb115-123"><a href="#cb115-123" aria-hidden="true" tabindex="-1"></a><span class="in">  list(point_1, point_2, point_3) %&gt;% </span></span>
<span id="cb115-124"><a href="#cb115-124" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% </span></span>
<span id="cb115-125"><a href="#cb115-125" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf() %&gt;% </span></span>
<span id="cb115-126"><a href="#cb115-126" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(point_name = c("point 1", "point 2", "point 3"))</span></span>
<span id="cb115-127"><a href="#cb115-127" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-128"><a href="#cb115-128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-129"><a href="#cb115-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-130"><a href="#cb115-130" aria-hidden="true" tabindex="-1"></a>**LINES**</span>
<span id="cb115-131"><a href="#cb115-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-132"><a href="#cb115-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_lines}</span></span>
<span id="cb115-133"><a href="#cb115-133" aria-hidden="true" tabindex="-1"></a><span class="in">#--- create points ---#</span></span>
<span id="cb115-134"><a href="#cb115-134" aria-hidden="true" tabindex="-1"></a><span class="in">line_1 &lt;- sf::st_linestring(rbind(c(0, 0), c(2.5, 0.5)))</span></span>
<span id="cb115-135"><a href="#cb115-135" aria-hidden="true" tabindex="-1"></a><span class="in">line_2 &lt;- sf::st_linestring(rbind(c(1.5, 0.5), c(2.5, 2)))</span></span>
<span id="cb115-136"><a href="#cb115-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-137"><a href="#cb115-137" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine the points to make a single  sf of points ---#</span></span>
<span id="cb115-138"><a href="#cb115-138" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-139"><a href="#cb115-139" aria-hidden="true" tabindex="-1"></a><span class="in">lines &lt;- </span></span>
<span id="cb115-140"><a href="#cb115-140" aria-hidden="true" tabindex="-1"></a><span class="in">  list(line_1, line_2) %&gt;% </span></span>
<span id="cb115-141"><a href="#cb115-141" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% </span></span>
<span id="cb115-142"><a href="#cb115-142" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf() %&gt;% </span></span>
<span id="cb115-143"><a href="#cb115-143" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(line_name = c("line 1", "line 2"))</span></span>
<span id="cb115-144"><a href="#cb115-144" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-145"><a href="#cb115-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-146"><a href="#cb115-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-147"><a href="#cb115-147" aria-hidden="true" tabindex="-1"></a>**POLYGONS**</span>
<span id="cb115-148"><a href="#cb115-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-149"><a href="#cb115-149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_polygons}</span></span>
<span id="cb115-150"><a href="#cb115-150" aria-hidden="true" tabindex="-1"></a><span class="in">#--- create polygons ---#</span></span>
<span id="cb115-151"><a href="#cb115-151" aria-hidden="true" tabindex="-1"></a><span class="in">polygon_1 &lt;- sf::st_polygon(list(</span></span>
<span id="cb115-152"><a href="#cb115-152" aria-hidden="true" tabindex="-1"></a><span class="in">  rbind(c(0, 0), c(2, 0), c(2, 2), c(0, 2), c(0, 0)) </span></span>
<span id="cb115-153"><a href="#cb115-153" aria-hidden="true" tabindex="-1"></a><span class="in">))</span></span>
<span id="cb115-154"><a href="#cb115-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-155"><a href="#cb115-155" aria-hidden="true" tabindex="-1"></a><span class="in">polygon_2 &lt;- sf::st_polygon(list(</span></span>
<span id="cb115-156"><a href="#cb115-156" aria-hidden="true" tabindex="-1"></a><span class="in">  rbind(c(0.5, 1.5), c(0.5, 3.5), c(2.5, 3.5), c(2.5, 1.5), c(0.5, 1.5)) </span></span>
<span id="cb115-157"><a href="#cb115-157" aria-hidden="true" tabindex="-1"></a><span class="in">))</span></span>
<span id="cb115-158"><a href="#cb115-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-159"><a href="#cb115-159" aria-hidden="true" tabindex="-1"></a><span class="in">polygon_3 &lt;- sf::st_polygon(list(</span></span>
<span id="cb115-160"><a href="#cb115-160" aria-hidden="true" tabindex="-1"></a><span class="in">  rbind(c(0.5, 2.5), c(0.5, 3.2), c(2.3, 3.2), c(2, 2), c(0.5, 2.5)) </span></span>
<span id="cb115-161"><a href="#cb115-161" aria-hidden="true" tabindex="-1"></a><span class="in">))</span></span>
<span id="cb115-162"><a href="#cb115-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-163"><a href="#cb115-163" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine the polygons to make an sf of polygons ---#</span></span>
<span id="cb115-164"><a href="#cb115-164" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-165"><a href="#cb115-165" aria-hidden="true" tabindex="-1"></a><span class="in">polygons &lt;- </span></span>
<span id="cb115-166"><a href="#cb115-166" aria-hidden="true" tabindex="-1"></a><span class="in">  list(polygon_1, polygon_2, polygon_3) %&gt;% </span></span>
<span id="cb115-167"><a href="#cb115-167" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% </span></span>
<span id="cb115-168"><a href="#cb115-168" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf() %&gt;% </span></span>
<span id="cb115-169"><a href="#cb115-169" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(polygon_name = c("polygon 1", "polygon 2", "polygon 3"))</span></span>
<span id="cb115-170"><a href="#cb115-170" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-171"><a href="#cb115-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-172"><a href="#cb115-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-173"><a href="#cb115-173" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb115-174"><a href="#cb115-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-175"><a href="#cb115-175" aria-hidden="true" tabindex="-1"></a>@fig-plot-point-polygons shows how they look together: </span>
<span id="cb115-176"><a href="#cb115-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-179"><a href="#cb115-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-180"><a href="#cb115-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-plot-point-polygons</span></span>
<span id="cb115-181"><a href="#cb115-181" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visualization of the points, lines, and polygons" </span></span>
<span id="cb115-182"><a href="#cb115-182" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb115-183"><a href="#cb115-183" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-184"><a href="#cb115-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-185"><a href="#cb115-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>) <span class="sc">+</span></span>
<span id="cb115-186"><a href="#cb115-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> lines, <span class="fu">aes</span>(<span class="at">color =</span> line_name)) <span class="sc">+</span></span>
<span id="cb115-187"><a href="#cb115-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"Lines"</span>) <span class="sc">+</span> </span>
<span id="cb115-188"><a href="#cb115-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> points, <span class="fu">aes</span>(<span class="at">shape =</span> point_name), <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb115-189"><a href="#cb115-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_discrete</span>(<span class="at">name =</span> <span class="st">"Points"</span>)  </span>
<span id="cb115-190"><a href="#cb115-190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-191"><a href="#cb115-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-192"><a href="#cb115-192" aria-hidden="true" tabindex="-1"></a><span class="fu">### `sf::st_intersects()`</span></span>
<span id="cb115-193"><a href="#cb115-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-194"><a href="#cb115-194" aria-hidden="true" tabindex="-1"></a><span class="in">`sf::st_intersects()`</span> identifies which <span class="in">`sfg`</span> object in an <span class="in">`sf`</span> (or <span class="in">`sfc`</span>) intersects with <span class="in">`sfg`</span> object(s) in another <span class="in">`sf`</span>. For example, you can use the function to identify which well is located within which county. <span class="in">`sf::st_intersects()`</span> is the most commonly used topological relation. It is important to understand what it does as it is the default topological relation used when performing spatial subsetting and joining, which we will cover later.  </span>
<span id="cb115-195"><a href="#cb115-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-196"><a href="#cb115-196" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb115-197"><a href="#cb115-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-198"><a href="#cb115-198" aria-hidden="true" tabindex="-1"></a>**points and polygons** (@fig-points-polygons)</span>
<span id="cb115-199"><a href="#cb115-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-200"><a href="#cb115-200" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-203"><a href="#cb115-203" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-204"><a href="#cb115-204" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-points-polygons</span></span>
<span id="cb115-205"><a href="#cb115-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb115-206"><a href="#cb115-206" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-207"><a href="#cb115-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-208"><a href="#cb115-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>) <span class="sc">+</span></span>
<span id="cb115-209"><a href="#cb115-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> points, <span class="fu">aes</span>(<span class="at">shape =</span> point_name), <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb115-210"><a href="#cb115-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_discrete</span>(<span class="at">name =</span> <span class="st">"Points"</span>)</span>
<span id="cb115-211"><a href="#cb115-211" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-212"><a href="#cb115-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-213"><a href="#cb115-213" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-214"><a href="#cb115-214" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-215"><a href="#cb115-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-216"><a href="#cb115-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r intersects_point_polygons}</span></span>
<span id="cb115-217"><a href="#cb115-217" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_intersects(points, polygons)</span></span>
<span id="cb115-218"><a href="#cb115-218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-219"><a href="#cb115-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-220"><a href="#cb115-220" aria-hidden="true" tabindex="-1"></a>As you can see, the output is a list of which polygon(s) each of the points intersect with. The numbers 1, 2, and 3 in the first row mean that 1st (polygon 1), 2nd (polygon 2), and 3rd (polygon 3) objects of the <span class="in">`polygons`</span> intersect with the first point (point 1) of the <span class="in">`points`</span> object. The fact that point 1 is considered to be intersecting with polygon 2 means that the area inside the border is considered a part of the polygon (of course). </span>
<span id="cb115-221"><a href="#cb115-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-222"><a href="#cb115-222" aria-hidden="true" tabindex="-1"></a>If you would like the results of <span class="in">`sf::st_intersects()`</span> in a matrix form with boolean values filling the matrix, you can add <span class="in">`sparse = FALSE`</span> option. </span>
<span id="cb115-223"><a href="#cb115-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-224"><a href="#cb115-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb115-225"><a href="#cb115-225" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_intersects(points, polygons, sparse = FALSE)</span></span>
<span id="cb115-226"><a href="#cb115-226" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-227"><a href="#cb115-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-228"><a href="#cb115-228" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb115-229"><a href="#cb115-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-230"><a href="#cb115-230" aria-hidden="true" tabindex="-1"></a>**lines and polygons** (@fig-lines-polygons)</span>
<span id="cb115-231"><a href="#cb115-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-232"><a href="#cb115-232" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-235"><a href="#cb115-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-236"><a href="#cb115-236" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-lines-polygons</span></span>
<span id="cb115-237"><a href="#cb115-237" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb115-238"><a href="#cb115-238" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-239"><a href="#cb115-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-240"><a href="#cb115-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>) <span class="sc">+</span></span>
<span id="cb115-241"><a href="#cb115-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> lines, <span class="fu">aes</span>(<span class="at">color =</span> line_name)) <span class="sc">+</span></span>
<span id="cb115-242"><a href="#cb115-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"Lines"</span>)</span>
<span id="cb115-243"><a href="#cb115-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-244"><a href="#cb115-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-245"><a href="#cb115-245" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-246"><a href="#cb115-246" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-247"><a href="#cb115-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-248"><a href="#cb115-248" aria-hidden="true" tabindex="-1"></a><span class="in">```{r intersects_lines_polygons}</span></span>
<span id="cb115-249"><a href="#cb115-249" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_intersects(lines, polygons)</span></span>
<span id="cb115-250"><a href="#cb115-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-251"><a href="#cb115-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-252"><a href="#cb115-252" aria-hidden="true" tabindex="-1"></a>The output is a list of which polygon(s) each of the lines intersect with. For example, line intersects with the 1st and 2nd elements of <span class="in">`polygons`</span>, which are <span class="in">`polygon 1`</span> and <span class="in">`polygon 2`</span>.</span>
<span id="cb115-253"><a href="#cb115-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-254"><a href="#cb115-254" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb115-255"><a href="#cb115-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-256"><a href="#cb115-256" aria-hidden="true" tabindex="-1"></a>**polygons and polygons** (@fig-polygons-polygons)</span>
<span id="cb115-257"><a href="#cb115-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-258"><a href="#cb115-258" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-261"><a href="#cb115-261" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-262"><a href="#cb115-262" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-polygons-polygons</span></span>
<span id="cb115-263"><a href="#cb115-263" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb115-264"><a href="#cb115-264" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-265"><a href="#cb115-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-266"><a href="#cb115-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>)</span>
<span id="cb115-267"><a href="#cb115-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-268"><a href="#cb115-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-269"><a href="#cb115-269" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-270"><a href="#cb115-270" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-271"><a href="#cb115-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-272"><a href="#cb115-272" aria-hidden="true" tabindex="-1"></a>For polygons vs polygons interaction, <span class="in">`sf::st_intersects()`</span> identifies any polygons that either touches (even at a point like polygons 1 and 3) or share some area.</span>
<span id="cb115-273"><a href="#cb115-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-274"><a href="#cb115-274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb115-275"><a href="#cb115-275" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_intersects(polygons, polygons)</span></span>
<span id="cb115-276"><a href="#cb115-276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-277"><a href="#cb115-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-278"><a href="#cb115-278" aria-hidden="true" tabindex="-1"></a>Clearly, all of them interact with all the polygons (including themselves) in this case.</span>
<span id="cb115-279"><a href="#cb115-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-280"><a href="#cb115-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-281"><a href="#cb115-281" aria-hidden="true" tabindex="-1"></a><span class="fu">### `sf::st_is_within_distance()`</span></span>
<span id="cb115-282"><a href="#cb115-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-283"><a href="#cb115-283" aria-hidden="true" tabindex="-1"></a>This function identifies whether two spatial objects are within the distance you specify^<span class="co">[</span><span class="ot">For example, this function can be useful to identify neighbors. For example, you may want to find irrigation wells located around well $i$ to label them as well $i$'s neighbor.</span><span class="co">]</span>.</span>
<span id="cb115-284"><a href="#cb115-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-285"><a href="#cb115-285" aria-hidden="true" tabindex="-1"></a>We will use two sets of points data.</span>
<span id="cb115-286"><a href="#cb115-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-287"><a href="#cb115-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_random_points}</span></span>
<span id="cb115-288"><a href="#cb115-288" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb115-289"><a href="#cb115-289" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(38424738)</span></span>
<span id="cb115-290"><a href="#cb115-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-291"><a href="#cb115-291" aria-hidden="true" tabindex="-1"></a><span class="in">points_set_1 &lt;-</span></span>
<span id="cb115-292"><a href="#cb115-292" aria-hidden="true" tabindex="-1"></a><span class="in">  lapply(1:5, function(x) sf::st_point(runif(2))) %&gt;% </span></span>
<span id="cb115-293"><a href="#cb115-293" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% sf::st_as_sf() %&gt;% </span></span>
<span id="cb115-294"><a href="#cb115-294" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(id = 1:nrow(.))</span></span>
<span id="cb115-295"><a href="#cb115-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-296"><a href="#cb115-296" aria-hidden="true" tabindex="-1"></a><span class="in">points_set_2 &lt;-</span></span>
<span id="cb115-297"><a href="#cb115-297" aria-hidden="true" tabindex="-1"></a><span class="in">  lapply(1:5, function(x) sf::st_point(runif(2))) %&gt;% </span></span>
<span id="cb115-298"><a href="#cb115-298" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% sf::st_as_sf() %&gt;% </span></span>
<span id="cb115-299"><a href="#cb115-299" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(id = 1:nrow(.))</span></span>
<span id="cb115-300"><a href="#cb115-300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-301"><a href="#cb115-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-304"><a href="#cb115-304" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-305"><a href="#cb115-305" aria-hidden="true" tabindex="-1"></a>points_set_1</span>
<span id="cb115-306"><a href="#cb115-306" aria-hidden="true" tabindex="-1"></a>points_set_2</span>
<span id="cb115-307"><a href="#cb115-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-308"><a href="#cb115-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-309"><a href="#cb115-309" aria-hidden="true" tabindex="-1"></a>Here is how they are spatially distributed (@fig-map-points-points-points). Instead of circles of points, their corresponding <span class="in">`id`</span> (or equivalently row number here) values are displayed.</span>
<span id="cb115-310"><a href="#cb115-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-313"><a href="#cb115-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-314"><a href="#cb115-314" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-315"><a href="#cb115-315" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-points-points-points </span></span>
<span id="cb115-316"><a href="#cb115-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The locations of the set of points"</span></span>
<span id="cb115-317"><a href="#cb115-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb115-318"><a href="#cb115-318" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-319"><a href="#cb115-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> points_set_1, <span class="fu">aes</span>(<span class="at">label =</span> id), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb115-320"><a href="#cb115-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> points_set_2, <span class="fu">aes</span>(<span class="at">label =</span> id), <span class="at">color =</span> <span class="st">"blue"</span>) </span>
<span id="cb115-321"><a href="#cb115-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-322"><a href="#cb115-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-323"><a href="#cb115-323" aria-hidden="true" tabindex="-1"></a>We want to know which of the blue points (<span class="in">`points_set_2`</span>) are located within 0.2 from each of the red points (<span class="in">`points_set_1`</span>). @fig-points-points-within gives us the answer visually.</span>
<span id="cb115-324"><a href="#cb115-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-327"><a href="#cb115-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-328"><a href="#cb115-328" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-points-points-within</span></span>
<span id="cb115-329"><a href="#cb115-329" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The blue points within 0.2 radius of the red points"</span></span>
<span id="cb115-330"><a href="#cb115-330" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-331"><a href="#cb115-331" aria-hidden="true" tabindex="-1"></a><span class="co">#--- create 0.2 buffers around points in points_set_1 ---#</span></span>
<span id="cb115-332"><a href="#cb115-332" aria-hidden="true" tabindex="-1"></a>buffer_1 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(points_set_1, <span class="at">dist =</span> <span class="fl">0.2</span>)</span>
<span id="cb115-333"><a href="#cb115-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-334"><a href="#cb115-334" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-335"><a href="#cb115-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> buffer_1, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb115-336"><a href="#cb115-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> points_set_1, <span class="fu">aes</span>(<span class="at">label =</span> id), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb115-337"><a href="#cb115-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> points_set_2, <span class="fu">aes</span>(<span class="at">label =</span> id), <span class="at">color =</span> <span class="st">"blue"</span>) </span>
<span id="cb115-338"><a href="#cb115-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-339"><a href="#cb115-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-340"><a href="#cb115-340" aria-hidden="true" tabindex="-1"></a>Confirm your visual inspection results with the outcome of the following code using <span class="in">`sf::st_is_within_distance()`</span> function.</span>
<span id="cb115-341"><a href="#cb115-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-342"><a href="#cb115-342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r within_distance_blue_red}</span></span>
<span id="cb115-343"><a href="#cb115-343" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_is_within_distance(points_set_1, points_set_2, dist = 0.2)</span></span>
<span id="cb115-344"><a href="#cb115-344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-345"><a href="#cb115-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-346"><a href="#cb115-346" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial cropping</span></span>
<span id="cb115-347"><a href="#cb115-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-348"><a href="#cb115-348" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data preparation</span></span>
<span id="cb115-349"><a href="#cb115-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-350"><a href="#cb115-350" aria-hidden="true" tabindex="-1"></a>Let's import the following files: </span>
<span id="cb115-351"><a href="#cb115-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-352"><a href="#cb115-352" aria-hidden="true" tabindex="-1"></a><span class="in">```{r hp_import, results = "hide"}</span></span>
<span id="cb115-353"><a href="#cb115-353" aria-hidden="true" tabindex="-1"></a><span class="in">#--- Kansas county borders ---#</span></span>
<span id="cb115-354"><a href="#cb115-354" aria-hidden="true" tabindex="-1"></a><span class="in">KS_counties &lt;-</span></span>
<span id="cb115-355"><a href="#cb115-355" aria-hidden="true" tabindex="-1"></a><span class="in">  readRDS("Data/KS_county_borders.rds") %&gt;%</span></span>
<span id="cb115-356"><a href="#cb115-356" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(32614)</span></span>
<span id="cb115-357"><a href="#cb115-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-358"><a href="#cb115-358" aria-hidden="true" tabindex="-1"></a><span class="in">#--- High-Plains Aquifer boundary ---#</span></span>
<span id="cb115-359"><a href="#cb115-359" aria-hidden="true" tabindex="-1"></a><span class="in">hpa &lt;- </span></span>
<span id="cb115-360"><a href="#cb115-360" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_read("Data/hp_bound2010.shp") %&gt;%</span></span>
<span id="cb115-361"><a href="#cb115-361" aria-hidden="true" tabindex="-1"></a><span class="in">  .[1, ] %&gt;%</span></span>
<span id="cb115-362"><a href="#cb115-362" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(st_crs(KS_counties))</span></span>
<span id="cb115-363"><a href="#cb115-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-364"><a href="#cb115-364" aria-hidden="true" tabindex="-1"></a><span class="in">#--- all the irrigation wells in KS ---#</span></span>
<span id="cb115-365"><a href="#cb115-365" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells &lt;- </span></span>
<span id="cb115-366"><a href="#cb115-366" aria-hidden="true" tabindex="-1"></a><span class="in">  readRDS("Data/Kansas_wells.rds") %&gt;%</span></span>
<span id="cb115-367"><a href="#cb115-367" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(st_crs(KS_counties))</span></span>
<span id="cb115-368"><a href="#cb115-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-369"><a href="#cb115-369" aria-hidden="true" tabindex="-1"></a><span class="in">#--- US railroads in the Mid West region ---#</span></span>
<span id="cb115-370"><a href="#cb115-370" aria-hidden="true" tabindex="-1"></a><span class="in">rail_roads_mw &lt;- sf::st_read("Data/mw_railroads.geojson")</span></span>
<span id="cb115-371"><a href="#cb115-371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-372"><a href="#cb115-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-373"><a href="#cb115-373" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bounding box</span></span>
<span id="cb115-374"><a href="#cb115-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-375"><a href="#cb115-375" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`st_crop()`</span> to crop a spatial object to a spatial bounding box (extent) of another spatial object. The bounding box of an <span class="in">`sf`</span> is a rectangle represented by the minimum and maximum of <span class="in">`x`</span> and <span class="in">`y`</span> that encompass/contain all the spatial objects in the <span class="in">`sf`</span>. You can use <span class="in">`st_bbox()`</span> to find the bounding box of an <span class="in">`sf`</span> object. Let's get the bounding box of irrigation wells in Kansas (<span class="in">`KS_wells`</span>).</span>
<span id="cb115-376"><a href="#cb115-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-377"><a href="#cb115-377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r bbox_KS_wlls}</span></span>
<span id="cb115-378"><a href="#cb115-378" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the bounding box of KS_wells ---#</span></span>
<span id="cb115-379"><a href="#cb115-379" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-380"><a href="#cb115-380" aria-hidden="true" tabindex="-1"></a><span class="in">bbox_KS_wells &lt;- sf::st_bbox(KS_wells)  </span></span>
<span id="cb115-381"><a href="#cb115-381" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-382"><a href="#cb115-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-383"><a href="#cb115-383" aria-hidden="true" tabindex="-1"></a><span class="in">#--- check the class ---#</span></span>
<span id="cb115-384"><a href="#cb115-384" aria-hidden="true" tabindex="-1"></a><span class="in">class(bbox_KS_wells)</span></span>
<span id="cb115-385"><a href="#cb115-385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-386"><a href="#cb115-386" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb115-387"><a href="#cb115-387" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`sf::st_bbox()`</span> returns an object of class <span class="in">`bbox`</span>. You cannot directly create a map using a <span class="in">`bbox`</span>. So, let's convert it to an <span class="in">`sfc`</span> using <span class="in">`sf::st_as_sfc()`</span>:</span>
<span id="cb115-388"><a href="#cb115-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-389"><a href="#cb115-389" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sfc-county-bbox}</span></span>
<span id="cb115-390"><a href="#cb115-390" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells_bbox_sfc &lt;- sf::st_as_sfc(bbox_KS_wells) </span></span>
<span id="cb115-391"><a href="#cb115-391" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-392"><a href="#cb115-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-393"><a href="#cb115-393" aria-hidden="true" tabindex="-1"></a>@fig-bbox-fig shows the bounding box (red rectangle).</span>
<span id="cb115-394"><a href="#cb115-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-397"><a href="#cb115-397" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-398"><a href="#cb115-398" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-bbox-fig</span></span>
<span id="cb115-399"><a href="#cb115-399" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The bounding box of the irrigation wells in Kansas that overlie HPA" </span></span>
<span id="cb115-400"><a href="#cb115-400" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-401"><a href="#cb115-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-402"><a href="#cb115-402" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-403"><a href="#cb115-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb115-404"><a href="#cb115-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> KS_wells_bbox_sfc, </span>
<span id="cb115-405"><a href="#cb115-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb115-406"><a href="#cb115-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>,</span>
<span id="cb115-407"><a href="#cb115-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">1.2</span></span>
<span id="cb115-408"><a href="#cb115-408" aria-hidden="true" tabindex="-1"></a>   ) <span class="sc">+</span></span>
<span id="cb115-409"><a href="#cb115-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb115-410"><a href="#cb115-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> KS_wells,</span>
<span id="cb115-411"><a href="#cb115-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.4</span></span>
<span id="cb115-412"><a href="#cb115-412" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb115-413"><a href="#cb115-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-414"><a href="#cb115-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-415"><a href="#cb115-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-416"><a href="#cb115-416" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatial cropping</span></span>
<span id="cb115-417"><a href="#cb115-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-418"><a href="#cb115-418" aria-hidden="true" tabindex="-1"></a>Let's now crop High-Plains aquifer boundary (<span class="in">`hpa`</span>) to the bounding box of Kansas wells (@fig-hpa).</span>
<span id="cb115-419"><a href="#cb115-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-420"><a href="#cb115-420" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-423"><a href="#cb115-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-424"><a href="#cb115-424" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-hpa</span></span>
<span id="cb115-425"><a href="#cb115-425" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "HPA and irrigation wells in Kansas"</span></span>
<span id="cb115-426"><a href="#cb115-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-427"><a href="#cb115-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-428"><a href="#cb115-428" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-429"><a href="#cb115-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells, <span class="at">size =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb115-430"><a href="#cb115-430" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_bbox_sfc, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb115-431"><a href="#cb115-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-432"><a href="#cb115-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-433"><a href="#cb115-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-434"><a href="#cb115-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-435"><a href="#cb115-435" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-436"><a href="#cb115-436" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-437"><a href="#cb115-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-438"><a href="#cb115-438" aria-hidden="true" tabindex="-1"></a><span class="in">```{r crop_counties}</span></span>
<span id="cb115-439"><a href="#cb115-439" aria-hidden="true" tabindex="-1"></a><span class="in">hpa_cropped_to_KS &lt;- sf::st_crop(hpa, KS_wells)</span></span>
<span id="cb115-440"><a href="#cb115-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-441"><a href="#cb115-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-442"><a href="#cb115-442" aria-hidden="true" tabindex="-1"></a>Here is what the cropped version of <span class="in">`hpa`</span> looks like (@fig-cropped-hpa):</span>
<span id="cb115-443"><a href="#cb115-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-446"><a href="#cb115-446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-447"><a href="#cb115-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cropped-hpa</span></span>
<span id="cb115-448"><a href="#cb115-448" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The bounding box of the irrigation wells in Kansas that overlie HPA"</span></span>
<span id="cb115-449"><a href="#cb115-449" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-450"><a href="#cb115-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-451"><a href="#cb115-451" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-452"><a href="#cb115-452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells, <span class="at">size =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb115-453"><a href="#cb115-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_bbox_sfc, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb115-454"><a href="#cb115-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-455"><a href="#cb115-455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-456"><a href="#cb115-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-457"><a href="#cb115-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-458"><a href="#cb115-458" aria-hidden="true" tabindex="-1"></a>As you can see, the <span class="in">`st_crop()`</span> operation cut the parts of <span class="in">`hpa`</span> that are not intersecting with the bounding box of <span class="in">`KS_wells`</span>.</span>
<span id="cb115-459"><a href="#cb115-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-460"><a href="#cb115-460" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb115-461"><a href="#cb115-461" aria-hidden="true" tabindex="-1"></a>Please note that we did not explicilty crop <span class="in">`hpa`</span> to the bouding box of <span class="in">`KS_wells`</span> (<span class="in">`bbox_KS_wells`</span>) above. That is, we just run <span class="in">`hpa_cropped_to_KS &lt;- sf::st_crop(hpa, KS_wells)`</span> instead of <span class="in">`hpa_cropped_to_KS &lt;- sf::st_crop(hpa, bbox_KS_wells)`</span>. When <span class="in">`sf::st_crop()`</span> is used, it automatically finds the bounding box of the <span class="in">`sf`</span> as second argument and implements cropping.</span>
<span id="cb115-462"><a href="#cb115-462" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-463"><a href="#cb115-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-464"><a href="#cb115-464" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial subsetting {#sec-sf-subset}</span></span>
<span id="cb115-465"><a href="#cb115-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-466"><a href="#cb115-466" aria-hidden="true" tabindex="-1"></a>Spatial subsetting refers to operations that narrow down the geographic scope of a spatial object (source data) based on another spatial object (target data). We illustrate spatial subsetting using Kansas county borders (<span class="in">`KS_counties`</span>), the boundary of the Kansas portion of the High-Plains Aquifer (<span class="in">`hpa_cropped_to_KS`</span>), and agricultural irrigation wells in Kansas (<span class="in">`KS_wells`</span>).</span>
<span id="cb115-467"><a href="#cb115-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-468"><a href="#cb115-468" aria-hidden="true" tabindex="-1"></a><span class="fu">### polygons (source) vs polygons (target)</span></span>
<span id="cb115-469"><a href="#cb115-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-470"><a href="#cb115-470" aria-hidden="true" tabindex="-1"></a>@fig-overlap-KS-county-HPA shows the Kansas portion of the HPA and Kansas counties.</span>
<span id="cb115-471"><a href="#cb115-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-472"><a href="#cb115-472" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-475"><a href="#cb115-475" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-476"><a href="#cb115-476" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-overlap-KS-county-HPA</span></span>
<span id="cb115-477"><a href="#cb115-477" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Kansas portion of High-Plains Aquifer and Kansas counties"</span></span>
<span id="cb115-478"><a href="#cb115-478" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-479"><a href="#cb115-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-480"><a href="#cb115-480" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-481"><a href="#cb115-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties) <span class="sc">+</span></span>
<span id="cb115-482"><a href="#cb115-482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-483"><a href="#cb115-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-484"><a href="#cb115-484" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-485"><a href="#cb115-485" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-486"><a href="#cb115-486" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-487"><a href="#cb115-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-488"><a href="#cb115-488" aria-hidden="true" tabindex="-1"></a>The goal is to select only the counties that intersect with the HPA boundary. Spatial subsetting of <span class="in">`sf`</span> objects follows this syntax:</span>
<span id="cb115-489"><a href="#cb115-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-490"><a href="#cb115-490" aria-hidden="true" tabindex="-1"></a><span class="in">```{r syntax_subset}</span></span>
<span id="cb115-491"><a href="#cb115-491" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: false</span></span>
<span id="cb115-492"><a href="#cb115-492" aria-hidden="true" tabindex="-1"></a><span class="in">#--- this does not run ---#</span></span>
<span id="cb115-493"><a href="#cb115-493" aria-hidden="true" tabindex="-1"></a><span class="in">sf_1[sf_2, ]</span></span>
<span id="cb115-494"><a href="#cb115-494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-495"><a href="#cb115-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-496"><a href="#cb115-496" aria-hidden="true" tabindex="-1"></a>where you are subsetting <span class="in">`sf_1`</span> based on <span class="in">`sf_2`</span>. Instead of row numbers, you provide another sf object in place. The following code spatially subsets Kansas counties based on the HPA boundary.</span>
<span id="cb115-497"><a href="#cb115-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-498"><a href="#cb115-498" aria-hidden="true" tabindex="-1"></a><span class="in">```{r spatial_subset}</span></span>
<span id="cb115-499"><a href="#cb115-499" aria-hidden="true" tabindex="-1"></a><span class="in">counties_intersecting_hpa &lt;- KS_counties[hpa_cropped_to_KS, ]</span></span>
<span id="cb115-500"><a href="#cb115-500" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-501"><a href="#cb115-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-502"><a href="#cb115-502" aria-hidden="true" tabindex="-1"></a>@fig-default-subset presents counties in <span class="in">`counties_intersecting_hpa`</span> and the cropped HPA boundary.</span>
<span id="cb115-503"><a href="#cb115-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-506"><a href="#cb115-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-507"><a href="#cb115-507" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-508"><a href="#cb115-508" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The results of spatially subsetting Kansas counties based on HPA boundary"</span></span>
<span id="cb115-509"><a href="#cb115-509" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-default-subset</span></span>
<span id="cb115-510"><a href="#cb115-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-511"><a href="#cb115-511" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-512"><a href="#cb115-512" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- add US counties layer ---#</span></span>
<span id="cb115-513"><a href="#cb115-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> counties_intersecting_hpa) <span class="sc">+</span></span>
<span id="cb115-514"><a href="#cb115-514" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- add High-Plains Aquifer layer ---#</span></span>
<span id="cb115-515"><a href="#cb115-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-516"><a href="#cb115-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-517"><a href="#cb115-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-518"><a href="#cb115-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-519"><a href="#cb115-519" aria-hidden="true" tabindex="-1"></a>You can see that only the counties intersecting with the HPA boundary remain. This is because, when using the syntax <span class="in">`sf_1[sf_2, ]`</span>, the default topological relation is <span class="in">`sf::st_intersects()`</span>. If objects in <span class="in">`sf_1`</span> intersect with any of the objects in <span class="in">`sf_2`</span>, even slightly, they will remain after subsetting.</span>
<span id="cb115-520"><a href="#cb115-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-521"><a href="#cb115-521" aria-hidden="true" tabindex="-1"></a>Sometimes, instead of removing non-intersecting observations, you may just want to flag whether two spatial objects intersect. To do this, you can first retrieve the IDs of the intersecting counties from <span class="in">`counties_intersecting_hpa`</span> and then create a variable in the original dataset (<span class="in">`KS_counties`</span>) that indicates whether an intersection occurs.</span>
<span id="cb115-522"><a href="#cb115-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-523"><a href="#cb115-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r county_hpa}</span></span>
<span id="cb115-524"><a href="#cb115-524" aria-hidden="true" tabindex="-1"></a><span class="in">#--- check the intersections of HPA and counties  ---#</span></span>
<span id="cb115-525"><a href="#cb115-525" aria-hidden="true" tabindex="-1"></a><span class="in">intersecting_counties_list &lt;- counties_intersecting_hpa$COUNTYFP</span></span>
<span id="cb115-526"><a href="#cb115-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-527"><a href="#cb115-527" aria-hidden="true" tabindex="-1"></a><span class="in">#--- assign true/false ---#</span></span>
<span id="cb115-528"><a href="#cb115-528" aria-hidden="true" tabindex="-1"></a><span class="in">KS_counties &lt;- dplyr::mutate(KS_counties, intersects_hpa = ifelse(COUNTYFP %in% intersecting_counties_list, TRUE, FALSE))</span></span>
<span id="cb115-529"><a href="#cb115-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-530"><a href="#cb115-530" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb115-531"><a href="#cb115-531" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::select(KS_counties, COUNTYFP, intersects_hpa)</span></span>
<span id="cb115-532"><a href="#cb115-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-533"><a href="#cb115-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-534"><a href="#cb115-534" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb115-535"><a href="#cb115-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-536"><a href="#cb115-536" aria-hidden="true" tabindex="-1"></a>**Other topological relations**</span>
<span id="cb115-537"><a href="#cb115-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-538"><a href="#cb115-538" aria-hidden="true" tabindex="-1"></a>As mentioned above, the default topological relation used in <span class="in">`sf_1[sf_2, ]`</span> is <span class="in">`sf::st_intersects()`</span>. However, you can specify other topological relations using the following syntax:</span>
<span id="cb115-539"><a href="#cb115-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-540"><a href="#cb115-540" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = FALSE}</span></span>
<span id="cb115-541"><a href="#cb115-541" aria-hidden="true" tabindex="-1"></a><span class="in">#--- this does not run ---#</span></span>
<span id="cb115-542"><a href="#cb115-542" aria-hidden="true" tabindex="-1"></a><span class="in">sf_1[sf_2, op = topological_relation_type] </span></span>
<span id="cb115-543"><a href="#cb115-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-544"><a href="#cb115-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-545"><a href="#cb115-545" aria-hidden="true" tabindex="-1"></a>For example, if you only want counties that are completely within the HPA boundary, you can use the following approach:  </span>
<span id="cb115-546"><a href="#cb115-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-547"><a href="#cb115-547" aria-hidden="true" tabindex="-1"></a><span class="in">```{r st_within}</span></span>
<span id="cb115-548"><a href="#cb115-548" aria-hidden="true" tabindex="-1"></a><span class="in">counties_within_hpa &lt;- KS_counties[hpa_cropped_to_KS, op = st_within]</span></span>
<span id="cb115-549"><a href="#cb115-549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-550"><a href="#cb115-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-551"><a href="#cb115-551" aria-hidden="true" tabindex="-1"></a>@fig-within-subset shows the resulting set of counties.</span>
<span id="cb115-552"><a href="#cb115-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-555"><a href="#cb115-555" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-556"><a href="#cb115-556" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-within-subset</span></span>
<span id="cb115-557"><a href="#cb115-557" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Kansas counties that are completely within the HPA boundary"</span></span>
<span id="cb115-558"><a href="#cb115-558" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-559"><a href="#cb115-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-560"><a href="#cb115-560" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-561"><a href="#cb115-561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> counties_within_hpa) <span class="sc">+</span></span>
<span id="cb115-562"><a href="#cb115-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-563"><a href="#cb115-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-564"><a href="#cb115-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-565"><a href="#cb115-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-566"><a href="#cb115-566" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb115-567"><a href="#cb115-567" aria-hidden="true" tabindex="-1"></a><span class="co">#%%%%%%%%%%%%%%%%%%%%%</span></span>
<span id="cb115-568"><a href="#cb115-568" aria-hidden="true" tabindex="-1"></a><span class="co"># Points vs Polygons </span></span>
<span id="cb115-569"><a href="#cb115-569" aria-hidden="true" tabindex="-1"></a><span class="co">#%%%%%%%%%%%%%%%%%%%%%</span></span>
<span id="cb115-570"><a href="#cb115-570" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb115-571"><a href="#cb115-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-572"><a href="#cb115-572" aria-hidden="true" tabindex="-1"></a><span class="fu">### points (source) vs polygons (target)</span></span>
<span id="cb115-573"><a href="#cb115-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-574"><a href="#cb115-574" aria-hidden="true" tabindex="-1"></a>The following map (@fig-map-wells-county) shows the Kansas portion of the HPA and all the irrigation wells in Kansas. We can select only wells that reside within the HPA boundary using the same syntax as the above example.</span>
<span id="cb115-575"><a href="#cb115-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-578"><a href="#cb115-578" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-579"><a href="#cb115-579" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-wells-county</span></span>
<span id="cb115-580"><a href="#cb115-580" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "A map of Kansas irrigation wells and HPA"</span></span>
<span id="cb115-581"><a href="#cb115-581" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-582"><a href="#cb115-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-583"><a href="#cb115-583" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-584"><a href="#cb115-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-585"><a href="#cb115-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb115-586"><a href="#cb115-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-587"><a href="#cb115-587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-588"><a href="#cb115-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-589"><a href="#cb115-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wells_hpa}</span></span>
<span id="cb115-590"><a href="#cb115-590" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells_in_hpa &lt;- KS_wells[hpa_cropped_to_KS, ]</span></span>
<span id="cb115-591"><a href="#cb115-591" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-592"><a href="#cb115-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-593"><a href="#cb115-593" aria-hidden="true" tabindex="-1"></a>As you can see in @fig-map-wells-in-hpa below, only the wells that are inside (or intersect with) the HPA remained because the default topological relation is <span class="in">`sf::st_intersects()`</span>.</span>
<span id="cb115-594"><a href="#cb115-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-597"><a href="#cb115-597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-598"><a href="#cb115-598" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-wells-in-hpa</span></span>
<span id="cb115-599"><a href="#cb115-599" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "A map of Kansas irrigation wells and HPA"</span></span>
<span id="cb115-600"><a href="#cb115-600" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-601"><a href="#cb115-601" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-602"><a href="#cb115-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-603"><a href="#cb115-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_in_hpa, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb115-604"><a href="#cb115-604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-605"><a href="#cb115-605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-606"><a href="#cb115-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-607"><a href="#cb115-607" aria-hidden="true" tabindex="-1"></a>If you want to flag wells that intersect with HPA, use the following approach:</span>
<span id="cb115-608"><a href="#cb115-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-609"><a href="#cb115-609" aria-hidden="true" tabindex="-1"></a><span class="in">```{r well_hpa_flag}</span></span>
<span id="cb115-610"><a href="#cb115-610" aria-hidden="true" tabindex="-1"></a><span class="in">site_list &lt;- KS_wells_in_hpa$site</span></span>
<span id="cb115-611"><a href="#cb115-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-612"><a href="#cb115-612" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-613"><a href="#cb115-613" aria-hidden="true" tabindex="-1"></a><span class="in">  KS_wells &lt;- dplyr::mutate(KS_wells, in_hpa = ifelse(site %in% site_list, TRUE, FALSE))</span></span>
<span id="cb115-614"><a href="#cb115-614" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-615"><a href="#cb115-615" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-616"><a href="#cb115-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-617"><a href="#cb115-617" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb115-618"><a href="#cb115-618" aria-hidden="true" tabindex="-1"></a><span class="co">#%%%%%%%%%%%%%%%%%%%%%</span></span>
<span id="cb115-619"><a href="#cb115-619" aria-hidden="true" tabindex="-1"></a><span class="co"># Lines vs Polygons </span></span>
<span id="cb115-620"><a href="#cb115-620" aria-hidden="true" tabindex="-1"></a><span class="co">#%%%%%%%%%%%%%%%%%%%%%</span></span>
<span id="cb115-621"><a href="#cb115-621" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb115-622"><a href="#cb115-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-623"><a href="#cb115-623" aria-hidden="true" tabindex="-1"></a><span class="fu">### lines (source) vs polygons (target) {#sec-lines_polygons}</span></span>
<span id="cb115-624"><a href="#cb115-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-625"><a href="#cb115-625" aria-hidden="true" tabindex="-1"></a>@fig-map-lines-county shows the Kansas counties (in red) and U.S. railroads in the Mid West region(in blue).</span>
<span id="cb115-626"><a href="#cb115-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-627"><a href="#cb115-627" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-630"><a href="#cb115-630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-631"><a href="#cb115-631" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "U.S. railroads and Kansas county boundaries"</span></span>
<span id="cb115-632"><a href="#cb115-632" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-lines-county</span></span>
<span id="cb115-633"><a href="#cb115-633" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb115-634"><a href="#cb115-634" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb115-635"><a href="#cb115-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-636"><a href="#cb115-636" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-637"><a href="#cb115-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb115-638"><a href="#cb115-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rail_roads_mw, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-639"><a href="#cb115-639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-640"><a href="#cb115-640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-641"><a href="#cb115-641" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-642"><a href="#cb115-642" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span>  </span>
<span id="cb115-643"><a href="#cb115-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-644"><a href="#cb115-644" aria-hidden="true" tabindex="-1"></a>We can select only the railroads that intersect with Kansas.</span>
<span id="cb115-645"><a href="#cb115-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-646"><a href="#cb115-646" aria-hidden="true" tabindex="-1"></a><span class="in">```{r railroads_ks_county}</span></span>
<span id="cb115-647"><a href="#cb115-647" aria-hidden="true" tabindex="-1"></a><span class="in">railroads_KS &lt;- rail_roads_mw[KS_counties, ]</span></span>
<span id="cb115-648"><a href="#cb115-648" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-649"><a href="#cb115-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-650"><a href="#cb115-650" aria-hidden="true" tabindex="-1"></a>As you can see in @fig-map-rail-ks below, only the railroads that intersect with Kansas were selected. Note the lines that go beyond the Kansas boundary are also selected. Remember, the default is <span class="in">`sf::st_intersect()`</span>. </span>
<span id="cb115-651"><a href="#cb115-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-654"><a href="#cb115-654" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-655"><a href="#cb115-655" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-rail-ks</span></span>
<span id="cb115-656"><a href="#cb115-656" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Railroads that intersect Kansas county boundaries"</span></span>
<span id="cb115-657"><a href="#cb115-657" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-658"><a href="#cb115-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-659"><a href="#cb115-659" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(railroads_KS) <span class="sc">+</span></span>
<span id="cb115-660"><a href="#cb115-660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">col =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb115-661"><a href="#cb115-661" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(KS_counties) <span class="sc">+</span></span>
<span id="cb115-662"><a href="#cb115-662" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="dv">0</span>)  <span class="sc">+</span></span>
<span id="cb115-663"><a href="#cb115-663" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>) </span>
<span id="cb115-664"><a href="#cb115-664" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-665"><a href="#cb115-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-666"><a href="#cb115-666" aria-hidden="true" tabindex="-1"></a>If you would like the lines beyond the state boundary to be cut out but the intersecting parts of those lines to remain, use <span class="in">`sf::st_intersection()`</span>, which is explained in @sec-st-intersection.</span>
<span id="cb115-667"><a href="#cb115-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-668"><a href="#cb115-668" aria-hidden="true" tabindex="-1"></a>If you want to flag railroads that intersect with Kansas counties in <span class="in">`railroads`</span>, use the following approach:</span>
<span id="cb115-669"><a href="#cb115-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-670"><a href="#cb115-670" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lines_ks_flag}</span></span>
<span id="cb115-671"><a href="#cb115-671" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the list of lines ---#</span></span>
<span id="cb115-672"><a href="#cb115-672" aria-hidden="true" tabindex="-1"></a><span class="in">lines_list &lt;- railroads_KS$LINEARID</span></span>
<span id="cb115-673"><a href="#cb115-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-674"><a href="#cb115-674" aria-hidden="true" tabindex="-1"></a><span class="in">#--- railroads ---#</span></span>
<span id="cb115-675"><a href="#cb115-675" aria-hidden="true" tabindex="-1"></a><span class="in">rail_roads_mw &lt;- dplyr::mutate(rail_roads_mw, intersect_ks = ifelse(LINEARID %in% lines_list, TRUE, FALSE))</span></span>
<span id="cb115-676"><a href="#cb115-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-677"><a href="#cb115-677" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb115-678"><a href="#cb115-678" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::select(rail_roads_mw, LINEARID, intersect_ks)</span></span>
<span id="cb115-679"><a href="#cb115-679" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-680"><a href="#cb115-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-681"><a href="#cb115-681" aria-hidden="true" tabindex="-1"></a><span class="fu">### polygons (source) vs points (target) {#sec-polygons_points}</span></span>
<span id="cb115-682"><a href="#cb115-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-683"><a href="#cb115-683" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-686"><a href="#cb115-686" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-687"><a href="#cb115-687" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-county-point</span></span>
<span id="cb115-688"><a href="#cb115-688" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Kansas county boundaries and wells that overlie the HPA"</span></span>
<span id="cb115-689"><a href="#cb115-689" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-690"><a href="#cb115-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-691"><a href="#cb115-691" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-692"><a href="#cb115-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb115-693"><a href="#cb115-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_in_hpa, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-694"><a href="#cb115-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-695"><a href="#cb115-695" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-696"><a href="#cb115-696" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-697"><a href="#cb115-697" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-698"><a href="#cb115-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-699"><a href="#cb115-699" aria-hidden="true" tabindex="-1"></a>@fig-map-county-point shows the Kansas counties and irrigation wells in Kansas that overlie HPA. We can select only the counties that intersect with at least one well.</span>
<span id="cb115-700"><a href="#cb115-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-701"><a href="#cb115-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r counties_wells}</span></span>
<span id="cb115-702"><a href="#cb115-702" aria-hidden="true" tabindex="-1"></a><span class="in">KS_counties_intersected &lt;- KS_counties[KS_wells_in_hpa, ]  </span></span>
<span id="cb115-703"><a href="#cb115-703" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-704"><a href="#cb115-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-705"><a href="#cb115-705" aria-hidden="true" tabindex="-1"></a>As you can see in @fig-subset-county-point below, only the counties that intersect with at least one well remained.</span>
<span id="cb115-706"><a href="#cb115-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-709"><a href="#cb115-709" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-710"><a href="#cb115-710" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-subset-county-point</span></span>
<span id="cb115-711"><a href="#cb115-711" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Counties that have at least one well"</span></span>
<span id="cb115-712"><a href="#cb115-712" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-713"><a href="#cb115-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-714"><a href="#cb115-714" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-715"><a href="#cb115-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb115-716"><a href="#cb115-716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties_intersected, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb115-717"><a href="#cb115-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_in_hpa, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-718"><a href="#cb115-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-719"><a href="#cb115-719" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-720"><a href="#cb115-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-721"><a href="#cb115-721" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial join {#sec-sp-join}</span></span>
<span id="cb115-722"><a href="#cb115-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-723"><a href="#cb115-723" aria-hidden="true" tabindex="-1"></a>A spatial join refers to spatial operations that involve the following steps:</span>
<span id="cb115-724"><a href="#cb115-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-725"><a href="#cb115-725" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Overlay one spatial layer (target layer) onto another (source layer).</span>
<span id="cb115-726"><a href="#cb115-726" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>For each observation in the target layer:</span>
<span id="cb115-727"><a href="#cb115-727" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Identify which objects in the source layer it geographically intersects with (or has another specified topological relationship).</span>
<span id="cb115-728"><a href="#cb115-728" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Extract values associated with the intersecting objects in the source layer, summarizing if necessary.</span>
<span id="cb115-729"><a href="#cb115-729" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Assign the extracted values to the corresponding objects in the target layer.</span>
<span id="cb115-730"><a href="#cb115-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-731"><a href="#cb115-731" aria-hidden="true" tabindex="-1"></a>We can classify spatial join into four categories by the type of the underlying spatial objects:</span>
<span id="cb115-732"><a href="#cb115-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-733"><a href="#cb115-733" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**vector-vector**: vector data (target) against vector data (source)</span>
<span id="cb115-734"><a href="#cb115-734" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**vector-raster**: vector data (target) against raster data (source)</span>
<span id="cb115-735"><a href="#cb115-735" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**raster-vector**: raster data (target) against vector data (source)</span>
<span id="cb115-736"><a href="#cb115-736" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**raster-raster**: raster data (target) against raster data (source)</span>
<span id="cb115-737"><a href="#cb115-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-738"><a href="#cb115-738" aria-hidden="true" tabindex="-1"></a>Among these four types, our focus here is on the first case, **vector-vector**. The second case will be discussed in @sec-int-RV. The third and fourth cases are not covered in this book, as the target data is almost always vector data (e.g., cities or farm fields as points, political boundaries as polygons, etc.).</span>
<span id="cb115-739"><a href="#cb115-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-740"><a href="#cb115-740" aria-hidden="true" tabindex="-1"></a>The **vector-vector** category can be further divided into subcategories depending on the type of spatial object: point, line, or polygon. In this context, we will exclude spatial joins involving lines. This is because line objects are rarely used as observation units in subsequent analyses or as the source data for extracting values.^<span class="co">[</span><span class="ot">For example, in @sec-demo-railroad, we did not extract any attribute values from the railroads. Instead, we calculated the travel length of the railroads, meaning the geometry of the railroads was of interest rather than the values associated with them.</span><span class="co">]</span></span>
<span id="cb115-741"><a href="#cb115-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-742"><a href="#cb115-742" aria-hidden="true" tabindex="-1"></a>Below is a list of the types of spatial joins we will cover:</span>
<span id="cb115-743"><a href="#cb115-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-744"><a href="#cb115-744" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>points (target) against polygons (source)</span>
<span id="cb115-745"><a href="#cb115-745" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>polygons (target) against points (source)</span>
<span id="cb115-746"><a href="#cb115-746" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>polygons (target) against polygons (source)</span>
<span id="cb115-747"><a href="#cb115-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-748"><a href="#cb115-748" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb115-749"><a href="#cb115-749" aria-hidden="true" tabindex="-1"></a><span class="co">#=========================================</span></span>
<span id="cb115-750"><a href="#cb115-750" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial Joining </span></span>
<span id="cb115-751"><a href="#cb115-751" aria-hidden="true" tabindex="-1"></a><span class="co">#=========================================</span></span>
<span id="cb115-752"><a href="#cb115-752" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb115-753"><a href="#cb115-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-754"><a href="#cb115-754" aria-hidden="true" tabindex="-1"></a><span class="fu">### Syntax</span></span>
<span id="cb115-755"><a href="#cb115-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-756"><a href="#cb115-756" aria-hidden="true" tabindex="-1"></a>To perform spatial join, we can use the <span class="in">`sf::st_join()`</span> function, with the following syntax:</span>
<span id="cb115-757"><a href="#cb115-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-758"><a href="#cb115-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{r syntax_st_join, eval = FALSE}</span></span>
<span id="cb115-759"><a href="#cb115-759" aria-hidden="true" tabindex="-1"></a><span class="in">#--- this does not run ---#</span></span>
<span id="cb115-760"><a href="#cb115-760" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_join(target_sf, source_sf)</span></span>
<span id="cb115-761"><a href="#cb115-761" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-762"><a href="#cb115-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-763"><a href="#cb115-763" aria-hidden="true" tabindex="-1"></a>Similar to spatial subsetting, the default topological relation is <span class="in">`sf::st_intersects()`</span>.</span>
<span id="cb115-764"><a href="#cb115-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-765"><a href="#cb115-765" aria-hidden="true" tabindex="-1"></a><span class="fu">### Case 1: points (target) vs polygons (source)</span></span>
<span id="cb115-766"><a href="#cb115-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-767"><a href="#cb115-767" aria-hidden="true" tabindex="-1"></a>In this case, for each observation (point) in the target data, it identifies which polygon in the source data it intersects with and then assigns the value associated with the polygon to the point.^<span class="co">[</span><span class="ot">A practical example of this case is shown in Demonstration 1 of @sec-demo.</span><span class="co">]</span></span>
<span id="cb115-768"><a href="#cb115-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-769"><a href="#cb115-769" aria-hidden="true" tabindex="-1"></a>We use the Kansas irrigation well data (points) and Kansas county boundary data (polygons) for a demonstration. Our goal is to assign the county-level corn price information from the Kansas county data to wells. First let me create and add a fake county-level corn price variable to the Kansas county data.</span>
<span id="cb115-770"><a href="#cb115-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-771"><a href="#cb115-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_corn_price}</span></span>
<span id="cb115-772"><a href="#cb115-772" aria-hidden="true" tabindex="-1"></a><span class="in">KS_corn_price &lt;-</span></span>
<span id="cb115-773"><a href="#cb115-773" aria-hidden="true" tabindex="-1"></a><span class="in">  KS_counties %&gt;%</span></span>
<span id="cb115-774"><a href="#cb115-774" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(corn_price = seq(3.2, 3.9, length = nrow(.))) %&gt;%</span></span>
<span id="cb115-775"><a href="#cb115-775" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(COUNTYFP, corn_price)</span></span>
<span id="cb115-776"><a href="#cb115-776" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-777"><a href="#cb115-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-778"><a href="#cb115-778" aria-hidden="true" tabindex="-1"></a>@fig-map-corn-price presents Kansas counties color-differentiated by the fake corn price.</span>
<span id="cb115-779"><a href="#cb115-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-780"><a href="#cb115-780" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-783"><a href="#cb115-783" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-784"><a href="#cb115-784" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-corn-price</span></span>
<span id="cb115-785"><a href="#cb115-785" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of county-level fake corn price" </span></span>
<span id="cb115-786"><a href="#cb115-786" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-787"><a href="#cb115-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-788"><a href="#cb115-788" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(KS_corn_price) <span class="sc">+</span></span>
<span id="cb115-789"><a href="#cb115-789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> corn_price)) <span class="sc">+</span></span>
<span id="cb115-790"><a href="#cb115-790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb115-791"><a href="#cb115-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-792"><a href="#cb115-792" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-793"><a href="#cb115-793" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-794"><a href="#cb115-794" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-795"><a href="#cb115-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-796"><a href="#cb115-796" aria-hidden="true" tabindex="-1"></a>For this particular context, the following code will do the job: </span>
<span id="cb115-797"><a href="#cb115-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-798"><a href="#cb115-798" aria-hidden="true" tabindex="-1"></a><span class="in">```{r st_join_KS}</span></span>
<span id="cb115-799"><a href="#cb115-799" aria-hidden="true" tabindex="-1"></a><span class="in">#--- spatial join ---#</span></span>
<span id="cb115-800"><a href="#cb115-800" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-801"><a href="#cb115-801" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells_County &lt;- sf::st_join(KS_wells, KS_corn_price)</span></span>
<span id="cb115-802"><a href="#cb115-802" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-803"><a href="#cb115-803" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-804"><a href="#cb115-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-805"><a href="#cb115-805" aria-hidden="true" tabindex="-1"></a>You can see from @fig-map-corn-wells that all the wells inside the same county have the same corn price value.</span>
<span id="cb115-806"><a href="#cb115-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-807"><a href="#cb115-807" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-808"><a href="#cb115-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-809"><a href="#cb115-809" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-810"><a href="#cb115-810" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-813"><a href="#cb115-813" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-814"><a href="#cb115-814" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-corn-wells</span></span>
<span id="cb115-815"><a href="#cb115-815" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of wells color-differentiated by corn price"</span></span>
<span id="cb115-816"><a href="#cb115-816" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-817"><a href="#cb115-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-818"><a href="#cb115-818" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-819"><a href="#cb115-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties) <span class="sc">+</span></span>
<span id="cb115-820"><a href="#cb115-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_County, <span class="fu">aes</span>(<span class="at">color =</span> corn_price)) <span class="sc">+</span></span>
<span id="cb115-821"><a href="#cb115-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb115-822"><a href="#cb115-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-823"><a href="#cb115-823" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-824"><a href="#cb115-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-825"><a href="#cb115-825" aria-hidden="true" tabindex="-1"></a>We can also confirm that the <span class="in">`corn_price`</span> value associated with all the wells in a single county is identical with the <span class="in">`corn_price`</span> value associated with that county in the original corn price data (<span class="in">`KS_corn_price`</span>).</span>
<span id="cb115-826"><a href="#cb115-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-829"><a href="#cb115-829" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-830"><a href="#cb115-830" aria-hidden="true" tabindex="-1"></a>KS_wells_County <span class="sc">%&gt;%</span></span>
<span id="cb115-831"><a href="#cb115-831" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(COUNTYFP <span class="sc">==</span> <span class="st">"069"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb115-832"><a href="#cb115-832" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(corn_price) <span class="sc">%&gt;%</span></span>
<span id="cb115-833"><a href="#cb115-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb115-834"><a href="#cb115-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-835"><a href="#cb115-835" aria-hidden="true" tabindex="-1"></a>KS_corn_price <span class="sc">%&gt;%</span></span>
<span id="cb115-836"><a href="#cb115-836" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(COUNTYFP <span class="sc">==</span> <span class="st">"069"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb115-837"><a href="#cb115-837" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(corn_price)</span>
<span id="cb115-838"><a href="#cb115-838" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-839"><a href="#cb115-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-840"><a href="#cb115-840" aria-hidden="true" tabindex="-1"></a><span class="fu">### Case 2: polygons (target) vs points (source) {#sec-polygons-points}</span></span>
<span id="cb115-841"><a href="#cb115-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-842"><a href="#cb115-842" aria-hidden="true" tabindex="-1"></a>In this case, for each observation (polygon) in the target data, it identifies which observations (points) in the source data intersect with it, and then assigns the values associated with those points to the polygon (A practical example of this case is shown in Demonstration 2 of @sec-demo.).</span>
<span id="cb115-843"><a href="#cb115-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-844"><a href="#cb115-844" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-847"><a href="#cb115-847" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-848"><a href="#cb115-848" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-wells-county-gw</span></span>
<span id="cb115-849"><a href="#cb115-849" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of wells color-differentiated by corn price"</span></span>
<span id="cb115-850"><a href="#cb115-850" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-851"><a href="#cb115-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-852"><a href="#cb115-852" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-853"><a href="#cb115-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties) <span class="sc">+</span></span>
<span id="cb115-854"><a href="#cb115-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells, <span class="fu">aes</span>(<span class="at">color =</span> af_used), <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb115-855"><a href="#cb115-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">name =</span> <span class="st">"Groundwater Pumping (acre-feet)"</span>) <span class="sc">+</span></span>
<span id="cb115-856"><a href="#cb115-856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb115-857"><a href="#cb115-857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb115-858"><a href="#cb115-858" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-859"><a href="#cb115-859" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-860"><a href="#cb115-860" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-861"><a href="#cb115-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-862"><a href="#cb115-862" aria-hidden="true" tabindex="-1"></a>For instance, if you are conducting a county-level analysis and want to calculate the total groundwater pumping for each county, the target data would be <span class="in">`KS_counties`</span>, and the source data would be <span class="in">`KS_wells`</span> (@fig-wells-county-gw).</span>
<span id="cb115-863"><a href="#cb115-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-864"><a href="#cb115-864" aria-hidden="true" tabindex="-1"></a><span class="in">```{r st_join_polygon_point}</span></span>
<span id="cb115-865"><a href="#cb115-865" aria-hidden="true" tabindex="-1"></a><span class="in">#--- spatial join ---#</span></span>
<span id="cb115-866"><a href="#cb115-866" aria-hidden="true" tabindex="-1"></a><span class="in">KS_County_wells &lt;- sf::st_join(KS_counties, KS_wells)</span></span>
<span id="cb115-867"><a href="#cb115-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-868"><a href="#cb115-868" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb115-869"><a href="#cb115-869" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::select(KS_County_wells, COUNTYFP, site, af_used)</span></span>
<span id="cb115-870"><a href="#cb115-870" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-871"><a href="#cb115-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-872"><a href="#cb115-872" aria-hidden="true" tabindex="-1"></a>As seen in the resulting dataset, each unique polygon-point intersection forms an observation. For each polygon, there will be as many observations as there are wells intersecting with that polygon. After joining the two layers, you can calculate statistics for each polygon (in this case, each county). Since the goal is to calculate groundwater extraction by county, the following code will accomplish this:</span>
<span id="cb115-873"><a href="#cb115-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-874"><a href="#cb115-874" aria-hidden="true" tabindex="-1"></a><span class="in">```{r summary_after_join}</span></span>
<span id="cb115-875"><a href="#cb115-875" aria-hidden="true" tabindex="-1"></a><span class="in">KS_County_wells %&gt;% </span></span>
<span id="cb115-876"><a href="#cb115-876" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::group_by(COUNTYFP) %&gt;% </span></span>
<span id="cb115-877"><a href="#cb115-877" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::summarize(af_used = sum(af_used, na.rm = TRUE)) </span></span>
<span id="cb115-878"><a href="#cb115-878" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-879"><a href="#cb115-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-880"><a href="#cb115-880" aria-hidden="true" tabindex="-1"></a>It is just as easy to get other types of statistics by simply modifying the <span class="in">`dplyr::summarize()`</span> part.</span>
<span id="cb115-881"><a href="#cb115-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-882"><a href="#cb115-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-883"><a href="#cb115-883" aria-hidden="true" tabindex="-1"></a><span class="fu">### Case 3: polygons (target) vs polygons (source) {#sec-polygon-polygon}</span></span>
<span id="cb115-884"><a href="#cb115-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-885"><a href="#cb115-885" aria-hidden="true" tabindex="-1"></a>In this case, <span class="in">`sf::st_join(target_sf, source_sf)`</span> returns all the unique polygon-polygon intersections, with the attributes from <span class="in">`source_sf`</span> attached to the intersecting polygons.</span>
<span id="cb115-886"><a href="#cb115-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-887"><a href="#cb115-887" aria-hidden="true" tabindex="-1"></a>We will use county-level corn acres data in Iowa for 2018 from USDA NASS^<span class="co">[</span><span class="ot">See @sec-nass-quick for instructions on downloading Quick Stats data from within R.</span><span class="co">]</span> and Hydrologic Units. Our objective is to estimate corn acres by HUC units based on county-level corn acres data.^<span class="co">[</span><span class="ot">There will be substantial measurement errors because the source polygons (corn acres by county) are large compared to the target polygons (HUC units). However, this serves as a useful illustration of a polygon-polygon join.</span><span class="co">]</span></span>
<span id="cb115-888"><a href="#cb115-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-889"><a href="#cb115-889" aria-hidden="true" tabindex="-1"></a>We first import the Iowa corn acre data (@fig-map-IA-corn is the map of Iowa counties color-differentiated by corn acres): </span>
<span id="cb115-890"><a href="#cb115-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-891"><a href="#cb115-891" aria-hidden="true" tabindex="-1"></a><span class="in">```{r IA_corn_data}</span></span>
<span id="cb115-892"><a href="#cb115-892" aria-hidden="true" tabindex="-1"></a><span class="in">#--- IA boundary ---#</span></span>
<span id="cb115-893"><a href="#cb115-893" aria-hidden="true" tabindex="-1"></a><span class="in">IA_corn &lt;- readRDS("Data/IA_corn.rds")</span></span>
<span id="cb115-894"><a href="#cb115-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-895"><a href="#cb115-895" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb115-896"><a href="#cb115-896" aria-hidden="true" tabindex="-1"></a><span class="in">IA_corn</span></span>
<span id="cb115-897"><a href="#cb115-897" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-898"><a href="#cb115-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-899"><a href="#cb115-899" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-902"><a href="#cb115-902" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-903"><a href="#cb115-903" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-IA-corn</span></span>
<span id="cb115-904"><a href="#cb115-904" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of Iowa counties color-differentiated by corn planted acreage"</span></span>
<span id="cb115-905"><a href="#cb115-905" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-906"><a href="#cb115-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-907"><a href="#cb115-907" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(IA_corn) <span class="sc">+</span></span>
<span id="cb115-908"><a href="#cb115-908" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> acres)) <span class="sc">+</span></span>
<span id="cb115-909"><a href="#cb115-909" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb115-910"><a href="#cb115-910" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-911"><a href="#cb115-911" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-912"><a href="#cb115-912" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-913"><a href="#cb115-913" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-914"><a href="#cb115-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-915"><a href="#cb115-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-916"><a href="#cb115-916" aria-hidden="true" tabindex="-1"></a>Now import the HUC units data (@fig-HUC-map presents the map of HUC units):</span>
<span id="cb115-917"><a href="#cb115-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-918"><a href="#cb115-918" aria-hidden="true" tabindex="-1"></a><span class="in">```{r HUC_import, results = "hide"}</span></span>
<span id="cb115-919"><a href="#cb115-919" aria-hidden="true" tabindex="-1"></a><span class="in">#--- import HUC units ---#</span></span>
<span id="cb115-920"><a href="#cb115-920" aria-hidden="true" tabindex="-1"></a><span class="in">HUC_IA &lt;- </span></span>
<span id="cb115-921"><a href="#cb115-921" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_read("Data/huc250k.shp") %&gt;% </span></span>
<span id="cb115-922"><a href="#cb115-922" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(HUC_CODE) %&gt;% </span></span>
<span id="cb115-923"><a href="#cb115-923" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- reproject to the CRS of IA ---#</span></span>
<span id="cb115-924"><a href="#cb115-924" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(st_crs(IA_corn)) %&gt;% </span></span>
<span id="cb115-925"><a href="#cb115-925" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- select HUC units that overlaps with IA ---#</span></span>
<span id="cb115-926"><a href="#cb115-926" aria-hidden="true" tabindex="-1"></a><span class="in">  .[IA_corn, ]</span></span>
<span id="cb115-927"><a href="#cb115-927" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-928"><a href="#cb115-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-929"><a href="#cb115-929" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-932"><a href="#cb115-932" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-933"><a href="#cb115-933" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-HUC-map</span></span>
<span id="cb115-934"><a href="#cb115-934" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of HUC units that intersect with Iowa state boundary"</span></span>
<span id="cb115-935"><a href="#cb115-935" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true  </span></span>
<span id="cb115-936"><a href="#cb115-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-937"><a href="#cb115-937" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(HUC_IA) <span class="sc">+</span> </span>
<span id="cb115-938"><a href="#cb115-938" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb115-939"><a href="#cb115-939" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-940"><a href="#cb115-940" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-941"><a href="#cb115-941" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-942"><a href="#cb115-942" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-943"><a href="#cb115-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-944"><a href="#cb115-944" aria-hidden="true" tabindex="-1"></a>@fig-HUC-county-map presents a map of Iowa counties superimposed on the HUC units:</span>
<span id="cb115-945"><a href="#cb115-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-948"><a href="#cb115-948" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-949"><a href="#cb115-949" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-HUC-county-map</span></span>
<span id="cb115-950"><a href="#cb115-950" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of HUC units superimposed on the counties in Iowas"</span></span>
<span id="cb115-951"><a href="#cb115-951" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-952"><a href="#cb115-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-953"><a href="#cb115-953" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-954"><a href="#cb115-954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> HUC_IA) <span class="sc">+</span></span>
<span id="cb115-955"><a href="#cb115-955" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> IA_corn, <span class="fu">aes</span>(<span class="at">fill =</span> acres), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb115-956"><a href="#cb115-956" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb115-957"><a href="#cb115-957" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-958"><a href="#cb115-958" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-959"><a href="#cb115-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-960"><a href="#cb115-960" aria-hidden="true" tabindex="-1"></a>Spatial join using <span class="in">`sf::st_join()`</span> will produce the following: </span>
<span id="cb115-961"><a href="#cb115-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-962"><a href="#cb115-962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r join_HUC_acres}</span></span>
<span id="cb115-963"><a href="#cb115-963" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-964"><a href="#cb115-964" aria-hidden="true" tabindex="-1"></a><span class="in">HUC_joined &lt;- sf::st_join(HUC_IA, IA_corn)</span></span>
<span id="cb115-965"><a href="#cb115-965" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-966"><a href="#cb115-966" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-967"><a href="#cb115-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-968"><a href="#cb115-968" aria-hidden="true" tabindex="-1"></a>Each intersecting HUC-county combination becomes a separate observation, with the resulting geometry being the same as that of the HUC unit. To illustrate this, let's take a closer look at one of the HUC units. The HUC unit with <span class="in">`HUC_CODE ==10170203`</span> intersects with four County.</span>
<span id="cb115-969"><a href="#cb115-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-970"><a href="#cb115-970" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filter_the_first_one}</span></span>
<span id="cb115-971"><a href="#cb115-971" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the HUC unit with `HUC_CODE ==10170203`  ---#</span></span>
<span id="cb115-972"><a href="#cb115-972" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-973"><a href="#cb115-973" aria-hidden="true" tabindex="-1"></a><span class="in">temp_HUC_county &lt;- filter(HUC_joined, HUC_CODE == 10170203)</span></span>
<span id="cb115-974"><a href="#cb115-974" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-975"><a href="#cb115-975" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-976"><a href="#cb115-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-977"><a href="#cb115-977" aria-hidden="true" tabindex="-1"></a>All of the four observations in <span class="in">`temp_HUC_county`</span> has the identical geometry (@fig-identical-geometry shows this visually.).</span>
<span id="cb115-978"><a href="#cb115-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-981"><a href="#cb115-981" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-982"><a href="#cb115-982" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(temp_HUC_county<span class="sc">$</span>geometry))</span>
<span id="cb115-983"><a href="#cb115-983" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-984"><a href="#cb115-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-985"><a href="#cb115-985" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-988"><a href="#cb115-988" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-989"><a href="#cb115-989" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-identical-geometry</span></span>
<span id="cb115-990"><a href="#cb115-990" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Geoemetry of the four observations in the joined object"</span></span>
<span id="cb115-991"><a href="#cb115-991" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb115-992"><a href="#cb115-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-993"><a href="#cb115-993" aria-hidden="true" tabindex="-1"></a>temp_HUC_county <span class="sc">%&gt;%</span></span>
<span id="cb115-994"><a href="#cb115-994" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">county_text =</span> <span class="fu">paste0</span>(<span class="st">"County Code: "</span>, county_code)) <span class="sc">%&gt;%</span></span>
<span id="cb115-995"><a href="#cb115-995" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(.) <span class="sc">+</span></span>
<span id="cb115-996"><a href="#cb115-996" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb115-997"><a href="#cb115-997" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(county_text <span class="sc">~</span> ., <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb115-998"><a href="#cb115-998" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-999"><a href="#cb115-999" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1000"><a href="#cb115-1000" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1001"><a href="#cb115-1001" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-1002"><a href="#cb115-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1003"><a href="#cb115-1003" aria-hidden="true" tabindex="-1"></a>Moreover, they are identical with the geometry of the intersecting HUC unit (the HUC unit with <span class="in">`HUC_CODE ==10170203`</span>):</span>
<span id="cb115-1004"><a href="#cb115-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1007"><a href="#cb115-1007" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-1008"><a href="#cb115-1008" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(</span>
<span id="cb115-1009"><a href="#cb115-1009" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- geometry of the one of the observations from the joined object ---#</span></span>
<span id="cb115-1010"><a href="#cb115-1010" aria-hidden="true" tabindex="-1"></a>  temp_HUC_county[<span class="dv">1</span>, ]<span class="sc">$</span>geometry,</span>
<span id="cb115-1011"><a href="#cb115-1011" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- original HUC geometry ---#</span></span>
<span id="cb115-1012"><a href="#cb115-1012" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(HUC_IA, HUC_CODE <span class="sc">==</span> <span class="dv">10170203</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(geometry)</span>
<span id="cb115-1013"><a href="#cb115-1013" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb115-1014"><a href="#cb115-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1015"><a href="#cb115-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1016"><a href="#cb115-1016" aria-hidden="true" tabindex="-1"></a>So, all four observations have identical geometry, which corresponds to the geometry of the HUC unit. This indicates that <span class="in">`sf::st_join()`</span> does not retain information about the extent of the intersection between the HUC unit and the four counties. Keep in mind that the default behavior uses <span class="in">`sf::st_intersects()`</span>, which only checks whether the spatial objects intersect, without providing further details.</span>
<span id="cb115-1017"><a href="#cb115-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1018"><a href="#cb115-1018" aria-hidden="true" tabindex="-1"></a>If you are calculating a simple average of corn acres and are not concerned with the degree of spatial overlap, this method works just fine. However, if you want to compute an area-weighted average, the information provided is insufficient. You will learn how to calculate the area-weighted average in the next subsection.</span>
<span id="cb115-1019"><a href="#cb115-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1020"><a href="#cb115-1020" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial join and summary in one step</span></span>
<span id="cb115-1021"><a href="#cb115-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1022"><a href="#cb115-1022" aria-hidden="true" tabindex="-1"></a>In @sec-polygons-points, we first joined <span class="in">`KS_counties`</span> and <span class="in">`KS_wells`</span> uusing <span class="in">`sf::st_join()`</span> and then applied <span class="in">`dplyr::summarize()`</span> to find total groundwater use per county. This two-step procedure can be done in one step using <span class="in">`aggregate()`</span> with the summarizing function specified for the <span class="in">`FUN`</span> option.</span>
<span id="cb115-1023"><a href="#cb115-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1026"><a href="#cb115-1026" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-1027"><a href="#cb115-1027" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb115-1028"><a href="#cb115-1028" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(source layer, target layer, <span class="at">FUN =</span> <span class="cf">function</span>)</span>
<span id="cb115-1029"><a href="#cb115-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1030"><a href="#cb115-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1031"><a href="#cb115-1031" aria-hidden="true" tabindex="-1"></a>Since we are trying to find total groundwater use for each county, the target layer is <span class="in">`KS_counties`</span>, the source layer is <span class="in">`KS_wells`</span>, which has <span class="in">`af_used`</span>, and the function to summarize is <span class="in">`sum()`</span>. So, the following code will replicate what we just did above:</span>
<span id="cb115-1032"><a href="#cb115-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1033"><a href="#cb115-1033" aria-hidden="true" tabindex="-1"></a><span class="in">```{r demo_aggregate}</span></span>
<span id="cb115-1034"><a href="#cb115-1034" aria-hidden="true" tabindex="-1"></a><span class="in">#--- sum ---#</span></span>
<span id="cb115-1035"><a href="#cb115-1035" aria-hidden="true" tabindex="-1"></a><span class="in">aggregate(KS_wells, KS_counties, FUN = sum)</span></span>
<span id="cb115-1036"><a href="#cb115-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1037"><a href="#cb115-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1038"><a href="#cb115-1038" aria-hidden="true" tabindex="-1"></a>Notice that the <span class="in">`sum()`</span> function was applied to all the columns in <span class="in">`KS_wells`</span>, including site id number. So, you might want to select variables you want to join before you apply the <span class="in">`aggregate()`</span> function like this:  </span>
<span id="cb115-1039"><a href="#cb115-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1040"><a href="#cb115-1040" aria-hidden="true" tabindex="-1"></a><span class="in">```{r agg_select}</span></span>
<span id="cb115-1041"><a href="#cb115-1041" aria-hidden="true" tabindex="-1"></a><span class="in">aggregate(dplyr::select(KS_wells, af_used), KS_counties, FUN = sum)</span></span>
<span id="cb115-1042"><a href="#cb115-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1043"><a href="#cb115-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1044"><a href="#cb115-1044" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial intersection (cropping join)</span></span>
<span id="cb115-1045"><a href="#cb115-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1046"><a href="#cb115-1046" aria-hidden="true" tabindex="-1"></a>Sometimes, you may need to crop spatial objects by polygon boundaries. For instance, in the demonstration in @sec-demo-railroad, we calculated the total length of railroads within each county by trimming the parts of the railroads that extended beyond county boundaries. Similarly, we cannot find area-weighted averages using <span class="in">`sf::st_join()`</span> alone because it does not provide information about how much of each HUC unit intersects with a county. However, if we can obtain the geometry of the intersecting portions of the HUC unit and the county, we can calculate their areas, allowing us to compute area-weighted averages of the joined attributes.</span>
<span id="cb115-1047"><a href="#cb115-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1048"><a href="#cb115-1048" aria-hidden="true" tabindex="-1"></a>For these purposes, we can use <span class="in">`sf::st_intersection()`</span>. Below, we illustrate how <span class="in">`sf::st_intersection()`</span> works for line-polygon and polygon-polygon intersections (using data generated in @sec-topo). Intersections involving points with <span class="in">`sf::st_intersection()`</span> are equivalent to using <span class="in">`sf::st_join()`</span> since points have neither length nor area (nothing to crop). Therefore, they are not discussed here.</span>
<span id="cb115-1049"><a href="#cb115-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1050"><a href="#cb115-1050" aria-hidden="true" tabindex="-1"></a><span class="fu">### `sf::st_intersection()` {#sec-st-intersection}</span></span>
<span id="cb115-1051"><a href="#cb115-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1052"><a href="#cb115-1052" aria-hidden="true" tabindex="-1"></a>While <span class="in">`sf::st_intersects()`</span> returns the indices of intersecting objects, <span class="in">`sf::st_intersection()`</span> returns the actual intersecting spatial objects, with the non-intersecting parts of the sf objects removed. Additionally, the attribute values from the source sf are merged with the intersecting geometries (<span class="in">`sfg`</span>) in the target <span class="in">`sf`</span>.</span>
<span id="cb115-1053"><a href="#cb115-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1054"><a href="#cb115-1054" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb115-1057"><a href="#cb115-1057" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-1058"><a href="#cb115-1058" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-1059"><a href="#cb115-1059" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-plot-lines-polygons</span></span>
<span id="cb115-1060"><a href="#cb115-1060" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visualization of the points, lines, and polygons"</span></span>
<span id="cb115-1061"><a href="#cb115-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1062"><a href="#cb115-1062" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-1063"><a href="#cb115-1063" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-1064"><a href="#cb115-1064" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>) <span class="sc">+</span></span>
<span id="cb115-1065"><a href="#cb115-1065" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> lines, <span class="fu">aes</span>(<span class="at">color =</span> line_name)) <span class="sc">+</span></span>
<span id="cb115-1066"><a href="#cb115-1066" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"Lines"</span>) </span>
<span id="cb115-1067"><a href="#cb115-1067" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1068"><a href="#cb115-1068" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1069"><a href="#cb115-1069" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb115-1070"><a href="#cb115-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1071"><a href="#cb115-1071" aria-hidden="true" tabindex="-1"></a>We will now explore how this works for both line-polygon and polygon-polygon intersections, using the same toy examples we used to demonstrate how <span class="in">`sf::st_intersects()`</span> functions (@fig-plot-lines-polygons shows the lines and polygons).</span>
<span id="cb115-1072"><a href="#cb115-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1073"><a href="#cb115-1073" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb115-1074"><a href="#cb115-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1075"><a href="#cb115-1075" aria-hidden="true" tabindex="-1"></a>**lines and polygons**</span>
<span id="cb115-1076"><a href="#cb115-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1077"><a href="#cb115-1077" aria-hidden="true" tabindex="-1"></a>The following code finds the intersection of the lines and the polygons.</span>
<span id="cb115-1078"><a href="#cb115-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1079"><a href="#cb115-1079" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lines_polygons_intersection}</span></span>
<span id="cb115-1080"><a href="#cb115-1080" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-1081"><a href="#cb115-1081" aria-hidden="true" tabindex="-1"></a><span class="in">intersections_lp &lt;- </span></span>
<span id="cb115-1082"><a href="#cb115-1082" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_intersection(lines, polygons) %&gt;% </span></span>
<span id="cb115-1083"><a href="#cb115-1083" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(int_name = paste0(line_name, "-", polygon_name))</span></span>
<span id="cb115-1084"><a href="#cb115-1084" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-1085"><a href="#cb115-1085" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1086"><a href="#cb115-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1087"><a href="#cb115-1087" aria-hidden="true" tabindex="-1"></a>As shown in the output, each intersection between the lines and polygons becomes an observation (e.g., line 1-polygon 1, line 2-polygon 1, and line 2-polygon 2). Any part of the lines that does not intersect with a polygon is removed and does not appear in the returned sf object. To confirm this, see @fig-lines-polygons-int below:</span>
<span id="cb115-1088"><a href="#cb115-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1091"><a href="#cb115-1091" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-1092"><a href="#cb115-1092" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-lines-polygons-int</span></span>
<span id="cb115-1093"><a href="#cb115-1093" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The outcome of the intersections of the lines and polygons"</span></span>
<span id="cb115-1094"><a href="#cb115-1094" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-1095"><a href="#cb115-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1096"><a href="#cb115-1096" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-1097"><a href="#cb115-1097" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- here are all the original polygons  ---#</span></span>
<span id="cb115-1098"><a href="#cb115-1098" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-1099"><a href="#cb115-1099" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- here is what is returned after st_intersection ---#</span></span>
<span id="cb115-1100"><a href="#cb115-1100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> intersections_lp, <span class="fu">aes</span>(<span class="at">color =</span> int_name), <span class="at">size =</span> <span class="fl">1.5</span>)</span>
<span id="cb115-1101"><a href="#cb115-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1102"><a href="#cb115-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1103"><a href="#cb115-1103" aria-hidden="true" tabindex="-1"></a>This approach also allows us to calculate the length of the line segments that are fully contained within the polygons, similar to what we did in @sec-demo-railroad. Additionally, the attributes (e.g., <span class="in">`polygon_name`</span>) from the source <span class="in">`sf`</span> (the polygons) are merged with their intersecting lines. As a result, <span class="in">`sf::st_intersection()`</span> not only transforms the original geometries but also joins the attributes, which is why I refer to this as a "cropping join."</span>
<span id="cb115-1104"><a href="#cb115-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1105"><a href="#cb115-1105" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb115-1106"><a href="#cb115-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1107"><a href="#cb115-1107" aria-hidden="true" tabindex="-1"></a>**polygons and polygons**</span>
<span id="cb115-1108"><a href="#cb115-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1109"><a href="#cb115-1109" aria-hidden="true" tabindex="-1"></a>The following code finds the intersection of polygon 1 and polygon 3 with polygon 2.</span>
<span id="cb115-1110"><a href="#cb115-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1111"><a href="#cb115-1111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb115-1112"><a href="#cb115-1112" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-1113"><a href="#cb115-1113" aria-hidden="true" tabindex="-1"></a><span class="in">intersections_pp &lt;- </span></span>
<span id="cb115-1114"><a href="#cb115-1114" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_intersection(polygons[c(1,3), ], polygons[2, ]) %&gt;% </span></span>
<span id="cb115-1115"><a href="#cb115-1115" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(int_name = paste0(polygon_name, "-", polygon_name.1))</span></span>
<span id="cb115-1116"><a href="#cb115-1116" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-1117"><a href="#cb115-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1118"><a href="#cb115-1118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1119"><a href="#cb115-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1120"><a href="#cb115-1120" aria-hidden="true" tabindex="-1"></a>As shown in @fig-polygons-polygons-int, each intersection between polygons 1 and 3 with polygon 2 becomes a separate observation (e.g., polygon 1-polygon 2 and polygon 3-polygon 2). Similar to the lines-polygons case, the non-intersecting parts of polygons 1 and 3 are removed and do not appear in the returned sf. Later, we will explore how <span class="in">`sf::st_intersection()`</span> can be used to calculate area-weighted values from the intersecting polygons with the help of <span class="in">`sf::st_area()`</span>.</span>
<span id="cb115-1121"><a href="#cb115-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1124"><a href="#cb115-1124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-1125"><a href="#cb115-1125" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-polygons-polygons-int</span></span>
<span id="cb115-1126"><a href="#cb115-1126" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The outcome of the intersections of polygon 2 and polygons 1 and 3"</span></span>
<span id="cb115-1127"><a href="#cb115-1127" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-1128"><a href="#cb115-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1129"><a href="#cb115-1129" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-1130"><a href="#cb115-1130" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- here are all the original polygons  ---#</span></span>
<span id="cb115-1131"><a href="#cb115-1131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb115-1132"><a href="#cb115-1132" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- here is what is returned after st_intersection ---#</span></span>
<span id="cb115-1133"><a href="#cb115-1133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> intersections_pp, <span class="fu">aes</span>(<span class="at">fill =</span> int_name))</span>
<span id="cb115-1134"><a href="#cb115-1134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1135"><a href="#cb115-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1136"><a href="#cb115-1136" aria-hidden="true" tabindex="-1"></a><span class="fu">### Area-weighted average</span></span>
<span id="cb115-1137"><a href="#cb115-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1138"><a href="#cb115-1138" aria-hidden="true" tabindex="-1"></a>Let’s now return to the example of HUC units and county-level corn acres data from @sec-sp-join. This time, we aim to calculate the area-weighted average of corn acres, rather than just the simple average.</span>
<span id="cb115-1139"><a href="#cb115-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1140"><a href="#cb115-1140" aria-hidden="true" tabindex="-1"></a>Using <span class="in">`sf::st_intersection()`</span>, we can divide each HUC polygon into parts based on the boundaries of the intersecting counties. For each HUC polygon, the intersecting counties are identified, and the polygon is split according to these boundaries.</span>
<span id="cb115-1141"><a href="#cb115-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1142"><a href="#cb115-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1143"><a href="#cb115-1143" aria-hidden="true" tabindex="-1"></a><span class="in">```{r intersection}</span></span>
<span id="cb115-1144"><a href="#cb115-1144" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-1145"><a href="#cb115-1145" aria-hidden="true" tabindex="-1"></a><span class="in">HUC_intersections &lt;- </span></span>
<span id="cb115-1146"><a href="#cb115-1146" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_intersection(HUC_IA, IA_corn) %&gt;% </span></span>
<span id="cb115-1147"><a href="#cb115-1147" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(huc_county = paste0(HUC_CODE, "-", county_code))</span></span>
<span id="cb115-1148"><a href="#cb115-1148" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-1149"><a href="#cb115-1149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1150"><a href="#cb115-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1151"><a href="#cb115-1151" aria-hidden="true" tabindex="-1"></a>The key difference from the <span class="in">`sf::st_join()`</span> example is that each observation in the returned data represents a unique HUC-county intersection. @fig-inter-ex below shows a map of all the intersections between the HUC unit with <span class="in">`HUC_CODE == 10170203`</span> and its four intersecting counties.</span>
<span id="cb115-1152"><a href="#cb115-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1155"><a href="#cb115-1155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb115-1156"><a href="#cb115-1156" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-inter-ex</span></span>
<span id="cb115-1157"><a href="#cb115-1157" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Intersections of a HUC unit and Iowa counties"</span></span>
<span id="cb115-1158"><a href="#cb115-1158" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb115-1159"><a href="#cb115-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1160"><a href="#cb115-1160" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb115-1161"><a href="#cb115-1161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb115-1162"><a href="#cb115-1162" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb115-1163"><a href="#cb115-1163" aria-hidden="true" tabindex="-1"></a>      HUC_intersections,</span>
<span id="cb115-1164"><a href="#cb115-1164" aria-hidden="true" tabindex="-1"></a>      HUC_CODE <span class="sc">==</span> <span class="st">"10170203"</span></span>
<span id="cb115-1165"><a href="#cb115-1165" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb115-1166"><a href="#cb115-1166" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> huc_county)</span>
<span id="cb115-1167"><a href="#cb115-1167" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb115-1168"><a href="#cb115-1168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb115-1169"><a href="#cb115-1169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb115-1170"><a href="#cb115-1170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1171"><a href="#cb115-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1172"><a href="#cb115-1172" aria-hidden="true" tabindex="-1"></a>Note that the attributes from the county data, such as acres, are joined to the resulting intersections, as seen in the output above. As mentioned earlier, <span class="in">`sf::st_intersection()`</span> performs a spetial type of join where the resulting observations are the intersections between the target and source <span class="in">`sf`</span> objects.</span>
<span id="cb115-1173"><a href="#cb115-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1174"><a href="#cb115-1174" aria-hidden="true" tabindex="-1"></a>To calculate the area-weighted average of corn acres, you can first use <span class="in">`sf::st_area()`</span> to determine the area of each intersection. Then, compute the area-weighted average as follows:</span>
<span id="cb115-1175"><a href="#cb115-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1176"><a href="#cb115-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1177"><a href="#cb115-1177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r map_area_weighted}</span></span>
<span id="cb115-1178"><a href="#cb115-1178" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb115-1179"><a href="#cb115-1179" aria-hidden="true" tabindex="-1"></a><span class="in">HUC_aw_acres &lt;- </span></span>
<span id="cb115-1180"><a href="#cb115-1180" aria-hidden="true" tabindex="-1"></a><span class="in">  HUC_intersections %&gt;% </span></span>
<span id="cb115-1181"><a href="#cb115-1181" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- get area ---#</span></span>
<span id="cb115-1182"><a href="#cb115-1182" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(area = as.numeric(st_area(.))) %&gt;% </span></span>
<span id="cb115-1183"><a href="#cb115-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- get area-weight by HUC unit ---#</span></span>
<span id="cb115-1184"><a href="#cb115-1184" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::group_by(HUC_CODE) %&gt;% </span></span>
<span id="cb115-1185"><a href="#cb115-1185" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(weight = area / sum(area)) %&gt;% </span></span>
<span id="cb115-1186"><a href="#cb115-1186" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- calculate area-weighted corn acreage by HUC unit ---#</span></span>
<span id="cb115-1187"><a href="#cb115-1187" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::summarize(aw_acres = sum(weight * acres))</span></span>
<span id="cb115-1188"><a href="#cb115-1188" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-1189"><a href="#cb115-1189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1190"><a href="#cb115-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1191"><a href="#cb115-1191" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises {#sec-exercises-int-vv}</span></span>
<span id="cb115-1192"><a href="#cb115-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1193"><a href="#cb115-1193" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb115-1194"><a href="#cb115-1194" aria-hidden="true" tabindex="-1"></a>Before working on exercises, please run the following codes by hitting the **Run Code** button.</span>
<span id="cb115-1195"><a href="#cb115-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1196"><a href="#cb115-1196" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1197"><a href="#cb115-1197" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb115-1198"><a href="#cb115-1198" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb115-1199"><a href="#cb115-1199" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb115-1200"><a href="#cb115-1200" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb115-1201"><a href="#cb115-1201" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb115-1202"><a href="#cb115-1202" aria-hidden="true" tabindex="-1"></a><span class="in">library(tigris)</span></span>
<span id="cb115-1203"><a href="#cb115-1203" aria-hidden="true" tabindex="-1"></a><span class="in">install.packages(</span></span>
<span id="cb115-1204"><a href="#cb115-1204" aria-hidden="true" tabindex="-1"></a><span class="in">  "r.spatial.workshop.datasets", </span></span>
<span id="cb115-1205"><a href="#cb115-1205" aria-hidden="true" tabindex="-1"></a><span class="in">  repos = c("https://tmieno2.r-universe.dev")</span></span>
<span id="cb115-1206"><a href="#cb115-1206" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb115-1207"><a href="#cb115-1207" aria-hidden="true" tabindex="-1"></a><span class="in">library(r.spatial.workshop.datasets)</span></span>
<span id="cb115-1208"><a href="#cb115-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1209"><a href="#cb115-1209" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1210"><a href="#cb115-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1211"><a href="#cb115-1211" aria-hidden="true" tabindex="-1"></a>:::{.callout-note title="Tips for working with an <span class="in">`webr`</span> session"}</span>
<span id="cb115-1212"><a href="#cb115-1212" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Hit the **Run Code** button to run all the codes in the code area.</span>
<span id="cb115-1213"><a href="#cb115-1213" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>To run only parts of the code, highlight the section you want to execute with your cursor and then press **Cmd + Return** (Mac) or **Ctrl + Enter** (Windows).</span>
<span id="cb115-1214"><a href="#cb115-1214" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>All the code blocks are interconnected and R objects defined in one R code block is available in another R code block.</span>
<span id="cb115-1215"><a href="#cb115-1215" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1216"><a href="#cb115-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1217"><a href="#cb115-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1218"><a href="#cb115-1218" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 1: Spatially intersecting objects</span></span>
<span id="cb115-1219"><a href="#cb115-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1220"><a href="#cb115-1220" aria-hidden="true" tabindex="-1"></a>Find the points in <span class="in">`mower_sensor_sf`</span> that are intersecting with any of the polygons in <span class="in">`fairway_grid`</span>.^<span class="co">[</span><span class="ot">Hint: see @sec-sf-subset</span><span class="co">]</span></span>
<span id="cb115-1221"><a href="#cb115-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1222"><a href="#cb115-1222" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb115-1223"><a href="#cb115-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1224"><a href="#cb115-1224" aria-hidden="true" tabindex="-1"></a><span class="fu">### Work here</span></span>
<span id="cb115-1225"><a href="#cb115-1225" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1226"><a href="#cb115-1226" aria-hidden="true" tabindex="-1"></a><span class="in">data(fairway_grid)</span></span>
<span id="cb115-1227"><a href="#cb115-1227" aria-hidden="true" tabindex="-1"></a><span class="in">data(mower_sensor)</span></span>
<span id="cb115-1228"><a href="#cb115-1228" aria-hidden="true" tabindex="-1"></a><span class="in">mower_sensor_sf &lt;- </span></span>
<span id="cb115-1229"><a href="#cb115-1229" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf(</span></span>
<span id="cb115-1230"><a href="#cb115-1230" aria-hidden="true" tabindex="-1"></a><span class="in">    mower_sensor, </span></span>
<span id="cb115-1231"><a href="#cb115-1231" aria-hidden="true" tabindex="-1"></a><span class="in">    coords = c("LNG", "LAT"),</span></span>
<span id="cb115-1232"><a href="#cb115-1232" aria-hidden="true" tabindex="-1"></a><span class="in">    crs = sf::st_crs(fairway_grid)</span></span>
<span id="cb115-1233"><a href="#cb115-1233" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb115-1234"><a href="#cb115-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1235"><a href="#cb115-1235" aria-hidden="true" tabindex="-1"></a><span class="in">#--- write codes below  ---#</span></span>
<span id="cb115-1236"><a href="#cb115-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1237"><a href="#cb115-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1238"><a href="#cb115-1238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1239"><a href="#cb115-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1240"><a href="#cb115-1240" aria-hidden="true" tabindex="-1"></a><span class="fu">### Answer</span></span>
<span id="cb115-1241"><a href="#cb115-1241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb115-1242"><a href="#cb115-1242" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb115-1243"><a href="#cb115-1243" aria-hidden="true" tabindex="-1"></a><span class="in">intersecting_points &lt;- mower_sensor_sf[fairway_grid, ]</span></span>
<span id="cb115-1244"><a href="#cb115-1244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1245"><a href="#cb115-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1246"><a href="#cb115-1246" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1247"><a href="#cb115-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1248"><a href="#cb115-1248" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 2: Spatial subset and cropping</span></span>
<span id="cb115-1249"><a href="#cb115-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1250"><a href="#cb115-1250" aria-hidden="true" tabindex="-1"></a>Run the following codes first and get the sense of their spatial positions:</span>
<span id="cb115-1251"><a href="#cb115-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1252"><a href="#cb115-1252" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1253"><a href="#cb115-1253" aria-hidden="true" tabindex="-1"></a><span class="in">data(hp_boundary)</span></span>
<span id="cb115-1254"><a href="#cb115-1254" aria-hidden="true" tabindex="-1"></a><span class="in">data(co_counties)</span></span>
<span id="cb115-1255"><a href="#cb115-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1256"><a href="#cb115-1256" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb115-1257"><a href="#cb115-1257" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = hp_boundary, fill = "blue", alpha = 0.3) +</span></span>
<span id="cb115-1258"><a href="#cb115-1258" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = co_counties, fill = NA) +</span></span>
<span id="cb115-1259"><a href="#cb115-1259" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void()</span></span>
<span id="cb115-1260"><a href="#cb115-1260" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1261"><a href="#cb115-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1262"><a href="#cb115-1262" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb115-1263"><a href="#cb115-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1264"><a href="#cb115-1264" aria-hidden="true" tabindex="-1"></a><span class="fu">### Problem 1</span></span>
<span id="cb115-1265"><a href="#cb115-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1266"><a href="#cb115-1266" aria-hidden="true" tabindex="-1"></a>Find the counties in Colorado that are intersecting with the High-Plains aquifer (<span class="in">`hp_boundary`</span>) and name the resulting R object <span class="in">`subset_co_counties`</span>. If you know how to create a map from <span class="in">`sf`</span> objects using <span class="in">`ggplot2`</span> (@sec-create-maps), then create a map of the intersecting Colorado counties.</span>
<span id="cb115-1267"><a href="#cb115-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1268"><a href="#cb115-1268" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb115-1269"><a href="#cb115-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1270"><a href="#cb115-1270" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Work here</span></span>
<span id="cb115-1271"><a href="#cb115-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1272"><a href="#cb115-1272" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1273"><a href="#cb115-1273" aria-hidden="true" tabindex="-1"></a><span class="in">#--- write codes below  ---#</span></span>
<span id="cb115-1274"><a href="#cb115-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1275"><a href="#cb115-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1276"><a href="#cb115-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1277"><a href="#cb115-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1278"><a href="#cb115-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1279"><a href="#cb115-1279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1280"><a href="#cb115-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1281"><a href="#cb115-1281" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Answer</span></span>
<span id="cb115-1282"><a href="#cb115-1282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb115-1283"><a href="#cb115-1283" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb115-1284"><a href="#cb115-1284" aria-hidden="true" tabindex="-1"></a><span class="in">subset_co_counties &lt;- co_counties[hp_boundary, ]</span></span>
<span id="cb115-1285"><a href="#cb115-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1286"><a href="#cb115-1286" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(subset_co_counties) +</span></span>
<span id="cb115-1287"><a href="#cb115-1287" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf() +</span></span>
<span id="cb115-1288"><a href="#cb115-1288" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void()</span></span>
<span id="cb115-1289"><a href="#cb115-1289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1290"><a href="#cb115-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1291"><a href="#cb115-1291" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1292"><a href="#cb115-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1293"><a href="#cb115-1293" aria-hidden="true" tabindex="-1"></a><span class="fu">### Problem 2</span></span>
<span id="cb115-1294"><a href="#cb115-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1295"><a href="#cb115-1295" aria-hidden="true" tabindex="-1"></a>Crop the Colorado counties to <span class="in">`hpa_boundary`</span> and name it <span class="in">`cropped_co_counties`</span> If you know how to create a map from <span class="in">`sf`</span> objects using <span class="in">`ggplot2`</span> (@sec-create-maps), then create a map of the cropped Colorado counties (with <span class="in">`aes(fill = "blue, alpha = 0.3)`</span>) on top of all the Colorado counties.</span>
<span id="cb115-1296"><a href="#cb115-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1297"><a href="#cb115-1297" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb115-1298"><a href="#cb115-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1299"><a href="#cb115-1299" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Work here</span></span>
<span id="cb115-1300"><a href="#cb115-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1301"><a href="#cb115-1301" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1302"><a href="#cb115-1302" aria-hidden="true" tabindex="-1"></a><span class="in">#--- write codes below  ---#</span></span>
<span id="cb115-1303"><a href="#cb115-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1304"><a href="#cb115-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1305"><a href="#cb115-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1306"><a href="#cb115-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1307"><a href="#cb115-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1308"><a href="#cb115-1308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1309"><a href="#cb115-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1310"><a href="#cb115-1310" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Answer</span></span>
<span id="cb115-1311"><a href="#cb115-1311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb115-1312"><a href="#cb115-1312" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb115-1313"><a href="#cb115-1313" aria-hidden="true" tabindex="-1"></a><span class="in">cropped_co_counties &lt;- sf::st_crop(co_counties, hp_boundary)</span></span>
<span id="cb115-1314"><a href="#cb115-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1315"><a href="#cb115-1315" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb115-1316"><a href="#cb115-1316" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = co_counties) +</span></span>
<span id="cb115-1317"><a href="#cb115-1317" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = cropped_co_counties, fill = "blue", alpha = 0.3) +</span></span>
<span id="cb115-1318"><a href="#cb115-1318" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void()</span></span>
<span id="cb115-1319"><a href="#cb115-1319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1320"><a href="#cb115-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1321"><a href="#cb115-1321" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1322"><a href="#cb115-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1323"><a href="#cb115-1323" aria-hidden="true" tabindex="-1"></a><span class="fu">### Problem 3</span></span>
<span id="cb115-1324"><a href="#cb115-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1325"><a href="#cb115-1325" aria-hidden="true" tabindex="-1"></a>Find the area of counties in <span class="in">`co_counties`</span> (name the column <span class="in">`area`</span>) and <span class="in">`cropped_co_counties`</span> (name the column <span class="in">`area_cropped`</span>). Then, join them together using <span class="in">`left_join`</span> and filter the ones that satisfy <span class="in">`area_cropped &lt; area`</span> to find out which counties were chopped off.</span>
<span id="cb115-1326"><a href="#cb115-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1327"><a href="#cb115-1327" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb115-1328"><a href="#cb115-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1329"><a href="#cb115-1329" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Work here</span></span>
<span id="cb115-1330"><a href="#cb115-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1331"><a href="#cb115-1331" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1332"><a href="#cb115-1332" aria-hidden="true" tabindex="-1"></a><span class="in">#--- write codes below  ---#</span></span>
<span id="cb115-1333"><a href="#cb115-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1334"><a href="#cb115-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1335"><a href="#cb115-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1336"><a href="#cb115-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1337"><a href="#cb115-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1338"><a href="#cb115-1338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1339"><a href="#cb115-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1340"><a href="#cb115-1340" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Answer</span></span>
<span id="cb115-1341"><a href="#cb115-1341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb115-1342"><a href="#cb115-1342" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb115-1343"><a href="#cb115-1343" aria-hidden="true" tabindex="-1"></a><span class="in">subset_co_area &lt;- </span></span>
<span id="cb115-1344"><a href="#cb115-1344" aria-hidden="true" tabindex="-1"></a><span class="in">  co_counties %&gt;%</span></span>
<span id="cb115-1345"><a href="#cb115-1345" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(area = sf::st_area(geometry) %&gt;% as.numeric()) %&gt;%</span></span>
<span id="cb115-1346"><a href="#cb115-1346" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- make it non-sf so it can be merged with left_join later  ---#</span></span>
<span id="cb115-1347"><a href="#cb115-1347" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_drop_geometry() %&gt;%</span></span>
<span id="cb115-1348"><a href="#cb115-1348" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(area, COUNTYFP)</span></span>
<span id="cb115-1349"><a href="#cb115-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1350"><a href="#cb115-1350" aria-hidden="true" tabindex="-1"></a><span class="in">cropped_co_area &lt;- </span></span>
<span id="cb115-1351"><a href="#cb115-1351" aria-hidden="true" tabindex="-1"></a><span class="in">  cropped_co_counties %&gt;%</span></span>
<span id="cb115-1352"><a href="#cb115-1352" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(area_cro = sf::st_area(geometry) %&gt;% as.numeric()) %&gt;%</span></span>
<span id="cb115-1353"><a href="#cb115-1353" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- make it non-sf so it can be merged with left_join later  ---#</span></span>
<span id="cb115-1354"><a href="#cb115-1354" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_drop_geometry() %&gt;%</span></span>
<span id="cb115-1355"><a href="#cb115-1355" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(area_cro, COUNTYFP)</span></span>
<span id="cb115-1356"><a href="#cb115-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1357"><a href="#cb115-1357" aria-hidden="true" tabindex="-1"></a><span class="in">cut_off_counties &lt;- </span></span>
<span id="cb115-1358"><a href="#cb115-1358" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::left_join(subset_co_area, cropped_co_area, by = "COUNTYFP") %&gt;%</span></span>
<span id="cb115-1359"><a href="#cb115-1359" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::filter(area &lt; area_cro)</span></span>
<span id="cb115-1360"><a href="#cb115-1360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1361"><a href="#cb115-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1362"><a href="#cb115-1362" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1363"><a href="#cb115-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1364"><a href="#cb115-1364" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1365"><a href="#cb115-1365" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of panel--&gt;</span></span>
<span id="cb115-1366"><a href="#cb115-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1367"><a href="#cb115-1367" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 3: Spatial join</span></span>
<span id="cb115-1368"><a href="#cb115-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1369"><a href="#cb115-1369" aria-hidden="true" tabindex="-1"></a>In this exercise, we will use Nebraska county boundaries (<span class="in">`ne_counties`</span>) and irrigation wells in Nebraska (<span class="in">`wells_ne_sf`</span>).</span>
<span id="cb115-1370"><a href="#cb115-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1371"><a href="#cb115-1371" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1372"><a href="#cb115-1372" aria-hidden="true" tabindex="-1"></a><span class="in">data(ne_counties)</span></span>
<span id="cb115-1373"><a href="#cb115-1373" aria-hidden="true" tabindex="-1"></a><span class="in">data(wells_ne_sf)</span></span>
<span id="cb115-1374"><a href="#cb115-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1375"><a href="#cb115-1375" aria-hidden="true" tabindex="-1"></a><span class="in">#--- visualize ---#</span></span>
<span id="cb115-1376"><a href="#cb115-1376" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb115-1377"><a href="#cb115-1377" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = ne_counties) +</span></span>
<span id="cb115-1378"><a href="#cb115-1378" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = wells_ne_sf) +</span></span>
<span id="cb115-1379"><a href="#cb115-1379" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void()</span></span>
<span id="cb115-1380"><a href="#cb115-1380" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1381"><a href="#cb115-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1382"><a href="#cb115-1382" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb115-1383"><a href="#cb115-1383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1384"><a href="#cb115-1384" aria-hidden="true" tabindex="-1"></a><span class="fu">### Problem 1</span></span>
<span id="cb115-1385"><a href="#cb115-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1386"><a href="#cb115-1386" aria-hidden="true" tabindex="-1"></a>Spatially join <span class="in">`ne_counties`</span> with <span class="in">`wells_ne_sf`</span> and then find the total amount of groundwater extracted (<span class="in">`gw_extracted`</span>) per county.</span>
<span id="cb115-1387"><a href="#cb115-1387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1388"><a href="#cb115-1388" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb115-1389"><a href="#cb115-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1390"><a href="#cb115-1390" aria-hidden="true" tabindex="-1"></a><span class="fu">### Work here</span></span>
<span id="cb115-1391"><a href="#cb115-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1392"><a href="#cb115-1392" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1393"><a href="#cb115-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1394"><a href="#cb115-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1395"><a href="#cb115-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1396"><a href="#cb115-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1397"><a href="#cb115-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1398"><a href="#cb115-1398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1399"><a href="#cb115-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1400"><a href="#cb115-1400" aria-hidden="true" tabindex="-1"></a><span class="fu">### Answer</span></span>
<span id="cb115-1401"><a href="#cb115-1401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb115-1402"><a href="#cb115-1402" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb115-1403"><a href="#cb115-1403" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_join(ne_counties, wells_ne_sf) %&gt;%</span></span>
<span id="cb115-1404"><a href="#cb115-1404" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- geometry no longer neded (makes summary faster later) ---#</span></span>
<span id="cb115-1405"><a href="#cb115-1405" aria-hidden="true" tabindex="-1"></a><span class="in">  st_drop_geometry() %&gt;%</span></span>
<span id="cb115-1406"><a href="#cb115-1406" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::group_by(countyfp) %&gt;%</span></span>
<span id="cb115-1407"><a href="#cb115-1407" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::summarize(tot_gw = sum(gw_extracted))</span></span>
<span id="cb115-1408"><a href="#cb115-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1409"><a href="#cb115-1409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1410"><a href="#cb115-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1411"><a href="#cb115-1411" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1412"><a href="#cb115-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1413"><a href="#cb115-1413" aria-hidden="true" tabindex="-1"></a><span class="fu">### Problem 2</span></span>
<span id="cb115-1414"><a href="#cb115-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1415"><a href="#cb115-1415" aria-hidden="true" tabindex="-1"></a>Use <span class="in">`aggregate()`</span> instead to do the process implemented in Problem 1 in one step.</span>
<span id="cb115-1416"><a href="#cb115-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1417"><a href="#cb115-1417" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb115-1418"><a href="#cb115-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1419"><a href="#cb115-1419" aria-hidden="true" tabindex="-1"></a><span class="fu">### Work here</span></span>
<span id="cb115-1420"><a href="#cb115-1420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1421"><a href="#cb115-1421" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1422"><a href="#cb115-1422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1423"><a href="#cb115-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1424"><a href="#cb115-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1425"><a href="#cb115-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1426"><a href="#cb115-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1427"><a href="#cb115-1427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1428"><a href="#cb115-1428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1429"><a href="#cb115-1429" aria-hidden="true" tabindex="-1"></a><span class="fu">### Answer</span></span>
<span id="cb115-1430"><a href="#cb115-1430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb115-1431"><a href="#cb115-1431" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb115-1432"><a href="#cb115-1432" aria-hidden="true" tabindex="-1"></a><span class="in">aggregate(wells_ne_sf, ne_counties, FUN = sum)</span></span>
<span id="cb115-1433"><a href="#cb115-1433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1434"><a href="#cb115-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1435"><a href="#cb115-1435" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1436"><a href="#cb115-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1437"><a href="#cb115-1437" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1438"><a href="#cb115-1438" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of panel--&gt;</span></span>
<span id="cb115-1439"><a href="#cb115-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1440"><a href="#cb115-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1441"><a href="#cb115-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1442"><a href="#cb115-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1443"><a href="#cb115-1443" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 3: Spatial join</span></span>
<span id="cb115-1444"><a href="#cb115-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1445"><a href="#cb115-1445" aria-hidden="true" tabindex="-1"></a>In this exercise, we use soybean yield (<span class="in">`soy_yield`</span>) and as-applied seed rate (<span class="in">`as_applied_s_rate`</span>) within a production field.</span>
<span id="cb115-1446"><a href="#cb115-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1447"><a href="#cb115-1447" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1448"><a href="#cb115-1448" aria-hidden="true" tabindex="-1"></a><span class="in">#--- soybean yield ---#</span></span>
<span id="cb115-1449"><a href="#cb115-1449" aria-hidden="true" tabindex="-1"></a><span class="in">data(soy_yield)</span></span>
<span id="cb115-1450"><a href="#cb115-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1451"><a href="#cb115-1451" aria-hidden="true" tabindex="-1"></a><span class="in">#--- seed rate ---#</span></span>
<span id="cb115-1452"><a href="#cb115-1452" aria-hidden="true" tabindex="-1"></a><span class="in">data(as_applied_s_rate)</span></span>
<span id="cb115-1453"><a href="#cb115-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1454"><a href="#cb115-1454" aria-hidden="true" tabindex="-1"></a><span class="in">#--- visualize ---#</span></span>
<span id="cb115-1455"><a href="#cb115-1455" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb115-1456"><a href="#cb115-1456" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = soy_yield, size = 0.4, color = "red") +</span></span>
<span id="cb115-1457"><a href="#cb115-1457" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = as_applied_s_rate, size = 0.4, color = "darkgreen") +</span></span>
<span id="cb115-1458"><a href="#cb115-1458" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void()</span></span>
<span id="cb115-1459"><a href="#cb115-1459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1460"><a href="#cb115-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1461"><a href="#cb115-1461" aria-hidden="true" tabindex="-1"></a>For each of the yield points, find all the seed rate points within 10 meter. Then, find the average of the neighboring seed rates by yield point.</span>
<span id="cb115-1462"><a href="#cb115-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1463"><a href="#cb115-1463" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb115-1464"><a href="#cb115-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1465"><a href="#cb115-1465" aria-hidden="true" tabindex="-1"></a><span class="fu">### Work here</span></span>
<span id="cb115-1466"><a href="#cb115-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1467"><a href="#cb115-1467" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb115-1468"><a href="#cb115-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1469"><a href="#cb115-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1470"><a href="#cb115-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1471"><a href="#cb115-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1472"><a href="#cb115-1472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1473"><a href="#cb115-1473" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1474"><a href="#cb115-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1475"><a href="#cb115-1475" aria-hidden="true" tabindex="-1"></a><span class="fu">### Answer</span></span>
<span id="cb115-1476"><a href="#cb115-1476" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb115-1477"><a href="#cb115-1477" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb115-1478"><a href="#cb115-1478" aria-hidden="true" tabindex="-1"></a><span class="in">soy_seed &lt;-</span></span>
<span id="cb115-1479"><a href="#cb115-1479" aria-hidden="true" tabindex="-1"></a><span class="in">  st_join(</span></span>
<span id="cb115-1480"><a href="#cb115-1480" aria-hidden="true" tabindex="-1"></a><span class="in">    soy_yield,</span></span>
<span id="cb115-1481"><a href="#cb115-1481" aria-hidden="true" tabindex="-1"></a><span class="in">    as_applied_s_rate,</span></span>
<span id="cb115-1482"><a href="#cb115-1482" aria-hidden="true" tabindex="-1"></a><span class="in">    join = \(x, y) st_is_within_distance(x, y, dist = 10)</span></span>
<span id="cb115-1483"><a href="#cb115-1483" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb115-1484"><a href="#cb115-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1485"><a href="#cb115-1485" aria-hidden="true" tabindex="-1"></a><span class="in">soy_seed %&gt;%</span></span>
<span id="cb115-1486"><a href="#cb115-1486" aria-hidden="true" tabindex="-1"></a><span class="in">  st_drop_geometry() %&gt;%</span></span>
<span id="cb115-1487"><a href="#cb115-1487" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(yield_id) %&gt;%</span></span>
<span id="cb115-1488"><a href="#cb115-1488" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(avg_seed_rate = mean(seed_rate))</span></span>
<span id="cb115-1489"><a href="#cb115-1489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb115-1490"><a href="#cb115-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1491"><a href="#cb115-1491" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb115-1492"><a href="#cb115-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1493"><a href="#cb115-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-1494"><a href="#cb115-1494" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/03-SpatialInteractionVectorVector.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer><script type="module">
// Handle cell initialization initialization
qwebrCellDetails.map(
  (entry) => {
    // Handle the creation of the element
    qwebrCreateHTMLElement(entry);
    // In the event of interactive, initialize the monaco editor
    if (entry.options.context == EvalTypes.Interactive) {
      qwebrCreateMonacoEditorInstance(entry);
    }
  }
);

// Identify non-interactive cells (in order)
const filteredEntries = qwebrCellDetails.filter(entry => {
  const contextOption = entry.options && entry.options.context;
  return ['output', 'setup'].includes(contextOption) || (contextOption == "interactive" && entry.options && entry.options.autorun === 'true');
});

// Condition non-interactive cells to only be run after webR finishes its initialization.
qwebrInstance.then(
  async () => {
    const nHiddenCells = filteredEntries.length;
    var currentHiddenCell = 0;


    // Modify button state
    qwebrSetInteractiveButtonState(`🟡 Running hidden code cells ...`, false);

    // Begin processing non-interactive sections
    // Due to the iteration policy, we must use a for() loop.
    // Otherwise, we would need to switch to using reduce with an empty
    // starting promise
    for (const entry of filteredEntries) {

      // Determine cell being examined
      currentHiddenCell = currentHiddenCell + 1;
      const formattedMessage = `Evaluating hidden cell ${currentHiddenCell} out of ${nHiddenCells}`;

      // Update the document status header
      if (qwebrShowStartupMessage) {
        qwebrUpdateStatusHeader(formattedMessage);
      }

      // Display the update in non-active areas
      qwebrUpdateStatusMessage(formattedMessage);

      // Extract details on the active cell
      const evalType = entry.options.context;
      const cellCode = entry.code;
      const qwebrCounter = entry.id;

      if (['output', 'setup'].includes(evalType)) {
        // Disable further global status updates
        const activeContainer = document.getElementById(`qwebr-non-interactive-loading-container-${qwebrCounter}`);
        activeContainer.classList.remove('qwebr-cell-needs-evaluation');
        activeContainer.classList.add('qwebr-cell-evaluated');

        // Update status on the code cell
        const activeStatus = document.getElementById(`qwebr-status-text-${qwebrCounter}`);
        activeStatus.innerText = " Evaluating hidden code cell...";
        activeStatus.classList.remove('qwebr-cell-needs-evaluation');
        activeStatus.classList.add('qwebr-cell-evaluated');
      }

      switch (evalType) {
        case 'interactive':
          // TODO: Make this more standardized.
          // At the moment, we're overriding the interactive status update by pretending its
          // output-like. 
          const tempOptions = entry.options;
          tempOptions["context"] = "output"
          // Run the code in a non-interactive state that is geared to displaying output
          await qwebrExecuteCode(`${cellCode}`, qwebrCounter, tempOptions);
          break;
        case 'output':
          // Run the code in a non-interactive state that is geared to displaying output
          await qwebrExecuteCode(`${cellCode}`, qwebrCounter, entry.options);
          break;
        case 'setup':
          const activeDiv = document.getElementById(`qwebr-noninteractive-setup-area-${qwebrCounter}`);

          // Store code in history
          qwebrLogCodeToHistory(cellCode, entry.options);

          // Run the code in a non-interactive state with all output thrown away
          await mainWebR.evalRVoid(`${cellCode}`);
          break;
        default: 
          break; 
      }

      if (['output', 'setup'].includes(evalType)) {
        // Disable further global status updates
        const activeContainer = document.getElementById(`qwebr-non-interactive-loading-container-${qwebrCounter}`);
        // Disable visibility
        activeContainer.style.visibility = 'hidden';
        activeContainer.style.display = 'none';
      }
    }
  }
).then(
  () => {
    // Release document status as ready

    if (qwebrShowStartupMessage) {
      qwebrStartupMessage.innerText = "🟢 Ready!"
    }
  
    qwebrSetInteractiveButtonState(
      `<i class="fa-solid fa-play qwebr-icon-run-code"></i> <span>Run Code</span>`, 
      true
    );  
  }
);
</script>


</body></html>
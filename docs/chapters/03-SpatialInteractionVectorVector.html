<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>3&nbsp; Spatial Interactions of Vector Data: Subsetting and Joining – R as GIS for Economists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/04-RasterDataBasics.html" rel="next">
<link href="../chapters/02-VectorDataBasics.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Google tag (gtag.js) --><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../style.css">
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-VectorDataBasics.html">Foundations</a></li><li class="breadcrumb-item"><a href="../chapters/03-SpatialInteractionVectorVector.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">R as GIS for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/R-as-GIS-for-Economists" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/00-preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Demonstrations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-Demonstration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-VectorDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-SpatialInteractionVectorVector.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-RasterDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-SpatialInteractionVectorRaster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Extensions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-stars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-CreateMaps-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-DownloadSpatialData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">(slightly) Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-SpeedThingsUp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-ParallelComputing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Loop and Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-ggplot2-appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">ggplot2 minimals</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#before-you-start" id="toc-before-you-start" class="nav-link active" data-scroll-target="#before-you-start">Before you start</a>
  <ul class="collapse">
<li><a href="#direction-for-replication" id="toc-direction-for-replication" class="nav-link" data-scroll-target="#direction-for-replication">Direction for replication</a></li>
  </ul>
</li>
  <li>
<a href="#sec-topo" id="toc-sec-topo" class="nav-link" data-scroll-target="#sec-topo"><span class="header-section-number">3.1</span> Topological relations</a>
  <ul class="collapse">
<li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">3.1.1</span> Data preparation</a></li>
  <li><a href="#sfst_intersects" id="toc-sfst_intersects" class="nav-link" data-scroll-target="#sfst_intersects"><span class="header-section-number">3.1.2</span> <code>sf::st_intersects()</code></a></li>
  <li><a href="#sfst_is_within_distance" id="toc-sfst_is_within_distance" class="nav-link" data-scroll-target="#sfst_is_within_distance"><span class="header-section-number">3.1.3</span> <code>sf::st_is_within_distance()</code></a></li>
  </ul>
</li>
  <li>
<a href="#spatial-cropping" id="toc-spatial-cropping" class="nav-link" data-scroll-target="#spatial-cropping"><span class="header-section-number">3.2</span> Spatial cropping</a>
  <ul class="collapse">
<li><a href="#data-preparation-1" id="toc-data-preparation-1" class="nav-link" data-scroll-target="#data-preparation-1"><span class="header-section-number">3.2.1</span> Data preparation</a></li>
  <li><a href="#bounding-box" id="toc-bounding-box" class="nav-link" data-scroll-target="#bounding-box"><span class="header-section-number">3.2.2</span> Bounding box</a></li>
  <li><a href="#spatial-cropping-1" id="toc-spatial-cropping-1" class="nav-link" data-scroll-target="#spatial-cropping-1"><span class="header-section-number">3.2.3</span> Spatial cropping</a></li>
  </ul>
</li>
  <li>
<a href="#spatial-subsetting" id="toc-spatial-subsetting" class="nav-link" data-scroll-target="#spatial-subsetting"><span class="header-section-number">3.3</span> Spatial subsetting</a>
  <ul class="collapse">
<li><a href="#polygons-source-vs-polygons-target" id="toc-polygons-source-vs-polygons-target" class="nav-link" data-scroll-target="#polygons-source-vs-polygons-target"><span class="header-section-number">3.3.1</span> polygons (source) vs polygons (target)</a></li>
  <li><a href="#points-source-vs-polygons-target" id="toc-points-source-vs-polygons-target" class="nav-link" data-scroll-target="#points-source-vs-polygons-target"><span class="header-section-number">3.3.2</span> points (source) vs polygons (target)</a></li>
  <li><a href="#sec-lines_polygons" id="toc-sec-lines_polygons" class="nav-link" data-scroll-target="#sec-lines_polygons"><span class="header-section-number">3.3.3</span> lines (source) vs polygons (target)</a></li>
  <li><a href="#sec-polygons_points" id="toc-sec-polygons_points" class="nav-link" data-scroll-target="#sec-polygons_points"><span class="header-section-number">3.3.4</span> polygons (source) vs points (target)</a></li>
  </ul>
</li>
  <li>
<a href="#sec-sp-join" id="toc-sec-sp-join" class="nav-link" data-scroll-target="#sec-sp-join"><span class="header-section-number">3.4</span> Spatial join</a>
  <ul class="collapse">
<li><a href="#syntax" id="toc-syntax" class="nav-link" data-scroll-target="#syntax"><span class="header-section-number">3.4.1</span> Syntax</a></li>
  <li><a href="#case-1-points-target-vs-polygons-source" id="toc-case-1-points-target-vs-polygons-source" class="nav-link" data-scroll-target="#case-1-points-target-vs-polygons-source"><span class="header-section-number">3.4.2</span> Case 1: points (target) vs polygons (source)</a></li>
  <li><a href="#sec-polygons-points" id="toc-sec-polygons-points" class="nav-link" data-scroll-target="#sec-polygons-points"><span class="header-section-number">3.4.3</span> Case 2: polygons (target) vs points (source)</a></li>
  <li><a href="#sec-polygon-polygon" id="toc-sec-polygon-polygon" class="nav-link" data-scroll-target="#sec-polygon-polygon"><span class="header-section-number">3.4.4</span> Case 3: polygons (target) vs polygons (source)</a></li>
  </ul>
</li>
  <li><a href="#spatial-join-and-summary-in-one-step" id="toc-spatial-join-and-summary-in-one-step" class="nav-link" data-scroll-target="#spatial-join-and-summary-in-one-step"><span class="header-section-number">3.5</span> Spatial join and summary in one step</a></li>
  <li>
<a href="#spatial-intersection-cropping-join" id="toc-spatial-intersection-cropping-join" class="nav-link" data-scroll-target="#spatial-intersection-cropping-join"><span class="header-section-number">3.6</span> Spatial intersection (cropping join)</a>
  <ul class="collapse">
<li><a href="#sec-st-intersection" id="toc-sec-st-intersection" class="nav-link" data-scroll-target="#sec-st-intersection"><span class="header-section-number">3.6.1</span> <code>sf::st_intersection()</code></a></li>
  <li><a href="#area-weighted-average" id="toc-area-weighted-average" class="nav-link" data-scroll-target="#area-weighted-average"><span class="header-section-number">3.6.2</span> Area-weighted average</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/03-SpatialInteractionVectorVector.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/02-VectorDataBasics.html">Foundations</a></li><li class="breadcrumb-item"><a href="../chapters/03-SpatialInteractionVectorVector.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-int-vv" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="before-you-start" class="level2 unnumbered page-columns page-full"><h2 class="unnumbered anchored" data-anchor-id="before-you-start">Before you start</h2>
<p>In this chapter, we explore the spatial interactions between two <code>sf</code> objects. We begin by examining topological relations—how two spatial objects relate to each other—focusing on <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_is_within_distance()</a></code>. <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> is particularly important as it is the most commonly used topological relation and serves as the default for spatial subsetting and joining in <code>sf</code>.</p>
<p>Next, we cover spatial subsetting, which involves filtering spatial data based on the geographic features of another dataset. Finally, we will discuss spatial joining, where attribute values from one spatial dataset are assigned to another based on their topological relationship<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;For those familiar with the <code>sp</code> package, these operations are similar to <code><a href="https://edzer.github.io/sp/reference/over.html">sp::over()</a></code>.</p></div></div><section id="direction-for-replication" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="direction-for-replication">Direction for replication</h3>
<p><strong>Datasets</strong></p>
<p>All the datasets that you need to import are available <a href="https://www.dropbox.com/sh/vhtpjiezijb97lj/AABpvzqdyZMkR1DgUBeI_mOja?dl=0">here</a>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</p>
<ul>
<li>set a folder (any folder) as the working directory using <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code><br>
</li>
<li>create a folder called “Data” inside the folder designated as the working directory (if you have created a “Data” folder previously, skip this step)</li>
<li>download the pertinent datasets from <a href="https://www.dropbox.com/sh/vhtpjiezijb97lj/AABpvzqdyZMkR1DgUBeI_mOja?dl=0">here</a>
</li>
<li>place all the files in the downloaded folder in the “Data” folder</li>
</ul>
<p><strong>Packages</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">data.table</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">ggplot2</span>, <span class="co"># for map creation</span></span>
<span>  <span class="va">tmap</span> <span class="co"># for map creation</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sec-topo" class="level2 page-columns page-full" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="sec-topo">
<span class="header-section-number">3.1</span> Topological relations</h2>
<p>Before diving into spatial subsetting and joining, we first examine topological relations. These refer to how multiple spatial objects are related to each other in space. The <code>sf</code> package provides various functions to identify these spatial relationships, with our primary focus being on intersections, which can be identified using <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. We will also briefly explore <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_is_within_distance()</a></code>. If you’re interested in other topological relations, you can check the documentation with <code>?geos_binary_pred</code>.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;Other topological relations like <code>st_within()</code> or <code>st_touches()</code> are rarely used.</p></div></div><section id="data-preparation" class="level3" data-number="3.1.1"><h3 data-number="3.1.1" class="anchored" data-anchor-id="data-preparation">
<span class="header-section-number">3.1.1</span> Data preparation</h3>
<p>We will use three <code>sf</code> objects: <code>points</code>, <code>lines</code>, and <code>polygons</code>.</p>
<p><strong>POINTS</strong></p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create points ---#</span></span>
<span><span class="va">point_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">point_2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">point_3</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- combine the points to make a single  sf of points ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">point_1</span>, <span class="va">point_2</span>, <span class="va">point_3</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>point_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"point 1"</span>, <span class="st">"point 2"</span>, <span class="st">"point 3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 1 ymin: 1 xmax: 2 ymax: 3
CRS:           NA
            x point_name
1 POINT (2 2)    point 1
2 POINT (1 1)    point 2
3 POINT (1 3)    point 3</code></pre>
</div>
</div>
<p><strong>LINES</strong></p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create points ---#</span></span>
<span><span class="va">line_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">line_2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- combine the points to make a single  sf of points ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">lines</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">line_1</span>, <span class="va">line_2</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>line_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"line 1"</span>, <span class="st">"line 2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 2 features and 1 field
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 0 ymin: 0 xmax: 2.5 ymax: 2
CRS:           NA
                            x line_name
1   LINESTRING (0 0, 2.5 0.5)    line 1
2 LINESTRING (1.5 0.5, 2.5 2)    line 2</code></pre>
</div>
</div>
<p><strong>POLYGONS</strong></p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create polygons ---#</span></span>
<span><span class="va">polygon_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">polygon_2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">3.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">1.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">polygon_3</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3.2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.3</span>, <span class="fl">3.2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2.5</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- combine the polygons to make an sf of polygons ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">polygons</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">polygon_1</span>, <span class="va">polygon_2</span>, <span class="va">polygon_3</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>polygon_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"polygon 1"</span>, <span class="st">"polygon 2"</span>, <span class="st">"polygon 3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 0 ymin: 0 xmax: 2.5 ymax: 3.5
CRS:           NA
                               x polygon_name
1 POLYGON ((0 0, 2 0, 2 2, 0 ...    polygon 1
2 POLYGON ((0.5 1.5, 0.5 3.5,...    polygon 2
3 POLYGON ((0.5 2.5, 0.5 3.2,...    polygon 3</code></pre>
</div>
</div>
<hr>
<p><a href="#fig-plot-point-polygons" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> shows how they look together:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">line_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Lines"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points</span>, <span class="fu">aes</span><span class="op">(</span>shape <span class="op">=</span> <span class="va">point_name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_shape_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Points"</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-plot-point-polygons" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plot-point-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-plot-point-polygons-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-point-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Visualization of the points, lines, and polygons
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sfst_intersects" class="level3 page-columns page-full" data-number="3.1.2"><h3 data-number="3.1.2" class="anchored" data-anchor-id="sfst_intersects">
<span class="header-section-number">3.1.2</span> <code>sf::st_intersects()</code>
</h3>
<p><code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> identifies which <code>sfg</code> object in an <code>sf</code> (or <code>sfc</code>) intersects with <code>sfg</code> object(s) in another <code>sf</code>. For example, you can use the function to identify which well is located within which county. <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> is the most commonly used topological relation. It is important to understand what it does as it is the default topological relation used when performing spatial subsetting and joining, which we will cover later.</p>
<hr>
<p><strong>points and polygons</strong> (<a href="#fig-points-polygons" class="quarto-xref">Figure&nbsp;<span>3.2</span></a>)</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points</span>, <span class="fu">aes</span><span class="op">(</span>shape <span class="op">=</span> <span class="va">point_name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_shape_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Points"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-points-polygons" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-points-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-points-polygons-1.png" id="fig-points-polygons" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-points-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2
</figcaption></figure>
</div>
</div>
</div>
</div></div><div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">points</span>, <span class="va">polygons</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 3, where the predicate
was `intersects'
 1: 1, 2, 3
 2: 1
 3: 2, 3</code></pre>
</div>
</div>
<p>As you can see, the output is a list of which polygon(s) each of the points intersect with. The numbers 1, 2, and 3 in the first row mean that 1st (polygon 1), 2nd (polygon 2), and 3rd (polygon 3) objects of the <code>polygons</code> intersect with the first point (point 1) of the <code>points</code> object. The fact that point 1 is considered to be intersecting with polygon 2 means that the area inside the border is considered a part of the polygon (of course).</p>
<p>If you would like the results of <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> in a matrix form with boolean values filling the matrix, you can add <code>sparse = FALSE</code> option.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">points</span>, <span class="va">polygons</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]  [,2]  [,3]
[1,]  TRUE  TRUE  TRUE
[2,]  TRUE FALSE FALSE
[3,] FALSE  TRUE  TRUE</code></pre>
</div>
</div>
<hr>
<p><strong>lines and polygons</strong> (<a href="#fig-lines-polygons" class="quarto-xref">Figure&nbsp;<span>3.3</span></a>)</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">line_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Lines"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-lines-polygons" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lines-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-lines-polygons-1.png" id="fig-lines-polygons" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-lines-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3
</figcaption></figure>
</div>
</div>
</div>
</div></div><div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">lines</span>, <span class="va">polygons</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 2, where the predicate
was `intersects'
 1: 1
 2: 1, 2</code></pre>
</div>
</div>
<p>The output is a list of which polygon(s) each of the lines intersect with. For example, line intersects with the 1st and 2nd elements of <code>polygons</code>, which are <code>polygon 1</code> and <code>polygon 2</code>.</p>
<hr>
<p><strong>polygons and polygons</strong> (<a href="#fig-polygons-polygons" class="quarto-xref">Figure&nbsp;<span>3.4</span></a>)</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-polygons-polygons" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-polygons-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-polygons-polygons-1.png" id="fig-polygons-polygons" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-polygons-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>For polygons vs polygons interaction, <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> identifies any polygons that either touches (even at a point like polygons 1 and 3) or share some area.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">polygons</span>, <span class="va">polygons</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 3, where the predicate
was `intersects'
 1: 1, 2, 3
 2: 1, 2, 3
 3: 1, 2, 3</code></pre>
</div>
</div>
<p>Clearly, all of them interact with all the polygons (including themselves) in this case.</p>
</section><section id="sfst_is_within_distance" class="level3 page-columns page-full" data-number="3.1.3"><h3 data-number="3.1.3" class="anchored" data-anchor-id="sfst_is_within_distance">
<span class="header-section-number">3.1.3</span> <code>sf::st_is_within_distance()</code>
</h3>
<p>This function identifies whether two spatial objects are within the distance you specify<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;For example, this function can be useful to identify neighbors. For example, you may want to find irrigation wells located around well <span class="math inline">\(i\)</span> to label them as well <span class="math inline">\(i\)</span>’s neighbor.</p></div></div><p>We will use two sets of points data.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">38424738</span><span class="op">)</span></span>
<span></span>
<span><span class="va">points_set_1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">points_set_2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">points_set_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 5 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 0.2641607 ymin: 0.2094549 xmax: 0.789738 ymax: 0.9198815
CRS:           NA
                            x id
1 POINT (0.2809702 0.7930091)  1
2 POINT (0.4907635 0.9198815)  2
3  POINT (0.789738 0.2094549)  3
4 POINT (0.2641607 0.3031891)  4
5 POINT (0.4544901 0.6499282)  5</code></pre>
</div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">points_set_2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 5 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 0.01389647 ymin: 0.2871567 xmax: 0.7799449 ymax: 0.8535346
CRS:           NA
                             x id
1  POINT (0.2641116 0.8535346)  1
2 POINT (0.01389647 0.2871567)  2
3  POINT (0.5088085 0.6107668)  3
4   POINT (0.248774 0.5386513)  4
5  POINT (0.7799449 0.6599416)  5</code></pre>
</div>
</div>
<p>Here is how they are spatially distributed (<a href="#fig-map-points-points-points" class="quarto-xref">Figure&nbsp;<span>3.5</span></a>). Instead of circles of points, their corresponding <code>id</code> (or equivalently row number here) values are displayed.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points_set_1</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points_set_2</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-points-points-points" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-points-points-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-points-points-points-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-points-points-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.5: The locations of the set of points
</figcaption></figure>
</div>
</div>
</div>
<p>We want to know which of the blue points (<code>points_set_2</code>) are located within 0.2 from each of the red points (<code>points_set_1</code>). <a href="#fig-points-points-within" class="quarto-xref">Figure&nbsp;<span>3.6</span></a> gives us the answer visually.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create 0.2 buffers around points in points_set_1 ---#</span></span>
<span><span class="va">buffer_1</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">points_set_1</span>, dist <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">buffer_1</span>, color <span class="op">=</span> <span class="st">"red"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points_set_1</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">points_set_2</span>, <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-points-points-within" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-points-points-within-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-points-points-within-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-points-points-within-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.6: The blue points within 0.2 radius of the red points
</figcaption></figure>
</div>
</div>
</div>
<p>Confirm your visual inspection results with the outcome of the following code using <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_is_within_distance()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_is_within_distance</a></span><span class="op">(</span><span class="va">points_set_1</span>, <span class="va">points_set_2</span>, dist <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 5, where the predicate
was `is_within_distance'
 1: 1
 2: (empty)
 3: (empty)
 4: (empty)
 5: 3</code></pre>
</div>
</div>
</section></section><section id="spatial-cropping" class="level2 page-columns page-full" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="spatial-cropping">
<span class="header-section-number">3.2</span> Spatial cropping</h2>
<section id="data-preparation-1" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="data-preparation-1">
<span class="header-section-number">3.2.1</span> Data preparation</h3>
<p>Let’s import the following files:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- Kansas county borders ---#</span></span>
<span><span class="va">KS_counties</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/KS_county_borders.rds"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">32614</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- High-Plains Aquifer boundary ---#</span></span>
<span><span class="va">hpa</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/hp_bound2010.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">KS_counties</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- all the irrigation wells in KS ---#</span></span>
<span><span class="va">KS_wells</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/Kansas_wells.rds"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">KS_counties</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- US railroads in the Mid West region ---#</span></span>
<span><span class="va">rail_roads_mw</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/mw_railroads.geojson"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="bounding-box" class="level3" data-number="3.2.2"><h3 data-number="3.2.2" class="anchored" data-anchor-id="bounding-box">
<span class="header-section-number">3.2.2</span> Bounding box</h3>
<p>We can use <code>st_crop()</code> to crop a spatial object to a spatial bounding box (extent) of another spatial object. The bounding box of an <code>sf</code> is a rectangle represented by the minimum and maximum of <code>x</code> and <code>y</code> that encompass/contain all the spatial objects in the <code>sf</code>. You can use <code>st_bbox()</code> to find the bounding box of an <code>sf</code> object. Let’s get the bounding box of irrigation wells in Kansas (<code>KS_wells</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the bounding box of KS_wells ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">bbox_KS_wells</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span>  </span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     xmin      ymin      xmax      ymax 
 230332.0 4095052.5  887329.7 4433596.9 </code></pre>
</div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- check the class ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">bbox_KS_wells</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "bbox"</code></pre>
</div>
</div>
<p>As you can see, <code><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">sf::st_bbox()</a></code> returns an object of class <code>bbox</code>. You cannot directly create a map using a <code>bbox</code>. So, let’s convert it to an <code>sfc</code> using <code><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">sf::st_as_sfc()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells_bbox_sfc</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="va">bbox_KS_wells</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-bbox-fig" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> shows the bounding box (red rectangle).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">KS_wells_bbox_sfc</span>, </span>
<span>    fill <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1.2</span></span>
<span>   <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">KS_wells</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">0.4</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-bbox-fig" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-bbox-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-bbox-fig-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bbox-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.7: The bounding box of the irrigation wells in Kansas that overlie HPA
</figcaption></figure>
</div>
</div>
</div>
</section><section id="spatial-cropping-1" class="level3 page-columns page-full" data-number="3.2.3"><h3 data-number="3.2.3" class="anchored" data-anchor-id="spatial-cropping-1">
<span class="header-section-number">3.2.3</span> Spatial cropping</h3>
<p>Let’s now crop High-Plains aquifer boundary (<code>hpa</code>) to the bounding box of Kansas wells (<a href="#fig-hpa" class="quarto-xref">Figure&nbsp;<span>3.8</span></a>).</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_bbox_sfc</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-hpa" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-hpa-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.8: HPA and irrigation wells in Kansas
</figcaption></figure>
</div>
</div>
</div>
</div></div><div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hpa_cropped_to_KS</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">hpa</span>, <span class="va">KS_wells</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what the cropped version of <code>hpa</code> looks like (<a href="#fig-cropped-hpa" class="quarto-xref">Figure&nbsp;<span>3.9</span></a>):</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_bbox_sfc</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cropped-hpa" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cropped-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-cropped-hpa-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cropped-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.9: The bounding box of the irrigation wells in Kansas that overlie HPA
</figcaption></figure>
</div>
</div>
</div>
<p>As you can see, the <code>st_crop()</code> operation cut the parts of <code>hpa</code> that are not intersecting with the bounding box of <code>KS_wells</code>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please note that we did not explicilty crop <code>hpa</code> to the bouding box of <code>KS_wells</code> (<code>bbox_KS_wells</code>) above. That is, we just run <code>hpa_cropped_to_KS &lt;- sf::st_crop(hpa, KS_wells)</code> instead of <code>hpa_cropped_to_KS &lt;- sf::st_crop(hpa, bbox_KS_wells)</code>. When <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">sf::st_crop()</a></code> is used, it automatically finds the bounding box of the <code>sf</code> as second argument and implements cropping.</p>
</div>
</div>
</section></section><section id="spatial-subsetting" class="level2 page-columns page-full" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="spatial-subsetting">
<span class="header-section-number">3.3</span> Spatial subsetting</h2>
<p>Spatial subsetting refers to operations that narrow down the geographic scope of a spatial object (source data) based on another spatial object (target data). We illustrate spatial subsetting using Kansas county borders (<code>KS_counties</code>), the boundary of the Kansas portion of the High-Plains Aquifer (<code>hpa_cropped_to_KS</code>), and agricultural irrigation wells in Kansas (<code>KS_wells</code>).</p>
<section id="polygons-source-vs-polygons-target" class="level3 page-columns page-full" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="polygons-source-vs-polygons-target">
<span class="header-section-number">3.3.1</span> polygons (source) vs polygons (target)</h3>
<p><a href="#fig-overlap-KS-county-HPA" class="quarto-xref">Figure&nbsp;<span>3.10</span></a> shows the Kansas portion of the HPA and Kansas counties.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-overlap-KS-county-HPA" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-overlap-KS-county-HPA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-overlap-KS-county-HPA-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-overlap-KS-county-HPA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.10: Kansas portion of High-Plains Aquifer and Kansas counties
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>The goal is to select only the counties that intersect with the HPA boundary. Spatial subsetting of <code>sf</code> objects follows this syntax:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- this does not run ---#</span></span>
<span><span class="va">sf_1</span><span class="op">[</span><span class="va">sf_2</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where you are subsetting <code>sf_1</code> based on <code>sf_2</code>. Instead of row numbers, you provide another sf object in place. The following code spatially subsets Kansas counties based on the HPA boundary.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">counties_intersecting_hpa</span> <span class="op">&lt;-</span> <span class="va">KS_counties</span><span class="op">[</span><span class="va">hpa_cropped_to_KS</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-default-subset" class="quarto-xref">Figure&nbsp;<span>3.11</span></a> presents counties in <code>counties_intersecting_hpa</code> and the cropped HPA boundary.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- add US counties layer ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">counties_intersecting_hpa</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- add High-Plains Aquifer layer ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-default-subset" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-default-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-default-subset-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-default-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.11: The results of spatially subsetting Kansas counties based on HPA boundary
</figcaption></figure>
</div>
</div>
</div>
<p>You can see that only the counties intersecting with the HPA boundary remain. This is because, when using the syntax <code>sf_1[sf_2, ]</code>, the default topological relation is <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>. If objects in <code>sf_1</code> intersect with any of the objects in <code>sf_2</code>, even slightly, they will remain after subsetting.</p>
<p>Sometimes, instead of removing non-intersecting observations, you may just want to flag whether two spatial objects intersect. To do this, you can first retrieve the IDs of the intersecting counties from <code>counties_intersecting_hpa</code> and then create a variable in the original dataset (<code>KS_counties</code>) that indicates whether an intersection occurs.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- check the intersections of HPA and counties  ---#</span></span>
<span><span class="va">intersecting_counties_list</span> <span class="op">&lt;-</span> <span class="va">counties_intersecting_hpa</span><span class="op">$</span><span class="va">COUNTYFP</span></span>
<span></span>
<span><span class="co">#--- assign true/false ---#</span></span>
<span><span class="va">KS_counties</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">KS_counties</span>, intersects_hpa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">COUNTYFP</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">intersecting_counties_list</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">KS_counties</span>, <span class="va">COUNTYFP</span>, <span class="va">intersects_hpa</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
   COUNTYFP intersects_hpa                       geometry
1       133          FALSE MULTIPOLYGON (((806203.1 41...
2       075           TRUE MULTIPOLYGON (((233615.1 42...
3       123          FALSE MULTIPOLYGON (((544031.7 43...
4       189           TRUE MULTIPOLYGON (((273665.9 41...
5       155           TRUE MULTIPOLYGON (((546178.6 42...
6       129           TRUE MULTIPOLYGON (((229431.1 41...
7       073          FALSE MULTIPOLYGON (((717254.1 42...
8       023           TRUE MULTIPOLYGON (((239494.1 44...
9       089           TRUE MULTIPOLYGON (((542298.2 44...
10      059          FALSE MULTIPOLYGON (((804792.9 42...</code></pre>
</div>
</div>
<hr>
<p><strong>Other topological relations</strong></p>
<p>As mentioned above, the default topological relation used in <code>sf_1[sf_2, ]</code> is <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>. However, you can specify other topological relations using the following syntax:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- this does not run ---#</span></span>
<span><span class="va">sf_1</span><span class="op">[</span><span class="va">sf_2</span>, op <span class="op">=</span> <span class="va">topological_relation_type</span><span class="op">]</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, if you only want counties that are completely within the HPA boundary, you can use the following approach:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">counties_within_hpa</span> <span class="op">&lt;-</span> <span class="va">KS_counties</span><span class="op">[</span><span class="va">hpa_cropped_to_KS</span>, op <span class="op">=</span> <span class="va">st_within</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-within-subset" class="quarto-xref">Figure&nbsp;<span>3.12</span></a> shows the resulting set of counties.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">counties_within_hpa</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-within-subset" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-within-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-within-subset-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-within-subset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.12: Kansas counties that are completely within the HPA boundary
</figcaption></figure>
</div>
</div>
</div>
<!-- 
#%%%%%%%%%%%%%%%%%%%%%
# Points vs Polygons 
#%%%%%%%%%%%%%%%%%%%%%
-->
</section><section id="points-source-vs-polygons-target" class="level3" data-number="3.3.2"><h3 data-number="3.3.2" class="anchored" data-anchor-id="points-source-vs-polygons-target">
<span class="header-section-number">3.3.2</span> points (source) vs polygons (target)</h3>
<p>The following map (<a href="#fig-map-wells-county" class="quarto-xref">Figure&nbsp;<span>3.13</span></a>) shows the Kansas portion of the HPA and all the irrigation wells in Kansas. We can select only wells that reside within the HPA boundary using the same syntax as the above example.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells</span>, size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-wells-county" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-wells-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-wells-county-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-wells-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.13: A map of Kansas irrigation wells and HPA
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells_in_hpa</span> <span class="op">&lt;-</span> <span class="va">KS_wells</span><span class="op">[</span><span class="va">hpa_cropped_to_KS</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see in <a href="#fig-map-wells-in-hpa" class="quarto-xref">Figure&nbsp;<span>3.14</span></a> below, only the wells that are inside (or intersect with) the HPA remained because the default topological relation is <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">hpa_cropped_to_KS</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_in_hpa</span>, size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-wells-in-hpa" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-wells-in-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-wells-in-hpa-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-wells-in-hpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.14: A map of Kansas irrigation wells and HPA
</figcaption></figure>
</div>
</div>
</div>
<p>If you want to flag wells that intersect with HPA, use the following approach:</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">site_list</span> <span class="op">&lt;-</span> <span class="va">KS_wells_in_hpa</span><span class="op">$</span><span class="va">site</span></span>
<span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">KS_wells</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">KS_wells</span>, in_hpa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">site_list</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37647 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 230332 ymin: 4095052 xmax: 887329.7 ymax: 4433597
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
   site    af_used                 geometry in_hpa
1     1 232.099948   POINT (372548 4153588)   TRUE
2     3  13.183940 POINT (353698.6 4419755)   TRUE
3     5  99.187052 POINT (486771.7 4260027)   TRUE
4     7   0.000000 POINT (248127.1 4296442)   TRUE
5     8 145.520499 POINT (349813.2 4215310)   TRUE
6     9   3.614535 POINT (612277.6 4322077)  FALSE
7    11 188.423543 POINT (267030.7 4381364)   TRUE
8    12  77.335960 POINT (761774.6 4339039)  FALSE
9    15   0.000000 POINT (560570.3 4235763)   TRUE
10   17 167.819034 POINT (387315.1 4175007)   TRUE</code></pre>
</div>
</div>
<!-- 
#%%%%%%%%%%%%%%%%%%%%%
# Lines vs Polygons 
#%%%%%%%%%%%%%%%%%%%%%
-->
</section><section id="sec-lines_polygons" class="level3 page-columns page-full" data-number="3.3.3"><h3 data-number="3.3.3" class="anchored" data-anchor-id="sec-lines_polygons">
<span class="header-section-number">3.3.3</span> lines (source) vs polygons (target)</h3>
<p><a href="#fig-map-lines-county" class="quarto-xref">Figure&nbsp;<span>3.15</span></a> shows the Kansas counties (in red) and U.S. railroads in the Mid West region(in blue).</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">rail_roads_mw</span>, color <span class="op">=</span> <span class="st">"blue"</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-lines-county" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-lines-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-lines-county-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-lines-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.15: U.S. railroads and Kansas county boundaries
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>We can select only the railroads that intersect with Kansas.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">railroads_KS</span> <span class="op">&lt;-</span> <span class="va">rail_roads_mw</span><span class="op">[</span><span class="va">KS_counties</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see in <a href="#fig-map-rail-ks" class="quarto-xref">Figure&nbsp;<span>3.16</span></a> below, only the railroads that intersect with Kansas were selected. Note the lines that go beyond the Kansas boundary are also selected. Remember, the default is <code>sf::st_intersect()</code>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">railroads_KS</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">KS_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-rail-ks" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-rail-ks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-rail-ks-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-rail-ks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.16: Railroads that intersect Kansas county boundaries
</figcaption></figure>
</div>
</div>
</div>
<p>If you would like the lines beyond the state boundary to be cut out but the intersecting parts of those lines to remain, use <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code>, which is explained in <a href="#sec-st-intersection" class="quarto-xref"><span>Section 3.6.1</span></a>.</p>
<p>If you want to flag railroads that intersect with Kansas counties in <code>railroads</code>, use the following approach:</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the list of lines ---#</span></span>
<span><span class="va">lines_list</span> <span class="op">&lt;-</span> <span class="va">railroads_KS</span><span class="op">$</span><span class="va">LINEARID</span></span>
<span></span>
<span><span class="co">#--- railroads ---#</span></span>
<span><span class="va">rail_roads_mw</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">rail_roads_mw</span>, intersect_ks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">LINEARID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">lines_list</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">rail_roads_mw</span>, <span class="va">LINEARID</span>, <span class="va">intersect_ks</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 100661 features and 2 fields
Geometry type: MULTILINESTRING
Dimension:     XY
Bounding box:  xmin: -414024 ymin: 3692172 xmax: 2094886 ymax: 5446589
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
      LINEARID intersect_ks                       geometry
1  11050905483        FALSE MULTILINESTRING ((1250147 3...
2  11050905484        FALSE MULTILINESTRING ((1250147 3...
3  11050905485        FALSE MULTILINESTRING ((1250429 3...
4  11050905486        FALSE MULTILINESTRING ((1248249 3...
5  11050905487        FALSE MULTILINESTRING ((1248249 3...
6  11050905488        FALSE MULTILINESTRING ((1249095 3...
7  11050905489        FALSE MULTILINESTRING ((1250429 3...
8  11050905490        FALSE MULTILINESTRING ((1250383 3...
9  11050905492        FALSE MULTILINESTRING ((1250329 3...
10 11050905494        FALSE MULTILINESTRING ((1250033 3...</code></pre>
</div>
</div>
</section><section id="sec-polygons_points" class="level3 page-columns page-full" data-number="3.3.4"><h3 data-number="3.3.4" class="anchored" data-anchor-id="sec-polygons_points">
<span class="header-section-number">3.3.4</span> polygons (source) vs points (target)</h3>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_in_hpa</span>, fill <span class="op">=</span> <span class="cn">NA</span>, size <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-county-point" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-county-point-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-county-point-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-county-point-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.17: Kansas county boundaries and wells that overlie the HPA
</figcaption></figure>
</div>
</div>
</div>
</div></div><p><a href="#fig-map-county-point" class="quarto-xref">Figure&nbsp;<span>3.17</span></a> shows the Kansas counties and irrigation wells in Kansas that overlie HPA. We can select only the counties that intersect with at least one well.</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_counties_intersected</span> <span class="op">&lt;-</span> <span class="va">KS_counties</span><span class="op">[</span><span class="va">KS_wells_in_hpa</span>, <span class="op">]</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see in <a href="#fig-subset-county-point" class="quarto-xref">Figure&nbsp;<span>3.18</span></a> below, only the counties that intersect with at least one well remained.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties_intersected</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_in_hpa</span>, fill <span class="op">=</span> <span class="cn">NA</span>, size <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-subset-county-point" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-subset-county-point-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-subset-county-point-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-subset-county-point-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.18: Counties that have at least one well
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="sec-sp-join" class="level2 page-columns page-full" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="sec-sp-join">
<span class="header-section-number">3.4</span> Spatial join</h2>
<p>A spatial join refers to spatial operations that involve the following steps:</p>
<ul>
<li>Overlay one spatial layer (target layer) onto another (source layer).</li>
<li>For each observation in the target layer:</li>
<li>Identify which objects in the source layer it geographically intersects with (or has another specified topological relationship).</li>
<li>Extract values associated with the intersecting objects in the source layer, summarizing if necessary.</li>
<li>Assign the extracted values to the corresponding objects in the target layer.</li>
</ul>
<p>We can classify spatial join into four categories by the type of the underlying spatial objects:</p>
<ul>
<li>
<strong>vector-vector</strong>: vector data (target) against vector data (source)</li>
<li>
<strong>vector-raster</strong>: vector data (target) against raster data (source)</li>
<li>
<strong>raster-vector</strong>: raster data (target) against vector data (source)</li>
<li>
<strong>raster-raster</strong>: raster data (target) against raster data (source)</li>
</ul>
<p>Among these four types, our focus here is on the first case, <strong>vector-vector</strong>. The second case will be discussed in <a href="05-SpatialInteractionVectorRaster.html" class="quarto-xref"><span>Chapter 5</span></a>. The third and fourth cases are not covered in this book, as the target data is almost always vector data (e.g., cities or farm fields as points, political boundaries as polygons, etc.).</p>
<p>The <strong>vector-vector</strong> category can be further divided into subcategories depending on the type of spatial object: point, line, or polygon. In this context, we will exclude spatial joins involving lines. This is because line objects are rarely used as observation units in subsequent analyses or as the source data for extracting values.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;For example, in <a href="01-Demonstration.html#sec-demo-railroad" class="quarto-xref"><span>Section 1.4</span></a>, we did not extract any attribute values from the railroads. Instead, we calculated the travel length of the railroads, meaning the geometry of the railroads was of interest rather than the values associated with them.</p></div></div><p>Below is a list of the types of spatial joins we will cover:</p>
<ol type="1">
<li>points (target) against polygons (source)</li>
<li>polygons (target) against points (source)</li>
<li>polygons (target) against polygons (source)</li>
</ol>
<!-- 
#=========================================
# Spatial Joining 
#=========================================
--><section id="syntax" class="level3" data-number="3.4.1"><h3 data-number="3.4.1" class="anchored" data-anchor-id="syntax">
<span class="header-section-number">3.4.1</span> Syntax</h3>
<p>To perform spatial join, we can use the <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> function, with the following syntax:</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- this does not run ---#</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">target_sf</span>, <span class="va">source_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similar to spatial subsetting, the default topological relation is <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>.</p>
</section><section id="case-1-points-target-vs-polygons-source" class="level3 page-columns page-full" data-number="3.4.2"><h3 data-number="3.4.2" class="anchored" data-anchor-id="case-1-points-target-vs-polygons-source">
<span class="header-section-number">3.4.2</span> Case 1: points (target) vs polygons (source)</h3>
<p>In this case, for each observation (point) in the target data, it identifies which polygon in the source data it intersects with and then assigns the value associated with the polygon to the point.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;A practical example of this case is shown in Demonstration 1 of <a href="01-Demonstration.html" class="quarto-xref"><span>Chapter 1</span></a>.</p></div></div><p>We use the Kansas irrigation well data (points) and Kansas county boundary data (polygons) for a demonstration. Our goal is to assign the county-level corn price information from the Kansas county data to wells. First let me create and add a fake county-level corn price variable to the Kansas county data.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_corn_price</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">KS_counties</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>corn_price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">3.2</span>, <span class="fl">3.9</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">COUNTYFP</span>, <span class="va">corn_price</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-map-corn-price" class="quarto-xref">Figure&nbsp;<span>3.19</span></a> presents Kansas counties color-differentiated by the fake corn price.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">KS_corn_price</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">corn_price</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-corn-price" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-corn-price-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-corn-price-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-corn-price-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.19: Map of county-level fake corn price
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>For this particular context, the following code will do the job:</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- spatial join ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">KS_wells_County</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">KS_wells</span>, <span class="va">KS_corn_price</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37647 features and 5 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 230332 ymin: 4095052 xmax: 887329.7 ymax: 4433597
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
   site    af_used in_hpa COUNTYFP corn_price                 geometry
1     1 232.099948   TRUE      069   3.556731   POINT (372548 4153588)
2     3  13.183940   TRUE      039   3.449038 POINT (353698.6 4419755)
3     5  99.187052   TRUE      165   3.287500 POINT (486771.7 4260027)
4     7   0.000000   TRUE      199   3.644231 POINT (248127.1 4296442)
5     8 145.520499   TRUE      055   3.832692 POINT (349813.2 4215310)
6     9   3.614535  FALSE      143   3.799038 POINT (612277.6 4322077)
7    11 188.423543   TRUE      181   3.590385 POINT (267030.7 4381364)
8    12  77.335960  FALSE      177   3.550000 POINT (761774.6 4339039)
9    15   0.000000   TRUE      159   3.610577 POINT (560570.3 4235763)
10   17 167.819034   TRUE      069   3.556731 POINT (387315.1 4175007)</code></pre>
</div>
</div>
<p>You can see from <a href="#fig-map-corn-wells" class="quarto-xref">Figure&nbsp;<span>3.20</span></a> that all the wells inside the same county have the same corn price value.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">

</div></div><div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells_County</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">corn_price</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-corn-wells" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-corn-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-corn-wells-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-corn-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.20: Map of wells color-differentiated by corn price
</figcaption></figure>
</div>
</div>
</div>
<p>We can also confirm that the <code>corn_price</code> value associated with all the wells in a single county is identical with the <code>corn_price</code> value associated with that county in the original corn price data (<code>KS_corn_price</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_wells_County</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">COUNTYFP</span> <span class="op">==</span> <span class="st">"069"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">corn_price</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.556731</code></pre>
</div>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_corn_price</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">COUNTYFP</span> <span class="op">==</span> <span class="st">"069"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">corn_price</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.556731</code></pre>
</div>
</div>
</section><section id="sec-polygons-points" class="level3 page-columns page-full" data-number="3.4.3"><h3 data-number="3.4.3" class="anchored" data-anchor-id="sec-polygons-points">
<span class="header-section-number">3.4.3</span> Case 2: polygons (target) vs points (source)</h3>
<p>In this case, for each observation (polygon) in the target data, it identifies which observations (points) in the source data intersect with it, and then assigns the values associated with those points to the polygon (A practical example of this case is shown in Demonstration 2 of <a href="01-Demonstration.html" class="quarto-xref"><span>Chapter 1</span></a>.).</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_wells</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">af_used</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Groundwater Pumping (acre-feet)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-wells-county-gw" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wells-county-gw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-wells-county-gw-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wells-county-gw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.21: Map of wells color-differentiated by corn price
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>For instance, if you are conducting a county-level analysis and want to calculate the total groundwater pumping for each county, the target data would be <code>KS_counties</code>, and the source data would be <code>KS_wells</code> (<a href="#fig-wells-county-gw" class="quarto-xref">Figure&nbsp;<span>3.21</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- spatial join ---#</span></span>
<span><span class="va">KS_County_wells</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">KS_counties</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">KS_County_wells</span>, <span class="va">COUNTYFP</span>, <span class="va">site</span>, <span class="va">af_used</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37652 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
    COUNTYFP  site   af_used                       geometry
1        133 53861  17.01790 MULTIPOLYGON (((806203.1 41...
1.1      133 70592   0.00000 MULTIPOLYGON (((806203.1 41...
2        075   328 394.04513 MULTIPOLYGON (((233615.1 42...
2.1      075   336  80.65036 MULTIPOLYGON (((233615.1 42...
2.2      075   436 568.25359 MULTIPOLYGON (((233615.1 42...
2.3      075  1007 215.80416 MULTIPOLYGON (((233615.1 42...
2.4      075  1170   0.00000 MULTIPOLYGON (((233615.1 42...
2.5      075  1192  77.39120 MULTIPOLYGON (((233615.1 42...
2.6      075  1249   0.00000 MULTIPOLYGON (((233615.1 42...
2.7      075  1300 320.22612 MULTIPOLYGON (((233615.1 42...</code></pre>
</div>
</div>
<p>As seen in the resulting dataset, each unique polygon-point intersection forms an observation. For each polygon, there will be as many observations as there are wells intersecting with that polygon. After joining the two layers, you can calculate statistics for each polygon (in this case, each county). Since the goal is to calculate groundwater extraction by county, the following code will accomplish this:</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_County_wells</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">COUNTYFP</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>af_used <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">af_used</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
# A tibble: 105 × 3
   COUNTYFP af_used                                                     geometry
   &lt;fct&gt;      &lt;dbl&gt;                                           &lt;MULTIPOLYGON [m]&gt;
 1 001           0  (((806387 4191583, 805512 4215779, 844240.9 4217265, 845100…
 2 003           0  (((804971.3 4254894, 843634.8 4256415, 844240.9 4217265, 80…
 3 005         771. (((794798 4394875, 814054.6 4395649, 833328.7 4396412, 8396…
 4 007        4972. (((498886 4147060, 547336.9 4147260, 547367.8 4137622, 5575…
 5 009       61083. (((497132.8 4283127, 544688.2 4283265, 545236.6 4281565, 54…
 6 011           0  (((844767.7 4183342, 845100.4 4193068, 844240.9 4217265, 88…
 7 013         480. (((774189.2 4432752, 774491.2 4432762, 812462.5 4434180, 81…
 8 015         343. (((662406.7 4197742, 661982.8 4217157, 689364.6 4217517, 71…
 9 017           0  (((688956.3 4246711, 690085.5 4266038, 730694.2 4267016, 73…
10 019           0  (((719369.2 4131329, 769067.5 4132390, 770145.1 4099095, 76…
# ℹ 95 more rows</code></pre>
</div>
</div>
<p>It is just as easy to get other types of statistics by simply modifying the <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code> part.</p>
</section><section id="sec-polygon-polygon" class="level3 page-columns page-full" data-number="3.4.4"><h3 data-number="3.4.4" class="anchored" data-anchor-id="sec-polygon-polygon">
<span class="header-section-number">3.4.4</span> Case 3: polygons (target) vs polygons (source)</h3>
<p>In this case, <code>sf::st_join(target_sf, source_sf)</code> returns all the unique polygon-polygon intersections, with the attributes from <code>source_sf</code> attached to the intersecting polygons.</p>
<p>We will use county-level corn acres data in Iowa for 2018 from USDA NASS<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> and Hydrologic Units. Our objective is to estimate corn acres by HUC units based on county-level corn acres data.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;See <a href="08-DownloadSpatialData.html#sec-nass-quick" class="quarto-xref"><span>Section 8.1</span></a> for instructions on downloading Quick Stats data from within R.</p></div><div id="fn7"><p><sup>7</sup>&nbsp;There will be substantial measurement errors because the source polygons (corn acres by county) are large compared to the target polygons (HUC units). However, this serves as a useful illustration of a polygon-polygon join.</p></div></div><p>We first import the Iowa corn acre data (<a href="#fig-map-IA-corn" class="quarto-xref">Figure&nbsp;<span>3.22</span></a> is the map of Iowa counties color-differentiated by corn acres):</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- IA boundary ---#</span></span>
<span><span class="va">IA_corn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/IA_corn.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="va">IA_corn</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 93 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 203228.6 ymin: 4470941 xmax: 736832.9 ymax: 4822687
Projected CRS: NAD83 / UTM zone 15N
First 10 features:
   county_code year  acres                       geometry
1          083 2018 183500 MULTIPOLYGON (((458997 4711...
2          141 2018 167000 MULTIPOLYGON (((267700.8 47...
3          081 2018 184500 MULTIPOLYGON (((421231.2 47...
4          019 2018 189500 MULTIPOLYGON (((575285.6 47...
5          023 2018 165500 MULTIPOLYGON (((497947.5 47...
6          195 2018 111500 MULTIPOLYGON (((459791.6 48...
7          063 2018 110500 MULTIPOLYGON (((345214.3 48...
8          027 2018 183000 MULTIPOLYGON (((327408.5 46...
9          121 2018  70000 MULTIPOLYGON (((396378.1 45...
10         077 2018 107000 MULTIPOLYGON (((355180.1 46...</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">IA_corn</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">acres</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-map-IA-corn" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-IA-corn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-map-IA-corn-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-IA-corn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.22: Map of Iowa counties color-differentiated by corn planted acreage
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Now import the HUC units data (<a href="#fig-HUC-map" class="quarto-xref">Figure&nbsp;<span>3.23</span></a> presents the map of HUC units):</p>
<div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- import HUC units ---#</span></span>
<span><span class="va">HUC_IA</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/huc250k.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">HUC_CODE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- reproject to the CRS of IA ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">IA_corn</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- select HUC units that overlaps with IA ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="va">IA_corn</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">HUC_IA</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-HUC-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-HUC-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-HUC-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-HUC-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.23: Map of HUC units that intersect with Iowa state boundary
</figcaption></figure>
</div>
</div>
</div>
</div></div><p><a href="#fig-HUC-county-map" class="quarto-xref">Figure&nbsp;<span>3.24</span></a> presents a map of Iowa counties superimposed on the HUC units:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">HUC_IA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">IA_corn</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">acres</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-HUC-county-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-HUC-county-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-HUC-county-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-HUC-county-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.24: Map of HUC units superimposed on the counties in Iowas
</figcaption></figure>
</div>
</div>
</div>
<p>Spatial join using <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> will produce the following:</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">HUC_joined</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">HUC_IA</span>, <span class="va">IA_corn</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 349 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 154941.7 ymin: 4346327 xmax: 773299.8 ymax: 4907735
Projected CRS: NAD83 / UTM zone 15N
First 10 features:
      HUC_CODE county_code year  acres                       geometry
608   10170203         149 2018 226500 POLYGON ((235551.4 4907513,...
608.1 10170203         167 2018 249000 POLYGON ((235551.4 4907513,...
608.2 10170203         193 2018 201000 POLYGON ((235551.4 4907513,...
608.3 10170203         119 2018 184500 POLYGON ((235551.4 4907513,...
621   07020009         063 2018 110500 POLYGON ((408580.7 4880798,...
621.1 07020009         109 2018 304000 POLYGON ((408580.7 4880798,...
621.2 07020009         189 2018 120000 POLYGON ((408580.7 4880798,...
627   10170204         141 2018 167000 POLYGON ((248115.2 4891652,...
627.1 10170204         143 2018 116000 POLYGON ((248115.2 4891652,...
627.2 10170204         167 2018 249000 POLYGON ((248115.2 4891652,...</code></pre>
</div>
</div>
<p>Each intersecting HUC-county combination becomes a separate observation, with the resulting geometry being the same as that of the HUC unit. To illustrate this, let’s take a closer look at one of the HUC units. The HUC unit with <code>HUC_CODE ==10170203</code> intersects with four County.</p>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the HUC unit with `HUC_CODE ==10170203`  ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">temp_HUC_county</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">HUC_joined</span>, <span class="va">HUC_CODE</span> <span class="op">==</span> <span class="fl">10170203</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 4 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 154941.7 ymin: 4709628 xmax: 248115.2 ymax: 4907735
Projected CRS: NAD83 / UTM zone 15N
      HUC_CODE county_code year  acres                       geometry
608   10170203         149 2018 226500 POLYGON ((235551.4 4907513,...
608.1 10170203         167 2018 249000 POLYGON ((235551.4 4907513,...
608.2 10170203         193 2018 201000 POLYGON ((235551.4 4907513,...
608.3 10170203         119 2018 184500 POLYGON ((235551.4 4907513,...</code></pre>
</div>
</div>
<p>All of the four observations in <code>temp_HUC_county</code> has the identical geometry (<a href="#fig-identical-geometry" class="quarto-xref">Figure&nbsp;<span>3.25</span></a> shows this visually.).</p>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">temp_HUC_county</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">temp_HUC_county</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>county_text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"County Code: "</span>, <span class="va">county_code</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="va">county_text</span> <span class="op">~</span> <span class="va">.</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-identical-geometry" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-identical-geometry-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-identical-geometry-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-identical-geometry-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.25: Geoemetry of the four observations in the joined object
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Moreover, they are identical with the geometry of the intersecting HUC unit (the HUC unit with <code>HUC_CODE ==10170203</code>):</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span></span>
<span>  <span class="co">#--- geometry of the one of the observations from the joined object ---#</span></span>
<span>  <span class="va">temp_HUC_county</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">$</span><span class="va">geometry</span>,</span>
<span>  <span class="co">#--- original HUC geometry ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">HUC_IA</span>, <span class="va">HUC_CODE</span> <span class="op">==</span> <span class="fl">10170203</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">pull</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>So, all four observations have identical geometry, which corresponds to the geometry of the HUC unit. This indicates that <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> does not retain information about the extent of the intersection between the HUC unit and the four counties. Keep in mind that the default behavior uses <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code>, which only checks whether the spatial objects intersect, without providing further details.</p>
<p>If you are calculating a simple average of corn acres and are not concerned with the degree of spatial overlap, this method works just fine. However, if you want to compute an area-weighted average, the information provided is insufficient. You will learn how to calculate the area-weighted average in the next subsection.</p>
</section></section><section id="spatial-join-and-summary-in-one-step" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="spatial-join-and-summary-in-one-step">
<span class="header-section-number">3.5</span> Spatial join and summary in one step</h2>
<p>In <a href="#sec-polygons-points" class="quarto-xref"><span>Section 3.4.3</span></a>, we first joined <code>KS_counties</code> and <code>KS_wells</code> uusing <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> and then applied <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code> to find total groundwater use per county. This two-step procedure can be done in one step using <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> with the summarizing function specified for the <code>FUN</code> option.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(source layer, target layer, <span class="at">FUN =</span> <span class="cf">function</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we are trying to find total groundwater use for each county, the target layer is <code>KS_counties</code>, the source layer is <code>KS_wells</code>, which has <code>af_used</code>, and the function to summarize is <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code>. So, the following code will replicate what we just did above:</p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- sum ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">KS_wells</span>, <span class="va">KS_counties</span>, FUN <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
       site      af_used in_hpa                       geometry
1    124453 1.701790e+01      0 MULTIPOLYGON (((806203.1 41...
2  12514550 6.261704e+04    159 MULTIPOLYGON (((233615.1 42...
3   1964254 1.737791e+03      0 MULTIPOLYGON (((544031.7 43...
4  42442400 3.023589e+05   1056 MULTIPOLYGON (((273665.9 41...
5  68068173 6.110576e+04   1294 MULTIPOLYGON (((546178.6 42...
6  15756801 9.664610e+04    477 MULTIPOLYGON (((229431.1 41...
7    149202 0.000000e+00      0 MULTIPOLYGON (((717254.1 42...
8  17167377 5.750807e+04    592 MULTIPOLYGON (((239494.1 44...
9   1809003 2.201696e+03     15 MULTIPOLYGON (((542298.2 44...
10   160064 4.571102e+00      0 MULTIPOLYGON (((804792.9 42...</code></pre>
</div>
</div>
<p>Notice that the <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> function was applied to all the columns in <code>KS_wells</code>, including site id number. So, you might want to select variables you want to join before you apply the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> function like this:</p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">KS_wells</span>, <span class="va">af_used</span><span class="op">)</span>, <span class="va">KS_counties</span>, FUN <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 1 field
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229253.5 ymin: 4094801 xmax: 890007.5 ymax: 4434288
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
        af_used                       geometry
1  1.701790e+01 MULTIPOLYGON (((806203.1 41...
2  6.261704e+04 MULTIPOLYGON (((233615.1 42...
3  1.737791e+03 MULTIPOLYGON (((544031.7 43...
4  3.023589e+05 MULTIPOLYGON (((273665.9 41...
5  6.110576e+04 MULTIPOLYGON (((546178.6 42...
6  9.664610e+04 MULTIPOLYGON (((229431.1 41...
7  0.000000e+00 MULTIPOLYGON (((717254.1 42...
8  5.750807e+04 MULTIPOLYGON (((239494.1 44...
9  2.201696e+03 MULTIPOLYGON (((542298.2 44...
10 4.571102e+00 MULTIPOLYGON (((804792.9 42...</code></pre>
</div>
</div>
</section><section id="spatial-intersection-cropping-join" class="level2 page-columns page-full" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="spatial-intersection-cropping-join">
<span class="header-section-number">3.6</span> Spatial intersection (cropping join)</h2>
<p>Sometimes, you may need to crop spatial objects by polygon boundaries. For instance, in the demonstration in <a href="01-Demonstration.html#sec-demo-railroad" class="quarto-xref"><span>Section 1.4</span></a>, we calculated the total length of railroads within each county by trimming the parts of the railroads that extended beyond county boundaries. Similarly, we cannot find area-weighted averages using <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> alone because it does not provide information about how much of each HUC unit intersects with a county. However, if we can obtain the geometry of the intersecting portions of the HUC unit and the county, we can calculate their areas, allowing us to compute area-weighted averages of the joined attributes.</p>
<p>For these purposes, we can use <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code>. Below, we illustrate how <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> works for line-polygon and polygon-polygon intersections (using data generated in <a href="#sec-topo" class="quarto-xref"><span>Section 3.1</span></a>). Intersections involving points with <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> are equivalent to using <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> since points have neither length nor area (nothing to crop). Therefore, they are not discussed here.</p>
<section id="sec-st-intersection" class="level3 page-columns page-full" data-number="3.6.1"><h3 data-number="3.6.1" class="anchored" data-anchor-id="sec-st-intersection">
<span class="header-section-number">3.6.1</span> <code>sf::st_intersection()</code>
</h3>
<p>While <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> returns the indices of intersecting objects, <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> returns the actual intersecting spatial objects, with the non-intersecting parts of the sf objects removed. Additionally, the attribute values from the source sf are merged with the intersecting geometries (<code>sfg</code>) in the target <code>sf</code>.</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Polygons"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">line_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Lines"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-plot-lines-polygons" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-plot-lines-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-plot-lines-polygons-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot-lines-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.26: Visualization of the points, lines, and polygons
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>We will now explore how this works for both line-polygon and polygon-polygon intersections, using the same toy examples we used to demonstrate how <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_intersects()</a></code> functions (<a href="#fig-plot-lines-polygons" class="quarto-xref">Figure&nbsp;<span>3.26</span></a> shows the lines and polygons).</p>
<hr>
<p><strong>lines and polygons</strong></p>
<p>The following code finds the intersection of the lines and the polygons.</p>
<div class="cell">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">intersections_lp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">lines</span>, <span class="va">polygons</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>int_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">line_name</span>, <span class="st">"-"</span>, <span class="va">polygon_name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 3 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 0 ymin: 0 xmax: 2.5 ymax: 2
CRS:           NA
    line_name polygon_name                              x         int_name
1      line 1    polygon 1        LINESTRING (0 0, 2 0.4) line 1-polygon 1
2      line 2    polygon 1   LINESTRING (1.5 0.5, 2 1.25) line 2-polygon 1
2.1    line 2    polygon 2 LINESTRING (2.166667 1.5, 2... line 2-polygon 2</code></pre>
</div>
</div>
<p>As shown in the output, each intersection between the lines and polygons becomes an observation (e.g., line 1-polygon 1, line 2-polygon 1, and line 2-polygon 2). Any part of the lines that does not intersect with a polygon is removed and does not appear in the returned sf object. To confirm this, see <a href="#fig-lines-polygons-int" class="quarto-xref">Figure&nbsp;<span>3.27</span></a> below:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- here are all the original polygons  ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- here is what is returned after st_intersection ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">intersections_lp</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">int_name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-lines-polygons-int" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lines-polygons-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-lines-polygons-int-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lines-polygons-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.27: The outcome of the intersections of the lines and polygons
</figcaption></figure>
</div>
</div>
</div>
<p>This approach also allows us to calculate the length of the line segments that are fully contained within the polygons, similar to what we did in <a href="01-Demonstration.html#sec-demo-railroad" class="quarto-xref"><span>Section 1.4</span></a>. Additionally, the attributes (e.g., <code>polygon_name</code>) from the source <code>sf</code> (the polygons) are merged with their intersecting lines. As a result, <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> not only transforms the original geometries but also joins the attributes, which is why I refer to this as a “cropping join.”</p>
<hr>
<p><strong>polygons and polygons</strong></p>
<p>The following code finds the intersection of polygon 1 and polygon 3 with polygon 2.</p>
<div class="cell">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">intersections_pp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">polygons</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, <span class="op">]</span>, <span class="va">polygons</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>int_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">polygon_name</span>, <span class="st">"-"</span>, <span class="va">polygon_name.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 2 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 0.5 ymin: 1.5 xmax: 2.3 ymax: 3.2
CRS:           NA
  polygon_name polygon_name.1                              x
1    polygon 1      polygon 2 POLYGON ((2 2, 2 1.5, 0.5 1...
3    polygon 3      polygon 2 POLYGON ((0.5 3.2, 2.3 3.2,...
             int_name
1 polygon 1-polygon 2
3 polygon 3-polygon 2</code></pre>
</div>
</div>
<p>As shown in <a href="#fig-polygons-polygons-int" class="quarto-xref">Figure&nbsp;<span>3.28</span></a>, each intersection between polygons 1 and 3 with polygon 2 becomes a separate observation (e.g., polygon 1-polygon 2 and polygon 3-polygon 2). Similar to the lines-polygons case, the non-intersecting parts of polygons 1 and 3 are removed and do not appear in the returned sf. Later, we will explore how <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> can be used to calculate area-weighted values from the intersecting polygons with the help of <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">sf::st_area()</a></code>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- here are all the original polygons  ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">polygons</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">polygon_name</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#--- here is what is returned after st_intersection ---#</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">intersections_pp</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">int_name</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-polygons-polygons-int" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-polygons-polygons-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-polygons-polygons-int-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-polygons-polygons-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.28: The outcome of the intersections of polygon 2 and polygons 1 and 3
</figcaption></figure>
</div>
</div>
</div>
</section><section id="area-weighted-average" class="level3" data-number="3.6.2"><h3 data-number="3.6.2" class="anchored" data-anchor-id="area-weighted-average">
<span class="header-section-number">3.6.2</span> Area-weighted average</h3>
<p>Let’s now return to the example of HUC units and county-level corn acres data from <a href="#sec-sp-join" class="quarto-xref"><span>Section 3.4</span></a>. This time, we aim to calculate the area-weighted average of corn acres, rather than just the simple average.</p>
<p>Using <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code>, we can divide each HUC polygon into parts based on the boundaries of the intersecting counties. For each HUC polygon, the intersecting counties are identified, and the polygon is split according to these boundaries.</p>
<div class="cell">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">HUC_intersections</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">HUC_IA</span>, <span class="va">IA_corn</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>huc_county <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">HUC_CODE</span>, <span class="st">"-"</span>, <span class="va">county_code</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 349 features and 5 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 203228.6 ymin: 4470941 xmax: 736832.9 ymax: 4822687
Projected CRS: NAD83 / UTM zone 15N
First 10 features:
      HUC_CODE county_code year  acres                       geometry
732   07080207         083 2018 183500 POLYGON ((482923.9 4711643,...
803   07080205         083 2018 183500 POLYGON ((499725.6 4696873,...
826   07080105         083 2018 183500 POLYGON ((461853.2 4682925,...
627   10170204         141 2018 167000 POLYGON ((269364.9 4793311,...
687   10230003         141 2018 167000 POLYGON ((271504.3 4754685,...
731   10230002         141 2018 167000 POLYGON ((267684.6 4790972,...
683   07100003         081 2018 184500 POLYGON ((435951.2 4789348,...
686   07080203         081 2018 184500 MULTIPOLYGON (((459303.2 47...
732.1 07080207         081 2018 184500 POLYGON ((429573.1 4779788,...
747   07100005         081 2018 184500 POLYGON ((421044.8 4772268,...
        huc_county
732   07080207-083
803   07080205-083
826   07080105-083
627   10170204-141
687   10230003-141
731   10230002-141
683   07100003-081
686   07080203-081
732.1 07080207-081
747   07100005-081</code></pre>
</div>
</div>
<p>The key difference from the <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> example is that each observation in the returned data represents a unique HUC-county intersection. <a href="#fig-inter-ex" class="quarto-xref">Figure&nbsp;<span>3.29</span></a> below shows a map of all the intersections between the HUC unit with <code>HUC_CODE == 10170203</code> and its four intersecting counties.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>      <span class="va">HUC_intersections</span>,</span>
<span>      <span class="va">HUC_CODE</span> <span class="op">==</span> <span class="st">"10170203"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">huc_county</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_d</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-inter-ex" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-inter-ex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03-SpatialInteractionVectorVector_files/figure-html/fig-inter-ex-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-inter-ex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.29: Intersections of a HUC unit and Iowa counties
</figcaption></figure>
</div>
</div>
</div>
<p>Note that the attributes from the county data, such as acres, are joined to the resulting intersections, as seen in the output above. As mentioned earlier, <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> performs a spetial type of join where the resulting observations are the intersections between the target and source <code>sf</code> objects.</p>
<p>To calculate the area-weighted average of corn acres, you can first use <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">sf::st_area()</a></code> to determine the area of each intersection. Then, compute the area-weighted average as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">HUC_aw_acres</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">HUC_intersections</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- get area ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">st_area</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- get area-weight by HUC unit ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">HUC_CODE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="va">area</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">area</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">#--- calculate area-weighted corn acreage by HUC unit ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>aw_acres <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">*</span> <span class="va">acres</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 55 features and 2 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 203228.6 ymin: 4470941 xmax: 736832.9 ymax: 4822687
Projected CRS: NAD83 / UTM zone 15N
# A tibble: 55 × 3
   HUC_CODE aw_acres                                                    geometry
   &lt;chr&gt;       &lt;dbl&gt;                                              &lt;GEOMETRY [m]&gt;
 1 07020009  251185. POLYGON ((421060.3 4797550, 420940.3 4797420, 420860.3 479…
 2 07040008  165000  POLYGON ((602922.4 4817166, 602862.4 4816996, 602772.4 481…
 3 07060001  105234. MULTIPOLYGON (((649333.8 4761761, 648933.7 4761621, 648793…
 4 07060002  140201. MULTIPOLYGON (((593780.7 4816946, 594000.7 4816865, 594380…
 5 07060003  149000  MULTIPOLYGON (((692011.6 4712966, 691981.6 4712956, 691881…
 6 07060004  162123. POLYGON ((652046.5 4718813, 651916.4 4718783, 651786.4 471…
 7 07060005  142428. POLYGON ((734140.4 4642126, 733620.4 4641926, 733520.3 464…
 8 07060006  159635. POLYGON ((673976.9 4651911, 673950.7 4651910, 673887.8 465…
 9 07080101  115572. POLYGON ((666760.8 4558401, 666630.9 4558362, 666510.8 455…
10 07080102  160008. POLYGON ((576151.1 4706650, 575891 4706810, 575741 4706890…
# ℹ 45 more rows</code></pre>
</div>
</div>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tmieno2\.github\.io\/R-as-GIS-for-Economists\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/02-VectorDataBasics.html" class="pagination-link" aria-label="Vector Data Handling with `sf`">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/04-RasterDataBasics.html" class="pagination-link" aria-label="Raster Data Handling">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb108" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="an">webr:</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="co">  # packages: ['dplyr', 'ggplot2', 'sf']</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co">  cell-options:</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="co">    editor-font-scale: 0.7</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="co">    out-width: 100%</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="an">filters:</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - webr</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatial Interactions of Vector Data: Subsetting and Joining {#sec-int-vv}</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setwd, eval = FALSE, echo = FALSE}</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a><span class="in">setwd(here::here())</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include = FALSE, cache = FALSE}</span></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a><span class="in">#--- load packages ---#</span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a><span class="in">library(data.table)</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a><span class="in">library(exactextractr)</span></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a><span class="in">library(stringr)</span></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a><span class="in">library(raster)</span></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a><span class="in">library(tictoc)</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a><span class="in">library(stargazer)</span></span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a><span class="in">library(tmap)</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a><span class="in">library(future.apply)</span></span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a><span class="in">library(lubridate)</span></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a><span class="in">```{r chap3_figure_setup, echo = FALSE, cache = FALSE}</span></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(</span></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.title.x = element_text(size = 12, angle = 0, hjust = .5, vjust = -0.3, face = "plain", family = "Times"),</span></span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.title.y = element_text(size = 12, angle = 90, hjust = .5, vjust = .9, face = "plain", family = "Times"),</span></span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text.x = element_text(size = 12, angle = 0, hjust = .5, vjust = 1.5, face = "plain", family = "Times"),</span></span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.text.y = element_text(size = 12, angle = 0, hjust = 1, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks = element_line(size = 0.3, linetype = "solid"),</span></span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.ticks = element_blank(),</span></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a><span class="in">  axis.ticks.length = unit(.15, "cm"),</span></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.ticks.margin = unit(.1,'cm'),</span></span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a><span class="in">  # axis.text = element_text(margin=unit(.1,'cm')),</span></span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- legend ---#</span></span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.text = element_text(size = 12, angle = 0, hjust = 0, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.title = element_text(size = 12, angle = 0, hjust = 0, vjust = 0, face = "plain", family = "Times"),</span></span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a><span class="in">  legend.key.size = unit(0.5, "cm"),</span></span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- strip (for faceting) ---#</span></span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a><span class="in">  strip.text = element_text(size = 12, family = "Times"),</span></span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-55"><a href="#cb108-55" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- plot title ---#</span></span>
<span id="cb108-56"><a href="#cb108-56" aria-hidden="true" tabindex="-1"></a><span class="in">  plot.title = element_text(family = "Times", face = "bold", size = 12),</span></span>
<span id="cb108-57"><a href="#cb108-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-58"><a href="#cb108-58" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- margin ---#</span></span>
<span id="cb108-59"><a href="#cb108-59" aria-hidden="true" tabindex="-1"></a><span class="in">  # plot.margin = margin(0, 0, 0, 0, "cm"),</span></span>
<span id="cb108-60"><a href="#cb108-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-61"><a href="#cb108-61" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- panel ---#</span></span>
<span id="cb108-62"><a href="#cb108-62" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.major = element_blank(),</span></span>
<span id="cb108-63"><a href="#cb108-63" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.grid.minor = element_blank(),</span></span>
<span id="cb108-64"><a href="#cb108-64" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.background = element_blank(),</span></span>
<span id="cb108-65"><a href="#cb108-65" aria-hidden="true" tabindex="-1"></a><span class="in">  panel.border = element_rect(fill = NA)</span></span>
<span id="cb108-66"><a href="#cb108-66" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-67"><a href="#cb108-67" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-68"><a href="#cb108-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-69"><a href="#cb108-69" aria-hidden="true" tabindex="-1"></a><span class="fu">## Before you start {-}</span></span>
<span id="cb108-70"><a href="#cb108-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-71"><a href="#cb108-71" aria-hidden="true" tabindex="-1"></a>In this chapter, we explore the spatial interactions between two <span class="in">`sf`</span> objects. We begin by examining topological relations—how two spatial objects relate to each other—focusing on <span class="in">`sf::st_intersects()`</span> and <span class="in">`sf::st_is_within_distance()`</span>. <span class="in">`sf::st_intersects()`</span> is particularly important as it is the most commonly used topological relation and serves as the default for spatial subsetting and joining in <span class="in">`sf`</span>.</span>
<span id="cb108-72"><a href="#cb108-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-73"><a href="#cb108-73" aria-hidden="true" tabindex="-1"></a>Next, we cover spatial subsetting, which involves filtering spatial data based on the geographic features of another dataset. Finally, we will discuss spatial joining, where attribute values from one spatial dataset are assigned to another based on their topological relationship^<span class="co">[</span><span class="ot">For those familiar with the `sp` package, these operations are similar to `sp::over()`.</span><span class="co">]</span>. </span>
<span id="cb108-74"><a href="#cb108-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-75"><a href="#cb108-75" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direction for replication {-}</span></span>
<span id="cb108-76"><a href="#cb108-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-77"><a href="#cb108-77" aria-hidden="true" tabindex="-1"></a>**Datasets**</span>
<span id="cb108-78"><a href="#cb108-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-79"><a href="#cb108-79" aria-hidden="true" tabindex="-1"></a>All the datasets that you need to import are available <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/vhtpjiezijb97lj/AABpvzqdyZMkR1DgUBeI_mOja?dl=0)</span>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</span>
<span id="cb108-80"><a href="#cb108-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-81"><a href="#cb108-81" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>set a folder (any folder) as the working directory using <span class="in">`setwd()`</span>  </span>
<span id="cb108-82"><a href="#cb108-82" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>create a folder called "Data" inside the folder designated as the working directory (if you have created a "Data" folder previously, skip this step)</span>
<span id="cb108-83"><a href="#cb108-83" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>download the pertinent datasets from <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/vhtpjiezijb97lj/AABpvzqdyZMkR1DgUBeI_mOja?dl=0)</span> </span>
<span id="cb108-84"><a href="#cb108-84" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>place all the files in the downloaded folder in the "Data" folder</span>
<span id="cb108-85"><a href="#cb108-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-86"><a href="#cb108-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-87"><a href="#cb108-87" aria-hidden="true" tabindex="-1"></a>**Packages**</span>
<span id="cb108-88"><a href="#cb108-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-89"><a href="#cb108-89" aria-hidden="true" tabindex="-1"></a>Run the following code to install or load (if already installed) the <span class="in">`pacman`</span> package, and then install or load (if already installed) the listed package inside the <span class="in">`pacman::p_load()`</span> function.</span>
<span id="cb108-90"><a href="#cb108-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-91"><a href="#cb108-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Chap_3_packages, cache = F}</span></span>
<span id="cb108-92"><a href="#cb108-92" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require("pacman")) install.packages("pacman")</span></span>
<span id="cb108-93"><a href="#cb108-93" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(</span></span>
<span id="cb108-94"><a href="#cb108-94" aria-hidden="true" tabindex="-1"></a><span class="in">  sf, # vector data operations</span></span>
<span id="cb108-95"><a href="#cb108-95" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr, # data wrangling</span></span>
<span id="cb108-96"><a href="#cb108-96" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table, # data wrangling</span></span>
<span id="cb108-97"><a href="#cb108-97" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot2, # for map creation</span></span>
<span id="cb108-98"><a href="#cb108-98" aria-hidden="true" tabindex="-1"></a><span class="in">  tmap # for map creation</span></span>
<span id="cb108-99"><a href="#cb108-99" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-100"><a href="#cb108-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-101"><a href="#cb108-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-102"><a href="#cb108-102" aria-hidden="true" tabindex="-1"></a><span class="fu">## Topological relations {#sec-topo}</span></span>
<span id="cb108-103"><a href="#cb108-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-104"><a href="#cb108-104" aria-hidden="true" tabindex="-1"></a>Before diving into spatial subsetting and joining, we first examine topological relations. These refer to how multiple spatial objects are related to each other in space. The <span class="in">`sf`</span> package provides various functions to identify these spatial relationships, with our primary focus being on intersections, which can be identified using <span class="in">`sf::st_intersects()`</span>^<span class="co">[</span><span class="ot">Other topological relations like `st_within()` or `st_touches()` are rarely used.</span><span class="co">]</span>. We will also briefly explore <span class="in">`sf::st_is_within_distance()`</span>. If you're interested in other topological relations, you can check the documentation with <span class="in">`?geos_binary_pred`</span>.</span>
<span id="cb108-105"><a href="#cb108-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-106"><a href="#cb108-106" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data preparation</span></span>
<span id="cb108-107"><a href="#cb108-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-108"><a href="#cb108-108" aria-hidden="true" tabindex="-1"></a>We will use three <span class="in">`sf`</span> objects: <span class="in">`points`</span>, <span class="in">`lines`</span>, and <span class="in">`polygons`</span>. </span>
<span id="cb108-109"><a href="#cb108-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-110"><a href="#cb108-110" aria-hidden="true" tabindex="-1"></a>**POINTS**</span>
<span id="cb108-111"><a href="#cb108-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-112"><a href="#cb108-112" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_points}</span></span>
<span id="cb108-113"><a href="#cb108-113" aria-hidden="true" tabindex="-1"></a><span class="in">#--- create points ---#</span></span>
<span id="cb108-114"><a href="#cb108-114" aria-hidden="true" tabindex="-1"></a><span class="in">point_1 &lt;- sf::st_point(c(2, 2))</span></span>
<span id="cb108-115"><a href="#cb108-115" aria-hidden="true" tabindex="-1"></a><span class="in">point_2 &lt;- sf::st_point(c(1, 1))</span></span>
<span id="cb108-116"><a href="#cb108-116" aria-hidden="true" tabindex="-1"></a><span class="in">point_3 &lt;- sf::st_point(c(1, 3))</span></span>
<span id="cb108-117"><a href="#cb108-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-118"><a href="#cb108-118" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine the points to make a single  sf of points ---#</span></span>
<span id="cb108-119"><a href="#cb108-119" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-120"><a href="#cb108-120" aria-hidden="true" tabindex="-1"></a><span class="in">points &lt;- </span></span>
<span id="cb108-121"><a href="#cb108-121" aria-hidden="true" tabindex="-1"></a><span class="in">  list(point_1, point_2, point_3) %&gt;% </span></span>
<span id="cb108-122"><a href="#cb108-122" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% </span></span>
<span id="cb108-123"><a href="#cb108-123" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf() %&gt;% </span></span>
<span id="cb108-124"><a href="#cb108-124" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(point_name = c("point 1", "point 2", "point 3"))</span></span>
<span id="cb108-125"><a href="#cb108-125" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-126"><a href="#cb108-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-127"><a href="#cb108-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-128"><a href="#cb108-128" aria-hidden="true" tabindex="-1"></a>**LINES**</span>
<span id="cb108-129"><a href="#cb108-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-130"><a href="#cb108-130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_lines}</span></span>
<span id="cb108-131"><a href="#cb108-131" aria-hidden="true" tabindex="-1"></a><span class="in">#--- create points ---#</span></span>
<span id="cb108-132"><a href="#cb108-132" aria-hidden="true" tabindex="-1"></a><span class="in">line_1 &lt;- sf::st_linestring(rbind(c(0, 0), c(2.5, 0.5)))</span></span>
<span id="cb108-133"><a href="#cb108-133" aria-hidden="true" tabindex="-1"></a><span class="in">line_2 &lt;- sf::st_linestring(rbind(c(1.5, 0.5), c(2.5, 2)))</span></span>
<span id="cb108-134"><a href="#cb108-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-135"><a href="#cb108-135" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine the points to make a single  sf of points ---#</span></span>
<span id="cb108-136"><a href="#cb108-136" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-137"><a href="#cb108-137" aria-hidden="true" tabindex="-1"></a><span class="in">lines &lt;- </span></span>
<span id="cb108-138"><a href="#cb108-138" aria-hidden="true" tabindex="-1"></a><span class="in">  list(line_1, line_2) %&gt;% </span></span>
<span id="cb108-139"><a href="#cb108-139" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% </span></span>
<span id="cb108-140"><a href="#cb108-140" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf() %&gt;% </span></span>
<span id="cb108-141"><a href="#cb108-141" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(line_name = c("line 1", "line 2"))</span></span>
<span id="cb108-142"><a href="#cb108-142" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-143"><a href="#cb108-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-144"><a href="#cb108-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-145"><a href="#cb108-145" aria-hidden="true" tabindex="-1"></a>**POLYGONS**</span>
<span id="cb108-146"><a href="#cb108-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-147"><a href="#cb108-147" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_polygons}</span></span>
<span id="cb108-148"><a href="#cb108-148" aria-hidden="true" tabindex="-1"></a><span class="in">#--- create polygons ---#</span></span>
<span id="cb108-149"><a href="#cb108-149" aria-hidden="true" tabindex="-1"></a><span class="in">polygon_1 &lt;- sf::st_polygon(list(</span></span>
<span id="cb108-150"><a href="#cb108-150" aria-hidden="true" tabindex="-1"></a><span class="in">  rbind(c(0, 0), c(2, 0), c(2, 2), c(0, 2), c(0, 0)) </span></span>
<span id="cb108-151"><a href="#cb108-151" aria-hidden="true" tabindex="-1"></a><span class="in">))</span></span>
<span id="cb108-152"><a href="#cb108-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-153"><a href="#cb108-153" aria-hidden="true" tabindex="-1"></a><span class="in">polygon_2 &lt;- sf::st_polygon(list(</span></span>
<span id="cb108-154"><a href="#cb108-154" aria-hidden="true" tabindex="-1"></a><span class="in">  rbind(c(0.5, 1.5), c(0.5, 3.5), c(2.5, 3.5), c(2.5, 1.5), c(0.5, 1.5)) </span></span>
<span id="cb108-155"><a href="#cb108-155" aria-hidden="true" tabindex="-1"></a><span class="in">))</span></span>
<span id="cb108-156"><a href="#cb108-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-157"><a href="#cb108-157" aria-hidden="true" tabindex="-1"></a><span class="in">polygon_3 &lt;- sf::st_polygon(list(</span></span>
<span id="cb108-158"><a href="#cb108-158" aria-hidden="true" tabindex="-1"></a><span class="in">  rbind(c(0.5, 2.5), c(0.5, 3.2), c(2.3, 3.2), c(2, 2), c(0.5, 2.5)) </span></span>
<span id="cb108-159"><a href="#cb108-159" aria-hidden="true" tabindex="-1"></a><span class="in">))</span></span>
<span id="cb108-160"><a href="#cb108-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-161"><a href="#cb108-161" aria-hidden="true" tabindex="-1"></a><span class="in">#--- combine the polygons to make an sf of polygons ---#</span></span>
<span id="cb108-162"><a href="#cb108-162" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-163"><a href="#cb108-163" aria-hidden="true" tabindex="-1"></a><span class="in">polygons &lt;- </span></span>
<span id="cb108-164"><a href="#cb108-164" aria-hidden="true" tabindex="-1"></a><span class="in">  list(polygon_1, polygon_2, polygon_3) %&gt;% </span></span>
<span id="cb108-165"><a href="#cb108-165" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% </span></span>
<span id="cb108-166"><a href="#cb108-166" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf() %&gt;% </span></span>
<span id="cb108-167"><a href="#cb108-167" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(polygon_name = c("polygon 1", "polygon 2", "polygon 3"))</span></span>
<span id="cb108-168"><a href="#cb108-168" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-169"><a href="#cb108-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-170"><a href="#cb108-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-171"><a href="#cb108-171" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb108-172"><a href="#cb108-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-173"><a href="#cb108-173" aria-hidden="true" tabindex="-1"></a>@fig-plot-point-polygons shows how they look together: </span>
<span id="cb108-174"><a href="#cb108-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-177"><a href="#cb108-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-178"><a href="#cb108-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-plot-point-polygons</span></span>
<span id="cb108-179"><a href="#cb108-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visualization of the points, lines, and polygons" </span></span>
<span id="cb108-180"><a href="#cb108-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb108-181"><a href="#cb108-181" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-182"><a href="#cb108-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-183"><a href="#cb108-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>) <span class="sc">+</span></span>
<span id="cb108-184"><a href="#cb108-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> lines, <span class="fu">aes</span>(<span class="at">color =</span> line_name)) <span class="sc">+</span></span>
<span id="cb108-185"><a href="#cb108-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"Lines"</span>) <span class="sc">+</span> </span>
<span id="cb108-186"><a href="#cb108-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> points, <span class="fu">aes</span>(<span class="at">shape =</span> point_name), <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb108-187"><a href="#cb108-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_discrete</span>(<span class="at">name =</span> <span class="st">"Points"</span>)  </span>
<span id="cb108-188"><a href="#cb108-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-189"><a href="#cb108-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-190"><a href="#cb108-190" aria-hidden="true" tabindex="-1"></a><span class="fu">### `sf::st_intersects()`</span></span>
<span id="cb108-191"><a href="#cb108-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-192"><a href="#cb108-192" aria-hidden="true" tabindex="-1"></a><span class="in">`sf::st_intersects()`</span> identifies which <span class="in">`sfg`</span> object in an <span class="in">`sf`</span> (or <span class="in">`sfc`</span>) intersects with <span class="in">`sfg`</span> object(s) in another <span class="in">`sf`</span>. For example, you can use the function to identify which well is located within which county. <span class="in">`sf::st_intersects()`</span> is the most commonly used topological relation. It is important to understand what it does as it is the default topological relation used when performing spatial subsetting and joining, which we will cover later.  </span>
<span id="cb108-193"><a href="#cb108-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-194"><a href="#cb108-194" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb108-195"><a href="#cb108-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-196"><a href="#cb108-196" aria-hidden="true" tabindex="-1"></a>**points and polygons** (@fig-points-polygons)</span>
<span id="cb108-197"><a href="#cb108-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-198"><a href="#cb108-198" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-201"><a href="#cb108-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-202"><a href="#cb108-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-points-polygons</span></span>
<span id="cb108-203"><a href="#cb108-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb108-204"><a href="#cb108-204" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-205"><a href="#cb108-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-206"><a href="#cb108-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>) <span class="sc">+</span></span>
<span id="cb108-207"><a href="#cb108-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> points, <span class="fu">aes</span>(<span class="at">shape =</span> point_name), <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb108-208"><a href="#cb108-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_discrete</span>(<span class="at">name =</span> <span class="st">"Points"</span>)</span>
<span id="cb108-209"><a href="#cb108-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-210"><a href="#cb108-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-211"><a href="#cb108-211" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-212"><a href="#cb108-212" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-213"><a href="#cb108-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-214"><a href="#cb108-214" aria-hidden="true" tabindex="-1"></a><span class="in">```{r intersects_point_polygons}</span></span>
<span id="cb108-215"><a href="#cb108-215" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_intersects(points, polygons)</span></span>
<span id="cb108-216"><a href="#cb108-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-217"><a href="#cb108-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-218"><a href="#cb108-218" aria-hidden="true" tabindex="-1"></a>As you can see, the output is a list of which polygon(s) each of the points intersect with. The numbers 1, 2, and 3 in the first row mean that 1st (polygon 1), 2nd (polygon 2), and 3rd (polygon 3) objects of the <span class="in">`polygons`</span> intersect with the first point (point 1) of the <span class="in">`points`</span> object. The fact that point 1 is considered to be intersecting with polygon 2 means that the area inside the border is considered a part of the polygon (of course). </span>
<span id="cb108-219"><a href="#cb108-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-220"><a href="#cb108-220" aria-hidden="true" tabindex="-1"></a>If you would like the results of <span class="in">`sf::st_intersects()`</span> in a matrix form with boolean values filling the matrix, you can add <span class="in">`sparse = FALSE`</span> option. </span>
<span id="cb108-221"><a href="#cb108-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-222"><a href="#cb108-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb108-223"><a href="#cb108-223" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_intersects(points, polygons, sparse = FALSE)</span></span>
<span id="cb108-224"><a href="#cb108-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-225"><a href="#cb108-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-226"><a href="#cb108-226" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb108-227"><a href="#cb108-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-228"><a href="#cb108-228" aria-hidden="true" tabindex="-1"></a>**lines and polygons** (@fig-lines-polygons)</span>
<span id="cb108-229"><a href="#cb108-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-230"><a href="#cb108-230" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-233"><a href="#cb108-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-234"><a href="#cb108-234" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-lines-polygons</span></span>
<span id="cb108-235"><a href="#cb108-235" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb108-236"><a href="#cb108-236" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-237"><a href="#cb108-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-238"><a href="#cb108-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>) <span class="sc">+</span></span>
<span id="cb108-239"><a href="#cb108-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> lines, <span class="fu">aes</span>(<span class="at">color =</span> line_name)) <span class="sc">+</span></span>
<span id="cb108-240"><a href="#cb108-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"Lines"</span>)</span>
<span id="cb108-241"><a href="#cb108-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-242"><a href="#cb108-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-243"><a href="#cb108-243" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-244"><a href="#cb108-244" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-245"><a href="#cb108-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-246"><a href="#cb108-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r intersects_lines_polygons}</span></span>
<span id="cb108-247"><a href="#cb108-247" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_intersects(lines, polygons)</span></span>
<span id="cb108-248"><a href="#cb108-248" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-249"><a href="#cb108-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-250"><a href="#cb108-250" aria-hidden="true" tabindex="-1"></a>The output is a list of which polygon(s) each of the lines intersect with. For example, line intersects with the 1st and 2nd elements of <span class="in">`polygons`</span>, which are <span class="in">`polygon 1`</span> and <span class="in">`polygon 2`</span>.</span>
<span id="cb108-251"><a href="#cb108-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-252"><a href="#cb108-252" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb108-253"><a href="#cb108-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-254"><a href="#cb108-254" aria-hidden="true" tabindex="-1"></a>**polygons and polygons** (@fig-polygons-polygons)</span>
<span id="cb108-255"><a href="#cb108-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-256"><a href="#cb108-256" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-259"><a href="#cb108-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-260"><a href="#cb108-260" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-polygons-polygons</span></span>
<span id="cb108-261"><a href="#cb108-261" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb108-262"><a href="#cb108-262" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-263"><a href="#cb108-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-264"><a href="#cb108-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>)</span>
<span id="cb108-265"><a href="#cb108-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-266"><a href="#cb108-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-267"><a href="#cb108-267" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-268"><a href="#cb108-268" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-269"><a href="#cb108-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-270"><a href="#cb108-270" aria-hidden="true" tabindex="-1"></a>For polygons vs polygons interaction, <span class="in">`sf::st_intersects()`</span> identifies any polygons that either touches (even at a point like polygons 1 and 3) or share some area.</span>
<span id="cb108-271"><a href="#cb108-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-272"><a href="#cb108-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb108-273"><a href="#cb108-273" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_intersects(polygons, polygons)</span></span>
<span id="cb108-274"><a href="#cb108-274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-275"><a href="#cb108-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-276"><a href="#cb108-276" aria-hidden="true" tabindex="-1"></a>Clearly, all of them interact with all the polygons (including themselves) in this case.</span>
<span id="cb108-277"><a href="#cb108-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-278"><a href="#cb108-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-279"><a href="#cb108-279" aria-hidden="true" tabindex="-1"></a><span class="fu">### `sf::st_is_within_distance()`</span></span>
<span id="cb108-280"><a href="#cb108-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-281"><a href="#cb108-281" aria-hidden="true" tabindex="-1"></a>This function identifies whether two spatial objects are within the distance you specify^<span class="co">[</span><span class="ot">For example, this function can be useful to identify neighbors. For example, you may want to find irrigation wells located around well $i$ to label them as well $i$'s neighbor.</span><span class="co">]</span>.</span>
<span id="cb108-282"><a href="#cb108-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-283"><a href="#cb108-283" aria-hidden="true" tabindex="-1"></a>We will use two sets of points data.</span>
<span id="cb108-284"><a href="#cb108-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-285"><a href="#cb108-285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_random_points}</span></span>
<span id="cb108-286"><a href="#cb108-286" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb108-287"><a href="#cb108-287" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(38424738)</span></span>
<span id="cb108-288"><a href="#cb108-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-289"><a href="#cb108-289" aria-hidden="true" tabindex="-1"></a><span class="in">points_set_1 &lt;-</span></span>
<span id="cb108-290"><a href="#cb108-290" aria-hidden="true" tabindex="-1"></a><span class="in">  lapply(1:5, function(x) sf::st_point(runif(2))) %&gt;% </span></span>
<span id="cb108-291"><a href="#cb108-291" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% sf::st_as_sf() %&gt;% </span></span>
<span id="cb108-292"><a href="#cb108-292" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(id = 1:nrow(.))</span></span>
<span id="cb108-293"><a href="#cb108-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-294"><a href="#cb108-294" aria-hidden="true" tabindex="-1"></a><span class="in">points_set_2 &lt;-</span></span>
<span id="cb108-295"><a href="#cb108-295" aria-hidden="true" tabindex="-1"></a><span class="in">  lapply(1:5, function(x) sf::st_point(runif(2))) %&gt;% </span></span>
<span id="cb108-296"><a href="#cb108-296" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_sfc() %&gt;% sf::st_as_sf() %&gt;% </span></span>
<span id="cb108-297"><a href="#cb108-297" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(id = 1:nrow(.))</span></span>
<span id="cb108-298"><a href="#cb108-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-299"><a href="#cb108-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-302"><a href="#cb108-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-303"><a href="#cb108-303" aria-hidden="true" tabindex="-1"></a>points_set_1</span>
<span id="cb108-304"><a href="#cb108-304" aria-hidden="true" tabindex="-1"></a>points_set_2</span>
<span id="cb108-305"><a href="#cb108-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-306"><a href="#cb108-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-307"><a href="#cb108-307" aria-hidden="true" tabindex="-1"></a>Here is how they are spatially distributed (@fig-map-points-points-points). Instead of circles of points, their corresponding <span class="in">`id`</span> (or equivalently row number here) values are displayed.</span>
<span id="cb108-308"><a href="#cb108-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-311"><a href="#cb108-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-312"><a href="#cb108-312" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-313"><a href="#cb108-313" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-points-points-points </span></span>
<span id="cb108-314"><a href="#cb108-314" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The locations of the set of points"</span></span>
<span id="cb108-315"><a href="#cb108-315" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb108-316"><a href="#cb108-316" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-317"><a href="#cb108-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> points_set_1, <span class="fu">aes</span>(<span class="at">label =</span> id), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb108-318"><a href="#cb108-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> points_set_2, <span class="fu">aes</span>(<span class="at">label =</span> id), <span class="at">color =</span> <span class="st">"blue"</span>) </span>
<span id="cb108-319"><a href="#cb108-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-320"><a href="#cb108-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-321"><a href="#cb108-321" aria-hidden="true" tabindex="-1"></a>We want to know which of the blue points (<span class="in">`points_set_2`</span>) are located within 0.2 from each of the red points (<span class="in">`points_set_1`</span>). @fig-points-points-within gives us the answer visually.</span>
<span id="cb108-322"><a href="#cb108-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-325"><a href="#cb108-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-326"><a href="#cb108-326" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-points-points-within</span></span>
<span id="cb108-327"><a href="#cb108-327" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The blue points within 0.2 radius of the red points"</span></span>
<span id="cb108-328"><a href="#cb108-328" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-329"><a href="#cb108-329" aria-hidden="true" tabindex="-1"></a><span class="co">#--- create 0.2 buffers around points in points_set_1 ---#</span></span>
<span id="cb108-330"><a href="#cb108-330" aria-hidden="true" tabindex="-1"></a>buffer_1 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(points_set_1, <span class="at">dist =</span> <span class="fl">0.2</span>)</span>
<span id="cb108-331"><a href="#cb108-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-332"><a href="#cb108-332" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-333"><a href="#cb108-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> buffer_1, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb108-334"><a href="#cb108-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> points_set_1, <span class="fu">aes</span>(<span class="at">label =</span> id), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb108-335"><a href="#cb108-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> points_set_2, <span class="fu">aes</span>(<span class="at">label =</span> id), <span class="at">color =</span> <span class="st">"blue"</span>) </span>
<span id="cb108-336"><a href="#cb108-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-337"><a href="#cb108-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-338"><a href="#cb108-338" aria-hidden="true" tabindex="-1"></a>Confirm your visual inspection results with the outcome of the following code using <span class="in">`sf::st_is_within_distance()`</span> function.</span>
<span id="cb108-339"><a href="#cb108-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-340"><a href="#cb108-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r within_distance_blue_red}</span></span>
<span id="cb108-341"><a href="#cb108-341" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_is_within_distance(points_set_1, points_set_2, dist = 0.2)</span></span>
<span id="cb108-342"><a href="#cb108-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-343"><a href="#cb108-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-344"><a href="#cb108-344" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial cropping</span></span>
<span id="cb108-345"><a href="#cb108-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-346"><a href="#cb108-346" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data preparation</span></span>
<span id="cb108-347"><a href="#cb108-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-348"><a href="#cb108-348" aria-hidden="true" tabindex="-1"></a>Let's import the following files: </span>
<span id="cb108-349"><a href="#cb108-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-350"><a href="#cb108-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r hp_import, results = "hide"}</span></span>
<span id="cb108-351"><a href="#cb108-351" aria-hidden="true" tabindex="-1"></a><span class="in">#--- Kansas county borders ---#</span></span>
<span id="cb108-352"><a href="#cb108-352" aria-hidden="true" tabindex="-1"></a><span class="in">KS_counties &lt;-</span></span>
<span id="cb108-353"><a href="#cb108-353" aria-hidden="true" tabindex="-1"></a><span class="in">  readRDS("Data/KS_county_borders.rds") %&gt;%</span></span>
<span id="cb108-354"><a href="#cb108-354" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(32614)</span></span>
<span id="cb108-355"><a href="#cb108-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-356"><a href="#cb108-356" aria-hidden="true" tabindex="-1"></a><span class="in">#--- High-Plains Aquifer boundary ---#</span></span>
<span id="cb108-357"><a href="#cb108-357" aria-hidden="true" tabindex="-1"></a><span class="in">hpa &lt;- </span></span>
<span id="cb108-358"><a href="#cb108-358" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_read("Data/hp_bound2010.shp") %&gt;%</span></span>
<span id="cb108-359"><a href="#cb108-359" aria-hidden="true" tabindex="-1"></a><span class="in">  .[1, ] %&gt;%</span></span>
<span id="cb108-360"><a href="#cb108-360" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(st_crs(KS_counties))</span></span>
<span id="cb108-361"><a href="#cb108-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-362"><a href="#cb108-362" aria-hidden="true" tabindex="-1"></a><span class="in">#--- all the irrigation wells in KS ---#</span></span>
<span id="cb108-363"><a href="#cb108-363" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells &lt;- </span></span>
<span id="cb108-364"><a href="#cb108-364" aria-hidden="true" tabindex="-1"></a><span class="in">  readRDS("Data/Kansas_wells.rds") %&gt;%</span></span>
<span id="cb108-365"><a href="#cb108-365" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(st_crs(KS_counties))</span></span>
<span id="cb108-366"><a href="#cb108-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-367"><a href="#cb108-367" aria-hidden="true" tabindex="-1"></a><span class="in">#--- US railroads in the Mid West region ---#</span></span>
<span id="cb108-368"><a href="#cb108-368" aria-hidden="true" tabindex="-1"></a><span class="in">rail_roads_mw &lt;- sf::st_read("Data/mw_railroads.geojson")</span></span>
<span id="cb108-369"><a href="#cb108-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-370"><a href="#cb108-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-371"><a href="#cb108-371" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bounding box</span></span>
<span id="cb108-372"><a href="#cb108-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-373"><a href="#cb108-373" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`st_crop()`</span> to crop a spatial object to a spatial bounding box (extent) of another spatial object. The bounding box of an <span class="in">`sf`</span> is a rectangle represented by the minimum and maximum of <span class="in">`x`</span> and <span class="in">`y`</span> that encompass/contain all the spatial objects in the <span class="in">`sf`</span>. You can use <span class="in">`st_bbox()`</span> to find the bounding box of an <span class="in">`sf`</span> object. Let's get the bounding box of irrigation wells in Kansas (<span class="in">`KS_wells`</span>).</span>
<span id="cb108-374"><a href="#cb108-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-375"><a href="#cb108-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r bbox_KS_wlls}</span></span>
<span id="cb108-376"><a href="#cb108-376" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the bounding box of KS_wells ---#</span></span>
<span id="cb108-377"><a href="#cb108-377" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-378"><a href="#cb108-378" aria-hidden="true" tabindex="-1"></a><span class="in">bbox_KS_wells &lt;- sf::st_bbox(KS_wells)  </span></span>
<span id="cb108-379"><a href="#cb108-379" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-380"><a href="#cb108-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-381"><a href="#cb108-381" aria-hidden="true" tabindex="-1"></a><span class="in">#--- check the class ---#</span></span>
<span id="cb108-382"><a href="#cb108-382" aria-hidden="true" tabindex="-1"></a><span class="in">class(bbox_KS_wells)</span></span>
<span id="cb108-383"><a href="#cb108-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-384"><a href="#cb108-384" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb108-385"><a href="#cb108-385" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`sf::st_bbox()`</span> returns an object of class <span class="in">`bbox`</span>. You cannot directly create a map using a <span class="in">`bbox`</span>. So, let's convert it to an <span class="in">`sfc`</span> using <span class="in">`sf::st_as_sfc()`</span>:</span>
<span id="cb108-386"><a href="#cb108-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-387"><a href="#cb108-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sfc-county-bbox}</span></span>
<span id="cb108-388"><a href="#cb108-388" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells_bbox_sfc &lt;- sf::st_as_sfc(bbox_KS_wells) </span></span>
<span id="cb108-389"><a href="#cb108-389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-390"><a href="#cb108-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-391"><a href="#cb108-391" aria-hidden="true" tabindex="-1"></a>@fig-bbox-fig shows the bounding box (red rectangle).</span>
<span id="cb108-392"><a href="#cb108-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-395"><a href="#cb108-395" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-396"><a href="#cb108-396" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-bbox-fig</span></span>
<span id="cb108-397"><a href="#cb108-397" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The bounding box of the irrigation wells in Kansas that overlie HPA" </span></span>
<span id="cb108-398"><a href="#cb108-398" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-399"><a href="#cb108-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-400"><a href="#cb108-400" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-401"><a href="#cb108-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb108-402"><a href="#cb108-402" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> KS_wells_bbox_sfc, </span>
<span id="cb108-403"><a href="#cb108-403" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb108-404"><a href="#cb108-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>,</span>
<span id="cb108-405"><a href="#cb108-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">1.2</span></span>
<span id="cb108-406"><a href="#cb108-406" aria-hidden="true" tabindex="-1"></a>   ) <span class="sc">+</span></span>
<span id="cb108-407"><a href="#cb108-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb108-408"><a href="#cb108-408" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> KS_wells,</span>
<span id="cb108-409"><a href="#cb108-409" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.4</span></span>
<span id="cb108-410"><a href="#cb108-410" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb108-411"><a href="#cb108-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-412"><a href="#cb108-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-413"><a href="#cb108-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-414"><a href="#cb108-414" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatial cropping</span></span>
<span id="cb108-415"><a href="#cb108-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-416"><a href="#cb108-416" aria-hidden="true" tabindex="-1"></a>Let's now crop High-Plains aquifer boundary (<span class="in">`hpa`</span>) to the bounding box of Kansas wells (@fig-hpa).</span>
<span id="cb108-417"><a href="#cb108-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-418"><a href="#cb108-418" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-421"><a href="#cb108-421" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-422"><a href="#cb108-422" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-hpa</span></span>
<span id="cb108-423"><a href="#cb108-423" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "HPA and irrigation wells in Kansas"</span></span>
<span id="cb108-424"><a href="#cb108-424" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-425"><a href="#cb108-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-426"><a href="#cb108-426" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-427"><a href="#cb108-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells, <span class="at">size =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb108-428"><a href="#cb108-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_bbox_sfc, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb108-429"><a href="#cb108-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-430"><a href="#cb108-430" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-431"><a href="#cb108-431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-432"><a href="#cb108-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-433"><a href="#cb108-433" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-434"><a href="#cb108-434" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-435"><a href="#cb108-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-436"><a href="#cb108-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r crop_counties}</span></span>
<span id="cb108-437"><a href="#cb108-437" aria-hidden="true" tabindex="-1"></a><span class="in">hpa_cropped_to_KS &lt;- sf::st_crop(hpa, KS_wells)</span></span>
<span id="cb108-438"><a href="#cb108-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-439"><a href="#cb108-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-440"><a href="#cb108-440" aria-hidden="true" tabindex="-1"></a>Here is what the cropped version of <span class="in">`hpa`</span> looks like (@fig-cropped-hpa):</span>
<span id="cb108-441"><a href="#cb108-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-444"><a href="#cb108-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-445"><a href="#cb108-445" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cropped-hpa</span></span>
<span id="cb108-446"><a href="#cb108-446" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The bounding box of the irrigation wells in Kansas that overlie HPA"</span></span>
<span id="cb108-447"><a href="#cb108-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-448"><a href="#cb108-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-449"><a href="#cb108-449" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-450"><a href="#cb108-450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells, <span class="at">size =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb108-451"><a href="#cb108-451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_bbox_sfc, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb108-452"><a href="#cb108-452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-453"><a href="#cb108-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-454"><a href="#cb108-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-455"><a href="#cb108-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-456"><a href="#cb108-456" aria-hidden="true" tabindex="-1"></a>As you can see, the <span class="in">`st_crop()`</span> operation cut the parts of <span class="in">`hpa`</span> that are not intersecting with the bounding box of <span class="in">`KS_wells`</span>.</span>
<span id="cb108-457"><a href="#cb108-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-458"><a href="#cb108-458" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb108-459"><a href="#cb108-459" aria-hidden="true" tabindex="-1"></a>Please note that we did not explicilty crop <span class="in">`hpa`</span> to the bouding box of <span class="in">`KS_wells`</span> (<span class="in">`bbox_KS_wells`</span>) above. That is, we just run <span class="in">`hpa_cropped_to_KS &lt;- sf::st_crop(hpa, KS_wells)`</span> instead of <span class="in">`hpa_cropped_to_KS &lt;- sf::st_crop(hpa, bbox_KS_wells)`</span>. When <span class="in">`sf::st_crop()`</span> is used, it automatically finds the bounding box of the <span class="in">`sf`</span> as second argument and implements cropping.</span>
<span id="cb108-460"><a href="#cb108-460" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-461"><a href="#cb108-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-462"><a href="#cb108-462" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial subsetting</span></span>
<span id="cb108-463"><a href="#cb108-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-464"><a href="#cb108-464" aria-hidden="true" tabindex="-1"></a>Spatial subsetting refers to operations that narrow down the geographic scope of a spatial object (source data) based on another spatial object (target data). We illustrate spatial subsetting using Kansas county borders (<span class="in">`KS_counties`</span>), the boundary of the Kansas portion of the High-Plains Aquifer (<span class="in">`hpa_cropped_to_KS`</span>), and agricultural irrigation wells in Kansas (<span class="in">`KS_wells`</span>).</span>
<span id="cb108-465"><a href="#cb108-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-466"><a href="#cb108-466" aria-hidden="true" tabindex="-1"></a><span class="fu">### polygons (source) vs polygons (target)</span></span>
<span id="cb108-467"><a href="#cb108-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-468"><a href="#cb108-468" aria-hidden="true" tabindex="-1"></a>@fig-overlap-KS-county-HPA shows the Kansas portion of the HPA and Kansas counties.</span>
<span id="cb108-469"><a href="#cb108-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-470"><a href="#cb108-470" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-473"><a href="#cb108-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-474"><a href="#cb108-474" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-overlap-KS-county-HPA</span></span>
<span id="cb108-475"><a href="#cb108-475" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Kansas portion of High-Plains Aquifer and Kansas counties"</span></span>
<span id="cb108-476"><a href="#cb108-476" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-477"><a href="#cb108-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-478"><a href="#cb108-478" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-479"><a href="#cb108-479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties) <span class="sc">+</span></span>
<span id="cb108-480"><a href="#cb108-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-481"><a href="#cb108-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-482"><a href="#cb108-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-483"><a href="#cb108-483" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-484"><a href="#cb108-484" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-485"><a href="#cb108-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-486"><a href="#cb108-486" aria-hidden="true" tabindex="-1"></a>The goal is to select only the counties that intersect with the HPA boundary. Spatial subsetting of <span class="in">`sf`</span> objects follows this syntax:</span>
<span id="cb108-487"><a href="#cb108-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-488"><a href="#cb108-488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r syntax_subset}</span></span>
<span id="cb108-489"><a href="#cb108-489" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: false</span></span>
<span id="cb108-490"><a href="#cb108-490" aria-hidden="true" tabindex="-1"></a><span class="in">#--- this does not run ---#</span></span>
<span id="cb108-491"><a href="#cb108-491" aria-hidden="true" tabindex="-1"></a><span class="in">sf_1[sf_2, ]</span></span>
<span id="cb108-492"><a href="#cb108-492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-493"><a href="#cb108-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-494"><a href="#cb108-494" aria-hidden="true" tabindex="-1"></a>where you are subsetting <span class="in">`sf_1`</span> based on <span class="in">`sf_2`</span>. Instead of row numbers, you provide another sf object in place. The following code spatially subsets Kansas counties based on the HPA boundary.</span>
<span id="cb108-495"><a href="#cb108-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-496"><a href="#cb108-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r spatial_subset}</span></span>
<span id="cb108-497"><a href="#cb108-497" aria-hidden="true" tabindex="-1"></a><span class="in">counties_intersecting_hpa &lt;- KS_counties[hpa_cropped_to_KS, ]</span></span>
<span id="cb108-498"><a href="#cb108-498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-499"><a href="#cb108-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-500"><a href="#cb108-500" aria-hidden="true" tabindex="-1"></a>@fig-default-subset presents counties in <span class="in">`counties_intersecting_hpa`</span> and the cropped HPA boundary.</span>
<span id="cb108-501"><a href="#cb108-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-504"><a href="#cb108-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-505"><a href="#cb108-505" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-506"><a href="#cb108-506" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The results of spatially subsetting Kansas counties based on HPA boundary"</span></span>
<span id="cb108-507"><a href="#cb108-507" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-default-subset</span></span>
<span id="cb108-508"><a href="#cb108-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-509"><a href="#cb108-509" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-510"><a href="#cb108-510" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- add US counties layer ---#</span></span>
<span id="cb108-511"><a href="#cb108-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> counties_intersecting_hpa) <span class="sc">+</span></span>
<span id="cb108-512"><a href="#cb108-512" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- add High-Plains Aquifer layer ---#</span></span>
<span id="cb108-513"><a href="#cb108-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-514"><a href="#cb108-514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-515"><a href="#cb108-515" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-516"><a href="#cb108-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-517"><a href="#cb108-517" aria-hidden="true" tabindex="-1"></a>You can see that only the counties intersecting with the HPA boundary remain. This is because, when using the syntax <span class="in">`sf_1[sf_2, ]`</span>, the default topological relation is <span class="in">`sf::st_intersects()`</span>. If objects in <span class="in">`sf_1`</span> intersect with any of the objects in <span class="in">`sf_2`</span>, even slightly, they will remain after subsetting.</span>
<span id="cb108-518"><a href="#cb108-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-519"><a href="#cb108-519" aria-hidden="true" tabindex="-1"></a>Sometimes, instead of removing non-intersecting observations, you may just want to flag whether two spatial objects intersect. To do this, you can first retrieve the IDs of the intersecting counties from <span class="in">`counties_intersecting_hpa`</span> and then create a variable in the original dataset (<span class="in">`KS_counties`</span>) that indicates whether an intersection occurs.</span>
<span id="cb108-520"><a href="#cb108-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-521"><a href="#cb108-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r county_hpa}</span></span>
<span id="cb108-522"><a href="#cb108-522" aria-hidden="true" tabindex="-1"></a><span class="in">#--- check the intersections of HPA and counties  ---#</span></span>
<span id="cb108-523"><a href="#cb108-523" aria-hidden="true" tabindex="-1"></a><span class="in">intersecting_counties_list &lt;- counties_intersecting_hpa$COUNTYFP</span></span>
<span id="cb108-524"><a href="#cb108-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-525"><a href="#cb108-525" aria-hidden="true" tabindex="-1"></a><span class="in">#--- assign true/false ---#</span></span>
<span id="cb108-526"><a href="#cb108-526" aria-hidden="true" tabindex="-1"></a><span class="in">KS_counties &lt;- dplyr::mutate(KS_counties, intersects_hpa = ifelse(COUNTYFP %in% intersecting_counties_list, TRUE, FALSE))</span></span>
<span id="cb108-527"><a href="#cb108-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-528"><a href="#cb108-528" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb108-529"><a href="#cb108-529" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::select(KS_counties, COUNTYFP, intersects_hpa)</span></span>
<span id="cb108-530"><a href="#cb108-530" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-531"><a href="#cb108-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-532"><a href="#cb108-532" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb108-533"><a href="#cb108-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-534"><a href="#cb108-534" aria-hidden="true" tabindex="-1"></a>**Other topological relations**</span>
<span id="cb108-535"><a href="#cb108-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-536"><a href="#cb108-536" aria-hidden="true" tabindex="-1"></a>As mentioned above, the default topological relation used in <span class="in">`sf_1[sf_2, ]`</span> is <span class="in">`sf::st_intersects()`</span>. However, you can specify other topological relations using the following syntax:</span>
<span id="cb108-537"><a href="#cb108-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-538"><a href="#cb108-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = FALSE}</span></span>
<span id="cb108-539"><a href="#cb108-539" aria-hidden="true" tabindex="-1"></a><span class="in">#--- this does not run ---#</span></span>
<span id="cb108-540"><a href="#cb108-540" aria-hidden="true" tabindex="-1"></a><span class="in">sf_1[sf_2, op = topological_relation_type] </span></span>
<span id="cb108-541"><a href="#cb108-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-542"><a href="#cb108-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-543"><a href="#cb108-543" aria-hidden="true" tabindex="-1"></a>For example, if you only want counties that are completely within the HPA boundary, you can use the following approach:  </span>
<span id="cb108-544"><a href="#cb108-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-545"><a href="#cb108-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r st_within}</span></span>
<span id="cb108-546"><a href="#cb108-546" aria-hidden="true" tabindex="-1"></a><span class="in">counties_within_hpa &lt;- KS_counties[hpa_cropped_to_KS, op = st_within]</span></span>
<span id="cb108-547"><a href="#cb108-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-548"><a href="#cb108-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-549"><a href="#cb108-549" aria-hidden="true" tabindex="-1"></a>@fig-within-subset shows the resulting set of counties.</span>
<span id="cb108-550"><a href="#cb108-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-553"><a href="#cb108-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-554"><a href="#cb108-554" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-within-subset</span></span>
<span id="cb108-555"><a href="#cb108-555" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Kansas counties that are completely within the HPA boundary"</span></span>
<span id="cb108-556"><a href="#cb108-556" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-557"><a href="#cb108-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-558"><a href="#cb108-558" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-559"><a href="#cb108-559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> counties_within_hpa) <span class="sc">+</span></span>
<span id="cb108-560"><a href="#cb108-560" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-561"><a href="#cb108-561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-562"><a href="#cb108-562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-563"><a href="#cb108-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-564"><a href="#cb108-564" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb108-565"><a href="#cb108-565" aria-hidden="true" tabindex="-1"></a><span class="co">#%%%%%%%%%%%%%%%%%%%%%</span></span>
<span id="cb108-566"><a href="#cb108-566" aria-hidden="true" tabindex="-1"></a><span class="co"># Points vs Polygons </span></span>
<span id="cb108-567"><a href="#cb108-567" aria-hidden="true" tabindex="-1"></a><span class="co">#%%%%%%%%%%%%%%%%%%%%%</span></span>
<span id="cb108-568"><a href="#cb108-568" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb108-569"><a href="#cb108-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-570"><a href="#cb108-570" aria-hidden="true" tabindex="-1"></a><span class="fu">### points (source) vs polygons (target)</span></span>
<span id="cb108-571"><a href="#cb108-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-572"><a href="#cb108-572" aria-hidden="true" tabindex="-1"></a>The following map (@fig-map-wells-county) shows the Kansas portion of the HPA and all the irrigation wells in Kansas. We can select only wells that reside within the HPA boundary using the same syntax as the above example.</span>
<span id="cb108-573"><a href="#cb108-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-576"><a href="#cb108-576" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-577"><a href="#cb108-577" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-wells-county</span></span>
<span id="cb108-578"><a href="#cb108-578" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "A map of Kansas irrigation wells and HPA"</span></span>
<span id="cb108-579"><a href="#cb108-579" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-580"><a href="#cb108-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-581"><a href="#cb108-581" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-582"><a href="#cb108-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-583"><a href="#cb108-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb108-584"><a href="#cb108-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-585"><a href="#cb108-585" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-586"><a href="#cb108-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-587"><a href="#cb108-587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wells_hpa}</span></span>
<span id="cb108-588"><a href="#cb108-588" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells_in_hpa &lt;- KS_wells[hpa_cropped_to_KS, ]</span></span>
<span id="cb108-589"><a href="#cb108-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-590"><a href="#cb108-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-591"><a href="#cb108-591" aria-hidden="true" tabindex="-1"></a>As you can see in @fig-map-wells-in-hpa below, only the wells that are inside (or intersect with) the HPA remained because the default topological relation is <span class="in">`sf::st_intersects()`</span>.</span>
<span id="cb108-592"><a href="#cb108-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-595"><a href="#cb108-595" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-596"><a href="#cb108-596" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-wells-in-hpa</span></span>
<span id="cb108-597"><a href="#cb108-597" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "A map of Kansas irrigation wells and HPA"</span></span>
<span id="cb108-598"><a href="#cb108-598" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-599"><a href="#cb108-599" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-600"><a href="#cb108-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hpa_cropped_to_KS, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-601"><a href="#cb108-601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_in_hpa, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb108-602"><a href="#cb108-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-603"><a href="#cb108-603" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-604"><a href="#cb108-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-605"><a href="#cb108-605" aria-hidden="true" tabindex="-1"></a>If you want to flag wells that intersect with HPA, use the following approach:</span>
<span id="cb108-606"><a href="#cb108-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-607"><a href="#cb108-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r well_hpa_flag}</span></span>
<span id="cb108-608"><a href="#cb108-608" aria-hidden="true" tabindex="-1"></a><span class="in">site_list &lt;- KS_wells_in_hpa$site</span></span>
<span id="cb108-609"><a href="#cb108-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-610"><a href="#cb108-610" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-611"><a href="#cb108-611" aria-hidden="true" tabindex="-1"></a><span class="in">  KS_wells &lt;- dplyr::mutate(KS_wells, in_hpa = ifelse(site %in% site_list, TRUE, FALSE))</span></span>
<span id="cb108-612"><a href="#cb108-612" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-613"><a href="#cb108-613" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-614"><a href="#cb108-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-615"><a href="#cb108-615" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb108-616"><a href="#cb108-616" aria-hidden="true" tabindex="-1"></a><span class="co">#%%%%%%%%%%%%%%%%%%%%%</span></span>
<span id="cb108-617"><a href="#cb108-617" aria-hidden="true" tabindex="-1"></a><span class="co"># Lines vs Polygons </span></span>
<span id="cb108-618"><a href="#cb108-618" aria-hidden="true" tabindex="-1"></a><span class="co">#%%%%%%%%%%%%%%%%%%%%%</span></span>
<span id="cb108-619"><a href="#cb108-619" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb108-620"><a href="#cb108-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-621"><a href="#cb108-621" aria-hidden="true" tabindex="-1"></a><span class="fu">### lines (source) vs polygons (target) {#sec-lines_polygons}</span></span>
<span id="cb108-622"><a href="#cb108-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-623"><a href="#cb108-623" aria-hidden="true" tabindex="-1"></a>@fig-map-lines-county shows the Kansas counties (in red) and U.S. railroads in the Mid West region(in blue).</span>
<span id="cb108-624"><a href="#cb108-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-625"><a href="#cb108-625" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-628"><a href="#cb108-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-629"><a href="#cb108-629" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "U.S. railroads and Kansas county boundaries"</span></span>
<span id="cb108-630"><a href="#cb108-630" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-lines-county</span></span>
<span id="cb108-631"><a href="#cb108-631" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb108-632"><a href="#cb108-632" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb108-633"><a href="#cb108-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-634"><a href="#cb108-634" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-635"><a href="#cb108-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb108-636"><a href="#cb108-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rail_roads_mw, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-637"><a href="#cb108-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-638"><a href="#cb108-638" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-639"><a href="#cb108-639" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-640"><a href="#cb108-640" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span>  </span>
<span id="cb108-641"><a href="#cb108-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-642"><a href="#cb108-642" aria-hidden="true" tabindex="-1"></a>We can select only the railroads that intersect with Kansas.</span>
<span id="cb108-643"><a href="#cb108-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-644"><a href="#cb108-644" aria-hidden="true" tabindex="-1"></a><span class="in">```{r railroads_ks_county}</span></span>
<span id="cb108-645"><a href="#cb108-645" aria-hidden="true" tabindex="-1"></a><span class="in">railroads_KS &lt;- rail_roads_mw[KS_counties, ]</span></span>
<span id="cb108-646"><a href="#cb108-646" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-647"><a href="#cb108-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-648"><a href="#cb108-648" aria-hidden="true" tabindex="-1"></a>As you can see in @fig-map-rail-ks below, only the railroads that intersect with Kansas were selected. Note the lines that go beyond the Kansas boundary are also selected. Remember, the default is <span class="in">`sf::st_intersect()`</span>. </span>
<span id="cb108-649"><a href="#cb108-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-652"><a href="#cb108-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-653"><a href="#cb108-653" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-rail-ks</span></span>
<span id="cb108-654"><a href="#cb108-654" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Railroads that intersect Kansas county boundaries"</span></span>
<span id="cb108-655"><a href="#cb108-655" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-656"><a href="#cb108-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-657"><a href="#cb108-657" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(railroads_KS) <span class="sc">+</span></span>
<span id="cb108-658"><a href="#cb108-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">col =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb108-659"><a href="#cb108-659" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(KS_counties) <span class="sc">+</span></span>
<span id="cb108-660"><a href="#cb108-660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="dv">0</span>)  <span class="sc">+</span></span>
<span id="cb108-661"><a href="#cb108-661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">frame =</span> <span class="cn">FALSE</span>) </span>
<span id="cb108-662"><a href="#cb108-662" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-663"><a href="#cb108-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-664"><a href="#cb108-664" aria-hidden="true" tabindex="-1"></a>If you would like the lines beyond the state boundary to be cut out but the intersecting parts of those lines to remain, use <span class="in">`sf::st_intersection()`</span>, which is explained in @sec-st-intersection.</span>
<span id="cb108-665"><a href="#cb108-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-666"><a href="#cb108-666" aria-hidden="true" tabindex="-1"></a>If you want to flag railroads that intersect with Kansas counties in <span class="in">`railroads`</span>, use the following approach:</span>
<span id="cb108-667"><a href="#cb108-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-668"><a href="#cb108-668" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lines_ks_flag}</span></span>
<span id="cb108-669"><a href="#cb108-669" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the list of lines ---#</span></span>
<span id="cb108-670"><a href="#cb108-670" aria-hidden="true" tabindex="-1"></a><span class="in">lines_list &lt;- railroads_KS$LINEARID</span></span>
<span id="cb108-671"><a href="#cb108-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-672"><a href="#cb108-672" aria-hidden="true" tabindex="-1"></a><span class="in">#--- railroads ---#</span></span>
<span id="cb108-673"><a href="#cb108-673" aria-hidden="true" tabindex="-1"></a><span class="in">rail_roads_mw &lt;- dplyr::mutate(rail_roads_mw, intersect_ks = ifelse(LINEARID %in% lines_list, TRUE, FALSE))</span></span>
<span id="cb108-674"><a href="#cb108-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-675"><a href="#cb108-675" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb108-676"><a href="#cb108-676" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::select(rail_roads_mw, LINEARID, intersect_ks)</span></span>
<span id="cb108-677"><a href="#cb108-677" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-678"><a href="#cb108-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-679"><a href="#cb108-679" aria-hidden="true" tabindex="-1"></a><span class="fu">### polygons (source) vs points (target) {#sec-polygons_points}</span></span>
<span id="cb108-680"><a href="#cb108-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-681"><a href="#cb108-681" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-684"><a href="#cb108-684" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-685"><a href="#cb108-685" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-county-point</span></span>
<span id="cb108-686"><a href="#cb108-686" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Kansas county boundaries and wells that overlie the HPA"</span></span>
<span id="cb108-687"><a href="#cb108-687" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-688"><a href="#cb108-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-689"><a href="#cb108-689" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-690"><a href="#cb108-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb108-691"><a href="#cb108-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_in_hpa, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-692"><a href="#cb108-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-693"><a href="#cb108-693" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-694"><a href="#cb108-694" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-695"><a href="#cb108-695" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-696"><a href="#cb108-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-697"><a href="#cb108-697" aria-hidden="true" tabindex="-1"></a>@fig-map-county-point shows the Kansas counties and irrigation wells in Kansas that overlie HPA. We can select only the counties that intersect with at least one well.</span>
<span id="cb108-698"><a href="#cb108-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-699"><a href="#cb108-699" aria-hidden="true" tabindex="-1"></a><span class="in">```{r counties_wells}</span></span>
<span id="cb108-700"><a href="#cb108-700" aria-hidden="true" tabindex="-1"></a><span class="in">KS_counties_intersected &lt;- KS_counties[KS_wells_in_hpa, ]  </span></span>
<span id="cb108-701"><a href="#cb108-701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-702"><a href="#cb108-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-703"><a href="#cb108-703" aria-hidden="true" tabindex="-1"></a>As you can see in @fig-subset-county-point below, only the counties that intersect with at least one well remained.</span>
<span id="cb108-704"><a href="#cb108-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-707"><a href="#cb108-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-708"><a href="#cb108-708" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-subset-county-point</span></span>
<span id="cb108-709"><a href="#cb108-709" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Counties that have at least one well"</span></span>
<span id="cb108-710"><a href="#cb108-710" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-711"><a href="#cb108-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-712"><a href="#cb108-712" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-713"><a href="#cb108-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb108-714"><a href="#cb108-714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties_intersected, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb108-715"><a href="#cb108-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_in_hpa, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-716"><a href="#cb108-716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-717"><a href="#cb108-717" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-718"><a href="#cb108-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-719"><a href="#cb108-719" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial join {#sec-sp-join}</span></span>
<span id="cb108-720"><a href="#cb108-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-721"><a href="#cb108-721" aria-hidden="true" tabindex="-1"></a>A spatial join refers to spatial operations that involve the following steps:</span>
<span id="cb108-722"><a href="#cb108-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-723"><a href="#cb108-723" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Overlay one spatial layer (target layer) onto another (source layer).</span>
<span id="cb108-724"><a href="#cb108-724" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>For each observation in the target layer:</span>
<span id="cb108-725"><a href="#cb108-725" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Identify which objects in the source layer it geographically intersects with (or has another specified topological relationship).</span>
<span id="cb108-726"><a href="#cb108-726" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Extract values associated with the intersecting objects in the source layer, summarizing if necessary.</span>
<span id="cb108-727"><a href="#cb108-727" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Assign the extracted values to the corresponding objects in the target layer.</span>
<span id="cb108-728"><a href="#cb108-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-729"><a href="#cb108-729" aria-hidden="true" tabindex="-1"></a>We can classify spatial join into four categories by the type of the underlying spatial objects:</span>
<span id="cb108-730"><a href="#cb108-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-731"><a href="#cb108-731" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**vector-vector**: vector data (target) against vector data (source)</span>
<span id="cb108-732"><a href="#cb108-732" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**vector-raster**: vector data (target) against raster data (source)</span>
<span id="cb108-733"><a href="#cb108-733" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**raster-vector**: raster data (target) against vector data (source)</span>
<span id="cb108-734"><a href="#cb108-734" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**raster-raster**: raster data (target) against raster data (source)</span>
<span id="cb108-735"><a href="#cb108-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-736"><a href="#cb108-736" aria-hidden="true" tabindex="-1"></a>Among these four types, our focus here is on the first case, **vector-vector**. The second case will be discussed in @sec-int-RV. The third and fourth cases are not covered in this book, as the target data is almost always vector data (e.g., cities or farm fields as points, political boundaries as polygons, etc.).</span>
<span id="cb108-737"><a href="#cb108-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-738"><a href="#cb108-738" aria-hidden="true" tabindex="-1"></a>The **vector-vector** category can be further divided into subcategories depending on the type of spatial object: point, line, or polygon. In this context, we will exclude spatial joins involving lines. This is because line objects are rarely used as observation units in subsequent analyses or as the source data for extracting values.^<span class="co">[</span><span class="ot">For example, in @sec-demo-railroad, we did not extract any attribute values from the railroads. Instead, we calculated the travel length of the railroads, meaning the geometry of the railroads was of interest rather than the values associated with them.</span><span class="co">]</span></span>
<span id="cb108-739"><a href="#cb108-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-740"><a href="#cb108-740" aria-hidden="true" tabindex="-1"></a>Below is a list of the types of spatial joins we will cover:</span>
<span id="cb108-741"><a href="#cb108-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-742"><a href="#cb108-742" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>points (target) against polygons (source)</span>
<span id="cb108-743"><a href="#cb108-743" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>polygons (target) against points (source)</span>
<span id="cb108-744"><a href="#cb108-744" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>polygons (target) against polygons (source)</span>
<span id="cb108-745"><a href="#cb108-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-746"><a href="#cb108-746" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb108-747"><a href="#cb108-747" aria-hidden="true" tabindex="-1"></a><span class="co">#=========================================</span></span>
<span id="cb108-748"><a href="#cb108-748" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial Joining </span></span>
<span id="cb108-749"><a href="#cb108-749" aria-hidden="true" tabindex="-1"></a><span class="co">#=========================================</span></span>
<span id="cb108-750"><a href="#cb108-750" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb108-751"><a href="#cb108-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-752"><a href="#cb108-752" aria-hidden="true" tabindex="-1"></a><span class="fu">### Syntax</span></span>
<span id="cb108-753"><a href="#cb108-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-754"><a href="#cb108-754" aria-hidden="true" tabindex="-1"></a>To perform spatial join, we can use the <span class="in">`sf::st_join()`</span> function, with the following syntax:</span>
<span id="cb108-755"><a href="#cb108-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-756"><a href="#cb108-756" aria-hidden="true" tabindex="-1"></a><span class="in">```{r syntax_st_join, eval = FALSE}</span></span>
<span id="cb108-757"><a href="#cb108-757" aria-hidden="true" tabindex="-1"></a><span class="in">#--- this does not run ---#</span></span>
<span id="cb108-758"><a href="#cb108-758" aria-hidden="true" tabindex="-1"></a><span class="in">sf::st_join(target_sf, source_sf)</span></span>
<span id="cb108-759"><a href="#cb108-759" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-760"><a href="#cb108-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-761"><a href="#cb108-761" aria-hidden="true" tabindex="-1"></a>Similar to spatial subsetting, the default topological relation is <span class="in">`sf::st_intersects()`</span>.</span>
<span id="cb108-762"><a href="#cb108-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-763"><a href="#cb108-763" aria-hidden="true" tabindex="-1"></a><span class="fu">### Case 1: points (target) vs polygons (source)</span></span>
<span id="cb108-764"><a href="#cb108-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-765"><a href="#cb108-765" aria-hidden="true" tabindex="-1"></a>In this case, for each observation (point) in the target data, it identifies which polygon in the source data it intersects with and then assigns the value associated with the polygon to the point.^<span class="co">[</span><span class="ot">A practical example of this case is shown in Demonstration 1 of @sec-demo.</span><span class="co">]</span></span>
<span id="cb108-766"><a href="#cb108-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-767"><a href="#cb108-767" aria-hidden="true" tabindex="-1"></a>We use the Kansas irrigation well data (points) and Kansas county boundary data (polygons) for a demonstration. Our goal is to assign the county-level corn price information from the Kansas county data to wells. First let me create and add a fake county-level corn price variable to the Kansas county data.</span>
<span id="cb108-768"><a href="#cb108-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-769"><a href="#cb108-769" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create_corn_price}</span></span>
<span id="cb108-770"><a href="#cb108-770" aria-hidden="true" tabindex="-1"></a><span class="in">KS_corn_price &lt;-</span></span>
<span id="cb108-771"><a href="#cb108-771" aria-hidden="true" tabindex="-1"></a><span class="in">  KS_counties %&gt;%</span></span>
<span id="cb108-772"><a href="#cb108-772" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(corn_price = seq(3.2, 3.9, length = nrow(.))) %&gt;%</span></span>
<span id="cb108-773"><a href="#cb108-773" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(COUNTYFP, corn_price)</span></span>
<span id="cb108-774"><a href="#cb108-774" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-775"><a href="#cb108-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-776"><a href="#cb108-776" aria-hidden="true" tabindex="-1"></a>@fig-map-corn-price presents Kansas counties color-differentiated by the fake corn price.</span>
<span id="cb108-777"><a href="#cb108-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-778"><a href="#cb108-778" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-781"><a href="#cb108-781" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-782"><a href="#cb108-782" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-corn-price</span></span>
<span id="cb108-783"><a href="#cb108-783" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of county-level fake corn price" </span></span>
<span id="cb108-784"><a href="#cb108-784" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-785"><a href="#cb108-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-786"><a href="#cb108-786" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(KS_corn_price) <span class="sc">+</span></span>
<span id="cb108-787"><a href="#cb108-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> corn_price)) <span class="sc">+</span></span>
<span id="cb108-788"><a href="#cb108-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb108-789"><a href="#cb108-789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-790"><a href="#cb108-790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-791"><a href="#cb108-791" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-792"><a href="#cb108-792" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-793"><a href="#cb108-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-794"><a href="#cb108-794" aria-hidden="true" tabindex="-1"></a>For this particular context, the following code will do the job: </span>
<span id="cb108-795"><a href="#cb108-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-796"><a href="#cb108-796" aria-hidden="true" tabindex="-1"></a><span class="in">```{r st_join_KS}</span></span>
<span id="cb108-797"><a href="#cb108-797" aria-hidden="true" tabindex="-1"></a><span class="in">#--- spatial join ---#</span></span>
<span id="cb108-798"><a href="#cb108-798" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-799"><a href="#cb108-799" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells_County &lt;- sf::st_join(KS_wells, KS_corn_price)</span></span>
<span id="cb108-800"><a href="#cb108-800" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-801"><a href="#cb108-801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-802"><a href="#cb108-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-803"><a href="#cb108-803" aria-hidden="true" tabindex="-1"></a>You can see from @fig-map-corn-wells that all the wells inside the same county have the same corn price value.</span>
<span id="cb108-804"><a href="#cb108-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-805"><a href="#cb108-805" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-806"><a href="#cb108-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-807"><a href="#cb108-807" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-808"><a href="#cb108-808" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-811"><a href="#cb108-811" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-812"><a href="#cb108-812" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-corn-wells</span></span>
<span id="cb108-813"><a href="#cb108-813" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of wells color-differentiated by corn price"</span></span>
<span id="cb108-814"><a href="#cb108-814" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-815"><a href="#cb108-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-816"><a href="#cb108-816" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-817"><a href="#cb108-817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties) <span class="sc">+</span></span>
<span id="cb108-818"><a href="#cb108-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells_County, <span class="fu">aes</span>(<span class="at">color =</span> corn_price)) <span class="sc">+</span></span>
<span id="cb108-819"><a href="#cb108-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb108-820"><a href="#cb108-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-821"><a href="#cb108-821" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-822"><a href="#cb108-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-823"><a href="#cb108-823" aria-hidden="true" tabindex="-1"></a>We can also confirm that the <span class="in">`corn_price`</span> value associated with all the wells in a single county is identical with the <span class="in">`corn_price`</span> value associated with that county in the original corn price data (<span class="in">`KS_corn_price`</span>).</span>
<span id="cb108-824"><a href="#cb108-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-827"><a href="#cb108-827" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-828"><a href="#cb108-828" aria-hidden="true" tabindex="-1"></a>KS_wells_County <span class="sc">%&gt;%</span></span>
<span id="cb108-829"><a href="#cb108-829" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(COUNTYFP <span class="sc">==</span> <span class="st">"069"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb108-830"><a href="#cb108-830" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(corn_price) <span class="sc">%&gt;%</span></span>
<span id="cb108-831"><a href="#cb108-831" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb108-832"><a href="#cb108-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-833"><a href="#cb108-833" aria-hidden="true" tabindex="-1"></a>KS_corn_price <span class="sc">%&gt;%</span></span>
<span id="cb108-834"><a href="#cb108-834" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(COUNTYFP <span class="sc">==</span> <span class="st">"069"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb108-835"><a href="#cb108-835" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(corn_price)</span>
<span id="cb108-836"><a href="#cb108-836" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-837"><a href="#cb108-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-838"><a href="#cb108-838" aria-hidden="true" tabindex="-1"></a><span class="fu">### Case 2: polygons (target) vs points (source) {#sec-polygons-points}</span></span>
<span id="cb108-839"><a href="#cb108-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-840"><a href="#cb108-840" aria-hidden="true" tabindex="-1"></a>In this case, for each observation (polygon) in the target data, it identifies which observations (points) in the source data intersect with it, and then assigns the values associated with those points to the polygon (A practical example of this case is shown in Demonstration 2 of @sec-demo.).</span>
<span id="cb108-841"><a href="#cb108-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-842"><a href="#cb108-842" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-845"><a href="#cb108-845" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-846"><a href="#cb108-846" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-wells-county-gw</span></span>
<span id="cb108-847"><a href="#cb108-847" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of wells color-differentiated by corn price"</span></span>
<span id="cb108-848"><a href="#cb108-848" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-849"><a href="#cb108-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-850"><a href="#cb108-850" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-851"><a href="#cb108-851" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_counties) <span class="sc">+</span></span>
<span id="cb108-852"><a href="#cb108-852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> KS_wells, <span class="fu">aes</span>(<span class="at">color =</span> af_used), <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb108-853"><a href="#cb108-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">name =</span> <span class="st">"Groundwater Pumping (acre-feet)"</span>) <span class="sc">+</span></span>
<span id="cb108-854"><a href="#cb108-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb108-855"><a href="#cb108-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb108-856"><a href="#cb108-856" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-857"><a href="#cb108-857" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-858"><a href="#cb108-858" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-859"><a href="#cb108-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-860"><a href="#cb108-860" aria-hidden="true" tabindex="-1"></a>For instance, if you are conducting a county-level analysis and want to calculate the total groundwater pumping for each county, the target data would be <span class="in">`KS_counties`</span>, and the source data would be <span class="in">`KS_wells`</span> (@fig-wells-county-gw).</span>
<span id="cb108-861"><a href="#cb108-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-862"><a href="#cb108-862" aria-hidden="true" tabindex="-1"></a><span class="in">```{r st_join_polygon_point}</span></span>
<span id="cb108-863"><a href="#cb108-863" aria-hidden="true" tabindex="-1"></a><span class="in">#--- spatial join ---#</span></span>
<span id="cb108-864"><a href="#cb108-864" aria-hidden="true" tabindex="-1"></a><span class="in">KS_County_wells &lt;- sf::st_join(KS_counties, KS_wells)</span></span>
<span id="cb108-865"><a href="#cb108-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-866"><a href="#cb108-866" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb108-867"><a href="#cb108-867" aria-hidden="true" tabindex="-1"></a><span class="in">dplyr::select(KS_County_wells, COUNTYFP, site, af_used)</span></span>
<span id="cb108-868"><a href="#cb108-868" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-869"><a href="#cb108-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-870"><a href="#cb108-870" aria-hidden="true" tabindex="-1"></a>As seen in the resulting dataset, each unique polygon-point intersection forms an observation. For each polygon, there will be as many observations as there are wells intersecting with that polygon. After joining the two layers, you can calculate statistics for each polygon (in this case, each county). Since the goal is to calculate groundwater extraction by county, the following code will accomplish this:</span>
<span id="cb108-871"><a href="#cb108-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-872"><a href="#cb108-872" aria-hidden="true" tabindex="-1"></a><span class="in">```{r summary_after_join}</span></span>
<span id="cb108-873"><a href="#cb108-873" aria-hidden="true" tabindex="-1"></a><span class="in">KS_County_wells %&gt;% </span></span>
<span id="cb108-874"><a href="#cb108-874" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::group_by(COUNTYFP) %&gt;% </span></span>
<span id="cb108-875"><a href="#cb108-875" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::summarize(af_used = sum(af_used, na.rm = TRUE)) </span></span>
<span id="cb108-876"><a href="#cb108-876" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-877"><a href="#cb108-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-878"><a href="#cb108-878" aria-hidden="true" tabindex="-1"></a>It is just as easy to get other types of statistics by simply modifying the <span class="in">`dplyr::summarize()`</span> part.</span>
<span id="cb108-879"><a href="#cb108-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-880"><a href="#cb108-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-881"><a href="#cb108-881" aria-hidden="true" tabindex="-1"></a><span class="fu">### Case 3: polygons (target) vs polygons (source) {#sec-polygon-polygon}</span></span>
<span id="cb108-882"><a href="#cb108-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-883"><a href="#cb108-883" aria-hidden="true" tabindex="-1"></a>In this case, <span class="in">`sf::st_join(target_sf, source_sf)`</span> returns all the unique polygon-polygon intersections, with the attributes from <span class="in">`source_sf`</span> attached to the intersecting polygons.</span>
<span id="cb108-884"><a href="#cb108-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-885"><a href="#cb108-885" aria-hidden="true" tabindex="-1"></a>We will use county-level corn acres data in Iowa for 2018 from USDA NASS^<span class="co">[</span><span class="ot">See @sec-nass-quick for instructions on downloading Quick Stats data from within R.</span><span class="co">]</span> and Hydrologic Units. Our objective is to estimate corn acres by HUC units based on county-level corn acres data.^<span class="co">[</span><span class="ot">There will be substantial measurement errors because the source polygons (corn acres by county) are large compared to the target polygons (HUC units). However, this serves as a useful illustration of a polygon-polygon join.</span><span class="co">]</span></span>
<span id="cb108-886"><a href="#cb108-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-887"><a href="#cb108-887" aria-hidden="true" tabindex="-1"></a>We first import the Iowa corn acre data (@fig-map-IA-corn is the map of Iowa counties color-differentiated by corn acres): </span>
<span id="cb108-888"><a href="#cb108-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-889"><a href="#cb108-889" aria-hidden="true" tabindex="-1"></a><span class="in">```{r IA_corn_data}</span></span>
<span id="cb108-890"><a href="#cb108-890" aria-hidden="true" tabindex="-1"></a><span class="in">#--- IA boundary ---#</span></span>
<span id="cb108-891"><a href="#cb108-891" aria-hidden="true" tabindex="-1"></a><span class="in">IA_corn &lt;- readRDS("Data/IA_corn.rds")</span></span>
<span id="cb108-892"><a href="#cb108-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-893"><a href="#cb108-893" aria-hidden="true" tabindex="-1"></a><span class="in">#--- take a look ---#</span></span>
<span id="cb108-894"><a href="#cb108-894" aria-hidden="true" tabindex="-1"></a><span class="in">IA_corn</span></span>
<span id="cb108-895"><a href="#cb108-895" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-896"><a href="#cb108-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-897"><a href="#cb108-897" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-900"><a href="#cb108-900" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-901"><a href="#cb108-901" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map-IA-corn</span></span>
<span id="cb108-902"><a href="#cb108-902" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of Iowa counties color-differentiated by corn planted acreage"</span></span>
<span id="cb108-903"><a href="#cb108-903" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-904"><a href="#cb108-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-905"><a href="#cb108-905" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(IA_corn) <span class="sc">+</span></span>
<span id="cb108-906"><a href="#cb108-906" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> acres)) <span class="sc">+</span></span>
<span id="cb108-907"><a href="#cb108-907" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb108-908"><a href="#cb108-908" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-909"><a href="#cb108-909" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-910"><a href="#cb108-910" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-911"><a href="#cb108-911" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-912"><a href="#cb108-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-913"><a href="#cb108-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-914"><a href="#cb108-914" aria-hidden="true" tabindex="-1"></a>Now import the HUC units data (@fig-HUC-map presents the map of HUC units):</span>
<span id="cb108-915"><a href="#cb108-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-916"><a href="#cb108-916" aria-hidden="true" tabindex="-1"></a><span class="in">```{r HUC_import, results = "hide"}</span></span>
<span id="cb108-917"><a href="#cb108-917" aria-hidden="true" tabindex="-1"></a><span class="in">#--- import HUC units ---#</span></span>
<span id="cb108-918"><a href="#cb108-918" aria-hidden="true" tabindex="-1"></a><span class="in">HUC_IA &lt;- </span></span>
<span id="cb108-919"><a href="#cb108-919" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_read("Data/huc250k.shp") %&gt;% </span></span>
<span id="cb108-920"><a href="#cb108-920" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(HUC_CODE) %&gt;% </span></span>
<span id="cb108-921"><a href="#cb108-921" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- reproject to the CRS of IA ---#</span></span>
<span id="cb108-922"><a href="#cb108-922" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(st_crs(IA_corn)) %&gt;% </span></span>
<span id="cb108-923"><a href="#cb108-923" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- select HUC units that overlaps with IA ---#</span></span>
<span id="cb108-924"><a href="#cb108-924" aria-hidden="true" tabindex="-1"></a><span class="in">  .[IA_corn, ]</span></span>
<span id="cb108-925"><a href="#cb108-925" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-926"><a href="#cb108-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-927"><a href="#cb108-927" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-930"><a href="#cb108-930" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-931"><a href="#cb108-931" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-HUC-map</span></span>
<span id="cb108-932"><a href="#cb108-932" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of HUC units that intersect with Iowa state boundary"</span></span>
<span id="cb108-933"><a href="#cb108-933" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true  </span></span>
<span id="cb108-934"><a href="#cb108-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-935"><a href="#cb108-935" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(HUC_IA) <span class="sc">+</span> </span>
<span id="cb108-936"><a href="#cb108-936" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb108-937"><a href="#cb108-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-938"><a href="#cb108-938" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-939"><a href="#cb108-939" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-940"><a href="#cb108-940" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-941"><a href="#cb108-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-942"><a href="#cb108-942" aria-hidden="true" tabindex="-1"></a>@fig-HUC-county-map presents a map of Iowa counties superimposed on the HUC units:</span>
<span id="cb108-943"><a href="#cb108-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-946"><a href="#cb108-946" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-947"><a href="#cb108-947" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-HUC-county-map</span></span>
<span id="cb108-948"><a href="#cb108-948" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of HUC units superimposed on the counties in Iowas"</span></span>
<span id="cb108-949"><a href="#cb108-949" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-950"><a href="#cb108-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-951"><a href="#cb108-951" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-952"><a href="#cb108-952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> HUC_IA) <span class="sc">+</span></span>
<span id="cb108-953"><a href="#cb108-953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> IA_corn, <span class="fu">aes</span>(<span class="at">fill =</span> acres), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb108-954"><a href="#cb108-954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb108-955"><a href="#cb108-955" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-956"><a href="#cb108-956" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-957"><a href="#cb108-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-958"><a href="#cb108-958" aria-hidden="true" tabindex="-1"></a>Spatial join using <span class="in">`sf::st_join()`</span> will produce the following: </span>
<span id="cb108-959"><a href="#cb108-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-960"><a href="#cb108-960" aria-hidden="true" tabindex="-1"></a><span class="in">```{r join_HUC_acres}</span></span>
<span id="cb108-961"><a href="#cb108-961" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-962"><a href="#cb108-962" aria-hidden="true" tabindex="-1"></a><span class="in">HUC_joined &lt;- sf::st_join(HUC_IA, IA_corn)</span></span>
<span id="cb108-963"><a href="#cb108-963" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-964"><a href="#cb108-964" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-965"><a href="#cb108-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-966"><a href="#cb108-966" aria-hidden="true" tabindex="-1"></a>Each intersecting HUC-county combination becomes a separate observation, with the resulting geometry being the same as that of the HUC unit. To illustrate this, let's take a closer look at one of the HUC units. The HUC unit with <span class="in">`HUC_CODE ==10170203`</span> intersects with four County.</span>
<span id="cb108-967"><a href="#cb108-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-968"><a href="#cb108-968" aria-hidden="true" tabindex="-1"></a><span class="in">```{r filter_the_first_one}</span></span>
<span id="cb108-969"><a href="#cb108-969" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the HUC unit with `HUC_CODE ==10170203`  ---#</span></span>
<span id="cb108-970"><a href="#cb108-970" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-971"><a href="#cb108-971" aria-hidden="true" tabindex="-1"></a><span class="in">temp_HUC_county &lt;- filter(HUC_joined, HUC_CODE == 10170203)</span></span>
<span id="cb108-972"><a href="#cb108-972" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-973"><a href="#cb108-973" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-974"><a href="#cb108-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-975"><a href="#cb108-975" aria-hidden="true" tabindex="-1"></a>All of the four observations in <span class="in">`temp_HUC_county`</span> has the identical geometry (@fig-identical-geometry shows this visually.).</span>
<span id="cb108-976"><a href="#cb108-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-979"><a href="#cb108-979" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-980"><a href="#cb108-980" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(temp_HUC_county<span class="sc">$</span>geometry))</span>
<span id="cb108-981"><a href="#cb108-981" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-982"><a href="#cb108-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-983"><a href="#cb108-983" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-986"><a href="#cb108-986" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-987"><a href="#cb108-987" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-identical-geometry</span></span>
<span id="cb108-988"><a href="#cb108-988" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Geoemetry of the four observations in the joined object"</span></span>
<span id="cb108-989"><a href="#cb108-989" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb108-990"><a href="#cb108-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-991"><a href="#cb108-991" aria-hidden="true" tabindex="-1"></a>temp_HUC_county <span class="sc">%&gt;%</span></span>
<span id="cb108-992"><a href="#cb108-992" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">county_text =</span> <span class="fu">paste0</span>(<span class="st">"County Code: "</span>, county_code)) <span class="sc">%&gt;%</span></span>
<span id="cb108-993"><a href="#cb108-993" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(.) <span class="sc">+</span></span>
<span id="cb108-994"><a href="#cb108-994" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb108-995"><a href="#cb108-995" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(county_text <span class="sc">~</span> ., <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb108-996"><a href="#cb108-996" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-997"><a href="#cb108-997" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-998"><a href="#cb108-998" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-999"><a href="#cb108-999" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-1000"><a href="#cb108-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1001"><a href="#cb108-1001" aria-hidden="true" tabindex="-1"></a>Moreover, they are identical with the geometry of the intersecting HUC unit (the HUC unit with <span class="in">`HUC_CODE ==10170203`</span>):</span>
<span id="cb108-1002"><a href="#cb108-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1005"><a href="#cb108-1005" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-1006"><a href="#cb108-1006" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(</span>
<span id="cb108-1007"><a href="#cb108-1007" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- geometry of the one of the observations from the joined object ---#</span></span>
<span id="cb108-1008"><a href="#cb108-1008" aria-hidden="true" tabindex="-1"></a>  temp_HUC_county[<span class="dv">1</span>, ]<span class="sc">$</span>geometry,</span>
<span id="cb108-1009"><a href="#cb108-1009" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- original HUC geometry ---#</span></span>
<span id="cb108-1010"><a href="#cb108-1010" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(HUC_IA, HUC_CODE <span class="sc">==</span> <span class="dv">10170203</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(geometry)</span>
<span id="cb108-1011"><a href="#cb108-1011" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb108-1012"><a href="#cb108-1012" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1013"><a href="#cb108-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1014"><a href="#cb108-1014" aria-hidden="true" tabindex="-1"></a>So, all four observations have identical geometry, which corresponds to the geometry of the HUC unit. This indicates that <span class="in">`sf::st_join()`</span> does not retain information about the extent of the intersection between the HUC unit and the four counties. Keep in mind that the default behavior uses <span class="in">`sf::st_intersects()`</span>, which only checks whether the spatial objects intersect, without providing further details.</span>
<span id="cb108-1015"><a href="#cb108-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1016"><a href="#cb108-1016" aria-hidden="true" tabindex="-1"></a>If you are calculating a simple average of corn acres and are not concerned with the degree of spatial overlap, this method works just fine. However, if you want to compute an area-weighted average, the information provided is insufficient. You will learn how to calculate the area-weighted average in the next subsection.</span>
<span id="cb108-1017"><a href="#cb108-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1018"><a href="#cb108-1018" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial join and summary in one step</span></span>
<span id="cb108-1019"><a href="#cb108-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1020"><a href="#cb108-1020" aria-hidden="true" tabindex="-1"></a>In @sec-polygons-points, we first joined <span class="in">`KS_counties`</span> and <span class="in">`KS_wells`</span> uusing <span class="in">`sf::st_join()`</span> and then applied <span class="in">`dplyr::summarize()`</span> to find total groundwater use per county. This two-step procedure can be done in one step using <span class="in">`aggregate()`</span> with the summarizing function specified for the <span class="in">`FUN`</span> option.</span>
<span id="cb108-1021"><a href="#cb108-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1024"><a href="#cb108-1024" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-1025"><a href="#cb108-1025" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb108-1026"><a href="#cb108-1026" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(source layer, target layer, <span class="at">FUN =</span> <span class="cf">function</span>)</span>
<span id="cb108-1027"><a href="#cb108-1027" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1028"><a href="#cb108-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1029"><a href="#cb108-1029" aria-hidden="true" tabindex="-1"></a>Since we are trying to find total groundwater use for each county, the target layer is <span class="in">`KS_counties`</span>, the source layer is <span class="in">`KS_wells`</span>, which has <span class="in">`af_used`</span>, and the function to summarize is <span class="in">`sum()`</span>. So, the following code will replicate what we just did above:</span>
<span id="cb108-1030"><a href="#cb108-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1031"><a href="#cb108-1031" aria-hidden="true" tabindex="-1"></a><span class="in">```{r demo_aggregate}</span></span>
<span id="cb108-1032"><a href="#cb108-1032" aria-hidden="true" tabindex="-1"></a><span class="in">#--- sum ---#</span></span>
<span id="cb108-1033"><a href="#cb108-1033" aria-hidden="true" tabindex="-1"></a><span class="in">aggregate(KS_wells, KS_counties, FUN = sum)</span></span>
<span id="cb108-1034"><a href="#cb108-1034" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1035"><a href="#cb108-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1036"><a href="#cb108-1036" aria-hidden="true" tabindex="-1"></a>Notice that the <span class="in">`sum()`</span> function was applied to all the columns in <span class="in">`KS_wells`</span>, including site id number. So, you might want to select variables you want to join before you apply the <span class="in">`aggregate()`</span> function like this:  </span>
<span id="cb108-1037"><a href="#cb108-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1038"><a href="#cb108-1038" aria-hidden="true" tabindex="-1"></a><span class="in">```{r agg_select}</span></span>
<span id="cb108-1039"><a href="#cb108-1039" aria-hidden="true" tabindex="-1"></a><span class="in">aggregate(dplyr::select(KS_wells, af_used), KS_counties, FUN = sum)</span></span>
<span id="cb108-1040"><a href="#cb108-1040" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1041"><a href="#cb108-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1042"><a href="#cb108-1042" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial intersection (cropping join)</span></span>
<span id="cb108-1043"><a href="#cb108-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1044"><a href="#cb108-1044" aria-hidden="true" tabindex="-1"></a>Sometimes, you may need to crop spatial objects by polygon boundaries. For instance, in the demonstration in @sec-demo-railroad, we calculated the total length of railroads within each county by trimming the parts of the railroads that extended beyond county boundaries. Similarly, we cannot find area-weighted averages using <span class="in">`sf::st_join()`</span> alone because it does not provide information about how much of each HUC unit intersects with a county. However, if we can obtain the geometry of the intersecting portions of the HUC unit and the county, we can calculate their areas, allowing us to compute area-weighted averages of the joined attributes.</span>
<span id="cb108-1045"><a href="#cb108-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1046"><a href="#cb108-1046" aria-hidden="true" tabindex="-1"></a>For these purposes, we can use <span class="in">`sf::st_intersection()`</span>. Below, we illustrate how <span class="in">`sf::st_intersection()`</span> works for line-polygon and polygon-polygon intersections (using data generated in @sec-topo). Intersections involving points with <span class="in">`sf::st_intersection()`</span> are equivalent to using <span class="in">`sf::st_join()`</span> since points have neither length nor area (nothing to crop). Therefore, they are not discussed here.</span>
<span id="cb108-1047"><a href="#cb108-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1048"><a href="#cb108-1048" aria-hidden="true" tabindex="-1"></a><span class="fu">### `sf::st_intersection()` {#sec-st-intersection}</span></span>
<span id="cb108-1049"><a href="#cb108-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1050"><a href="#cb108-1050" aria-hidden="true" tabindex="-1"></a>While <span class="in">`sf::st_intersects()`</span> returns the indices of intersecting objects, <span class="in">`sf::st_intersection()`</span> returns the actual intersecting spatial objects, with the non-intersecting parts of the sf objects removed. Additionally, the attribute values from the source sf are merged with the intersecting geometries (<span class="in">`sfg`</span>) in the target <span class="in">`sf`</span>.</span>
<span id="cb108-1051"><a href="#cb108-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1052"><a href="#cb108-1052" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb108-1055"><a href="#cb108-1055" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-1056"><a href="#cb108-1056" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-1057"><a href="#cb108-1057" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-plot-lines-polygons</span></span>
<span id="cb108-1058"><a href="#cb108-1058" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visualization of the points, lines, and polygons"</span></span>
<span id="cb108-1059"><a href="#cb108-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1060"><a href="#cb108-1060" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-1061"><a href="#cb108-1061" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-1062"><a href="#cb108-1062" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Polygons"</span>) <span class="sc">+</span></span>
<span id="cb108-1063"><a href="#cb108-1063" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> lines, <span class="fu">aes</span>(<span class="at">color =</span> line_name)) <span class="sc">+</span></span>
<span id="cb108-1064"><a href="#cb108-1064" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"Lines"</span>) </span>
<span id="cb108-1065"><a href="#cb108-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1066"><a href="#cb108-1066" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb108-1067"><a href="#cb108-1067" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb108-1068"><a href="#cb108-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1069"><a href="#cb108-1069" aria-hidden="true" tabindex="-1"></a>We will now explore how this works for both line-polygon and polygon-polygon intersections, using the same toy examples we used to demonstrate how <span class="in">`sf::st_intersects()`</span> functions (@fig-plot-lines-polygons shows the lines and polygons).</span>
<span id="cb108-1070"><a href="#cb108-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1071"><a href="#cb108-1071" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb108-1072"><a href="#cb108-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1073"><a href="#cb108-1073" aria-hidden="true" tabindex="-1"></a>**lines and polygons**</span>
<span id="cb108-1074"><a href="#cb108-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1075"><a href="#cb108-1075" aria-hidden="true" tabindex="-1"></a>The following code finds the intersection of the lines and the polygons.</span>
<span id="cb108-1076"><a href="#cb108-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1077"><a href="#cb108-1077" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lines_polygons_intersection}</span></span>
<span id="cb108-1078"><a href="#cb108-1078" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-1079"><a href="#cb108-1079" aria-hidden="true" tabindex="-1"></a><span class="in">intersections_lp &lt;- </span></span>
<span id="cb108-1080"><a href="#cb108-1080" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_intersection(lines, polygons) %&gt;% </span></span>
<span id="cb108-1081"><a href="#cb108-1081" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(int_name = paste0(line_name, "-", polygon_name))</span></span>
<span id="cb108-1082"><a href="#cb108-1082" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-1083"><a href="#cb108-1083" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1084"><a href="#cb108-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1085"><a href="#cb108-1085" aria-hidden="true" tabindex="-1"></a>As shown in the output, each intersection between the lines and polygons becomes an observation (e.g., line 1-polygon 1, line 2-polygon 1, and line 2-polygon 2). Any part of the lines that does not intersect with a polygon is removed and does not appear in the returned sf object. To confirm this, see @fig-lines-polygons-int below:</span>
<span id="cb108-1086"><a href="#cb108-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1089"><a href="#cb108-1089" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-1090"><a href="#cb108-1090" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-lines-polygons-int</span></span>
<span id="cb108-1091"><a href="#cb108-1091" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The outcome of the intersections of the lines and polygons"</span></span>
<span id="cb108-1092"><a href="#cb108-1092" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-1093"><a href="#cb108-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1094"><a href="#cb108-1094" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-1095"><a href="#cb108-1095" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- here are all the original polygons  ---#</span></span>
<span id="cb108-1096"><a href="#cb108-1096" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-1097"><a href="#cb108-1097" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- here is what is returned after st_intersection ---#</span></span>
<span id="cb108-1098"><a href="#cb108-1098" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> intersections_lp, <span class="fu">aes</span>(<span class="at">color =</span> int_name), <span class="at">size =</span> <span class="fl">1.5</span>)</span>
<span id="cb108-1099"><a href="#cb108-1099" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1100"><a href="#cb108-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1101"><a href="#cb108-1101" aria-hidden="true" tabindex="-1"></a>This approach also allows us to calculate the length of the line segments that are fully contained within the polygons, similar to what we did in @sec-demo-railroad. Additionally, the attributes (e.g., <span class="in">`polygon_name`</span>) from the source <span class="in">`sf`</span> (the polygons) are merged with their intersecting lines. As a result, <span class="in">`sf::st_intersection()`</span> not only transforms the original geometries but also joins the attributes, which is why I refer to this as a "cropping join."</span>
<span id="cb108-1102"><a href="#cb108-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1103"><a href="#cb108-1103" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb108-1104"><a href="#cb108-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1105"><a href="#cb108-1105" aria-hidden="true" tabindex="-1"></a>**polygons and polygons**</span>
<span id="cb108-1106"><a href="#cb108-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1107"><a href="#cb108-1107" aria-hidden="true" tabindex="-1"></a>The following code finds the intersection of polygon 1 and polygon 3 with polygon 2.</span>
<span id="cb108-1108"><a href="#cb108-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1109"><a href="#cb108-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache=TRUE}</span></span>
<span id="cb108-1110"><a href="#cb108-1110" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-1111"><a href="#cb108-1111" aria-hidden="true" tabindex="-1"></a><span class="in">intersections_pp &lt;- </span></span>
<span id="cb108-1112"><a href="#cb108-1112" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_intersection(polygons[c(1,3), ], polygons[2, ]) %&gt;% </span></span>
<span id="cb108-1113"><a href="#cb108-1113" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(int_name = paste0(polygon_name, "-", polygon_name.1))</span></span>
<span id="cb108-1114"><a href="#cb108-1114" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-1115"><a href="#cb108-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1116"><a href="#cb108-1116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1117"><a href="#cb108-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1118"><a href="#cb108-1118" aria-hidden="true" tabindex="-1"></a>As shown in @fig-polygons-polygons-int, each intersection between polygons 1 and 3 with polygon 2 becomes a separate observation (e.g., polygon 1-polygon 2 and polygon 3-polygon 2). Similar to the lines-polygons case, the non-intersecting parts of polygons 1 and 3 are removed and do not appear in the returned sf. Later, we will explore how <span class="in">`sf::st_intersection()`</span> can be used to calculate area-weighted values from the intersecting polygons with the help of <span class="in">`sf::st_area()`</span>.</span>
<span id="cb108-1119"><a href="#cb108-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1122"><a href="#cb108-1122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-1123"><a href="#cb108-1123" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-polygons-polygons-int</span></span>
<span id="cb108-1124"><a href="#cb108-1124" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The outcome of the intersections of polygon 2 and polygons 1 and 3"</span></span>
<span id="cb108-1125"><a href="#cb108-1125" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-1126"><a href="#cb108-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1127"><a href="#cb108-1127" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-1128"><a href="#cb108-1128" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- here are all the original polygons  ---#</span></span>
<span id="cb108-1129"><a href="#cb108-1129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> polygons, <span class="fu">aes</span>(<span class="at">fill =</span> polygon_name), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb108-1130"><a href="#cb108-1130" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- here is what is returned after st_intersection ---#</span></span>
<span id="cb108-1131"><a href="#cb108-1131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> intersections_pp, <span class="fu">aes</span>(<span class="at">fill =</span> int_name))</span>
<span id="cb108-1132"><a href="#cb108-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1133"><a href="#cb108-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1134"><a href="#cb108-1134" aria-hidden="true" tabindex="-1"></a><span class="fu">### Area-weighted average</span></span>
<span id="cb108-1135"><a href="#cb108-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1136"><a href="#cb108-1136" aria-hidden="true" tabindex="-1"></a>Let’s now return to the example of HUC units and county-level corn acres data from @sec-sp-join. This time, we aim to calculate the area-weighted average of corn acres, rather than just the simple average.</span>
<span id="cb108-1137"><a href="#cb108-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1138"><a href="#cb108-1138" aria-hidden="true" tabindex="-1"></a>Using <span class="in">`sf::st_intersection()`</span>, we can divide each HUC polygon into parts based on the boundaries of the intersecting counties. For each HUC polygon, the intersecting counties are identified, and the polygon is split according to these boundaries.</span>
<span id="cb108-1139"><a href="#cb108-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1140"><a href="#cb108-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1141"><a href="#cb108-1141" aria-hidden="true" tabindex="-1"></a><span class="in">```{r intersection}</span></span>
<span id="cb108-1142"><a href="#cb108-1142" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-1143"><a href="#cb108-1143" aria-hidden="true" tabindex="-1"></a><span class="in">HUC_intersections &lt;- </span></span>
<span id="cb108-1144"><a href="#cb108-1144" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_intersection(HUC_IA, IA_corn) %&gt;% </span></span>
<span id="cb108-1145"><a href="#cb108-1145" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(huc_county = paste0(HUC_CODE, "-", county_code))</span></span>
<span id="cb108-1146"><a href="#cb108-1146" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-1147"><a href="#cb108-1147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1148"><a href="#cb108-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1149"><a href="#cb108-1149" aria-hidden="true" tabindex="-1"></a>The key difference from the <span class="in">`sf::st_join()`</span> example is that each observation in the returned data represents a unique HUC-county intersection. @fig-inter-ex below shows a map of all the intersections between the HUC unit with <span class="in">`HUC_CODE == 10170203`</span> and its four intersecting counties.</span>
<span id="cb108-1150"><a href="#cb108-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1153"><a href="#cb108-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb108-1154"><a href="#cb108-1154" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-inter-ex</span></span>
<span id="cb108-1155"><a href="#cb108-1155" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Intersections of a HUC unit and Iowa counties"</span></span>
<span id="cb108-1156"><a href="#cb108-1156" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb108-1157"><a href="#cb108-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1158"><a href="#cb108-1158" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb108-1159"><a href="#cb108-1159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb108-1160"><a href="#cb108-1160" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb108-1161"><a href="#cb108-1161" aria-hidden="true" tabindex="-1"></a>      HUC_intersections,</span>
<span id="cb108-1162"><a href="#cb108-1162" aria-hidden="true" tabindex="-1"></a>      HUC_CODE <span class="sc">==</span> <span class="st">"10170203"</span></span>
<span id="cb108-1163"><a href="#cb108-1163" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb108-1164"><a href="#cb108-1164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> huc_county)</span>
<span id="cb108-1165"><a href="#cb108-1165" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb108-1166"><a href="#cb108-1166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb108-1167"><a href="#cb108-1167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb108-1168"><a href="#cb108-1168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1169"><a href="#cb108-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1170"><a href="#cb108-1170" aria-hidden="true" tabindex="-1"></a>Note that the attributes from the county data, such as acres, are joined to the resulting intersections, as seen in the output above. As mentioned earlier, <span class="in">`sf::st_intersection()`</span> performs a spetial type of join where the resulting observations are the intersections between the target and source <span class="in">`sf`</span> objects.</span>
<span id="cb108-1171"><a href="#cb108-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1172"><a href="#cb108-1172" aria-hidden="true" tabindex="-1"></a>To calculate the area-weighted average of corn acres, you can first use <span class="in">`sf::st_area()`</span> to determine the area of each intersection. Then, compute the area-weighted average as follows:</span>
<span id="cb108-1173"><a href="#cb108-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1174"><a href="#cb108-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-1175"><a href="#cb108-1175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r map_area_weighted}</span></span>
<span id="cb108-1176"><a href="#cb108-1176" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb108-1177"><a href="#cb108-1177" aria-hidden="true" tabindex="-1"></a><span class="in">HUC_aw_acres &lt;- </span></span>
<span id="cb108-1178"><a href="#cb108-1178" aria-hidden="true" tabindex="-1"></a><span class="in">  HUC_intersections %&gt;% </span></span>
<span id="cb108-1179"><a href="#cb108-1179" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- get area ---#</span></span>
<span id="cb108-1180"><a href="#cb108-1180" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(area = as.numeric(st_area(.))) %&gt;% </span></span>
<span id="cb108-1181"><a href="#cb108-1181" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- get area-weight by HUC unit ---#</span></span>
<span id="cb108-1182"><a href="#cb108-1182" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::group_by(HUC_CODE) %&gt;% </span></span>
<span id="cb108-1183"><a href="#cb108-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(weight = area / sum(area)) %&gt;% </span></span>
<span id="cb108-1184"><a href="#cb108-1184" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- calculate area-weighted corn acreage by HUC unit ---#</span></span>
<span id="cb108-1185"><a href="#cb108-1185" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::summarize(aw_acres = sum(weight * acres))</span></span>
<span id="cb108-1186"><a href="#cb108-1186" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb108-1187"><a href="#cb108-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb108-1188"><a href="#cb108-1188" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/03-SpatialInteractionVectorVector.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>1&nbsp; R as GIS: Demonstrations – R as GIS for Economists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Google tag (gtag.js) --><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../style.css">
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/01-Demonstration.html">Demonstrations</a></li><li class="breadcrumb-item"><a href="../chapters/01-Demonstration.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">R as GIS for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/R-as-GIS-for-Economists" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/00-preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Demonstrations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-Demonstration.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-VectorDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-SpatialInteractionVectorVector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-RasterDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-SpatialInteractionVectorRaster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Extensions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-stars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-CreateMaps-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-DownloadSpatialData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">(slightly) Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-SpeedThingsUp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-ParallelComputing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Loop and Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-ggplot2-appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">ggplot2 minimals</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#before-you-start" id="toc-before-you-start" class="nav-link active" data-scroll-target="#before-you-start">Before you start</a>
  <ul class="collapse">
<li><a href="#target-audience" id="toc-target-audience" class="nav-link" data-scroll-target="#target-audience">Target Audience</a></li>
  <li><a href="#direction-for-replication" id="toc-direction-for-replication" class="nav-link" data-scroll-target="#direction-for-replication">Direction for replication</a></li>
  </ul>
</li>
  <li>
<a href="#sec-demo1" id="toc-sec-demo1" class="nav-link" data-scroll-target="#sec-demo1"><span class="header-section-number">1.1</span> The impact of groundwater pumping on depth to water table</a>
  <ul class="collapse">
<li><a href="#project-overview" id="toc-project-overview" class="nav-link" data-scroll-target="#project-overview"><span class="header-section-number">1.1.1</span> Project Overview</a></li>
  <li><a href="#project-demonstration" id="toc-project-demonstration" class="nav-link" data-scroll-target="#project-demonstration"><span class="header-section-number">1.1.2</span> Project Demonstration</a></li>
  </ul>
</li>
  <li>
<a href="#sec-demo-PA" id="toc-sec-demo-PA" class="nav-link" data-scroll-target="#sec-demo-PA"><span class="header-section-number">1.2</span> Precision Agriculture</a>
  <ul class="collapse">
<li><a href="#project-overview-1" id="toc-project-overview-1" class="nav-link" data-scroll-target="#project-overview-1"><span class="header-section-number">1.2.1</span> Project Overview</a></li>
  <li><a href="#project-demonstration-1" id="toc-project-demonstration-1" class="nav-link" data-scroll-target="#project-demonstration-1"><span class="header-section-number">1.2.2</span> Project Demonstration</a></li>
  </ul>
</li>
  <li>
<a href="#sec-demo3" id="toc-sec-demo3" class="nav-link" data-scroll-target="#sec-demo3"><span class="header-section-number">1.3</span> Land Use and Weather</a>
  <ul class="collapse">
<li><a href="#project-overview-2" id="toc-project-overview-2" class="nav-link" data-scroll-target="#project-overview-2"><span class="header-section-number">1.3.1</span> Project Overview</a></li>
  <li><a href="#project-demonstration-2" id="toc-project-demonstration-2" class="nav-link" data-scroll-target="#project-demonstration-2"><span class="header-section-number">1.3.2</span> Project Demonstration</a></li>
  </ul>
</li>
  <li>
<a href="#sec-demo-railroad" id="toc-sec-demo-railroad" class="nav-link" data-scroll-target="#sec-demo-railroad"><span class="header-section-number">1.4</span> The Impact of Railroad Presence on Corn Planted Acreage</a>
  <ul class="collapse">
<li><a href="#project-overview-3" id="toc-project-overview-3" class="nav-link" data-scroll-target="#project-overview-3"><span class="header-section-number">1.4.1</span> Project Overview</a></li>
  <li><a href="#project-demonstration-3" id="toc-project-demonstration-3" class="nav-link" data-scroll-target="#project-demonstration-3"><span class="header-section-number">1.4.2</span> Project Demonstration</a></li>
  </ul>
</li>
  <li>
<a href="#sec-demo-gw-ir" id="toc-sec-demo-gw-ir" class="nav-link" data-scroll-target="#sec-demo-gw-ir"><span class="header-section-number">1.5</span> Groundwater use for agricultural irrigation</a>
  <ul class="collapse">
<li><a href="#project-overview-4" id="toc-project-overview-4" class="nav-link" data-scroll-target="#project-overview-4"><span class="header-section-number">1.5.1</span> Project Overview</a></li>
  <li><a href="#project-demonstration-4" id="toc-project-demonstration-4" class="nav-link" data-scroll-target="#project-demonstration-4"><span class="header-section-number">1.5.2</span> Project Demonstration</a></li>
  </ul>
</li>
  <li>
<a href="#sec-demo-slave" id="toc-sec-demo-slave" class="nav-link" data-scroll-target="#sec-demo-slave"><span class="header-section-number">1.6</span> African Economy and Slaves: Nunn 2008</a>
  <ul class="collapse">
<li><a href="#project-overview-5" id="toc-project-overview-5" class="nav-link" data-scroll-target="#project-overview-5"><span class="header-section-number">1.6.1</span> Project Overview</a></li>
  <li><a href="#project-demonstration-5" id="toc-project-demonstration-5" class="nav-link" data-scroll-target="#project-demonstration-5"><span class="header-section-number">1.6.2</span> Project Demonstration</a></li>
  </ul>
</li>
  <li>
<a href="#sec-demo-tri" id="toc-sec-demo-tri" class="nav-link" data-scroll-target="#sec-demo-tri"><span class="header-section-number">1.7</span> Terrain Ruggedness and Economic Development in Africa: Nunn 2012</a>
  <ul class="collapse">
<li><a href="#project-overview-6" id="toc-project-overview-6" class="nav-link" data-scroll-target="#project-overview-6"><span class="header-section-number">1.7.1</span> Project Overview</a></li>
  <li><a href="#project-demonstration-6" id="toc-project-demonstration-6" class="nav-link" data-scroll-target="#project-demonstration-6"><span class="header-section-number">1.7.2</span> Project Demonstration</a></li>
  </ul>
</li>
  <li>
<a href="#sec-demo-tsetse" id="toc-sec-demo-tsetse" class="nav-link" data-scroll-target="#sec-demo-tsetse"><span class="header-section-number">1.8</span> TseTse fly suitability index: Alsan 2015</a>
  <ul class="collapse">
<li><a href="#project-overview-7" id="toc-project-overview-7" class="nav-link" data-scroll-target="#project-overview-7"><span class="header-section-number">1.8.1</span> Project Overview</a></li>
  <li><a href="#project-demonstration-7" id="toc-project-demonstration-7" class="nav-link" data-scroll-target="#project-demonstration-7"><span class="header-section-number">1.8.2</span> Project Demonstration</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/01-Demonstration.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/01-Demonstration.html">Demonstrations</a></li><li class="breadcrumb-item"><a href="../chapters/01-Demonstration.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-demo" class="quarto-section-identifier"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="before-you-start" class="level2 unnumbered page-columns page-full"><h2 class="unnumbered anchored" data-anchor-id="before-you-start">Before you start</h2>
<p>The primary objective of this chapter is to showcase the power of R as GIS through demonstrations via mock-up econometric research projects (first five demonstrations) and creating variables used in published articles (the last three demonstrations)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Each demonstration project consists of a project overview (objective, datasets used, econometric model, and GIS tasks involved) and demonstration. This is really <strong>NOT</strong> a place you learn the nuts and bolts of how R does spatial operations. Indeed, we intentionally do not explain all the details of how the R codes work. We reiterate that the main purpose of the demonstrations is to get you a better idea of how R can be used to process spatial data to help your research projects involving spatial datasets. Finally, note that the <em>mock-up</em> projects use extremely simple econometric models that completely lacks careful thoughts you would need in real research projects. So, don’t waste your time judging the econometric models, and just focus on GIS tasks. If you are not familiar with html documents generated by <code>rmarkdown</code>, you might benefit from reading the conventions of the book in the Preface. Finally, for those who are interested in replicating the demonstrations, directions for replication are provided below. However, I would suggest focusing on the narratives for the first time around, learn the nuts and bolts of spatial operations from Chapters 2 through 5, and then come back to replicate them.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Note that this lecture does not deal with spatial econometrics at all. This lecture is about spatial data processing, not spatial econometrics.</p></div></div><section id="target-audience" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="target-audience">Target Audience</h3>
<p>The target audience of this chapter is those who are not very familiar with R as GIS. Knowledge of R certainly helps. But, I tried to write in a way that R beginners can still understand the power of R as GIS. Do not get bogged down by all the complex-looking R codes. Just focus on the narratives and figures to get a sense of what R can do.</p>
</section><section id="direction-for-replication" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="direction-for-replication">Direction for replication</h3>
<hr>
<p><strong>Datasets</strong></p>
<p>Running the codes in this chapter involves reading datasets from a disk. All the datasets that will be imported are available <a href="https://www.dropbox.com/sh/rtbs4ji21c9uiy9/AADYpHAWhUxMittAptuq-Apaa?dl=0">here</a>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</p>
<ul>
<li>set a folder (any folder) as the working directory using <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code><br>
</li>
<li>create a folder called “Data” inside the folder designated as the working directory<br>
</li>
<li>download the pertinent datasets from <a href="https://www.dropbox.com/sh/rtbs4ji21c9uiy9/AADYpHAWhUxMittAptuq-Apaa?dl=0">here</a>
</li>
<li>place all the files in the downloaded folder in the “Data” folder</li>
</ul></section></section><section id="sec-demo1" class="level2 page-columns page-full" data-number="1.1"><h2 data-number="1.1" class="anchored" data-anchor-id="sec-demo1">
<span class="header-section-number">1.1</span> The impact of groundwater pumping on depth to water table</h2>
<section id="project-overview" class="level3 page-columns page-full" data-number="1.1.1"><h3 data-number="1.1.1" class="anchored" data-anchor-id="project-overview">
<span class="header-section-number">1.1.1</span> Project Overview</h3>
<hr>
<p><strong>Objective:</strong></p>
<ul>
<li>Understand the impact of groundwater pumping on groundwater level.</li>
</ul>
<hr>
<p><strong>Datasets</strong></p>
<ul>
<li>Groundwater pumping by irrigation wells in Chase, Dundy, and Perkins Counties in the southwest corner of Nebraska</li>
<li>Groundwater levels observed at USGS monitoring wells located in the three counties and retrieved from the National Water Information System (NWIS) maintained by USGS using the <code>dataRetrieval</code> package.</li>
</ul>
<hr>
<p><strong>Econometric Model</strong></p>
<p>In order to achieve the project objective, we will estimate the following model:</p>
<p><span class="math display">\[
y_{i,t} - y_{i,t-1} = \alpha + \beta gw_{i,t-1} + v
\]</span></p>
<p>where <span class="math inline">\(y_{i,t}\)</span> is the depth to groundwater table<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> in March<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> in year <span class="math inline">\(t\)</span> at USGS monitoring well <span class="math inline">\(i\)</span>, and <span class="math inline">\(gw_{i,t-1}\)</span> is the total amount of groundwater pumping that happened within the 2-mile radius of the monitoring well <span class="math inline">\(i\)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;the distance from the surface to the top of the aquifer</p></div><div id="fn3"><p><sup>3</sup>&nbsp;For our geographic focus of southwest Nebraska, corn is the dominant crop type. Irrigation for corn happens typically between April through September. For example, this means that changes in groundwater level (<span class="math inline">\(y_{i,2012} - y_{i,2011}\)</span>) captures the impact of groundwater pumping that occurred April through September in 2011.</p></div></div><hr>
<p><strong>GIS tasks</strong></p>
<ul>
<li>read an ESRI shape file as an <code>sf</code> (spatial) object
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">sf::st_read()</a></code>
</li>
</ul>
</li>
<li>download depth to water table data using the <code>dataRetrieval</code> package developed by USGS
<ul>
<li>use <code><a href="https://rdrr.io/pkg/dataRetrieval/man/readNWISdata.html">dataRetrieval::readNWISdata()</a></code> and <code><a href="https://rdrr.io/pkg/dataRetrieval/man/readNWISsite.html">dataRetrieval::readNWISsite()</a></code>
</li>
</ul>
</li>
<li>create a buffer around USGS monitoring wells
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">sf::st_buffer()</a></code>
</li>
</ul>
</li>
<li>convert a regular <code>data.frame</code> (non-spatial) with geographic coordinates into an <code>sf</code> (spatial) objects
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">sf::st_as_sf()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">sf::st_set_crs()</a></code>
</li>
</ul>
</li>
<li>reproject an <code>sf</code> object to another CRS
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">sf::st_transform()</a></code>
</li>
</ul>
</li>
<li>identify irrigation wells located inside the buffers and calculate total pumping
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code>
</li>
</ul>
</li>
<li>create maps
<ul>
<li>use the <code>tmap</code> package</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Preparation for replication</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">dataRetrieval</span>, <span class="co"># download USGS NWIS data</span></span>
<span>  <span class="va">lubridate</span>, <span class="co"># Date object handling</span></span>
<span>  <span class="va">modelsummary</span>, <span class="co"># regression table generation</span></span>
<span>  <span class="va">lfe</span>, <span class="co"># fast regression with many fixed effects</span></span>
<span>  <span class="va">tmap</span> <span class="co"># mapping</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="project-demonstration" class="level3 page-columns page-full" data-number="1.1.2"><h3 data-number="1.1.2" class="anchored" data-anchor-id="project-demonstration">
<span class="header-section-number">1.1.2</span> Project Demonstration</h3>
<p>The geographic focus of the project is the southwest corner of Nebraska consisting of Chase, Dundy, and Perkins County (see <a href="#fig-NE-county" class="quarto-xref">Figure&nbsp;<span>1.1</span></a> for their locations within Nebraska). Let’s read a shape file of the three counties represented as polygons. We will use it later to spatially filter groundwater level data downloaded from NWIS.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">three_counties</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span>dsn <span class="op">=</span> <span class="st">"Data"</span>, layer <span class="op">=</span> <span class="st">"urnrd"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- project to WGS84/UTM 14N ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">32614</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `urnrd' from data source 
  `/Users/tmieno2/Dropbox/TeachingUNL/R-as-GIS-for-Scientists/chapters/Data' 
  using driver `ESRI Shapefile'
Simple feature collection with 3 features and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -102.0518 ymin: 40.00257 xmax: -101.248 ymax: 41.00395
Geodetic CRS:  NAD83</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- map the three counties ---#</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">NE_county</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">three_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-NE-county" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-NE-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-NE-county-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-NE-county-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.1: The location of Chase, Dundy, and Perkins County in Nebraska
</figcaption></figure>
</div>
</div>
</div>
</div></div><hr>
<p>We have already collected groundwater pumping data, so let’s import it.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- groundwater pumping data ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">urnrd_gw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/urnrd_gw_pumping.rds"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       well_id  year  vol_af      lon     lat
         &lt;num&gt; &lt;int&gt;   &lt;num&gt;    &lt;num&gt;   &lt;num&gt;
    1:    1706  2007 182.566 245322.3 4542717
    2:    2116  2007  46.328 245620.9 4541125
    3:    2583  2007  38.380 245660.9 4542523
    4:    2597  2007  70.133 244816.2 4541143
    5:    3143  2007 135.870 243614.0 4541579
   ---                                       
18668:    2006  2012 148.713 284782.5 4432317
18669:    2538  2012 115.567 284462.6 4432331
18670:    2834  2012  15.766 283338.0 4431341
18671:    2834  2012 381.622 283740.4 4431329
18672:    4983  2012      NA 284636.0 4432725</code></pre>
</div>
</div>
<p><code>well_id</code> is the unique irrigation well identifier, and <code>vol_af</code> is the amount of groundwater pumped in acre-feet. This dataset is just a regular <code>data.frame</code> with coordinates. We need to convert this dataset into a object of class <code>sf</code> so that we can later identify irrigation wells located within a 2-mile radius of USGS monitoring wells (see <a href="#fig-sp-dist-wells" class="quarto-xref">Figure&nbsp;<span>1.2</span></a>) for the spatial distribution of the irrigation wells.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">urnrd_gw_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">urnrd_gw</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- convert to sf ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- set CRS WGS UTM 14 (you need to know the CRS of the coordinates to do this) ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_set_crs</a></span><span class="op">(</span><span class="fl">32614</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- now sf ---#</span></span>
<span><span class="va">urnrd_gw_sf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 18672 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 239959 ymin: 4431329 xmax: 310414.4 ymax: 4543146
Projected CRS: WGS 84 / UTM zone 14N
First 10 features:
   well_id year  vol_af                 geometry
1     1706 2007 182.566 POINT (245322.3 4542717)
2     2116 2007  46.328 POINT (245620.9 4541125)
3     2583 2007  38.380 POINT (245660.9 4542523)
4     2597 2007  70.133 POINT (244816.2 4541143)
5     3143 2007 135.870   POINT (243614 4541579)
6     5017 2007 196.799 POINT (243539.9 4543146)
7     1706 2008 171.250 POINT (245322.3 4542717)
8     2116 2008 171.650 POINT (245620.9 4541125)
9     2583 2008  46.100 POINT (245660.9 4542523)
10    2597 2008 124.830 POINT (244816.2 4541143)</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<div class="cell-output-display">
<div id="fig-sp-dist-wells" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-sp-dist-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-sp-dist-wells-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sp-dist-wells-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.2: Spatial distribution of irrigation wells
</figcaption></figure>
</div>
</div>
</div>
</div></div><hr>
<p>Here are the rest of the steps we will take to create a regression-ready dataset for our analysis.</p>
<ol type="1">
<li>download groundwater level data observed at USGS monitoring wells from National Water Information System (NWIS) using the <code>dataRetrieval</code> package</li>
<li>identify the irrigation wells located within the 2-mile radius of the USGS wells and calculate the total groundwater pumping that occurred around each of the USGS wells by year</li>
<li>merge the groundwater pumping data to the groundwater level data</li>
</ol>
<hr>
<p>Let’s download groundwater level data from NWIS first. The following code downloads groundwater level data for Nebraska from Jan 1, 1990, through Jan 1, 2016 (This would take a while if you try to run this yourself).</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- download groundwater level data ---#</span></span>
<span><span class="va">NE_gwl</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1990</span><span class="op">:</span><span class="fl">2015</span>,</span>
<span>    \<span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">dataRetrieval</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dataRetrieval/man/readNWISdata.html">readNWISdata</a></span><span class="op">(</span></span>
<span>        stateCd <span class="op">=</span> <span class="st">"Nebraska"</span>,</span>
<span>        startDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span>, <span class="st">"-01-01"</span><span class="op">)</span>,</span>
<span>        endDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year</span> <span class="op">+</span> <span class="fl">1</span>, <span class="st">"-01-01"</span><span class="op">)</span>,</span>
<span>        service <span class="op">=</span> <span class="st">"gwlevels"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">site_no</span>, <span class="va">lev_dt</span>, <span class="va">lev_va</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">lev_dt</span>, dwt <span class="op">=</span> <span class="va">lev_va</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">NE_gwl</span>, <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           site_no       date   dwt
1  400008097545301 2000-11-08 17.40
2  400008097545301 2008-10-09 13.99
3  400008097545301 2009-04-09 11.32
4  400008097545301 2009-10-06 15.54
5  400008097545301 2010-04-12 11.15
6  400008100050501 1990-03-15 24.80
7  400008100050501 1990-10-04 27.20
8  400008100050501 1991-03-08 24.20
9  400008100050501 1991-10-07 26.90
10 400008100050501 1992-03-02 24.70</code></pre>
</div>
</div>
<p><code>site_no</code> is the unique monitoring well identifier, <code>date</code> is the date of groundwater level monitoring, and <code>dwt</code> is depth to water table.</p>
<p>We calculate the average groundwater level in March by USGS monitoring well (right before the irrigation season starts):</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- Average depth to water table in March ---#</span></span>
<span><span class="va">NE_gwl_march</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">NE_gwl</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>    year <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- select observation in March ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">2007</span>, <span class="va">month</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- gwl average in March ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">site_no</span>, <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>dwt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dwt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">NE_gwl_march</span>, <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
# Groups:   site_no [2]
   site_no          year   dwt
   &lt;chr&gt;           &lt;dbl&gt; &lt;dbl&gt;
 1 400032101022901  2008 118. 
 2 400032101022901  2009 117. 
 3 400032101022901  2010 118. 
 4 400032101022901  2011 118. 
 5 400032101022901  2012 118. 
 6 400032101022901  2013 118. 
 7 400032101022901  2014 116. 
 8 400032101022901  2015 117. 
 9 400038099244601  2007  24.3
10 400038099244601  2008  21.7</code></pre>
</div>
</div>
<p>Since <code>NE_gwl</code> is missing geographic coordinates for the monitoring wells, we will download them using the <code>readNWISsite()</code> function and select only the monitoring wells that are inside the three counties.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the list of site ids ---#</span></span>
<span><span class="va">NE_site_ls</span> <span class="op">&lt;-</span> <span class="va">NE_gwl</span><span class="op">$</span><span class="va">site_no</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- get the locations of the site ids ---#</span></span>
<span><span class="va">sites_info</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">readNWISsite</span><span class="op">(</span>siteNumbers <span class="op">=</span> <span class="va">NE_site_ls</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">site_no</span>, <span class="va">dec_lat_va</span>, <span class="va">dec_long_va</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- turn the data into an sf object ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dec_long_va"</span>, <span class="st">"dec_lat_va"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- NAD 83 ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_set_crs</a></span><span class="op">(</span><span class="fl">4269</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- project to WGS UTM 14 ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">32614</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- keep only those located inside the three counties ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="va">three_counties</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>We now identify irrigation wells that are located within the 2-mile radius of the monitoring wells<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. We first create polygons of 2-mile radius circles around the monitoring wells (see <a href="#fig-buffer-map" class="quarto-xref">Figure&nbsp;<span>1.3</span></a>).</p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;This can alternatively be done using the <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">sf::st_is_within_distance()</a></code> function.</p></div></div><div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">buffers</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">sites_info</span>, dist <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="fl">1609.34</span><span class="op">)</span> <span class="co"># in meter</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">three_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">buffers</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">sites_info</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_symbols</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-buffer-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-buffer-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-buffer-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-buffer-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.3: 2-mile buffers around USGS monitoring wells
</figcaption></figure>
</div>
</div>
</div>
<p>We now identify which irrigation wells are inside each of the buffers and get the associated groundwater pumping values. The <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> function from the <code>sf</code> package will do the trick.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- find irrigation wells inside the buffer and calculate total pumping  ---#</span></span>
<span><span class="va">pumping_nearby</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">buffers</span>, <span class="va">urnrd_gw_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s take a look at a USGS monitoring well (<code>site_no</code> = <span class="math inline">\(400012101323401\)</span>).</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">pumping_nearby</span>, <span class="va">site_no</span> <span class="op">==</span> <span class="fl">400012101323401</span>, <span class="va">year</span> <span class="op">==</span> <span class="fl">2010</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 7 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 279690.7 ymin: 4428006 xmax: 286128 ymax: 4434444
Projected CRS: WGS 84 / UTM zone 14N
             site_no well_id year  vol_af                       geometry
9.3  400012101323401    6331 2010      NA POLYGON ((286128 4431225, 2...
9.24 400012101323401    1883 2010 180.189 POLYGON ((286128 4431225, 2...
9.25 400012101323401    2006 2010  79.201 POLYGON ((286128 4431225, 2...
9.26 400012101323401    2538 2010  68.205 POLYGON ((286128 4431225, 2...
9.27 400012101323401    2834 2010      NA POLYGON ((286128 4431225, 2...
9.28 400012101323401    2834 2010 122.981 POLYGON ((286128 4431225, 2...
9.29 400012101323401    4983 2010      NA POLYGON ((286128 4431225, 2...</code></pre>
</div>
</div>
<p>As you can see, this well has seven irrigation wells within its 2-mile radius in 2010.</p>
<p>Now, we will get total nearby pumping by monitoring well and year.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">total_pumping_nearby</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">pumping_nearby</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- calculate total pumping by monitoring well ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">site_no</span>, <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>nearby_pumping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">vol_af</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- NA means 0 pumping ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      nearby_pumping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nearby_pumping</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">nearby_pumping</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 2396 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 237904.5 ymin: 4428006 xmax: 313476.5 ymax: 4545687
Projected CRS: WGS 84 / UTM zone 14N
# A tibble: 2,396 × 4
# Groups:   site_no [401]
   site_no          year nearby_pumping                                 geometry
 * &lt;chr&gt;           &lt;int&gt;          &lt;dbl&gt;                            &lt;POLYGON [m]&gt;
 1 400012101323401  2007           571. ((286128 4431225, 286123.6 4431057, 286…
 2 400012101323401  2008           772. ((286128 4431225, 286123.6 4431057, 286…
 3 400012101323401  2009           500. ((286128 4431225, 286123.6 4431057, 286…
 4 400012101323401  2010           451. ((286128 4431225, 286123.6 4431057, 286…
 5 400012101323401  2011           545. ((286128 4431225, 286123.6 4431057, 286…
 6 400012101323401  2012          1028. ((286128 4431225, 286123.6 4431057, 286…
 7 400130101374401  2007           485. ((278847.4 4433844, 278843 4433675, 278…
 8 400130101374401  2008           515. ((278847.4 4433844, 278843 4433675, 278…
 9 400130101374401  2009           351. ((278847.4 4433844, 278843 4433675, 278…
10 400130101374401  2010           374. ((278847.4 4433844, 278843 4433675, 278…
# ℹ 2,386 more rows</code></pre>
</div>
</div>
<hr>
<p>We now merge nearby pumping data to the groundwater level data, and transform the data to obtain the dataset ready for regression analysis.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- regression-ready data ---#</span></span>
<span><span class="va">reg_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">NE_gwl_march</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- pick monitoring wells that are inside the three counties ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">site_no</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sites_info</span><span class="op">$</span><span class="va">site_no</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- merge with the nearby pumping data ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">total_pumping_nearby</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"site_no"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- lead depth to water table ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">site_no</span>, <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">site_no</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">#--- lead depth ---#</span></span>
<span>    dwt_lead1 <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead</a></span><span class="op">(</span><span class="va">dwt</span>, n <span class="op">=</span> <span class="fl">1</span>, default <span class="op">=</span> <span class="cn">NA</span>, order_by <span class="op">=</span> <span class="va">year</span><span class="op">)</span>,</span>
<span>    <span class="co">#--- first order difference in dwt  ---#</span></span>
<span>    dwt_dif <span class="op">=</span> <span class="va">dwt_lead1</span> <span class="op">-</span> <span class="va">dwt</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">reg_data</span>, <span class="va">site_no</span>, <span class="va">year</span>, <span class="va">dwt_dif</span>, <span class="va">nearby_pumping</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,022 × 4
# Groups:   site_no [230]
   site_no          year dwt_dif nearby_pumping
   &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt;          &lt;dbl&gt;
 1 400130101374401  2011  NA               358.
 2 400134101483501  2007   2.87           2038.
 3 400134101483501  2008   0.780          2320.
 4 400134101483501  2009  -2.45           2096.
 5 400134101483501  2010   3.97           2432.
 6 400134101483501  2011   1.84           2634.
 7 400134101483501  2012  -1.35            985.
 8 400134101483501  2013  44.8              NA 
 9 400134101483501  2014 -26.7              NA 
10 400134101483501  2015  NA                NA 
# ℹ 2,012 more rows</code></pre>
</div>
</div>
<hr>
<p>Finally, we estimate the model using <code><a href="https://lrberge.github.io/fixest/reference/feols.html">fixest::feols()</a></code> from the <code>fixest</code> package (see <a href="https://cran.r-project.org/web/packages/fixest/vignettes/fixest_walkthrough.html">here</a> for an introduction).</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- OLS with site_no and year FEs (error clustered by site_no) ---#</span></span>
<span><span class="va">reg_dwt</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span></span>
<span>    <span class="va">dwt_dif</span> <span class="op">~</span> <span class="va">nearby_pumping</span> <span class="op">|</span> <span class="va">site_no</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>    cluster <span class="op">=</span> <span class="st">"site_no"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">reg_data</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the regression result.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">modelsummary</span><span class="fu">::</span><span class="fu"><a href="https://modelsummary.com/man/msummary.html">msummary</a></span><span class="op">(</span></span>
<span>  <span class="va">reg_dwt</span>,</span>
<span>  stars <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  gof_omit <span class="op">=</span> <span class="st">"IC|Log|Adj|Within|Pseudo"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
 

  
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tinytable_ulj2y38wyxsc09583cx1</title>
<style>
.table td.tinytable_css_8p1qmnu948ys2cm445b7, .table th.tinytable_css_8p1qmnu948ys2cm445b7 {    border-bottom: solid 0.1em #d3d8dc; }
.table td.tinytable_css_r90on568cs6vw9niqj9o, .table th.tinytable_css_r90on568cs6vw9niqj9o {    text-align: left; }
.table td.tinytable_css_utkaunxkiiif7wbxbgtx, .table th.tinytable_css_utkaunxkiiif7wbxbgtx {    text-align: center; }
.table td.tinytable_css_gic1xqycsyju3f13i569, .table th.tinytable_css_gic1xqycsyju3f13i569 {    border-bottom: solid 0.05em black; }
    </style>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script><div class="container">
      <table class="table table-borderless" id="tinytable_ulj2y38wyxsc09583cx1" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
<thead><tr>
<th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr></thead>
<tfoot><tr><td colspan="2">+ p </td></tr></tfoot>
<tbody>
<tr>
<td>nearby_pumping</td>
                  <td>0.001***   </td>
                </tr>
<tr>
<td>              </td>
                  <td>(0.000)    </td>
                </tr>
<tr>
<td>Num.Obs.      </td>
                  <td>1342       </td>
                </tr>
<tr>
<td>R2            </td>
                  <td>0.409      </td>
                </tr>
<tr>
<td>RMSE          </td>
                  <td>1.36       </td>
                </tr>
<tr>
<td>Std.Errors    </td>
                  <td>by: site_no</td>
                </tr>
<tr>
<td>FE: site_no   </td>
                  <td>X          </td>
                </tr>
<tr>
<td>FE: year      </td>
                  <td>X          </td>
                </tr>
</tbody>
</table>
</div>

    <script>
      function styleCell_tinytable_v68ehg9gfpti0j5guxvw(i, j, css_id) {
        var table = document.getElementById("tinytable_ulj2y38wyxsc09583cx1");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_ulj2y38wyxsc09583cx1');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_tinytable_v68ehg9gfpti0j5guxvw(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_ulj2y38wyxsc09583cx1");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }

window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(0, 0, 'tinytable_css_8p1qmnu948ys2cm445b7') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(0, 1, 'tinytable_css_8p1qmnu948ys2cm445b7') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(0, 0, 'tinytable_css_r90on568cs6vw9niqj9o') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(1, 0, 'tinytable_css_r90on568cs6vw9niqj9o') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(2, 0, 'tinytable_css_r90on568cs6vw9niqj9o') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(3, 0, 'tinytable_css_r90on568cs6vw9niqj9o') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(4, 0, 'tinytable_css_r90on568cs6vw9niqj9o') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(5, 0, 'tinytable_css_r90on568cs6vw9niqj9o') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(6, 0, 'tinytable_css_r90on568cs6vw9niqj9o') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(7, 0, 'tinytable_css_r90on568cs6vw9niqj9o') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(8, 0, 'tinytable_css_r90on568cs6vw9niqj9o') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(0, 1, 'tinytable_css_utkaunxkiiif7wbxbgtx') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(1, 1, 'tinytable_css_utkaunxkiiif7wbxbgtx') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(2, 1, 'tinytable_css_utkaunxkiiif7wbxbgtx') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(3, 1, 'tinytable_css_utkaunxkiiif7wbxbgtx') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(4, 1, 'tinytable_css_utkaunxkiiif7wbxbgtx') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(5, 1, 'tinytable_css_utkaunxkiiif7wbxbgtx') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(6, 1, 'tinytable_css_utkaunxkiiif7wbxbgtx') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(7, 1, 'tinytable_css_utkaunxkiiif7wbxbgtx') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(8, 1, 'tinytable_css_utkaunxkiiif7wbxbgtx') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(2, 0, 'tinytable_css_gic1xqycsyju3f13i569') })
window.addEventListener('load', function () { styleCell_tinytable_v68ehg9gfpti0j5guxvw(2, 1, 'tinytable_css_gic1xqycsyju3f13i569') })
    </script>
</div>
</div>
</section></section><section id="sec-demo-PA" class="level2 page-columns page-full" data-number="1.2"><h2 data-number="1.2" class="anchored" data-anchor-id="sec-demo-PA">
<span class="header-section-number">1.2</span> Precision Agriculture</h2>
<section id="project-overview-1" class="level3" data-number="1.2.1"><h3 data-number="1.2.1" class="anchored" data-anchor-id="project-overview-1">
<span class="header-section-number">1.2.1</span> Project Overview</h3>
<hr>
<p><strong>Objectives:</strong></p>
<ul>
<li>Understand the impact of nitrogen on corn yield</li>
<li>Understand how electric conductivity (EC) affects the marginal impact of nitrogen on corn</li>
</ul>
<hr>
<p><strong>Datasets:</strong></p>
<ul>
<li>The experimental design of an on-farm randomized nitrogen trail on an 80-acre field</li>
<li>Data generated by the experiment
<ul>
<li>As-applied nitrogen rate</li>
<li>Yield measures</li>
</ul>
</li>
<li>Electric conductivity</li>
</ul>
<hr>
<p><strong>Econometric Model:</strong></p>
<p>Here is the econometric model, we would like to estimate:</p>
<p><span class="math display">\[
yield_i = \beta_0 + \beta_1 N_i + \beta_2 N_i^2 + \beta_3 N_i \cdot EC_i + \beta_4 N_i^2 \cdot EC_i + v_i
\]</span></p>
<p>where <span class="math inline">\(yield_i\)</span>, <span class="math inline">\(N_i\)</span>, <span class="math inline">\(EC_i\)</span>, and <span class="math inline">\(v_i\)</span> are corn yield, nitrogen rate, EC, and error term at subplot <span class="math inline">\(i\)</span>. Subplots which are obtained by dividing experimental plots into six of equal-area compartments.</p>
<hr>
<p><strong>GIS tasks</strong></p>
<ul>
<li>read spatial data in various formats: R data set (rds), shape file, and GeoPackage file
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">sf::st_read()</a></code>
</li>
</ul>
</li>
<li>create maps using the <code>ggplot2</code> package
<ul>
<li>use <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">ggplot2::geom_sf()</a></code>
</li>
</ul>
</li>
<li>create subplots within experimental plots
<ul>
<li>user-defined function that makes use of <code>st_geometry()</code>
</li>
</ul>
</li>
<li>identify corn yield, as-applied nitrogen, and electric conductivity (EC) data points within each of the experimental plots and find their averages
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/aggregate.sf.html">sf::aggregate()</a></code>
</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Preparation for replication</strong></p>
<ul>
<li>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">ggplot2</span>, <span class="co"># for map creation</span></span>
<span>  <span class="va">modelsummary</span>, <span class="co"># regression table generation</span></span>
<span>  <span class="va">patchwork</span> <span class="co"># arrange multiple plots</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Run the following code to define the theme for map:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">theme_for_map</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    axis.ticks <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.border <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span>, color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="project-demonstration-1" class="level3 page-columns page-full" data-number="1.2.2"><h3 data-number="1.2.2" class="anchored" data-anchor-id="project-demonstration-1">
<span class="header-section-number">1.2.2</span> Project Demonstration</h3>
<p>We have already run a whole-field randomized nitrogen experiment on a 80-acre field. Let’s import the trial design data</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read the trial design data ---#</span></span>
<span><span class="va">trial_design_16</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/trial_design.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-trial-fig" class="quarto-xref">Figure&nbsp;<span>1.4</span></a> is the map of the trial design generated using <code>ggplot2</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- map of trial design ---#</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">trial_design_16</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">NRATE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"N"</span>, palette <span class="op">=</span> <span class="st">"OrRd"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-trial-fig" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-trial-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-trial-fig-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-trial-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.4: The Experimental Design of the Randomize Nitrogen Trial
</figcaption></figure>
</div>
</div>
</div>
<hr>
<p>We have collected yield, as-applied NH3, and EC data. Let’s read in these datasets:<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;Here we are demonstrating that R can read spatial data in different formats. R can read spatial data of many other formats. Here, we are reading a shapefile (.shp) and GeoPackage file (.gpkg).</p></div></div><div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read yield data (sf data saved as rds) ---#</span></span>
<span><span class="va">yield</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/yield.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- read NH3 data (GeoPackage data) ---#</span></span>
<span><span class="va">NH3_data</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/NH3.gpkg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- read ec data (shape file) ---#</span></span>
<span><span class="va">ec</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span>dsn <span class="op">=</span> <span class="st">"Data"</span>, <span class="st">"ec"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-Demo2-show-the-map" class="quarto-xref">Figure&nbsp;<span>1.5</span></a> shows the spatial distribution of the three variables. A map of each variable was made first, and then they are combined into one figure using the <code>patchwork</code> package<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;Here is its <a href="https://github.com/thomasp85/patchwork">Github page</a>. See the bottom of the page to find vignettes.</p></div></div><div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- yield map ---#</span></span>
<span><span class="va">g_yield</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">trial_design_16</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">yield</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">yield</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Yield"</span>, palette <span class="op">=</span> <span class="st">"OrRd"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span>
<span></span>
<span><span class="co">#--- NH3 map ---#</span></span>
<span><span class="va">g_NH3</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">trial_design_16</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NH3_data</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">aa_NH3</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"NH3"</span>, palette <span class="op">=</span> <span class="st">"OrRd"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span>
<span></span>
<span><span class="co">#--- NH3 map ---#</span></span>
<span><span class="va">g_ec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">trial_design_16</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ec</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">ec</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"EC"</span>, palette <span class="op">=</span> <span class="st">"OrRd"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span>
<span></span>
<span><span class="co">#--- stack the figures vertically and display (enabled by the patchwork package) ---#</span></span>
<span><span class="va">g_yield</span> <span class="op">/</span> <span class="va">g_NH3</span> <span class="op">/</span> <span class="va">g_ec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Demo2-show-the-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Demo2-show-the-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-Demo2-show-the-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Demo2-show-the-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.5: Spatial distribution of yield, NH3, and EC
</figcaption></figure>
</div>
</div>
</div>
<hr>
<p>Instead of using plot as the observation unit, we would like to create subplots inside each of the plots and make them the unit of analysis because it would avoid masking the within-plot spatial heterogeneity of EC. Here, we divide each plot into six subplots.</p>
<p>The following function generate subplots by supplying a trial design and the number of subplots you would like to create within each plot:</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gen_subplots</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">plot</span>, <span class="va">num_sub</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co">#--- extract geometry information ---#</span></span>
<span>  <span class="va">geom_mat</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">plot</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#--- upper left ---#</span></span>
<span>  <span class="va">top_start</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">geom_mat</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- upper right ---#</span></span>
<span>  <span class="va">top_end</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">geom_mat</span><span class="op">[</span><span class="fl">3</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- lower right ---#</span></span>
<span>  <span class="va">bot_start</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">geom_mat</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- lower left ---#</span></span>
<span>  <span class="va">bot_end</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">geom_mat</span><span class="op">[</span><span class="fl">4</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">top_step_vec</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">top_end</span> <span class="op">-</span> <span class="va">top_start</span><span class="op">)</span> <span class="op">/</span> <span class="va">num_sub</span></span>
<span>  <span class="va">bot_step_vec</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">bot_end</span> <span class="op">-</span> <span class="va">bot_start</span><span class="op">)</span> <span class="op">/</span> <span class="va">num_sub</span></span>
<span></span>
<span>  <span class="co"># create a list for the sub-grid</span></span>
<span></span>
<span>  <span class="va">subplots_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_sub</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">rec_pt1</span> <span class="op">&lt;-</span> <span class="va">top_start</span> <span class="op">+</span> <span class="op">(</span><span class="va">j</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">top_step_vec</span></span>
<span>    <span class="va">rec_pt2</span> <span class="op">&lt;-</span> <span class="va">top_start</span> <span class="op">+</span> <span class="va">j</span> <span class="op">*</span> <span class="va">top_step_vec</span></span>
<span>    <span class="va">rec_pt3</span> <span class="op">&lt;-</span> <span class="va">bot_start</span> <span class="op">+</span> <span class="va">j</span> <span class="op">*</span> <span class="va">bot_step_vec</span></span>
<span>    <span class="va">rec_pt4</span> <span class="op">&lt;-</span> <span class="va">bot_start</span> <span class="op">+</span> <span class="op">(</span><span class="va">j</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">bot_step_vec</span></span>
<span></span>
<span>    <span class="va">rec_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">rec_pt1</span>, <span class="va">rec_pt2</span>, <span class="va">rec_pt3</span>, <span class="va">rec_pt4</span>, <span class="va">rec_pt1</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">temp_quater_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">st_polygon</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">rec_j</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html">st_sf</a></span><span class="op">(</span><span class="va">.</span>, crs <span class="op">=</span> <span class="fl">26914</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">subplots_ls</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">temp_quater_sf</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">subplots_ls</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s run the function to create six subplots within each of the experimental plots.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- generate subplots ---#</span></span>
<span><span class="va">subplots</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">trial_design_16</span><span class="op">)</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">gen_subplots</span><span class="op">(</span><span class="va">trial_design_16</span><span class="op">[</span><span class="va">x</span>, <span class="op">]</span>, <span class="fl">6</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">.</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-map-subgrid" class="quarto-xref">Figure&nbsp;<span>1.6</span></a> is a map of the subplots generated.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- here is what subplots look like ---#</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">subplots</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-map-subgrid" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-subgrid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-map-subgrid-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-subgrid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.6: Map of the subplots
</figcaption></figure>
</div>
</div>
</div>
<hr>
<p>We now identify the mean value of corn yield, nitrogen rate, and EC for each of the subplots using <code><a href="https://r-spatial.github.io/sf/reference/aggregate.sf.html">sf::aggregate()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">reg_data</span> <span class="op">&lt;-</span> <span class="va">subplots</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- yield ---#</span></span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">yield</span>, <span class="va">.</span>, <span class="va">mean</span><span class="op">)</span>, join <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="va"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_equals</a></span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- nitrogen ---#</span></span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">NH3_data</span>, <span class="va">.</span>, <span class="va">mean</span><span class="op">)</span>, join <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="va"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_equals</a></span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- EC ---#</span></span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">ec</span>, <span class="va">.</span>, <span class="va">mean</span><span class="op">)</span>, join <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="va"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_equals</a></span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 816 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 560121.3 ymin: 4533410 xmax: 560758.9 ymax: 4533734
Projected CRS: NAD83 / UTM zone 14N
First 10 features:
      yield   aa_NH3       ec                       geometry
1  220.1789 194.5155 28.33750 POLYGON ((560121.3 4533428,...
2  218.9671 194.4291 29.37667 POLYGON ((560134.5 4533428,...
3  220.3286 195.2903 30.73600 POLYGON ((560147.7 4533428,...
4  215.3121 196.7649 32.24000 POLYGON ((560160.9 4533429,...
5  216.9709 195.2199 36.27000 POLYGON ((560174.1 4533429,...
6  227.8761 184.6362 31.21000 POLYGON ((560187.3 4533429,...
7  226.0991 179.2143 31.99250 POLYGON ((560200.5 4533430,...
8  225.3973 179.0916 31.56500 POLYGON ((560213.7 4533430,...
9  221.1820 178.9585 33.01000 POLYGON ((560227 4533430, 5...
10 219.4659 179.0057 41.89750 POLYGON ((560240.2 4533430,...</code></pre>
</div>
</div>
<p>Here are the visualization of the subplot-level data (<a href="#fig-Demo2-subplot-fig" class="quarto-xref">Figure&nbsp;<span>1.7</span></a>):</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g_sub_yield</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">reg_data</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">yield</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Yield"</span>, palette <span class="op">=</span> <span class="st">"OrRd"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span>
<span></span>
<span><span class="va">g_sub_NH3</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">reg_data</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">aa_NH3</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"NH3"</span>, palette <span class="op">=</span> <span class="st">"OrRd"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span>
<span></span>
<span><span class="va">g_sub_ec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">reg_data</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">ec</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"EC"</span>, palette <span class="op">=</span> <span class="st">"OrRd"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span>
<span></span>
<span><span class="va">g_sub_yield</span> <span class="op">/</span> <span class="va">g_sub_NH3</span> <span class="op">/</span> <span class="va">g_sub_ec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Demo2-subplot-fig" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Demo2-subplot-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-Demo2-subplot-fig-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Demo2-subplot-fig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.7: Spatial distribution of subplot-level yield, NH3, and EC
</figcaption></figure>
</div>
</div>
</div>
<hr>
<p>Let’s estimate the model and see the results:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ols_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">yield</span> <span class="op">~</span> <span class="va">aa_NH3</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">aa_NH3</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">aa_NH3</span> <span class="op">*</span> <span class="va">ec</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">aa_NH3</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">ec</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">reg_data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">modelsummary</span><span class="fu">::</span><span class="fu"><a href="https://modelsummary.com/man/msummary.html">msummary</a></span><span class="op">(</span></span>
<span>  <span class="va">ols_res</span>,</span>
<span>  stars <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  gof_omit <span class="op">=</span> <span class="st">"IC|Log|Adj|Within|Pseudo"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
 

  
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tinytable_sq88gu9pom72mvsy65kd</title>
<style>
.table td.tinytable_css_cmzjmzxmdw1c61r5ddbw, .table th.tinytable_css_cmzjmzxmdw1c61r5ddbw {    border-bottom: solid 0.1em #d3d8dc; }
.table td.tinytable_css_03db2jsfmdhlq9452ljp, .table th.tinytable_css_03db2jsfmdhlq9452ljp {    text-align: left; }
.table td.tinytable_css_rnbkcev1p9a8uginf85w, .table th.tinytable_css_rnbkcev1p9a8uginf85w {    text-align: center; }
.table td.tinytable_css_d3wuuyrtcjm33nunqtxh, .table th.tinytable_css_d3wuuyrtcjm33nunqtxh {    border-bottom: solid 0.05em black; }
    </style>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script><div class="container">
      <table class="table table-borderless" id="tinytable_sq88gu9pom72mvsy65kd" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
<thead><tr>
<th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr></thead>
<tfoot><tr><td colspan="2">+ p </td></tr></tfoot>
<tbody>
<tr>
<td>(Intercept)     </td>
                  <td>327.993**</td>
                </tr>
<tr>
<td>                </td>
                  <td>(125.638)</td>
                </tr>
<tr>
<td>aa_NH3          </td>
                  <td>-1.223   </td>
                </tr>
<tr>
<td>                </td>
                  <td>(1.308)  </td>
                </tr>
<tr>
<td>I(aa_NH3^2)     </td>
                  <td>0.004    </td>
                </tr>
<tr>
<td>                </td>
                  <td>(0.003)  </td>
                </tr>
<tr>
<td>I(aa_NH3 * ec)  </td>
                  <td>0.002    </td>
                </tr>
<tr>
<td>                </td>
                  <td>(0.003)  </td>
                </tr>
<tr>
<td>I(aa_NH3^2 * ec)</td>
                  <td>0.000    </td>
                </tr>
<tr>
<td>                </td>
                  <td>(0.000)  </td>
                </tr>
<tr>
<td>Num.Obs.        </td>
                  <td>784      </td>
                </tr>
<tr>
<td>R2              </td>
                  <td>0.010    </td>
                </tr>
<tr>
<td>F               </td>
                  <td>2.023    </td>
                </tr>
<tr>
<td>RMSE            </td>
                  <td>5.69     </td>
                </tr>
</tbody>
</table>
</div>

    <script>
      function styleCell_tinytable_sqgx25mf4az0czeg4ljf(i, j, css_id) {
        var table = document.getElementById("tinytable_sq88gu9pom72mvsy65kd");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_sq88gu9pom72mvsy65kd');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_tinytable_sqgx25mf4az0czeg4ljf(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_sq88gu9pom72mvsy65kd");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }

window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(0, 0, 'tinytable_css_cmzjmzxmdw1c61r5ddbw') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(0, 1, 'tinytable_css_cmzjmzxmdw1c61r5ddbw') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(0, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(1, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(2, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(3, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(4, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(5, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(6, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(7, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(8, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(9, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(10, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(11, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(12, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(13, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(14, 0, 'tinytable_css_03db2jsfmdhlq9452ljp') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(0, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(1, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(2, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(3, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(4, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(5, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(6, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(7, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(8, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(9, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(10, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(11, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(12, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(13, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(14, 1, 'tinytable_css_rnbkcev1p9a8uginf85w') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(10, 0, 'tinytable_css_d3wuuyrtcjm33nunqtxh') })
window.addEventListener('load', function () { styleCell_tinytable_sqgx25mf4az0czeg4ljf(10, 1, 'tinytable_css_d3wuuyrtcjm33nunqtxh') })
    </script>
</div>
</div>
</section></section><section id="sec-demo3" class="level2 page-columns page-full" data-number="1.3"><h2 data-number="1.3" class="anchored" data-anchor-id="sec-demo3">
<span class="header-section-number">1.3</span> Land Use and Weather</h2>
<section id="project-overview-2" class="level3" data-number="1.3.1"><h3 data-number="1.3.1" class="anchored" data-anchor-id="project-overview-2">
<span class="header-section-number">1.3.1</span> Project Overview</h3>
<hr>
<p><strong>Objective</strong></p>
<ul>
<li>Understand the impact of past precipitation on crop choice in Iowa (IA).</li>
</ul>
<hr>
<p><strong>Datasets</strong></p>
<ul>
<li>IA county boundary</li>
<li>Regular grids over IA, created using <code><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">sf::st_make_grid()</a></code>
</li>
<li>PRISM daily precipitation data downloaded using <code>prism</code> package</li>
<li>Land use data from the Cropland Data Layer (CDL) for IA in 2015, downloaded using <code>CropScapeR</code> package</li>
</ul>
<hr>
<p><strong>Econometric Model</strong></p>
<p>The econometric model we would like to estimate is:</p>
<p><span class="math display">\[
CS_i = \alpha + \beta_1 PrN_{i} + \beta_2 PrC_{i} + v_i
\]</span></p>
<p>where <span class="math inline">\(CS_i\)</span> is the area share of corn divided by that of soy in 2015 for grid <span class="math inline">\(i\)</span> (we will generate regularly-sized grids in the Demo section), <span class="math inline">\(PrN_i\)</span> is the total precipitation observed in April through May and September in 2014, <span class="math inline">\(PrC_i\)</span> is the total precipitation observed in June through August in 2014, and <span class="math inline">\(v_i\)</span> is the error term. To run the econometric model, we need to find crop share and weather variables observed at the grids. We first tackle the crop share variable, and then the precipitation variable.</p>
<hr>
<p><strong>GIS tasks</strong></p>
<ul>
<li>download Cropland Data Layer (CDL) data by USDA NASS
<ul>
<li>use <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">CropScapeR::GetCDLData()</a></code>
</li>
</ul>
</li>
<li>download PRISM weather data
<ul>
<li>use <code><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">prism::get_prism_dailys()</a></code>
</li>
</ul>
</li>
<li>crop PRISM data to the geographic extent of IA
<ul>
<li>use <code><a href="https://rspatial.github.io/terra/reference/crop.html">terra::crop()</a></code>
</li>
</ul>
</li>
<li>read PRISM data
<ul>
<li>use <code><a href="https://rspatial.github.io/terra/reference/rast.html">terra::rast()</a></code>
</li>
</ul>
</li>
<li>extract the CRS of PRISM data
<ul>
<li>use <code><a href="https://rspatial.github.io/terra/reference/crs.html">terra::crs()</a></code>
</li>
</ul>
</li>
<li>create regular grids within IA, which become the observation units of the econometric analysis
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">sf::st_make_grid()</a></code>
</li>
</ul>
</li>
<li>remove grids that share small area with IA
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">sf::st_area</a></code>
</li>
</ul>
</li>
<li>assign crop share and weather data to each of the generated IA grids (parallelized)
<ul>
<li>use <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> and <code><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future.apply::future_lapply()</a></code>
</li>
</ul>
</li>
<li>create maps
<ul>
<li>use the <code>tmap</code> package</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Preparation for replication</strong></p>
<ul>
<li>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">terra</span>, <span class="co"># raster data operations</span></span>
<span>  <span class="va">exactextractr</span>, <span class="co"># fast raster data extraction for polygons</span></span>
<span>  <span class="va">maps</span>, <span class="co"># to get county boundary data</span></span>
<span>  <span class="va">data.table</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">lubridate</span>, <span class="co"># Date object handling</span></span>
<span>  <span class="va">tmap</span>, <span class="co"># for map creation</span></span>
<span>  <span class="va">modelsummary</span>, <span class="co"># regression table generation</span></span>
<span>  <span class="va">future.apply</span>, <span class="co"># parallel computation</span></span>
<span>  <span class="va">CropScapeR</span>, <span class="co"># download CDL data</span></span>
<span>  <span class="va">prism</span>, <span class="co"># download PRISM data</span></span>
<span>  <span class="va">stringr</span> <span class="co"># string manipulation</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="project-demonstration-2" class="level3 page-columns page-full" data-number="1.3.2"><h3 data-number="1.3.2" class="anchored" data-anchor-id="project-demonstration-2">
<span class="header-section-number">1.3.2</span> Project Demonstration</h3>
<p>The geographic focus of this project is Iowas. Let’s get Iowa state border (see <a href="#fig-IA-map" class="quarto-xref">Figure&nbsp;<span>1.8</span></a> for its map).</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- IA state boundary ---#</span></span>
<span><span class="va">IA_boundary</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Iowa"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- map IA state border ---#</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">IA_boundary</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_polygons</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-IA-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-IA-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-IA-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-IA-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.8: Iowa state boundary
</figcaption></figure>
</div>
</div>
</div>
</div><div id="fn7"><p><sup>7</sup>&nbsp;We by no means are saying that this is the right geographical unit of analysis. This is just about demonstrating how R can be used for analysis done at the higher spatial resolution than county.</p></div></div><p>The unit of analysis is artificial grids that we create over Iowa. The grids are regularly-sized rectangles except around the edge of the Iowa state border<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>. So, let’s create grids and remove those that do not overlap much with Iowa (<a href="#fig-Demo-3-IA-grids-map" class="quarto-xref">Figure&nbsp;<span>1.9</span></a> shows what the generated grids look like).</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- create regular grids (40 cells by 40 columns) over IA ---#</span></span>
<span><span class="va">IA_grids</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">IA_boundary</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- create grids ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid</a></span><span class="op">(</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- convert to sf ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- assign grid id for future merge ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>grid_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- make some of the invalid polygons valid ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- drop grids that do not overlap with Iowa ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="va">IA_boundary</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- plot the grids over the IA state border ---#</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">IA_boundary</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_borders</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">IA_grids</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_borders</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-Demo-3-IA-grids-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Demo-3-IA-grids-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-Demo-3-IA-grids-map-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Demo-3-IA-grids-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.9: Map of regular grids generated over IA
</figcaption></figure>
</div>
</div>
</div>
</div></div><hr>
<p>Let’s work on crop share data. You can download CDL data using the <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">CropScapeR::GetCDLData()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- download the CDL data for IA in 2015 ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">cdl_IA_2015</span> <span class="op">&lt;-</span> <span class="fu">CropScapeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">19</span>, year <span class="op">=</span> <span class="fl">2015</span>, type <span class="op">=</span> <span class="st">"f"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The cells (30 meter by 30 meter) of the imported raster layer take a value ranging from 0 to 255. Corn and soybean are represented by 1 and 5, respectively.</p>
<p><a href="#fig-overlap-cdl-grid" class="quarto-xref">Figure&nbsp;<span>1.10</span></a> shows the map of one of the IA grids and the CDL cells it overlaps with.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">temp_grid</span> <span class="op">&lt;-</span> <span class="va">IA_grids</span><span class="op">[</span><span class="fl">100</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">extent_grid</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">temp_grid</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="va">IA_cdl_2015</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raster_ovelap</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">IA_cdl_2015</span>, <span class="va">extent_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">raster_ovelap</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Layer_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">temp_grid</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-overlap-cdl-grid" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-overlap-cdl-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-overlap-cdl-grid-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-overlap-cdl-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.10: Spatial overlap of an IA grid and CDL layer
</figcaption></figure>
</div>
</div>
</div>
<p>We would like to extract all the cell values within the red border.</p>
<p>We use <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> to identify which cells of the CDL raster layer fall within each of the IA grids and extract land use type values. We then find the share of corn and soybean for each of the grids.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- reproject grids to the CRS of the CDL data ---#</span></span>
<span><span class="va">IA_grids_rp_cdl</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">IA_grids</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="va">IA_cdl_2015</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- extract crop type values and find frequencies ---#</span></span>
<span><span class="va">cdl_extracted</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_2015</span>, <span class="va">IA_grids_rp_cdl</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">data.table</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="va">value</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- combine the list of data.tables into one data.table ---#</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span>idcol <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- find the share of each land use type ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">share</span> <span class="op">:=</span> <span class="va">N</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">.id</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">N</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- keep only the share of corn and soy ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="va">value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then find the corn to soy ratio for each of the IA grids.</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- find corn/soy ratio ---#</span></span>
<span><span class="va">corn_soy</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cdl_extracted</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- long to wide ---#</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">.id</span> <span class="op">~</span> <span class="va">value</span>, value.var <span class="op">=</span> <span class="st">"share"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- change variable names ---#</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".id"</span>, <span class="st">"1"</span>, <span class="st">"5"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grid_id"</span>, <span class="st">"corn_share"</span>, <span class="st">"soy_share"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- corn share divided by soy share ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">c_s_ratio</span> <span class="op">:=</span> <span class="va">corn_share</span> <span class="op">/</span> <span class="va">soy_share</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>We are still missing daily precipitation data at the moment. We have decided to use daily weather data from PRISM. Daily PRISM data is a raster data with the cell size of 4 km by 4 km. <a href="#fig-Demo-3-show-prism-data" class="quarto-xref">Figure&nbsp;<span>1.11</span></a> presents precipitation data downloaded for April 1, 2010. It covers the entire contiguous U.S.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prism_ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/prism_ex.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">prism_ex</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-Demo-3-show-prism-data" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Demo-3-show-prism-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-Demo-3-show-prism-data-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Demo-3-show-prism-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.11: Map of PRISM raster data layer
</figcaption></figure>
</div>
</div>
</div>
<p>Let’s now download PRISM data (You do not have to run this code to get the data. It is included in the data folder for replication <a href="https://www.dropbox.com/sh/rtbs4ji21c9uiy9/AADYpHAWhUxMittAptuq-Apaa?dl=0">here</a>). This can be done using the <code>get_prism_dailys()</code> function from the <code>prism</code> package.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<!-- not to be seen -->
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;<a href="https://github.com/ropensci/prism">prism Github page</a></p></div></div><div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>prism.path <span class="op">=</span> <span class="st">"Data/PRISM"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">prism</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">get_prism_dailys</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"ppt"</span>,</span>
<span>  minDate <span class="op">=</span> <span class="st">"2014-04-01"</span>,</span>
<span>  maxDate <span class="op">=</span> <span class="st">"2014-09-30"</span>,</span>
<span>  keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we use <code>get_prism_dailys()</code> to download data<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>, it creates one folder for each day. So, I have about 180 folders inside the folder I designated as the download destination above with the <code><a href="https://rdrr.io/r/base/options.html">options()</a></code> function.</p>
<!-- The name of the folder is expressive about what the data inside it is about. For example, the precipitation data for April 1st, 2010 is stored in the folder called "PRISM_ppt_stable_4kmD2_20100401_bil." Inside it, you will see bunch of files with exactly the same prefix, but with different extensions.   -->
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;For this project, monthly PRISM data could have been used, which can be downloaded using the <code><a href="https://docs.ropensci.org/prism/reference/get_prism_data.html">prism::get_prism_monthlys()</a></code> function. But, in many applications, daily data is necessary, so how to download and process them is illustrated here.</p></div></div><hr>
<p>We now try to extract precipitation value by day for each of the IA grids by geographically overlaying IA grids onto the PRISM data layer and identify which PRISM cells each of the IA grid encompass. <a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn10"><p><sup>10</sup>&nbsp;Be cautious about using <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">sf::st_buffer()</a></code> for spatial objects in geographic coordinates (latitude, longitude) in practice. Significant distortion will be introduced to the buffer due to the fact that one degree in latitude and longitude means different distances at the latitude of IA. Here, I am just creating a buffer to extract PRISM cells to display on the map.</p></div></div><div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read a PRISM dataset ---#</span></span>
<span><span class="va">prism_whole</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="st">"Data/PRISM/PRISM_ppt_stable_4kmD2_20140401_bil/PRISM_ppt_stable_4kmD2_20140401_bil.bil"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- align the CRS ---#</span></span>
<span><span class="va">IA_grids_rp_prism</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">IA_grids</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="va">prism_whole</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- crop the PRISM data for the 1st IA grid ---#</span></span>
<span><span class="fu">sf_use_s2</span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">PRISM_1</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">prism_whole</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">IA_grids_rp_prism</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, dist <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-Demo-3-prism-crop" class="quarto-xref">Figure&nbsp;<span>1.12</span></a> shows how the first IA grid (in red) overlaps with the PRISM cells. As you can see, some PRISM grids are fully inside the analysis grid, while others are partially inside it. So, when assigning precipitation values to grids, we will use the coverage-weighted mean of precipitations.</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- map them ---#</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">PRISM_1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Precipitation"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">IA_grids_rp_prism</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Demo-3-prism-crop" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Demo-3-prism-crop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-Demo-3-prism-crop-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Demo-3-prism-crop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.12: Spatial overlap of an IA grid over PRISM cells
</figcaption></figure>
</div>
</div>
</div>
<p>Unlike the CDL layer, we have 183 raster layers to process. Fortunately, we can process many raster files at the same time very quickly by first “stacking” many raster files first and then applying the <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> function. Using <code><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future.apply::future_lapply()</a></code>, we let <span class="math inline">\(6\)</span> cores take care of this task with each processing 31 files, except one of them handling only 28 files.<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn11"><p><sup>11</sup>&nbsp;Parallelization of extracting values from many raster layers for polygons are discussed in much more detail in <a href="09-SpeedThingsUp.html" class="quarto-xref"><span>Chapter 9</span></a>.</p></div></div><p>We first get all the paths to the PRISM files.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get all the dates ---#</span></span>
<span><span class="va">dates_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2014-04-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2014-09-30"</span><span class="op">)</span>, <span class="st">"days"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- remove hyphen ---#</span></span>
<span><span class="va">dates_ls_no_hyphen</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">dates_ls</span>, <span class="st">"-"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- get all the prism file names ---#</span></span>
<span><span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_ppt_stable_4kmD2_"</span>, <span class="va">dates_ls_no_hyphen</span>, <span class="st">"_bil"</span><span class="op">)</span></span>
<span><span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_ppt_stable_4kmD2_"</span>, <span class="va">dates_ls_no_hyphen</span>, <span class="st">"_bil.bil"</span><span class="op">)</span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span>, <span class="st">"/"</span>, <span class="va">file_name</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">file_paths</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Data/PRISM/PRISM_ppt_stable_4kmD2_20140401_bil/PRISM_ppt_stable_4kmD2_20140401_bil.bil"
[2] "Data/PRISM/PRISM_ppt_stable_4kmD2_20140402_bil/PRISM_ppt_stable_4kmD2_20140402_bil.bil"
[3] "Data/PRISM/PRISM_ppt_stable_4kmD2_20140403_bil/PRISM_ppt_stable_4kmD2_20140403_bil.bil"
[4] "Data/PRISM/PRISM_ppt_stable_4kmD2_20140404_bil/PRISM_ppt_stable_4kmD2_20140404_bil.bil"
[5] "Data/PRISM/PRISM_ppt_stable_4kmD2_20140405_bil/PRISM_ppt_stable_4kmD2_20140405_bil.bil"
[6] "Data/PRISM/PRISM_ppt_stable_4kmD2_20140406_bil/PRISM_ppt_stable_4kmD2_20140406_bil.bil"</code></pre>
</div>
</div>
<p>We now prepare for parallelized extractions and then implement them using <code>future_apply()</code> (you can have a look at <a href="A1-ParallelComputing.html" class="quarto-xref"><span>Appendix A</span></a> to familiarize yourself with parallel computation using the <code>future.apply</code> package).</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- define the number of cores to use ---#</span></span>
<span><span class="va">num_core</span> <span class="op">&lt;-</span> <span class="fl">6</span></span>
<span></span>
<span><span class="co">#--- prepare some parameters for parallelization ---#</span></span>
<span><span class="va">file_len</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">file_paths</span><span class="op">)</span></span>
<span><span class="va">files_per_core</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">file_len</span> <span class="op">/</span> <span class="va">num_core</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- prepare for parallel processing ---#</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multicore</span>, workers <span class="op">=</span> <span class="va">num_core</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- reproject IA grids to the CRS of PRISM data ---#</span></span>
<span><span class="va">IA_grids_reprojected</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">IA_grids</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="va">prism_whole</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the function that we run in parallel over 6 cores.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- define the function to extract PRISM values by block of files ---#</span></span>
<span><span class="va">extract_by_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">files_per_core</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co">#--- files processed by core  ---#</span></span>
<span>  <span class="va">start_file_index</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">files_per_core</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="co">#--- indexes for files to process ---#</span></span>
<span>  <span class="va">file_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span></span>
<span>    from <span class="op">=</span> <span class="va">start_file_index</span>,</span>
<span>    to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="op">(</span><span class="va">start_file_index</span> <span class="op">+</span> <span class="va">files_per_core</span><span class="op">)</span>, <span class="va">file_len</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- extract values ---#</span></span>
<span>  <span class="va">data_temp</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">file_paths</span><span class="op">[</span><span class="va">file_index</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="co"># get file names</span></span>
<span>    <span class="co">#--- read as a multi-layer raster ---#</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- extract ---#</span></span>
<span>    <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">IA_grids_reprojected</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- combine into one data set ---#</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- wide to long ---#</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span>id.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"coverage_fraction"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- calculate "area"-weighted mean ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ID</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">data_temp</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s run the function in parallel and calculate precipitation by period.</p>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- run the function ---#</span></span>
<span><span class="va">precip_by_period</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future_lapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">num_core</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">extract_by_block</span><span class="op">(</span><span class="va">x</span>, <span class="va">files_per_core</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- recover the date ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">variable</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">str_extract</span><span class="op">(</span><span class="va">variable</span>, <span class="st">"[0-9]{8}"</span><span class="op">)</span>, <span class="st">"%Y%m%d"</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- change the variable name to date ---#</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="st">"variable"</span>, <span class="st">"date"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- define critical period ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">critical</span> <span class="op">:=</span> <span class="st">"non_critical"</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="fu">month</span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">6</span><span class="op">:</span><span class="fl">8</span>, <span class="va">critical</span> <span class="op">:=</span> <span class="st">"critical"</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- total precipitation by critical dummy  ---#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>precip <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ID</span>, <span class="va">critical</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- wide to long ---#</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">~</span> <span class="va">critical</span>, value.var <span class="op">=</span> <span class="st">"precip"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now have grid-level crop share and precipitation data.</p>
<hr>
<p>Let’s merge them and run regression.<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn12"><p><sup>12</sup>&nbsp;We can match on <code>grid_id</code> from <code>corn_soy</code> and <code>ID</code> from “precip_by_period” because <code>grid_id</code> is identical with the row number and ID variables were created so that the ID value of <span class="math inline">\(i\)</span> corresponds to <span class="math inline">\(i\)</span> th row of <code>IA_grids</code>.</p></div></div><div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- crop share ---#</span></span>
<span><span class="va">reg_data</span> <span class="op">&lt;-</span> <span class="va">corn_soy</span><span class="op">[</span><span class="va">precip_by_period</span>, on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>grid_id <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#--- OLS ---#</span></span>
<span><span class="va">reg_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">c_s_ratio</span> <span class="op">~</span> <span class="va">critical</span> <span class="op">+</span> <span class="va">non_critical</span>, data <span class="op">=</span> <span class="va">reg_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the regression results table.</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- regression table ---#</span></span>
<span><span class="fu">modelsummary</span><span class="fu">::</span><span class="fu"><a href="https://modelsummary.com/man/msummary.html">msummary</a></span><span class="op">(</span></span>
<span>  <span class="va">reg_results</span>,</span>
<span>  stars <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  gof_omit <span class="op">=</span> <span class="st">"IC|Log|Adj|Within|Pseudo"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
 

  
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tinytable_drkckwksok9d4ctmuubn</title>
<style>
.table td.tinytable_css_zi5pstikebakrtq8j8vr, .table th.tinytable_css_zi5pstikebakrtq8j8vr {    border-bottom: solid 0.1em #d3d8dc; }
.table td.tinytable_css_g8o5k9kmr19eoci0t874, .table th.tinytable_css_g8o5k9kmr19eoci0t874 {    text-align: left; }
.table td.tinytable_css_bz70zr3adc5p3l27i8cl, .table th.tinytable_css_bz70zr3adc5p3l27i8cl {    text-align: center; }
.table td.tinytable_css_wwrdcxermy2si3krrs6k, .table th.tinytable_css_wwrdcxermy2si3krrs6k {    border-bottom: solid 0.05em black; }
    </style>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script><div class="container">
      <table class="table table-borderless" id="tinytable_drkckwksok9d4ctmuubn" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
<thead><tr>
<th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr></thead>
<tfoot><tr><td colspan="2">+ p </td></tr></tfoot>
<tbody>
<tr>
<td>(Intercept) </td>
                  <td>2.701*** </td>
                </tr>
<tr>
<td>            </td>
                  <td>(0.161)  </td>
                </tr>
<tr>
<td>critical    </td>
                  <td>-0.002***</td>
                </tr>
<tr>
<td>            </td>
                  <td>(0.000)  </td>
                </tr>
<tr>
<td>non_critical</td>
                  <td>0.000    </td>
                </tr>
<tr>
<td>            </td>
                  <td>(0.000)  </td>
                </tr>
<tr>
<td>Num.Obs.    </td>
                  <td>1218     </td>
                </tr>
<tr>
<td>R2          </td>
                  <td>0.058    </td>
                </tr>
<tr>
<td>F           </td>
                  <td>37.230   </td>
                </tr>
<tr>
<td>RMSE        </td>
                  <td>0.74     </td>
                </tr>
</tbody>
</table>
</div>

    <script>
      function styleCell_tinytable_d8q07cm0q1pwg46i3l74(i, j, css_id) {
        var table = document.getElementById("tinytable_drkckwksok9d4ctmuubn");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_drkckwksok9d4ctmuubn');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_tinytable_d8q07cm0q1pwg46i3l74(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_drkckwksok9d4ctmuubn");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }

window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(0, 0, 'tinytable_css_zi5pstikebakrtq8j8vr') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(0, 1, 'tinytable_css_zi5pstikebakrtq8j8vr') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(0, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(1, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(2, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(3, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(4, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(5, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(6, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(7, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(8, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(9, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(10, 0, 'tinytable_css_g8o5k9kmr19eoci0t874') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(0, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(1, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(2, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(3, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(4, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(5, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(6, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(7, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(8, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(9, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(10, 1, 'tinytable_css_bz70zr3adc5p3l27i8cl') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(6, 0, 'tinytable_css_wwrdcxermy2si3krrs6k') })
window.addEventListener('load', function () { styleCell_tinytable_d8q07cm0q1pwg46i3l74(6, 1, 'tinytable_css_wwrdcxermy2si3krrs6k') })
    </script>
</div>
</div>
<p>Again, do not read into the results as the econometric model is terrible.</p>
</section></section><section id="sec-demo-railroad" class="level2 page-columns page-full" data-number="1.4"><h2 data-number="1.4" class="anchored" data-anchor-id="sec-demo-railroad">
<span class="header-section-number">1.4</span> The Impact of Railroad Presence on Corn Planted Acreage</h2>
<section id="project-overview-3" class="level3" data-number="1.4.1"><h3 data-number="1.4.1" class="anchored" data-anchor-id="project-overview-3">
<span class="header-section-number">1.4.1</span> Project Overview</h3>
<hr>
<p><strong>Objective</strong></p>
<ul>
<li>Understand the impact of railroad on corn planted acreage in Illinois</li>
</ul>
<hr>
<p><strong>Datasets</strong></p>
<ul>
<li>USDA corn planted acreage for Illinois downloaded from the USDA NationalAgricultural Statistics Service (NASS) QuickStats service using <code>tidyUSDA</code> package</li>
<li>US railroads (line data) downloaded from <a href="https://catalog.data.gov/dataset/tiger-line-shapefile-2015-nation-u-s-rails-national-shapefile">here</a>
</li>
</ul>
<hr>
<p><strong>Econometric Model</strong></p>
<p>We will estimate the following model:</p>
<p><span class="math display">\[
  y_i = \beta_0 + \beta_1 RL_i + v_i
\]</span></p>
<p>where <span class="math inline">\(y_i\)</span> is corn planted acreage in county <span class="math inline">\(i\)</span> in Illinois, <span class="math inline">\(RL_i\)</span> is the total length of railroad, and <span class="math inline">\(v_i\)</span> is the error term.</p>
<hr>
<p><strong>GIS tasks</strong></p>
<ul>
<li>Download USDA corn planted acreage by county as a spatial dataset (<code>sf</code> object)
<ul>
<li>use <code>tidyUSDA::getQuickStat()</code>
</li>
</ul>
</li>
<li>Import US railroad shape file as a spatial dataset (<code>sf</code> object)
<ul>
<li>use <code>sf:st_read()</code>
</li>
</ul>
</li>
<li>Spatially subset (crop) the railroad data to the geographic boundary of Illinois
<ul>
<li>use <code>sf_1[sf_2, ]</code>
</li>
</ul>
</li>
<li>Find railroads for each county (cross-county railroad will be chopped into pieces for them to fit within a single county)
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code><br>
</li>
</ul>
</li>
<li>Calculate the travel distance of each railroad piece
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">sf::st_length()</a></code>
</li>
</ul>
</li>
<li>create maps using the <code>ggplot2</code> package
<ul>
<li>use <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">ggplot2::geom_sf()</a></code>
</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Preparation for replication</strong></p>
<ul>
<li>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">tidyUSDA</span>, <span class="co"># access USDA NASS data</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">ggplot2</span>, <span class="co"># for map creation</span></span>
<span>  <span class="va">modelsummary</span>, <span class="co"># regression table generation</span></span>
<span>  <span class="va">keyring</span> <span class="co"># API management</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Run the following code to define the theme for map:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">theme_for_map</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    axis.ticks <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.border <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span>, color <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="project-demonstration-3" class="level3 page-columns page-full" data-number="1.4.2"><h3 data-number="1.4.2" class="anchored" data-anchor-id="project-demonstration-3">
<span class="header-section-number">1.4.2</span> Project Demonstration</h3>
<p>We first download corn planted acreage data for 2018 from USDA NASS QuickStat service using <code>tidyUSDA</code> package<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn13"><p><sup>13</sup>&nbsp;In order to actually download the data, you need to obtain the API key <a href="https://quickstats.nass.usda.gov/api">here</a>. Once the API key was obtained, it was stored using <code>keyring::set_key()</code>, which was named “usda_nass_qs_api”. In the code to the left, the API key was retrieved using <code>keyring::key_get("usda_nass_qs_api")</code> in the code. For your replication, replace <code>key_get("usda_nass_qs_api")</code> with your own API key.</p></div></div><div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">IL_corn_planted</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">getQuickstat</span><span class="op">(</span></span>
<span>      <span class="co">#--- use your own API key here fore replication ---#</span></span>
<span>      key <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html">key_get</a></span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,</span>
<span>      program <span class="op">=</span> <span class="st">"SURVEY"</span>,</span>
<span>      data_item <span class="op">=</span> <span class="st">"CORN - ACRES PLANTED"</span>,</span>
<span>      geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,</span>
<span>      state <span class="op">=</span> <span class="st">"ILLINOIS"</span>,</span>
<span>      year <span class="op">=</span> <span class="st">"2018"</span>,</span>
<span>      geometry <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- keep only some of the variables ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">NAME</span>, <span class="va">county_code</span>, <span class="va">short_desc</span>, <span class="va">Value</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 90 features and 5 fields (with 6 geometries empty)
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -91.51308 ymin: 36.9703 xmax: -87.4952 ymax: 42.50848
Geodetic CRS:  NAD83
First 10 features:
   year        NAME county_code           short_desc  Value
1  2018      Bureau         011 CORN - ACRES PLANTED 264000
2  2018     Carroll         015 CORN - ACRES PLANTED 134000
3  2018       Henry         073 CORN - ACRES PLANTED 226500
4  2018  Jo Daviess         085 CORN - ACRES PLANTED  98500
5  2018         Lee         103 CORN - ACRES PLANTED 236500
6  2018      Mercer         131 CORN - ACRES PLANTED 141000
7  2018        Ogle         141 CORN - ACRES PLANTED 217000
8  2018      Putnam         155 CORN - ACRES PLANTED  32300
9  2018 Rock Island         161 CORN - ACRES PLANTED  68400
10 2018  Stephenson         177 CORN - ACRES PLANTED 166500
                         geometry
1  MULTIPOLYGON (((-89.16654 4...
2  MULTIPOLYGON (((-89.97844 4...
3  MULTIPOLYGON (((-89.85722 4...
4  MULTIPOLYGON (((-90.21448 4...
5  MULTIPOLYGON (((-89.05201 4...
6  MULTIPOLYGON (((-91.11419 4...
7  MULTIPOLYGON (((-88.94215 4...
8  MULTIPOLYGON (((-89.46647 4...
9  MULTIPOLYGON (((-90.33554 4...
10 MULTIPOLYGON (((-89.62982 4...</code></pre>
</div>
</div>
<p>A nice thing about this function is that the data is downloaded as an <code>sf</code> object with county geometry with <code>geometry = TRUE</code>. So, you can immediately plot it (<a href="#fig-map-il-corn-acreage" class="quarto-xref">Figure&nbsp;<span>1.13</span></a>) and use it for later spatial interactions without having to merge the downloaded data to an independent county boundary data.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">IL_corn_planted</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Value</span> <span class="op">/</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Planted Acreage (1000 acres)"</span>, palette <span class="op">=</span> <span class="st">"YlOrRd"</span>, trans <span class="op">=</span> <span class="st">"reverse"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-map-il-corn-acreage" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-map-il-corn-acreage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-map-il-corn-acreage-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-il-corn-acreage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.13: Map of Con Planted Acreage in Illinois in 2018
</figcaption></figure>
</div>
</div>
</div>
<hr>
<p>Let’s import the U.S. railroad data and reproject to the CRS of <code>IL_corn_planted</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rail_roads</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/tl_2015_us_rails.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- reproject to the CRS of IL_corn_planted ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">IL_corn_planted</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `tl_2015_us_rails' from data source 
  `/Users/tmieno2/Dropbox/TeachingUNL/R-as-GIS-for-Scientists/chapters/Data/tl_2015_us_rails.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 180958 features and 3 fields
Geometry type: MULTILINESTRING
Dimension:     XY
Bounding box:  xmin: -165.4011 ymin: 17.95174 xmax: -65.74931 ymax: 65.00006
Geodetic CRS:  NAD83</code></pre>
</div>
</div>
<p><a href="#fig-Demo5-rail-plot" class="quarto-xref">Figure&nbsp;<span>1.14</span></a> shows is what it looks like:</p>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">rail_roads</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Demo5-rail-plot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Demo5-rail-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-Demo5-rail-plot-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Demo5-rail-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.14: Map of Railroads
</figcaption></figure>
</div>
</div>
</div>
<p>We now crop it to the Illinois state border (<a href="#fig-Demo5-rail-IL-plot" class="quarto-xref">Figure&nbsp;<span>1.15</span></a>):</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rail_roads_IL</span> <span class="op">&lt;-</span> <span class="va">rail_roads</span><span class="op">[</span><span class="va">IL_corn_planted</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">rail_roads_IL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Demo5-rail-IL-plot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Demo5-rail-IL-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-Demo5-rail-IL-plot-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Demo5-rail-IL-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.15: Map of railroads in Illinois
</figcaption></figure>
</div>
</div>
</div>
<p>Let’s now find railroads for each county, where cross-county railroads will be chopped into pieces so each piece fits completely within a single county, using <code>st_intersection()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rails_IL_segmented</span> <span class="op">&lt;-</span> <span class="fu">st_intersection</span><span class="op">(</span><span class="va">rail_roads_IL</span>, <span class="va">IL_corn_planted</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the railroads for Richland County:</p>
<div class="cell">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">IL_corn_planted</span>, <span class="va">NAME</span> <span class="op">==</span> <span class="st">"Richland"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rails_IL_segmented</span>, <span class="va">NAME</span> <span class="op">==</span> <span class="st">"Richland"</span><span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">LINEARID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_for_map</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/map_seg_rail-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We now calculate the travel distance (Great-circle distance) of each railroad piece using <code>st_length()</code> and then sum them up by county to find total railroad length by county.</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">rail_length_county</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      <span class="va">rails_IL_segmented</span>,</span>
<span>      length_in_m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">st_length</span><span class="op">(</span><span class="va">rails_IL_segmented</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- geometry no longer needed ---#</span></span>
<span>    <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- group by county ID ---#</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">county_code</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- sum rail length by county ---#</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>length_in_m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">length_in_m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 82 × 2
   county_code length_in_m
   &lt;chr&gt;             &lt;dbl&gt;
 1 001              77221.
 2 003              77293.
 3 007              36757.
 4 011             255425.
 5 015             161620.
 6 017              30585.
 7 019             389226.
 8 021             155749.
 9 023              78592.
10 025              92030.
# ℹ 72 more rows</code></pre>
</div>
</div>
<hr>
<p>We merge the railroad length data to the corn planted acreage data and estimate the model.</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">reg_data</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">IL_corn_planted</span>, <span class="va">rail_length_county</span>, by <span class="op">=</span> <span class="st">"county_code"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Value</span> <span class="op">~</span> <span class="va">length_in_m</span>, data <span class="op">=</span> <span class="va">reg_data</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">modelsummary</span><span class="op">(</span></span>
<span>    stars <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    gof_omit <span class="op">=</span> <span class="st">"IC|Log|Adj|Within|Pseudo"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
 

  
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tinytable_dicszxjt32zpffg2nqq0</title>
<style>
.table td.tinytable_css_hz7xujvz2x5coama6iog, .table th.tinytable_css_hz7xujvz2x5coama6iog {    border-bottom: solid 0.1em #d3d8dc; }
.table td.tinytable_css_nmspft166lkjbuanfcrg, .table th.tinytable_css_nmspft166lkjbuanfcrg {    text-align: left; }
.table td.tinytable_css_x1jhcdc3cstmwx88tzvm, .table th.tinytable_css_x1jhcdc3cstmwx88tzvm {    text-align: center; }
.table td.tinytable_css_93t4gqa1dez3fopr0211, .table th.tinytable_css_93t4gqa1dez3fopr0211 {    border-bottom: solid 0.05em black; }
    </style>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script><div class="container">
      <table class="table table-borderless" id="tinytable_dicszxjt32zpffg2nqq0" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
<thead><tr>
<th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr></thead>
<tfoot><tr><td colspan="2">+ p </td></tr></tfoot>
<tbody>
<tr>
<td>(Intercept)</td>
                  <td>108153.372***</td>
                </tr>
<tr>
<td>           </td>
                  <td>(11419.166)  </td>
                </tr>
<tr>
<td>length_in_m</td>
                  <td>0.092+       </td>
                </tr>
<tr>
<td>           </td>
                  <td>(0.047)      </td>
                </tr>
<tr>
<td>Num.Obs.   </td>
                  <td>82           </td>
                </tr>
<tr>
<td>R2         </td>
                  <td>0.046        </td>
                </tr>
<tr>
<td>F          </td>
                  <td>3.866        </td>
                </tr>
<tr>
<td>RMSE       </td>
                  <td>68193.40     </td>
                </tr>
</tbody>
</table>
</div>

    <script>
      function styleCell_tinytable_eck14731ij0x0nzkce23(i, j, css_id) {
        var table = document.getElementById("tinytable_dicszxjt32zpffg2nqq0");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_dicszxjt32zpffg2nqq0');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_tinytable_eck14731ij0x0nzkce23(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_dicszxjt32zpffg2nqq0");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }

window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(0, 0, 'tinytable_css_hz7xujvz2x5coama6iog') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(0, 1, 'tinytable_css_hz7xujvz2x5coama6iog') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(0, 0, 'tinytable_css_nmspft166lkjbuanfcrg') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(1, 0, 'tinytable_css_nmspft166lkjbuanfcrg') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(2, 0, 'tinytable_css_nmspft166lkjbuanfcrg') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(3, 0, 'tinytable_css_nmspft166lkjbuanfcrg') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(4, 0, 'tinytable_css_nmspft166lkjbuanfcrg') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(5, 0, 'tinytable_css_nmspft166lkjbuanfcrg') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(6, 0, 'tinytable_css_nmspft166lkjbuanfcrg') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(7, 0, 'tinytable_css_nmspft166lkjbuanfcrg') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(8, 0, 'tinytable_css_nmspft166lkjbuanfcrg') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(0, 1, 'tinytable_css_x1jhcdc3cstmwx88tzvm') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(1, 1, 'tinytable_css_x1jhcdc3cstmwx88tzvm') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(2, 1, 'tinytable_css_x1jhcdc3cstmwx88tzvm') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(3, 1, 'tinytable_css_x1jhcdc3cstmwx88tzvm') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(4, 1, 'tinytable_css_x1jhcdc3cstmwx88tzvm') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(5, 1, 'tinytable_css_x1jhcdc3cstmwx88tzvm') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(6, 1, 'tinytable_css_x1jhcdc3cstmwx88tzvm') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(7, 1, 'tinytable_css_x1jhcdc3cstmwx88tzvm') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(8, 1, 'tinytable_css_x1jhcdc3cstmwx88tzvm') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(4, 0, 'tinytable_css_93t4gqa1dez3fopr0211') })
window.addEventListener('load', function () { styleCell_tinytable_eck14731ij0x0nzkce23(4, 1, 'tinytable_css_93t4gqa1dez3fopr0211') })
    </script>
</div>
</div>
<hr></section></section><section id="sec-demo-gw-ir" class="level2 page-columns page-full" data-number="1.5"><h2 data-number="1.5" class="anchored" data-anchor-id="sec-demo-gw-ir">
<span class="header-section-number">1.5</span> Groundwater use for agricultural irrigation</h2>
<section id="project-overview-4" class="level3" data-number="1.5.1"><h3 data-number="1.5.1" class="anchored" data-anchor-id="project-overview-4">
<span class="header-section-number">1.5.1</span> Project Overview</h3>
<hr>
<p><strong>Objective</strong></p>
<ul>
<li>Understand the impact of monthly precipitation on groundwater use for agricultural irrigation</li>
</ul>
<hr>
<p><strong>Datasets</strong></p>
<ul>
<li>Annual groundwater pumping by irrigation wells in Kansas for 2010 and 2011 (originally obtained from the Water Information Management &amp; Analysis System (WIMAS) database)</li>
<li>Daymet daily precipitation and maximum temperature downloaded using <code>daymetr</code> package</li>
</ul>
<hr>
<p><strong>Econometric Model</strong></p>
<p>The econometric model we would like to estimate is:</p>
<p><span class="math display">\[
   y_{i,t}  = \alpha +  P_{i,t} \beta + T_{i,t} \gamma + \phi_i + \eta_t + v_{i,t}
\]</span></p>
<p>where <span class="math inline">\(y\)</span> is the total groundwater extracted in year <span class="math inline">\(t\)</span>, <span class="math inline">\(P_{i,t}\)</span> and <span class="math inline">\(T_{i,t}\)</span> is the collection of monthly total precipitation and mean maximum temperature April through September in year <span class="math inline">\(t\)</span>, respectively, <span class="math inline">\(\phi_i\)</span> is the well fixed effect, <span class="math inline">\(\eta_t\)</span> is the year fixed effect, and <span class="math inline">\(v_{i,t}\)</span> is the error term.</p>
<hr>
<p><strong>GIS tasks</strong></p>
<ul>
<li>download Daymet precipitation and maximum temperature data for each well from within R in parallel
<ul>
<li>use <code><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">daymetr::download_daymet()</a></code> and <code><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future.apply::future_lapply()</a></code>
</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Preparation for replication</strong></p>
<ul>
<li>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">daymetr</span>, <span class="co"># get Daymet data</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">data.table</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">ggplot2</span>, <span class="co"># for map creation</span></span>
<span>  <span class="va">RhpcBLASctl</span>, <span class="co"># to get the number of available cores</span></span>
<span>  <span class="va">future.apply</span>, <span class="co"># parallelization</span></span>
<span>  <span class="va">lfe</span>, <span class="co"># fast regression with many fixed effects</span></span>
<span>  <span class="va">modelsummary</span> <span class="co"># regression table generation</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="project-demonstration-4" class="level3 page-columns page-full" data-number="1.5.2"><h3 data-number="1.5.2" class="anchored" data-anchor-id="project-demonstration-4">
<span class="header-section-number">1.5.2</span> Project Demonstration</h3>
<p>We have already collected annual groundwater pumping data by irrigation wells in 2010 and 2011 in Kansas from the Water Information Management &amp; Analysis System (WIMAS) database. Let’s read in the groundwater use data.</p>
<div class="cell">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read in the data ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">gw_KS_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/gw_KS_sf.rds"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 56225 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -102.0495 ymin: 36.99561 xmax: -94.70746 ymax: 40.00191
Geodetic CRS:  NAD83
First 10 features:
   well_id year   af_used                   geometry
1        1 2010  67.00000 POINT (-100.4423 37.52046)
2        1 2011 171.00000 POINT (-100.4423 37.52046)
3        3 2010  30.93438 POINT (-100.7118 39.91526)
4        3 2011  12.00000 POINT (-100.7118 39.91526)
5        7 2010   0.00000 POINT (-101.8995 38.78077)
6        7 2011   0.00000 POINT (-101.8995 38.78077)
7       11 2010 154.00000 POINT (-101.7114 39.55035)
8       11 2011 160.00000 POINT (-101.7114 39.55035)
9       12 2010  28.17239 POINT (-95.97031 39.16121)
10      12 2011  89.53479 POINT (-95.97031 39.16121)</code></pre>
</div>
</div>
<p>We have 28553 wells in total, and each well has records of groundwater pumping (<code>af_used</code>) for years 2010 and 2011.</p>
<div class="cell">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS_counties</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Kansas"</span>, cb<span class="op">=</span> <span class="cn">TRUE</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-well-dist" class="quarto-xref">Figure&nbsp;<span>1.16</span></a> shows the spatial distribution of the wells.</p>

<!--end of column-margin-->
<!-- 
#=========================================
# Daymet data download and processing 
#=========================================
-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">KS_counties</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">gw_KS_sf</span>, size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-well-dist" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-well-dist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="01-Demonstration_files/figure-html/fig-well-dist-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-well-dist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.16: Spatial distribution of the wells in Kansas
</figcaption></figure>
</div>
</div>
</div>
</div></div><hr>
<p>We now need to get monthly precipitation and maximum temperature data. We have decided that we use <a href="https://daymet.ornl.gov/">Daymet</a> weather data. Here we use the <code>download_daymet()</code> function from the <code>daymetr</code> package<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> that allows us to download all the weather variables for a specified geographic location and time period<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a>. We write a wrapper function that downloads Daymet data and then processes it to find monthly total precipitation and mean maximum temperature<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a>. We then loop over the 56225 wells, which is parallelized using the <code><a href="https://future.apply.futureverse.org/reference/future_apply.html">future.apply::future_apply()</a></code> function<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a>. This process takes about half an hour on my Mac with parallelization on 18 cores. The data is available in the data repository for this course (named as “all_daymet.rds”).</p>
<div class="no-row-height column-margin column-container"><div id="fn14"><p><sup>14</sup>&nbsp;<a href="https://cran.r-project.org/web/packages/daymetr/vignettes/daymetr-vignette.html">daymetr vignette</a></p></div><div id="fn15"><p><sup>15</sup>&nbsp;See <a href="08-DownloadSpatialData.html#sec-daymetr" class="quarto-xref"><span>Section 8.4</span></a> for a fuller explanation of how to use the <code>daymetr</code> package.</p></div><div id="fn16"><p><sup>16</sup>&nbsp;This may not be ideal for a real research project because the original raw data is not kept. It is often the case that your econometric plan changes on the course of your project (e.g., using other weather variables or using different temporal aggregation of weather variables instead of monthly aggregation). When this happens, you need to download the same data all over again.</p></div><div id="fn17"><p><sup>17</sup>&nbsp;For parallelized computation, see <a href="A1-ParallelComputing.html" class="quarto-xref"><span>Appendix A</span></a></p></div></div><div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the geographic coordinates of the wells ---#</span></span>
<span><span class="va">well_locations</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">gw_KS_sf</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"well_id"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">well_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu">st_coordinates</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- define a function that downloads Daymet data by well and process it ---#</span></span>
<span><span class="va">get_daymet</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp_site</span> <span class="op">&lt;-</span> <span class="va">well_locations</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">$</span><span class="va">well_id</span></span>
<span>  <span class="va">temp_long</span> <span class="op">&lt;-</span> <span class="va">well_locations</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">$</span><span class="va">X</span></span>
<span>  <span class="va">temp_lat</span> <span class="op">&lt;-</span> <span class="va">well_locations</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">$</span><span class="va">Y</span></span>
<span></span>
<span>  <span class="va">data_temp</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">daymetr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">download_daymet</a></span><span class="op">(</span></span>
<span>      site <span class="op">=</span> <span class="va">temp_site</span>,</span>
<span>      lat <span class="op">=</span> <span class="va">temp_lat</span>,</span>
<span>      lon <span class="op">=</span> <span class="va">temp_long</span>,</span>
<span>      start <span class="op">=</span> <span class="fl">2010</span>,</span>
<span>      end <span class="op">=</span> <span class="fl">2011</span>,</span>
<span>      <span class="co">#--- if TRUE, tidy data is returned ---#</span></span>
<span>      simplify <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      <span class="co">#--- if TRUE, the downloaded data can be assigned to an R object ---#</span></span>
<span>      internal <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- keep only precip and tmax ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span><span class="va">measurement</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"prcp..mm.day."</span>, <span class="st">"tmax..deg.c."</span><span class="op">)</span>, <span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- recover calender date from Julian day ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">date</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">yday</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>, <span class="st">"%Y-%j"</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- get month ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">month</span> <span class="op">:=</span> <span class="fu">month</span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- keep only April through September ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">4</span><span class="op">:</span><span class="fl">9</span>, <span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">site</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">date</span>, <span class="va">measurement</span>, <span class="va">value</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- long to wide ---#</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">site</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">month</span> <span class="op">+</span> <span class="va">date</span> <span class="op">~</span> <span class="va">measurement</span>, value.var <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- change variable names ---#</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"prcp..mm.day."</span>, <span class="st">"tmax..deg.c."</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"prcp"</span>, <span class="st">"tmax"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- find the total precip and mean tmax by month-year ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>prcp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">prcp</span><span class="op">)</span>, tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tmax</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">month</span>, <span class="va">year</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">well_id</span> <span class="op">:=</span> <span class="va">temp_site</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">data_temp</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what one run (for the first well) of <code>get_daymet()</code> returns</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- one run ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">returned_data</span> <span class="op">&lt;-</span> <span class="fu">get_daymet</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    month  year  prcp     tmax well_id
    &lt;num&gt; &lt;int&gt; &lt;num&gt;    &lt;num&gt;   &lt;num&gt;
 1:     4  2010 40.72 20.71700       1
 2:     5  2010 93.60 24.41677       1
 3:     6  2010 70.45 32.59933       1
 4:     7  2010 84.58 33.59903       1
 5:     8  2010 66.41 34.17323       1
 6:     9  2010 15.58 31.25800       1
 7:     4  2011 24.04 21.86367       1
 8:     5  2011 25.59 26.51097       1
 9:     6  2011 23.15 35.37533       1
10:     7  2011 35.10 38.60548       1
11:     8  2011 36.66 36.94871       1
12:     9  2011  9.59 28.31800       1</code></pre>
</div>
</div>
<p>We get the number of cores you can use by <code><a href="https://rdrr.io/pkg/RhpcBLASctl/man/RhpcBLASctl-package.html">RhpcBLASctl::get_num_procs()</a></code> and parallelize the loop over wells using <code><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future.apply::future_lapply()</a></code>.<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn18"><p><sup>18</sup>&nbsp;For Mac users, <code><a href="https://rdrr.io/r/parallel/mclapply.html">parallel::mclapply()</a></code> is a good alternative.</p></div></div><div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- prepare for parallelization ---#</span></span>
<span><span class="va">num_cores</span> <span class="op">&lt;-</span> <span class="fu">RhpcBLASctl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RhpcBLASctl/man/RhpcBLASctl-package.html">get_num_procs</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span> <span class="co"># number of cores</span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">multicore</span>, workers <span class="op">=</span> <span class="va">num_cores</span><span class="op">)</span> <span class="co"># set up cores</span></span>
<span></span>
<span><span class="co">#--- run get_daymet with parallelization ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">all_daymet</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">future_lapply</span><span class="op">(</span></span>
<span>      <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">well_locations</span><span class="op">)</span>,</span>
<span>      <span class="va">get_daymet</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">rbindlist</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>        month  year  prcp     tmax well_id
        &lt;num&gt; &lt;num&gt; &lt;num&gt;    &lt;num&gt;   &lt;num&gt;
     1:     4  2010    42 20.96667       1
     2:     5  2010    94 24.19355       1
     3:     6  2010    70 32.51667       1
     4:     7  2010    89 33.50000       1
     5:     8  2010    63 34.17742       1
    ---                                   
336980:     5  2011    18 26.11290   78051
336981:     6  2011    25 34.61667   78051
336982:     7  2011     6 38.37097   78051
336983:     8  2011    39 36.66129   78051
336984:     9  2011    23 28.45000   78051</code></pre>
</div>
</div>
<hr>
<p>Before merging the Daymet data, we need to reshape the data into a wide format to get monthly precipitation and maximum temperature as columns.</p>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- long to wide ---#</span></span>
<span><span class="va">daymet_to_merge</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">all_daymet</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span></span>
<span>    <span class="va">well_id</span> <span class="op">+</span> <span class="va">year</span> <span class="op">~</span> <span class="va">month</span>,</span>
<span>    value.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"prcp"</span>, <span class="st">"tmax"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="va">daymet_to_merge</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;well_id, year&gt;
       well_id  year prcp_4 prcp_5 prcp_6 prcp_7 prcp_8 prcp_9   tmax_4
         &lt;num&gt; &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;    &lt;num&gt;
    1:       1  2010     42     94     70     89     63     15 20.96667
    2:       1  2011     25     26     23     35     37      9 21.91667
    3:       3  2010     85     62    109    112     83     41 19.93333
    4:       3  2011     80    104     44    124    118     14 18.40000
    5:       7  2010     44     83     23     99    105     13 18.81667
   ---                                                                 
56160:   78049  2011     27      6     38     37     34     36 22.81667
56161:   78050  2010     35     48     68    111     56      9 21.38333
56162:   78050  2011     26      7     44     38     34     35 22.76667
56163:   78051  2010     30     62     48     29     76      3 21.05000
56164:   78051  2011     33     18     25      6     39     23 21.90000
         tmax_5   tmax_6   tmax_7   tmax_8   tmax_9
          &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;
    1: 24.19355 32.51667 33.50000 34.17742 31.43333
    2: 26.30645 35.16667 38.62903 36.90323 28.66667
    3: 21.64516 30.73333 32.80645 33.56452 28.93333
    4: 22.62903 30.08333 35.08065 32.90323 25.81667
    5: 22.14516 31.30000 33.12903 32.67742 30.16667
   ---                                             
56160: 26.70968 35.01667 38.32258 36.54839 28.80000
56161: 24.85484 33.16667 33.88710 34.40323 32.11667
56162: 26.70968 34.91667 38.32258 36.54839 28.83333
56163: 24.14516 32.90000 33.83871 34.38710 31.56667
56164: 26.11290 34.61667 38.37097 36.66129 28.45000</code></pre>
</div>
</div>
<p>Now, let’s merge the weather data to the groundwater pumping dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">reg_data</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span><span class="va">gw_KS_sf</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- keep only the relevant variables ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">well_id</span>, <span class="va">year</span>, <span class="va">af_used</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- join ---#</span></span>
<span>    <span class="va">daymet_to_merge</span><span class="op">[</span><span class="va">.</span>, on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"well_id"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       well_id  year prcp_4 prcp_5 prcp_6 prcp_7 prcp_8 prcp_9   tmax_4
         &lt;num&gt; &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;  &lt;num&gt;    &lt;num&gt;
    1:       1  2010     42     94     70     89     63     15 20.96667
    2:       1  2011     25     26     23     35     37      9 21.91667
    3:       3  2010     85     62    109    112     83     41 19.93333
    4:       3  2011     80    104     44    124    118     14 18.40000
    5:       7  2010     44     83     23     99    105     13 18.81667
   ---                                                                 
56221:   79348  2011     NA     NA     NA     NA     NA     NA       NA
56222:   79349  2011     NA     NA     NA     NA     NA     NA       NA
56223:   79367  2011     NA     NA     NA     NA     NA     NA       NA
56224:   79372  2011     NA     NA     NA     NA     NA     NA       NA
56225:   80930  2011     NA     NA     NA     NA     NA     NA       NA
         tmax_5   tmax_6   tmax_7   tmax_8   tmax_9   af_used
          &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;     &lt;num&gt;
    1: 24.19355 32.51667 33.50000 34.17742 31.43333  67.00000
    2: 26.30645 35.16667 38.62903 36.90323 28.66667 171.00000
    3: 21.64516 30.73333 32.80645 33.56452 28.93333  30.93438
    4: 22.62903 30.08333 35.08065 32.90323 25.81667  12.00000
    5: 22.14516 31.30000 33.12903 32.67742 30.16667   0.00000
   ---                                                       
56221:       NA       NA       NA       NA       NA  76.00000
56222:       NA       NA       NA       NA       NA 182.00000
56223:       NA       NA       NA       NA       NA   0.00000
56224:       NA       NA       NA       NA       NA 134.00000
56225:       NA       NA       NA       NA       NA  23.69150</code></pre>
</div>
</div>
<hr>
<p>Let’s run regression and display the results.</p>
<div class="cell">
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- run FE ---#</span></span>
<span><span class="va">reg_results</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span></span>
<span>    <span class="va">af_used</span> <span class="op">~</span> <span class="co"># dependent variable</span></span>
<span>      <span class="va">prcp_4</span> <span class="op">+</span> <span class="va">prcp_5</span> <span class="op">+</span> <span class="va">prcp_6</span> <span class="op">+</span> <span class="va">prcp_7</span> <span class="op">+</span> <span class="va">prcp_8</span> <span class="op">+</span> <span class="va">prcp_9</span></span>
<span>        <span class="op">+</span> <span class="va">tmax_4</span> <span class="op">+</span> <span class="va">tmax_5</span> <span class="op">+</span> <span class="va">tmax_6</span> <span class="op">+</span> <span class="va">tmax_7</span> <span class="op">+</span> <span class="va">tmax_8</span> <span class="op">+</span> <span class="va">tmax_9</span> <span class="op">|</span></span>
<span>        <span class="va">well_id</span> <span class="op">+</span> <span class="va">year</span>, <span class="co"># FEs</span></span>
<span>    cluster <span class="op">=</span> <span class="st">"well_id"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">reg_data</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- display regression results ---#</span></span>
<span><span class="fu">modelsummary</span><span class="fu">::</span><span class="fu"><a href="https://modelsummary.com/man/modelsummary.html">modelsummary</a></span><span class="op">(</span></span>
<span>  <span class="va">reg_results</span>,</span>
<span>  stars <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  gof_omit <span class="op">=</span> <span class="st">"IC|Log|Adj|Within|Pseudo"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
 

  
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tinytable_gi0qhnlynb8avwb1yonl</title>
<style>
.table td.tinytable_css_tgomm9mf6yju6k3re5wb, .table th.tinytable_css_tgomm9mf6yju6k3re5wb {    border-bottom: solid 0.1em #d3d8dc; }
.table td.tinytable_css_sz29ozvizfzpzbec3uv1, .table th.tinytable_css_sz29ozvizfzpzbec3uv1 {    text-align: left; }
.table td.tinytable_css_2cebuqjccisq61zxinz4, .table th.tinytable_css_2cebuqjccisq61zxinz4 {    text-align: center; }
.table td.tinytable_css_fwseubmwjb4wsumeap1w, .table th.tinytable_css_fwseubmwjb4wsumeap1w {    border-bottom: solid 0.05em black; }
    </style>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script><div class="container">
      <table class="table table-borderless" id="tinytable_gi0qhnlynb8avwb1yonl" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
<thead><tr>
<th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr></thead>
<tfoot><tr><td colspan="2">+ p </td></tr></tfoot>
<tbody>
<tr>
<td>prcp_4     </td>
                  <td>-0.053**   </td>
                </tr>
<tr>
<td>           </td>
                  <td>(0.017)    </td>
                </tr>
<tr>
<td>prcp_5     </td>
                  <td>0.112***   </td>
                </tr>
<tr>
<td>           </td>
                  <td>(0.010)    </td>
                </tr>
<tr>
<td>prcp_6     </td>
                  <td>-0.073***  </td>
                </tr>
<tr>
<td>           </td>
                  <td>(0.008)    </td>
                </tr>
<tr>
<td>prcp_7     </td>
                  <td>0.014      </td>
                </tr>
<tr>
<td>           </td>
                  <td>(0.010)    </td>
                </tr>
<tr>
<td>prcp_8     </td>
                  <td>0.093***   </td>
                </tr>
<tr>
<td>           </td>
                  <td>(0.014)    </td>
                </tr>
<tr>
<td>prcp_9     </td>
                  <td>-0.177***  </td>
                </tr>
<tr>
<td>           </td>
                  <td>(0.025)    </td>
                </tr>
<tr>
<td>tmax_4     </td>
                  <td>9.159***   </td>
                </tr>
<tr>
<td>           </td>
                  <td>(1.227)    </td>
                </tr>
<tr>
<td>tmax_5     </td>
                  <td>-7.505***  </td>
                </tr>
<tr>
<td>           </td>
                  <td>(1.062)    </td>
                </tr>
<tr>
<td>tmax_6     </td>
                  <td>15.134***  </td>
                </tr>
<tr>
<td>           </td>
                  <td>(1.360)    </td>
                </tr>
<tr>
<td>tmax_7     </td>
                  <td>3.969*     </td>
                </tr>
<tr>
<td>           </td>
                  <td>(1.618)    </td>
                </tr>
<tr>
<td>tmax_8     </td>
                  <td>3.420**    </td>
                </tr>
<tr>
<td>           </td>
                  <td>(1.066)    </td>
                </tr>
<tr>
<td>tmax_9     </td>
                  <td>-11.803*** </td>
                </tr>
<tr>
<td>           </td>
                  <td>(1.801)    </td>
                </tr>
<tr>
<td>Num.Obs.   </td>
                  <td>55754      </td>
                </tr>
<tr>
<td>R2         </td>
                  <td>0.942      </td>
                </tr>
<tr>
<td>RMSE       </td>
                  <td>33.01      </td>
                </tr>
<tr>
<td>Std.Errors </td>
                  <td>by: well_id</td>
                </tr>
<tr>
<td>FE: well_id</td>
                  <td>X          </td>
                </tr>
<tr>
<td>FE: year   </td>
                  <td>X          </td>
                </tr>
</tbody>
</table>
</div>

    <script>
      function styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(i, j, css_id) {
        var table = document.getElementById("tinytable_gi0qhnlynb8avwb1yonl");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_gi0qhnlynb8avwb1yonl');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_tinytable_zfzd8ixmsk4olx7l1hm3(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_gi0qhnlynb8avwb1yonl");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }

window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(0, 0, 'tinytable_css_tgomm9mf6yju6k3re5wb') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(0, 1, 'tinytable_css_tgomm9mf6yju6k3re5wb') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(0, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(1, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(2, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(3, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(4, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(5, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(6, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(7, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(8, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(9, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(10, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(11, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(12, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(13, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(14, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(15, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(16, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(17, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(18, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(19, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(20, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(21, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(22, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(23, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(24, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(25, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(26, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(27, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(28, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(29, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(30, 0, 'tinytable_css_sz29ozvizfzpzbec3uv1') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(0, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(1, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(2, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(3, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(4, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(5, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(6, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(7, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(8, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(9, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(10, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(11, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(12, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(13, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(14, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(15, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(16, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(17, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(18, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(19, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(20, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(21, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(22, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(23, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(24, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(25, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(26, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(27, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(28, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(29, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(30, 1, 'tinytable_css_2cebuqjccisq61zxinz4') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(24, 0, 'tinytable_css_fwseubmwjb4wsumeap1w') })
window.addEventListener('load', function () { styleCell_tinytable_zfzd8ixmsk4olx7l1hm3(24, 1, 'tinytable_css_fwseubmwjb4wsumeap1w') })
    </script>
</div>
</div>
<p>That’s it. Do not bother to try to read into the regression results. Again, this is just an illustration of how R can be used to prepare a regression-ready dataset with spatial variables.</p>
</section></section><section id="sec-demo-slave" class="level2 page-columns page-full" data-number="1.6"><h2 data-number="1.6" class="anchored" data-anchor-id="sec-demo-slave">
<span class="header-section-number">1.6</span> African Economy and Slaves: Nunn 2008</h2>
<section id="project-overview-5" class="level3" data-number="1.6.1"><h3 data-number="1.6.1" class="anchored" data-anchor-id="project-overview-5">
<span class="header-section-number">1.6.1</span> Project Overview</h3>
<hr>
<p><strong>Objective:</strong></p>
<p>Create some of the variables used in <span class="citation" data-cites="nunn2008long">Nunn (<a href="#ref-nunn2008long" role="doc-biblioref">2008</a>)</span> <a href="https://scholar.harvard.edu/nunn/publications/long-term-effects-africas-slave-trades">here</a></p>
<ul>
<li>the distance variable used as an instrument (distance to the nearest trade center for each country in Africa)<br>
</li>
<li>the number of slaves for each of the countries in Africa</li>
</ul>
<p>The tutorial is originally from http://mkudamatsu.github.io/gis_lecture4.html.</p>
<hr>
<p><strong>Datasets</strong></p>
<ul>
<li>Coast lines of the world</li>
<li>Country boundary in Africa</li>
<li>Boundary of ethnic regions in Africa</li>
</ul>
<hr>
<p><strong>GIS tasks</strong></p>
<ul>
<li>read an ESRI shape file as an <code>sf</code> (spatial) object
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">sf::st_read()</a></code>
</li>
</ul>
</li>
<li>simply a spatial object (reduce the number of points representing it)
<ul>
<li>use <code><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html">rmapshaper::ms_simplify()</a></code>
</li>
</ul>
</li>
<li>find the closest point on the boundary of polygons
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html">sf::st_nearest_points()</a></code>
</li>
</ul>
</li>
<li>find the centroid of a polygon
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">sf::st_centroid()</a></code>
</li>
</ul>
</li>
<li>combine multiple lines into a single line
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">sf::st_union()</a></code>
</li>
</ul>
</li>
<li>identify the last point of a line
<ul>
<li>use <code><a href="https://r-spatial.github.io/lwgeom/reference/st_startpoint.html">lwgeom::st_endpoint()</a></code>
</li>
</ul>
</li>
<li>calculate the distance between two spatial objects
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">sf::st_distance()</a></code>
</li>
</ul>
</li>
<li>implement area-weighted spatial interpolation
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/interpolate_aw.html">sf::st_interpolate_aw()</a></code>
</li>
</ul>
</li>
<li>drop geometry from an <code>sf</code> object
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">sf::st_drop_geometry()</a></code>
</li>
</ul>
</li>
<li>convert a regular <code>data.frame</code> (non-spatial) with geographic coordinates into an <code>sf</code> (spatial) objects
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">sf::st_as_sf()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">sf::st_set_crs()</a></code>
</li>
</ul>
</li>
<li>reproject an <code>sf</code> object to another CRS
<ul>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">sf::st_transform()</a></code>
</li>
<li>use <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code>
</li>
</ul>
</li>
<li>create maps
<ul>
<li>use the <code>ggplot2</code> package</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Preparation for replication</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">tidyverse</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">patchwork</span>, <span class="co"># plot arrangement</span></span>
<span>  <span class="va">units</span>,</span>
<span>  <span class="va">rmapshaper</span>,</span>
<span>  <span class="va">lwgeom</span>,</span>
<span>  <span class="va">tictoc</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="project-demonstration-5" class="level3 page-columns page-full" data-number="1.6.2"><h3 data-number="1.6.2" class="anchored" data-anchor-id="project-demonstration-5">
<span class="header-section-number">1.6.2</span> Project Demonstration</h3>
<p>We first read all the GIS data we will be using in this demonstration and then re-project them to epsg:3857, which is Pseudo-mercator.</p>
<p><strong>coast line</strong></p>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">coast</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/nunn_2008/10m-coastline/10m_coastline.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="fl">3857</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `10m_coastline' from data source 
  `/Users/tmieno2/Dropbox/TeachingUNL/R-as-GIS-for-Scientists/chapters/Data/nunn_2008/10m-coastline/10m_coastline.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 4177 features and 3 fields
Geometry type: MULTILINESTRING
Dimension:     XY
Bounding box:  xmin: -180 ymin: -85.22198 xmax: 180 ymax: 83.6341
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
<hr>
<p><strong>African countries</strong></p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">countries</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/nunn_2008/gadm36_africa/gadm36_africa.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="fl">3857</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `gadm36_africa' from data source 
  `/Users/tmieno2/Dropbox/TeachingUNL/R-as-GIS-for-Scientists/chapters/Data/nunn_2008/gadm36_africa/gadm36_africa.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 54 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -25.3618 ymin: -34.83514 xmax: 63.50347 ymax: 37.55986
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
<hr>
<p><strong>ethnic regions</strong></p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ethnic_regions</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/nunn_2008/Murdock_shapefile/borders_tribes.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="fl">3857</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `borders_tribes' from data source 
  `/Users/tmieno2/Dropbox/TeachingUNL/R-as-GIS-for-Scientists/chapters/Data/nunn_2008/Murdock_shapefile/borders_tribes.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 843 features and 4 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -25.35875 ymin: -34.82223 xmax: 63.50018 ymax: 37.53944
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># lat/long for slave trade centers</span></span>
<span><span class="va">trade_centers</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"Data/nunn_2008/nunn2008.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="calculate-the-distance-to-the-nearest-trade-center" class="level4 page-columns page-full" data-number="1.6.2.1"><h4 data-number="1.6.2.1" class="anchored" data-anchor-id="calculate-the-distance-to-the-nearest-trade-center">
<span class="header-section-number">1.6.2.1</span> Calculate the distance to the nearest trade center</h4>
<p>We first simplify geometries of the African countries using <code><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html">rmapshaper::ms_simplify()</a></code>, so the code run faster, while maintaining borders between countries<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a>. As comparison, <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">sf::st_simplify()</a></code> does not ensure borders between countries remain (see this by running <code>countries_simp_sf &lt;- sf::st_simplify(countries)</code> and <code>plot(countries_simp_sf$geometry)</code>).</p>
<div class="no-row-height column-margin column-container"><div id="fn19"><p><sup>19</sup>&nbsp;The <code>keep</code> option allows you to determine the degree of simplification, with <code>keep = 1</code> being remains the same, <code>keep = 0.001</code> is quite drastic. The default value is 0.05.</p></div></div><div class="cell">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">countries_simp</span> <span class="op">&lt;-</span> <span class="fu">rmapshaper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html">ms_simplify</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">g_countries</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">countries_simp</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/countries-africa-nunn08-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We now finds the centroid of each country using <code>st_centroid()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">countries_centroid</span> <span class="op">&lt;-</span> <span class="fu">st_centroid</span><span class="op">(</span><span class="va">countries</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The red points represent the centroids.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/centroids-africa-nunn08-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, for the centroid of each country, we find its closest point on the coast line using <code>sf::st_nrearest_points()</code>. <code>sf::st_nearest_points(x, y)</code> loops through each geometry in <code>x</code> and returns the closest point in each feature of <code>y</code>. So, we first union the coast lines so we only get the single closest point on the coast.</p>
<div class="cell">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">coast_union</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">coast</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry set for 1 feature 
Geometry type: MULTILINESTRING
Dimension:     XY
Bounding box:  xmin: -20037510 ymin: -20261860 xmax: 20037510 ymax: 18428920
Projected CRS: WGS 84 / Pseudo-Mercator</code></pre>
</div>
</div>
<p>Notice that <code>coast_union</code> is now has a single feature while <code>coast</code> has 4177 lines. Now, we are ready to use <code>st_nearest_points</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">minum_dist_to_coast</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html">st_nearest_points</a></span><span class="op">(</span><span class="va">countries_centroid</span>, <span class="va">coast_union</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see below, this returns a line between the centroid and the coast.</p>
<div class="cell">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">g_min_dist_line</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">countries_simp</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">minum_dist_to_coast</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/lines-africa-nunn08-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>However, what we need is the end point of the lines. We can use <code><a href="https://r-spatial.github.io/lwgeom/reference/st_startpoint.html">lwgeom::st_endpoint()</a></code> to extract such a point<a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn20"><p><sup>20</sup>&nbsp;The <code>lwgeom</code> package is a companion to the <code>sf</code> package. Its package website is <a href="https://r-spatial.github.io/lwgeom/">here</a></p></div></div><div class="cell">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">closest_pt_on_coast</span> <span class="op">&lt;-</span> <span class="fu">lwgeom</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/lwgeom/reference/st_startpoint.html">st_endpoint</a></span><span class="op">(</span><span class="va">minum_dist_to_coast</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The end points are represented as blue points in the figure below.</p>
<div class="cell">
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g_min_dist_line</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">closest_pt_on_coast</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/endpoint-africa-nunn08-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s make <code>closest_pt_on_coast</code> as part of <code>countries_simp</code> by assigning it to a new column named <code>nearest_pt</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">countries_simp</span><span class="op">$</span><span class="va">nearest_pt</span> <span class="op">&lt;-</span> <span class="va">closest_pt_on_coast</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now calculate the distance between the closest point on the coast to the nearest slave trade center. Before doing so, we first need to convert <code>trade_centers</code> to an <code>sf</code> object. At the moment, it is merely a <code>data.frame</code> and cannot be used for spatial operations like calculating distance. Since the <code>lon</code>, <code>lat</code> are in epsg:4326, we first create an <code>sf</code> using the GRS and then reproejct it to epsg:3857, so it has the same CRS as the other <code>sf</code> objects.</p>
<div class="cell">
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">trade_centers_sf</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">trade_centers</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_as_sf</span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">st_transform</span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">3857</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 9 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -9168273 ymin: -2617513 xmax: -4288027 ymax: 4418219
Projected CRS: WGS 84 / Pseudo-Mercator
# A tibble: 9 × 3
  name           fallingrain_name             geometry
* &lt;chr&gt;          &lt;chr&gt;                     &lt;POINT [m]&gt;
1 Virginia       Virginia Beach     (-8458055 4418219)
2 Havana         Habana             (-9168273 2647748)
3 Haiti          Port au Prince     (-8051739 2100853)
4 Kingston       Kingston           (-8549337 2037549)
5 Dominica       Roseau             (-6835017 1723798)
6 Martinique     Fort-de-France     (-6799394 1644295)
7 Guyana         Georgetown        (-6473228 758755.9)
8 Salvador       Salvador da Bahia (-4288027 -1457447)
9 Rio de Janeiro Rio               (-4817908 -2617513)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">trade_centers_sf</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">countries_simp</span>, <span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/trade-center-africa-nunn08-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this demonstration, we calculate distance “as the bird flies” rather than “as the boat travels” using <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">sf::st_distance()</a></code>. <a href="#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup>21</sup></a>. <code>sf::st_distance(x, y)</code> returns the distance between each of the elements in <code>x</code> and <code>y</code> in a matrix form.</p>
<div class="no-row-height column-margin column-container"><div id="fn21"><p><sup>21</sup>&nbsp;This is not ideal, but calculating maritime routes has yet to be implemented in the <code>sf</code> framework. If you are interested in calculating maritime routes, you can follow <a href="https://www.r-bloggers.com/computing-maritime-routes-in-r/" class="uri">https://www.r-bloggers.com/computing-maritime-routes-in-r/</a>. This requires the <code>sp</code> package</p></div></div><div class="cell">
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trade_dist</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_distance</a></span><span class="op">(</span><span class="va">countries_simp</span><span class="op">$</span><span class="va">nearest_pt</span>, <span class="va">trade_centers_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">trade_dist</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
         [,1]     [,2]     [,3]     [,4]     [,5]     [,6]     [,7]    [,8]
[1,] 11524640 11416031 10179765 10629529  8907267  8846828  8274449 5824949
[2,] 13748687 13887733 12676043 13149129 11406957 11355782 10886895 8647735
[3,]  9581167  9745043  8548826  9031060  7289700  7244017  6860791 5164743
[4,]  9292324  9417143  8215166  8694951  6952594  6905440  6507429 4805015
[5,] 12274855 11991450 10748178 11171531  9490901  9423172  8757351 6013466
[6,] 10332371 10485152  9283995  9763730  8021308  7973939  7565252 5706017
        [,9]
[1,] 6484009
[2,] 9349100
[3,] 6192456
[4,] 5845456
[5,] 6435144
[6,] 6658041</code></pre>
</div>
</div>
<p>We can get the minimum distance as follows,</p>
<div class="cell">
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">min_trade_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">trade_dist</span>, <span class="fl">1</span>, <span class="va">min</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  5824949  8647735  5164743  4805015  6013466  5706017  4221530  5705994
 [9]  5811638  5671835  9131093  3696804  9435913  6967219  9273570  9254110
[17]  5063714  9432182  5602645  4726523  3760754  3930290  3833379  5631878
[25]  8922914  3810618  8119209  7962929  6404745  9748744  4377720  8406030
[33]  4503451 10754102  8407292  6009943  5246859  5574562  8689308  9188164
[41]  3940639  3718730  9859817  9263852  5252289  8052799  5705994  4938291
[49]  7715612  8640368  8835414  7876588  8170477  8168325</code></pre>
</div>
</div>
<p>Let’s assign these values to a new column named <code>distance_to_trade_center</code> in <code>countries_simp</code> while converting the unit to kilometer from meter.</p>
<div class="cell">
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">countries_simp</span><span class="op">$</span><span class="va">distance_to_trade_center</span> <span class="op">&lt;-</span> <span class="va">min_trade_dist</span> <span class="op">/</span> <span class="fl">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Figure below color-differentiate countries by their distance to the closest trade center.</p>
<div class="cell">
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">trade_centers_sf</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">countries_simp</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span>, fill <span class="op">=</span> <span class="va">distance_to_trade_center</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Distance to trade center"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/trade-center-dist-africa-nunn08-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr></section><section id="calculate-slaves-exported-from-each-country-in-africa" class="level4 page-columns page-full" data-number="1.6.2.2"><h4 data-number="1.6.2.2" class="anchored" data-anchor-id="calculate-slaves-exported-from-each-country-in-africa">
<span class="header-section-number">1.6.2.2</span> Calculate slaves exported from each country in Africa</h4>
<p><span class="citation" data-cites="nunn2008long">Nunn (<a href="#ref-nunn2008long" role="doc-biblioref">2008</a>)</span> used data on the number slaves exported from each ethnic region in <code>ethnic_regions</code>. Note that many ethnic regions intersects more than one countries as can be seen below, where the red and black lines represent country and ethnic region borders, respectively.</p>
<div class="cell">
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">countries_simp</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"red"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">ethnic_regions</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey60"</span>,</span>
<span>    fill <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/ethnic-region-africa-nunn08-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So, we need to assign a mapping from the amount of slaves exported from tribal regions to countries. We achieve this by means of “area weighted interpolation.” For example, if a country has 40% of a tribal region, then it will be assigned 40% of the slaves exported. The main assumption is that the distribution of slaves traded in a region is uniform.</p>
<p>Unfortunately, ethnic region data is not available on Prof.&nbsp;Nunn’s website. So, we generate fake data in this demonstration. Mean is increasing as we move west and normalized by area of region</p>
<div class="cell">
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3834</span><span class="op">)</span></span>
<span><span class="co">#--- calculate area ---#</span></span>
<span><span class="va">ethnic_regions</span><span class="op">$</span><span class="va">area</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">ethnic_regions</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- generate fake trade numbers ---#</span></span>
<span><span class="va">ethnic_regions</span><span class="op">$</span><span class="va">slaves_traded</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">ethnic_regions</span><span class="op">)</span>,</span>
<span>    mean <span class="op">=</span> <span class="va">ethnic_regions</span><span class="op">$</span><span class="va">area</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ethnic_regions</span><span class="op">$</span><span class="va">area</span><span class="op">)</span> <span class="op">*</span> <span class="fl">200</span> <span class="op">*</span> <span class="op">(</span><span class="fl">60</span> <span class="op">-</span> <span class="va">ethnic_regions</span><span class="op">$</span><span class="va">LON</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">ethnic_regions</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">slaves_traded</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"# of slaves traded"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/fake-trade-africa-nunn08-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s implement area-weighted interpolation on this fake dataset using <code><a href="https://r-spatial.github.io/sf/reference/interpolate_aw.html">sf::st_interpolate_aw()</a></code>. Since we would like to sum the number of exported slaves from each ethnic region, we use <code>extensive = TRUE</code> option.<a href="#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup>22</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn22"><p><sup>22</sup>&nbsp;<code>extensive= FALSE</code> does a weighted mean. More information is available <a href="https://edzer.github.io/UseR2017/#higher-level-operations-summarise-interpolate-aggregate-st_join">here</a></p></div></div><div class="cell">
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">countries_simp</span><span class="op">$</span><span class="va">slaves_traded</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/interpolate_aw.html">st_interpolate_aw</a></span><span class="op">(</span></span>
<span>    <span class="fu">st_make_valid</span><span class="op">(</span><span class="va">ethnic_regions</span><span class="op">[</span>, <span class="st">"slaves_traded"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="fu">st_make_valid</span><span class="op">(</span><span class="va">countries_simp</span><span class="op">)</span>,</span>
<span>    extensive <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">slaves_traded</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The left and right panel of the figure below shows the number of exported slaves by ethnic region and by country, respectively.</p>
<div class="cell">
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ethnic_regions_plot</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="va">ethnic_regions</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span>, fill <span class="op">=</span> <span class="va">slaves_traded</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"# of slaves traded"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">countries_plot</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="va">countries_simp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span>, fill <span class="op">=</span> <span class="va">slaves_traded</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"# of slaves traded"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ethnic_regions_plot</span> <span class="op">|</span> <span class="va">countries_plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/fake-trade-country-africa-nunn08-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section></section><section id="sec-demo-tri" class="level2" data-number="1.7"><h2 data-number="1.7" class="anchored" data-anchor-id="sec-demo-tri">
<span class="header-section-number">1.7</span> Terrain Ruggedness and Economic Development in Africa: Nunn 2012</h2>
<section id="project-overview-6" class="level3" data-number="1.7.1"><h3 data-number="1.7.1" class="anchored" data-anchor-id="project-overview-6">
<span class="header-section-number">1.7.1</span> Project Overview</h3>
<hr>
<p><strong>Objective:</strong></p>
<p><span class="citation" data-cites="nunn2012ruggedness">Nunn and Puga (<a href="#ref-nunn2012ruggedness" role="doc-biblioref">2012</a>)</span> showed empirically that the ruggedness of the terrain has had a positive impacts on economic developement in African countries. In this demonstration, we calculate Terrain Ruggedness Index (TRI) for African countries from the world elevation data.</p>
<hr>
<p><strong>Datasets</strong></p>
<ul>
<li>World elevation data</li>
<li>World country borders</li>
</ul>
<hr>
<p><strong>GIS tasks</strong></p>
<ul>
<li>read a raster file
<ul>
<li>use <code><a href="https://rspatial.github.io/terra/reference/rast.html">terra::rast()</a></code>
</li>
</ul>
</li>
<li>import world country border data
<ul>
<li>use <code><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html">rnaturalearth::ne_countries()</a></code>
</li>
</ul>
</li>
<li>crop a raster data to a particular region
<ul>
<li>use <code><a href="https://rspatial.github.io/terra/reference/crop.html">terra::crop()</a></code>
</li>
</ul>
</li>
<li>replace cell values
<ul>
<li>use <code><a href="https://rspatial.github.io/terra/reference/subst.html">terra::subst()</a></code>
</li>
</ul>
</li>
<li>calculate TRI
<ul>
<li>use <code><a href="https://rspatial.github.io/terra/reference/focal.html">terra::focal()</a></code>
</li>
</ul>
</li>
<li>create maps
<ul>
<li>use the <code>tmap</code> package</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Preparation for replication</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">tidyverse</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">stars</span>,</span>
<span>  <span class="va">tmap</span>,</span>
<span>  <span class="va">raster</span>,</span>
<span>  <span class="va">rnaturalearth</span>,</span>
<span>  <span class="va">skimr</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="project-demonstration-6" class="level3" data-number="1.7.2"><h3 data-number="1.7.2" class="anchored" data-anchor-id="project-demonstration-6">
<span class="header-section-number">1.7.2</span> Project Demonstration</h3>
<p>We first read the world elevation data using <code><a href="https://rspatial.github.io/terra/reference/rast.html">terra::rast()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="st">"Data/nunn_2012/GDEM-10km-BW.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 2160, 4320, 1  (nrow, ncol, nlyr)
resolution  : 0.08333333, 0.08333333  (x, y)
extent      : -180.0042, 179.9958, -89.99583, 90.00417  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source      : GDEM-10km-BW.tif 
name        : GDEM-10km-BW </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/map-world-elev-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this dataset, the elevation of the ocean floor is recorded as 0, so let’s replace an elevation of 0 with <code>NA</code>s. This avoids a problem associated with calculating TRI later.</p>
<div class="cell">
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/subst.html">subst</a></span><span class="op">(</span><span class="va">dem</span>, <span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/map-world-elev-no-zero-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, since our interest is in Africa, let’s just crop the raster data to its African portion. To do so, we first get the world map using <code><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html">rnaturalearth::ne_countries()</a></code> and filter out the non-African countries.</p>
<div class="cell">
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">africa_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="co">#--- get an sf of all the countries in the world ---#</span></span>
<span>  <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"medium"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- filter our non-African countries ---#</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">continent</span> <span class="op">==</span> <span class="st">"Africa"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now apply <code><a href="https://rspatial.github.io/terra/reference/crop.html">terra::crop()</a></code> to <code>dem</code> based on the bounding box of <code>africa_sf</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">africa_dem</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">africa_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is a map of the crop data.</p>
<div class="cell">
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">africa_dem</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/map-africa-elev-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, we are ready to calculte TRI, which is defined as</p>
<p><span class="math display">\[
  Ruggedness_{r,c} = \sqrt{\sum_{i=r-1}^{r+1} \sum_{j= r-1}^{r+1} (e_{i,j} - e_{r,c})^2}
\]</span></p>
<p>We are going to loop through the raster cells and calculate TRI. To do so, we make use of <code><a href="https://rspatial.github.io/terra/reference/focal.html">terra::focal()</a></code> It allows you to apply a function to every cell of a raster and bring a matrix of the surrounding values as an input to the function. For example <code>terra::focal(raster, w = 3, fun = any_function)</code> will pass to your <code>any_function</code> a 3 by 3 matrix of the raster values centered at the point.</p>
<p>Let’s define a function that calculates TRI for a given matrix.</p>
<div class="cell">
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">calc_tri</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">matr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># matr is a length 9 matrix</span></span>
<span>  <span class="va">center</span> <span class="op">&lt;-</span> <span class="va">matr</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span></span>
<span>  <span class="va">sum_squares</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">matr</span> <span class="op">-</span> <span class="va">center</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sum_squares</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s calculate TRI.</p>
<div class="cell">
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tri_africa</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/focal.html">focal</a></span><span class="op">(</span></span>
<span>    <span class="va">africa_dem</span>,</span>
<span>    w <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    fun <span class="op">=</span> <span class="va">calc_tri</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the map of the calculated TRI.</p>
<div class="cell">
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">tri_africa</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_raster</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/map-tri-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="sec-demo-tsetse" class="level2 page-columns page-full" data-number="1.8"><h2 data-number="1.8" class="anchored" data-anchor-id="sec-demo-tsetse">
<span class="header-section-number">1.8</span> TseTse fly suitability index: Alsan 2015</h2>
<section id="project-overview-7" class="level3" data-number="1.8.1"><h3 data-number="1.8.1" class="anchored" data-anchor-id="project-overview-7">
<span class="header-section-number">1.8.1</span> Project Overview</h3>
<hr>
<p><strong>Objective:</strong></p>
<p>Create TseTse fly suitability index used in <span class="citation" data-cites="alsan2015effect">Alsan (<a href="#ref-alsan2015effect" role="doc-biblioref">2015</a>)</span> (find the paper <a href="https://www.aeaweb.org/articles?id=10.1257/aer.20130604">here</a>) from temperature and humidity raster datasets.</p>
<hr>
<p><strong>Datasets</strong></p>
<ul>
<li>daily temperature and humidity datasets</li>
</ul>
<hr>
<p><strong>GIS tasks</strong></p>
<ul>
<li>read raster data files in the NetCDF format
<ul>
<li>use <code><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">stars::read_ncdf()</a></code>
</li>
</ul>
</li>
<li>aggregate raster data
<ul>
<li>use <code><a href="https://r-spatial.github.io/stars/reference/st_apply.html">stars::st_apply()</a></code>
</li>
</ul>
</li>
<li>read vector data in the geojson format
<ul>
<li>use <code>stars::st_read()</code>
</li>
</ul>
</li>
<li>shift (rotate) longitude of a raster dataset
<ul>
<li>use <code><a href="https://rspatial.github.io/terra/reference/rotate.html">terra::rotate()</a></code>
</li>
</ul>
</li>
<li>convert <code>stars</code> objects to <code>SpatRaster</code> objects, and vice versa
<ul>
<li>use <code>as(, "SpatRaster")</code>
</li>
<li>use <code><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">stars::st_as_stars()</a></code>
</li>
</ul>
</li>
<li>define variables inside a <code>stars</code> object
<ul>
<li>use <code>mutate()</code>
</li>
</ul>
</li>
<li>subset (crop) raster data to a region specified by a vector dataset
<ul>
<li>use <code>[]</code>
</li>
</ul>
</li>
<li>spatially aggregate raster data by regions specified by a vector dataset
<ul>
<li>use <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code>
</li>
<li>use <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>
</li>
</ul>
</li>
<li>create maps
<ul>
<li>use the <code>ggplot2</code> package</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Preparation for replication</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">tidyverse</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">stars</span>,</span>
<span>  <span class="va">exactextractr</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="project-demonstration-7" class="level3 page-columns page-full" data-number="1.8.2"><h3 data-number="1.8.2" class="anchored" data-anchor-id="project-demonstration-7">
<span class="header-section-number">1.8.2</span> Project Demonstration</h3>
<p>Marcella Alsan’s 2015 AER paper “The Effect of the TseTse Fly on African Development” tests a hypothesis about historical African economic development. The hypothesis considers the TseTse fly – a fly indigenous to Africa that is lethal to crops. The theory posits that the fly prevented agricultural surplus and hence stunted historical economic development in impacted regions of Africa. To test the hypothesis, <span class="citation" data-cites="alsan2015effect">Alsan (<a href="#ref-alsan2015effect" role="doc-biblioref">2015</a>)</span> whats to compare African tribes that were in regions highly affected by the TseTse fly to areas not highly affected. To do so, they use a “sutability index” that is based on an areas average temperature and humidity.</p>
<p>For this replication, we will recreate the suitability index and aggregate the data at the tribe level. For reference, the original figure from the article is reproduced in <a href="#fig-alsan-orig" class="quarto-xref">Figure&nbsp;<span>1.17</span></a>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-alsan-orig" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-alsan-orig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/alsan-fig.png" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-alsan-orig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.17: TseTse Suitability Index from Alsan (2015)
</figcaption></figure>
</div>
</div>
</div>
<section id="scientific-details" class="level4" data-number="1.8.2.1"><h4 data-number="1.8.2.1" class="anchored" data-anchor-id="scientific-details">
<span class="header-section-number">1.8.2.1</span> Scientific Details</h4>
<p>Understanding the details of the suitablity index is not necessary, but below I implement the following to derive the index. Feel free to skip this if you would like.</p>
<p>Let B represent the birth rate, which is temperature dependent, and M represent the mortality of adult flies from desication. The growth rate, <span class="math inline">\(\lambda\)</span> is defined as: <span class="math display">\[
    \lambda= \max(B - M, 0)
\]</span></p>
<p>The formula for the birth rate and the mortality rate are determined by scientific experiments and have the following form <span class="math display">\[
    B(t) = (-0.0058 * t^2 + .2847 t -2.467)
\]</span> <span class="math display">\[
    M(t, h) = -0.0003 * satdef^2 + 0.0236 * satdef + .235,
\]</span> where <span class="math inline">\(t\)</span> is temperature, <span class="math inline">\(h\)</span> is humidity and <span class="math inline">\(satdef\)</span> is defined as:</p>
<p><span class="math display">\[
    satdef = \frac{100-h}{100} \left( 6.1078 * exp(\frac{17.2694t}{t+237}) \right)
\]</span></p>
<p>A “second form of mortality that is not due to climate, but rather attributable to competition among flies, is introduce. This is known as density dependent mortality, <span class="math inline">\(\Delta\)</span>; and can be expressed as:” <span class="math display">\[
    \Delta = \phi (N)^\psi
\]</span></p>
<p>This yields a steady state equilibrium population of <span class="math display">\[
    N^* = (\frac{\lambda}{\phi})^{1/\psi}
\]</span> which is calibrated with = 0.025 = 1.25.</p>
<p>Lastly, the TseTse Suitability Index is the Z-score of <span class="math inline">\(N^*\)</span>.</p>
</section><section id="load-and-prepare-data" class="level4" data-number="1.8.2.2"><h4 data-number="1.8.2.2" class="anchored" data-anchor-id="load-and-prepare-data">
<span class="header-section-number">1.8.2.2</span> Load and Prepare Data</h4>
<p>To generate the data, we first download historical weather data in 1871 from <a href="https://psl.noaa.gov/data/gridded/data.20thC_ReanV2c.html">NOAA-CIRES 20th Century Reanalysis</a>. This data comes in a <code>NetCDF</code> file format (with extension <code>.nc</code>). We can use <code><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">stars::read_ncdf()</a></code> read a <code>NetCDF</code> file.</p>
<div class="cell">
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># NOAA-CIRES 20th Century Reanalysis version 2</span></span>
<span></span>
<span><span class="co">#--- temperature ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">temp_raw</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="st">"data/alsan_2015/air.sig995.1871.nc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
          Min. 1st Qu. Median     Mean 3rd Qu.   Max.
air [K] 235.13  260.45 278.93 277.0255  294.93 308.33
dimension(s):
     from  to         offset  delta  refsys x/y
lon     1 180             -1      2  WGS 84 [x]
lat     1  91             91     -2  WGS 84 [y]
time    1 365 1871-01-01 UTC 1 days POSIXct    </code></pre>
</div>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- humidity ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">humidity_raw</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="st">"data/alsan_2015/rhum.sig995.1871.nc"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
         Min. 1st Qu. Median     Mean 3rd Qu. Max.
rhum [%]   11      74     78 77.37066      84  100
dimension(s):
     from   to         offset   delta  refsys x/y
lon     1  180             -1       2  WGS 84 [x]
lat     1   91             91      -2  WGS 84 [y]
time    1 1460 1871-01-01 UTC 6 hours POSIXct    </code></pre>
</div>
</div>
<p>Since these raster files contain daily observations (see the <code>time</code> dimension above), Alsan aggregates them to the annual level. To average across a dimension (e.g.&nbsp;time), we will use the function <code><a href="https://r-spatial.github.io/stars/reference/st_apply.html">stars::st_apply</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Aggregate to annual average</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="va">temp_raw</span>, MARGIN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">mean</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Rename "mean" attribute which was created from st_apply</span></span>
<span>  <span class="co"># Convert Kelvin to Celsius</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>temp <span class="op">=</span> <span class="va">mean</span> <span class="op">-</span> <span class="fl">273.15</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">humidity</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html">st_apply</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="va">humidity_raw</span>, MARGIN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">mean</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Rename "mean" attribute which was created from st_apply</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>hum <span class="op">=</span> <span class="va">mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">hum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then combine the two to a single weather dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">weather</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">humidity</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 2 attributes
attribute(s):
           Min.   1st Qu.    Median      Mean  3rd Qu.     Max.
temp  -47.37911 -4.803978  8.705419  5.683404 22.29556 30.72751
hum    18.93425 73.694521 75.642466 74.541109 80.79110 96.53836
dimension(s):
    from  to offset delta refsys x/y
lon    1 180     -1     2 WGS 84 [x]
lat    1  91     91    -2 WGS 84 [y]</code></pre>
</div>
</div>
<p>The second piece of data needed is a shape file containing the Tribal boundaries. The original drawings come from Murdock (1959), but were digitized by Nathan Nunn and coauthors and is available <a href="https://scholar.harvard.edu/nunn/pages/data-0">here</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># African Tribes, originally from Murdock (1959)</span></span>
<span><span class="va">tribes</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/alsan_2015/Murdock_shapefile/borders_tribes.geojson"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- reproject to the CRS of temp_raw ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">temp_raw</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `borders_tribes' from data source 
  `/Users/tmieno2/Dropbox/TeachingUNL/R-as-GIS-for-Scientists/chapters/Data/alsan_2015/Murdock_shapefile/borders_tribes.geojson' 
  using driver `GeoJSON'
Simple feature collection with 812 features and 4 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -17.22583 ymin: -34.76862 xmax: 51.27722 ymax: 37.33028
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Africa</span></span>
<span><span class="va">africa</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"Data/alsan_2015/africa.geojson"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- reproject to the CRS of temp_raw ---#</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="va">temp_raw</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `africa' from data source 
  `/Users/tmieno2/Dropbox/TeachingUNL/R-as-GIS-for-Scientists/chapters/Data/alsan_2015/africa.geojson' 
  using driver `GeoJSON'
Simple feature collection with 1 feature and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -17.12917 ymin: -34.77313 xmax: 51.27278 ymax: 37.33521
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
<p>Here is the map of triabl boundaries superimposed on top of Africa.</p>
<div class="cell">
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tribes</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">africa</span>, color <span class="op">=</span> <span class="st">"#F26D21"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_map</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/g-trial-boundary-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is a common problem in working with raster data for countries that cross the Prime Meridian. To see the problem, let’s plot our weather data:</p>
<div class="cell">
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">weather</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lon</span>, y <span class="op">=</span> <span class="va">lat</span>, fill <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">africa</span>, color <span class="op">=</span> <span class="st">"#F26D21"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"seq"</span>, palette <span class="op">=</span> <span class="st">"Greys"</span>, direction <span class="op">=</span> <span class="fl">1</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_map</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/weather-before-rotation-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As you can see, the portion of Africa east of the Prime Meridian is wrapped to the other side of the map. That is because there are two ways to handle longitude: either from [0,360] or [-180,180]. Since our data is in [0,360] form, Africa will be cut in half. To convert, we can use the <code><a href="https://rspatial.github.io/terra/reference/rotate.html">terra::rotate()</a></code> function in the <code>terra</code> package. This means that you first need to convert <code>weather</code>, which is a <code>stars</code>, to a <code>SpatRaster</code> object, and then apply <code><a href="https://rspatial.github.io/terra/reference/rotate.html">terra::rotate()</a></code> to it.</p>
<div class="cell">
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">weather_raster</span> <span class="op">&lt;-</span></span>
<span>    <span class="co">#--- convert to SpatRaster ---#</span></span>
<span>    <span class="fu">as</span><span class="op">(</span><span class="va">weather</span>, <span class="st">"SpatRaster"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rotate.html">rotate</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 91, 180, 2  (nrow, ncol, nlyr)
resolution  : 2, 2  (x, y)
extent      : -181, 179, -91, 91  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 
source(s)   : memory
names       :      temp,      hum 
min values  : -47.37911, 18.93425 
max values  :  30.72751, 96.53836 </code></pre>
</div>
</div>
<p>Conversion back to a <code>stars</code> object with multiple layers needs some work. Specfically, we turn each layer into a <code>stars</code> object and then combine them using <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">st_as_stars</span><span class="op">(</span><span class="va">weather_raster</span><span class="op">$</span><span class="va">temp</span><span class="op">)</span>,</span>
<span>    <span class="fu">st_as_stars</span><span class="op">(</span><span class="va">weather_raster</span><span class="op">$</span><span class="va">hum</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Things are looking good now.</p>
<div class="cell">
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">weather</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">africa</span>, color <span class="op">=</span> <span class="st">"#F26D21"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="st">"seq"</span>, palette <span class="op">=</span> <span class="st">"Greys"</span>, direction <span class="op">=</span> <span class="fl">1</span>, na.value <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_map</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/rotated-weather-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="calculate-tsetse-suitability-index" class="level4 unnumbered page-columns page-full"><h4 class="unnumbered anchored" data-anchor-id="calculate-tsetse-suitability-index">Calculate TseTse Suitability Index</h4>
<p>Following the scientific formulae above, we add those variables to the <code>stars</code> object using <code>mutate()</code> function as if you are wrangling a <code>data.frame</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">weather</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    B <span class="op">=</span> <span class="op">-</span><span class="fl">0.0058</span> <span class="op">*</span> <span class="va">temp</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">.2847</span> <span class="op">*</span> <span class="va">temp</span> <span class="op">-</span> <span class="fl">2.467</span>,</span>
<span>    satdef <span class="op">=</span> <span class="op">(</span><span class="fl">6.1078</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">(</span><span class="fl">17.2694</span> <span class="op">*</span> <span class="va">temp</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">temp</span> <span class="op">+</span> <span class="fl">237</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">hum</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">6.1078</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">(</span><span class="fl">17.2694</span> <span class="op">*</span> <span class="va">temp</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">temp</span> <span class="op">+</span> <span class="fl">237</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    M <span class="op">=</span> <span class="op">-</span><span class="fl">0.0003</span> <span class="op">*</span> <span class="va">satdef</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">0.0236</span> <span class="op">*</span> <span class="va">satdef</span> <span class="op">+</span> <span class="fl">.235</span>,</span>
<span>    lambda <span class="op">=</span> <span class="va">B</span> <span class="op">-</span> <span class="va">M</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">lambda</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">lambda</span><span class="op">)</span>,</span>
<span>    Nstar <span class="op">=</span> <span class="op">(</span><span class="va">lambda</span> <span class="op">/</span> <span class="fl">0.025</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">1.25</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s subset <code>weather</code> to Africa and then calculate tsetse.</p>
<div class="cell">
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sf_use_s2</span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">weather_africa</span> <span class="op">&lt;-</span></span>
<span>  <span class="co">#--- subset to Africa ---#</span></span>
<span>  <span class="va">weather</span><span class="op">[</span><span class="va">tribes</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- calculate TseTse suitability index---#</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    tsetse <span class="op">=</span> <span class="op">(</span><span class="va">Nstar</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Nstar</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">Nstar</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the map of TseTse suitability index.</p>
<div class="cell">
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">weather_africa</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">tsetse</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="st">"seq"</span>, palette <span class="op">=</span> <span class="st">"Greys"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, na.value <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_map</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/tsetse-suitability-index-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now that we have our raster of the standardized TseTse suitability index, we want to aggregate this to the tribal level. This can be done using <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">agg_tsetse</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">weather_africa</span><span class="op">[</span><span class="st">"tsetse"</span><span class="op">]</span>,</span>
<span>    by <span class="op">=</span> <span class="va">tribes</span>,</span>
<span>    FUN <span class="op">=</span> <span class="va">mean</span>,</span>
<span>    na.rm <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    as_points <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, we are going to run into a problem due to the size of the tribes relative to the size of the raster cells.</p>
<div class="cell">
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">agg_tsetse</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/map-agg-tsetse-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notice all the holes in the map that we have!<a href="#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup>23</sup></a>. This problem can be fixed using the <code>exactextractr</code> package. Since it does not work with <code>stars</code> object, we need to convert <code>weather</code> to a <code>SpatRaster</code> objective from the <code>terra</code> package (you can alternatively convert to a <code>raster</code> object).</p>
<div class="no-row-height column-margin column-container"><div id="fn23"><p><sup>23</sup>&nbsp;This problem is documented well in <a href="https://twitter.com/kylefbutts/status/1270815765948579841?s=20">this thread</a></p></div></div><div class="cell">
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tribes</span><span class="op">$</span><span class="va">tsetse</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu">as</span><span class="op">(</span><span class="va">weather</span><span class="op">[</span><span class="st">"Nstar"</span><span class="op">]</span>, <span class="st">"SpatRaster"</span><span class="op">)</span>,</span>
<span>    <span class="co"># x = as(weather["Nstar"], "Raster"),</span></span>
<span>    y <span class="op">=</span> <span class="va">tribes</span>,</span>
<span>    fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># not display progress bar</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tribes</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">tsetse</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="st">"seq"</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"Greys"</span>,</span>
<span>    direction <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    na.value <span class="op">=</span> <span class="st">"red"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01-Demonstration_files/figure-html/map-tsese-final-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There we have it! We successfully dealt with a slew of issues but now have created the tsetse susceptability index at the tribal level!</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-alsan2015effect" class="csl-entry" role="listitem">
Alsan, Marcella. 2015. <span>“The Effect of the Tsetse Fly on African Development.”</span> <em>American Economic Review</em> 105 (1): 382–410.
</div>
<div id="ref-nunn2008long" class="csl-entry" role="listitem">
Nunn, Nathan. 2008. <span>“The Long-Term Effects of Africa’s Slave Trades.”</span> <em>The Quarterly Journal of Economics</em> 123 (1): 139–76.
</div>
<div id="ref-nunn2012ruggedness" class="csl-entry" role="listitem">
Nunn, Nathan, and Diego Puga. 2012. <span>“Ruggedness: The Blessing of Bad Geography in Africa.”</span> <em>Review of Economics and Statistics</em> 94 (1): 20–36.
</div>
</div>
</section></section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tmieno2\.github\.io\/R-as-GIS-for-Economists\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb158" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># R as GIS: Demonstrations {#sec-demo}</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ch01-setwd, eval = FALSE, echo = FALSE}</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="in">setwd(here::here("chapters"))</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include = FALSE, cache = FALSE}</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a><span class="in">#--- load packages ---#</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a><span class="in">library(data.table)</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a><span class="in">library(here)</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a><span class="in">library(stringr)</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a><span class="in">library(sf)</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a><span class="in">library(raster)</span></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a><span class="in">library(modelsummary)</span></span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a><span class="in">library(tmap)</span></span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a><span class="in">library(future.apply)</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a><span class="in">library(lubridate)</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a><span class="in">library(fixest)</span></span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a><span class="in">#--- set seed ---#</span></span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(2473498)</span></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Before you start {-}</span></span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a>The primary objective of this chapter is to showcase the power of R as GIS through demonstrations via mock-up econometric research projects (first five demonstrations) and creating variables used in published articles (the last three demonstrations)^<span class="co">[</span><span class="ot">Note that this lecture does not deal with spatial econometrics at all. This lecture is about spatial data processing, not spatial econometrics.</span><span class="co">]</span>. Each demonstration project consists of a project overview (objective, datasets used, econometric model, and GIS tasks involved) and demonstration. This is really **NOT** a place you learn the nuts and bolts of how R does spatial operations. Indeed, we intentionally do not explain all the details of how the R codes work. We reiterate that the main purpose of the demonstrations is to get you a better idea of how R can be used to process spatial data to help your research projects involving spatial datasets. Finally, note that the *mock-up* projects use extremely simple econometric models that completely lacks careful thoughts you would need in real research projects. So, don't waste your time judging the econometric models, and just focus on GIS tasks. If you are not familiar with html documents generated by <span class="in">`rmarkdown`</span>, you might benefit from reading the conventions of the book in the Preface. Finally, for those who are interested in replicating the demonstrations, directions for replication are provided below. However, I would suggest focusing on the narratives for the first time around, learn the nuts and bolts of spatial operations from Chapters 2 through 5, and then come back to replicate them.</span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a><span class="fu">### Target Audience {-}</span></span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a>The target audience of this chapter is those who are not very familiar with R as GIS. Knowledge of R certainly helps. But, I tried to write in a way that R beginners can still understand the power of R as GIS. Do not get bogged down by all the complex-looking R codes. Just focus on the narratives and figures to get a sense of what R can do.</span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-34"><a href="#cb158-34" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direction for replication {-}</span></span>
<span id="cb158-35"><a href="#cb158-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-36"><a href="#cb158-36" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb158-37"><a href="#cb158-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-38"><a href="#cb158-38" aria-hidden="true" tabindex="-1"></a>**Datasets**</span>
<span id="cb158-39"><a href="#cb158-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-40"><a href="#cb158-40" aria-hidden="true" tabindex="-1"></a>Running the codes in this chapter involves reading datasets from a disk. All the datasets that will be imported are available <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/rtbs4ji21c9uiy9/AADYpHAWhUxMittAptuq-Apaa?dl=0)</span>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</span>
<span id="cb158-41"><a href="#cb158-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-42"><a href="#cb158-42" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>set a folder (any folder) as the working directory using <span class="in">`setwd()`</span>  </span>
<span id="cb158-43"><a href="#cb158-43" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>create a folder called "Data" inside the folder designated as the working directory  </span>
<span id="cb158-44"><a href="#cb158-44" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>download the pertinent datasets from <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/rtbs4ji21c9uiy9/AADYpHAWhUxMittAptuq-Apaa?dl=0)</span></span>
<span id="cb158-45"><a href="#cb158-45" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>place all the files in the downloaded folder in the "Data" folder</span>
<span id="cb158-46"><a href="#cb158-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-47"><a href="#cb158-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-48"><a href="#cb158-48" aria-hidden="true" tabindex="-1"></a><span class="fu">## The impact of groundwater pumping on depth to water table {#sec-demo1}</span></span>
<span id="cb158-49"><a href="#cb158-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-50"><a href="#cb158-50" aria-hidden="true" tabindex="-1"></a>{{&lt; include 01-z01-groundwater-pumping.qmd &gt;}}</span>
<span id="cb158-51"><a href="#cb158-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-52"><a href="#cb158-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## Precision Agriculture {#sec-demo-PA}</span></span>
<span id="cb158-53"><a href="#cb158-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-54"><a href="#cb158-54" aria-hidden="true" tabindex="-1"></a>{{&lt; include 01-z02-precision-agriculture.qmd &gt;}}</span>
<span id="cb158-55"><a href="#cb158-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-56"><a href="#cb158-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## Land Use and Weather {#sec-demo3}</span></span>
<span id="cb158-57"><a href="#cb158-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-58"><a href="#cb158-58" aria-hidden="true" tabindex="-1"></a>{{&lt; include 01-z03-landuse-weather.qmd &gt;}}</span>
<span id="cb158-59"><a href="#cb158-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-60"><a href="#cb158-60" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Impact of Railroad Presence on Corn Planted Acreage {#sec-demo-railroad}</span></span>
<span id="cb158-61"><a href="#cb158-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-62"><a href="#cb158-62" aria-hidden="true" tabindex="-1"></a>{{&lt; include 01-z04-railroad-acres.qmd &gt;}}</span>
<span id="cb158-63"><a href="#cb158-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-64"><a href="#cb158-64" aria-hidden="true" tabindex="-1"></a><span class="fu">## Groundwater use for agricultural irrigation {#sec-demo-gw-ir}</span></span>
<span id="cb158-65"><a href="#cb158-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-66"><a href="#cb158-66" aria-hidden="true" tabindex="-1"></a>{{&lt; include 01-z05-groundwater-irrigation.qmd &gt;}}</span>
<span id="cb158-67"><a href="#cb158-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-68"><a href="#cb158-68" aria-hidden="true" tabindex="-1"></a><span class="fu">## African Economy and Slaves: Nunn 2008 {#sec-demo-slave}</span></span>
<span id="cb158-69"><a href="#cb158-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-70"><a href="#cb158-70" aria-hidden="true" tabindex="-1"></a>{{&lt; include 01-z06-nunn-2008.qmd &gt;}}</span>
<span id="cb158-71"><a href="#cb158-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-72"><a href="#cb158-72" aria-hidden="true" tabindex="-1"></a><span class="fu">## Terrain Ruggedness and Economic Development in Africa: Nunn 2012 {#sec-demo-tri}</span></span>
<span id="cb158-73"><a href="#cb158-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-74"><a href="#cb158-74" aria-hidden="true" tabindex="-1"></a>{{&lt; include 01-z07-nunn-2012.qmd &gt;}}</span>
<span id="cb158-75"><a href="#cb158-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-76"><a href="#cb158-76" aria-hidden="true" tabindex="-1"></a><span class="fu">## TseTse fly suitability index: Alsan 2015 {#sec-demo-tsetse}</span></span>
<span id="cb158-77"><a href="#cb158-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-78"><a href="#cb158-78" aria-hidden="true" tabindex="-1"></a>{{&lt; include 01-z08-alsan-2015.qmd &gt;}}</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/chapters/01-Demonstration.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>9&nbsp; Extraction Speed Considerations – R as GIS for Empiricists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Google tag (gtag.js) --><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="style.css">
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./06-SpeedThingsUp.html">(slightly) Advanced Topics</a></li><li class="breadcrumb-item"><a href="./06-SpeedThingsUp.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R as GIS for Empiricists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/R-as-GIS-for-Economists" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Demonstrations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-Demonstration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R as GIS: Demonstrations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-VectorDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector Data Handling with <code>sf</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-SpatialInteractionVectorVector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector Data: Subsetting and Joining</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-RasterDataBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Raster Data Handling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-SpatialInteractionVectorRaster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interactions of Vector and Raster Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Extensions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-stars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatiotemporal Raster Data Handling with <code>stars</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-CreateMaps-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Creating Maps using <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-DownloadSpatialData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Download and process spatial datasets from within R</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">(slightly) Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-SpeedThingsUp.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A1-ParallelComputing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Loop and Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A2-ggplot2-appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">ggplot2 minimals</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#before-you-start" id="toc-before-you-start" class="nav-link active" data-scroll-target="#before-you-start">Before you start</a>
  <ul class="collapse">
<li><a href="#direction-for-replication" id="toc-direction-for-replication" class="nav-link" data-scroll-target="#direction-for-replication">Direction for replication</a></li>
  </ul>
</li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">9.1</span> Data preparation</a></li>
  <li>
<a href="#sec-crop-first" id="toc-sec-crop-first" class="nav-link" data-scroll-target="#sec-crop-first"><span class="header-section-number">9.2</span> Should we crop first?</a>
  <ul class="collapse">
<li><a href="#extract-for-points" id="toc-extract-for-points" class="nav-link" data-scroll-target="#extract-for-points"><span class="header-section-number">9.2.1</span> Extract for points</a></li>
  <li><a href="#extract-for-polygons" id="toc-extract-for-polygons" class="nav-link" data-scroll-target="#extract-for-polygons"><span class="header-section-number">9.2.2</span> Extract for polygons</a></li>
  </ul>
</li>
  <li>
<a href="#sec-num-cells-geometries" id="toc-sec-num-cells-geometries" class="nav-link" data-scroll-target="#sec-num-cells-geometries"><span class="header-section-number">9.3</span> The number of raster cells and vector geometries</a>
  <ul class="collapse">
<li><a href="#base-line" id="toc-base-line" class="nav-link" data-scroll-target="#base-line"><span class="header-section-number">9.3.1</span> Base line</a></li>
  <li><a href="#large-number-of-polygons" id="toc-large-number-of-polygons" class="nav-link" data-scroll-target="#large-number-of-polygons"><span class="header-section-number">9.3.2</span> Large number of polygons</a></li>
  <li><a href="#large-number-of-raster-cells" id="toc-large-number-of-raster-cells" class="nav-link" data-scroll-target="#large-number-of-raster-cells"><span class="header-section-number">9.3.3</span> Large number of raster cells</a></li>
  </ul>
</li>
  <li>
<a href="#parallelization-on-a-single-raster-layer" id="toc-parallelization-on-a-single-raster-layer" class="nav-link" data-scroll-target="#parallelization-on-a-single-raster-layer"><span class="header-section-number">9.4</span> Parallelization on a single raster layer</a>
  <ul class="collapse">
<li><a href="#datasets" id="toc-datasets" class="nav-link" data-scroll-target="#datasets"><span class="header-section-number">9.4.1</span> Datasets</a></li>
  <li><a href="#parallelization" id="toc-parallelization" class="nav-link" data-scroll-target="#parallelization"><span class="header-section-number">9.4.2</span> Parallelization</a></li>
  </ul>
</li>
  <li>
<a href="#sec-many-multi-layer" id="toc-sec-many-multi-layer" class="nav-link" data-scroll-target="#sec-many-multi-layer"><span class="header-section-number">9.5</span> Many multi-layer raster files</a>
  <ul class="collapse">
<li><a href="#datasets-1" id="toc-datasets-1" class="nav-link" data-scroll-target="#datasets-1"><span class="header-section-number">9.5.1</span> Datasets</a></li>
  <li><a href="#sec-non-par-ext-multi" id="toc-sec-non-par-ext-multi" class="nav-link" data-scroll-target="#sec-non-par-ext-multi"><span class="header-section-number">9.5.2</span> Non-parallelized extraction</a></li>
  <li><a href="#approach-1-parallelize-over-polygons-and-do-regular-loop-over-year-month" id="toc-approach-1-parallelize-over-polygons-and-do-regular-loop-over-year-month" class="nav-link" data-scroll-target="#approach-1-parallelize-over-polygons-and-do-regular-loop-over-year-month"><span class="header-section-number">9.5.3</span> Approach 1: parallelize over polygons and do regular loop over year-month</a></li>
  <li><a href="#approach-2-parallelize-over-the-temporal-dimension-year-month" id="toc-approach-2-parallelize-over-the-temporal-dimension-year-month" class="nav-link" data-scroll-target="#approach-2-parallelize-over-the-temporal-dimension-year-month"><span class="header-section-number">9.5.4</span> Approach 2: parallelize over the temporal dimension (year-month)</a></li>
  <li><a href="#memory-consideration" id="toc-memory-consideration" class="nav-link" data-scroll-target="#memory-consideration"><span class="header-section-number">9.5.5</span> Memory consideration</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/06-SpeedThingsUp.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./06-SpeedThingsUp.html">(slightly) Advanced Topics</a></li><li class="breadcrumb-item"><a href="./06-SpeedThingsUp.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-EE" class="quarto-section-identifier"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extraction Speed Considerations</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="before-you-start" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="before-you-start">Before you start</h2>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Objectives">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Compare extraction speed of <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>, <code>stars::extract()</code>, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code>, and <code>aggregate.stars()</code> under different conditions:
<ul>
<li>Varying raster data size (number of cells)</li>
<li>Different numbers of points and polygons for which raster values are extracted</li>
<li>Whether the raster data is cropped to the area of interest first or not</li>
</ul>
</li>
<li>Learn how to parallelize the extraction process</li>
</ul>
</div>
</div>
<p>In this chapter, we will examine the speed of raster value extraction for vector data under various conditions and using different functions. Repeated raster value extraction is often necessary, such as when calculating county-level daily evapotranspiration for the past 30 years using PRISM data. In such cases, choosing the right strategy for minimizing extraction time can significantly impact performance.</p>
<p>To optimize extraction speed, we will explore parallelizing raster data extraction for polygon data. Parallelization for point data extraction will not be covered, as point extractions are typically very fast and unlikely to become a bottleneck in most workflows. We will start by discussing parallel extraction for single-layer raster data before progressing to multi-layer raster data.</p>
<p>There are several ways to parallelize the extraction process, and we will evaluate different approaches in terms of speed and memory usage. You’ll learn that the method of parallelization is crucial—naive parallelization can sometimes increase extraction time, while a more efficient approach can save hours or even days, depending on the scale of the task.</p>
<p>We will use the <code>future.apply</code> and <code>parallel</code> packages for parallelization. A basic understanding of these packages is assumed. If you are unfamiliar with looping via <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> or parallelization methods like <code>mclapply()</code> (for Mac and Linux users) or <code><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future.apply::future_lapply()</a></code> (for Windows and others), refer to <a href="A1-ParallelComputing.html" class="quarto-xref"><span>Appendix A</span></a> for an introduction.</p>
<section id="direction-for-replication" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="direction-for-replication">Direction for replication</h3>
<p><strong>Datasets</strong></p>
<p>All the datasets that you need to import are available <a href="https://www.dropbox.com/sh/gkprbgp8sg5362f/AABLLEUjsGkelCK2aUxaUI72a?dl=0">here</a>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</p>
<ul>
<li>set a folder (any folder) as the working directory using <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code><br>
</li>
<li>create a folder called “Data” inside the folder designated as the working directory (if you have created a “Data” folder previously, skip this step)</li>
<li>download the pertinent datasets from <a href="https://www.dropbox.com/sh/gkprbgp8sg5362f/AABLLEUjsGkelCK2aUxaUI72a?dl=0">here</a>
</li>
<li>place all the files in the downloaded folder in the “Data” folder</li>
</ul>
<p>Warning: the folder includes a series of daily PRISM datasets stored by month for 10 years. They amount to <span class="math inline">\(12.75\)</span> GB of data.</p>
<p><strong>Packages</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">parallel</span>, <span class="co"># for parallelization</span></span>
<span>  <span class="va">future.apply</span>, <span class="co"># for parallelization</span></span>
<span>  <span class="va">terra</span>, <span class="co"># handle raster data</span></span>
<span>  <span class="va">raster</span>, <span class="co"># handle raster data</span></span>
<span>  <span class="va">stars</span>, <span class="co"># handle raster data </span></span>
<span>  <span class="va">exactextractr</span>, <span class="co"># fast extractions</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">data.table</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">prism</span>, <span class="co"># download PRISM data</span></span>
<span>  <span class="va">ggplot2</span>, <span class="co"># mapping</span></span>
<span>  <span class="va">tictoc</span> <span class="co"># timing codes</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="data-preparation" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="data-preparation">
<span class="header-section-number">9.1</span> Data preparation</h2>
<p>We use the following datasets in the first part of this Chapter:</p>
<p><strong>Wells (points) in Kansas</strong></p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- read in the KS points data ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">KS_wells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/Chap_5_wells_KS.rds"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 37647 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -102.0495 ymin: 36.99552 xmax: -94.62089 ymax: 40.00199
Geodetic CRS:  NAD83
First 10 features:
   well_id                   geometry
1        1 POINT (-100.4423 37.52046)
2        3 POINT (-100.7118 39.91526)
3        5 POINT (-99.15168 38.48849)
4        7 POINT (-101.8995 38.78077)
5        8  POINT (-100.7122 38.0731)
6        9 POINT (-97.70265 39.04055)
7       11 POINT (-101.7114 39.55035)
8       12 POINT (-95.97031 39.16121)
9       15 POINT (-98.30759 38.26787)
10      17 POINT (-100.2785 37.71539)</code></pre>
</div>
</div>
<p><strong>Daily PRISM tmax (January, 2009) as <code>stars</code> and <code>SpatRaster</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_m8_y09_stars</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">"Data/PRISM_tmax_y2009_m1.tif"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- change the attribute name ---#</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="st">"tmax"</span><span class="op">)</span></span>
<span><span class="op">(</span></span>
<span><span class="va">tmax_m8_y09_sr</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="st">"SpatRaster"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 621, 1405, 31  (nrow, ncol, nlyr)
resolution  : 0.04166667, 0.04166667  (x, y)
extent      : -125.0208, -66.47917, 24.0625, 49.9375  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 (EPSG:4269) 
source(s)   : memory
names       : PRISM~1_bil, PRISM~2_bil, PRISM~3_bil, PRISM~4_bil, PRISM~5_bil, PRISM~6_bil, ... 
min values  :     -17.898,     -21.161,     -20.686,     -25.589,     -26.769,      -20.63, ... 
max values  :      28.271,      26.871,      29.709,      31.683,      31.397,       30.42, ... </code></pre>
</div>
</div>
<p><strong>Kansas county borders</strong></p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">KS_county_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Kansas"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- transform using the CRS of the PRISM stars data  ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- generate unique id ---#</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 105 features and 1 field
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -102.0517 ymin: 36.99302 xmax: -94.58841 ymax: 40.00316
Geodetic CRS:  NAD83
First 10 features:
                         geometry id
1  MULTIPOLYGON (((-101.0681 3...  1
2  MULTIPOLYGON (((-97.3707 39...  2
3  MULTIPOLYGON (((-101.1284 3...  3
4  MULTIPOLYGON (((-99.56988 3...  4
5  MULTIPOLYGON (((-99.62821 3...  5
6  MULTIPOLYGON (((-96.72774 3...  6
7  MULTIPOLYGON (((-101.103 37...  7
8  MULTIPOLYGON (((-99.04234 3...  8
9  MULTIPOLYGON (((-100.2477 3...  9
10 MULTIPOLYGON (((-101.5419 3... 10</code></pre>
</div>
</div>
<p><strong>Daily PRISM tmax (January, 2009) cropped to Kansas as <code>stars</code> and <code>SpatRaster</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">tmax_m8_y09_KS_stars</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s):
         Min. 1st Qu. Median     Mean 3rd Qu.   Max.
tmax  -13.477   1.154   7.66 6.615802  13.127 23.685
dimension(s):
     from  to offset    delta refsys point
x     552 731   -125  0.04167  NAD83 FALSE
y     239 311  49.94 -0.04167  NAD83 FALSE
band    1  31     NA       NA     NA    NA
                                                                            values
x                                                                             NULL
y                                                                             NULL
band PRISM_tmax_stable_4kmD2_20090101_bil,...,PRISM_tmax_stable_4kmD2_20090131_bil
     x/y
x    [x]
y    [y]
band    </code></pre>
</div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmax_m8_y09_KS_sr</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">tmax_m8_y09_KS_stars</span>, <span class="st">"SpatRaster"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sec-crop-first" class="level2 page-columns page-full" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="sec-crop-first">
<span class="header-section-number">9.2</span> Should we crop first?</h2>
<section id="extract-for-points" class="level3 page-columns page-full" data-number="9.2.1"><h3 data-number="9.2.1" class="anchored" data-anchor-id="extract-for-points">
<span class="header-section-number">9.2.1</span> Extract for points</h3>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<p>Here is the results of benchmarking:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="st">"terra-no-crop"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_sr</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  <span class="st">"terra-crop"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_sr</span>, <span class="va">KS_wells</span><span class="op">)</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  <span class="st">"stars-no-crop"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  <span class="st">"stars-crop"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span><span class="op">)</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
          expr       min        lq      mean    median        uq      max neval
 terra-no-crop 229.26191 241.87681 257.39702 250.24133 263.98649 407.0301   100
    terra-crop 228.96151 242.73248 258.61140 250.87914 263.29618 466.8389   100
 stars-no-crop  59.00630  63.25863  74.63379  67.79081  78.62381 210.9096   100
    stars-crop  50.53406  52.29614  58.00831  54.21836  56.78662 124.1551   100
 cld
 a  
 a  
  b 
   c</code></pre>
</div>
</div>
</div></div><section id="terraextract" class="level4" data-number="9.2.1.1"><h4 data-number="9.2.1.1" class="anchored" data-anchor-id="terraextract">
<span class="header-section-number">9.2.1.1</span> <strong><code>terra::extract()</code></strong>
</h4>
<p><strong>without cropping</strong></p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_sr</span>, <span class="va">KS_wells</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.255 sec elapsed</code></pre>
</div>
</div>
<p><strong>with cropping</strong></p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_sr</span>, <span class="va">KS_wells</span><span class="op">)</span>, <span class="va">KS_wells</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.298 sec elapsed</code></pre>
</div>
</div>
<p>As you can see, the difference in computation time is not large.</p>
</section><section id="starsextract" class="level4 page-columns page-full" data-number="9.2.1.2"><h4 data-number="9.2.1.2" class="anchored" data-anchor-id="starsextract">
<span class="header-section-number">9.2.1.2</span> <strong><code>stars::extract()</code></strong>
</h4>
<p><strong>without cropping</strong></p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">tmax_m8_y09_stars</span>, </span>
<span>    <span class="va">KS_wells</span>, </span>
<span>    FUN <span class="op">=</span> <span class="va">mean</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.072 sec elapsed</code></pre>
</div>
</div>
<p><strong>with cropping</strong><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Remember, if you crop to <code>KS_wells</code> instead of <code>sf::st_bbox(KS_wells)</code>, it would take a lot longer (see <a href="07-stars.html#sec-stars-crop" class="quarto-xref"><span>Section 6.10.1</span></a>).</p></div></div><div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span></span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span><span class="op">)</span>, <span class="va">KS_wells</span>,</span>
<span>    FUN <span class="op">=</span> <span class="va">mean</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.037 sec elapsed</code></pre>
</div>
</div>
<p>As you can see, the difference in computation time is not large either here.</p>
</section></section><section id="extract-for-polygons" class="level3" data-number="9.2.2"><h3 data-number="9.2.2" class="anchored" data-anchor-id="extract-for-polygons">
<span class="header-section-number">9.2.2</span> Extract for polygons</h3>
<p>When extracting for polygons, it typically pays off to first crop the raster data to the extent of the polygons data first before extraction.</p>
<p><strong>aggregate.stars()</strong></p>
<p>Here, the raster dataset is <code>tmax_m8_y09_stars</code> which covers the entire contiguous U.S. even though you are extracting values for Kansas (<code>KS_county_sf</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="va">KS_county_sf</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
  5.418 </code></pre>
</div>
</div>
<p>This one first crops the raster data to the extent of Kansas and then extract.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">tmax_m8_y09_KS_stars</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">KS_county_sf</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.14 sec elapsed</code></pre>
</div>
</div>
<p>You can see a noticeable improvement.</p>
<p><strong>exactextractr::exact_extract()</strong></p>
<p>Without cropping,</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="fu">as</span><span class="op">(</span><span class="va">tmax_m8_y09_stars</span>, <span class="st">"SpatRaster"</span><span class="op">)</span>, <span class="va">KS_county_sf</span>, <span class="st">"mean"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.198 sec elapsed</code></pre>
</div>
</div>
<p>With cropping,</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">tmax_m8_y09_KS_stars</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_crop</span><span class="op">(</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as</span><span class="op">(</span><span class="st">"SpatRaster"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">KS_county_sf</span>, <span class="st">"mean"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.119 sec elapsed</code></pre>
</div>
</div>
<p>So, it is still worthwhile to crop first, but the benefit of doing so is not as large as <code>aggregate.stars()</code> experienced. This is because <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract</a></code> does chunk-by-chunk operations where the unnecessary parts of the data are hardly relevant in the entire process.</p>
<p><strong>terra::extract()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_sr</span>, <span class="va">KS_county_sf</span>, fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.04 sec elapsed</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html">crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_sr</span>, <span class="va">KS_county_sf</span><span class="op">)</span>, <span class="va">KS_county_sf</span>, fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.047 sec elapsed</code></pre>
</div>
</div>
<p>Virtually no time difference between the two.</p>
<hr>
<p>Given, how fast <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> is, you might wonder if you should convert the <code>stars</code> object to a <code>SpatRaster</code> object, and then extract with <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> instead of <code>aggregate.stars()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- terra::extract() with internal conversion to "SpatRaster" ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="fu">as</span><span class="op">(</span><span class="va">tmax_m8_y09_sr</span>, <span class="st">"SpatRaster"</span><span class="op">)</span>, <span class="va">KS_county_sf</span>, fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.038 sec elapsed</code></pre>
</div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- aggregate.stars() with cropping ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tmax_m8_y09_KS_stars</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">KS_county_sf</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.136 sec elapsed</code></pre>
</div>
</div>
<p>Well, the winner is clear here. Even if you mainly use <code>stars</code> to handle raster data, you might want to consider using <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> if you need to repeat raster value extraction many many times given how simple it is to convert a <code>stars</code> object to a <code>SpatRaster</code> with <code>as(stars, "SpatRaster")</code>.</p>
</section></section><section id="sec-num-cells-geometries" class="level2 page-columns page-full" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="sec-num-cells-geometries">
<span class="header-section-number">9.3</span> The number of raster cells and vector geometries</h2>
<section id="base-line" class="level3" data-number="9.3.1"><h3 data-number="9.3.1" class="anchored" data-anchor-id="base-line">
<span class="header-section-number">9.3.1</span> Base line</h3>
<p>Let’s start with the example we used above in <a href="07-stars.html#sec-extraction-stars-polygons" class="quarto-xref"><span>Section 6.10.3</span></a> using <code>KS_county_sf</code> as the polygons data and <code>tmax_m8_y09_KS_stars</code> and <code>tmax_m8_y09_KS_sr</code> (they are already cropped to Kansas) as the raster data.</p>
<p><strong>terra::extract()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr</span>, <span class="va">KS_county_sf</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.048 sec elapsed</code></pre>
</div>
</div>
<p><strong>aggregate.stars()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_stars</span>, <span class="va">KS_county_sf</span><span class="op">)</span>, <span class="va">KS_county_sf</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.333 sec elapsed</code></pre>
</div>
</div>
<p><strong>exactextractr::exact_extract()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr</span>, <span class="va">KS_county_sf</span>, <span class="st">"mean"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.03 sec elapsed</code></pre>
</div>
</div>
<p>All of them are quite fast, but <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract</a></code> and <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> are clearly faster than <code>aggregate.stars()</code>.</p>
</section><section id="large-number-of-polygons" class="level3 page-columns page-full" data-number="9.3.2"><h3 data-number="9.3.2" class="anchored" data-anchor-id="large-number-of-polygons">
<span class="header-section-number">9.3.2</span> Large number of polygons</h3>
<p>Now, let’s increase the number of polygons without changing the spatial extent of the polygons data. This is done by creating lots of regular grids over Kansas.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">grids_in_KS</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid</a></span><span class="op">(</span><span class="va">KS_county_sf</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 40000 features and 0 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -102.0517 ymin: 36.99302 xmax: -94.58841 ymax: 40.00316
Geodetic CRS:  NAD83
First 10 features:
                                x
1  POLYGON ((-102.0517 36.9930...
2  POLYGON ((-102.0144 36.9930...
3  POLYGON ((-101.9771 36.9930...
4  POLYGON ((-101.9398 36.9930...
5  POLYGON ((-101.9025 36.9930...
6  POLYGON ((-101.8652 36.9930...
7  POLYGON ((-101.8278 36.9930...
8  POLYGON ((-101.7905 36.9930...
9  POLYGON ((-101.7532 36.9930...
10 POLYGON ((-101.7159 36.9930...</code></pre>
</div>
</div>
<p>In total, <code>grids_in_KS</code> has 40,000 polygons (<a href="#fig-grids-ks" class="quarto-xref">Figure&nbsp;<span>9.1</span></a> shows what the grids look like).</p>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tmax_m8_y09_KS_stars</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">grids_in_KS</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-grids-ks" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-grids-ks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-SpeedThingsUp_files/figure-html/fig-grids-ks-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-grids-ks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.1: 40,000 regular grids over tmax data for Kansas
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Now, let’s compare the three approaches.</p>
<p><strong>terra::extract()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr</span>, <span class="va">grids_in_KS</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3.615 sec elapsed</code></pre>
</div>
</div>
<p><strong>aggregate()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_stars</span>, <span class="va">grids_in_KS</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="va">st_as_sf</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4.032 sec elapsed</code></pre>
</div>
</div>
<p><strong>exact_extract()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr</span>, <span class="va">grids_in_KS</span>, <span class="st">"mean"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4.061 sec elapsed</code></pre>
</div>
</div>
<p>Interestingly, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> is affected by an increase in the number of polygons more than <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code>.</p>
</section><section id="large-number-of-raster-cells" class="level3" data-number="9.3.3"><h3 data-number="9.3.3" class="anchored" data-anchor-id="large-number-of-raster-cells">
<span class="header-section-number">9.3.3</span> Large number of raster cells</h3>
<p>Now, let’s make <code>tmax_m8_y09_KS_sr</code> much larger by disaggregating it by a factor of 10 (100 times more cells).</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">tmax_m8_y09_KS_sr_large</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/disaggregate.html">disagg</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr</span>, fact <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 730, 1800, 31  (nrow, ncol, nlyr)
resolution  : 0.004166667, 0.004166667  (x, y)
extent      : -102.0625, -94.5625, 36.97917, 40.02083  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 (EPSG:4269) 
source(s)   : memory
names       : PRISM~1_bil, PRISM~2_bil, PRISM~3_bil, PRISM~4_bil, PRISM~5_bil, PRISM~6_bil, ... 
min values  :      -2.409,       3.844,       7.267,      -1.286,      -6.891,      -2.286, ... 
max values  :      10.005,      16.707,      21.849,      23.120,       1.519,       9.483, ... </code></pre>
</div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- stars version ---#</span></span>
<span><span class="va">tmax_m8_y09_KS_stars_large</span> <span class="op">&lt;-</span> <span class="fu">st_as_stars</span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr_large</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>terra::extract()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr_large</span>, <span class="va">grids_in_KS</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
  5.967 </code></pre>
</div>
</div>
<p><strong>aggregate()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_stars_large</span>, <span class="va">grids_in_KS</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
157.947 </code></pre>
</div>
</div>
<p><strong>exact_extract()</strong></p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">extracted_values</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">tmax_m8_y09_KS_sr_large</span>, <span class="va">grids_in_KS</span>, <span class="st">"mean"</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
   4.18 </code></pre>
</div>
</div>
<p>Here, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> outperforms <code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code>, both of which outperform significantly <code>aggregate.stars()</code>. Indeed, <code>aggregate.stars()</code> is painfully slow.</p>
</section></section><section id="parallelization-on-a-single-raster-layer" class="level2 page-columns page-full" data-number="9.4"><h2 data-number="9.4" class="anchored" data-anchor-id="parallelization-on-a-single-raster-layer">
<span class="header-section-number">9.4</span> Parallelization on a single raster layer</h2>
<p>Let’s prepare for parallel processing for the rest of the section.</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- get the number of logical cores to use ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">num_cores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 18</code></pre>
</div>
</div>
<section id="datasets" class="level3 page-columns page-full" data-number="9.4.1"><h3 data-number="9.4.1" class="anchored" data-anchor-id="datasets">
<span class="header-section-number">9.4.1</span> Datasets</h3>
<p>We will use the following datasets:</p>
<ul>
<li>
<strong>raster</strong>: Iowa Cropland Data Layer (CDL) data in 2015<br>
</li>
<li>
<strong>polygons</strong>: Regular polygon grids over Iowa</li>
</ul>
<p><strong>Iowa CDL data in 2015</strong> (<a href="#fig-land" class="quarto-xref">Figure&nbsp;<span>9.2</span></a>)</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- Iowa CDL in 2015 ---#</span></span>
<span><span class="op">(</span></span>
<span><span class="va">IA_cdl_15</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="st">"Data/IA_cdl_2015.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 11671, 17795, 1  (nrow, ncol, nlyr)
resolution  : 30, 30  (x, y)
extent      : -52095, 481755, 1938165, 2288295  (xmin, xmax, ymin, ymax)
coord. ref. : +proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs 
source      : IA_cdl_2015.tif 
color table : 1 
name        : Layer_1 
min value   :       0 
max value   :     229 </code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">IA_cdl_15</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-land" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-land-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-SpeedThingsUp_files/figure-html/fig-land-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-land-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.2: Land use type in Iowa in 2105
</figcaption></figure>
</div>
</div>
</div>
</div></div><p>Values recorded in the raster data are integers representing land use type.</p>
<p><strong>Regularly-sized grids over Iowa</strong> (<a href="#fig-IA-grids" class="quarto-xref">Figure&nbsp;<span>9.3</span></a>)</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- regular grids over Iowa ---#</span></span>
<span><span class="va">IA_grids</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"IA"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- create regularly-sized grids ---#</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">x</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- project to the CRS of the CDL data ---#</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="va">IA_cdl_15</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">IA_grids</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-IA-grids" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-IA-grids-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-SpeedThingsUp_files/figure-html/fig-IA-grids-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-IA-grids-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.3: Regular grids over Iowas as sf
</figcaption></figure>
</div>
</div>
</div>
</div></div></section><section id="parallelization" class="level3" data-number="9.4.2"><h3 data-number="9.4.2" class="anchored" data-anchor-id="parallelization">
<span class="header-section-number">9.4.2</span> Parallelization</h3>
<p>Here is how long it takes to extract raster data values for the polygon grids using <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exactextractr::exact_extract()</a></code> (<code><a href="https://rspatial.github.io/terra/reference/extract.html">terra::extract()</a></code> takes too much time and is not practical for this set of datasets).</p>
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_15</span>, <span class="va">IA_grids</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
 17.692 </code></pre>
</div>
</div>
<hr>
<p>One way to parallelize this process is to let each core work on one polygon at a time. Let’s first define the function to extract values for one polygon and then run it for all the polygons parallelized.</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- function to extract raster values for a single polygon ---#</span></span>
<span><span class="va">get_values_i</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_15</span>, <span class="va">IA_grids</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#--- parallelized ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">IA_grids</span><span class="op">)</span>, <span class="va">get_values_i</span>, mc.cores <span class="op">=</span> <span class="va">num_cores</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
 51.192 </code></pre>
</div>
</div>
<p>As you can see, this is not a good way to parallelize the computation process. To see why, let’s look at the computation time of extracting from one polygon, two polygons, and up to five polygons.</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>    <span class="st">"p_1"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_15</span>, <span class="va">IA_grids</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="st">"p_2"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_15</span>, <span class="va">IA_grids</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="st">"p_3"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_15</span>, <span class="va">IA_grids</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="st">"p_4"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_15</span>, <span class="va">IA_grids</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="st">"p_5"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_15</span>, <span class="va">IA_grids</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-comp-polygons" class="quarto-xref">Figure&nbsp;<span>9.4</span></a> shows the results of the benchmarking.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mb</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">data.table</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">expr</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"p_"</span>, <span class="st">""</span>, <span class="va">expr</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_boxplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">time</span> <span class="op">/</span> <span class="fl">1e9</span>, x <span class="op">=</span> <span class="va">expr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylim</span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"seconds"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"number of polygons to process"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-comp-polygons" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-comp-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-SpeedThingsUp_files/figure-html/fig-comp-polygons-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-comp-polygons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.4: Comparison of the computation time of raster data extractions
</figcaption></figure>
</div>
</div>
</div>
<p>As you can see, there is a significant overhead (about 0.02 seconds) regardless of the number of polygons being processed for data extraction. Once the process is initiated and ready to begin extracting values for the polygons, the additional time required to process extra units is minimal. This serves as a prime example of how not to parallelize a task. Since each core processes approximately 555 polygons, simple math suggests that you would spend at least 11.1 seconds (calculated as 0.02 <span class="math inline">\(\times\)</span> 555) just in preparing the extraction jobs.</p>
<hr>
<p>We can minimize this overhead as much as possible by having each core use <code>exactextract::exact_extract()</code> only once in which multiple polygons are processed in the single call. Specifically, we will split the collection of the polygons into 18 groups and have each core extract for one group.</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- number of polygons in a group ---#</span></span>
<span><span class="va">num_in_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">IA_grids</span><span class="op">)</span> <span class="op">/</span> <span class="va">num_cores</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- assign group id to polygons ---#</span></span>
<span><span class="va">IA_grids</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">IA_grids</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">#--- create grid id ---#</span></span>
<span>    grid_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>    <span class="co">#--- assign group id  ---#</span></span>
<span>    group_id <span class="op">=</span> <span class="va">grid_id</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="va">num_in_group</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#--- parallelized processing by group ---#</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">num_cores</span>,</span>
<span>    \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_15</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">IA_grids</span>, <span class="va">group_id</span> <span class="op">==</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    mc.cores <span class="op">=</span> <span class="va">num_cores</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
  5.249 </code></pre>
</div>
</div>
<p>Okay, this is much better.</p>
<hr>
<p>Now, we can further reduce the processing time by reducing the size of the object that is returned from each core to be collated into one. In the code above, each core returns a list of <code>data.frame</code>s where each grid of the same group has multiple values from the intersecting raster cells.</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- the size of the list of data returned by the first core ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">temp</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span>units <span class="op">=</span> <span class="st">"GB"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0 Gb"</code></pre>
</div>
</div>
<p>In total, about 2.3GB of data has to be collated into one list from 18 cores. It turns out, this process is costly. To see this, take a look at the following example where the same <code>exactextractr::exact_extrct()</code> processes are run, yet nothing is returned by each core.</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- define the function to extract values by block of polygons ---#</span></span>
<span><span class="va">extract_by_group</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">IA_cdl_15</span>, <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">IA_grids</span>, <span class="va">group_id</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--- returns nothing! ---#</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#--- parallelized processing by group ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="va">num_cores</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu">extract_by_group</span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>  mc.cores <span class="op">=</span> <span class="va">num_cores</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
   2.07 </code></pre>
</div>
</div>
<p>Approximately 3.179 seconds were used just to collect the 2.3GB worth of data from the cores into one.</p>
<p>In most cases, we do not have to carry around all the individual cell values of land use types for our subsequent analysis. For example, in Demonstration 3 (<a href="01-Demonstration.html#sec-demo3" class="quarto-xref"><span>Section 1.3</span></a>) we just need a summary (count) of each unique land use type by polygon. So, let’s get the summary before we have the computer collect the objects returned from each core as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extract_by_group_reduced</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp_return</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>      <span class="va">IA_cdl_15</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">IA_grids</span>, <span class="va">group_id</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- combine the list of data.frames into one with polygon id ---#</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"id_within_group"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- find the count of land use type values by polygon ---#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>num_value <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">value</span>, <span class="va">id_within_group</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">temp_return</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#--- parallelized processing by group ---#</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="va">num_cores</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu">extract_by_group_reduced</span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>  mc.cores <span class="op">=</span> <span class="va">num_cores</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
  2.994 </code></pre>
</div>
</div>
<p>It is of course slower than the one that returns nothing, but it is faster than the one that does not reduce the size before the outcome collation.</p>
<hr>
<p>As you can see, the computation time of the fastest approach is now significantly reduced, but you only saved 48.2 seconds. How much time did I spend writing the code to implement the parallelized group processing? About three minutes. What truly matters is the total time you spend (coding time plus processing time) to get the desired outcome. The maximum time you could save with clever coding is 51.19 seconds. If writing code to make it faster takes more time than that, it’s simply not worth the effort. So, don’t try to optimize your code if the processing time is already short. Before you dive into parallelization, think through the coding steps in your head and assess whether it’s really worth the time investment.</p>
<p>However, imagine processing CDL data for all U.S. states from 2009 to 2020. The entire process would take approximately 8.7 hours (calculated as <span class="math inline">\(51 \times 12 \times 51.192/60/60\)</span>). A rough estimate suggests that with parallelization, using the best approach we discussed, the process could be completed in about 0.51 hours. While 8.7 hours is still manageable (you could start the process before bed and have the results ready by the next afternoon), it becomes worthwhile to parallelize the process, especially considering the time savings from parallelization, even after accounting for the time spent coding it.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Summary">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Summary
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Do not let each core runs small tasks over and over again (e.g., extracting raster values for one polygon at a time), or you will suffer from significant overhead.</li>
<li>Blocking is one way to avoid the problem above.</li>
<li>Reduce the size of the outcome of each core as much as possible to spend less time to simply collating them into one.</li>
<li>Do not forget about the time you would spend on coding parallelized processes.</li>
<li>If you are extracting from a single layer, it is likely that you should not parallelize.</li>
</ul>
</div>
</div>
</section></section><section id="sec-many-multi-layer" class="level2 page-columns page-full" data-number="9.5"><h2 data-number="9.5" class="anchored" data-anchor-id="sec-many-multi-layer">
<span class="header-section-number">9.5</span> Many multi-layer raster files</h2>
<p>In this section, we discuss various methods to parallelize the process of extracting values from many multi-layer raster files.</p>
<section id="datasets-1" class="level3 page-columns page-full" data-number="9.5.1"><h3 data-number="9.5.1" class="anchored" data-anchor-id="datasets-1">
<span class="header-section-number">9.5.1</span> Datasets</h3>
<p>We will use the following datasets:</p>
<ul>
<li>
<strong>raster</strong>: daily PRISM data 2010 through 2019 stacked by month</li>
<li>
<strong>polygons</strong>: US County polygons</li>
</ul>
<p><strong>daily PRISM precipitation 2010 through 2019</strong></p>
<p>You can download all the prism files from <a href="https://www.dropbox.com/sh/gkprbgp8sg5362f/AABLLEUjsGkelCK2aUxaUI72a?dl=0">here</a>. For those who are interested in learning how to generate the series of daily PRISM data files stored by month, see <a href="09-DownloadSpatialData.html#sec-download-prism" class="quarto-xref"><span>Section 8.3</span></a> for the code.</p>
<p>Let’s retrieve the U.S. counties data (see <a href="#fig-us-counties" class="quarto-xref">Figure&nbsp;<span>9.5</span></a> for the map).</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">US_county</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>cb <span class="op">=</span> <span class="cn">TRUE</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- only keep geometry ---#</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- project to the CRS of the CDL data ---#</span></span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html">crs</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="st">"Data/PRISM_ppt_y2009_m1.tif"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3235 features and 0 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -179.1467 ymin: -14.5487 xmax: 179.7785 ymax: 71.38782
Geodetic CRS:  NAD83
First 10 features:
                         geometry
1  MULTIPOLYGON (((-85.71209 3...
2  MULTIPOLYGON (((-88.47323 3...
3  MULTIPOLYGON (((-85.74803 3...
4  MULTIPOLYGON (((-88.34043 3...
5  MULTIPOLYGON (((-88.13925 3...
6  MULTIPOLYGON (((-114.7312 3...
7  MULTIPOLYGON (((-110.0007 3...
8  MULTIPOLYGON (((-94.48558 3...
9  MULTIPOLYGON (((-91.40687 3...
10 MULTIPOLYGON (((-118.6044 3...</code></pre>
</div>
</div>

<!--end of column-margin-->
<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">US_county</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-us-counties" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-us-counties-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06-SpeedThingsUp_files/figure-html/fig-us-counties-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-us-counties-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.5: U.S. counties
</figcaption></figure>
</div>
</div>
</div>
</div></div></section><section id="sec-non-par-ext-multi" class="level3" data-number="9.5.2"><h3 data-number="9.5.2" class="anchored" data-anchor-id="sec-non-par-ext-multi">
<span class="header-section-number">9.5.2</span> Non-parallelized extraction</h3>
<p>As we learned in <a href="05-SpatialInteractionVectorRaster.html#sec-extract-speed" class="quarto-xref"><span>Section 5.3</span></a>, extracting values from stacked raster layers (multi-layer <code>SpatRaster</code>) is faster than extracting from multiple single-layer raster datasets one at a time. In this case, daily precipitation datasets are stacked by year and month and saved as multi-layer GeoTIFF files. For example, <strong>PRISM_ppt_y2009_m1.tif</strong> contains the daily precipitation data for January 2009. Below is an example of how long it takes to extract values for U.S. counties from a month of daily PRISM precipitation data.</p>
<div class="cell">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="st">"Data/PRISM_ppt_y2009_m1.tif"</span><span class="op">)</span>,</span>
<span>    <span class="va">US_county</span>,</span>
<span>    <span class="st">"mean"</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">F</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
  5.556 </code></pre>
</div>
</div>
<p>Now, to process all the precipitation data from 2009-2018, we consider two approaches in this section are:</p>
<ol type="1">
<li>parallelize over polygons (blocked) and do regular loop over year-month</li>
<li>parallelize over year-month</li>
</ol></section><section id="approach-1-parallelize-over-polygons-and-do-regular-loop-over-year-month" class="level3" data-number="9.5.3"><h3 data-number="9.5.3" class="anchored" data-anchor-id="approach-1-parallelize-over-polygons-and-do-regular-loop-over-year-month">
<span class="header-section-number">9.5.3</span> Approach 1: parallelize over polygons and do regular loop over year-month</h3>
<p>For this approach, let’s measure the time spent on processing one year-month PRISM dataset and then guess how long it would take to process 120 year-month PRISM datasets.</p>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--- number of polygons in a group ---#</span></span>
<span><span class="va">num_in_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">US_county</span><span class="op">)</span> <span class="op">/</span> <span class="va">num_cores</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- define group id ---#</span></span>
<span><span class="va">US_county</span> <span class="op">&lt;-</span> <span class="va">US_county</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="co">#--- create grid id ---#</span></span>
<span>    poly_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>    <span class="co">#--- assign group id  ---#</span></span>
<span>    group_id <span class="op">=</span> <span class="va">poly_id</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="va">num_in_group</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">extract_by_group</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp_return</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="st">"Data/PRISM_ppt_y2009_m1.tif"</span><span class="op">)</span>,</span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">US_county</span>, <span class="va">group_id</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- combine the list of data.frames into one with polygon id ---#</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"id_within_group"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- find the count of land use type values by polygon ---#</span></span>
<span>    <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span>id.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id_within_group"</span>, <span class="st">"coverage_fraction"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">id_within_group</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">temp_return</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">num_cores</span>, <span class="va">extract_by_group</span>, mc.cores <span class="op">=</span> <span class="va">num_cores</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
  0.757 </code></pre>
</div>
</div>
<p>Okay, this approach is not bad at all. If we are to process 10 years of daily PRISM data, then it would take roughly 1.51 minutes.</p>
</section><section id="approach-2-parallelize-over-the-temporal-dimension-year-month" class="level3" data-number="9.5.4"><h3 data-number="9.5.4" class="anchored" data-anchor-id="approach-2-parallelize-over-the-temporal-dimension-year-month">
<span class="header-section-number">9.5.4</span> Approach 2: parallelize over the temporal dimension (year-month)</h3>
<p>Instead of parallelize over polygons, let’s parallelize over time (year-month). To do so, we first create a <code>data.frame</code> that has all the year-month combinations we will work on.</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">month_year_data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/J.html">CJ</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, year <span class="op">=</span> <span class="fl">2009</span><span class="op">:</span><span class="fl">2018</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following function extract data from a single year-month case:</p>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_prism_by_month</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">vector</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp_month</span> <span class="op">&lt;-</span> <span class="va">month_year_data</span><span class="op">[</span><span class="va">i</span>, <span class="va">month</span><span class="op">]</span> <span class="co"># month to work on</span></span>
<span>  <span class="va">temp_year</span> <span class="op">&lt;-</span> <span class="va">month_year_data</span><span class="op">[</span><span class="va">i</span>, <span class="va">year</span><span class="op">]</span> <span class="co"># year to work on</span></span>
<span></span>
<span>  <span class="co">#--- import raster data ---#</span></span>
<span>  <span class="va">temp_raster</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/PRISM_ppt_y"</span>, <span class="va">temp_year</span>, <span class="st">"_m"</span>, <span class="va">temp_month</span>, <span class="st">".tif"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">temp_raster</span>, <span class="va">vector</span>, <span class="st">"mean"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then loop over the rows of <code>month_year_data</code> in parallel.</p>
<div class="cell">
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span></span>
<span>   <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span></span>
<span>     <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">month_year_data</span><span class="op">)</span>,</span>
<span>     \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_prism_by_month</span><span class="op">(</span><span class="va">x</span>, <span class="va">US_county</span><span class="op">)</span>,</span>
<span>     mc.cores <span class="op">=</span> <span class="va">num_cores</span></span>
<span>   <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>elapsed 
 13.736 </code></pre>
</div>
</div>
<p>It took 0.23 minutes. So, Approach 2 is the clear winner.</p>
</section><section id="memory-consideration" class="level3" data-number="9.5.5"><h3 data-number="9.5.5" class="anchored" data-anchor-id="memory-consideration">
<span class="header-section-number">9.5.5</span> Memory consideration</h3>
<p>So far, we have not addressed the memory footprint of the parallelized processes, but it becomes crucial when working with many large datasets. Approaches 1 and 2 differ significantly in their memory usage.</p>
<ul>
<li>
<strong>Approach 1</strong>: divides the polygons into groups and parallelizes over these groups when extracting raster values.</li>
<li>
<strong>Approach 2</strong>: extracts and holds raster values for r num_cores of the entire U.S. polygons at once.</li>
</ul>
<p>Clearly, Approach 1 has a smaller memory footprint. Approach 2, on the other hand, used about 40 GB of memory, nearly maxing out my computer’s 64 GB of RAM (with other processes also consuming memory). As long as you stay within the memory limits, Approach 2 is more efficient. However, if I had only 32 GB of RAM, Approach 2 would have experienced a significant performance drop, while Approach 1 would not. Similarly, if the raster data had twice as many cells within the same spatial extent, Approach 2 would suffer, whereas Approach 1 would not.</p>
<p>It’s easy to imagine situations where Approach 1 is preferable. For example, if you have multiple 10-GB raster layers and only 16 GB of RAM, Approach 2 would clearly be impractical, making Approach 1 the better, and perhaps only, choice—far better than not parallelizing at all.</p>
<p>In summary, while processing larger datasets with each core can improve performance, you must be cautious not to exceed your computer’s RAM limits.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Summary">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Summary
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Parallelize over time rathe than space as long as your RAM memory allows it</li>
<li>Parallelizing over space is still better than not parallelizing at all</li>
</ul>
</div>
</div>
<!-- ```{r by_year, eval = F}
save_tif <- function(y) {
  temp_ml <- terra::rast(stack(paste0("Data/PRISM/PRISM_ppt_y", y, "_m", 1:12, ".tif")))
  writeRaster(temp_ml, paste0("Data/PRISM/PRISM_ppt_y", y, ".tif"), overwrite = T)
}

mclapply(2009:2018, save_tif, mc.cores = 10)

temp_ml <- stack(paste0("Data/PRISM/PRISM_ppt_y2009.tif"))

tic()
temp <- exactextractr::exact_extract(temp_ml, US_county)
toc()
```-->


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tmieno2\.github\.io\/R-as-GIS-for-Economists\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb93" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Extraction Speed Considerations {#sec-EE}</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Chap6_setup, echo = FALSE, results = "hide"}</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="in">library(knitr)</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="in">  echo = TRUE,</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="in">  cache = TRUE,</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="in">  comment = NA,</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="in">  message = FALSE,</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="in">  warning = FALSE,</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="in">  tidy = FALSE,</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="in">  cache.lazy = FALSE</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a><span class="co">#--- load packages ---#</span></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(exactextractr)</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prism)</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply)</span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## Before you start {-}</span></span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a>:::{.callout-note title="Objectives"}</span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Compare extraction speed of <span class="in">`terra::extract()`</span>, <span class="in">`stars::extract()`</span>, <span class="in">`exactextractr::exact_extract()`</span>, and <span class="in">`aggregate.stars()`</span> under different conditions:</span>
<span id="cb93-41"><a href="#cb93-41" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>Varying raster data size (number of cells)</span>
<span id="cb93-42"><a href="#cb93-42" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>Different numbers of points and polygons for which raster values are extracted</span>
<span id="cb93-43"><a href="#cb93-43" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>Whether the raster data is cropped to the area of interest first or not </span>
<span id="cb93-44"><a href="#cb93-44" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Learn how to parallelize the extraction process</span>
<span id="cb93-45"><a href="#cb93-45" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb93-46"><a href="#cb93-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-47"><a href="#cb93-47" aria-hidden="true" tabindex="-1"></a>In this chapter, we will examine the speed of raster value extraction for vector data under various conditions and using different functions. Repeated raster value extraction is often necessary, such as when calculating county-level daily evapotranspiration for the past 30 years using PRISM data. In such cases, choosing the right strategy for minimizing extraction time can significantly impact performance.</span>
<span id="cb93-48"><a href="#cb93-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-49"><a href="#cb93-49" aria-hidden="true" tabindex="-1"></a>To optimize extraction speed, we will explore parallelizing raster data extraction for polygon data. Parallelization for point data extraction will not be covered, as point extractions are typically very fast and unlikely to become a bottleneck in most workflows. We will start by discussing parallel extraction for single-layer raster data before progressing to multi-layer raster data.</span>
<span id="cb93-50"><a href="#cb93-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-51"><a href="#cb93-51" aria-hidden="true" tabindex="-1"></a>There are several ways to parallelize the extraction process, and we will evaluate different approaches in terms of speed and memory usage. You'll learn that the method of parallelization is crucial—naive parallelization can sometimes increase extraction time, while a more efficient approach can save hours or even days, depending on the scale of the task.</span>
<span id="cb93-52"><a href="#cb93-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-53"><a href="#cb93-53" aria-hidden="true" tabindex="-1"></a>We will use the <span class="in">`future.apply`</span> and <span class="in">`parallel`</span> packages for parallelization. A basic understanding of these packages is assumed. If you are unfamiliar with looping via <span class="in">`lapply()`</span> or parallelization methods like <span class="in">`mclapply()`</span> (for Mac and Linux users) or <span class="in">`future.apply::future_lapply()`</span> (for Windows and others), refer to @sec-par-comp for an introduction.</span>
<span id="cb93-54"><a href="#cb93-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-55"><a href="#cb93-55" aria-hidden="true" tabindex="-1"></a><span class="fu">### Direction for replication {-}</span></span>
<span id="cb93-56"><a href="#cb93-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-57"><a href="#cb93-57" aria-hidden="true" tabindex="-1"></a>**Datasets**</span>
<span id="cb93-58"><a href="#cb93-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-59"><a href="#cb93-59" aria-hidden="true" tabindex="-1"></a>All the datasets that you need to import are available <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/gkprbgp8sg5362f/AABLLEUjsGkelCK2aUxaUI72a?dl=0)</span>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</span>
<span id="cb93-60"><a href="#cb93-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-61"><a href="#cb93-61" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>set a folder (any folder) as the working directory using <span class="in">`setwd()`</span>  </span>
<span id="cb93-62"><a href="#cb93-62" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>create a folder called "Data" inside the folder designated as the working directory (if you have created a "Data" folder previously, skip this step)</span>
<span id="cb93-63"><a href="#cb93-63" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>download the pertinent datasets from <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/gkprbgp8sg5362f/AABLLEUjsGkelCK2aUxaUI72a?dl=0)</span> </span>
<span id="cb93-64"><a href="#cb93-64" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>place all the files in the downloaded folder in the "Data" folder</span>
<span id="cb93-65"><a href="#cb93-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-66"><a href="#cb93-66" aria-hidden="true" tabindex="-1"></a>Warning: the folder includes a series of daily PRISM datasets stored by month for 10 years. They amount to $12.75$ GB of data.</span>
<span id="cb93-67"><a href="#cb93-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-68"><a href="#cb93-68" aria-hidden="true" tabindex="-1"></a>**Packages**</span>
<span id="cb93-69"><a href="#cb93-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-70"><a href="#cb93-70" aria-hidden="true" tabindex="-1"></a>Run the following code to install or load (if already installed) the <span class="in">`pacman`</span> package, and then install or load (if already installed) the listed package inside the <span class="in">`pacman::p_load()`</span> function.</span>
<span id="cb93-71"><a href="#cb93-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-72"><a href="#cb93-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r Chap6_packages}</span></span>
<span id="cb93-73"><a href="#cb93-73" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require("pacman")) install.packages("pacman")</span></span>
<span id="cb93-74"><a href="#cb93-74" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(</span></span>
<span id="cb93-75"><a href="#cb93-75" aria-hidden="true" tabindex="-1"></a><span class="in">  parallel, # for parallelization</span></span>
<span id="cb93-76"><a href="#cb93-76" aria-hidden="true" tabindex="-1"></a><span class="in">  future.apply, # for parallelization</span></span>
<span id="cb93-77"><a href="#cb93-77" aria-hidden="true" tabindex="-1"></a><span class="in">  terra, # handle raster data</span></span>
<span id="cb93-78"><a href="#cb93-78" aria-hidden="true" tabindex="-1"></a><span class="in">  raster, # handle raster data</span></span>
<span id="cb93-79"><a href="#cb93-79" aria-hidden="true" tabindex="-1"></a><span class="in">  stars, # handle raster data </span></span>
<span id="cb93-80"><a href="#cb93-80" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr, # fast extractions</span></span>
<span id="cb93-81"><a href="#cb93-81" aria-hidden="true" tabindex="-1"></a><span class="in">  sf, # vector data operations</span></span>
<span id="cb93-82"><a href="#cb93-82" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr, # data wrangling</span></span>
<span id="cb93-83"><a href="#cb93-83" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table, # data wrangling</span></span>
<span id="cb93-84"><a href="#cb93-84" aria-hidden="true" tabindex="-1"></a><span class="in">  prism, # download PRISM data</span></span>
<span id="cb93-85"><a href="#cb93-85" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot2, # mapping</span></span>
<span id="cb93-86"><a href="#cb93-86" aria-hidden="true" tabindex="-1"></a><span class="in">  tictoc # timing codes</span></span>
<span id="cb93-87"><a href="#cb93-87" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-88"><a href="#cb93-88" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-89"><a href="#cb93-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-90"><a href="#cb93-90" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data preparation</span></span>
<span id="cb93-91"><a href="#cb93-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-92"><a href="#cb93-92" aria-hidden="true" tabindex="-1"></a>We use the following datasets in the first part of this Chapter:</span>
<span id="cb93-93"><a href="#cb93-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-94"><a href="#cb93-94" aria-hidden="true" tabindex="-1"></a>**Wells (points) in Kansas**</span>
<span id="cb93-95"><a href="#cb93-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-96"><a href="#cb93-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{r import_KS_wells}</span></span>
<span id="cb93-97"><a href="#cb93-97" aria-hidden="true" tabindex="-1"></a><span class="in">#--- read in the KS points data ---#</span></span>
<span id="cb93-98"><a href="#cb93-98" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-99"><a href="#cb93-99" aria-hidden="true" tabindex="-1"></a><span class="in">KS_wells &lt;- readRDS("Data/Chap_5_wells_KS.rds")</span></span>
<span id="cb93-100"><a href="#cb93-100" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-101"><a href="#cb93-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-102"><a href="#cb93-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-103"><a href="#cb93-103" aria-hidden="true" tabindex="-1"></a>**Daily PRISM tmax (January, 2009) as `stars` and `SpatRaster`**</span>
<span id="cb93-104"><a href="#cb93-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-105"><a href="#cb93-105" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tmax_read}</span></span>
<span id="cb93-106"><a href="#cb93-106" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_m8_y09_stars &lt;- </span></span>
<span id="cb93-107"><a href="#cb93-107" aria-hidden="true" tabindex="-1"></a><span class="in">  stars::read_stars("Data/PRISM_tmax_y2009_m1.tif") %&gt;%</span></span>
<span id="cb93-108"><a href="#cb93-108" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- change the attribute name ---#</span></span>
<span id="cb93-109"><a href="#cb93-109" aria-hidden="true" tabindex="-1"></a><span class="in">  setNames("tmax")</span></span>
<span id="cb93-110"><a href="#cb93-110" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-111"><a href="#cb93-111" aria-hidden="true" tabindex="-1"></a><span class="in">tmax_m8_y09_sr &lt;- as(tmax_m8_y09_stars, "SpatRaster")</span></span>
<span id="cb93-112"><a href="#cb93-112" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-113"><a href="#cb93-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-114"><a href="#cb93-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-115"><a href="#cb93-115" aria-hidden="true" tabindex="-1"></a>**Kansas county borders**</span>
<span id="cb93-116"><a href="#cb93-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-117"><a href="#cb93-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r county-KS}</span></span>
<span id="cb93-118"><a href="#cb93-118" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-119"><a href="#cb93-119" aria-hidden="true" tabindex="-1"></a><span class="in">KS_county_sf &lt;-</span></span>
<span id="cb93-120"><a href="#cb93-120" aria-hidden="true" tabindex="-1"></a><span class="in">  tigris::counties(state = "Kansas", cb = TRUE, progress_bar = FALSE) %&gt;%</span></span>
<span id="cb93-121"><a href="#cb93-121" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(geometry) %&gt;%</span></span>
<span id="cb93-122"><a href="#cb93-122" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- transform using the CRS of the PRISM stars data  ---#</span></span>
<span id="cb93-123"><a href="#cb93-123" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_transform(sf::st_crs(tmax_m8_y09_stars)) %&gt;%</span></span>
<span id="cb93-124"><a href="#cb93-124" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- generate unique id ---#</span></span>
<span id="cb93-125"><a href="#cb93-125" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(id = 1:nrow(.))</span></span>
<span id="cb93-126"><a href="#cb93-126" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-127"><a href="#cb93-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-128"><a href="#cb93-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-129"><a href="#cb93-129" aria-hidden="true" tabindex="-1"></a>**Daily PRISM tmax (January, 2009) cropped to Kansas as `stars` and `SpatRaster`**</span>
<span id="cb93-130"><a href="#cb93-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-133"><a href="#cb93-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-134"><a href="#cb93-134" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb93-135"><a href="#cb93-135" aria-hidden="true" tabindex="-1"></a>tmax_m8_y09_KS_stars <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_crop</span>(tmax_m8_y09_stars, sf<span class="sc">::</span><span class="fu">st_bbox</span>(KS_county_sf)) </span>
<span id="cb93-136"><a href="#cb93-136" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-137"><a href="#cb93-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-138"><a href="#cb93-138" aria-hidden="true" tabindex="-1"></a>tmax_m8_y09_KS_sr <span class="ot">&lt;-</span> <span class="fu">as</span>(tmax_m8_y09_KS_stars, <span class="st">"SpatRaster"</span>)</span>
<span id="cb93-139"><a href="#cb93-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-140"><a href="#cb93-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-141"><a href="#cb93-141" aria-hidden="true" tabindex="-1"></a><span class="fu">## Should we crop first? {#sec-crop-first}</span></span>
<span id="cb93-142"><a href="#cb93-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-143"><a href="#cb93-143" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extract for points</span></span>
<span id="cb93-144"><a href="#cb93-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-147"><a href="#cb93-147" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-148"><a href="#cb93-148" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mb-crop-or-not</span></span>
<span id="cb93-149"><a href="#cb93-149" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb93-150"><a href="#cb93-150" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb93-151"><a href="#cb93-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-152"><a href="#cb93-152" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span></span>
<span id="cb93-153"><a href="#cb93-153" aria-hidden="true" tabindex="-1"></a>  microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(</span>
<span id="cb93-154"><a href="#cb93-154" aria-hidden="true" tabindex="-1"></a>    <span class="st">"terra-no-crop"</span> <span class="ot">=</span> {</span>
<span id="cb93-155"><a href="#cb93-155" aria-hidden="true" tabindex="-1"></a>      extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(tmax_m8_y09_sr, KS_wells)</span>
<span id="cb93-156"><a href="#cb93-156" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb93-157"><a href="#cb93-157" aria-hidden="true" tabindex="-1"></a>    <span class="st">"terra-crop"</span> <span class="ot">=</span> {</span>
<span id="cb93-158"><a href="#cb93-158" aria-hidden="true" tabindex="-1"></a>      temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(terra<span class="sc">::</span><span class="fu">crop</span>(tmax_m8_y09_sr, KS_wells), KS_wells)</span>
<span id="cb93-159"><a href="#cb93-159" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb93-160"><a href="#cb93-160" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stars-no-crop"</span> <span class="ot">=</span> {</span>
<span id="cb93-161"><a href="#cb93-161" aria-hidden="true" tabindex="-1"></a>      extracted_values <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">st_extract</span>(tmax_m8_y09_stars, KS_wells)</span>
<span id="cb93-162"><a href="#cb93-162" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb93-163"><a href="#cb93-163" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stars-crop"</span> <span class="ot">=</span> {</span>
<span id="cb93-164"><a href="#cb93-164" aria-hidden="true" tabindex="-1"></a>      extracted_values <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">st_extract</span>(sf<span class="sc">::</span><span class="fu">st_crop</span>(tmax_m8_y09_stars, sf<span class="sc">::</span><span class="fu">st_bbox</span>(KS_wells)), KS_wells)</span>
<span id="cb93-165"><a href="#cb93-165" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb93-166"><a href="#cb93-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> <span class="dv">100</span></span>
<span id="cb93-167"><a href="#cb93-167" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb93-168"><a href="#cb93-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-169"><a href="#cb93-169" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(mb, <span class="st">"Data/mb_point_comp.rds"</span>)</span>
<span id="cb93-170"><a href="#cb93-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-171"><a href="#cb93-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-172"><a href="#cb93-172" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb93-173"><a href="#cb93-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-174"><a href="#cb93-174" aria-hidden="true" tabindex="-1"></a>Here is the results of benchmarking:</span>
<span id="cb93-175"><a href="#cb93-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-178"><a href="#cb93-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-179"><a href="#cb93-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mb-crop-or-not-show</span></span>
<span id="cb93-180"><a href="#cb93-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb93-181"><a href="#cb93-181" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb93-182"><a href="#cb93-182" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(</span>
<span id="cb93-183"><a href="#cb93-183" aria-hidden="true" tabindex="-1"></a>  <span class="st">"terra-no-crop"</span> <span class="ot">=</span> {</span>
<span id="cb93-184"><a href="#cb93-184" aria-hidden="true" tabindex="-1"></a>    extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(tmax_m8_y09_sr, KS_wells)</span>
<span id="cb93-185"><a href="#cb93-185" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb93-186"><a href="#cb93-186" aria-hidden="true" tabindex="-1"></a>  <span class="st">"terra-crop"</span> <span class="ot">=</span> {</span>
<span id="cb93-187"><a href="#cb93-187" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(terra<span class="sc">::</span><span class="fu">crop</span>(tmax_m8_y09_sr, KS_wells), KS_wells)</span>
<span id="cb93-188"><a href="#cb93-188" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb93-189"><a href="#cb93-189" aria-hidden="true" tabindex="-1"></a>  <span class="st">"stars-no-crop"</span> <span class="ot">=</span> {</span>
<span id="cb93-190"><a href="#cb93-190" aria-hidden="true" tabindex="-1"></a>    extracted_values <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">st_extract</span>(tmax_m8_y09_stars, KS_wells)</span>
<span id="cb93-191"><a href="#cb93-191" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb93-192"><a href="#cb93-192" aria-hidden="true" tabindex="-1"></a>  <span class="st">"stars-crop"</span> <span class="ot">=</span> {</span>
<span id="cb93-193"><a href="#cb93-193" aria-hidden="true" tabindex="-1"></a>    extracted_values <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">st_extract</span>(sf<span class="sc">::</span><span class="fu">st_crop</span>(tmax_m8_y09_stars, sf<span class="sc">::</span><span class="fu">st_bbox</span>(KS_wells)), KS_wells)</span>
<span id="cb93-194"><a href="#cb93-194" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb93-195"><a href="#cb93-195" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">100</span></span>
<span id="cb93-196"><a href="#cb93-196" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-197"><a href="#cb93-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-198"><a href="#cb93-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-199"><a href="#cb93-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-202"><a href="#cb93-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-203"><a href="#cb93-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb93-204"><a href="#cb93-204" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb93-205"><a href="#cb93-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb93-206"><a href="#cb93-206" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb93-207"><a href="#cb93-207" aria-hidden="true" tabindex="-1"></a><span class="fu">readRDS</span>(<span class="st">"Data/mb_point_comp.rds"</span>)</span>
<span id="cb93-208"><a href="#cb93-208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-209"><a href="#cb93-209" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb93-210"><a href="#cb93-210" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb93-211"><a href="#cb93-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-212"><a href="#cb93-212" aria-hidden="true" tabindex="-1"></a><span class="fu">#### **`terra::extract()`**</span></span>
<span id="cb93-213"><a href="#cb93-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-214"><a href="#cb93-214" aria-hidden="true" tabindex="-1"></a>**without cropping**</span>
<span id="cb93-217"><a href="#cb93-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-218"><a href="#cb93-218" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb93-219"><a href="#cb93-219" aria-hidden="true" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(tmax_m8_y09_sr, KS_wells, <span class="at">FUN =</span> mean)</span>
<span id="cb93-220"><a href="#cb93-220" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb93-221"><a href="#cb93-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-222"><a href="#cb93-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-223"><a href="#cb93-223" aria-hidden="true" tabindex="-1"></a>**with cropping**</span>
<span id="cb93-226"><a href="#cb93-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-227"><a href="#cb93-227" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb93-228"><a href="#cb93-228" aria-hidden="true" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(terra<span class="sc">::</span><span class="fu">crop</span>(tmax_m8_y09_sr, KS_wells), KS_wells, <span class="at">FUN =</span> mean)</span>
<span id="cb93-229"><a href="#cb93-229" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb93-230"><a href="#cb93-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-231"><a href="#cb93-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-232"><a href="#cb93-232" aria-hidden="true" tabindex="-1"></a>As you can see, the difference in computation time is not large.</span>
<span id="cb93-233"><a href="#cb93-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-234"><a href="#cb93-234" aria-hidden="true" tabindex="-1"></a><span class="fu">#### **`stars::extract()`**</span></span>
<span id="cb93-235"><a href="#cb93-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-236"><a href="#cb93-236" aria-hidden="true" tabindex="-1"></a>**without cropping**</span>
<span id="cb93-237"><a href="#cb93-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-240"><a href="#cb93-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-241"><a href="#cb93-241" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb93-242"><a href="#cb93-242" aria-hidden="true" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span> </span>
<span id="cb93-243"><a href="#cb93-243" aria-hidden="true" tabindex="-1"></a>  stars<span class="sc">::</span><span class="fu">st_extract</span>(</span>
<span id="cb93-244"><a href="#cb93-244" aria-hidden="true" tabindex="-1"></a>    tmax_m8_y09_stars, </span>
<span id="cb93-245"><a href="#cb93-245" aria-hidden="true" tabindex="-1"></a>    KS_wells, </span>
<span id="cb93-246"><a href="#cb93-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> mean</span>
<span id="cb93-247"><a href="#cb93-247" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb93-248"><a href="#cb93-248" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb93-249"><a href="#cb93-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-250"><a href="#cb93-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-251"><a href="#cb93-251" aria-hidden="true" tabindex="-1"></a>**with cropping**^<span class="co">[</span><span class="ot">Remember, if you crop to `KS_wells` instead of `sf::st_bbox(KS_wells)`, it would take a lot longer (see @sec-stars-crop).</span><span class="co">]</span></span>
<span id="cb93-252"><a href="#cb93-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-255"><a href="#cb93-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-256"><a href="#cb93-256" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb93-257"><a href="#cb93-257" aria-hidden="true" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span> </span>
<span id="cb93-258"><a href="#cb93-258" aria-hidden="true" tabindex="-1"></a>  stars<span class="sc">::</span><span class="fu">st_extract</span>(</span>
<span id="cb93-259"><a href="#cb93-259" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_crop</span>(tmax_m8_y09_stars, sf<span class="sc">::</span><span class="fu">st_bbox</span>(KS_wells)), KS_wells,</span>
<span id="cb93-260"><a href="#cb93-260" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> mean</span>
<span id="cb93-261"><a href="#cb93-261" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb93-262"><a href="#cb93-262" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb93-263"><a href="#cb93-263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-264"><a href="#cb93-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-265"><a href="#cb93-265" aria-hidden="true" tabindex="-1"></a>As you can see, the difference in computation time is not large either here.</span>
<span id="cb93-266"><a href="#cb93-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-267"><a href="#cb93-267" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extract for polygons</span></span>
<span id="cb93-268"><a href="#cb93-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-269"><a href="#cb93-269" aria-hidden="true" tabindex="-1"></a>When extracting for polygons, it typically pays off to first crop the raster data to the extent of the polygons data first before extraction.</span>
<span id="cb93-270"><a href="#cb93-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-271"><a href="#cb93-271" aria-hidden="true" tabindex="-1"></a>**aggregate.stars()**</span>
<span id="cb93-272"><a href="#cb93-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-273"><a href="#cb93-273" aria-hidden="true" tabindex="-1"></a>Here, the raster dataset is <span class="in">`tmax_m8_y09_stars`</span> which covers the entire contiguous U.S. even though you are extracting values for Kansas (<span class="in">`KS_county_sf`</span>).</span>
<span id="cb93-274"><a href="#cb93-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-275"><a href="#cb93-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r without-cropping-ag, eval = F}</span></span>
<span id="cb93-276"><a href="#cb93-276" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-277"><a href="#cb93-277" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- aggregate(tmax_m8_y09_stars, KS_county_sf, FUN = mean)</span></span>
<span id="cb93-278"><a href="#cb93-278" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-279"><a href="#cb93-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-280"><a href="#cb93-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-281"><a href="#cb93-281" aria-hidden="true" tabindex="-1"></a><span class="in">```{r without-cropping-ag-run, echo = F, eval = F}</span></span>
<span id="cb93-282"><a href="#cb93-282" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-283"><a href="#cb93-283" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-284"><a href="#cb93-284" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- aggregate(tmax_m8_y09_stars, KS_county_sf, FUN = mean)</span></span>
<span id="cb93-285"><a href="#cb93-285" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-286"><a href="#cb93-286" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-287"><a href="#cb93-287" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_txt, "./Data/extracted_tmax_wo_cropping.rds")</span></span>
<span id="cb93-288"><a href="#cb93-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-289"><a href="#cb93-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-290"><a href="#cb93-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r without-cropping-ag-show, echo = F}</span></span>
<span id="cb93-291"><a href="#cb93-291" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt &lt;- readRDS("./Data/extracted_tmax_wo_cropping.rds")</span></span>
<span id="cb93-292"><a href="#cb93-292" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-293"><a href="#cb93-293" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_woc &lt;- log_txt[[1]]$toc - log_txt[[1]]$tic</span></span>
<span id="cb93-294"><a href="#cb93-294" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-295"><a href="#cb93-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-296"><a href="#cb93-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-297"><a href="#cb93-297" aria-hidden="true" tabindex="-1"></a>This one first crops the raster data to the extent of Kansas and then extract.</span>
<span id="cb93-298"><a href="#cb93-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-299"><a href="#cb93-299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r with-cropping-ag}</span></span>
<span id="cb93-300"><a href="#cb93-300" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-301"><a href="#cb93-301" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- </span></span>
<span id="cb93-302"><a href="#cb93-302" aria-hidden="true" tabindex="-1"></a><span class="in">  tmax_m8_y09_KS_stars %&gt;% </span></span>
<span id="cb93-303"><a href="#cb93-303" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_crop(sf::st_bbox(KS_county_sf)) %&gt;% </span></span>
<span id="cb93-304"><a href="#cb93-304" aria-hidden="true" tabindex="-1"></a><span class="in">  aggregate(KS_county_sf, FUN = mean)</span></span>
<span id="cb93-305"><a href="#cb93-305" aria-hidden="true" tabindex="-1"></a><span class="in">toc() </span></span>
<span id="cb93-306"><a href="#cb93-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-307"><a href="#cb93-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-308"><a href="#cb93-308" aria-hidden="true" tabindex="-1"></a>You can see a noticeable improvement.</span>
<span id="cb93-309"><a href="#cb93-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-310"><a href="#cb93-310" aria-hidden="true" tabindex="-1"></a>**exactextractr::exact_extract()**</span>
<span id="cb93-311"><a href="#cb93-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-312"><a href="#cb93-312" aria-hidden="true" tabindex="-1"></a>Without cropping,</span>
<span id="cb93-313"><a href="#cb93-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-314"><a href="#cb93-314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r without-cropping-ee}</span></span>
<span id="cb93-315"><a href="#cb93-315" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-316"><a href="#cb93-316" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- exactextractr::exact_extract(as(tmax_m8_y09_stars, "SpatRaster"), KS_county_sf, "mean", progress = FALSE)</span></span>
<span id="cb93-317"><a href="#cb93-317" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-318"><a href="#cb93-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-319"><a href="#cb93-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-320"><a href="#cb93-320" aria-hidden="true" tabindex="-1"></a>With cropping,</span>
<span id="cb93-321"><a href="#cb93-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-322"><a href="#cb93-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r with-cropping-ee}</span></span>
<span id="cb93-323"><a href="#cb93-323" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-324"><a href="#cb93-324" aria-hidden="true" tabindex="-1"></a><span class="in">results &lt;- tmax_m8_y09_KS_stars %&gt;% </span></span>
<span id="cb93-325"><a href="#cb93-325" aria-hidden="true" tabindex="-1"></a><span class="in">  st_crop(st_bbox(KS_county_sf)) %&gt;% </span></span>
<span id="cb93-326"><a href="#cb93-326" aria-hidden="true" tabindex="-1"></a><span class="in">  as("SpatRaster") %&gt;% </span></span>
<span id="cb93-327"><a href="#cb93-327" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(KS_county_sf, "mean", progress = FALSE)</span></span>
<span id="cb93-328"><a href="#cb93-328" aria-hidden="true" tabindex="-1"></a><span class="in">toc() </span></span>
<span id="cb93-329"><a href="#cb93-329" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-330"><a href="#cb93-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-331"><a href="#cb93-331" aria-hidden="true" tabindex="-1"></a>So, it is still worthwhile to crop first, but the benefit of doing so is not as large as <span class="in">`aggregate.stars()`</span> experienced. This is because <span class="in">`exactextractr::exact_extract`</span> does chunk-by-chunk operations where the unnecessary parts of the data are hardly relevant in the entire process.</span>
<span id="cb93-332"><a href="#cb93-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-333"><a href="#cb93-333" aria-hidden="true" tabindex="-1"></a>**terra::extract()**</span>
<span id="cb93-334"><a href="#cb93-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-337"><a href="#cb93-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-338"><a href="#cb93-338" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb93-339"><a href="#cb93-339" aria-hidden="true" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(tmax_m8_y09_sr, KS_county_sf, <span class="at">fun =</span> mean)</span>
<span id="cb93-340"><a href="#cb93-340" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb93-341"><a href="#cb93-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-342"><a href="#cb93-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-345"><a href="#cb93-345" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-346"><a href="#cb93-346" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb93-347"><a href="#cb93-347" aria-hidden="true" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(terra<span class="sc">::</span><span class="fu">crop</span>(tmax_m8_y09_sr, KS_county_sf), KS_county_sf, <span class="at">fun =</span> mean)</span>
<span id="cb93-348"><a href="#cb93-348" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb93-349"><a href="#cb93-349" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-350"><a href="#cb93-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-351"><a href="#cb93-351" aria-hidden="true" tabindex="-1"></a>Virtually no time difference between the two.</span>
<span id="cb93-352"><a href="#cb93-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-353"><a href="#cb93-353" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb93-354"><a href="#cb93-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-355"><a href="#cb93-355" aria-hidden="true" tabindex="-1"></a>Given, how fast <span class="in">`terra::extract()`</span> is, you might wonder if you should convert the <span class="in">`stars`</span> object to a <span class="in">`SpatRaster`</span> object, and then extract with <span class="in">`terra::extract()`</span> instead of <span class="in">`aggregate.stars()`</span>.</span>
<span id="cb93-356"><a href="#cb93-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-359"><a href="#cb93-359" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-360"><a href="#cb93-360" aria-hidden="true" tabindex="-1"></a><span class="co">#--- terra::extract() with internal conversion to "SpatRaster" ---#</span></span>
<span id="cb93-361"><a href="#cb93-361" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb93-362"><a href="#cb93-362" aria-hidden="true" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(<span class="fu">as</span>(tmax_m8_y09_sr, <span class="st">"SpatRaster"</span>), KS_county_sf, <span class="at">fun =</span> mean)</span>
<span id="cb93-363"><a href="#cb93-363" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb93-364"><a href="#cb93-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-365"><a href="#cb93-365" aria-hidden="true" tabindex="-1"></a><span class="co">#--- aggregate.stars() with cropping ---#</span></span>
<span id="cb93-366"><a href="#cb93-366" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb93-367"><a href="#cb93-367" aria-hidden="true" tabindex="-1"></a>extracted_values <span class="ot">&lt;-</span></span>
<span id="cb93-368"><a href="#cb93-368" aria-hidden="true" tabindex="-1"></a>  tmax_m8_y09_KS_stars <span class="sc">%&gt;%</span></span>
<span id="cb93-369"><a href="#cb93-369" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_crop</span>(sf<span class="sc">::</span><span class="fu">st_bbox</span>(KS_county_sf)) <span class="sc">%&gt;%</span></span>
<span id="cb93-370"><a href="#cb93-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate</span>(KS_county_sf, <span class="at">FUN =</span> mean)</span>
<span id="cb93-371"><a href="#cb93-371" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span>
<span id="cb93-372"><a href="#cb93-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-373"><a href="#cb93-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-374"><a href="#cb93-374" aria-hidden="true" tabindex="-1"></a>Well, the winner is clear here. Even if you mainly use <span class="in">`stars`</span> to handle raster data, you might want to consider using <span class="in">`terra::extract()`</span> if you need to repeat raster value extraction many many times given how simple it is to convert a <span class="in">`stars`</span> object to a <span class="in">`SpatRaster`</span> with <span class="in">`as(stars, "SpatRaster")`</span>.</span>
<span id="cb93-375"><a href="#cb93-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-376"><a href="#cb93-376" aria-hidden="true" tabindex="-1"></a><span class="fu">## The number of raster cells and vector geometries {#sec-num-cells-geometries}</span></span>
<span id="cb93-377"><a href="#cb93-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-378"><a href="#cb93-378" aria-hidden="true" tabindex="-1"></a><span class="fu">### Base line</span></span>
<span id="cb93-379"><a href="#cb93-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-380"><a href="#cb93-380" aria-hidden="true" tabindex="-1"></a>Let's start with the example we used above in @sec-extraction-stars-polygons using <span class="in">`KS_county_sf`</span> as the polygons data and <span class="in">`tmax_m8_y09_KS_stars`</span> and <span class="in">`tmax_m8_y09_KS_sr`</span> (they are already cropped to Kansas) as the raster data.</span>
<span id="cb93-381"><a href="#cb93-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-382"><a href="#cb93-382" aria-hidden="true" tabindex="-1"></a>**terra::extract()**</span>
<span id="cb93-383"><a href="#cb93-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb93-384"><a href="#cb93-384" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-385"><a href="#cb93-385" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- terra::extract(tmax_m8_y09_KS_sr, KS_county_sf, FUN = mean)</span></span>
<span id="cb93-386"><a href="#cb93-386" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-387"><a href="#cb93-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-388"><a href="#cb93-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-389"><a href="#cb93-389" aria-hidden="true" tabindex="-1"></a>**aggregate.stars()**</span>
<span id="cb93-390"><a href="#cb93-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-391"><a href="#cb93-391" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb93-392"><a href="#cb93-392" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-393"><a href="#cb93-393" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- aggregate(sf::st_crop(tmax_m8_y09_KS_stars, KS_county_sf), KS_county_sf, FUN = mean) %&gt;%</span></span>
<span id="cb93-394"><a href="#cb93-394" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sf()</span></span>
<span id="cb93-395"><a href="#cb93-395" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-396"><a href="#cb93-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-397"><a href="#cb93-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-398"><a href="#cb93-398" aria-hidden="true" tabindex="-1"></a>**exactextractr::exact_extract()**</span>
<span id="cb93-399"><a href="#cb93-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-400"><a href="#cb93-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb93-401"><a href="#cb93-401" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-402"><a href="#cb93-402" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- exactextractr::exact_extract(tmax_m8_y09_KS_sr, KS_county_sf, "mean", progress = FALSE)</span></span>
<span id="cb93-403"><a href="#cb93-403" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-404"><a href="#cb93-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-405"><a href="#cb93-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-406"><a href="#cb93-406" aria-hidden="true" tabindex="-1"></a>All of them are quite fast, but <span class="in">`terra::extract`</span> and <span class="in">`exactextractr::exact_extract()`</span> are clearly faster than <span class="in">`aggregate.stars()`</span>.</span>
<span id="cb93-407"><a href="#cb93-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-408"><a href="#cb93-408" aria-hidden="true" tabindex="-1"></a><span class="fu">### Large number of polygons</span></span>
<span id="cb93-409"><a href="#cb93-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-410"><a href="#cb93-410" aria-hidden="true" tabindex="-1"></a>Now, let's increase the number of polygons without changing the spatial extent of the polygons data. This is done by creating lots of regular grids over Kansas.</span>
<span id="cb93-411"><a href="#cb93-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-412"><a href="#cb93-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-grids-KS}</span></span>
<span id="cb93-413"><a href="#cb93-413" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-414"><a href="#cb93-414" aria-hidden="true" tabindex="-1"></a><span class="in">grids_in_KS &lt;- </span></span>
<span id="cb93-415"><a href="#cb93-415" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_make_grid(KS_county_sf, n = c(200, 200)) %&gt;%</span></span>
<span id="cb93-416"><a href="#cb93-416" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sf()</span></span>
<span id="cb93-417"><a href="#cb93-417" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-418"><a href="#cb93-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-419"><a href="#cb93-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-420"><a href="#cb93-420" aria-hidden="true" tabindex="-1"></a>In total, <span class="in">`grids_in_KS`</span> has 40,000 polygons (@fig-grids-ks shows what the grids look like).</span>
<span id="cb93-421"><a href="#cb93-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-422"><a href="#cb93-422" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb93-423"><a href="#cb93-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r , fig.cap = }</span></span>
<span id="cb93-424"><a href="#cb93-424" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-grids-ks</span></span>
<span id="cb93-425"><a href="#cb93-425" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "40,000 regular grids over tmax data for Kansas"</span></span>
<span id="cb93-426"><a href="#cb93-426" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb93-427"><a href="#cb93-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-428"><a href="#cb93-428" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot() +</span></span>
<span id="cb93-429"><a href="#cb93-429" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_stars(data = tmax_m8_y09_KS_stars[,,,1]) +</span></span>
<span id="cb93-430"><a href="#cb93-430" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_viridis_c() +</span></span>
<span id="cb93-431"><a href="#cb93-431" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_sf(data = grids_in_KS, fill = NA) +</span></span>
<span id="cb93-432"><a href="#cb93-432" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_void() </span></span>
<span id="cb93-433"><a href="#cb93-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-434"><a href="#cb93-434" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb93-435"><a href="#cb93-435" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb93-436"><a href="#cb93-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-437"><a href="#cb93-437" aria-hidden="true" tabindex="-1"></a>Now, let's compare the three approaches.</span>
<span id="cb93-438"><a href="#cb93-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-439"><a href="#cb93-439" aria-hidden="true" tabindex="-1"></a>**terra::extract()**</span>
<span id="cb93-440"><a href="#cb93-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-441"><a href="#cb93-441" aria-hidden="true" tabindex="-1"></a><span class="in">```{r more-grids-te}</span></span>
<span id="cb93-442"><a href="#cb93-442" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-443"><a href="#cb93-443" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- terra::extract(tmax_m8_y09_KS_sr, grids_in_KS, FUN = mean)</span></span>
<span id="cb93-444"><a href="#cb93-444" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-445"><a href="#cb93-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-446"><a href="#cb93-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-447"><a href="#cb93-447" aria-hidden="true" tabindex="-1"></a>**aggregate()**</span>
<span id="cb93-448"><a href="#cb93-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-449"><a href="#cb93-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r more-grids-se}</span></span>
<span id="cb93-450"><a href="#cb93-450" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-451"><a href="#cb93-451" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- aggregate(tmax_m8_y09_KS_stars, grids_in_KS, FUN = mean) %&gt;% </span></span>
<span id="cb93-452"><a href="#cb93-452" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sf</span></span>
<span id="cb93-453"><a href="#cb93-453" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-454"><a href="#cb93-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-455"><a href="#cb93-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-456"><a href="#cb93-456" aria-hidden="true" tabindex="-1"></a>**exact_extract()**</span>
<span id="cb93-457"><a href="#cb93-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-458"><a href="#cb93-458" aria-hidden="true" tabindex="-1"></a><span class="in">```{r more-grids-ee}</span></span>
<span id="cb93-459"><a href="#cb93-459" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-460"><a href="#cb93-460" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- exactextractr::exact_extract(tmax_m8_y09_KS_sr, grids_in_KS, "mean", progress = FALSE)</span></span>
<span id="cb93-461"><a href="#cb93-461" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-462"><a href="#cb93-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span> </span>
<span id="cb93-463"><a href="#cb93-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-464"><a href="#cb93-464" aria-hidden="true" tabindex="-1"></a>Interestingly, <span class="in">`exactextractr::exact_extract()`</span> is affected by an increase in the number of polygons more than <span class="in">`aggregate()`</span>.</span>
<span id="cb93-465"><a href="#cb93-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-466"><a href="#cb93-466" aria-hidden="true" tabindex="-1"></a><span class="fu">### Large number of raster cells</span></span>
<span id="cb93-467"><a href="#cb93-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-468"><a href="#cb93-468" aria-hidden="true" tabindex="-1"></a>Now, let's make <span class="in">`tmax_m8_y09_KS_sr`</span> much larger by disaggregating it by a factor of 10 (100 times more cells).</span>
<span id="cb93-469"><a href="#cb93-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-472"><a href="#cb93-472" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-473"><a href="#cb93-473" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb93-474"><a href="#cb93-474" aria-hidden="true" tabindex="-1"></a>tmax_m8_y09_KS_sr_large <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">disagg</span>(tmax_m8_y09_KS_sr, <span class="at">fact =</span> <span class="dv">10</span>)</span>
<span id="cb93-475"><a href="#cb93-475" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-476"><a href="#cb93-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-477"><a href="#cb93-477" aria-hidden="true" tabindex="-1"></a><span class="co">#--- stars version ---#</span></span>
<span id="cb93-478"><a href="#cb93-478" aria-hidden="true" tabindex="-1"></a>tmax_m8_y09_KS_stars_large <span class="ot">&lt;-</span> <span class="fu">st_as_stars</span>(tmax_m8_y09_KS_sr_large)</span>
<span id="cb93-479"><a href="#cb93-479" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-480"><a href="#cb93-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-481"><a href="#cb93-481" aria-hidden="true" tabindex="-1"></a>**terra::extract()**</span>
<span id="cb93-482"><a href="#cb93-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-483"><a href="#cb93-483" aria-hidden="true" tabindex="-1"></a><span class="in">```{r te_dips, eval = F}</span></span>
<span id="cb93-484"><a href="#cb93-484" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-485"><a href="#cb93-485" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- terra::extract(tmax_m8_y09_KS_sr_large, grids_in_KS, FUN = mean)</span></span>
<span id="cb93-486"><a href="#cb93-486" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-487"><a href="#cb93-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-488"><a href="#cb93-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-489"><a href="#cb93-489" aria-hidden="true" tabindex="-1"></a><span class="in">```{r te_run, echo = F, eval = F}</span></span>
<span id="cb93-490"><a href="#cb93-490" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-491"><a href="#cb93-491" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-492"><a href="#cb93-492" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- terra::extract(tmax_m8_y09_KS_sr_large, grids_in_KS, FUN = mean)</span></span>
<span id="cb93-493"><a href="#cb93-493" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-494"><a href="#cb93-494" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-495"><a href="#cb93-495" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_txt, "./Data/extracted_tmax_terra.rds")</span></span>
<span id="cb93-496"><a href="#cb93-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-497"><a href="#cb93-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-498"><a href="#cb93-498" aria-hidden="true" tabindex="-1"></a><span class="in">```{r te_show, echo = F}</span></span>
<span id="cb93-499"><a href="#cb93-499" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt &lt;- readRDS("./Data/extracted_tmax_terra.rds")</span></span>
<span id="cb93-500"><a href="#cb93-500" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-501"><a href="#cb93-501" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_ag &lt;- log_txt[[1]]$toc - log_txt[[1]]$tic</span></span>
<span id="cb93-502"><a href="#cb93-502" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-503"><a href="#cb93-503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-504"><a href="#cb93-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-505"><a href="#cb93-505" aria-hidden="true" tabindex="-1"></a>**aggregate()**</span>
<span id="cb93-506"><a href="#cb93-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-507"><a href="#cb93-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ag_dips, eval = F}</span></span>
<span id="cb93-508"><a href="#cb93-508" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-509"><a href="#cb93-509" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- aggregate(tmax_m8_y09_KS_stars_large, grids_in_KS, FUN = mean)</span></span>
<span id="cb93-510"><a href="#cb93-510" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-511"><a href="#cb93-511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-512"><a href="#cb93-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-513"><a href="#cb93-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ag_run, echo = F, eval = F}</span></span>
<span id="cb93-514"><a href="#cb93-514" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-515"><a href="#cb93-515" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-516"><a href="#cb93-516" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- aggregate(tmax_m8_y09_KS_stars_large, grids_in_KS, FUN = mean)</span></span>
<span id="cb93-517"><a href="#cb93-517" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-518"><a href="#cb93-518" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-519"><a href="#cb93-519" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_txt, "./Data/extracted_tmax_ag.rds")</span></span>
<span id="cb93-520"><a href="#cb93-520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-521"><a href="#cb93-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-522"><a href="#cb93-522" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ag_show, echo = F}</span></span>
<span id="cb93-523"><a href="#cb93-523" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt &lt;- readRDS("./Data/extracted_tmax_ag.rds")</span></span>
<span id="cb93-524"><a href="#cb93-524" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-525"><a href="#cb93-525" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_ag &lt;- log_txt[[1]]$toc - log_txt[[1]]$tic</span></span>
<span id="cb93-526"><a href="#cb93-526" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-527"><a href="#cb93-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-528"><a href="#cb93-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-529"><a href="#cb93-529" aria-hidden="true" tabindex="-1"></a>**exact_extract()**</span>
<span id="cb93-530"><a href="#cb93-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-531"><a href="#cb93-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ee-disp, eval = F}</span></span>
<span id="cb93-532"><a href="#cb93-532" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-533"><a href="#cb93-533" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- exactextractr::exact_extract(tmax_m8_y09_KS_sr_large, grids_in_KS, "mean", progress = FALSE)</span></span>
<span id="cb93-534"><a href="#cb93-534" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-535"><a href="#cb93-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-536"><a href="#cb93-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-537"><a href="#cb93-537" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ee-run, echo = F, eval = F}</span></span>
<span id="cb93-538"><a href="#cb93-538" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-539"><a href="#cb93-539" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-540"><a href="#cb93-540" aria-hidden="true" tabindex="-1"></a><span class="in">extracted_values &lt;- exactextractr::exact_extract(tmax_m8_y09_KS_sr_large, grids_in_KS, "mean", progress = FALSE)</span></span>
<span id="cb93-541"><a href="#cb93-541" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-542"><a href="#cb93-542" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-543"><a href="#cb93-543" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_txt, "./Data/extracted_tmax_ee_poly.rds")</span></span>
<span id="cb93-544"><a href="#cb93-544" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-545"><a href="#cb93-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-546"><a href="#cb93-546" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ee-show, echo = F}</span></span>
<span id="cb93-547"><a href="#cb93-547" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt &lt;- readRDS("./Data/extracted_tmax_ee_poly.rds")</span></span>
<span id="cb93-548"><a href="#cb93-548" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-549"><a href="#cb93-549" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_ee &lt;- log_txt[[1]]$toc - log_txt[[1]]$tic</span></span>
<span id="cb93-550"><a href="#cb93-550" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-551"><a href="#cb93-551" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-552"><a href="#cb93-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-553"><a href="#cb93-553" aria-hidden="true" tabindex="-1"></a>Here, <span class="in">`exactextractr::exact_extract()`</span> outperforms <span class="in">`terra::extract()`</span>, both of which outperform significantly <span class="in">`aggregate.stars()`</span>. Indeed, <span class="in">`aggregate.stars()`</span> is painfully slow.</span>
<span id="cb93-554"><a href="#cb93-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-555"><a href="#cb93-555" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parallelization on a single raster layer</span></span>
<span id="cb93-556"><a href="#cb93-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-557"><a href="#cb93-557" aria-hidden="true" tabindex="-1"></a>Let's prepare for parallel processing for the rest of the section.</span>
<span id="cb93-558"><a href="#cb93-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-559"><a href="#cb93-559" aria-hidden="true" tabindex="-1"></a><span class="in">```{r future_plan, cache = F}</span></span>
<span id="cb93-560"><a href="#cb93-560" aria-hidden="true" tabindex="-1"></a><span class="in">#--- get the number of logical cores to use ---#</span></span>
<span id="cb93-561"><a href="#cb93-561" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-562"><a href="#cb93-562" aria-hidden="true" tabindex="-1"></a><span class="in">  num_cores &lt;- parallel::detectCores() - 2</span></span>
<span id="cb93-563"><a href="#cb93-563" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-564"><a href="#cb93-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-565"><a href="#cb93-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-566"><a href="#cb93-566" aria-hidden="true" tabindex="-1"></a><span class="fu">### Datasets</span></span>
<span id="cb93-567"><a href="#cb93-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-568"><a href="#cb93-568" aria-hidden="true" tabindex="-1"></a>We will use the following datasets:</span>
<span id="cb93-569"><a href="#cb93-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-570"><a href="#cb93-570" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**raster**: Iowa Cropland Data Layer (CDL) data in 2015  </span>
<span id="cb93-571"><a href="#cb93-571" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**polygons**: Regular polygon grids over Iowa </span>
<span id="cb93-572"><a href="#cb93-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-573"><a href="#cb93-573" aria-hidden="true" tabindex="-1"></a>**Iowa CDL data in 2015** (@fig-land)</span>
<span id="cb93-574"><a href="#cb93-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-575"><a href="#cb93-575" aria-hidden="true" tabindex="-1"></a><span class="in">```{r data_prep_par}</span></span>
<span id="cb93-576"><a href="#cb93-576" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: false</span></span>
<span id="cb93-577"><a href="#cb93-577" aria-hidden="true" tabindex="-1"></a><span class="in">#--- Iowa CDL in 2015 ---#</span></span>
<span id="cb93-578"><a href="#cb93-578" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-579"><a href="#cb93-579" aria-hidden="true" tabindex="-1"></a><span class="in">IA_cdl_15 &lt;- terra::rast("Data/IA_cdl_2015.tif")</span></span>
<span id="cb93-580"><a href="#cb93-580" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-581"><a href="#cb93-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-582"><a href="#cb93-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-583"><a href="#cb93-583" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb93-586"><a href="#cb93-586" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-587"><a href="#cb93-587" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-land</span></span>
<span id="cb93-588"><a href="#cb93-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Land use type in Iowa in 2105"</span></span>
<span id="cb93-589"><a href="#cb93-589" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb93-590"><a href="#cb93-590" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb93-591"><a href="#cb93-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-592"><a href="#cb93-592" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(IA_cdl_15)</span>
<span id="cb93-593"><a href="#cb93-593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-594"><a href="#cb93-594" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb93-595"><a href="#cb93-595" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb93-596"><a href="#cb93-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-597"><a href="#cb93-597" aria-hidden="true" tabindex="-1"></a>Values recorded in the raster data are integers representing land use type.</span>
<span id="cb93-598"><a href="#cb93-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-599"><a href="#cb93-599" aria-hidden="true" tabindex="-1"></a>**Regularly-sized grids over Iowa** (@fig-IA-grids)</span>
<span id="cb93-600"><a href="#cb93-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-601"><a href="#cb93-601" aria-hidden="true" tabindex="-1"></a><span class="in">```{r IA_grids}</span></span>
<span id="cb93-602"><a href="#cb93-602" aria-hidden="true" tabindex="-1"></a><span class="in">#--- regular grids over Iowa ---#</span></span>
<span id="cb93-603"><a href="#cb93-603" aria-hidden="true" tabindex="-1"></a><span class="in">IA_grids &lt;-</span></span>
<span id="cb93-604"><a href="#cb93-604" aria-hidden="true" tabindex="-1"></a><span class="in">  tigris::counties(state = "IA", cb = TRUE) %&gt;%</span></span>
<span id="cb93-605"><a href="#cb93-605" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- create regularly-sized grids ---#</span></span>
<span id="cb93-606"><a href="#cb93-606" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_make_grid(n = c(100, 100)) %&gt;%</span></span>
<span id="cb93-607"><a href="#cb93-607" aria-hidden="true" tabindex="-1"></a><span class="in">  sf::st_as_sf() %&gt;%</span></span>
<span id="cb93-608"><a href="#cb93-608" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::rename(geometry = x) %&gt;%</span></span>
<span id="cb93-609"><a href="#cb93-609" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- project to the CRS of the CDL data ---#</span></span>
<span id="cb93-610"><a href="#cb93-610" aria-hidden="true" tabindex="-1"></a><span class="in">  st_transform(terra::crs(IA_cdl_15))</span></span>
<span id="cb93-611"><a href="#cb93-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-612"><a href="#cb93-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-613"><a href="#cb93-613" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb93-616"><a href="#cb93-616" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-617"><a href="#cb93-617" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-IA-grids</span></span>
<span id="cb93-618"><a href="#cb93-618" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Regular grids over Iowas as sf"</span></span>
<span id="cb93-619"><a href="#cb93-619" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb93-620"><a href="#cb93-620" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb93-621"><a href="#cb93-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-622"><a href="#cb93-622" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(IA_grids) <span class="sc">+</span></span>
<span id="cb93-623"><a href="#cb93-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb93-624"><a href="#cb93-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb93-625"><a href="#cb93-625" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-626"><a href="#cb93-626" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb93-627"><a href="#cb93-627" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb93-628"><a href="#cb93-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-629"><a href="#cb93-629" aria-hidden="true" tabindex="-1"></a><span class="fu">### Parallelization</span></span>
<span id="cb93-630"><a href="#cb93-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-631"><a href="#cb93-631" aria-hidden="true" tabindex="-1"></a>Here is how long it takes to extract raster data values for the polygon grids using <span class="in">`exactextractr::exact_extract()`</span> (<span class="in">`terra::extract()`</span> takes too much time and is not practical for this set of datasets). </span>
<span id="cb93-632"><a href="#cb93-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-633"><a href="#cb93-633" aria-hidden="true" tabindex="-1"></a><span class="in">```{r time_ee_disp, eval = F}</span></span>
<span id="cb93-634"><a href="#cb93-634" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-635"><a href="#cb93-635" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;-</span></span>
<span id="cb93-636"><a href="#cb93-636" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(IA_cdl_15, IA_grids) %&gt;% </span></span>
<span id="cb93-637"><a href="#cb93-637" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table::rbindlist()</span></span>
<span id="cb93-638"><a href="#cb93-638" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-639"><a href="#cb93-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-640"><a href="#cb93-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-641"><a href="#cb93-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r time_ee_run, echo = F}</span></span>
<span id="cb93-642"><a href="#cb93-642" aria-hidden="true" tabindex="-1"></a><span class="in">#| cache: false</span></span>
<span id="cb93-643"><a href="#cb93-643" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-644"><a href="#cb93-644" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-645"><a href="#cb93-645" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- </span></span>
<span id="cb93-646"><a href="#cb93-646" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(IA_cdl_15, IA_grids, progress = FALSE) %&gt;%</span></span>
<span id="cb93-647"><a href="#cb93-647" aria-hidden="true" tabindex="-1"></a><span class="in">  data.table::rbindlist()</span></span>
<span id="cb93-648"><a href="#cb93-648" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-649"><a href="#cb93-649" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-650"><a href="#cb93-650" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_nonpar &lt;- log_txt[[1]]$toc - log_txt[[1]]$tic</span></span>
<span id="cb93-651"><a href="#cb93-651" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_nonpar</span></span>
<span id="cb93-652"><a href="#cb93-652" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-653"><a href="#cb93-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-654"><a href="#cb93-654" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb93-655"><a href="#cb93-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-656"><a href="#cb93-656" aria-hidden="true" tabindex="-1"></a>One way to parallelize this process is to let each core work on one polygon at a time. Let's first define the function to extract values for one polygon and then run it for all the polygons parallelized.</span>
<span id="cb93-657"><a href="#cb93-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-658"><a href="#cb93-658" aria-hidden="true" tabindex="-1"></a><span class="in">```{r par_one_poly, eval = F}</span></span>
<span id="cb93-659"><a href="#cb93-659" aria-hidden="true" tabindex="-1"></a><span class="in">#--- function to extract raster values for a single polygon ---#</span></span>
<span id="cb93-660"><a href="#cb93-660" aria-hidden="true" tabindex="-1"></a><span class="in">get_values_i &lt;- function(i) {</span></span>
<span id="cb93-661"><a href="#cb93-661" aria-hidden="true" tabindex="-1"></a><span class="in">  temp &lt;- </span></span>
<span id="cb93-662"><a href="#cb93-662" aria-hidden="true" tabindex="-1"></a><span class="in">    exactextractr::exact_extract(IA_cdl_15, IA_grids[i, ]) %&gt;%</span></span>
<span id="cb93-663"><a href="#cb93-663" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::rbindlist()</span></span>
<span id="cb93-664"><a href="#cb93-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-665"><a href="#cb93-665" aria-hidden="true" tabindex="-1"></a><span class="in">  return(temp)</span></span>
<span id="cb93-666"><a href="#cb93-666" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb93-667"><a href="#cb93-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-668"><a href="#cb93-668" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallelized ---#</span></span>
<span id="cb93-669"><a href="#cb93-669" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-670"><a href="#cb93-670" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- parallel::mclapply(1:nrow(IA_grids), get_values_i, mc.cores = num_cores)</span></span>
<span id="cb93-671"><a href="#cb93-671" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-672"><a href="#cb93-672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-673"><a href="#cb93-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-674"><a href="#cb93-674" aria-hidden="true" tabindex="-1"></a><span class="in">```{r par_one_poly_run, echo = F, eval = F}</span></span>
<span id="cb93-675"><a href="#cb93-675" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-676"><a href="#cb93-676" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-677"><a href="#cb93-677" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- parallel::mclapply(1:nrow(IA_grids), get_values_i, mc.cores = num_cores)</span></span>
<span id="cb93-678"><a href="#cb93-678" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-679"><a href="#cb93-679" aria-hidden="true" tabindex="-1"></a><span class="in">log_one_poly &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-680"><a href="#cb93-680" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_one_poly, "Data/log_one_poly.rds")</span></span>
<span id="cb93-681"><a href="#cb93-681" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-682"><a href="#cb93-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-683"><a href="#cb93-683" aria-hidden="true" tabindex="-1"></a><span class="in">```{r par_one_poly_show, echo = F, cache = TRUE}</span></span>
<span id="cb93-684"><a href="#cb93-684" aria-hidden="true" tabindex="-1"></a><span class="in">log_one_poly &lt;- readRDS("Data/log_one_poly.rds")</span></span>
<span id="cb93-685"><a href="#cb93-685" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_nonpar &lt;- log_one_poly[[1]]$toc - log_one_poly[[1]]$tic</span></span>
<span id="cb93-686"><a href="#cb93-686" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_nonpar</span></span>
<span id="cb93-687"><a href="#cb93-687" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-688"><a href="#cb93-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-689"><a href="#cb93-689" aria-hidden="true" tabindex="-1"></a>As you can see, this is not a good way to parallelize the computation process. To see why, let's look at the computation time of extracting from one polygon, two polygons, and up to five polygons. </span>
<span id="cb93-690"><a href="#cb93-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-691"><a href="#cb93-691" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mb_poly, eval = F}</span></span>
<span id="cb93-692"><a href="#cb93-692" aria-hidden="true" tabindex="-1"></a><span class="in">mb &lt;- </span></span>
<span id="cb93-693"><a href="#cb93-693" aria-hidden="true" tabindex="-1"></a><span class="in">  microbenchmark::microbenchmark(</span></span>
<span id="cb93-694"><a href="#cb93-694" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_1" = {</span></span>
<span id="cb93-695"><a href="#cb93-695" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1, ])</span></span>
<span id="cb93-696"><a href="#cb93-696" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-697"><a href="#cb93-697" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_2" = {</span></span>
<span id="cb93-698"><a href="#cb93-698" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1:2, ])</span></span>
<span id="cb93-699"><a href="#cb93-699" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-700"><a href="#cb93-700" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_3" = {</span></span>
<span id="cb93-701"><a href="#cb93-701" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1:3, ])</span></span>
<span id="cb93-702"><a href="#cb93-702" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-703"><a href="#cb93-703" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_4" = {</span></span>
<span id="cb93-704"><a href="#cb93-704" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1:4, ])</span></span>
<span id="cb93-705"><a href="#cb93-705" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-706"><a href="#cb93-706" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_5" = {</span></span>
<span id="cb93-707"><a href="#cb93-707" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1:5, ])</span></span>
<span id="cb93-708"><a href="#cb93-708" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-709"><a href="#cb93-709" aria-hidden="true" tabindex="-1"></a><span class="in">    times = 100</span></span>
<span id="cb93-710"><a href="#cb93-710" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-711"><a href="#cb93-711" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-712"><a href="#cb93-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-713"><a href="#cb93-713" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mb_poly_run, echo = F, eval = F}</span></span>
<span id="cb93-714"><a href="#cb93-714" aria-hidden="true" tabindex="-1"></a><span class="in">mb &lt;- </span></span>
<span id="cb93-715"><a href="#cb93-715" aria-hidden="true" tabindex="-1"></a><span class="in">  microbenchmark::microbenchmark(</span></span>
<span id="cb93-716"><a href="#cb93-716" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_1" = {</span></span>
<span id="cb93-717"><a href="#cb93-717" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1, ], progress = F)</span></span>
<span id="cb93-718"><a href="#cb93-718" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-719"><a href="#cb93-719" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_2" = {</span></span>
<span id="cb93-720"><a href="#cb93-720" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1:2, ], progress = F)</span></span>
<span id="cb93-721"><a href="#cb93-721" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-722"><a href="#cb93-722" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_3" = {</span></span>
<span id="cb93-723"><a href="#cb93-723" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1:3, ], progress = F)</span></span>
<span id="cb93-724"><a href="#cb93-724" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-725"><a href="#cb93-725" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_4" = {</span></span>
<span id="cb93-726"><a href="#cb93-726" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1:4, ], progress = F)</span></span>
<span id="cb93-727"><a href="#cb93-727" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-728"><a href="#cb93-728" aria-hidden="true" tabindex="-1"></a><span class="in">    "p_5" = {</span></span>
<span id="cb93-729"><a href="#cb93-729" aria-hidden="true" tabindex="-1"></a><span class="in">      temp &lt;- exactextractr::exact_extract(IA_cdl_15, IA_grids[1:5, ], progress = F)</span></span>
<span id="cb93-730"><a href="#cb93-730" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-731"><a href="#cb93-731" aria-hidden="true" tabindex="-1"></a><span class="in">    times = 100</span></span>
<span id="cb93-732"><a href="#cb93-732" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-733"><a href="#cb93-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-734"><a href="#cb93-734" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(mb, "Data/mb_poly_run.rds")</span></span>
<span id="cb93-735"><a href="#cb93-735" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-736"><a href="#cb93-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-737"><a href="#cb93-737" aria-hidden="true" tabindex="-1"></a><span class="in">```{r read-mb, echo = F, cache = TRUE}</span></span>
<span id="cb93-738"><a href="#cb93-738" aria-hidden="true" tabindex="-1"></a><span class="in">mb &lt;- readRDS("Data/mb_poly_run.rds")</span></span>
<span id="cb93-739"><a href="#cb93-739" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-740"><a href="#cb93-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-741"><a href="#cb93-741" aria-hidden="true" tabindex="-1"></a>@fig-comp-polygons shows the results of the benchmarking.</span>
<span id="cb93-742"><a href="#cb93-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-745"><a href="#cb93-745" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-746"><a href="#cb93-746" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-comp-polygons</span></span>
<span id="cb93-747"><a href="#cb93-747" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comparison of the computation time of raster data extractions"</span></span>
<span id="cb93-748"><a href="#cb93-748" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb93-749"><a href="#cb93-749" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb93-750"><a href="#cb93-750" aria-hidden="true" tabindex="-1"></a>mb <span class="sc">%&gt;%</span></span>
<span id="cb93-751"><a href="#cb93-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb93-752"><a href="#cb93-752" aria-hidden="true" tabindex="-1"></a>  .[, expr <span class="sc">:</span><span class="er">=</span> <span class="fu">gsub</span>(<span class="st">"p_"</span>, <span class="st">""</span>, expr)] <span class="sc">%&gt;%</span></span>
<span id="cb93-753"><a href="#cb93-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(.) <span class="sc">+</span></span>
<span id="cb93-754"><a href="#cb93-754" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> time <span class="sc">/</span> <span class="fl">1e9</span>, <span class="at">x =</span> expr)) <span class="sc">+</span></span>
<span id="cb93-755"><a href="#cb93-755" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb93-756"><a href="#cb93-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"seconds"</span>) <span class="sc">+</span></span>
<span id="cb93-757"><a href="#cb93-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"number of polygons to process"</span>)</span>
<span id="cb93-758"><a href="#cb93-758" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-759"><a href="#cb93-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-760"><a href="#cb93-760" aria-hidden="true" tabindex="-1"></a><span class="in">```{r overhead, echo = F, cache = TRUE}</span></span>
<span id="cb93-761"><a href="#cb93-761" aria-hidden="true" tabindex="-1"></a><span class="in">mb_dt &lt;- data.table(mb)</span></span>
<span id="cb93-762"><a href="#cb93-762" aria-hidden="true" tabindex="-1"></a><span class="in">overhead &lt;- ((mb_dt[expr == "p_1", mean(time)] - (mb_dt[expr == "p_2", mean(time)] - mb_dt[expr == "p_1", mean(time)])) / 1e9) %&gt;% round(digits = 2)</span></span>
<span id="cb93-763"><a href="#cb93-763" aria-hidden="true" tabindex="-1"></a><span class="in">num_polygons_per_core &lt;- floor(nrow(IA_grids) / num_cores)</span></span>
<span id="cb93-764"><a href="#cb93-764" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-765"><a href="#cb93-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-766"><a href="#cb93-766" aria-hidden="true" tabindex="-1"></a>As you can see, there is a significant overhead (about <span class="in">`r overhead`</span> seconds) regardless of the number of polygons being processed for data extraction. Once the process is initiated and ready to begin extracting values for the polygons, the additional time required to process extra units is minimal. This serves as a prime example of how not to parallelize a task. Since each core processes approximately <span class="in">`r num_polygons_per_core`</span> polygons, simple math suggests that you would spend at least <span class="in">`r round(overhead * num_polygons_per_core, digits = 2)`</span> seconds (calculated as <span class="in">`r overhead`</span> $\times$ <span class="in">`r num_polygons_per_core`</span>) just in preparing the extraction jobs.</span>
<span id="cb93-767"><a href="#cb93-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-768"><a href="#cb93-768" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb93-769"><a href="#cb93-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-770"><a href="#cb93-770" aria-hidden="true" tabindex="-1"></a>We can minimize this overhead as much as possible by having each core use <span class="in">`exactextract::exact_extract()`</span> only once in which multiple polygons are processed in the single call. Specifically, we will split the collection of the polygons into <span class="in">`r num_cores`</span> groups and have each core extract for one group. </span>
<span id="cb93-771"><a href="#cb93-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-772"><a href="#cb93-772" aria-hidden="true" tabindex="-1"></a><span class="in">```{r group_par_code_disp, eval = F}</span></span>
<span id="cb93-773"><a href="#cb93-773" aria-hidden="true" tabindex="-1"></a><span class="in">#--- number of polygons in a group ---#</span></span>
<span id="cb93-774"><a href="#cb93-774" aria-hidden="true" tabindex="-1"></a><span class="in">num_in_group &lt;- floor(nrow(IA_grids) / num_cores)</span></span>
<span id="cb93-775"><a href="#cb93-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-776"><a href="#cb93-776" aria-hidden="true" tabindex="-1"></a><span class="in">#--- assign group id to polygons ---#</span></span>
<span id="cb93-777"><a href="#cb93-777" aria-hidden="true" tabindex="-1"></a><span class="in">IA_grids &lt;- </span></span>
<span id="cb93-778"><a href="#cb93-778" aria-hidden="true" tabindex="-1"></a><span class="in">  IA_grids %&gt;%</span></span>
<span id="cb93-779"><a href="#cb93-779" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(</span></span>
<span id="cb93-780"><a href="#cb93-780" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- create grid id ---#</span></span>
<span id="cb93-781"><a href="#cb93-781" aria-hidden="true" tabindex="-1"></a><span class="in">    grid_id = 1:nrow(.),</span></span>
<span id="cb93-782"><a href="#cb93-782" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- assign group id  ---#</span></span>
<span id="cb93-783"><a href="#cb93-783" aria-hidden="true" tabindex="-1"></a><span class="in">    group_id = grid_id %/% num_in_group + 1</span></span>
<span id="cb93-784"><a href="#cb93-784" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-785"><a href="#cb93-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-786"><a href="#cb93-786" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-787"><a href="#cb93-787" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallelized processing by group ---#</span></span>
<span id="cb93-788"><a href="#cb93-788" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- </span></span>
<span id="cb93-789"><a href="#cb93-789" aria-hidden="true" tabindex="-1"></a><span class="in">  parallel::mclapply(</span></span>
<span id="cb93-790"><a href="#cb93-790" aria-hidden="true" tabindex="-1"></a><span class="in">    1:num_cores,</span></span>
<span id="cb93-791"><a href="#cb93-791" aria-hidden="true" tabindex="-1"></a><span class="in">    \(x) {</span></span>
<span id="cb93-792"><a href="#cb93-792" aria-hidden="true" tabindex="-1"></a><span class="in">      exactextractr::exact_extract(IA_cdl_15, dplyr::filter(IA_grids, group_id == x)) %&gt;%</span></span>
<span id="cb93-793"><a href="#cb93-793" aria-hidden="true" tabindex="-1"></a><span class="in">      data.table::rbindlist()</span></span>
<span id="cb93-794"><a href="#cb93-794" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-795"><a href="#cb93-795" aria-hidden="true" tabindex="-1"></a><span class="in">    mc.cores = num_cores</span></span>
<span id="cb93-796"><a href="#cb93-796" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-797"><a href="#cb93-797" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-798"><a href="#cb93-798" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-799"><a href="#cb93-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-800"><a href="#cb93-800" aria-hidden="true" tabindex="-1"></a><span class="in">```{r group_par_run, echo = F, eval = F}</span></span>
<span id="cb93-801"><a href="#cb93-801" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-802"><a href="#cb93-802" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-803"><a href="#cb93-803" aria-hidden="true" tabindex="-1"></a><span class="in">#--- number of polygons in a group ---#</span></span>
<span id="cb93-804"><a href="#cb93-804" aria-hidden="true" tabindex="-1"></a><span class="in">num_in_group &lt;- floor(nrow(IA_grids) / num_cores)</span></span>
<span id="cb93-805"><a href="#cb93-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-806"><a href="#cb93-806" aria-hidden="true" tabindex="-1"></a><span class="in">#--- define group id ---#</span></span>
<span id="cb93-807"><a href="#cb93-807" aria-hidden="true" tabindex="-1"></a><span class="in">IA_grids &lt;- IA_grids %&gt;%</span></span>
<span id="cb93-808"><a href="#cb93-808" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb93-809"><a href="#cb93-809" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- create grid id ---#</span></span>
<span id="cb93-810"><a href="#cb93-810" aria-hidden="true" tabindex="-1"></a><span class="in">    grid_id = 1:nrow(.),</span></span>
<span id="cb93-811"><a href="#cb93-811" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- assign group id  ---#</span></span>
<span id="cb93-812"><a href="#cb93-812" aria-hidden="true" tabindex="-1"></a><span class="in">    group_id = grid_id %/% num_in_group + 1</span></span>
<span id="cb93-813"><a href="#cb93-813" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-814"><a href="#cb93-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-815"><a href="#cb93-815" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallelized processing by group ---#</span></span>
<span id="cb93-816"><a href="#cb93-816" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- </span></span>
<span id="cb93-817"><a href="#cb93-817" aria-hidden="true" tabindex="-1"></a><span class="in">  parallel::mclapply(</span></span>
<span id="cb93-818"><a href="#cb93-818" aria-hidden="true" tabindex="-1"></a><span class="in">    1:num_cores,</span></span>
<span id="cb93-819"><a href="#cb93-819" aria-hidden="true" tabindex="-1"></a><span class="in">    \(x) {</span></span>
<span id="cb93-820"><a href="#cb93-820" aria-hidden="true" tabindex="-1"></a><span class="in">      exactextractr::exact_extract(IA_cdl_15, dplyr::filter(IA_grids, group_id == x)) %&gt;%</span></span>
<span id="cb93-821"><a href="#cb93-821" aria-hidden="true" tabindex="-1"></a><span class="in">      data.table::rbindlist()</span></span>
<span id="cb93-822"><a href="#cb93-822" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-823"><a href="#cb93-823" aria-hidden="true" tabindex="-1"></a><span class="in">    mc.cores = num_cores</span></span>
<span id="cb93-824"><a href="#cb93-824" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-825"><a href="#cb93-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-826"><a href="#cb93-826" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-827"><a href="#cb93-827" aria-hidden="true" tabindex="-1"></a><span class="in">log_group_par_run &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-828"><a href="#cb93-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-829"><a href="#cb93-829" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_group_par_run, "Data/log_group_par_run.rds")</span></span>
<span id="cb93-830"><a href="#cb93-830" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-831"><a href="#cb93-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-832"><a href="#cb93-832" aria-hidden="true" tabindex="-1"></a><span class="in">```{r group_par_show, echo = F, cache = TRUE}</span></span>
<span id="cb93-833"><a href="#cb93-833" aria-hidden="true" tabindex="-1"></a><span class="in">log_group_par_run &lt;- readRDS("Data/log_group_par_run.rds")</span></span>
<span id="cb93-834"><a href="#cb93-834" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_gropu_par &lt;- log_group_par_run[[1]]$toc - log_group_par_run[[1]]$tic</span></span>
<span id="cb93-835"><a href="#cb93-835" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_gropu_par</span></span>
<span id="cb93-836"><a href="#cb93-836" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-837"><a href="#cb93-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-838"><a href="#cb93-838" aria-hidden="true" tabindex="-1"></a>Okay, this is much better.</span>
<span id="cb93-839"><a href="#cb93-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-840"><a href="#cb93-840" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb93-841"><a href="#cb93-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-842"><a href="#cb93-842" aria-hidden="true" tabindex="-1"></a>Now, we can further reduce the processing time by reducing the size of the object that is returned from each core to be collated into one. In the code above, each core returns a list of <span class="in">`data.frame`</span>s where each grid of the same group has multiple values from the intersecting raster cells.</span>
<span id="cb93-843"><a href="#cb93-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-844"><a href="#cb93-844" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include = F, cache = TRUE}</span></span>
<span id="cb93-845"><a href="#cb93-845" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;-</span></span>
<span id="cb93-846"><a href="#cb93-846" aria-hidden="true" tabindex="-1"></a><span class="in">  parallel::mclapply(</span></span>
<span id="cb93-847"><a href="#cb93-847" aria-hidden="true" tabindex="-1"></a><span class="in">    1:num_cores,</span></span>
<span id="cb93-848"><a href="#cb93-848" aria-hidden="true" tabindex="-1"></a><span class="in">    \(x) {</span></span>
<span id="cb93-849"><a href="#cb93-849" aria-hidden="true" tabindex="-1"></a><span class="in">      exactextractr::exact_extract(</span></span>
<span id="cb93-850"><a href="#cb93-850" aria-hidden="true" tabindex="-1"></a><span class="in">        IA_cdl_15, </span></span>
<span id="cb93-851"><a href="#cb93-851" aria-hidden="true" tabindex="-1"></a><span class="in">        dplyr::filter(IA_grids, group_id == x)</span></span>
<span id="cb93-852"><a href="#cb93-852" aria-hidden="true" tabindex="-1"></a><span class="in">      ) %&gt;%</span></span>
<span id="cb93-853"><a href="#cb93-853" aria-hidden="true" tabindex="-1"></a><span class="in">      data.table::rbindlist()</span></span>
<span id="cb93-854"><a href="#cb93-854" aria-hidden="true" tabindex="-1"></a><span class="in">    },</span></span>
<span id="cb93-855"><a href="#cb93-855" aria-hidden="true" tabindex="-1"></a><span class="in">    mc.cores = num_cores</span></span>
<span id="cb93-856"><a href="#cb93-856" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-857"><a href="#cb93-857" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-858"><a href="#cb93-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-859"><a href="#cb93-859" aria-hidden="true" tabindex="-1"></a><span class="in">```{r size_list, cache = TRUE}</span></span>
<span id="cb93-860"><a href="#cb93-860" aria-hidden="true" tabindex="-1"></a><span class="in">#--- the size of the list of data returned by the first core ---#</span></span>
<span id="cb93-861"><a href="#cb93-861" aria-hidden="true" tabindex="-1"></a><span class="in">object.size(temp[[1]]) %&gt;% format(units = "GB")</span></span>
<span id="cb93-862"><a href="#cb93-862" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-863"><a href="#cb93-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-864"><a href="#cb93-864" aria-hidden="true" tabindex="-1"></a>In total, about 2.3GB of data has to be collated into one list from <span class="in">`r num_cores`</span> cores. It turns out, this process is costly. To see this, take a look at the following example where the same <span class="in">`exactextractr::exact_extrct()`</span> processes are run, yet nothing is returned by each core.</span>
<span id="cb93-865"><a href="#cb93-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-866"><a href="#cb93-866" aria-hidden="true" tabindex="-1"></a><span class="in">```{r nothing_returned, eval = F}</span></span>
<span id="cb93-867"><a href="#cb93-867" aria-hidden="true" tabindex="-1"></a><span class="in">#--- define the function to extract values by block of polygons ---#</span></span>
<span id="cb93-868"><a href="#cb93-868" aria-hidden="true" tabindex="-1"></a><span class="in">extract_by_group &lt;- function(i) {</span></span>
<span id="cb93-869"><a href="#cb93-869" aria-hidden="true" tabindex="-1"></a><span class="in">  temp &lt;- </span></span>
<span id="cb93-870"><a href="#cb93-870" aria-hidden="true" tabindex="-1"></a><span class="in">    exactextractr::exact_extract(IA_cdl_15, filter(IA_grids, group_id == i)) %&gt;%</span></span>
<span id="cb93-871"><a href="#cb93-871" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::rbindlist()</span></span>
<span id="cb93-872"><a href="#cb93-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-873"><a href="#cb93-873" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- returns nothing! ---#</span></span>
<span id="cb93-874"><a href="#cb93-874" aria-hidden="true" tabindex="-1"></a><span class="in">  return(NULL)</span></span>
<span id="cb93-875"><a href="#cb93-875" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb93-876"><a href="#cb93-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-877"><a href="#cb93-877" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallelized processing by group ---#</span></span>
<span id="cb93-878"><a href="#cb93-878" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-879"><a href="#cb93-879" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- parallel::mclapply(</span></span>
<span id="cb93-880"><a href="#cb93-880" aria-hidden="true" tabindex="-1"></a><span class="in">  1:num_cores,</span></span>
<span id="cb93-881"><a href="#cb93-881" aria-hidden="true" tabindex="-1"></a><span class="in">  function(i) extract_by_group(i),</span></span>
<span id="cb93-882"><a href="#cb93-882" aria-hidden="true" tabindex="-1"></a><span class="in">  mc.cores = num_cores</span></span>
<span id="cb93-883"><a href="#cb93-883" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-884"><a href="#cb93-884" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-885"><a href="#cb93-885" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-886"><a href="#cb93-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-887"><a href="#cb93-887" aria-hidden="true" tabindex="-1"></a><span class="in">```{r nothing_returned_run, echo = F, eval = F}</span></span>
<span id="cb93-888"><a href="#cb93-888" aria-hidden="true" tabindex="-1"></a><span class="in">#--- define function ---#</span></span>
<span id="cb93-889"><a href="#cb93-889" aria-hidden="true" tabindex="-1"></a><span class="in">extract_by_group &lt;- function(i) {</span></span>
<span id="cb93-890"><a href="#cb93-890" aria-hidden="true" tabindex="-1"></a><span class="in">  temp &lt;-</span></span>
<span id="cb93-891"><a href="#cb93-891" aria-hidden="true" tabindex="-1"></a><span class="in">    exactextractr::exact_extract(IA_cdl_15, filter(IA_grids, group_id == i)) %&gt;%</span></span>
<span id="cb93-892"><a href="#cb93-892" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::rbindlist()</span></span>
<span id="cb93-893"><a href="#cb93-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-894"><a href="#cb93-894" aria-hidden="true" tabindex="-1"></a><span class="in">  return(NULL)</span></span>
<span id="cb93-895"><a href="#cb93-895" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb93-896"><a href="#cb93-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-897"><a href="#cb93-897" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-898"><a href="#cb93-898" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-899"><a href="#cb93-899" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallelized processing by group ---#</span></span>
<span id="cb93-900"><a href="#cb93-900" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- parallel::mclapply(</span></span>
<span id="cb93-901"><a href="#cb93-901" aria-hidden="true" tabindex="-1"></a><span class="in">  1:num_cores,</span></span>
<span id="cb93-902"><a href="#cb93-902" aria-hidden="true" tabindex="-1"></a><span class="in">  function(i) extract_by_group(i),</span></span>
<span id="cb93-903"><a href="#cb93-903" aria-hidden="true" tabindex="-1"></a><span class="in">  mc.cores = num_cores</span></span>
<span id="cb93-904"><a href="#cb93-904" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-905"><a href="#cb93-905" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-906"><a href="#cb93-906" aria-hidden="true" tabindex="-1"></a><span class="in">log_no_return &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-907"><a href="#cb93-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-908"><a href="#cb93-908" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_no_return, "Data/log_no_return.rds")</span></span>
<span id="cb93-909"><a href="#cb93-909" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-910"><a href="#cb93-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-911"><a href="#cb93-911" aria-hidden="true" tabindex="-1"></a><span class="in">```{r nothing_returned_show, echo = F, cache = TRUE}</span></span>
<span id="cb93-912"><a href="#cb93-912" aria-hidden="true" tabindex="-1"></a><span class="in">log_no_return &lt;- readRDS("Data/log_no_return.rds")</span></span>
<span id="cb93-913"><a href="#cb93-913" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_group_none &lt;- log_no_return[[1]]$toc - log_no_return[[1]]$tic</span></span>
<span id="cb93-914"><a href="#cb93-914" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_group_none</span></span>
<span id="cb93-915"><a href="#cb93-915" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-916"><a href="#cb93-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-917"><a href="#cb93-917" aria-hidden="true" tabindex="-1"></a>Approximately <span class="in">`r time_elapsed_gropu_par - time_elapsed_group_none`</span> seconds were used just to collect the 2.3GB worth of data from the cores into one.</span>
<span id="cb93-918"><a href="#cb93-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-919"><a href="#cb93-919" aria-hidden="true" tabindex="-1"></a>In most cases, we do not have to carry around all the individual cell values of land use types for our subsequent analysis. For example, in Demonstration 3 (@sec-demo3) we just need a summary (count) of each unique land use type by polygon. So, let's get the summary before we have the computer collect the objects returned from each core as follows: </span>
<span id="cb93-920"><a href="#cb93-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-921"><a href="#cb93-921" aria-hidden="true" tabindex="-1"></a><span class="in">```{r return_reduced_group, eval = F}</span></span>
<span id="cb93-922"><a href="#cb93-922" aria-hidden="true" tabindex="-1"></a><span class="in">extract_by_group_reduced &lt;- function(i) {</span></span>
<span id="cb93-923"><a href="#cb93-923" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_return &lt;- </span></span>
<span id="cb93-924"><a href="#cb93-924" aria-hidden="true" tabindex="-1"></a><span class="in">    exactextractr::exact_extract(</span></span>
<span id="cb93-925"><a href="#cb93-925" aria-hidden="true" tabindex="-1"></a><span class="in">      IA_cdl_15,</span></span>
<span id="cb93-926"><a href="#cb93-926" aria-hidden="true" tabindex="-1"></a><span class="in">      filter(IA_grids, group_id == i)</span></span>
<span id="cb93-927"><a href="#cb93-927" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;%</span></span>
<span id="cb93-928"><a href="#cb93-928" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- combine the list of data.frames into one with polygon id ---#</span></span>
<span id="cb93-929"><a href="#cb93-929" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::rbindlist(idcol = "id_within_group") %&gt;%</span></span>
<span id="cb93-930"><a href="#cb93-930" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- find the count of land use type values by polygon ---#</span></span>
<span id="cb93-931"><a href="#cb93-931" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, .(num_value = .N), by = .(value, id_within_group)]</span></span>
<span id="cb93-932"><a href="#cb93-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-933"><a href="#cb93-933" aria-hidden="true" tabindex="-1"></a><span class="in">  return(temp_return)</span></span>
<span id="cb93-934"><a href="#cb93-934" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb93-935"><a href="#cb93-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-936"><a href="#cb93-936" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-937"><a href="#cb93-937" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallelized processing by group ---#</span></span>
<span id="cb93-938"><a href="#cb93-938" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- parallel::mclapply(</span></span>
<span id="cb93-939"><a href="#cb93-939" aria-hidden="true" tabindex="-1"></a><span class="in">  1:num_cores,</span></span>
<span id="cb93-940"><a href="#cb93-940" aria-hidden="true" tabindex="-1"></a><span class="in">  function(i) extract_by_group_reduced(i),</span></span>
<span id="cb93-941"><a href="#cb93-941" aria-hidden="true" tabindex="-1"></a><span class="in">  mc.cores = num_cores</span></span>
<span id="cb93-942"><a href="#cb93-942" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-943"><a href="#cb93-943" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-944"><a href="#cb93-944" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-945"><a href="#cb93-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-946"><a href="#cb93-946" aria-hidden="true" tabindex="-1"></a><span class="in">```{r return_reduced_group_run, echo = F, eval = F}</span></span>
<span id="cb93-947"><a href="#cb93-947" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-948"><a href="#cb93-948" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-949"><a href="#cb93-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-950"><a href="#cb93-950" aria-hidden="true" tabindex="-1"></a><span class="in">extract_by_group_reduced &lt;- function(i) {</span></span>
<span id="cb93-951"><a href="#cb93-951" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_return &lt;- </span></span>
<span id="cb93-952"><a href="#cb93-952" aria-hidden="true" tabindex="-1"></a><span class="in">    exactextractr::exact_extract(</span></span>
<span id="cb93-953"><a href="#cb93-953" aria-hidden="true" tabindex="-1"></a><span class="in">      IA_cdl_15,</span></span>
<span id="cb93-954"><a href="#cb93-954" aria-hidden="true" tabindex="-1"></a><span class="in">      dplyr::filter(IA_grids, group_id == i)</span></span>
<span id="cb93-955"><a href="#cb93-955" aria-hidden="true" tabindex="-1"></a><span class="in">    ) %&gt;%</span></span>
<span id="cb93-956"><a href="#cb93-956" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- combine the list of data.frames into one with polygon id ---#</span></span>
<span id="cb93-957"><a href="#cb93-957" aria-hidden="true" tabindex="-1"></a><span class="in">    rbindlist(idcol = "id_within_group") %&gt;%</span></span>
<span id="cb93-958"><a href="#cb93-958" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- find the count of land use type values by polygon ---#</span></span>
<span id="cb93-959"><a href="#cb93-959" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, .(num_value = .N), by = .(value, id_within_group)]</span></span>
<span id="cb93-960"><a href="#cb93-960" aria-hidden="true" tabindex="-1"></a><span class="in">  return(temp_return)</span></span>
<span id="cb93-961"><a href="#cb93-961" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb93-962"><a href="#cb93-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-963"><a href="#cb93-963" aria-hidden="true" tabindex="-1"></a><span class="in">#--- parallelized processing by group ---#</span></span>
<span id="cb93-964"><a href="#cb93-964" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- parallel::mclapply(</span></span>
<span id="cb93-965"><a href="#cb93-965" aria-hidden="true" tabindex="-1"></a><span class="in">  1:num_cores,</span></span>
<span id="cb93-966"><a href="#cb93-966" aria-hidden="true" tabindex="-1"></a><span class="in">  function(i) extract_by_group_reduced(i),</span></span>
<span id="cb93-967"><a href="#cb93-967" aria-hidden="true" tabindex="-1"></a><span class="in">  mc.cores = num_cores</span></span>
<span id="cb93-968"><a href="#cb93-968" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-969"><a href="#cb93-969" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-970"><a href="#cb93-970" aria-hidden="true" tabindex="-1"></a><span class="in">log_reduced &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-971"><a href="#cb93-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-972"><a href="#cb93-972" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_reduced, "Data/log_reduced.rds")</span></span>
<span id="cb93-973"><a href="#cb93-973" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-974"><a href="#cb93-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-975"><a href="#cb93-975" aria-hidden="true" tabindex="-1"></a><span class="in">```{r return_reduced_group_show, echo = F, cache = TRUE}</span></span>
<span id="cb93-976"><a href="#cb93-976" aria-hidden="true" tabindex="-1"></a><span class="in">log_reduced &lt;- readRDS("Data/log_reduced.rds")</span></span>
<span id="cb93-977"><a href="#cb93-977" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_group_reduced &lt;- log_reduced[[1]]$toc - log_reduced[[1]]$tic</span></span>
<span id="cb93-978"><a href="#cb93-978" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_group_reduced</span></span>
<span id="cb93-979"><a href="#cb93-979" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-980"><a href="#cb93-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-981"><a href="#cb93-981" aria-hidden="true" tabindex="-1"></a>It is of course slower than the one that returns nothing, but it is faster than the one that does not reduce the size before the outcome collation.</span>
<span id="cb93-982"><a href="#cb93-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-983"><a href="#cb93-983" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb93-984"><a href="#cb93-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-985"><a href="#cb93-985" aria-hidden="true" tabindex="-1"></a>As you can see, the computation time of the fastest approach is now significantly reduced, but you only saved <span class="in">`r round(time_elapsed_nonpar - time_elapsed_group_reduced, digits = 2)`</span> seconds. How much time did I spend writing the code to implement the parallelized group processing? About three minutes. What truly matters is the total time you spend (coding time plus processing time) to get the desired outcome. The maximum time you could save with clever coding is <span class="in">`r round(time_elapsed_nonpar, digits = 2)`</span> seconds. If writing code to make it faster takes more time than that, it’s simply not worth the effort. So, don't try to optimize your code if the processing time is already short. Before you dive into parallelization, think through the coding steps in your head and assess whether it's really worth the time investment.</span>
<span id="cb93-986"><a href="#cb93-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-987"><a href="#cb93-987" aria-hidden="true" tabindex="-1"></a>However, imagine processing CDL data for all U.S. states from 2009 to 2020. The entire process would take approximately <span class="in">`r round(51*12*time_elapsed_nonpar/60/60, digits = 2)`</span> hours (calculated as $51 \times 12 \times <span class="in">`r time_elapsed_nonpar`</span>/60/60$). A rough estimate suggests that with parallelization, using the best approach we discussed, the process could be completed in about <span class="in">`r round(51*12*time_elapsed_group_reduced/60/60, digits = 2)`</span> hours. While <span class="in">`r round(51*12*time_elapsed_nonpar/60/60, digits = 2)`</span> hours is still manageable (you could start the process before bed and have the results ready by the next afternoon), it becomes worthwhile to parallelize the process, especially considering the time savings from parallelization, even after accounting for the time spent coding it.</span>
<span id="cb93-988"><a href="#cb93-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-989"><a href="#cb93-989" aria-hidden="true" tabindex="-1"></a>:::{.callout-note title="Summary"}</span>
<span id="cb93-990"><a href="#cb93-990" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Do not let each core runs small tasks over and over again (e.g., extracting raster values for one polygon at a time), or you will suffer from significant overhead.</span>
<span id="cb93-991"><a href="#cb93-991" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Blocking is one way to avoid the problem above.</span>
<span id="cb93-992"><a href="#cb93-992" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Reduce the size of the outcome of each core as much as possible to spend less time to simply collating them into one.</span>
<span id="cb93-993"><a href="#cb93-993" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Do not forget about the time you would spend on coding parallelized processes.</span>
<span id="cb93-994"><a href="#cb93-994" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>If you are extracting from a single layer, it is likely that you should not parallelize.</span>
<span id="cb93-995"><a href="#cb93-995" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb93-996"><a href="#cb93-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-997"><a href="#cb93-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-998"><a href="#cb93-998" aria-hidden="true" tabindex="-1"></a><span class="fu">## Many multi-layer raster files {#sec-many-multi-layer}</span></span>
<span id="cb93-999"><a href="#cb93-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1000"><a href="#cb93-1000" aria-hidden="true" tabindex="-1"></a>In this section, we discuss various methods to parallelize the process of extracting values from many multi-layer raster files.</span>
<span id="cb93-1001"><a href="#cb93-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1002"><a href="#cb93-1002" aria-hidden="true" tabindex="-1"></a><span class="fu">### Datasets</span></span>
<span id="cb93-1003"><a href="#cb93-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1004"><a href="#cb93-1004" aria-hidden="true" tabindex="-1"></a>We will use the following datasets:</span>
<span id="cb93-1005"><a href="#cb93-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1006"><a href="#cb93-1006" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**raster**: daily PRISM data 2010 through 2019 stacked by month</span>
<span id="cb93-1007"><a href="#cb93-1007" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**polygons**: US County polygons </span>
<span id="cb93-1008"><a href="#cb93-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1009"><a href="#cb93-1009" aria-hidden="true" tabindex="-1"></a>**daily PRISM precipitation 2010 through 2019**</span>
<span id="cb93-1010"><a href="#cb93-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1011"><a href="#cb93-1011" aria-hidden="true" tabindex="-1"></a>You can download all the prism files from <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.dropbox.com/sh/gkprbgp8sg5362f/AABLLEUjsGkelCK2aUxaUI72a?dl=0)</span>. For those who are interested in learning how to generate the series of daily PRISM data files stored by month, see @sec-download-prism for the code.</span>
<span id="cb93-1012"><a href="#cb93-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1013"><a href="#cb93-1013" aria-hidden="true" tabindex="-1"></a>Let's retrieve the U.S. counties data (see @fig-us-counties for the map).</span>
<span id="cb93-1014"><a href="#cb93-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1015"><a href="#cb93-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```{r US_county, cache = TRUE}</span></span>
<span id="cb93-1016"><a href="#cb93-1016" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-1017"><a href="#cb93-1017" aria-hidden="true" tabindex="-1"></a><span class="in">  US_county &lt;-</span></span>
<span id="cb93-1018"><a href="#cb93-1018" aria-hidden="true" tabindex="-1"></a><span class="in">    tigris::counties(cb = TRUE, progress_bar = FALSE) %&gt;%</span></span>
<span id="cb93-1019"><a href="#cb93-1019" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- only keep geometry ---#</span></span>
<span id="cb93-1020"><a href="#cb93-1020" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::select(geometry) %&gt;%</span></span>
<span id="cb93-1021"><a href="#cb93-1021" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- project to the CRS of the CDL data ---#</span></span>
<span id="cb93-1022"><a href="#cb93-1022" aria-hidden="true" tabindex="-1"></a><span class="in">    sf::st_transform(terra::crs(terra::rast("Data/PRISM_ppt_y2009_m1.tif")))</span></span>
<span id="cb93-1023"><a href="#cb93-1023" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-1024"><a href="#cb93-1024" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1025"><a href="#cb93-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1026"><a href="#cb93-1026" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb93-1029"><a href="#cb93-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb93-1030"><a href="#cb93-1030" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-us-counties </span></span>
<span id="cb93-1031"><a href="#cb93-1031" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "U.S. counties"</span></span>
<span id="cb93-1032"><a href="#cb93-1032" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb93-1033"><a href="#cb93-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1034"><a href="#cb93-1034" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(US_county) <span class="sc">+</span></span>
<span id="cb93-1035"><a href="#cb93-1035" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb93-1036"><a href="#cb93-1036" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb93-1037"><a href="#cb93-1037" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1038"><a href="#cb93-1038" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb93-1039"><a href="#cb93-1039" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--end of column-margin--&gt;</span></span>
<span id="cb93-1040"><a href="#cb93-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1041"><a href="#cb93-1041" aria-hidden="true" tabindex="-1"></a><span class="fu">### Non-parallelized extraction {#sec-non-par-ext-multi}</span></span>
<span id="cb93-1042"><a href="#cb93-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1043"><a href="#cb93-1043" aria-hidden="true" tabindex="-1"></a>As we learned in @sec-extract-speed, extracting values from stacked raster layers (multi-layer <span class="in">`SpatRaster`</span>) is faster than extracting from multiple single-layer raster datasets one at a time. In this case, daily precipitation datasets are stacked by year and month and saved as multi-layer GeoTIFF files. For example, **PRISM_ppt_y2009_m1.tif** contains the daily precipitation data for January 2009. Below is an example of how long it takes to extract values for U.S. counties from a month of daily PRISM precipitation data.</span>
<span id="cb93-1044"><a href="#cb93-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1045"><a href="#cb93-1045" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prism_import_one_month_disp, eval = F}</span></span>
<span id="cb93-1046"><a href="#cb93-1046" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-1047"><a href="#cb93-1047" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- </span></span>
<span id="cb93-1048"><a href="#cb93-1048" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb93-1049"><a href="#cb93-1049" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::rast("Data/PRISM_ppt_y2009_m1.tif"),</span></span>
<span id="cb93-1050"><a href="#cb93-1050" aria-hidden="true" tabindex="-1"></a><span class="in">    US_county,</span></span>
<span id="cb93-1051"><a href="#cb93-1051" aria-hidden="true" tabindex="-1"></a><span class="in">    "mean",</span></span>
<span id="cb93-1052"><a href="#cb93-1052" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = F</span></span>
<span id="cb93-1053"><a href="#cb93-1053" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-1054"><a href="#cb93-1054" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-1055"><a href="#cb93-1055" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1056"><a href="#cb93-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1057"><a href="#cb93-1057" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prism_import_one_month_run, echo = F, eval = F}</span></span>
<span id="cb93-1058"><a href="#cb93-1058" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-1059"><a href="#cb93-1059" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-1060"><a href="#cb93-1060" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- </span></span>
<span id="cb93-1061"><a href="#cb93-1061" aria-hidden="true" tabindex="-1"></a><span class="in">  exactextractr::exact_extract(</span></span>
<span id="cb93-1062"><a href="#cb93-1062" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::rast("Data/PRISM_ppt_y2009_m1.tif"),</span></span>
<span id="cb93-1063"><a href="#cb93-1063" aria-hidden="true" tabindex="-1"></a><span class="in">    US_county,</span></span>
<span id="cb93-1064"><a href="#cb93-1064" aria-hidden="true" tabindex="-1"></a><span class="in">    progress = F</span></span>
<span id="cb93-1065"><a href="#cb93-1065" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-1066"><a href="#cb93-1066" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-1067"><a href="#cb93-1067" aria-hidden="true" tabindex="-1"></a><span class="in">log_prism_import_one_month_run &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-1068"><a href="#cb93-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1069"><a href="#cb93-1069" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_prism_import_one_month_run, "Data/log_prism_import_one_month_run.rds")</span></span>
<span id="cb93-1070"><a href="#cb93-1070" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1071"><a href="#cb93-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1072"><a href="#cb93-1072" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prism_import_one_month_show, echo = F, cache = TRUE}</span></span>
<span id="cb93-1073"><a href="#cb93-1073" aria-hidden="true" tabindex="-1"></a><span class="in">log_prism_import_one_month_run &lt;- readRDS("Data/log_prism_import_one_month_run.rds")</span></span>
<span id="cb93-1074"><a href="#cb93-1074" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_prism_import_one_month &lt;- log_prism_import_one_month_run[[1]]$toc - log_prism_import_one_month_run[[1]]$tic</span></span>
<span id="cb93-1075"><a href="#cb93-1075" aria-hidden="true" tabindex="-1"></a><span class="in">time_elapsed_prism_import_one_month</span></span>
<span id="cb93-1076"><a href="#cb93-1076" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1077"><a href="#cb93-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1078"><a href="#cb93-1078" aria-hidden="true" tabindex="-1"></a>Now, to process all the precipitation data from 2009-2018, we consider two approaches in this section are:</span>
<span id="cb93-1079"><a href="#cb93-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1080"><a href="#cb93-1080" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>parallelize over polygons (blocked) and do regular loop over year-month</span>
<span id="cb93-1081"><a href="#cb93-1081" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>parallelize over year-month</span>
<span id="cb93-1082"><a href="#cb93-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1083"><a href="#cb93-1083" aria-hidden="true" tabindex="-1"></a><span class="fu">### Approach 1: parallelize over polygons and do regular loop over year-month</span></span>
<span id="cb93-1084"><a href="#cb93-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1085"><a href="#cb93-1085" aria-hidden="true" tabindex="-1"></a>For this approach, let's measure the time spent on processing one year-month PRISM dataset and then guess how long it would take to process 120 year-month PRISM datasets.</span>
<span id="cb93-1086"><a href="#cb93-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1087"><a href="#cb93-1087" aria-hidden="true" tabindex="-1"></a><span class="in">```{r by_state_block, eval = F}</span></span>
<span id="cb93-1088"><a href="#cb93-1088" aria-hidden="true" tabindex="-1"></a><span class="in">#--- number of polygons in a group ---#</span></span>
<span id="cb93-1089"><a href="#cb93-1089" aria-hidden="true" tabindex="-1"></a><span class="in">num_in_group &lt;- floor(nrow(US_county) / num_cores)</span></span>
<span id="cb93-1090"><a href="#cb93-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1091"><a href="#cb93-1091" aria-hidden="true" tabindex="-1"></a><span class="in">#--- define group id ---#</span></span>
<span id="cb93-1092"><a href="#cb93-1092" aria-hidden="true" tabindex="-1"></a><span class="in">US_county &lt;- US_county %&gt;%</span></span>
<span id="cb93-1093"><a href="#cb93-1093" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb93-1094"><a href="#cb93-1094" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- create grid id ---#</span></span>
<span id="cb93-1095"><a href="#cb93-1095" aria-hidden="true" tabindex="-1"></a><span class="in">    poly_id = 1:nrow(.),</span></span>
<span id="cb93-1096"><a href="#cb93-1096" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- assign group id  ---#</span></span>
<span id="cb93-1097"><a href="#cb93-1097" aria-hidden="true" tabindex="-1"></a><span class="in">    group_id = poly_id %/% num_in_group + 1</span></span>
<span id="cb93-1098"><a href="#cb93-1098" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-1099"><a href="#cb93-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1100"><a href="#cb93-1100" aria-hidden="true" tabindex="-1"></a><span class="in">extract_by_group &lt;- function(i) {</span></span>
<span id="cb93-1101"><a href="#cb93-1101" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_return &lt;- exactextractr::exact_extract(</span></span>
<span id="cb93-1102"><a href="#cb93-1102" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::rast("Data/PRISM_ppt_y2009_m1.tif"),</span></span>
<span id="cb93-1103"><a href="#cb93-1103" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::filter(US_county, group_id == i)</span></span>
<span id="cb93-1104"><a href="#cb93-1104" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb93-1105"><a href="#cb93-1105" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- combine the list of data.frames into one with polygon id ---#</span></span>
<span id="cb93-1106"><a href="#cb93-1106" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::rbindlist(idcol = "id_within_group") %&gt;%</span></span>
<span id="cb93-1107"><a href="#cb93-1107" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- find the count of land use type values by polygon ---#</span></span>
<span id="cb93-1108"><a href="#cb93-1108" aria-hidden="true" tabindex="-1"></a><span class="in">    data.table::melt(id.var = c("id_within_group", "coverage_fraction")) %&gt;%</span></span>
<span id="cb93-1109"><a href="#cb93-1109" aria-hidden="true" tabindex="-1"></a><span class="in">    .[, sum(value * coverage_fraction) / sum(coverage_fraction), by = .(id_within_group, variable)]</span></span>
<span id="cb93-1110"><a href="#cb93-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1111"><a href="#cb93-1111" aria-hidden="true" tabindex="-1"></a><span class="in">  return(temp_return)</span></span>
<span id="cb93-1112"><a href="#cb93-1112" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb93-1113"><a href="#cb93-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1114"><a href="#cb93-1114" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-1115"><a href="#cb93-1115" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- parallel::mclapply(1:num_cores, extract_by_group, mc.cores = num_cores)</span></span>
<span id="cb93-1116"><a href="#cb93-1116" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-1117"><a href="#cb93-1117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1118"><a href="#cb93-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1119"><a href="#cb93-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r by_state_block_run, echo = F, eval = F}</span></span>
<span id="cb93-1120"><a href="#cb93-1120" aria-hidden="true" tabindex="-1"></a><span class="in">#--- number of polygons in a group ---#</span></span>
<span id="cb93-1121"><a href="#cb93-1121" aria-hidden="true" tabindex="-1"></a><span class="in">num_in_group &lt;- floor(nrow(US_county) / num_cores)</span></span>
<span id="cb93-1122"><a href="#cb93-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1123"><a href="#cb93-1123" aria-hidden="true" tabindex="-1"></a><span class="in">#--- define group id ---#</span></span>
<span id="cb93-1124"><a href="#cb93-1124" aria-hidden="true" tabindex="-1"></a><span class="in">US_county &lt;- US_county %&gt;%</span></span>
<span id="cb93-1125"><a href="#cb93-1125" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb93-1126"><a href="#cb93-1126" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- create grid id ---#</span></span>
<span id="cb93-1127"><a href="#cb93-1127" aria-hidden="true" tabindex="-1"></a><span class="in">    poly_id = 1:nrow(.),</span></span>
<span id="cb93-1128"><a href="#cb93-1128" aria-hidden="true" tabindex="-1"></a><span class="in">    #--- assign group id  ---#</span></span>
<span id="cb93-1129"><a href="#cb93-1129" aria-hidden="true" tabindex="-1"></a><span class="in">    group_id = poly_id %/% num_in_group + 1</span></span>
<span id="cb93-1130"><a href="#cb93-1130" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-1131"><a href="#cb93-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1132"><a href="#cb93-1132" aria-hidden="true" tabindex="-1"></a><span class="in">extract_by_group &lt;- function(i) {</span></span>
<span id="cb93-1133"><a href="#cb93-1133" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_return &lt;- exactextractr::exact_extract(</span></span>
<span id="cb93-1134"><a href="#cb93-1134" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::rast("Data/PRISM_ppt_y2009_m1.tif"),</span></span>
<span id="cb93-1135"><a href="#cb93-1135" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::filter(US_county, group_id == i),</span></span>
<span id="cb93-1136"><a href="#cb93-1136" aria-hidden="true" tabindex="-1"></a><span class="in">    "mean"</span></span>
<span id="cb93-1137"><a href="#cb93-1137" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb93-1138"><a href="#cb93-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1139"><a href="#cb93-1139" aria-hidden="true" tabindex="-1"></a><span class="in">  return(temp_return)</span></span>
<span id="cb93-1140"><a href="#cb93-1140" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb93-1141"><a href="#cb93-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1142"><a href="#cb93-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1143"><a href="#cb93-1143" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-1144"><a href="#cb93-1144" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-1145"><a href="#cb93-1145" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- parallel::mclapply(1:num_cores, extract_by_group, mc.cores = num_cores)</span></span>
<span id="cb93-1146"><a href="#cb93-1146" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-1147"><a href="#cb93-1147" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt_state_block &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-1148"><a href="#cb93-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1149"><a href="#cb93-1149" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_txt_state_block, "Data/Ch6_log_txt_state_block.rds")</span></span>
<span id="cb93-1150"><a href="#cb93-1150" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1151"><a href="#cb93-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1152"><a href="#cb93-1152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r by_state_block_how, echo = F}</span></span>
<span id="cb93-1153"><a href="#cb93-1153" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt_state_block &lt;- readRDS("Data/Ch6_log_txt_state_block.rds")</span></span>
<span id="cb93-1154"><a href="#cb93-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1155"><a href="#cb93-1155" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-1156"><a href="#cb93-1156" aria-hidden="true" tabindex="-1"></a><span class="in">  log_txt_state_block_elapsed &lt;- log_txt_state_block[[1]]$toc - log_txt_state_block[[1]]$tic</span></span>
<span id="cb93-1157"><a href="#cb93-1157" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-1158"><a href="#cb93-1158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1159"><a href="#cb93-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1160"><a href="#cb93-1160" aria-hidden="true" tabindex="-1"></a>Okay, this approach is not bad at all. If we are to process 10 years of daily PRISM data, then it would take roughly <span class="in">`r round(120 * log_txt_state_block_elapsed / 60, digits = 2)`</span> minutes. </span>
<span id="cb93-1161"><a href="#cb93-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1162"><a href="#cb93-1162" aria-hidden="true" tabindex="-1"></a><span class="fu">### Approach 2: parallelize over the temporal dimension (year-month)</span></span>
<span id="cb93-1163"><a href="#cb93-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1164"><a href="#cb93-1164" aria-hidden="true" tabindex="-1"></a>Instead of parallelize over polygons, let's parallelize over time (year-month). To do so, we first create a <span class="in">`data.frame`</span> that has all the year-month combinations we will work on.</span>
<span id="cb93-1165"><a href="#cb93-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1166"><a href="#cb93-1166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r month-year, eval = F}</span></span>
<span id="cb93-1167"><a href="#cb93-1167" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-1168"><a href="#cb93-1168" aria-hidden="true" tabindex="-1"></a><span class="in">  month_year_data &lt;- data.table::CJ(month = 1:12, year = 2009:2018)</span></span>
<span id="cb93-1169"><a href="#cb93-1169" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-1170"><a href="#cb93-1170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1171"><a href="#cb93-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1172"><a href="#cb93-1172" aria-hidden="true" tabindex="-1"></a>The following function extract data from a single year-month case:</span>
<span id="cb93-1173"><a href="#cb93-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1174"><a href="#cb93-1174" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-prism-function-year-month}</span></span>
<span id="cb93-1175"><a href="#cb93-1175" aria-hidden="true" tabindex="-1"></a><span class="in">get_prism_by_month &lt;- function(i, vector) {</span></span>
<span id="cb93-1176"><a href="#cb93-1176" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_month &lt;- month_year_data[i, month] # month to work on</span></span>
<span id="cb93-1177"><a href="#cb93-1177" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_year &lt;- month_year_data[i, year] # year to work on</span></span>
<span id="cb93-1178"><a href="#cb93-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1179"><a href="#cb93-1179" aria-hidden="true" tabindex="-1"></a><span class="in">  #--- import raster data ---#</span></span>
<span id="cb93-1180"><a href="#cb93-1180" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_raster &lt;- terra::rast(paste0("Data/PRISM/PRISM_ppt_y", temp_year, "_m", temp_month, ".tif"))</span></span>
<span id="cb93-1181"><a href="#cb93-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1182"><a href="#cb93-1182" aria-hidden="true" tabindex="-1"></a><span class="in">  temp &lt;- exactextractr::exact_extract(temp_raster, vector, "mean")</span></span>
<span id="cb93-1183"><a href="#cb93-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1184"><a href="#cb93-1184" aria-hidden="true" tabindex="-1"></a><span class="in">  return(temp)</span></span>
<span id="cb93-1185"><a href="#cb93-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1186"><a href="#cb93-1186" aria-hidden="true" tabindex="-1"></a><span class="in">  gc()</span></span>
<span id="cb93-1187"><a href="#cb93-1187" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb93-1188"><a href="#cb93-1188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1189"><a href="#cb93-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1190"><a href="#cb93-1190" aria-hidden="true" tabindex="-1"></a>We then loop over the rows of <span class="in">`month_year_data`</span> in parallel. </span>
<span id="cb93-1191"><a href="#cb93-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1192"><a href="#cb93-1192" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loop_over_time, eval = F}</span></span>
<span id="cb93-1193"><a href="#cb93-1193" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-1194"><a href="#cb93-1194" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;-</span></span>
<span id="cb93-1195"><a href="#cb93-1195" aria-hidden="true" tabindex="-1"></a><span class="in">   parallel::mclapply(</span></span>
<span id="cb93-1196"><a href="#cb93-1196" aria-hidden="true" tabindex="-1"></a><span class="in">     1:nrow(month_year_data),</span></span>
<span id="cb93-1197"><a href="#cb93-1197" aria-hidden="true" tabindex="-1"></a><span class="in">     \(x) get_prism_by_month(x, US_county),</span></span>
<span id="cb93-1198"><a href="#cb93-1198" aria-hidden="true" tabindex="-1"></a><span class="in">     mc.cores = num_cores</span></span>
<span id="cb93-1199"><a href="#cb93-1199" aria-hidden="true" tabindex="-1"></a><span class="in">   )</span></span>
<span id="cb93-1200"><a href="#cb93-1200" aria-hidden="true" tabindex="-1"></a><span class="in">toc()</span></span>
<span id="cb93-1201"><a href="#cb93-1201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1202"><a href="#cb93-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1203"><a href="#cb93-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1204"><a href="#cb93-1204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loop_over_time_run, echo = F, eval = F}</span></span>
<span id="cb93-1205"><a href="#cb93-1205" aria-hidden="true" tabindex="-1"></a><span class="in">month_year_data &lt;- data.table::CJ(month = 1:12, year = 2009:2018)</span></span>
<span id="cb93-1206"><a href="#cb93-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1207"><a href="#cb93-1207" aria-hidden="true" tabindex="-1"></a><span class="in">get_prism_by_month &lt;- function(i, vector) {</span></span>
<span id="cb93-1208"><a href="#cb93-1208" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_month &lt;- month_year_data[i, month]</span></span>
<span id="cb93-1209"><a href="#cb93-1209" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_year &lt;- month_year_data[i, year]</span></span>
<span id="cb93-1210"><a href="#cb93-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1211"><a href="#cb93-1211" aria-hidden="true" tabindex="-1"></a><span class="in">  temp_raster &lt;- terra::rast(paste0("Data/PRISM/PRISM_ppt_y", temp_year, "_m", temp_month, ".tif"))</span></span>
<span id="cb93-1212"><a href="#cb93-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1213"><a href="#cb93-1213" aria-hidden="true" tabindex="-1"></a><span class="in">  temp &lt;- exactextractr::exact_extract(temp_raster, vector, "mean")</span></span>
<span id="cb93-1214"><a href="#cb93-1214" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb93-1215"><a href="#cb93-1215" aria-hidden="true" tabindex="-1"></a><span class="in">  return(temp)</span></span>
<span id="cb93-1216"><a href="#cb93-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1217"><a href="#cb93-1217" aria-hidden="true" tabindex="-1"></a><span class="in">  gc()</span></span>
<span id="cb93-1218"><a href="#cb93-1218" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb93-1219"><a href="#cb93-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1220"><a href="#cb93-1220" aria-hidden="true" tabindex="-1"></a><span class="in">tic.clearlog()</span></span>
<span id="cb93-1221"><a href="#cb93-1221" aria-hidden="true" tabindex="-1"></a><span class="in">tic()</span></span>
<span id="cb93-1222"><a href="#cb93-1222" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- parallel::mclapply(1:nrow(month_year_data), function(x) get_prism_by_month(x, US_county), mc.cores = num_cores)</span></span>
<span id="cb93-1223"><a href="#cb93-1223" aria-hidden="true" tabindex="-1"></a><span class="in">toc(log = TRUE, quiet = TRUE)</span></span>
<span id="cb93-1224"><a href="#cb93-1224" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt_all_by_month_par &lt;- tic.log(format = FALSE)</span></span>
<span id="cb93-1225"><a href="#cb93-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1226"><a href="#cb93-1226" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-1227"><a href="#cb93-1227" aria-hidden="true" tabindex="-1"></a><span class="in">  log_txt_all_by_month_par_elapsed &lt;- log_txt_all_by_month_par[[1]]$toc - log_txt_all_by_month_par[[1]]$tic</span></span>
<span id="cb93-1228"><a href="#cb93-1228" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-1229"><a href="#cb93-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1230"><a href="#cb93-1230" aria-hidden="true" tabindex="-1"></a><span class="in">saveRDS(log_txt_all_by_month_par, "Data/ch6_log_txt_all_by_month_par.rds")</span></span>
<span id="cb93-1231"><a href="#cb93-1231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1232"><a href="#cb93-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1233"><a href="#cb93-1233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loop_over_time_show, echo = F}</span></span>
<span id="cb93-1234"><a href="#cb93-1234" aria-hidden="true" tabindex="-1"></a><span class="in">log_txt_all_by_month_par &lt;- readRDS("Data/ch6_log_txt_all_by_month_par.rds")</span></span>
<span id="cb93-1235"><a href="#cb93-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1236"><a href="#cb93-1236" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb93-1237"><a href="#cb93-1237" aria-hidden="true" tabindex="-1"></a><span class="in">  log_txt_all_by_month_par_elapsed &lt;- log_txt_all_by_month_par[[1]]$toc - log_txt_all_by_month_par[[1]]$tic</span></span>
<span id="cb93-1238"><a href="#cb93-1238" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb93-1239"><a href="#cb93-1239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb93-1240"><a href="#cb93-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1241"><a href="#cb93-1241" aria-hidden="true" tabindex="-1"></a>It took <span class="in">`r round(log_txt_all_by_month_par_elapsed/60, digits = 2)`</span> minutes. So, Approach 2 is the clear winner. </span>
<span id="cb93-1242"><a href="#cb93-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1243"><a href="#cb93-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1244"><a href="#cb93-1244" aria-hidden="true" tabindex="-1"></a><span class="fu">### Memory consideration</span></span>
<span id="cb93-1245"><a href="#cb93-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1246"><a href="#cb93-1246" aria-hidden="true" tabindex="-1"></a>So far, we have not addressed the memory footprint of the parallelized processes, but it becomes crucial when working with many large datasets. Approaches 1 and 2 differ significantly in their memory usage.</span>
<span id="cb93-1247"><a href="#cb93-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1248"><a href="#cb93-1248" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**Approach 1**: divides the polygons into groups and parallelizes over these groups when extracting raster values.</span>
<span id="cb93-1249"><a href="#cb93-1249" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>**Approach 2**: extracts and holds raster values for r num_cores of the entire U.S. polygons at once.</span>
<span id="cb93-1250"><a href="#cb93-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1251"><a href="#cb93-1251" aria-hidden="true" tabindex="-1"></a>Clearly, Approach 1 has a smaller memory footprint. Approach 2, on the other hand, used about 40 GB of memory, nearly maxing out my computer's 64 GB of RAM (with other processes also consuming memory). As long as you stay within the memory limits, Approach 2 is more efficient. However, if I had only 32 GB of RAM, Approach 2 would have experienced a significant performance drop, while Approach 1 would not. Similarly, if the raster data had twice as many cells within the same spatial extent, Approach 2 would suffer, whereas Approach 1 would not.</span>
<span id="cb93-1252"><a href="#cb93-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1253"><a href="#cb93-1253" aria-hidden="true" tabindex="-1"></a>It's easy to imagine situations where Approach 1 is preferable. For example, if you have multiple 10-GB raster layers and only 16 GB of RAM, Approach 2 would clearly be impractical, making Approach 1 the better, and perhaps only, choice—far better than not parallelizing at all.</span>
<span id="cb93-1254"><a href="#cb93-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1255"><a href="#cb93-1255" aria-hidden="true" tabindex="-1"></a>In summary, while processing larger datasets with each core can improve performance, you must be cautious not to exceed your computer’s RAM limits.</span>
<span id="cb93-1256"><a href="#cb93-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1257"><a href="#cb93-1257" aria-hidden="true" tabindex="-1"></a>:::{.callout-note title="Summary"}</span>
<span id="cb93-1258"><a href="#cb93-1258" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Parallelize over time rathe than space as long as your RAM memory allows it</span>
<span id="cb93-1259"><a href="#cb93-1259" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Parallelizing over space is still better than not parallelizing at all</span>
<span id="cb93-1260"><a href="#cb93-1260" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb93-1261"><a href="#cb93-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1262"><a href="#cb93-1262" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r by_year, eval = F}</span></span>
<span id="cb93-1263"><a href="#cb93-1263" aria-hidden="true" tabindex="-1"></a><span class="co">save_tif &lt;- function(y) {</span></span>
<span id="cb93-1264"><a href="#cb93-1264" aria-hidden="true" tabindex="-1"></a><span class="co">  temp_ml &lt;- terra::rast(stack(paste0("Data/PRISM/PRISM_ppt_y", y, "_m", 1:12, ".tif")))</span></span>
<span id="cb93-1265"><a href="#cb93-1265" aria-hidden="true" tabindex="-1"></a><span class="co">  writeRaster(temp_ml, paste0("Data/PRISM/PRISM_ppt_y", y, ".tif"), overwrite = T)</span></span>
<span id="cb93-1266"><a href="#cb93-1266" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb93-1267"><a href="#cb93-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1268"><a href="#cb93-1268" aria-hidden="true" tabindex="-1"></a><span class="co">mclapply(2009:2018, save_tif, mc.cores = 10)</span></span>
<span id="cb93-1269"><a href="#cb93-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1270"><a href="#cb93-1270" aria-hidden="true" tabindex="-1"></a><span class="co">temp_ml &lt;- stack(paste0("Data/PRISM/PRISM_ppt_y2009.tif"))</span></span>
<span id="cb93-1271"><a href="#cb93-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-1272"><a href="#cb93-1272" aria-hidden="true" tabindex="-1"></a><span class="co">tic()</span></span>
<span id="cb93-1273"><a href="#cb93-1273" aria-hidden="true" tabindex="-1"></a><span class="co">temp &lt;- exactextractr::exact_extract(temp_ml, US_county)</span></span>
<span id="cb93-1274"><a href="#cb93-1274" aria-hidden="true" tabindex="-1"></a><span class="co">toc()</span></span>
<span id="cb93-1275"><a href="#cb93-1275" aria-hidden="true" tabindex="-1"></a><span class="co">```--&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tmieno2/R-as-GIS-for-Economists/edit/master/06-SpeedThingsUp.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>